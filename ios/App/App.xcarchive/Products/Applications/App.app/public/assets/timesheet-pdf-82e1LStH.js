import{fetchJobLogo as E}from"./logoUtils-D2o1jUVg.js";import{a as G}from"./lazyPdf-xVUlxKNu.js";import{ab as D,i as u}from"./index-NZ6jJLfQ.js";const A=o=>new Promise((r,i)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>r(n),n.onerror=c=>{i(c)},n.src=o}),z=o=>o?o.substring(0,5):"--",B=o=>o?`${o}min`:"--",R=o=>o?`${o}h`:"--",W=(o,r)=>new Promise(i=>{const n=new Image;n.crossOrigin="anonymous";const c=setTimeout(()=>{i(null)},5e3);n.onload=()=>{clearTimeout(c),i(n)},n.onerror=e=>{clearTimeout(c),i(null)},n.src=o}),Y=async({job:o,timesheets:r,date:i})=>{var _,$;const{jsPDF:n,autoTable:c}=await G(),e=new n,g=e.internal.pageSize.width,C=e.internal.pageSize.height,[S,H]=await Promise.all([E(o.id),J(r)]),[p,x]=await Promise.all([S?W(S):Promise.resolve(null),W("/lovable-uploads/ce3ff31a-4cc5-43c8-b5bb-a4056d3735e4.png")]),T=new Map;if(H.forEach(t=>{t.status==="fulfilled"&&t.value&&T.set(t.value.timesheetId,t.value.image)}),e.setFillColor(125,1,1),e.rect(0,0,g,40,"F"),p)try{e.addImage(p,"PNG",15,8,30,24)}catch{}e.setFont("helvetica","bold"),e.setFontSize(18),e.setTextColor(255,255,255),e.text("TIMESHEET",g/2,20,{align:"center"}),e.setFontSize(12),e.text(`${o.title}`,g/2,30,{align:"center"}),e.setTextColor(0,0,0);let l=55;e.setFont("helvetica","normal"),e.setFontSize(11);let f;if(r.length>0){const t=r.map(d=>D(d.date)).sort((d,h)=>d.getTime()-h.getTime()),s=t[0],a=t[t.length-1];s.getTime()===a.getTime()?f=u(s,"MMM dd, yyyy"):f=`${u(s,"MMM dd")} - ${u(a,"MMM dd, yyyy")}`}else f="All Dates";e.text(`Period: ${f}`,20,l),l+=8;const O=((_=o.location)==null?void 0:_.name)||"TBD",w=($=o.location)==null?void 0:$.formatted_address;e.text(`Location: ${O}`,20,l),w&&(l+=6,e.setFontSize(9),e.setTextColor(100,100,100),e.text(`${w}`,20,l),e.setFontSize(11),e.setTextColor(0,0,0)),l+=20;const P=r.reduce((t,s)=>{const a=`${s.date}-${s.technician_id}`;return t[a]||(t[a]=[]),t[a].push(s),t},{}),k=Object.values(P).flat().map(t=>{var I,v;const s=`${((I=t.technician)==null?void 0:I.first_name)||""} ${((v=t.technician)==null?void 0:v.last_name)||""}`.trim(),a=z(t.start_time),d=z(t.end_time);B(t.break_minutes);const h=R(t.overtime_hours);let F="--";if(t.start_time&&t.end_time){const L=new Date(`2000-01-01T${t.start_time}`);let y=new Date(`2000-01-01T${t.end_time}`).getTime()-L.getTime();(t.ends_next_day||y<0)&&(y+=1440*60*1e3);const N=y/(1e3*60*60),j=(t.break_minutes||0)/60;F=Math.max(0,N-j).toFixed(2)}let m="--";T.get(t.id)?m="Signed":t.signature_data?m="Failed":t.status==="approved"?m="Pending":t.status==="rejected"&&(m="Rejected");const M=[u(D(t.date),"MMM dd"),s,a,d,F,h,m];return t.notes&&M.push(`Notes: ${t.notes}`),M});c(e,{startY:l,head:[["Date","Technician","Start Time","End Time","Total Hours","Overtime","Signature"]],body:k,theme:"grid",headStyles:{fillColor:[125,1,1],textColor:[255,255,255],fontSize:10,fontStyle:"bold"},bodyStyles:{fontSize:9,cellPadding:3},alternateRowStyles:{fillColor:[248,248,248]},columnStyles:{0:{cellWidth:20},1:{cellWidth:40},2:{cellWidth:20},3:{cellWidth:20},4:{cellWidth:18},5:{cellWidth:16},6:{cellWidth:22}},didDrawCell:t=>{if(t.column.index===6&&t.section==="body"){const s=Object.values(P).flat()[t.row.index],a=T.get(s.id);if(a)try{e.addImage(a,"PNG",t.cell.x+2,t.cell.y+2,18,t.cell.height-4)}catch{}}}});const b=C-25;if(x)try{const a=(g-20)/2;e.addImage(x,"PNG",a,b-5,20,10)}catch{}return e.setFont("helvetica","normal"),e.setFontSize(8),e.setTextColor(100,100,100),e.text(`Generated on: ${u(new Date,"PPP")}`,g/2,b+8,{align:"center"}),e},J=async o=>{const r=[];for(const i of o)i.signature_data&&r.push(A(i.signature_data).then(n=>({timesheetId:i.id,image:n})).catch(n=>null));return Promise.allSettled(r)},V=async o=>{const r=await Y(o),i=`timesheet-${o.job.title.replace(/[^a-zA-Z0-9]/g,"_")}-all-dates.pdf`;r.save(i)};export{V as d,Y as g};
