import{u as z,f as P,a4 as m,d as Q,j as e,L as y,I as E,B as x,a as L,V as G,D as K,q as R,F as V,G as H,n as g,s as v}from"./index-NZ6jJLfQ.js";import{u as U}from"./useQuery-kdg2pmgf.js";import{u as F}from"./useMutation-DluhVBs1.js";import{B as $}from"./badge-vNTKF5RD.js";import{S as J}from"./switch-DUBpZhIC.js";import{S as W,b as X,c as Y,d as Z}from"./sheet-DFFfLazF.js";import{C as ee}from"./calendar-days-DcwEz6pd.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";function ce(){const{user:t}=z(),N=P(),[w,l]=m.useState(!1),[u,D]=m.useState(!0),[h,S]=m.useState(""),[f,q]=m.useState(""),[n,p]=m.useState({}),[j,C]=m.useState(null),B=Q(),A={vacation:"Vacaciones",travel:"Viaje",sick:"Baja médica",day_off:"Día libre"},I={vacation:"border-transparent bg-amber-100 text-amber-800",travel:"border-transparent bg-sky-100 text-sky-800",sick:"border-transparent bg-rose-100 text-rose-800",day_off:"border-transparent bg-emerald-100 text-emerald-800"},{data:k=[],isLoading:M}=U({queryKey:["my-unavailability",t==null?void 0:t.id],queryFn:async()=>{if(!(t!=null&&t.id))return[];const{data:a,error:s}=await v.from("technician_availability").select("id, technician_id, date, status, created_at, updated_at").eq("technician_id",t.id).order("date",{ascending:!1});if(s)throw s;return a||[]},enabled:!!(t!=null&&t.id)}),T=F({mutationFn:async a=>{if(!(t!=null&&t.id))return;const s=[],d=new Date(a.startDate+"T00:00"),i=new Date(a.endDate+"T00:00");if(isNaN(d.getTime())||isNaN(i.getTime())||i<d)throw new Error("Invalid date range");for(let r=new Date(d);r<=i;r.setDate(r.getDate()+1))s.push({technician_id:t.id,date:r.toISOString().slice(0,10),status:a.status});const{error:c}=await v.from("technician_availability").upsert(s,{onConflict:"technician_id,date"});if(c)throw c},onSuccess:()=>{g.success("Bloqueo de disponibilidad creado"),N.invalidateQueries({queryKey:["my-unavailability"]}),l(!1),S(""),q(""),D(!0),p({})},onError:a=>g.error((a==null?void 0:a.message)||"No se pudo crear el bloqueo")}),b=F({mutationFn:async a=>{const{error:s}=await v.from("technician_availability").delete().eq("id",a);if(s)throw s},onMutate:a=>{C(a)},onSuccess:()=>{g.success("Bloqueo eliminado"),N.invalidateQueries({queryKey:["my-unavailability"]})},onError:a=>g.error((a==null?void 0:a.message)||"No se pudo eliminar el bloqueo"),onSettled:()=>{C(null)}}),o=T.isPending,O=a=>{a==null||a.preventDefault();const s={};h||(s.start="La fecha de inicio es obligatoria."),f||(s.end="La fecha de fin es obligatoria.");const d=r=>r.includes("T")?r.slice(0,10):r,i=h?d(h):"",c=f?d(f):"";i&&c&&i>c&&(s.end="La fecha de fin debe ser posterior o igual a la fecha de inicio."),p(s),!(Object.keys(s).length>0)&&T.mutate({startDate:i,endDate:c,status:"day_off"})},_=e.jsxs("form",{onSubmit:O,className:"flex flex-1 flex-col",children:[e.jsxs("div",{className:"flex-1 space-y-6 overflow-y-auto pb-6",children:[e.jsxs("section",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Rango de fechas"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecciona cuándo estarás ausente. Las fechas se aplicarán a todo el día por defecto."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(y,{htmlFor:"start",children:["Inicio",u?" (fecha)":" (fecha y hora)"]}),e.jsx(E,{id:"start",type:u?"date":"datetime-local",value:h,onChange:a=>{S(a.target.value),n.start&&p(s=>({...s,start:void 0}))},"aria-invalid":!!n.start,disabled:o}),n.start&&e.jsx("p",{className:"text-sm text-destructive",children:n.start})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(y,{htmlFor:"end",children:["Fin",u?" (fecha)":" (fecha y hora)"]}),e.jsx(E,{id:"end",type:u?"date":"datetime-local",value:f,onChange:a=>{q(a.target.value),n.end&&p(s=>({...s,end:void 0}))},"aria-invalid":!!n.end,disabled:o}),n.end&&e.jsx("p",{className:"text-sm text-destructive",children:n.end})]})]})]}),e.jsxs("section",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Duración del bloqueo"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Activa la opción para bloquear días completos o desactívala si solo necesitas unas horas específicas."})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-lg border border-border/70 bg-muted/40 p-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(y,{htmlFor:"allDay",className:"text-base font-medium",children:"Todo el día"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Tus horarios quedarán marcados como no disponibles las 24 horas."})]}),e.jsx(J,{id:"allDay",checked:u,onCheckedChange:a=>D(!!a),disabled:o})]})]})]}),e.jsxs("div",{className:"mt-auto flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",children:[e.jsx(x,{type:"button",variant:"outline",onClick:()=>l(!1),disabled:o,children:"Cancelar"}),e.jsxs(x,{type:"submit",disabled:o,children:[o&&e.jsx(L,{className:"mr-2 h-4 w-4 animate-spin"}),o?"Guardando…":"Crear"]})]})]});return e.jsxs("div",{className:"relative mx-auto max-w-3xl p-4 pb-24 md:pb-6",children:[e.jsxs("div",{className:"mb-6 flex flex-col gap-y-2 md:mb-4 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Mis bloqueos de disponibilidad"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Gestiona y revisa los días en los que no estarás disponible para asignaciones."})]}),e.jsx(x,{className:"hidden md:inline-flex",onClick:()=>l(!0),children:"Añadir bloqueo"})]}),M?e.jsx("div",{className:"text-muted-foreground",children:"Cargando…"}):e.jsxs("div",{className:"space-y-3",children:[k.length===0&&e.jsx("div",{className:"text-muted-foreground",children:"Todavía no tienes bloqueos de disponibilidad. Añade uno para evitar asignaciones durante esas fechas."}),k.map(a=>{const s=new Date(a.date).toLocaleDateString("es-ES",{dateStyle:"long"}),d=I[a.status]||"border-transparent bg-muted text-foreground",i=A[a.status]||a.status;return e.jsx("div",{className:"rounded-lg border border-border/70 bg-muted/30 p-4 shadow-sm transition hover:bg-muted/40",children:e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 shrink-0 items-center justify-center rounded-md bg-background text-muted-foreground shadow-inner",children:e.jsx(ee,{"aria-hidden":!0,className:"h-5 w-5"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Fecha"}),e.jsx("p",{className:"text-base font-semibold text-foreground",children:s})]})]}),e.jsx($,{variant:"outline",className:`self-start ${d}`,children:i})]}),e.jsxs(x,{variant:"outline",className:"w-full justify-center md:h-9 md:w-auto md:px-3",onClick:()=>b.mutate(a.id),disabled:b.isPending&&j===a.id,children:[b.isPending&&j===a.id?e.jsx(L,{"aria-hidden":!0,className:"h-4 w-4 animate-spin"}):e.jsx(G,{"aria-hidden":!0,className:"h-4 w-4"}),e.jsx("span",{children:b.isPending&&j===a.id?"Eliminando…":"Eliminar"}),e.jsxs("span",{className:"sr-only",children:["Bloqueo del ",s]})]})]})},a.id)})]}),e.jsx("div",{className:"md:hidden",children:e.jsx("div",{className:"fixed inset-x-0 bottom-20 z-40 bg-background/95 px-4 pb-4 pt-4 shadow-lg backdrop-blur supports-[backdrop-filter]:bg-background/60 supports-[bottom:env(safe-area-inset-bottom)]:bottom-[calc(env(safe-area-inset-bottom)+5rem)]",children:e.jsx(x,{className:"w-full",onClick:()=>l(!0),children:"Añadir bloqueo"})})}),B?e.jsx(W,{open:w,onOpenChange:l,children:e.jsxs(X,{side:"bottom",className:"flex h-[94vh] flex-col overflow-hidden rounded-t-2xl bg-background px-6 pb-6 pt-10",children:[e.jsxs(Y,{className:"space-y-1 text-left",children:[e.jsx(Z,{children:"Añadir bloqueo de disponibilidad"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Define cuándo no podrás recibir asignaciones y mantén tu agenda al día."})]}),e.jsx("div",{className:"mt-6 flex flex-1 flex-col",children:_})]})}):e.jsx(K,{open:w,onOpenChange:l,children:e.jsxs(R,{className:"max-w-lg",children:[e.jsxs(V,{children:[e.jsx(H,{children:"Añadir bloqueo de disponibilidad"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Define cuándo no podrás recibir asignaciones y mantén tu agenda al día."})]}),_]})})]})}export{ce as default};
