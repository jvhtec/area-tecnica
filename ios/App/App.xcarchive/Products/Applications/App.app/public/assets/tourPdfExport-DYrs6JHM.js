import{l as et,j as e,L as Ce,S as tt,t as at,v as st,w as rt,x as _e,M as ot,bh as it,I as Ae,s as l,i as xe,f as Pe,a4 as $e,e as Se,r as k,D as Re,q as Ke,F as Ie,G as Ge,B as $,V as pe,bk as gt,aD as pt,ac as xt,u as wt,X as _t,c as vt}from"./index-NZ6jJLfQ.js";import{S as yt}from"./scroll-area-BHjMXddA.js";import{u as nt}from"./useQuery-kdg2pmgf.js";import{C as Le}from"./calendar-_Cj_Sgy-.js";import{C as lt}from"./clock-BXPvTWvY.js";import{R as be,D as Ee,a as Ne,F as X}from"./constants-DoXhG9KB.js";import{c as De}from"./api-C9EDenHJ.js";import{u as Qe}from"./useRealtimeSubscription-Bj7PWAKC.js";import{C as Je}from"./checkbox-BsRNEGV1.js";import{a as jt,d as bt}from"./optimisticJobDeletionService-Bq-53fU4.js";import{P as dt}from"./package-Oxfj-CNq.js";import{F as Nt}from"./folder-plus-DTUhlRcm.js";import{S as Dt}from"./square-pen-BMpSgZGa.js";import{P as St}from"./plus-C3JQqq7t.js";import{B as Tt}from"./badge-vNTKF5RD.js";import{F as We}from"./file-text-igU140SQ.js";import{B as Et}from"./building-2-nIk8XRuA.js";import{A as Ct,h as Pt,a as kt,b as Mt,c as qt,d as Ft,e as At,f as $t,g as Lt}from"./alert-dialog-CtyYUxwH.js";import{T as zt,a as Qt,b as qe,c as Fe}from"./tabs-BdaywI_b.js";import{e as Ye}from"./pdfExport-DjZPdCcG.js";import{fetchTourLogo as ze}from"./logoUtils-D2o1jUVg.js";import{u as Ut}from"./useTourPowerDefaults-COrAOuj-.js";import{u as Ue}from"./useMutation-DluhVBs1.js";import{u as Wt}from"./useTourDefaultSets-CKjECdAO.js";import{C as ct}from"./calculator-jIsLl-gd.js";import{D as Xe}from"./download-C1rVE0-J.js";import{I as Rt}from"./image--Pql38nK.js";import{U as Kt}from"./upload-DF4rjO7T.js";import{C as Oe}from"./circle-x-DDzV-xk_.js";import{C as It}from"./circle-check-big-CilmNGCn.js";import{S as Gt}from"./settings-egXcSQW9.js";import{a as ut}from"./lazyPdf-xVUlxKNu.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bt=et("Palette",[["circle",{cx:"13.5",cy:"6.5",r:".5",fill:"currentColor",key:"1okk4w"}],["circle",{cx:"17.5",cy:"10.5",r:".5",fill:"currentColor",key:"f64h9f"}],["circle",{cx:"8.5",cy:"7.5",r:".5",fill:"currentColor",key:"fotxhn"}],["circle",{cx:"6.5",cy:"12.5",r:".5",fill:"currentColor",key:"qy21gx"}],["path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z",key:"12rzf8"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mt=et("Weight",[["circle",{cx:"12",cy:"5",r:"3",key:"rqqgnr"}],["path",{d:"M6.5 8a2 2 0 0 0-1.905 1.46L2.1 18.5A2 2 0 0 0 4 21h16a2 2 0 0 0 1.925-2.54L19.4 9.5A2 2 0 0 0 17.48 8Z",key:"56o5sh"}]]),Vt=({location:r,setLocation:j,setLocationDetails:t,tourDateType:s,setTourDateType:w,startDate:_,setStartDate:d,endDate:M,setEndDate:N})=>{const h=n=>{d(n),(s==="show"||s==="travel")&&N(n)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Ce,{htmlFor:"tourDateType",children:"Type"}),e.jsxs(tt,{value:s,onValueChange:w,children:[e.jsx(at,{children:e.jsx(st,{placeholder:"Select date type"})}),e.jsxs(rt,{children:[e.jsx(_e,{value:"show",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"h-4 w-4"}),"Show"]})}),e.jsx(_e,{value:"rehearsal",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"h-4 w-4"}),"Rehearsal"]})}),e.jsx(_e,{value:"travel",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ot,{className:"h-4 w-4"}),"Travel Day"]})})]})]})]}),e.jsx("div",{children:e.jsx(it,{value:r,onInputChange:n=>{j(n),t==null||t(null)},onSelect:n=>{j(n.name),t==null||t({name:n.name,address:n.address,coordinates:n.coordinates,place_id:n.place_id})},placeholder:"Enter location",label:"Location"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(Ce,{htmlFor:"startDate",children:s==="rehearsal"?"Start Date":"Date"}),e.jsx(Ae,{id:"startDate",type:"date",value:_,onChange:n=>h(n.target.value)})]}),s==="rehearsal"&&e.jsxs("div",{children:[e.jsx(Ce,{htmlFor:"endDate",children:"End Date"}),e.jsx(Ae,{id:"endDate",type:"date",value:M,onChange:n=>N(n.target.value),min:_})]})]}),s==="rehearsal"&&_&&M&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Duration: ",Math.ceil((new Date(M).getTime()-new Date(_).getTime())/(1e3*60*60*24))+1," days"]})]})};async function Ht(r,j,t=!1){var s;try{if(!t){const{data:a,error:c}=await l.from("jobs").select("flex_folders_created").eq("tour_date_id",r.id);if(c)throw c;if(a&&a.some(b=>b.flex_folders_created))return!1}const{data:w,error:_}=await l.from("tours").select(`
        name,
        flex_main_folder_id,
        flex_sound_folder_id,
        flex_lights_folder_id,
        flex_video_folder_id,
        flex_production_folder_id,
        flex_personnel_folder_id
      `).eq("id",j).single();if(_)throw _;if(!w||!w.flex_main_folder_id)throw new Error("Parent tour folders not found. Please create tour folders first.");const d=new Date(r.date).toISOString().split(".")[0]+".000Z",M=d,N=new Date(r.date).toISOString().slice(2,10).replace(/-/g,""),h=xe(new Date(r.date),"MMM d, yyyy"),n=((s=r.location)==null?void 0:s.name)||"No Location",P=["sound","lights","video","production","personnel"];for(const a of P){const c=w[`flex_${a}_folder_id`],b=a.charAt(0).toUpperCase()+a.slice(1);if(!c)continue;const{data:S,error:T}=await l.from("flex_folders").select("*").eq("element_id",c).limit(1);if(T||!S||S.length===0)continue;const q=S[0],R={definitionId:X.subFolder,parentElementId:c,open:!0,locked:!1,name:`${n} - ${h} - ${b}`,plannedStartDate:d,plannedEndDate:M,locationId:X.location,departmentId:Ne[a],documentNumber:`${N}${Ee[a]}`,personResponsibleId:be[a]},E=(await De(R)).elementId;if(await l.from("flex_folders").insert({tour_date_id:r.id,parent_id:q.id,element_id:E,department:a,folder_type:"tourdate"}),a!=="personnel"){const F=[{definitionId:X.documentacionTecnica,name:`Documentación Técnica - ${b}`,suffix:"DT"},{definitionId:X.presupuestosRecibidos,name:`Presupuestos Recibidos - ${b}`,suffix:"PR"},{definitionId:X.hojaGastos,name:`Hoja de Gastos - ${b}`,suffix:"HG"}];for(const D of F){const C={definitionId:D.definitionId,parentElementId:E,open:!0,locked:!1,name:D.name,plannedStartDate:d,plannedEndDate:M,locationId:X.location,departmentId:Ne[a],documentNumber:`${N}${Ee[a]}${D.suffix}`,personResponsibleId:be[a]},se=(await De(C)).elementId;await l.from("flex_folders").insert({tour_date_id:r.id,parent_id:q.id,element_id:se,department:a,folder_type:"tourdate_subfolder"})}}if(["sound","lights","video"].includes(a)){const F=`${n} - ${h}`,D=a==="sound"?X.hojaInfoSx:a==="lights"?X.hojaInfoLx:X.hojaInfoVx,C=a==="sound"?"SIP":a==="lights"?"LIP":"VIP",G={definitionId:D,parentElementId:E,open:!0,locked:!1,name:`Hoja de Información - ${F}`,plannedStartDate:d,plannedEndDate:M,locationId:X.location,departmentId:Ne[a],documentNumber:`${N}${C}`,personResponsibleId:be[a]};await De(G)}if(a==="sound"){const F=r.is_tour_pack_only,D=[{name:`${w.name} - Tour Pack`,suffix:"TP"}];F||D.push({name:`${w.name} - PA`,suffix:"PA"});for(const C of D){const G={definitionId:X.pullSheet,parentElementId:E,open:!0,locked:!1,name:C.name,plannedStartDate:d,plannedEndDate:M,locationId:X.location,documentNumber:`${N}${Ee[a]}${C.suffix}`,departmentId:Ne[a],personResponsibleId:be[a]},O=(await De(G)).elementId;await l.from("flex_folders").insert({tour_date_id:r.id,parent_id:q.id,element_id:O,department:a,folder_type:"tourdate_subfolder"})}}if(a==="personnel"){const F=[{name:`Gastos de Personal - ${w.name}`,suffix:"GP"}];for(const C of F){const G={definitionId:X.hojaGastos,parentElementId:E,open:!0,locked:!1,name:C.name,plannedStartDate:d,plannedEndDate:M,locationId:X.location,documentNumber:`${N}${Ee[a]}${C.suffix}`,departmentId:Ne[a],personResponsibleId:be[a]},O=(await De(G)).elementId;await l.from("flex_folders").insert({tour_date_id:r.id,parent_id:q.id,element_id:O,department:a,folder_type:"tourdate_subfolder"})}const D=[{name:`Crew Call Sonido - ${w.name}`,suffix:"CCS"},{name:`Crew Call Luces - ${w.name}`,suffix:"CCL"}];for(const C of D){const G={definitionId:X.crewCall,parentElementId:E,open:!0,locked:!1,name:C.name,plannedStartDate:d,plannedEndDate:M,locationId:X.location,documentNumber:`${N}${Ee[a]}${C.suffix}`,departmentId:Ne[a],personResponsibleId:be[a]},O=(await De(G)).elementId;await l.from("flex_folders").insert({tour_date_id:r.id,parent_id:q.id,element_id:O,department:a,folder_type:"tourdate_subfolder"})}}}const{error:p}=await l.from("tour_dates").update({flex_folders_created:!0}).eq("id",r.id);if(p)throw p;return!0}catch(w){throw w}}const Zt=(r,j)=>{const t=Pe();$e.useMemo(()=>[...j].sort().join(","),[j]),Qe({table:"tour_dates",queryKey:["tour",r],event:"*",filter:r?`tour_id=eq.${r}`:void 0}),Qe({table:"flex_folders",queryKey:["flex-folders-existence",...j],event:"*"}),Qe({table:"locations",queryKey:["tour",r],event:"*"}),$e.useEffect(()=>{if(r){const w=setInterval(()=>{const _=t.getQueryState(["tour",r]),d=(_==null?void 0:_.dataUpdatedAt)??0;d>0&&Date.now()-d<15e3||t.invalidateQueries({queryKey:["tour",r]})},15e3);return()=>clearInterval(w)}},[r,t])},Fa=({open:r,onOpenChange:j,tourId:t,tourDates:s=[],readOnly:w=!1})=>{const{toast:_}=Se(),d=Pe(),{getOrCreateLocation:M,getOrCreateLocationWithDetails:N}=gt(),h=$e.useMemo(()=>s.map(i=>i.id),[s]);Zt(t,h),k.useEffect(()=>{r&&t&&d.invalidateQueries({queryKey:["tour",t]})},[r,t,d]);const[n,P]=k.useState(null),[p,a]=k.useState(""),[c,b]=k.useState("show"),[S,T]=k.useState(""),[q,R]=k.useState(""),[H,E]=k.useState(!1),[F,D]=k.useState(null),[C,G]=k.useState([]),[se,O]=k.useState(!1),[oe,ce]=k.useState(""),[ue,Te]=k.useState(null),[ie,ve]=k.useState("show"),[me,ke]=k.useState(""),[o,f]=k.useState(""),[m,J]=k.useState(!1),[B,ee]=k.useState(null),{data:g,refetch:V}=nt({queryKey:["flex-folders-existence",h],queryFn:async()=>{if(!s.length)return{};const{data:i,error:v}=await l.from("flex_folders").select("tour_date_id").in("tour_date_id",h);if(v)throw v;return i.reduce((y,W)=>(y[W.tour_date_id]=!0,y),{})},enabled:s.length>0}),z=async i=>{if(!t){_({title:"Missing tour ID",description:"No tour selected. Please refresh and try again.",variant:"destructive"});return}if(!(i.flex_folders_created||C.includes(i.id)))try{const{data:v}=await l.from("flex_folders").select("id").eq("tour_date_id",i.id);if((v==null?void 0:v.length)>0){_({title:"Folders already exist",description:"Flex folders have already been created for this tour date.",variant:"destructive"});return}await Ht(i,t,!0),G(y=>[...y,i.id]),d.invalidateQueries({queryKey:["flex-folders"]}),d.invalidateQueries({queryKey:["tours"]}),_({title:"Success",description:"Folders created for this tour date."})}catch(v){_({title:"Error creating folders",description:v.message,variant:"destructive"})}},ne=async(i,v="show",y,W,A=!1)=>{var u,Q,L,U,K;try{if(!t)throw new Error("Tour ID is required");const I=W||y,le=Math.ceil((new Date(I).getTime()-new Date(y).getTime())/(1e3*60*60*24))+1;let te=null;ue&&ue.name?te=await N(ue):te=await M(i);const{data:we,error:de}=await l.from("tour_dates").insert({tour_id:t,date:y,start_date:y,end_date:I,tour_date_type:v,rehearsal_days:le,location_id:te,is_tour_pack_only:A}).select(`
          id,
          date,
          start_date,
          end_date,
          tour_date_type,
          rehearsal_days,
          is_tour_pack_only,
          location:locations (
            id,
            name
          )
        `).single();if(de)throw de;const{data:ae,error:ye}=await l.from("tours").select(`
          name,
          color,
          tour_dates (
            jobs (
              job_departments (
                department
              )
            )
          )
        `).eq("id",t).single();if(ye)throw ye;const{data:je,error:Me}=await l.from("jobs").insert({title:v==="rehearsal"?`${ae.name} - Rehearsal (${i})`:v==="travel"?`${ae.name} - Travel (${i})`:`${ae.name} (${i||"No Location"})`,start_time:`${y}T06:00:00`,end_time:`${I}T21:59:59`,location_id:te,tour_date_id:we.id,tour_id:t,color:ae.color||"#7E69AB",job_type:"tourdate"}).select().single();if(Me)throw Me;const fe=(((K=(U=(L=(Q=(u=ae.tour_dates)==null?void 0:u[0])==null?void 0:Q.jobs)==null?void 0:L[0])==null?void 0:U.job_departments)==null?void 0:K.map(ge=>ge.department))||["sound","lights","video"]).map(ge=>({job_id:je.id,department:ge})),{error:Ve}=await l.from("job_departments").insert(fe);if(Ve)throw Ve;const He=[],ht=new Date(y),ft=new Date(I);for(let ge=new Date(ht);ge<=ft;ge.setDate(ge.getDate()+1))He.push({job_id:je.id,date:ge.toISOString().split("T")[0],type:v});const{error:Ze}=await l.from("job_date_types").insert(He);if(Ze)throw Ze;await Promise.all([d.invalidateQueries({queryKey:["tour",t]}),d.invalidateQueries({queryKey:["tours"]}),d.invalidateQueries({queryKey:["optimized-jobs"]}),d.invalidateQueries({queryKey:["jobs"]}),d.invalidateQueries({queryKey:["job-assignments"]}),d.invalidateQueries({queryKey:["flex-folders-existence"]})]),_({title:"Success",description:"Tour date and job created successfully"})}catch(I){_({title:"Error adding date",description:I.message,variant:"destructive"})}},he=async(i,v,y,W,A,u)=>{var Q;try{if(!t)throw new Error("Tour ID is required");const L=A||W,U=Math.ceil((new Date(L).getTime()-new Date(W).getTime())/(1e3*60*60*24))+1;let K=null;B&&B.name?K=await N(B):K=await M(v);const{data:I,error:le}=await l.from("tours").select("name").eq("id",t).single();if(le)throw le;const{data:te,error:we}=await l.from("tour_dates").update({date:W,start_date:W,end_date:L,tour_date_type:y,rehearsal_days:U,location_id:K,is_tour_pack_only:u}).eq("id",i).select(`
          id,
          date,
          is_tour_pack_only,
          location:locations (
            id,
            name
          ),
          tours (
            name
          )
        `).single();if(we)throw we;if(n&&n.tour_date_type!==y)try{l.functions.invoke("push",{body:{action:"broadcast",type:`tourdate.type.changed.${y}`,tour_id:t,tour_date_id:i,tour_name:I.name,location_name:v||((Q=te==null?void 0:te.location)==null?void 0:Q.name)||"",old_type:n.tour_date_type,new_type:y,url:`/tours/${t}`}})}catch{}const{data:de,error:ae}=await l.from("jobs").update({title:y==="rehearsal"?`${I.name} - Rehearsal (${v})`:y==="travel"?`${I.name} - Travel (${v})`:`${I.name} (${v||"No Location"})`,start_time:`${W}T06:00:00`,end_time:`${L}T21:59:59`,location_id:K}).eq("tour_date_id",i).select("id");if(ae)throw ae;if(de&&de.length>0)for(const ye of de){await l.from("job_date_types").delete().eq("job_id",ye.id);const je=[],Me=new Date(W),Be=new Date(L);for(let fe=new Date(Me);fe<=Be;fe.setDate(fe.getDate()+1))je.push({job_id:ye.id,date:fe.toISOString().split("T")[0],type:y});if(je.length>0){const{error:fe}=await l.from("job_date_types").insert(je)}}await Promise.all([d.invalidateQueries({queryKey:["tour",t]}),d.invalidateQueries({queryKey:["tours"]}),d.invalidateQueries({queryKey:["optimized-jobs"]}),d.invalidateQueries({queryKey:["jobs"]})]),_({title:"Success",description:"Tour date updated successfully"})}catch(L){_({title:"Error editing date",description:L.message,variant:"destructive"})}},re=async i=>{if(!F){D(i);try{const{error:v}=await l.from("flex_folders").delete().eq("tour_date_id",i);if(v)throw v;const{data:y,error:W}=await l.from("jobs").select("id").eq("tour_date_id",i);if(W)throw W;if(y&&y.length>0){const u=y.map(U=>U.id),Q=[{table:"task_documents",condition:"sound_task_id",subquery:"sound_job_tasks"},{table:"task_documents",condition:"lights_task_id",subquery:"lights_job_tasks"},{table:"task_documents",condition:"video_task_id",subquery:"video_job_tasks"},{table:"sound_job_tasks",condition:"job_id"},{table:"lights_job_tasks",condition:"job_id"},{table:"video_job_tasks",condition:"job_id"},{table:"sound_job_personnel",condition:"job_id"},{table:"lights_job_personnel",condition:"job_id"},{table:"video_job_personnel",condition:"job_id"},{table:"job_assignments",condition:"job_id"},{table:"job_departments",condition:"job_id"},{table:"job_documents",condition:"job_id"},{table:"logistics_events",condition:"job_id"},{table:"hoja_de_ruta",condition:"job_id"},{table:"memoria_tecnica_documents",condition:"job_id"},{table:"lights_memoria_tecnica_documents",condition:"job_id"},{table:"video_memoria_tecnica_documents",condition:"job_id"},{table:"job_date_types",condition:"job_id",useService:!0},{table:"job_milestones",condition:"job_id"},{table:"power_requirement_tables",condition:"job_id"},{table:"festival_artists",condition:"job_id"},{table:"festival_gear_setups",condition:"job_id"},{table:"festival_logos",condition:"job_id"},{table:"festival_shifts",condition:"job_id"},{table:"festival_settings",condition:"job_id"},{table:"festival_stages",condition:"job_id"},{table:"technician_work_records",condition:"job_id"}];for(const U of Q)if(U.subquery){const{data:K}=await l.from(U.subquery).select("id").in("job_id",u);if(K&&K.length>0){const{error:I}=await l.from(U.table).delete().in(U.condition,K.map(le=>le.id))}}else if(U.useService&&U.table==="job_date_types")for(const K of u)try{await jt(K)}catch{}else{const{error:K}=await l.from(U.table).delete().in(U.condition,u)}const{error:L}=await l.from("jobs").delete().in("id",u);if(L)throw L}await Promise.all([l.from("tour_date_power_overrides").delete().eq("tour_date_id",i),l.from("tour_date_weight_overrides").delete().eq("tour_date_id",i)]);const{error:A}=await l.from("tour_dates").delete().eq("id",i);if(A)throw A;await Promise.all([d.invalidateQueries({queryKey:["tour",t]}),d.invalidateQueries({queryKey:["tours"]}),d.invalidateQueries({queryKey:["tours-with-dates"]}),d.invalidateQueries({queryKey:["optimized-jobs"]}),d.invalidateQueries({queryKey:["jobs"]}),d.invalidateQueries({queryKey:["flex-folders-existence"]})]),_({title:"Success",description:"Tour date deleted successfully"})}catch(v){_({title:"Error deleting date",description:v.message||"An unexpected error occurred while deleting the tour date",variant:"destructive"})}finally{D(null)}}},x=i=>{var y;P(i);const v=(i.start_date||i.date||"").split("T")[0]||"";T(v),R((i.end_date||v||"").split("T")[0]||""),a(((y=i.location)==null?void 0:y.name)||""),b(i.tour_date_type||"show"),E(i.is_tour_pack_only||!1),i.location?ee({name:i.location.name,address:i.location.formatted_address||i.location.address||"",coordinates:i.location.latitude&&i.location.longitude?{lat:i.location.latitude,lng:i.location.longitude}:void 0,place_id:i.location.google_place_id||i.location.place_id||void 0}):ee(null)},Y=()=>{P(null),a(""),b("show"),T(""),R(""),E(!1),ee(null)},Z=async i=>{await he(i,p,c,S,q,H),Y()};return e.jsx(e.Fragment,{children:e.jsx(Re,{open:r,onOpenChange:j,children:e.jsxs(Ke,{className:"max-w-3xl w-[95vw] md:w-full max-h-[95vh] md:max-h-[90vh] flex flex-col gap-0 p-0",children:[e.jsx(Ie,{className:"px-4 pt-4 pb-2 md:px-6 md:pt-6 md:pb-4 border-b",children:e.jsx(Ge,{className:"text-base md:text-lg",children:w?"Tour Dates":"Manage Tour Dates"})}),e.jsx(yt,{className:"flex-1 overflow-auto px-4 md:px-6",children:e.jsxs("div",{className:"space-y-3 md:space-y-4 py-4 pb-6",children:[e.jsx("div",{className:"space-y-4",children:s==null?void 0:s.map(i=>{var A;const v=(g==null?void 0:g[i.id])||!1,y=F===i.id,W=C.includes(i.id);return e.jsx("div",{className:"p-3 md:p-4 border rounded-lg",children:n&&n.id===i.id&&!w?e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"h-4 w-4 flex-shrink-0"}),e.jsx(Ae,{type:"date",value:S,onChange:u=>{const Q=u.target.value;T(Q),c!=="rehearsal"&&R(Q)},required:!0,className:"text-sm"})]}),c==="rehearsal"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"h-4 w-4 flex-shrink-0"}),e.jsx(Ae,{type:"date",value:q,min:S,onChange:u=>R(u.target.value),required:!0,className:"text-sm"})]}),e.jsx(it,{value:p,onInputChange:u=>{a(u),ee(null)},onSelect:u=>{a(u.name),ee({name:u.name,address:u.address,coordinates:u.coordinates,place_id:u.place_id})},placeholder:"Location",label:"Location",className:"w-full"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Je,{id:"tour-pack-only-edit",checked:H,onCheckedChange:u=>E(u)}),e.jsx(Ce,{htmlFor:"tour-pack-only-edit",className:"text-xs md:text-sm",children:"Tour Pack Only (skip PA pullsheet)"})]}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row gap-2",children:[e.jsx($,{variant:"outline",onClick:Y,className:"w-full sm:w-auto",children:"Cancel"}),e.jsx($,{onClick:()=>Z(i.id),className:"w-full sm:w-auto",children:"Save"})]})]}):e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{className:"space-y-1 flex-1 min-w-0",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs md:text-sm",children:[e.jsx(Le,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{children:xe(new Date(i.date),"MMM d, yyyy")}),i.is_tour_pack_only&&e.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs",children:[e.jsx(dt,{className:"h-3 w-3"}),e.jsx("span",{className:"hidden sm:inline",children:"Tour Pack Only"}),e.jsx("span",{className:"sm:hidden",children:"TP Only"})]})]}),((A=i.location)==null?void 0:A.name)&&e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-muted-foreground",children:[e.jsx(ot,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:i.location.name})]}),v&&e.jsx("div",{className:"text-xs text-green-600",children:"✓ Flex folders created"})]}),e.jsx("div",{className:"flex gap-1 md:gap-2 self-end sm:self-auto",children:!w&&e.jsxs(e.Fragment,{children:[e.jsx($,{variant:"ghost",size:"icon",onClick:()=>z(i),title:"Create Flex folders",disabled:v||W,className:`h-9 w-9 touch-manipulation ${v?"opacity-50 cursor-not-allowed":""}`,children:W?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}):e.jsx(Nt,{className:"h-4 w-4"})}),e.jsx($,{variant:"ghost",size:"icon",onClick:()=>x(i),title:"Edit Date",disabled:y,className:"h-9 w-9 touch-manipulation",children:e.jsx(Dt,{className:"h-4 w-4"})}),e.jsx($,{variant:"ghost",size:"icon",onClick:()=>re(i.id),title:"Delete Date",disabled:y,className:`h-9 w-9 touch-manipulation ${y?"opacity-50 cursor-not-allowed":""}`,children:y?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}):e.jsx(pe,{className:"h-4 w-4"})})]})})]})},i.id)})}),!w&&e.jsxs("div",{className:"space-y-3 md:space-y-4 border-t pt-4",children:[e.jsx("h3",{className:"text-base md:text-lg font-semibold",children:"Add New Date"}),e.jsx(Vt,{location:oe,setLocation:ce,setLocationDetails:Te,tourDateType:ie,setTourDateType:ve,startDate:me,setStartDate:ke,endDate:o,setEndDate:f}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Je,{id:"tour-pack-only",checked:m,onCheckedChange:i=>J(i)}),e.jsx(Ce,{htmlFor:"tour-pack-only",className:"text-xs md:text-sm",children:"Tour Pack Only (skip PA pullsheet)"})]}),e.jsxs($,{onClick:()=>{if(!me||!oe){_({title:"Error",description:"Please fill in all required fields",variant:"destructive"});return}ne(oe,ie,me,o||me,m),ce(""),Te(null),ve("show"),ke(""),f(""),J(!1)},className:"w-full touch-manipulation",children:[e.jsx(St,{className:"h-4 w-4 mr-2"}),e.jsxs("span",{className:"hidden sm:inline",children:["Add ",ie==="rehearsal"?"Rehearsal Period":ie==="travel"?"Travel Day":"Show Date"]}),e.jsxs("span",{className:"sm:hidden",children:["Add ",ie==="rehearsal"?"Rehearsal":ie==="travel"?"Travel":"Show"]})]})]})]})})]})})})},Jt=({color:r,tourName:j,tourDescription:t="",invoicingCompany:s=null,onColorChange:w,onNameChange:_,onDescriptionChange:d,onInvoicingCompanyChange:M})=>{const[N,h]=k.useState(j),[n,P]=k.useState(t);k.useEffect(()=>{h(j)},[j]),k.useEffect(()=>{P(t)},[t]);const p=async()=>{if(N!==j)try{await _(N)}catch{}},a=async()=>{if(n!==t)try{await d(n)}catch{}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Bt,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"Tour Color"})]}),e.jsx(pt,{color:r,onChange:w})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"font-medium",children:"Tour Name"})}),e.jsx("input",{type:"text",value:N,onChange:c=>h(c.target.value),onBlur:p,className:"w-full border rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(We,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"Tour Description"})]}),e.jsx(xt,{value:n,onChange:c=>P(c.target.value),onBlur:a,placeholder:"Enter tour description...",className:"w-full min-h-[80px]"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Et,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"Invoicing Company"})]}),e.jsxs(tt,{value:s||"none",onValueChange:c=>M(c==="none"?null:c),children:[e.jsx(at,{children:e.jsx(st,{placeholder:"Select invoicing company (optional)"})}),e.jsxs(rt,{children:[e.jsx(_e,{value:"none",children:"None"}),e.jsx(_e,{value:"Production Sector",children:"Production Sector"}),e.jsx(_e,{value:"Sharecable",children:"Sharecable"}),e.jsx(_e,{value:"MFO",children:"MFO"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"All tour date jobs will inherit this invoicing company"})]})]})},Yt=({onDelete:r})=>e.jsxs(Ct,{children:[e.jsx(Pt,{asChild:!0,children:e.jsxs($,{variant:"destructive",className:"w-full",children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Delete Tour"]})}),e.jsxs(kt,{children:[e.jsxs(Mt,{children:[e.jsx(qt,{children:"Are you absolutely sure?"}),e.jsx(Ft,{children:"This action cannot be undone. This will permanently delete the tour and all associated tour dates and jobs."})]}),e.jsxs(At,{children:[e.jsx($t,{children:"Cancel"}),e.jsx(Lt,{onClick:r,children:"Delete"})]})]})]}),Xt=r=>{const{toast:j}=Se(),t=Pe(),{data:s=[],isLoading:w,error:_}=nt({queryKey:["tour-weight-defaults",r],queryFn:async()=>{const{data:h,error:n}=await l.from("tour_weight_defaults").select("*").eq("tour_id",r).order("created_at",{ascending:!0});if(n)throw n;return h},enabled:!!r}),d=Ue({mutationFn:async h=>{const{data:n,error:P}=await l.from("tour_weight_defaults").insert(h).select().single();if(P)throw P;return n},onSuccess:()=>{t.invalidateQueries({queryKey:["tour-weight-defaults",r]}),j({title:"Success",description:"Weight default created successfully"})},onError:h=>{j({title:"Error",description:h.message||"Failed to create weight default",variant:"destructive"})}}),M=Ue({mutationFn:async h=>{const{error:n}=await l.from("tour_weight_defaults").update({item_name:h.item_name,weight_kg:h.weight_kg,quantity:h.quantity,category:h.category,department:h.department}).eq("id",h.id);if(n)throw n;return h},onSuccess:()=>{t.invalidateQueries({queryKey:["tour-weight-defaults",r]})}}),N=Ue({mutationFn:async h=>{const{error:n}=await l.from("tour_weight_defaults").delete().eq("id",h);if(n)throw n;return h},onSuccess:()=>{t.invalidateQueries({queryKey:["tour-weight-defaults",r]})}});return{weightDefaults:s,isLoading:w,error:_,createDefault:d.mutateAsync,updateDefault:M.mutateAsync,deleteDefault:N.mutateAsync,isCreating:d.isPending,isUpdating:M.isPending,isDeleting:N.isPending}},Ot=({open:r,onOpenChange:j,tour:t})=>{const{toast:s}=Se(),[w,_]=k.useState("sound"),[d,M]=k.useState([]),{defaultSets:N,defaultTables:h,isLoading:n,deleteSet:P,deleteTable:p,isDeletingSet:a,isDeletingTable:c}=Wt((t==null?void 0:t.id)||""),{powerDefaults:b,isLoading:S,deleteDefault:T}=Ut((t==null?void 0:t.id)||""),{weightDefaults:q,isLoading:R,deleteDefault:H}=Xt((t==null?void 0:t.id)||"");$e.useEffect(()=>{(async()=>{if(!(t!=null&&t.id))return;const{data:f,error:m}=await l.from("tour_dates").select(`
          id,
          date,
          locations (
            name
          )
        `).eq("tour_id",t.id).order("date",{ascending:!0});m||M(f||[])})()},[t==null?void 0:t.id]);const E=o=>"set_id"in o||"table_data"in o,F=o=>"total_watts"in o&&!("set_id"in o),D=o=>"weight_kg"in o&&!("set_id"in o),C=(o,f)=>{const m=N.filter(B=>B.department===o),J=h.filter(B=>m.some(ee=>ee.id===B.set_id)&&B.table_type===f);return J.length>0?J:f==="power"?b.filter(B=>B.department===o||!B.department&&o==="sound"):q.filter(B=>B.department===o||!B.department&&o==="sound")},G=async(o,f)=>{try{E(o)?await p(o.id):f==="power"&&F(o)?await T(o.id):f==="weight"&&D(o)&&await H(o.id)}catch{s({title:"Error",description:"Error al eliminar la tabla",variant:"destructive"})}},se=async o=>{try{await P(o)}catch{s({title:"Error",description:"Error al eliminar el conjunto",variant:"destructive"})}},O=o=>E(o)?o.table_name||"Unnamed":(F(o)||D(o))&&(o.table_name||o.item_name)||"Unnamed",oe=o=>E(o)?o.total_value||0:F(o)&&o.total_watts||0,ce=o=>E(o)?o.total_value||0:D(o)?(o.weight_kg||0)*(o.quantity||1):0,ue=o=>{var f;if(E(o))return(f=o.metadata)==null?void 0:f.current_per_phase;if(F(o))return o.current_per_phase},Te=async(o,f)=>{try{const m=C(o,f);if(m.length===0){s({title:"No se encontraron valores por defecto",description:`No se encontraron valores por defecto de ${f==="power"?"potencia":"peso"} para el departamento de ${o}`,variant:"destructive"});return}let J;try{J=await ze(t.id)}catch{}const ee=[...m].sort((x,Y)=>{var Z,i;if(E(x)&&E(Y)){const v=((Z=x.metadata)==null?void 0:Z.order_index)??999,y=((i=Y.metadata)==null?void 0:i.order_index)??999;return v!==y?v-y:new Date(x.created_at).getTime()-new Date(Y.created_at).getTime()}return 0}).map(x=>{var Y,Z,i,v,y,W,A,u,Q,L;return E(x)&&((Y=x.table_data)!=null&&Y.rows)?{name:O(x),rows:x.table_data.rows||[],totalWeight:f==="weight"?x.total_value:void 0,totalWatts:f==="power"?x.total_value:void 0,currentPerPhase:f==="power"?(Z=x.metadata)==null?void 0:Z.current_per_phase:void 0,pduType:f==="power"?((i=x.metadata)==null?void 0:i.custom_pdu_type)||((v=x.metadata)==null?void 0:v.pdu_type):void 0,customPduType:f==="power"?(y=x.metadata)==null?void 0:y.custom_pdu_type:void 0,includesHoist:f==="power"?((W=x.metadata)==null?void 0:W.includes_hoist)||!1:void 0,dualMotors:f==="weight"?((A=x.metadata)==null?void 0:A.dualMotors)||!1:void 0,riggingPoint:f==="weight"?(u=x.metadata)==null?void 0:u.riggingPoint:void 0,toolType:f==="power"?"consumos":"pesos",id:Date.now()+Math.random()}:{name:O(x),rows:[{quantity:"1",componentName:O(x),weight:f==="weight"&&D(x)?(Q=x.weight_kg)==null?void 0:Q.toString():void 0,watts:f==="power"&&F(x)?(L=x.total_watts)==null?void 0:L.toString():void 0,totalWeight:f==="weight"?ce(x):void 0,totalWatts:f==="power"?oe(x):void 0}],totalWeight:f==="weight"?ce(x):void 0,totalWatts:f==="power"?oe(x):void 0,currentPerPhase:f==="power"?ue(x):void 0,pduType:f==="power"&&F(x)?x.custom_pdu_type||x.pdu_type:void 0,customPduType:f==="power"&&F(x)?x.custom_pdu_type:void 0,includesHoist:f==="power"&&F(x)?x.includes_hoist||!1:void 0,toolType:f==="power"?"consumos":"pesos",id:Date.now()+Math.random()}});let g;if(f==="power"){const x=ee.reduce((Z,i)=>Z+(i.totalWatts||0),0),Y=ee.reduce((Z,i)=>{const v=i.currentPerPhase||0;return Z+v},0);g={totalSystemWatts:x,totalSystemAmps:Y}}const V=(()=>{var Y,Z;const x=m[0];return E(x)&&((Y=x.metadata)!=null&&Y.safetyMargin)?x.metadata.safetyMargin:E(x)&&((Z=x.table_data)!=null&&Z.safetyMargin)?x.table_data.safetyMargin:0})(),z=await Ye(`${t.name} - ${o.toUpperCase()} ${f.toUpperCase()} Defaults`,ee,f,t.name,new Date().toLocaleDateString("en-GB"),void 0,g,V,J),ne=`${t.name} - ${o} ${f} defaults.pdf`,he=window.URL.createObjectURL(z),re=document.createElement("a");re.href=he,re.download=ne,document.body.appendChild(re),re.click(),window.URL.revokeObjectURL(he),document.body.removeChild(re),s({title:"Éxito",description:"PDF exportado exitosamente"})}catch{s({title:"Error",description:"Error al exportar PDF",variant:"destructive"})}},ie=async(o,f)=>{try{if(d.length===0){s({title:"No se encontraron fechas de gira",description:"No hay fechas de gira disponibles para exportar",variant:"destructive"});return}let m;try{m=await ze(t.id)}catch{}for(const J of d)await ve(J,o,f,m);s({title:"Éxito",description:`Se exportaron ${d.length} PDFs para todas las fechas de gira`})}catch{s({title:"Error",description:"Error al exportar los PDFs de las fechas de gira",variant:"destructive"})}},ve=async(o,f,m,J)=>{var v,y,W;const B=C(f,m),ee=m==="power"?"tour_date_power_overrides":"tour_date_weight_overrides",{data:g}=await l.from(ee).select("*").eq("tour_date_id",o.id).eq("department",f);let V,z=0;if(g&&g.length>0?(V=g.map(A=>{var u;return{name:A.table_name||A.item_name||"Override",rows:((u=A.override_data)==null?void 0:u.rows)||[],totalWeight:m==="weight"?(A.weight_kg||0)*(A.quantity||1):void 0,totalWatts:m==="power"?A.total_watts||0:void 0,currentPerPhase:m==="power"?A.current_per_phase:void 0,pduType:m==="power"?A.custom_pdu_type||A.pdu_type:void 0,customPduType:m==="power"?A.custom_pdu_type:void 0,includesHoist:m==="power"?A.includes_hoist||!1:void 0,toolType:m==="power"?"consumos":"pesos",id:Date.now()+Math.random()}}),z=((y=(v=g[0])==null?void 0:v.override_data)==null?void 0:y.safetyMargin)||0):V=[...B].sort((u,Q)=>{var L,U;if(E(u)&&E(Q)){const K=((L=u.metadata)==null?void 0:L.order_index)??999,I=((U=Q.metadata)==null?void 0:U.order_index)??999;return K!==I?K-I:new Date(u.created_at).getTime()-new Date(Q.created_at).getTime()}return 0}).map(u=>{var Q,L,U,K,I,le,te,we,de,ae;return E(u)&&((Q=u.table_data)!=null&&Q.rows)?{name:O(u),rows:u.table_data.rows||[],totalWeight:m==="weight"?u.total_value:void 0,totalWatts:m==="power"?u.total_value:void 0,currentPerPhase:m==="power"?(L=u.metadata)==null?void 0:L.current_per_phase:void 0,pduType:m==="power"?((U=u.metadata)==null?void 0:U.custom_pdu_type)||((K=u.metadata)==null?void 0:K.pdu_type):void 0,customPduType:m==="power"?(I=u.metadata)==null?void 0:I.custom_pdu_type:void 0,includesHoist:m==="power"?((le=u.metadata)==null?void 0:le.includes_hoist)||!1:void 0,dualMotors:m==="weight"?((te=u.metadata)==null?void 0:te.dualMotors)||!1:void 0,riggingPoint:m==="weight"?(we=u.metadata)==null?void 0:we.riggingPoint:void 0,toolType:m==="power"?"consumos":"pesos",id:Date.now()+Math.random()}:{name:O(u),rows:[{quantity:"1",componentName:O(u),weight:m==="weight"&&D(u)?(de=u.weight_kg)==null?void 0:de.toString():void 0,watts:m==="power"&&F(u)?(ae=u.total_watts)==null?void 0:ae.toString():void 0,totalWeight:m==="weight"?ce(u):void 0,totalWatts:m==="power"?oe(u):void 0}],totalWeight:m==="weight"?ce(u):void 0,totalWatts:m==="power"?oe(u):void 0,currentPerPhase:m==="power"?ue(u):void 0,pduType:m==="power"&&F(u)?u.custom_pdu_type||u.pdu_type:void 0,customPduType:m==="power"&&F(u)?u.custom_pdu_type:void 0,includesHoist:m==="power"&&F(u)?u.includes_hoist||!1:void 0,toolType:m==="power"?"consumos":"pesos",id:Date.now()+Math.random()}}),V.length===0)return;let ne;if(m==="power"){const A=V.reduce((Q,L)=>Q+(L.totalWatts||0),0),u=V.reduce((Q,L)=>{const U=L.currentPerPhase||0;return Q+U},0);ne={totalSystemWatts:A,totalSystemAmps:u}}const he=((W=o.locations)==null?void 0:W.name)||"Unknown Location",re=o.date,x=await Ye(`${t.name} - ${he} - ${f.toUpperCase()} ${m.toUpperCase()}`,V,m,`${t.name} - ${he}`,re,void 0,ne,z,J),Y=`${t.name} - ${re} - ${he} - ${f} ${m}.pdf`,Z=window.URL.createObjectURL(x),i=document.createElement("a");i.href=Z,i.download=Y,document.body.appendChild(i),i.click(),window.URL.revokeObjectURL(Z),document.body.removeChild(i)},me=o=>{const f=C(o,"power"),m=C(o,"weight"),J=N.filter(g=>g.department===o),B=J.filter(g=>h.some(V=>V.set_id===g.id&&V.table_type==="power")),ee=J.filter(g=>h.some(V=>V.set_id===g.id&&V.table_type==="weight"));return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(ct,{className:"h-5 w-5"}),"Valores por Defecto de Potencia (",f.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs($,{variant:"outline",size:"sm",onClick:()=>Te(o,"power"),disabled:f.length===0,children:[e.jsx(We,{className:"h-4 w-4 mr-1"}),"Exportar PDF de Valores"]}),e.jsxs($,{variant:"outline",size:"sm",onClick:()=>ie(o,"power"),disabled:f.length===0||d.length===0,children:[e.jsx(Xe,{className:"h-4 w-4 mr-1"}),"PDFs Masivos de Fechas"]})]})]}),B.map(g=>{const V=h.filter(z=>z.set_id===g.id&&z.table_type==="power");return e.jsxs("div",{className:"mb-6 border rounded-lg p-4 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium text-lg",children:g.name}),g.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:g.description})]}),e.jsx($,{variant:"ghost",size:"sm",onClick:()=>se(g.id),disabled:a,className:"text-destructive hover:text-destructive",children:e.jsx(pe,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:V.map(z=>{var ne;return e.jsxs("div",{className:"border rounded-lg p-4 bg-white",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("h6",{className:"font-medium",children:z.table_name}),e.jsx($,{variant:"ghost",size:"sm",onClick:()=>G(z,"power"),disabled:c,className:"text-destructive hover:text-destructive",children:e.jsx(pe,{className:"h-4 w-4"})})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[z.total_value.toFixed(2)," W"]}),((ne=z.metadata)==null?void 0:ne.current_per_phase)&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[z.metadata.current_per_phase.toFixed(2)," A per phase"]})]},z.id)})})]},g.id)}),f.filter(g=>!E(g)).length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:f.filter(g=>!E(g)).map(g=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("h5",{className:"font-medium",children:O(g)}),e.jsx($,{variant:"ghost",size:"sm",onClick:()=>G(g,"power"),className:"text-destructive hover:text-destructive",children:e.jsx(pe,{className:"h-4 w-4"})})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[oe(g).toFixed(2)," W"]}),ue(g)&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[ue(g).toFixed(2)," A per phase"]})]},g.id))}),f.length===0&&e.jsx("p",{className:"text-muted-foreground",children:"No hay valores por defecto de potencia configurados"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(mt,{className:"h-5 w-5"}),"Valores por Defecto de Peso (",m.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs($,{variant:"outline",size:"sm",onClick:()=>Te(o,"weight"),disabled:m.length===0,children:[e.jsx(We,{className:"h-4 w-4 mr-1"}),"Exportar PDF de Valores"]}),e.jsxs($,{variant:"outline",size:"sm",onClick:()=>ie(o,"weight"),disabled:m.length===0||d.length===0,children:[e.jsx(Xe,{className:"h-4 w-4 mr-1"}),"PDFs Masivos de Fechas"]})]})]}),ee.map(g=>{const V=h.filter(z=>z.set_id===g.id&&z.table_type==="weight");return e.jsxs("div",{className:"mb-6 border rounded-lg p-4 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium text-lg",children:g.name}),g.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:g.description})]}),e.jsx($,{variant:"ghost",size:"sm",onClick:()=>se(g.id),disabled:a,className:"text-destructive hover:text-destructive",children:e.jsx(pe,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:V.map(z=>e.jsxs("div",{className:"border rounded-lg p-4 bg-white",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("h6",{className:"font-medium",children:z.table_name}),e.jsx($,{variant:"ghost",size:"sm",onClick:()=>G(z,"weight"),disabled:c,className:"text-destructive hover:text-destructive",children:e.jsx(pe,{className:"h-4 w-4"})})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[z.total_value.toFixed(2)," kg"]})]},z.id))})]},g.id)}),m.filter(g=>!E(g)).length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:m.filter(g=>!E(g)).map(g=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("h5",{className:"font-medium",children:O(g)}),e.jsx($,{variant:"ghost",size:"sm",onClick:()=>G(g,"weight"),className:"text-destructive hover:text-destructive",children:e.jsx(pe,{className:"h-4 w-4"})})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[ce(g).toFixed(2)," kg"]}),D(g)&&g.quantity&&g.weight_kg&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[g.quantity," × ",g.weight_kg.toFixed(2)," kg"]})]},g.id))}),m.length===0&&e.jsx("p",{className:"text-muted-foreground",children:"No hay valores por defecto de peso configurados"})]})]})},ke=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2 mb-3",children:[e.jsx(Le,{className:"h-5 w-5"}),"Fechas de Gira (",d.length,")"]}),e.jsx("p",{className:"text-sm text-green-700 mb-4",children:"Exporta PDFs individuales para cada fecha de gira, incluyendo valores por defecto y anulaciones."})]}),d.length>0?e.jsx("div",{className:"grid grid-cols-1 gap-4",children:d.map(o=>{var f;return e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsx("div",{className:"flex justify-between items-start mb-3",children:e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:new Date(o.date).toLocaleDateString("en-GB")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:((f=o.locations)==null?void 0:f.name)||"Unknown Location"})]})}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:["sound","lights","video"].map(m=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-sm font-medium capitalize",children:m}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx($,{variant:"outline",size:"sm",onClick:()=>ve(o,m,"power"),className:"text-xs",children:"PDF de Potencia"}),e.jsx($,{variant:"outline",size:"sm",onClick:()=>ve(o,m,"weight"),className:"text-xs",children:"PDF de Peso"})]})]},m))})]},o.id)})}):e.jsx("p",{className:"text-muted-foreground",children:"No hay fechas de gira configuradas"})]});return e.jsx(Re,{open:r,onOpenChange:j,children:e.jsxs(Ke,{className:"max-w-5xl w-[95vw] md:w-full max-h-[95vh] md:max-h-[80vh] overflow-y-auto",children:[e.jsx(Ie,{children:e.jsxs(Ge,{className:"text-base md:text-lg truncate",children:["Valores por Defecto de Gira: ",t==null?void 0:t.name]})}),e.jsxs(zt,{value:w,onValueChange:_,children:[e.jsxs(Qt,{className:"grid w-full grid-cols-4",children:[e.jsx(qe,{value:"sound",children:"Sonido"}),e.jsx(qe,{value:"lights",children:"Luces"}),e.jsx(qe,{value:"video",children:"Vídeo"}),e.jsx(qe,{value:"tour-dates",children:"Fechas de Gira"})]}),e.jsx(Fe,{value:"sound",className:"mt-6",children:n||S||R?e.jsx("p",{children:"Cargando valores por defecto de sonido..."}):me("sound")}),e.jsx(Fe,{value:"lights",className:"mt-6",children:n||S||R?e.jsx("p",{children:"Cargando valores por defecto de luces..."}):me("lights")}),e.jsx(Fe,{value:"video",className:"mt-6",children:n||S||R?e.jsx("p",{children:"Cargando valores por defecto de vídeo..."}):me("video")}),e.jsx(Fe,{value:"tour-dates",className:"mt-6",children:ke()})]})]})})},ea=(r,j)=>{const{toast:t}=Se(),s=Pe();return{handleColorChange:async h=>{try{const{error:n}=await l.from("tours").update({color:h}).eq("id",r.id);if(n)throw n;const{data:P,error:p}=await l.from("tour_dates").select("id").eq("tour_id",r.id);if(p)throw p;if(P&&P.length>0){const{error:a}=await l.from("jobs").update({color:h}).in("tour_date_id",P.map(c=>c.id));if(a)throw a}await s.invalidateQueries({queryKey:["tours-with-dates"]}),await s.invalidateQueries({queryKey:["optimized-jobs"]}),await s.invalidateQueries({queryKey:["jobs"]}),t({title:"Color updated successfully"})}catch(n){t({title:"Error updating color",description:n.message,variant:"destructive"})}},handleNameChange:async h=>{try{const{error:n}=await l.from("tours").update({name:h}).eq("id",r.id);if(n)throw n;await s.invalidateQueries({queryKey:["tours-with-dates"]}),t({title:"Tour name updated successfully"})}catch(n){t({title:"Error updating tour name",description:n.message,variant:"destructive"})}},handleDescriptionChange:async h=>{try{const{error:n}=await l.from("tours").update({description:h}).eq("id",r.id);if(n)throw n;await s.invalidateQueries({queryKey:["tours-with-dates"]}),await s.invalidateQueries({queryKey:["tour",r.id]}),t({title:"Tour description updated successfully"})}catch(n){t({title:"Error updating tour description",description:n.message,variant:"destructive"})}},handleInvoicingCompanyChange:async h=>{try{const{error:n}=await l.from("tours").update({invoicing_company:h}).eq("id",r.id);if(n)throw n;const{data:P,error:p}=await l.from("tour_dates").select("id").eq("tour_id",r.id);if(p)throw p;if(P&&P.length>0){const{error:a}=await l.from("jobs").update({invoicing_company:h}).in("tour_date_id",P.map(c=>c.id));if(a)throw a}await s.invalidateQueries({queryKey:["tours-with-dates"]}),await s.invalidateQueries({queryKey:["tour",r.id]}),await s.invalidateQueries({queryKey:["optimized-jobs"]}),await s.invalidateQueries({queryKey:["jobs"]}),t({title:"Invoicing company updated successfully"})}catch(n){t({title:"Error updating invoicing company",description:n.message,variant:"destructive"})}},handleDelete:async()=>{try{const{data:h,error:n}=await l.from("tour_dates").select("id").eq("tour_id",r.id);if(n)throw n;if(h&&h.length>0){const p=h.map(T=>T.id),{data:a,error:c}=await l.from("jobs").select("id").in("tour_date_id",p);if(c)throw c;if(a&&a.length>0)for(const T of a){const q=await bt(T.id);if(!q.success)throw new Error(`Failed to delete job ${T.id}: ${q.error}`)}const{error:b}=await l.from("flex_folders").delete().in("tour_date_id",p);if(b)throw b;await Promise.all([l.from("tour_date_power_overrides").delete().in("tour_date_id",p),l.from("tour_date_weight_overrides").delete().in("tour_date_id",p)]);const{error:S}=await l.from("tour_dates").delete().eq("tour_id",r.id);if(S)throw S}await Promise.all([l.from("tour_logos").delete().eq("tour_id",r.id),l.from("tour_power_defaults").delete().eq("tour_id",r.id),l.from("tour_weight_defaults").delete().eq("tour_id",r.id),l.from("tour_default_sets").delete().eq("tour_id",r.id),l.from("tour_assignments").delete().eq("tour_id",r.id)]);const{error:P}=await l.from("tours").delete().eq("id",r.id);if(P)throw P;await s.invalidateQueries({queryKey:["tours-with-dates"]}),await s.invalidateQueries({queryKey:["tours"]}),await s.invalidateQueries({queryKey:["optimized-jobs"]}),await s.invalidateQueries({queryKey:["jobs"]}),j(),t({title:"Tour deleted successfully"})}catch(h){t({title:"Error deleting tour",description:h.message,variant:"destructive"})}}}},ta=({tourId:r})=>{const{toast:j}=Se(),{user:t}=wt(),[s,w]=k.useState(!1),[_,d]=k.useState(null),[M,N]=k.useState(null),h=k.useCallback(async()=>{try{if(!r)return;const{data:p,error:a}=await l.from("tour_logos").select("file_path").eq("tour_id",r).maybeSingle();if(a){N(`Failed to fetch logo: ${a.message}`);return}if(p!=null&&p.file_path)try{const{data:c}=await l.storage.from("tour-logos").createSignedUrl(p.file_path,3600);if(c!=null&&c.signedUrl)d(c.signedUrl);else{const{data:b}=l.storage.from("tour-logos").getPublicUrl(p.file_path);b!=null&&b.publicUrl&&d(b.publicUrl)}}catch(c){N(`Failed to get logo URL: ${c.message}`)}else d(null)}catch(p){N(`Unexpected error: ${p.message}`)}},[r]),n=async p=>{var b;N(null);const a=(b=p.target.files)==null?void 0:b[0];if(!a)return;if(!a.type.startsWith("image/")){j({title:"Invalid file type",description:"Please upload an image file",variant:"destructive"});return}if(!t){j({title:"Authentication required",description:"You must be logged in to upload logos",variant:"destructive"});return}const c=t.id;w(!0);try{const{data:S,error:T}=await l.auth.getSession();if(T||!S.session)throw new Error("Authentication error: "+((T==null?void 0:T.message)||"Session not found"));const q=a.name.split(".").pop(),R=`${r}.${q}`,{data:H,error:E}=await l.from("tour_logos").select("file_path").eq("tour_id",r).maybeSingle();if(E)throw new Error(`Error fetching existing logo: ${E.message}`);if(H!=null&&H.file_path){const{error:se}=await l.storage.from("tour-logos").remove([H.file_path])}const{error:F}=await l.storage.from("tour-logos").upload(R,a,{upsert:!0,cacheControl:"3600"});if(F)throw new Error(`Error uploading logo: ${F.message}`);const{error:D}=await l.from("tour_logos").upsert({tour_id:r,file_path:R,file_name:a.name,content_type:a.type,file_size:a.size,uploaded_by:c});if(D)throw new Error(`Error saving logo information: ${D.message}`);const{data:C}=await l.storage.from("tour-logos").createSignedUrl(R,3600),G=(C==null?void 0:C.signedUrl)||l.storage.from("tour-logos").getPublicUrl(R).data.publicUrl;d(G),j({title:"Success",description:"Tour logo has been updated"})}catch(S){const T=S.message||"Could not upload logo";N(T),j({title:"Error",description:T,variant:"destructive"})}finally{w(!1)}},P=async()=>{if(N(null),!t){j({title:"Authentication required",description:"You must be logged in to delete logos",variant:"destructive"});return}t.id;try{const{data:p,error:a}=await l.auth.getSession();if(a||!p.session)throw new Error("Authentication error: "+((a==null?void 0:a.message)||"Session not found"));const{data:c,error:b}=await l.from("tour_logos").select("file_path").eq("tour_id",r).maybeSingle();if(b)throw new Error(`Error fetching logo: ${b.message}`);if(c!=null&&c.file_path){const{error:S}=await l.storage.from("tour-logos").remove([c.file_path]);if(S)throw new Error(`Error removing logo: ${S.message}`);const{error:T}=await l.from("tour_logos").delete().eq("tour_id",r);if(T)throw new Error(`Error deleting logo record: ${T.message}`);d(null),j({title:"Success",description:"Tour logo has been removed"})}}catch(p){const a=p.message||"Could not delete logo";N(a),j({title:"Error",description:a,variant:"destructive"})}};return k.useEffect(()=>{r&&h()},[r,h]),e.jsxs("div",{className:"space-y-4",children:[_?e.jsxs("div",{className:"relative w-36 h-36",children:[e.jsx("img",{src:_,alt:"Tour logo",width:144,height:144,loading:"lazy",decoding:"async",className:"w-full h-full object-contain",onError:p=>{const a=p.target;a.onerror=null,a.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMTRIMTRWMTZIMTBWMTRaIiBmaWxsPSJjdXJyZW50Q29sb3IiLz48cGF0aCBkPSJNMTIgMUMxNC4yMDkxIDEgMTYgMi43OTA4NiAxNiA1QzE2IDcuMjA5MTQgMTQuMjA5MSA5IDEyIDlDOS43OTA4NiA5IDggNy4yMDkxNCA4IDVDOCAyLjc5MDg2IDkuNzkwODYgMSAxMiAxWiIgZmlsbD0iY3VycmVudENvbG9yIi8+PHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xIDEzQzEgMTAuNzkwOSAyLjc5MDg2IDkgNSA5SDE5QzIxLjIwOTEgOSAyMyAxMC43OTA5IDIzIDEzVjE5QzIzIDIwLjEwNDYgMjIuMTA0NiAyMSAyMSAyMUgzQzEuODk1NDMgMjEgMSAyMC4xMDQ2IDEgMTlWMTNaTTE5IDExSDVDMy44OTU0MyAxMSAzIDExLjg5NTQgMyAxM0MzIDE1LjIwOTEgNC43OTA5MSAxNyA3IDE3SDE3QzE5LjIwOTEgMTcgMjEgMTUuMjA5MSAyMSAxM0MyMSAxMS44OTU0IDIwLjEwNDYgMTEgMTkgMTFaIiBmaWxsPSJjdXJyZW50Q29sb3IiLz48L3N2Zz4="}}),e.jsx($,{variant:"destructive",size:"icon",className:"absolute top-2 right-2",onClick:P,children:e.jsx(_t,{className:"h-4 w-4"})})]}):e.jsx("div",{className:"w-36 h-36 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center",children:e.jsx(Rt,{className:"h-12 w-12 text-gray-400"})}),M&&e.jsxs("div",{className:"text-sm text-red-500 mt-1",children:["Error: ",M]}),e.jsxs("div",{children:[e.jsx("input",{type:"file",id:"logo-upload",accept:"image/*",className:"hidden",onChange:n,disabled:s}),e.jsx($,{asChild:!0,variant:"outline",disabled:s,children:e.jsxs("label",{htmlFor:"logo-upload",className:"cursor-pointer",children:[e.jsx(Kt,{className:"h-4 w-4 mr-2"}),s?"Uploading...":"Upload Logo"]})})]})]})},Aa=({open:r,onOpenChange:j,tour:t,tourDateId:s})=>{const w=vt(),{toast:_}=Se(),d=Pe(),{handleColorChange:M,handleNameChange:N,handleDescriptionChange:h,handleInvoicingCompanyChange:n,handleDelete:P}=ea(t,()=>j(!1)),[p,a]=k.useState(!1),[c,b]=k.useState(!1),[S,T]=k.useState(!1),q=()=>{const D=new URLSearchParams({tourId:t.id,mode:s?"override":"defaults"});s&&D.append("tourDateId",s),w(`/sound/consumos?${D.toString()}`),j(!1)},R=()=>{const D=new URLSearchParams({tourId:t.id,mode:s?"override":"defaults"});s&&D.append("tourDateId",s),w(`/sound/pesos?${D.toString()}`),j(!1)},H=()=>{a(!0)},E=async D=>{b(!0);try{const{error:C}=await l.from("tour_dates").update({is_tour_pack_only:D}).eq("tour_id",t.id);if(C)throw C;await d.invalidateQueries({queryKey:["tour",t.id]}),await d.invalidateQueries({queryKey:["tours"]}),_({title:"Éxito",description:`Todas las fechas de gira ${D?"configuradas en":"eliminadas de"} modo Solo Tour Pack.`})}catch(C){_({title:"Error",description:C.message,variant:"destructive"})}finally{b(!1)}},F=async()=>{const D=t.status==="active"?"cancelled":"active";T(!0);try{const{error:C}=await l.from("tours").update({status:D}).eq("id",t.id);if(C)throw C;if(D==="cancelled"){const{error:G}=await l.from("jobs").update({status:"Cancelado"}).eq("tour_id",t.id).eq("job_type","tourdate")}await d.invalidateQueries({queryKey:["tour",t.id]}),await d.invalidateQueries({queryKey:["tours"]}),await d.invalidateQueries({queryKey:["jobs"]}),await d.invalidateQueries({queryKey:["optimized-jobs"]}),_({title:"Éxito",description:`Gira ${D==="cancelled"?"cancelada":"reactivada"} exitosamente`})}catch(C){_({title:"Error",description:`Error al ${D==="cancelled"?"cancelar":"reactivar"} la gira: ${C.message}`,variant:"destructive"})}finally{T(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx(Re,{open:r,onOpenChange:j,children:e.jsxs(Ke,{className:"max-w-2xl max-h-[95vh] md:max-h-[90vh] overflow-y-auto w-[95vw] md:w-full",children:[e.jsx(Ie,{children:e.jsxs(Ge,{className:"text-base md:text-lg",children:["Gestionar Gira: ",t.name,s&&e.jsx("span",{className:"text-sm text-muted-foreground ml-2",children:"(Modo Anulación)"})]})}),e.jsxs("div",{className:"space-y-4 md:space-y-6",children:[e.jsxs("div",{className:"border-b pb-4",children:[e.jsx("h3",{className:"text-sm font-medium mb-3",children:"Logo de Gira"}),e.jsx(ta,{tourId:t.id})]}),e.jsxs("div",{className:"border-b pb-4",children:[e.jsx("h3",{className:"text-sm font-medium mb-3",children:"Estado de Gira"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg",children:[e.jsx("div",{className:"flex items-center gap-3",children:t.status==="cancelled"?e.jsxs(e.Fragment,{children:[e.jsx(Oe,{className:"h-4 w-4 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Gira Cancelada"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Esta gira está oculta de las vistas principales"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(It,{className:"h-4 w-4 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Gira Activa"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Esta gira es visible en todas las vistas"})]})]})}),e.jsx($,{variant:t.status==="cancelled"?"default":"destructive",size:"sm",onClick:F,disabled:S,children:S?"Actualizando...":t.status==="cancelled"?"Reactivar Gira":"Marcar como No Ocurrirá"})]}),t.status==="cancelled"&&e.jsxs(Tt,{variant:"destructive",className:"text-xs",children:[e.jsx(Oe,{className:"h-3 w-3 mr-1"}),"Esta gira y sus fechas están ocultas de las vistas principales"]})]})]}),e.jsx("div",{className:"border-b pb-4",children:e.jsx(Jt,{color:t.color,tourName:t.name,tourDescription:t.description,invoicingCompany:t.invoicing_company,onColorChange:M,onNameChange:N,onDescriptionChange:h,onInvoicingCompanyChange:n})}),e.jsxs("div",{className:"border-b pb-4",children:[e.jsx("h3",{className:"text-sm font-medium mb-3",children:"Configuración de Tour Pack"}),e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-950 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(dt,{className:"h-4 w-4 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Modo Tour Pack Masivo"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Establecer todas las fechas de esta gira a Solo Tour Pack"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx($,{size:"sm",variant:"outline",onClick:()=>E(!0),disabled:c,children:"Activar Todo"}),e.jsx($,{size:"sm",variant:"outline",onClick:()=>E(!1),disabled:c,children:"Desactivar Todo"})]})]})})]}),e.jsxs("div",{className:"border-b pb-4",children:[e.jsx("h3",{className:"text-sm font-medium mb-3",children:s?"Anulaciones de Fecha de Gira":"Valores por Defecto de Gira"}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs($,{variant:"outline",onClick:H,className:"flex items-center gap-2",children:[e.jsx(Gt,{className:"h-4 w-4"}),"Gestionar Todos los Valores y Exportar PDFs"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs($,{variant:"outline",onClick:q,className:"flex items-center gap-2",children:[e.jsx(ct,{className:"h-4 w-4"}),s?"Anular Potencia":"Configurar Valores de Potencia"]}),e.jsxs($,{variant:"outline",onClick:R,className:"flex items-center gap-2",children:[e.jsx(mt,{className:"h-4 w-4"}),s?"Anular Peso":"Configurar Valores de Peso"]})]})]})]}),e.jsx(Yt,{onDelete:P})]})]})}),e.jsx(Ot,{open:p,onOpenChange:a,tour:t})]})},$a=async r=>{var p;const{jsPDF:j,autoTable:t}=await ut(),s=new j,w=s.internal.pageSize.width,_=s.internal.pageSize.height;s.setFillColor(125,1,1),s.rect(0,0,w,30,"F");let d;try{d=await ze(r.id)}catch{}if(d)try{s.addImage(d,"PNG",5,5,25,20)}catch{}s.setTextColor(255,255,255),s.setFontSize(18),s.text(r.name,w/2,15,{align:"center"}),s.setFontSize(12),s.text("Tour Schedule",w/2,25,{align:"center"});const N=(((p=r.tour_dates)==null?void 0:p.sort((a,c)=>new Date(a.date).getTime()-new Date(c.date).getTime()))||[]).map(a=>{var c;return[xe(new Date(a.date),"dd/MM/yyyy"),xe(new Date(a.date),"EEEE"),((c=a.location)==null?void 0:c.name)||"TBC",a.is_tour_pack_only?"Tour Pack Only":"Full Setup"]});t(s,{head:[["Date","Day","Venue","Setup Type"]],body:N,startY:40,theme:"grid",styles:{fontSize:10,cellPadding:3,valign:"top"},headStyles:{fillColor:[125,1,1],textColor:[255,255,255],fontSize:11,fontStyle:"bold"},columnStyles:{0:{cellWidth:30,halign:"center"},1:{cellWidth:30,halign:"center"},2:{cellWidth:"auto",halign:"left"},3:{cellWidth:40,halign:"center"}},margin:{left:10,right:10}});const h=s.lastAutoTable.finalY||100;s.setFontSize(10),s.setTextColor(125,1,1),s.text(`Generated on ${xe(new Date,"dd/MM/yyyy HH:mm")}`,10,h+20);const n=async a=>{try{const c=await fetch(a);if(!c.ok)throw new Error(`Failed to fetch image: ${c.status} ${c.statusText}`);const b=await c.blob();return new Promise((S,T)=>{const q=new FileReader;q.onload=()=>{const R=q.result;S(R)},q.onerror=()=>{T(new Error("Failed to convert image to base64"))},q.readAsDataURL(b)})}catch{return null}};await(async()=>{try{const a=["/sector pro logo.png","./sector pro logo.png","sector pro logo.png"];let c=null;for(const b of a)if(c=await n(b),c)break;if(c)try{const T=(w-40)/2,q=_-30;s.addImage(c,"PNG",T,q,40,15)}catch{}}catch{}s.save(`${r.name}_schedule.pdf`)})()},La=async r=>{var n,P;const{jsPDF:j,autoTable:t}=await ut(),s=new j,w=s.internal.pageSize.width,_=s.internal.pageSize.height;s.setFillColor(125,1,1),s.rect(0,0,w,30,"F");let d;try{d=await ze(r.id)}catch{}if(d)try{s.addImage(d,"PNG",5,5,25,20)}catch{}s.setTextColor(255,255,255),s.setFontSize(18),s.text(r.name,w/2,15,{align:"center"}),s.setFontSize(12),s.text("Tour Schedule",w/2,25,{align:"center"});const N=(((n=r.tour_dates)==null?void 0:n.sort((p,a)=>new Date(p.date).getTime()-new Date(a.date).getTime()))||[]).map(p=>{var a;return[xe(new Date(p.date),"dd/MM/yyyy"),xe(new Date(p.date),"EEEE"),((a=p.location)==null?void 0:a.name)||"TBC",p.is_tour_pack_only?"Tour Pack Only":"Full Setup"]});t(s,{head:[["Date","Day","Venue","Setup Type"]],body:N,startY:40,theme:"grid",styles:{fontSize:10,cellPadding:3,valign:"top"},headStyles:{fillColor:[125,1,1],textColor:[255,255,255],fontSize:11,fontStyle:"bold"},columnStyles:{0:{cellWidth:30,halign:"center"},1:{cellWidth:30,halign:"center"},2:{cellWidth:"auto",halign:"left"},3:{cellWidth:40,halign:"center"}},margin:{left:10,right:10}});const h=((P=s.lastAutoTable)==null?void 0:P.finalY)||100;s.setFontSize(10),s.setTextColor(125,1,1),s.text(`Generated on ${xe(new Date,"dd/MM/yyyy HH:mm")}`,10,h+20);try{const p=async b=>{try{const S=await fetch(b);if(!S.ok)throw new Error(`Failed to fetch image: ${S.status} ${S.statusText}`);const T=await S.blob();return await new Promise((q,R)=>{const H=new FileReader;H.onload=()=>q(H.result),H.onerror=()=>R(new Error("Failed to convert image to base64")),H.readAsDataURL(T)})}catch{return null}},a=["/sector pro logo.png","./sector pro logo.png","sector pro logo.png"];let c=null;for(const b of a)if(c=await p(b),c)break;if(c){const T=(w-40)/2,q=_-30;try{s.addImage(c,"PNG",T,q,40,15)}catch{}}}catch{}return s.output("blob")};export{Aa as T,mt as W,Fa as a,La as b,Ot as c,$a as e};
