import{r as q,f,s}from"./index-NZ6jJLfQ.js";import{u as y}from"./useQuery-kdg2pmgf.js";import{u as b}from"./useMutation-DluhVBs1.js";function _(e){if(!e)return null;const t=Array.isArray(e.roles)?e.roles.map(r=>({role_code:r.role_code,quantity:Number(r.quantity||0),notes:r.notes??null})):[];return{job_id:e.job_id,department:e.department,total_required:Number(e.total_required||0),roles:t}}function g(e){return y({queryKey:["job-required-roles",e],queryFn:async()=>{if(!e)return[];const{data:t,error:r}=await s.from("job_required_roles").select("*").eq("job_id",e).order("department",{ascending:!0}).order("role_code",{ascending:!0});if(r)throw r;return t||[]},enabled:!!e,staleTime:6e4})}function C(e,t=!0){const r=y({queryKey:["job-required-summary",e],queryFn:async()=>{if(!e)return[];const{data:a,error:i}=await s.from("job_required_roles_summary").select("job_id, department, total_required, roles").eq("job_id",e);if(i)throw i;return(a||[]).map(_).filter(Boolean)},enabled:t&&!!e,staleTime:3e4}),n=q.useMemo(()=>{const a=new Map;return(r.data||[]).forEach(i=>a.set(i.department,i)),a},[r.data]);return{...r,byDepartment:n}}async function j(e){const{data:t,error:r}=await s.from("job_required_roles_summary").select("department, total_required, roles").eq("job_id",e);if(r)throw r;return(t||[]).map(_).filter(Boolean)}async function h(e,t){var r,n,a,i;try{const{data:u}=await s.auth.getSession(),d=((n=(r=u==null?void 0:u.session)==null?void 0:r.user)==null?void 0:n.id)??null,m=(await j(e)).map(o=>({department:o.department,total_required:o.total_required,roles:o.roles.map(c=>({role_code:c.role_code,quantity:c.quantity,notes:c.notes??null}))})),p={department_roles:m,last_change:{type:"batch",created:t.inserted.map(o=>({id:o.id,department:o.department,role_code:o.role_code,quantity:o.quantity})),updated:t.updated.map(o=>({id:o.id,department:o.department,role_code:o.role_code,quantity:o.quantity})),deleted:t.deleted}};(await s.rpc("log_activity",{_code:"job.requirements.updated",_job_id:e,_entity_type:"job_required_roles",_entity_id:((a=t.inserted[0])==null?void 0:a.id)??((i=t.updated[0])==null?void 0:i.id)??t.deleted[0]??e,_payload:p})).error,(await s.functions.invoke("push",{body:{action:"broadcast",type:"job.requirements.updated",job_id:e,actor_id:d??void 0,department_roles:m}})).error}catch{}}function E(){const e=f();return b({mutationFn:async({jobId:t,inserts:r,updates:n,deletes:a})=>{const i=[],u=[];if(r.length>0){const{data:d,error:l}=await s.from("job_required_roles").insert(r).select("*");if(l)throw l;i.push(...d||[])}if(n.length>0){const{data:d,error:l}=await s.from("job_required_roles").upsert(n,{onConflict:"id"}).select("*");if(l)throw l;u.push(...d||[])}if(a.length>0){const{error:d}=await s.from("job_required_roles").delete().in("id",a);if(d)throw d}return{jobId:t,inserted:i,updated:u,deleted:a}},onSuccess:t=>{e.invalidateQueries({queryKey:["job-required-roles",t.jobId]}),e.invalidateQueries({queryKey:["job-required-summary",t.jobId]}),e.invalidateQueries({queryKey:["optimized-jobs"]}),e.invalidateQueries({queryKey:["jobs"]}),h(t.jobId,t)}})}export{g as a,E as b,C as u};
