import{r as l,j as e,B as D,D as Ee,q as Pe,F as Ae,G as Me,s as P,L as fe,I as De,C as we,W as qe,Y as Ne,A as Se,n as pe,aK as ns,S as ke,t as Le,v as Re,w as ze,x as Ue,a as ge,aL as os,a0 as te,e as Xe,aM as ls,c as cs,$ as ds,U as ms,X as us}from"./index-NZ6jJLfQ.js";import{u as fs}from"./useRealtimeSubscription-Bj7PWAKC.js";import{M as hs,W as Te,C as xs}from"./connection-indicator-DXjKDIC2.js";import{a as _s,M as $e,E as Ge,I as Ie,N as Oe}from"./NotesSection-Cu_RhFOj.js";import{A as V,a as Q}from"./alert-BqA-5jRM.js";import{T as Ze,a as es,b as je,c as oe,d as ss,e as le}from"./table-DnQAmABX.js";import{B as me}from"./badge-vNTKF5RD.js";import{u as Ce}from"./useQuery-kdg2pmgf.js";import{o as ps,a as gs,P as js,b as ys,g as vs}from"./festivalPdfGenerator-gdXb7BRp.js";import{C as as}from"./calculator-jIsLl-gd.js";import{F as bs}from"./file-text-igU140SQ.js";import{P as ts}from"./plus-C3JQqq7t.js";import{M as ws}from"./minus-InO4I9Ks.js";import{I as qs}from"./info-CpCfiYD2.js";import{C as Ns}from"./circle-check-big-CilmNGCn.js";import{u as Ss}from"./useEquipmentModels--fmk95xL.js";import{A as Cs,a as re,b as ie,c as ne}from"./accordion-CkNUgJdy.js";import{e as Es,g as Ps,p as As}from"./flexPullsheets-DscweXrW.js";import{T as Ms,a as Ds,b as Be,c as We}from"./tabs-BdaywI_b.js";import{S as Fs}from"./switch-DUBpZhIC.js";import{r as He,P as ks}from"./equipment-B5qd5N3O.js";import{T as ve}from"./triangle-alert-D6qN0F8g.js";import{C as be}from"./circle-check-C0N48OpO.js";import{C as Ke}from"./circle-x-DDzV-xk_.js";import{U as rs}from"./upload-DF4rjO7T.js";import{S as Ls}from"./save-z_re-Mcq.js";import{A as Rs}from"./arrow-left-VpQwT4cv.js";import{P as zs}from"./pen-D_H3YLSb.js";import{W as Us}from"./wrench-DzMvZxmF.js";import{P as Ts}from"./printer-De77t3j8.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./radio-group-DzKNHD24.js";import"./index-hC3MxXep.js";import"./circle-CWxDyDxx.js";import"./checkbox-BsRNEGV1.js";import"./search-D-OiWg8h.js";import"./wifi-C3_7SFyW.js";import"./circle-alert-LZYNzZ7F.js";import"./artistPdfExport-DnsKQk1F.js";import"./lazyPdf-xVUlxKNu.js";import"./logoUtils-D2o1jUVg.js";import"./logo-url-cache-eY6nfvu7.js";import"./download-C1rVE0-J.js";import"./pdf-libs-BqoGqu1a.js";import"./pdfMerge-DXtLP7Xx.js";import"./weatherApi-BatwQpQy.js";import"./useMutation-DluhVBs1.js";import"./index-Bf_BVWwW.js";const Ve=({jobId:t})=>{const[o,i]=l.useState(!1),{data:c=[],isLoading:y}=Ce({queryKey:["festival-artists-mics",t],queryFn:async()=>{const{data:n,error:j}=await P.from("festival_artists").select("id, name, stage, date, show_start, show_end, wired_mics, mic_kit").eq("job_id",t).eq("mic_kit","festival").not("wired_mics","is",null);if(j)throw j;return n||[]},enabled:o&&!!t}),{data:_}=Ce({queryKey:["job-details",t],queryFn:async()=>{const{data:n,error:j}=await P.from("jobs").select("title").eq("id",t).single();if(j)throw j;const{data:N,error:M}=await P.from("festival_logos").select("file_path").eq("job_id",t).maybeSingle();return{title:n.title,logoUrl:(N==null?void 0:N.file_path)||void 0}},enabled:o&&!!t}),s=c.filter(n=>n.wired_mics&&Array.isArray(n.wired_mics)&&n.wired_mics.length>0),p=()=>{const n=new Set;return s.forEach(j=>{j.wired_mics&&Array.isArray(j.wired_mics)&&j.wired_mics.forEach(N=>{N.model&&N.quantity>0&&n.add(N.model)})}),Array.from(n).sort()},d=async()=>{if(!_||s.length===0)return;const n=ps(s),j={jobTitle:_.title,logoUrl:_.logoUrl,artistsByDateAndStage:n};try{const N=await gs(j),M=URL.createObjectURL(N),C=document.createElement("a");C.href=M,C.download=`${_.title}_Wired_Microphone_Matrix.pdf`,C.click(),URL.revokeObjectURL(M)}catch{}},v=p();return e.jsxs(e.Fragment,{children:[e.jsxs(D,{onClick:()=>i(!0),variant:"outline",className:"w-full",children:[e.jsx(as,{className:"h-4 w-4 mr-2"}),"Matriz de Micrófonos Cableados"]}),e.jsx(Ee,{open:o,onOpenChange:i,children:e.jsxs(Pe,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(Ae,{children:e.jsxs(Me,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Matriz de Requisitos de Micrófonos Cableados"}),e.jsx("div",{className:"flex gap-2",children:s.length>0&&e.jsxs(D,{onClick:d,variant:"outline",size:"sm",children:[e.jsx(bs,{className:"h-4 w-4 mr-2"}),"Exportar Matriz PDF"]})})]})}),y?e.jsx("div",{className:"text-center py-8",children:"Cargando datos de artistas..."}):s.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:["No se encontraron artistas con requisitos de micrófonos cableados usando kit de festival.",e.jsx("br",{}),"Asegúrese de que los artistas tengan micrófonos cableados configurados con kit de festival seleccionado."]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Esta matriz muestra todos los artistas que usan micrófonos cableados del festival. La exportación PDF calculará los requisitos máximos considerando los horarios de shows y las restricciones de compartir micrófonos."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-700",children:s.length}),e.jsx("div",{className:"text-sm text-blue-600",children:"Artistas con Micrófonos Cableados"})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-green-700",children:v.length}),e.jsx("div",{className:"text-sm text-green-600",children:"Modelos de Micrófonos"})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-700",children:new Set(s.map(n=>`${n.date}-${n.stage}`)).size}),e.jsx("div",{className:"text-sm text-purple-600",children:"Combinaciones Fecha/Stage"})]})]}),v.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Modelos de Micrófonos Requeridos"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:v.map(n=>e.jsx(me,{variant:"outline",className:"text-sm",children:n},n))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Artistas Incluidos en la Matriz"}),e.jsxs(Ze,{children:[e.jsx(es,{children:e.jsxs(je,{children:[e.jsx(oe,{children:"Artista"}),e.jsx(oe,{children:"Fecha"}),e.jsx(oe,{children:"Stage"}),e.jsx(oe,{children:"Hora del Show"}),e.jsx(oe,{children:"Micrófonos"})]})}),e.jsx(ss,{children:s.map(n=>e.jsxs(je,{children:[e.jsx(le,{className:"font-medium",children:n.name}),e.jsx(le,{children:n.date}),e.jsx(le,{children:e.jsxs(me,{variant:"outline",children:["Stage ",n.stage]})}),e.jsx(le,{children:n.show_start&&n.show_end?`${n.show_start} - ${n.show_end}`:"TBD"}),e.jsx(le,{children:e.jsx("div",{className:"space-y-1",children:n.wired_mics&&Array.isArray(n.wired_mics)?n.wired_mics.map((j,N)=>e.jsxs("div",{className:"text-xs",children:[e.jsxs(me,{variant:"secondary",className:"mr-1",children:[j.quantity,"x ",j.model]}),j.exclusive_use&&e.jsx(me,{variant:"destructive",className:"text-xs",children:"Exclusivo"})]},N)):null})})]},n.id))})]})]}),e.jsx("div",{className:"bg-yellow-50 p-4 rounded-lg border border-yellow-200",children:e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("strong",{children:"Nota:"})," El PDF de la matriz calculará los requisitos máximos exactos analizando los horarios de shows, requisitos de uso exclusivo y restricciones de compartir en todas las fechas y stages."]})})]})]})})]})},$s=["Yamaha CL5","Yamaha PMx","Yamaha DM7","Yamaha DM3","DiGiCo SD5","DiGiCo SD7","DiGiCo SD8","DiGiCo SD10","DiGiCo SD11","DiGiCo SD12","DiGiCo SD5Q","DiGiCo SD7Q","DiGiCo Q225","DiGiCo Q326","DiGiCo Q338","DiGiCo Q852","Avid S6L","A&H C1500","A&H C2500","A&H S3000","A&H S5000","A&H S7000","Waves LV1 (homemade)","Waves LV1 Classic","SSL","Other"],Qe=({consoles:t,onChange:o,label:i})=>{const c=()=>{o([...t,{model:"",quantity:1}])},y=p=>{o(t.filter((d,v)=>v!==p))},_=(p,d,v)=>{o(t.map((n,j)=>j===p?{...n,[d]:v}:n))},s=()=>{if(i.toLowerCase().includes("foh"))return"foh_console";if(i.toLowerCase().includes("monitor"))return"mon_console"};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(fe,{children:i}),e.jsxs(D,{type:"button",variant:"outline",size:"sm",onClick:c,children:[e.jsx(ts,{className:"h-4 w-4 mr-2"}),"Añadir Console"]})]}),t.map((p,d)=>e.jsxs("div",{className:"flex gap-4 items-start",children:[e.jsx("div",{className:"flex-1",children:e.jsx(_s,{value:p.model,onChange:v=>_(d,"model",v),options:[],fallbackOptions:$s,placeholder:"Seleccionar console",category:s()})}),e.jsx("div",{className:"w-24",children:e.jsx(De,{type:"number",min:"1",value:p.quantity,onChange:v=>_(d,"quantity",parseInt(v.target.value)||0)})}),e.jsx(D,{type:"button",variant:"ghost",size:"icon",onClick:()=>y(d),children:e.jsx(ws,{className:"h-4 w-4"})})]},d))]})},Ye=({formData:t,onChange:o})=>e.jsxs("div",{className:"space-y-4 md:space-y-6 border rounded-lg p-3 md:p-4",children:[e.jsx("h3",{className:"text-base md:text-lg font-semibold",children:"Configuración de Consoles"}),e.jsx(Qe,{consoles:t.foh_consoles,onChange:i=>o({foh_consoles:i}),label:"Consoles FOH"}),e.jsx(Qe,{consoles:t.mon_consoles,onChange:i=>o({mon_consoles:i}),label:"Consoles de Monitor"})]}),Gs=(t,o)=>Ce({queryKey:["microphone-analysis",t,o],queryFn:async()=>{const{data:i,error:c}=await P.from("festival_artists").select("id, name, stage, date, show_start, show_end, wired_mics, mic_kit").eq("job_id",t).eq("stage",o).eq("mic_kit","festival").not("wired_mics","is",null);if(c)throw c;const y=(i==null?void 0:i.filter(s=>s.wired_mics&&Array.isArray(s.wired_mics)&&s.wired_mics.length>0))||[],_=Is(y);return{artists:y,peakRequirements:_,analysisDetails:{totalArtists:y.length,microphoneModels:Array.from(new Set(y.flatMap(s=>{var p;return((p=s.wired_mics)==null?void 0:p.map(d=>d.model))||[]}))),peakCalculationMethod:"stage_aware_peak_analysis",stageNumber:o}}},enabled:!!t&&!!o}),Is=t=>{const o=new Map,i=t.reduce((c,y)=>{const _=y.date;return c[_]||(c[_]=[]),c[_].push(y),c},{});return Object.values(i).forEach(c=>{const y=new Map;c.forEach(_=>{_.wired_mics&&_.wired_mics.forEach(s=>{const p=s.model,d=y.get(p)||0;s.exclusive_use?y.set(p,d+s.quantity):y.set(p,Math.max(d,s.quantity))})}),y.forEach((_,s)=>{const p=o.get(s);p?_>p.quantity&&o.set(s,{...p,quantity:_,notes:`Peak requirement for stage (${c.length} artists)`}):o.set(s,{model:s,quantity:_,exclusive_use:!1,notes:`Peak requirement for stage (${c.length} artists)`})})}),Array.from(o.values()).sort((c,y)=>c.model.localeCompare(y.model))},Os=({open:t,onOpenChange:o,peakRequirements:i,analysisDetails:c,onConfirm:y,isLoading:_=!1})=>e.jsx(Ee,{open:t,onOpenChange:o,children:e.jsxs(Pe,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsx(Ae,{children:e.jsxs(Me,{className:"flex items-center gap-2",children:[e.jsx(qs,{className:"h-5 w-5"}),"Requisitos de Micrófonos Stage ",c.stageNumber]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(V,{children:[e.jsx(Ns,{className:"h-4 w-4"}),e.jsxs(Q,{children:["Análisis completado para ",c.totalArtists," artistas en Stage ",c.stageNumber," usando micrófonos del festival. Requisitos máximos calculados considerando horarios de shows y restricciones de uso exclusivo."]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-700",children:c.stageNumber}),e.jsx("div",{className:"text-sm text-blue-600",children:"Número de Stage"})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-green-700",children:c.totalArtists}),e.jsx("div",{className:"text-sm text-green-600",children:"Artistas Analizados"})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-700",children:i.length}),e.jsx("div",{className:"text-sm text-purple-600",children:"Modelos de Mic Requeridos"})]})]}),i.length>0?e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold mb-3",children:["Requisitos Máximos de Micrófonos para Stage ",c.stageNumber]}),e.jsxs(Ze,{children:[e.jsx(es,{children:e.jsxs(je,{children:[e.jsx(oe,{children:"Modelo de Micrófono"}),e.jsx(oe,{children:"Cantidad"}),e.jsx(oe,{children:"Notas"})]})}),e.jsx(ss,{children:i.map((s,p)=>e.jsxs(je,{children:[e.jsx(le,{className:"font-medium",children:s.model}),e.jsx(le,{children:e.jsx(me,{variant:"secondary",children:s.quantity})}),e.jsx(le,{className:"text-sm text-muted-foreground",children:s.notes})]},p))})]})]}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:["No se encontraron requisitos de micrófonos para Stage ",c.stageNumber,". Asegúrese de que los artistas en este stage tengan micrófonos cableados configurados con kit de festival seleccionado."]}),e.jsx("div",{className:"bg-yellow-50 p-4 rounded-lg border border-yellow-200",children:e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("strong",{children:"Nota:"})," Estos requisitos son específicos para Stage ",c.stageNumber," y se fusionarán con su kit de micrófonos existente. Las cantidades para modelos existentes se actualizarán al valor más alto."]})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(D,{variant:"outline",onClick:()=>o(!1),children:"Cancelar"}),e.jsx(D,{onClick:y,disabled:_||i.length===0,children:_?"Cargando...":"Cargar Requisitos"})]})]})]})}),Je=({jobId:t,stageNumber:o,wiredMics:i,onChange:c})=>{const[y,_]=l.useState(!1),[s,p]=l.useState(!1),{data:d,isLoading:v,refetch:n}=Gs(t,o),{models:j}=Ss(),N=j.filter(L=>L.category==="wired_mics").map(L=>L.name),M=async()=>{if(!d){pe.error("No hay datos de análisis disponibles");return}if(d.peakRequirements.length===0){pe.error(`No se encontraron requisitos de micrófonos para Stage ${o}`);return}_(!0)},C=async()=>{if(d){p(!0);try{const L=Array.isArray(i)?i:[],E=Array.isArray(d.peakRequirements)?d.peakRequirements:[],w=new Map(L.map(q=>[q.model,q]));E.forEach(q=>{if(w.has(q.model)){const I=w.get(q.model);q.quantity>I.quantity&&(I.quantity=q.quantity,I.notes=q.notes)}else w.set(q.model,q)});const Y=Array.from(w.values()).map(q=>({model:q.model||"",quantity:Number(q.quantity)||0,exclusive_use:!!q.exclusive_use,notes:q.notes||""}));c(Y),pe.success(`${E.length} tipos de micrófonos cargados para Stage ${o}`),_(!1)}catch{pe.error("Error al cargar los requisitos de micrófonos")}finally{p(!1)}}},F=L=>{const E=Array.isArray(L)?L:[];c(E)},k=Array.isArray(i)?i:[];return e.jsxs(we,{children:[e.jsx(qe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ne,{children:["Kit de Micrófonos Stage ",o]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(D,{variant:"outline",size:"sm",onClick:M,disabled:v,children:[e.jsx(as,{className:"h-4 w-4 mr-2"}),v?"Analizando...":"Cargar desde Requisitos de Artistas"]})})]})}),e.jsxs(Se,{children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:"Micrófonos Cableados Disponibles"}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-4",children:["Configure los micrófonos disponibles para Stage ",o,'. Use el botón "Cargar desde Requisitos de Artistas" para calcular automáticamente las necesidades máximas basadas en las solicitudes de los artistas.']})]}),e.jsx(hs,{value:k,onChange:F,availableMics:N,showExclusiveUse:!0,showNotes:!0})]}),e.jsx(Os,{open:y,onOpenChange:_,peakRequirements:(d==null?void 0:d.peakRequirements)||[],analysisDetails:(d==null?void 0:d.analysisDetails)||{totalArtists:0,microphoneModels:[],peakCalculationMethod:"",stageNumber:o},onConfirm:C,isLoading:s})]})]})},Bs=new Set(ks);function Ws({open:t,onOpenChange:o,gearSetup:i,jobId:c}){var ae,xe;const[y,_]=l.useState(""),[s,p]=l.useState(!1),[d,v]=l.useState(null),[n,j]=l.useState(!1),[N,M]=l.useState(null),[C,F]=l.useState("select"),[k,L]=l.useState([]),[E,w]=l.useState(null),[H,Y]=l.useState(!1),[q,I]=l.useState(!1),[R,h]=l.useState([]),[r,A]=l.useState(null),[x,U]=l.useState(!1);l.useEffect(()=>{if(!t||!c){L([]),w(null);return}let a=!0;return(async()=>{Y(!0);try{const S=await Ps(c);if(!a)return;L(S),S.length===1&&(w(S[0].element_id),v(S[0].element_id)),S.length>0?F("select"):F("url")}catch{if(!a)return;te({title:"Error",description:"Failed to load pullsheets for this job",variant:"destructive"})}finally{a&&Y(!1)}})(),()=>{a=!1}},[t,c]),l.useEffect(()=>{if(!t||!c){I(!1),h([]),A(null),U(!1);return}let a=!0;return(async()=>{U(!0);try{const{data:S,error:G}=await P.from("presets").select("id, name, job_id").eq("department","sound").or(`job_id.eq.${c},job_id.is.null`).order("job_id",{ascending:!1}).order("name");if(G)throw G;if(!a)return;h(S||[])}catch{if(!a)return;te({title:"Error",description:"Failed to load PA presets",variant:"destructive"})}finally{a&&U(!1)}})(),()=>{a=!1}},[t,c]),l.useEffect(()=>{C==="select"&&E&&v(E)},[C,E]),l.useEffect(()=>{if(C!=="url"||!y){C==="url"&&(p(!1),v(null));return}const a=Es(y);a?(v(a),p(!0)):(v(null),p(!1))},[y,C]);const Z=l.useMemo(()=>{const a=[];return i.foh_consoles.forEach(f=>{f.model&&f.quantity>0&&a.push(f.model)}),i.mon_consoles.forEach(f=>{f.model&&f.quantity>0&&a.push(f.model)}),i.wireless_systems.forEach(f=>{f.model&&(f.quantity_hh||0)+(f.quantity_bp||0)+(f.quantity||0)>0&&a.push(f.model)}),i.iem_systems.forEach(f=>{f.model&&(f.quantity_hh||0)+(f.quantity_bp||0)+(f.quantity||0)>0&&a.push(f.model)}),i.wired_mics.forEach(f=>{f.model&&f.quantity>0&&a.push(f.model)}),Array.from(new Set(a))},[i]),[z,ee]=l.useState(null),[J,he]=l.useState(!1);l.useEffect(()=>{if(!t||Z.length===0){ee(null);return}(async()=>{he(!0);try{const{data:f,error:S}=await P.from("equipment").select("name, resource_id, department, id").in("name",Z).not("resource_id","is",null);if(S)throw S;const G=new Map(f.map(b=>[b.name,b.resource_id])),K=[],B=[],W=(b,ue,_e)=>{b.forEach(X=>{if(!X.model)return;const de=ue(X);if(de<=0)return;const ye=G.get(X.model);if(ye){const Fe=K.find(is=>is.resourceId===ye);Fe?Fe.quantity+=de:K.push({resourceId:ye,quantity:de,name:X.model,category:_e})}else B.includes(X.model)||B.push(X.model)})};W(i.foh_consoles,b=>b.quantity,"foh_console"),W(i.mon_consoles,b=>b.quantity,"mon_console"),W(i.wireless_systems,b=>(b.quantity_hh||0)+(b.quantity_bp||0)+(b.quantity||0),"wireless"),W(i.iem_systems,b=>(b.quantity_hh||0)+(b.quantity_bp||0)+(b.quantity||0),"iem"),W(i.wired_mics,b=>b.quantity,"wired_mics"),ee({found:K,missing:B})}catch{te({title:"Error",description:"Failed to lookup equipment in database",variant:"destructive"})}finally{he(!1)}})()},[t,Z,i]);const[O,ce]=l.useState(null),[m,u]=l.useState(!1);l.useEffect(()=>{if(!t||!q||!r){ce(null),u(!1);return}let a=!0;return(async()=>{u(!0);try{const{data:S,error:G}=await P.from("preset_items").select("quantity, subsystem, equipment:equipment(id, name, category, resource_id)").eq("preset_id",r);if(G)throw G;if(!a)return;const K=new Map,B=[];(S||[]).forEach(W=>{const b=Array.isArray(W.equipment)?W.equipment[0]:W.equipment;if(!b||!b.category||!Bs.has(b.category))return;const ue=Number(W.quantity)||0;if(ue<=0)return;if(!b.resource_id){B.push(b.name);return}const _e=W.subsystem??He(b),X=`${b.resource_id}:${_e??""}`,de=K.get(X);if(de){de.quantity+=ue;return}K.set(X,{resourceId:b.resource_id,quantity:ue,name:b.name,category:b.category,subsystem:_e})}),ce({found:Array.from(K.values()),missing:B})}catch{if(!a)return;te({title:"Error",description:"Failed to lookup preset equipment in database",variant:"destructive"})}finally{a&&u(!1)}})(),()=>{a=!1}},[t,q,r]);const g=l.useMemo(()=>{const a=[...(z==null?void 0:z.found)||[],...q?(O==null?void 0:O.found)||[]:[]],f=new Map;for(const S of a){const G=S.subsystem??He({category:S.category??null})??S.category??"",K=`${S.resourceId}:${G}`,B=f.get(K);B?(B.quantity+=S.quantity,!B.subsystem&&G&&(B.subsystem=G)):f.set(K,{...S,subsystem:G||S.subsystem})}return Array.from(f.values())},[z,q,O]),T=async()=>{if(!(!d||g.length===0)){j(!0),M(null);try{const a=await As(d,g);M(a),a.failed.length===0?(te({title:"Success",description:`Successfully pushed ${a.succeeded} items to Flex pullsheet`}),setTimeout(()=>o(!1),2e3)):a.succeeded>0?te({title:"Partial Success",description:`Pushed ${a.succeeded} items, ${a.failed.length} failed`,variant:"destructive"}):te({title:"Failed",description:"Failed to push any items to Flex",variant:"destructive"})}catch(a){te({title:"Error",description:a instanceof Error?a.message:"Failed to push equipment to Flex",variant:"destructive"})}finally{j(!1)}}},$=()=>{n||(_(""),M(null),w(null),v(null),I(!1),A(null),ce(null),o(!1))},se=d&&g.length>0&&!n&&(C==="select"?!!E:s);return e.jsx(Ee,{open:t,onOpenChange:$,children:e.jsxs(Pe,{className:"sm:max-w-[550px]",children:[e.jsxs(Ae,{children:[e.jsx(Me,{children:"Push Equipment to Flex Pullsheet"}),e.jsx(ns,{children:"Select an existing pullsheet or enter a Flex pullsheet URL to add equipment items"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(fe,{htmlFor:"include-pa-preset",children:"Include PA preset"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Adds speakers + amplificación items from a preset."})]}),e.jsx(Fs,{id:"include-pa-preset",checked:q,onCheckedChange:a=>{I(a),A(null),ce(null)},disabled:n||x})]}),q&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(fe,{htmlFor:"pa-preset-select",children:"PA preset"}),e.jsxs(ke,{value:r||"",onValueChange:a=>A(a),disabled:n||x||R.length===0,children:[e.jsx(Le,{id:"pa-preset-select",children:e.jsx(Re,{placeholder:x?"Loading presets...":R.length===0?"No presets found":"Select a preset..."})}),e.jsx(ze,{children:R.map(a=>e.jsxs(Ue,{value:a.id,children:[a.name,a.job_id===c?" (job)":""]},a.id))})]})]})]}),e.jsxs(Ms,{value:C,onValueChange:a=>F(a),children:[e.jsxs(Ds,{className:"grid w-full grid-cols-2",children:[e.jsxs(Be,{value:"select",disabled:k.length===0&&!H,children:["Select Pullsheet ",k.length>0&&`(${k.length})`]}),e.jsx(Be,{value:"url",children:"Enter URL"})]}),e.jsx(We,{value:"select",className:"space-y-2",children:H?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground py-4",children:[e.jsx(ge,{className:"h-4 w-4 animate-spin"}),"Loading pullsheets..."]}):k.length===0?e.jsxs(V,{children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsx(Q,{children:"No pullsheets found for this job. Create pullsheets first or use the URL input option."})]}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{htmlFor:"pullsheet-select",children:"Available Pullsheets"}),e.jsxs(ke,{value:E||"",onValueChange:w,children:[e.jsx(Le,{id:"pullsheet-select",children:e.jsx(Re,{placeholder:"Select a pullsheet..."})}),e.jsx(ze,{children:k.map(a=>e.jsxs(Ue,{value:a.element_id,children:[a.display_name||(a.department?`${a.department.charAt(0).toUpperCase()+a.department.slice(1)} Pullsheet`:"Pullsheet")," ",e.jsxs("span",{className:"text-xs text-muted-foreground",children:[a.source==="flex_api"&&"(from Flex) ","(",a.source==="flex_api"&&a.created_at==="2000-01-01T00:00:00.000Z"?"Unknown":new Date(a.created_at).toLocaleDateString(),")"]})]},a.id))})]}),E&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Element ID: ",E]})]})}),e.jsxs(We,{value:"url",className:"space-y-2",children:[e.jsx(fe,{htmlFor:"pullsheet-url",children:"Pullsheet URL"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(De,{id:"pullsheet-url",placeholder:"Paste Flex pullsheet URL here...",value:y,onChange:a=>_(a.target.value),disabled:n,className:s?"border-green-500":""}),s&&e.jsx(be,{className:"h-5 w-5 text-green-500 flex-shrink-0 mt-2"})]}),y&&!s&&e.jsx("p",{className:"text-sm text-destructive",children:"Invalid Flex URL format"}),s&&d&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Element ID: ",d]})]})]}),(J||m)&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(ge,{className:"h-4 w-4 animate-spin"}),"Looking up equipment..."]}),!J&&!m&&e.jsxs("div",{className:"space-y-2",children:[g.length>0&&e.jsxs(V,{children:[e.jsx(be,{className:"h-4 w-4"}),e.jsxs(Q,{children:["Ready to push ",g.length," equipment items (",g.reduce((a,f)=>a+f.quantity,0)," total units)"]})]}),(((ae=z==null?void 0:z.missing)==null?void 0:ae.length)||0)>0&&e.jsxs(V,{variant:"destructive",children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsxs(Q,{children:[z.missing.length," items will be skipped (no Flex resource ID):",e.jsx("div",{className:"mt-1 text-xs max-h-20 overflow-y-auto",children:z.missing.join(", ")})]})]}),q&&r&&(((xe=O==null?void 0:O.missing)==null?void 0:xe.length)||0)>0&&e.jsxs(V,{variant:"destructive",children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsxs(Q,{children:[O.missing.length," preset items will be skipped (no Flex resource ID):",e.jsx("div",{className:"mt-1 text-xs max-h-20 overflow-y-auto",children:O.missing.join(", ")})]})]}),g.length===0&&e.jsxs(V,{variant:"destructive",children:[e.jsx(Ke,{className:"h-4 w-4"}),e.jsx(Q,{children:"No equipment items are linked to Flex resources. Please map equipment models to Flex resources first."})]})]}),N&&e.jsxs("div",{className:"space-y-2",children:[N.succeeded>0&&e.jsxs(V,{children:[e.jsx(be,{className:"h-4 w-4"}),e.jsxs(Q,{children:["Successfully pushed ",N.succeeded," items to Flex pullsheet"]})]}),N.failed.length>0&&e.jsxs(V,{variant:"destructive",children:[e.jsx(Ke,{className:"h-4 w-4"}),e.jsxs(Q,{children:[N.failed.length," items failed:",e.jsx("div",{className:"mt-1 text-xs max-h-20 overflow-y-auto",children:N.failed.map((a,f)=>e.jsxs("div",{children:[a.name,": ",a.error]},f))})]})]})]})]}),e.jsxs(os,{children:[e.jsx(D,{variant:"outline",onClick:$,disabled:n,children:"Cancel"}),e.jsx(D,{onClick:T,disabled:!se,children:n?e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"h-4 w-4 mr-2 animate-spin"}),"Pushing ",g.length," items..."]}):e.jsxs(e.Fragment,{children:[e.jsx(rs,{className:"h-4 w-4 mr-2"}),"Push Items"]})})]})]})})}const Hs=({jobId:t,stageNumber:o=1,onSave:i})=>{const{toast:c}=Xe(),[y,_]=l.useState(!1),[s,p]=l.useState({max_stages:1,foh_consoles:[],mon_consoles:[],wireless_systems:[],iem_systems:[],wired_mics:[],monitors_enabled:!1,monitors_quantity:0,extras_sf:!1,extras_df:!1,extras_djbooth:!1,extras_wired:"",infra_cat6:!1,infra_cat6_quantity:0,infra_hma:!1,infra_hma_quantity:0,infra_coax:!1,infra_coax_quantity:0,infra_opticalcon_duo:!1,infra_opticalcon_duo_quantity:0,infra_analog:0,other_infrastructure:"",notes:""}),[d,v]=l.useState(null),[n,j]=l.useState(null),[N,M]=l.useState(null),[C,F]=l.useState(!1),[k,L]=l.useState(!1),E=o===1;l.useEffect(()=>{t&&(async()=>{try{_(!0);const{data:r,error:A}=await P.from("festival_gear_setups").select("*").eq("job_id",t).single();if(A){if(A.code!=="PGRST116")throw A;j(null),v(null),M(null),F(!1);return}if(r)if(v(r),j(r.id),E)F(!1),p({max_stages:r.max_stages||1,foh_consoles:r.foh_consoles||[],mon_consoles:r.mon_consoles||[],wireless_systems:r.wireless_systems||[],iem_systems:r.iem_systems||[],wired_mics:r.wired_mics||[],monitors_enabled:r.available_monitors>0,monitors_quantity:r.available_monitors||0,extras_sf:r.has_side_fills||!1,extras_df:r.has_drum_fills||!1,extras_djbooth:r.has_dj_booths||!1,extras_wired:r.extras_wired||"",infra_cat6:r.available_cat6_runs>0,infra_cat6_quantity:r.available_cat6_runs||0,infra_hma:r.available_hma_runs>0,infra_hma_quantity:r.available_hma_runs||0,infra_coax:r.available_coax_runs>0,infra_coax_quantity:r.available_coax_runs||0,infra_opticalcon_duo:r.available_opticalcon_duo_runs>0,infra_opticalcon_duo_quantity:r.available_opticalcon_duo_runs||0,infra_analog:r.available_analog_runs||0,other_infrastructure:r.other_infrastructure||"",notes:r.notes||""});else{const{data:x,error:U}=await P.from("festival_stage_gear_setups").select("*").eq("gear_setup_id",r.id).eq("stage_number",o).maybeSingle();x?(M(x.id),F(!0),p({max_stages:r.max_stages||1,foh_consoles:x.foh_consoles||[],mon_consoles:x.mon_consoles||[],wireless_systems:x.wireless_systems||[],iem_systems:x.iem_systems||[],wired_mics:x.wired_mics||[],monitors_enabled:x.monitors_enabled||!1,monitors_quantity:x.monitors_quantity||0,extras_sf:x.extras_sf||!1,extras_df:x.extras_df||!1,extras_djbooth:x.extras_djbooth||!1,extras_wired:x.extras_wired||"",infra_cat6:x.infra_cat6||!1,infra_cat6_quantity:x.infra_cat6_quantity||0,infra_hma:x.infra_hma||!1,infra_hma_quantity:x.infra_hma_quantity||0,infra_coax:x.infra_coax||!1,infra_coax_quantity:x.infra_coax_quantity||0,infra_opticalcon_duo:x.infra_opticalcon_duo||!1,infra_opticalcon_duo_quantity:x.infra_opticalcon_duo_quantity||0,infra_analog:x.infra_analog||0,other_infrastructure:x.other_infrastructure||"",notes:x.notes||""})):(F(!1),p({max_stages:r.max_stages||1,foh_consoles:r.foh_consoles||[],mon_consoles:r.mon_consoles||[],wireless_systems:r.wireless_systems||[],iem_systems:r.iem_systems||[],wired_mics:r.wired_mics||[],monitors_enabled:r.available_monitors>0,monitors_quantity:r.available_monitors||0,extras_sf:r.has_side_fills||!1,extras_df:r.has_drum_fills||!1,extras_djbooth:r.has_dj_booths||!1,extras_wired:r.extras_wired||"",infra_cat6:r.available_cat6_runs>0,infra_cat6_quantity:r.available_cat6_runs||0,infra_hma:r.available_hma_runs>0,infra_hma_quantity:r.available_hma_runs||0,infra_coax:r.available_coax_runs>0,infra_coax_quantity:r.available_coax_runs||0,infra_opticalcon_duo:r.available_opticalcon_duo_runs>0,infra_opticalcon_duo_quantity:r.available_opticalcon_duo_runs||0,infra_analog:r.available_analog_runs||0,other_infrastructure:r.other_infrastructure||"",notes:r.notes||""}))}}catch{c({title:"Error",description:"Error al cargar la configuración de equipamiento.",variant:"destructive"})}finally{_(!1)}})()},[t,o,c,E]);const w=h=>{p(r=>({...r,...h}))},H=()=>{if(!n){c({title:"Configuración no guardada",description:"Por favor guarda la configuración de equipamiento antes de enviar a Flex.",variant:"destructive"});return}L(!0)},Y=async h=>{h.preventDefault(),_(!0);try{if(!t)throw new Error("No job ID provided");const r=Array.isArray(s.wired_mics)?s.wired_mics:[];if(E){const A={job_id:t,max_stages:s.max_stages,foh_consoles:s.foh_consoles,mon_consoles:s.mon_consoles,wireless_systems:s.wireless_systems,iem_systems:s.iem_systems,wired_mics:r,has_side_fills:s.extras_sf,has_drum_fills:s.extras_df,has_dj_booths:s.extras_djbooth,extras_wired:s.extras_wired,available_monitors:s.monitors_enabled?s.monitors_quantity:0,available_cat6_runs:s.infra_cat6?s.infra_cat6_quantity:0,available_hma_runs:s.infra_hma?s.infra_hma_quantity:0,available_coax_runs:s.infra_coax?s.infra_coax_quantity:0,available_opticalcon_duo_runs:s.infra_opticalcon_duo?s.infra_opticalcon_duo_quantity:0,available_analog_runs:s.infra_analog,other_infrastructure:s.other_infrastructure,notes:s.notes};n&&(A.id=n);const{data:x,error:U}=await P.from("festival_gear_setups").upsert(A,{onConflict:"job_id"}).select();if(U)throw U;x&&x.length>0&&(j(x[0].id),v(x[0]))}else{let A=n;if(A){const{error:z}=await P.from("festival_gear_setups").update({max_stages:Math.max((d==null?void 0:d.max_stages)||1,o)}).eq("id",A)}else{const z={job_id:t,max_stages:Math.max(s.max_stages,o||1)},{data:ee,error:J}=await P.from("festival_gear_setups").upsert(z,{onConflict:"job_id"}).select();if(J)throw J;A=ee[0].id,j(A),v(ee[0])}const x={gear_setup_id:A,stage_number:o,foh_consoles:s.foh_consoles,mon_consoles:s.mon_consoles,wireless_systems:s.wireless_systems,iem_systems:s.iem_systems,wired_mics:r,monitors_enabled:s.monitors_enabled,monitors_quantity:s.monitors_quantity,extras_sf:s.extras_sf,extras_df:s.extras_df,extras_djbooth:s.extras_djbooth,extras_wired:s.extras_wired,infra_cat6:s.infra_cat6,infra_cat6_quantity:s.infra_cat6_quantity,infra_hma:s.infra_hma,infra_hma_quantity:s.infra_hma_quantity,infra_coax:s.infra_coax,infra_coax_quantity:s.infra_coax_quantity,infra_opticalcon_duo:s.infra_opticalcon_duo,infra_opticalcon_duo_quantity:s.infra_opticalcon_duo_quantity,infra_analog:s.infra_analog,other_infrastructure:s.other_infrastructure,notes:s.notes};N&&(x.id=N);const{data:U,error:Z}=await P.from("festival_stage_gear_setups").upsert(x).select();if(Z)throw Z;U&&U.length>0&&(M(U[0].id),F(!0))}i==null||i(),c({title:"Éxito",description:E?"La configuración de equipamiento global ha sido guardada.":`La configuración de Stage ${o} ha sido guardada.`})}catch{c({title:"Error",description:"Error al guardar la configuración de equipamiento del festival.",variant:"destructive"})}finally{_(!1)}},q=E?"Está editando la configuración de stage predeterminada. Esta configuración se utilizará como predeterminada para todos los stages.":C?"Este stage tiene una configuración de equipamiento personalizada que difiere de la configuración global.":`Este stage está usando actualmente la configuración global. Cualquier cambio creará una configuración personalizada para Stage ${o}.`,I=E?"default":C?"info":"default",R=()=>({...s,name:"",stage:o,date:"",show_start:"",show_end:"",soundcheck:!1,foh_console:"",foh_console_provided_by:"",mon_console:"",mon_console_provided_by:"",wireless_provided_by:"",iem_provided_by:"",infrastructure_provided_by:"",foh_tech:!1,mon_tech:!1,rider_missing:!1,isaftermidnight:!1,mic_kit:"band",wired_mics:[]});return e.jsxs("form",{onSubmit:Y,className:"space-y-6 md:space-y-8",children:[e.jsx(V,{variant:I,className:E?"bg-yellow-50":C?"bg-blue-50":"bg-gray-50",children:e.jsx(Q,{className:"text-sm",children:q})}),e.jsxs("div",{className:"hidden md:block space-y-8",children:[e.jsx(Ye,{formData:s,onChange:h=>w(h)}),e.jsx(Te,{formData:R(),onChange:h=>w(h)}),e.jsx(Je,{jobId:t,stageNumber:o,wiredMics:s.wired_mics,onChange:h=>{w({wired_mics:h})}}),e.jsx($e,{formData:R(),onChange:h=>w(h),gearSetup:d}),e.jsx(Ge,{formData:R(),onChange:h=>w(h),gearSetup:d}),e.jsx(Ie,{formData:R(),onChange:h=>w(h),gearSetup:d}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Análisis de Requisitos de Micrófonos"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Calcule las necesidades de micrófonos cableados basándose en los requisitos de los artistas y los horarios de shows."}),e.jsx(Ve,{jobId:t})]}),e.jsx(Oe,{formData:R(),onChange:h=>w(h)})]}),e.jsx("div",{className:"md:hidden",children:e.jsxs(Cs,{type:"multiple",defaultValue:["consoles","wireless"],className:"space-y-4",children:[e.jsxs(re,{value:"consoles",className:"border rounded-lg px-4",children:[e.jsx(ie,{className:"text-base font-semibold hover:no-underline",children:"Configuración de Console"}),e.jsx(ne,{children:e.jsx(Ye,{formData:s,onChange:h=>w(h)})})]}),e.jsxs(re,{value:"wireless",className:"border rounded-lg px-4",children:[e.jsx(ie,{className:"text-base font-semibold hover:no-underline",children:"Configuración de Wireless"}),e.jsx(ne,{children:e.jsx(Te,{formData:R(),onChange:h=>w(h)})})]}),e.jsxs(re,{value:"mics",className:"border rounded-lg px-4",children:[e.jsx(ie,{className:"text-base font-semibold hover:no-underline",children:"Kit de Micrófonos"}),e.jsx(ne,{children:e.jsx(Je,{jobId:t,stageNumber:o,wiredMics:s.wired_mics,onChange:h=>{w({wired_mics:h})}})})]}),e.jsxs(re,{value:"monitors",className:"border rounded-lg px-4",children:[e.jsx(ie,{className:"text-base font-semibold hover:no-underline",children:"Configuración de Monitor"}),e.jsx(ne,{children:e.jsx($e,{formData:R(),onChange:h=>w(h),gearSetup:d})})]}),e.jsxs(re,{value:"extras",className:"border rounded-lg px-4",children:[e.jsx(ie,{className:"text-base font-semibold hover:no-underline",children:"Requisitos Adicionales"}),e.jsx(ne,{children:e.jsx(Ge,{formData:R(),onChange:h=>w(h),gearSetup:d})})]}),e.jsxs(re,{value:"infrastructure",className:"border rounded-lg px-4",children:[e.jsx(ie,{className:"text-base font-semibold hover:no-underline",children:"Infraestructura"}),e.jsx(ne,{children:e.jsx(Ie,{formData:R(),onChange:h=>w(h),gearSetup:d})})]}),e.jsxs(re,{value:"analysis",className:"border rounded-lg px-4",children:[e.jsx(ie,{className:"text-base font-semibold hover:no-underline",children:"Análisis de Micrófonos"}),e.jsx(ne,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Calcule las necesidades de micrófonos cableados basándose en los requisitos de los artistas y los horarios de shows."}),e.jsx(Ve,{jobId:t})]})})]}),e.jsxs(re,{value:"notes",className:"border rounded-lg px-4",children:[e.jsx(ie,{className:"text-base font-semibold hover:no-underline",children:"Notas"}),e.jsx(ne,{children:e.jsx(Oe,{formData:R(),onChange:h=>w(h)})})]})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(D,{type:"button",variant:"outline",onClick:H,disabled:!n||y,className:"flex-1",children:[e.jsx(rs,{className:"h-4 w-4 mr-2"}),"Push to Flex Pullsheet"]}),e.jsxs(D,{type:"submit",disabled:y,className:"flex-1",children:[e.jsx(Ls,{className:"h-4 w-4 mr-2"}),y?"Guardando...":E?"Guardar Configuración Global":C?`Actualizar Configuración de Stage ${o}`:`Crear Configuración Personalizada para Stage ${o}`]})]}),e.jsx(Ws,{open:k,onOpenChange:L,gearSetup:s,jobId:t})]})},Ia=()=>{const{jobId:t}=ls(),o=cs(),{toast:i}=Xe(),[c,y]=l.useState(""),[_,s]=l.useState(!0),[p,d]=l.useState([{number:1,name:"Stage 1"}]),[v,n]=l.useState(1),[j,N]=l.useState(1),[M,C]=l.useState(null),[F,k]=l.useState(""),[L,E]=l.useState(null),[w,H]=l.useState(!1),[Y,q]=l.useState(!1),[I,R]=l.useState({});fs([{table:"jobs",filter:`id=eq.${t}`,queryKey:["job",t]},{table:"festival_gear_setups",filter:`job_id=eq.${t}`,queryKey:["festival-gear",t]},{table:"festival_stages",filter:`job_id=eq.${t}`,queryKey:["festival-stages",t]}]);const h=async m=>{if(t)try{let u=m;if(!u){const{data:a}=await P.from("festival_gear_setups").select("max_stages").eq("job_id",t).maybeSingle();u=(a==null?void 0:a.max_stages)||1}const{data:g,error:T}=await P.from("festival_stages").select("id, number, name").eq("job_id",t).order("number");if(T)return;const $=new Set((g||[]).map(a=>a.number)),se=[];for(let a=1;a<=u;a++)$.has(a)||se.push({job_id:t,number:a,name:`Stage ${a}`});if(se.length>0){const{error:a}=await P.from("festival_stages").insert(se)}const{data:ae,error:xe}=await P.from("festival_stages").select("id, number, name").eq("job_id",t).order("number");if(xe)return;if(ae&&ae.length>0){const a=ae.map(f=>({id:f.id,number:f.number,name:f.name||`Stage ${f.number}`}));d(a),n(u)}}catch{}};l.useEffect(()=>{if(!t)return;(async()=>{try{s(!0);const{data:u,error:g}=await P.from("jobs").select("title, start_time, end_time").eq("id",t).single();if(g)throw g;y(u.title),await r()}catch{i({title:"Error",description:"No se pudieron cargar los detalles del festival",variant:"destructive"})}finally{s(!1)}})()},[t,i]);const r=async()=>{if(t)try{const{data:m,error:u}=await P.from("festival_gear_setups").select("*").eq("job_id",t).maybeSingle();if(u)throw u;if(m){E(m);const g=m.max_stages||1;await h(g)}else E(null),await h(1)}catch{i({title:"Error",description:"No se pudo cargar la configuración de equipo del festival",variant:"destructive"})}},A=async()=>{if(t)try{const{data:m,error:u}=await P.from("festival_gear_setups").select("id").eq("job_id",t).maybeSingle();if(u||!m)return;const{data:g,error:T}=await P.from("festival_stage_gear_setups").select("stage_number").eq("gear_setup_id",m.id);if(T)return;const $=g.reduce((se,ae)=>(se[ae.stage_number]=!0,se),{});R($)}catch{}};l.useEffect(()=>{A()},[t]);const x=async m=>{try{s(!0);const{error:u}=await P.from("festival_gear_setups").upsert({job_id:t,max_stages:m},{onConflict:"job_id"});if(u)throw u;await h(m),i({title:"Éxito",description:`Actualizado a ${m} escenarios`})}catch{i({title:"Error",description:"No se pudo actualizar la configuración de escenarios",variant:"destructive"})}finally{s(!1)}},U=()=>{x(v+1)},Z=m=>{const u=p.find(g=>g.number===m);C(m),k((u==null?void 0:u.name)||`Stage ${m}`)},z=async()=>{if(!M||!F.trim()){C(null),k("");return}try{const{data:m,error:u}=await P.from("festival_stages").update({name:F.trim()}).eq("job_id",t).eq("number",M).select();if(u)throw u;d(g=>g.map(T=>T.number===M?{...T,name:F.trim()}:T)),C(null),k(""),i({title:"Éxito",description:"Nombre del escenario actualizado"})}catch{i({title:"Error",description:"No se pudo actualizar el nombre del escenario",variant:"destructive"}),C(null),k("")}},ee=()=>{C(null),k("")},J=m=>{const u=p.find(g=>g.number===m);return(u==null?void 0:u.name)||`Stage ${m}`},he=()=>{i({title:"Éxito",description:"La configuración de equipo del festival ha sido actualizada."})},O=async()=>{if(t){H(!0);try{const m=await ys(t,j,J(j));if(!m||m.size===0)throw new Error("Generated PDF is empty");const u=URL.createObjectURL(m),g=document.createElement("a");g.href=u,g.download=`${c}_Stage${j}_GearSetup.pdf`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(u),i({title:"Éxito",description:"Documentación de configuración de equipo generada exitosamente"})}catch(m){i({title:"Error",description:`Error al generar documentación: ${m.message}`,variant:"destructive"})}finally{H(!1)}}},ce=async(m,u)=>{if(t){H(!0);try{const g=await vs(t,c||"Festival",m,u);if(!g.blob||g.blob.size===0)throw new Error("Generated PDF is empty");const T=URL.createObjectURL(g.blob),$=document.createElement("a");$.href=T,$.download=g.filename,document.body.appendChild($),$.click(),document.body.removeChild($),URL.revokeObjectURL(T),i({title:"Éxito",description:"Documentación generada exitosamente"})}catch(g){i({title:"Error",description:`Error al generar documentación: ${g.message}`,variant:"destructive"})}finally{H(!1)}}};return e.jsxs("div",{className:"container mx-auto px-4 py-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs(D,{variant:"ghost",onClick:()=>o(`/festival-management/${t}`),className:"self-start",children:[e.jsx(Rs,{className:"h-4 w-4 mr-2"}),"Volver a Gestión de Festival"]}),e.jsxs("div",{className:"flex flex-col items-start md:items-end md:text-right",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:c}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm md:text-base text-muted-foreground",children:"Gestión de Equipo"}),e.jsx(xs,{variant:"icon"})]})]})]}),e.jsxs(we,{children:[e.jsx(qe,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ne,{children:"Configuración de Escenarios"}),e.jsx(ds,{children:"Configura los escenarios para tu festival. Haz clic en el nombre de un escenario para editarlo."})]}),e.jsxs(D,{onClick:U,size:"sm",className:"self-start sm:self-auto",children:[e.jsx(ts,{className:"h-4 w-4 mr-2"}),"Añadir Escenario"]})]})}),e.jsx(Se,{children:e.jsx("div",{className:"flex flex-wrap gap-3",children:p.map(m=>e.jsxs("div",{className:"relative",children:[e.jsxs(D,{variant:j===m.number?"default":"outline",onClick:()=>N(m.number),className:"px-4 md:px-6 flex items-center gap-2 text-sm md:text-base",children:[e.jsx("span",{className:"truncate max-w-[120px] md:max-w-none",children:m.name}),I[m.number]&&e.jsx(me,{variant:"outline",className:"ml-1 md:ml-2 bg-blue-100 text-xs",children:"Personalizado"})]}),M===m.number?e.jsxs("div",{className:"fixed md:absolute top-1/2 left-1/2 md:top-full md:left-0 -translate-x-1/2 -translate-y-1/2 md:translate-x-0 md:translate-y-0 md:mt-2 p-4 md:p-2 bg-white border rounded-md shadow-lg z-50 w-[90vw] md:w-auto md:min-w-[200px]",children:[e.jsx(De,{value:F,onChange:u=>k(u.target.value),placeholder:"Nombre del escenario",className:"mb-2",onKeyDown:u=>{u.key==="Enter"&&z(),u.key==="Escape"&&ee()},autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 md:gap-1",children:[e.jsxs(D,{size:"sm",onClick:z,className:"flex-1 md:flex-initial",children:[e.jsx(ms,{className:"h-3 w-3 mr-2 md:mr-0"}),e.jsx("span",{className:"md:hidden",children:"Guardar"})]}),e.jsxs(D,{size:"sm",variant:"outline",onClick:ee,className:"flex-1 md:flex-initial",children:[e.jsx(us,{className:"h-3 w-3 mr-2 md:mr-0"}),e.jsx("span",{className:"md:hidden",children:"Cancelar"})]})]})]}):e.jsx(D,{size:"sm",variant:"ghost",className:"absolute -top-1 -right-1 h-6 w-6 p-0",onClick:()=>Z(m.number),children:e.jsx(zs,{className:"h-3 w-3"})})]},m.number))})})]}),!_&&e.jsxs(we,{className:"mb-6",children:[e.jsx(qe,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs(Ne,{className:"flex items-center gap-2 text-lg md:text-xl",children:[e.jsx(Us,{className:"h-4 w-4 md:h-5 md:w-5"}),e.jsxs("span",{className:"truncate",children:[J(j)," Gear Setup"]})]}),e.jsxs(D,{onClick:O,disabled:w,variant:"outline",size:"sm",className:"self-start sm:self-auto",children:[w?e.jsx(ge,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(Ts,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Imprimir Configuración de Equipo"}),e.jsx("span",{className:"sm:hidden",children:"Imprimir"})]})]})}),e.jsxs(Se,{children:[e.jsx("div",{className:"mb-4",children:e.jsx(V,{children:e.jsxs(Q,{className:"text-sm",children:["Configura el equipo para ",J(j),". Esta información se utilizará cuando los artistas envíen sus requerimientos técnicos."]})})}),e.jsx(Hs,{jobId:t||"",stageNumber:j,onSave:he})]})]}),Y&&e.jsx(js,{open:Y,onOpenChange:q,onConfirm:ce,maxStages:v,jobTitle:c,jobId:t})]})};export{Ia as default};
