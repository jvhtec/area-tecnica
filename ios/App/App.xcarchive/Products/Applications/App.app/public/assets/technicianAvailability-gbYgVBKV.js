import{s as r}from"./index-NZ6jJLfQ.js";async function A(_,u,t,s,c){try{const{data:g,error:C}=await r.rpc("get_profiles_with_skills");if(C)throw C;const T=(g||[]).filter(e=>e.department===_);if(T.length===0)return[];const w=T.filter(e=>e.role==="management"?!!e.assignable_as_tech:e.role==="technician"||e.role==="house_tech");if(w.length===0)return[];const j=w.map(e=>e.id),l=c?new Date(c).toISOString().split("T")[0]:null,b=l||new Date(t).toISOString().split("T")[0],m=l||new Date(s).toISOString().split("T")[0],{data:y,error:v}=await r.from("timesheets").select("technician_id, job_id, date").in("technician_id",j).eq("is_active",!0).gte("date",b).lte("date",m);if(v)throw v;const p=Array.from(new Set((y||[]).map(e=>e.job_id))),{data:k,error:E}=await r.from("jobs").select("id, start_time, end_time, title").in("id",p);if(E)throw E;const I=new Map;(k||[]).forEach(e=>I.set(e.id,e));const{data:n,error:O}=await r.from("availability_schedules").select("user_id, date, status, source").in("user_id",j).eq("status","unavailable").gte("date",b).lte("date",m),o=new Map;(y||[]).forEach(e=>{const a=e.technician_id;o.has(a)||o.set(a,new Set),o.get(a).add(e.date)});const d=new Map;return(y||[]).forEach(e=>{const a=e.technician_id;d.has(a)||d.set(a,new Set),d.get(a).add(e.job_id)}),w.filter(e=>{const a=d.get(e.id);if(a!=null&&a.has(u))return!1;const D=o.get(e.id);if(!D||D.size===0)return!(n==null?void 0:n.some(S=>S.user_id===e.id));const f=[];if(l)f.push(l);else{const i=new Date(b),S=new Date(m);for(let h=new Date(i);h<=S;h.setDate(h.getDate()+1))f.push(h.toISOString().split("T")[0])}return f.some(i=>D.has(i))?!1:!(n==null?void 0:n.some(i=>i.user_id===e.id&&f.includes(i.date)))})}catch(g){throw g}}async function H(_,u,t){try{const{data:s,error:c}=await r.rpc("check_technician_conflicts",{_technician_id:_,_target_job_id:u,_target_date:(t==null?void 0:t.targetDateIso)||null,_single_day:(t==null?void 0:t.singleDayOnly)||!1,_include_pending:(t==null?void 0:t.includePending)!==!1});return c?{hasHardConflict:!1,hasSoftConflict:!1,hardConflicts:[],softConflicts:[],unavailabilityConflicts:[]}:s}catch{return{hasHardConflict:!1,hasSoftConflict:!1,hardConflicts:[],softConflicts:[],unavailabilityConflicts:[]}}}export{H as c,A as g};
