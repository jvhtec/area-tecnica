import{l as Fe,j as e,B as k,V as Je,r as i,u as Ae,D as ye,q as Ne,F as we,G as Ce,L as P,I as $,S as Z,t as X,v as ee,w as se,x as M,a0 as q,m as H,e as fe,f as Ye,s as Q,Q as Se,a1 as ps,R as Ge,a as ce,X as De,d as fs,C as de,W as ue,Y as xe,$ as ve,P as Qe,a2 as gs,A as me,U as js,a3 as vs,a4 as bs,a5 as Le,n as ge,c as ys,g as Ns}from"./index-NZ6jJLfQ.js";import{M as Pe,U as ws,C as Cs}from"./ManageSkillsDialog-wCDwgGaG.js";import{u as Ze}from"./useQuery-kdg2pmgf.js";import{H as Ss,a as ks,b as _s}from"./hover-card-BMjtHitm.js";import{B as pe}from"./badge-vNTKF5RD.js";import{f as be}from"./userName-BCcvOtN-.js";import{T as Ds}from"./triangle-alert-D6qN0F8g.js";import{P as Fs}from"./pencil-BxZTvEYh.js";import{C as z}from"./checkbox-BsRNEGV1.js";import{S as As}from"./separator-E-JdTFOv.js";import{H as Es}from"./HouseTechRateEditor-BHnjxOLZ.js";import{C as Ts}from"./CityAutocomplete-D-A6C7rH.js";import{P as Is,u as Rs}from"./usePushNotifications-DXTVLUyg.js";import{A as Us,a as Ls,b as Ps,c as Ms,d as Os,e as qs,f as Bs,g as Vs}from"./alert-dialog-CtyYUxwH.js";import{A as Ws,a as $s,b as zs,c as Hs}from"./accordion-CkNUgJdy.js";import{S as Me}from"./scroll-area-BHjMXddA.js";import{u as Ks}from"./useTabVisibility-TU5j192j.js";import{A as ae,a as te,b as he}from"./alert-BqA-5jRM.js";import{D as Xe}from"./download-C1rVE0-J.js";import{I as Js}from"./image--Pql38nK.js";import{T as es,a as ss,b as oe,c as Ys}from"./tabs-BdaywI_b.js";import{u as Ee}from"./useEquipmentModels--fmk95xL.js";import{u as Te,D as Gs}from"./DepartmentContext-CUMyywOO.js";import{g as Ie}from"./equipment-B5qd5N3O.js";import{P as Qs}from"./plus-C3JQqq7t.js";import{S as Zs}from"./square-pen-BMpSgZGa.js";import{T as Xs,a as ea,b as Oe,c as le,d as sa,e as re}from"./table-DnQAmABX.js";import{C as as,a as ts,b as ns}from"./collapsible-DWBtmsfD.js";import{S as is}from"./switch-DUBpZhIC.js";import{u as aa}from"./useMutation-DluhVBs1.js";import{C as qe}from"./clock-BXPvTWvY.js";import{C as ta}from"./calendar-_Cj_Sgy-.js";import{I as Be}from"./info-CpCfiYD2.js";import{M as na}from"./MorningSummarySubscription-C4lbp6sF.js";import{P as ia}from"./pen-D_H3YLSb.js";import{W as la,a as ra}from"./wifi-C3_7SFyW.js";import{U as ls}from"./upload-DF4rjO7T.js";import{S as oa}from"./search-D-OiWg8h.js";import{B as rs}from"./briefcase-BrpPecAy.js";import{G as os}from"./grid-3x3-D3Em47ud.js";import{Z as cs}from"./zap-QKspq41J.js";import{g as ca,c as da}from"./dryhireFolderService-Bb-tDpoa.js";import{C as Ve}from"./circle-check-big-CilmNGCn.js";import{C as We}from"./circle-x-DDzV-xk_.js";import{F as ma}from"./folder-plus-DTUhlRcm.js";import{B as ha}from"./bell-eCP3MIu-.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./SignUpForm-BqJSq2KU.js";import"./arrow-left-VpQwT4cv.js";import"./popover-Dl-b1R8L.js";import"./command-D3uMBT-Z.js";import"./useHouseTechRates-BLqiuvHa.js";import"./ratesQueryKeys-DgMsgg6U.js";import"./euro-DgRTeGAz.js";import"./save-z_re-Mcq.js";import"./avatar-QSp4LpEt.js";import"./camera-DACJL5j2.js";import"./index-Bf_BVWwW.js";import"./index-hC3MxXep.js";import"./api-C9EDenHJ.js";import"./config-DVV3VxR4.js";import"./constants-DoXhG9KB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ua=Fe("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xa=Fe("Keyboard",[["path",{d:"M10 8h.01",key:"1r9ogq"}],["path",{d:"M12 12h.01",key:"1mp3jc"}],["path",{d:"M14 8h.01",key:"1primd"}],["path",{d:"M16 12h.01",key:"1l6xoz"}],["path",{d:"M18 8h.01",key:"emo2bl"}],["path",{d:"M6 8h.01",key:"x9i8wu"}],["path",{d:"M7 16h10",key:"wp8him"}],["path",{d:"M8 12h.01",key:"czm47f"}],["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=Fe("Navigation",[["polygon",{points:"3 11 22 2 13 21 11 13 3 11",key:"1ltx0t"}]]),$e=({user:s,onEdit:t,onDelete:d,showPasswordAlert:w=!1,onManageSkills:m})=>{const c=be(s.first_name,s.nickname,s.last_name);return e.jsxs("div",{className:"group flex items-center justify-between p-3 border rounded-lg hover:bg-accent/5 transition-colors",children:[e.jsxs(Ss,{children:[e.jsx(ks,{asChild:!0,children:e.jsxs("div",{className:"flex items-center gap-3 cursor-pointer",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:c||s.email}),w&&e.jsx(Ds,{className:"h-4 w-4 text-warning"})]}),e.jsx("span",{className:"text-sm text-muted-foreground",children:s.email})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(pe,{variant:"secondary",children:s.role}),s.department&&e.jsx(pe,{variant:"outline",children:s.department})]})]})}),e.jsx(_s,{className:"w-80",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-sm font-semibold",children:"User Details"}),e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Phone:"})," ",s.phone||"Not provided"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"DNI/NIE:"})," ",s.dni||"Not provided"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Residencia:"})," ",s.residencia||"Not provided"]})]})]})})]}),e.jsxs("div",{className:"flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[m&&e.jsxs(k,{variant:"outline",size:"sm",onClick:()=>m(s),className:"h-8",children:[e.jsx(ua,{className:"h-4 w-4 mr-1"})," Skills"]}),e.jsx(k,{variant:"outline",size:"icon",onClick:()=>t(s),children:e.jsx(Fs,{className:"h-4 w-4"})}),e.jsx(k,{variant:"outline",size:"icon",onClick:()=>d(s),children:e.jsx(Je,{className:"h-4 w-4"})})]})]})},ze=({user:s,onOpenChange:t,onSave:d})=>{var I,V;const[w,m]=i.useState(!!(s!=null&&s.assignable_as_tech)),[c,r]=i.useState(!!(s!=null&&s.soundvision_access_enabled)),[n,N]=i.useState((s==null?void 0:s.autonomo)!==!1),{userRole:x}=Ae(),D=["admin","management"].includes(x||""),[_,v]=i.useState(""),[g,l]=i.useState((s==null?void 0:s.flex_resource_id)||""),[h,f]=i.useState(!1),[S,o]=i.useState((s==null?void 0:s.residencia)||""),[C,F]=i.useState((s==null?void 0:s.bg_color)||""),[b,O]=i.useState((s==null?void 0:s.profile_picture_url)||null);i.useEffect(()=>{m(!!(s!=null&&s.assignable_as_tech));const u=(s==null?void 0:s.department)==="sound"&&(s==null?void 0:s.role)==="house_tech";r(u?!0:!!(s!=null&&s.soundvision_access_enabled)),l((s==null?void 0:s.flex_resource_id)||""),v(""),N((s==null?void 0:s.autonomo)!==!1),o((s==null?void 0:s.residencia)||""),F((s==null?void 0:s.bg_color)||""),O((s==null?void 0:s.profile_picture_url)||null)},[s==null?void 0:s.id]);const B=(s==null?void 0:s.department)==="sound"&&(s==null?void 0:s.role)==="technician",y=(s==null?void 0:s.department)==="sound"&&(s==null?void 0:s.role)==="house_tech",j=y,T=u=>{var A;try{const R=u.trim(),W=/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}/,U=(A=R.match(W))==null?void 0:A[0];if(U)return U;const ie=(R.split("#")[1]||"").match(W);return(ie==null?void 0:ie[0])||null}catch{return null}},a=u=>{u.preventDefault();const A=new FormData(u.currentTarget);if(!(s!=null&&s.id))return;const R={id:s.id,first_name:A.get("firstName"),nickname:A.get("nickname"),last_name:A.get("lastName"),phone:A.get("phone"),department:A.get("department"),dni:A.get("dni"),residencia:S,bg_color:C||null,role:A.get("role"),assignable_as_tech:w,flex_resource_id:(A.get("flex_resource_id")||g||"").trim()||null,soundvision_access_enabled:j?!0:c,autonomo:n};d(R)},p=async()=>{if(!(s!=null&&s.email)){q({title:"Missing email",description:"This user has no email set.",variant:"destructive"});return}try{f(!0);const{error:u}=await H.functions.invoke("send-onboarding-email",{body:{email:s.email,firstName:s.first_name||void 0,lastName:s.last_name||void 0,department:s.department||void 0}});if(u)throw u;q({title:"Onboarding email sent",description:`Sent to ${s.email}`,variant:"success"})}catch(u){q({title:"Failed to send onboarding",description:u instanceof Error?u.message:"Unknown error",variant:"destructive"})}finally{f(!1)}};return e.jsx(ye,{open:!!s,onOpenChange:t,children:e.jsxs(Ne,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(we,{children:e.jsx(Ce,{children:"Edit User Profile"})}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("form",{onSubmit:a,className:"space-y-4",children:[e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(Is,{userId:(s==null?void 0:s.id)||"",currentPictureUrl:b,userInitials:`${((I=s==null?void 0:s.first_name)==null?void 0:I[0])||""}${((V=(s==null?void 0:s.nickname)||(s==null?void 0:s.last_name))==null?void 0:V[0])||""}`.toUpperCase()||"U",onUploadComplete:u=>O(u),onRemove:()=>O(null),size:"lg",showCameraIcon:!0})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"firstName",children:"First Name"}),e.jsx($,{id:"firstName",name:"firstName",defaultValue:(s==null?void 0:s.first_name)||""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"nickname",children:"Nickname"}),e.jsx($,{id:"nickname",name:"nickname",defaultValue:(s==null?void 0:s.nickname)||"",placeholder:"Optional"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"assignableAsTech",children:"Assignable to jobs as tech"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{id:"assignableAsTech",checked:w,onCheckedChange:u=>m(!!u)}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"If enabled, this user (typically management) can be assigned to jobs in technician lists."})]})]}),D&&(B||y)&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"soundvisionAccess",children:"SoundVision Access"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{id:"soundvisionAccess",checked:j?!0:c,onCheckedChange:u=>!j&&r(!!u),disabled:j}),e.jsx("span",{className:"text-sm text-muted-foreground",children:j?"House techs always retain SoundVision access.":"Allow this sound technician to access SoundVision files and tools."})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"lastName",children:"Last Name"}),e.jsx($,{id:"lastName",name:"lastName",defaultValue:(s==null?void 0:s.last_name)||""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"phone",children:"Phone Number"}),e.jsx($,{id:"phone",name:"phone",defaultValue:(s==null?void 0:s.phone)||""})]}),D&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"flex_resource_id",children:"Flex Resource ID"}),e.jsx("div",{className:"flex gap-2",children:e.jsx($,{id:"flex_resource_id",name:"flex_resource_id",placeholder:"4b0d98e0-e700-11ea-97d0-2a0a4490a7fb",value:g,onChange:u=>l(u.target.value)})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"flex_url",children:"Flex Contact URL (paste then Extract)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx($,{id:"flex_url",placeholder:"https://sectorpro.flexrentalsolutions.com/f5/ui/?desktop#contact/UUID/phone",value:_,onChange:u=>v(u.target.value)}),e.jsx(k,{type:"button",variant:"secondary",onClick:()=>{const u=T(_);u&&l(u)},children:"Extract"}),e.jsx(k,{type:"button",variant:"outline",onClick:async()=>{try{const u=await navigator.clipboard.readText();v(u);const A=T(u);A&&l(A)}catch{}},children:"Paste URL"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Example URL: https://sectorpro.flexrentalsolutions.com/f5/ui/?desktop#contact/4b0d98e0-e700-11ea-97d0-2a0a4490a7fb/phone"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"department",children:"Department"}),e.jsxs(Z,{name:"department",defaultValue:(s==null?void 0:s.department)||"sound",children:[e.jsx(X,{children:e.jsx(ee,{placeholder:"Select department"})}),e.jsxs(se,{children:[e.jsx(M,{value:"sound",children:"Sound"}),e.jsx(M,{value:"lights",children:"Lights"}),e.jsx(M,{value:"video",children:"Video"}),e.jsx(M,{value:"production",children:"Production"}),e.jsx(M,{value:"logistics",children:"Logistics"}),e.jsx(M,{value:"administrative",children:"Administrative"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"role",children:"Role"}),e.jsxs(Z,{name:"role",defaultValue:s==null?void 0:s.role,children:[e.jsx(X,{children:e.jsx(ee,{placeholder:"Select role"})}),e.jsxs(se,{children:[e.jsx(M,{value:"admin",children:"Admin"}),e.jsx(M,{value:"management",children:"Management"}),e.jsx(M,{value:"logistics",children:"Logistics"}),e.jsx(M,{value:"technician",children:"Technician"}),e.jsx(M,{value:"house_tech",children:"House Tech"})]})]})]}),(s==null?void 0:s.role)==="technician"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"autonomo",children:"AutÃ³nomo (Self-employed)"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{id:"autonomo",checked:n,onCheckedChange:u=>N(!!u)}),e.jsx("span",{className:"text-sm text-muted-foreground",children:n?"Technician is autonomous (standard rates apply)":"Not autonomous (â‚¬30/day discount applied)"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"dni",children:"DNI/NIE"}),e.jsx($,{id:"dni",name:"dni",defaultValue:(s==null?void 0:s.dni)||""})]}),e.jsx(Ts,{id:"residencia",value:S,onChange:o,placeholder:"Enter city",label:"Residencia",className:"space-y-2"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"bg_color",children:"Row Background Color"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[[{color:"#DC2626",name:"Red"},{color:"#2563EB",name:"Blue"},{color:"#16A34A",name:"Green"},{color:"#CA8A04",name:"Yellow"},{color:"#9333EA",name:"Purple"},{color:"#EA580C",name:"Orange"},{color:"#DB2777",name:"Pink"},{color:"#0891B2",name:"Cyan"},{color:"#65A30D",name:"Lime"},{color:"#7C3AED",name:"Violet"},{color:"#0D9488",name:"Teal"},{color:"#64748B",name:"Slate"}].map(({color:u,name:A})=>e.jsx("button",{type:"button",onClick:()=>F(u),className:`w-10 h-10 rounded border-2 transition-all hover:scale-110 ${C===u?"border-white ring-2 ring-white":"border-gray-300"}`,style:{backgroundColor:u},title:A},u)),C&&e.jsx(k,{type:"button",variant:"outline",onClick:()=>F(""),children:"Clear"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(k,{variant:"outline",type:"button",onClick:()=>t(!1),children:"Cancel"}),D&&e.jsx(k,{type:"button",variant:"secondary",onClick:()=>void p(),disabled:h,title:"Send the onboarding email with instructions and screenshots",children:h?"Sendingâ€¦":"Send Onboarding Email"}),e.jsx(k,{type:"submit",children:"Save Changes"})]})]}),D&&(s==null?void 0:s.id)&&e.jsxs(e.Fragment,{children:[e.jsx(As,{}),e.jsx(Es,{profileId:s.id,profileName:be(s.first_name,s.nickname,s.last_name)||"",category:(s.role==="house_tech","tecnico")})]})]})]})})},He=({user:s,onConfirm:t,onCancel:d})=>s?e.jsx(Us,{open:!!s,onOpenChange:w=>!w&&d(),children:e.jsxs(Ls,{children:[e.jsxs(Ps,{children:[e.jsx(Ms,{children:"Are you sure?"}),e.jsx(Os,{children:"This action cannot be undone. This will permanently delete the user account and remove their data from our servers."})]}),e.jsxs(qs,{children:[e.jsx(Bs,{onClick:d,children:"Cancel"}),e.jsx(Vs,{onClick:t,children:"Delete"})]})]})}):null,pa=()=>{const{toast:s}=fe(),t=Ye();return{handleDelete:async m=>{try{const{error:c}=await Q.functions.invoke("delete-user",{body:{userId:m.id}});if(c)throw c;s({title:"User deleted",description:"The user has been successfully deleted."}),t.invalidateQueries({queryKey:["profiles"]})}catch(c){s({title:"Error",description:"Failed to delete user: "+c.message,variant:"destructive"})}},handleSaveEdit:async m=>{var c;try{const{error:r}=await Q.from("profiles").update(m).eq("id",m.id);if(r)throw r;s({title:"Profile updated",description:"The user profile has been successfully updated."}),t.invalidateQueries({queryKey:["profiles"]});const{data:{session:n}}=await Q.auth.getSession();((c=n==null?void 0:n.user)==null?void 0:c.id)===m.id&&window.location.reload()}catch(r){s({title:"Error",description:"Failed to update user: "+r.message,variant:"destructive"})}}}},fa=({users:s,groupBy:t,isManagementUser:d=!1})=>{const[w,m]=i.useState(null),[c,r]=i.useState(null),[n,N]=i.useState(null),{handleDelete:x,handleSaveEdit:D}=pa(),_=l=>{l!=null&&l.id&&m(l)},v=l=>{l!=null&&l.id&&r(l)};if(!t)return e.jsxs(Me,{className:"h-[600px]",children:[e.jsx("div",{className:"space-y-2",children:s.map(l=>l!=null&&l.id?e.jsx($e,{user:l,onEdit:_,onDelete:v,onManageSkills:d?N:void 0},l.id):null)}),e.jsx(ze,{user:w,onOpenChange:l=>!l&&m(null),onSave:D}),e.jsx(He,{user:c,onConfirm:()=>c&&x(c),onCancel:()=>r(null)}),e.jsx(Pe,{profileId:(n==null?void 0:n.id)||null,fullName:be(n==null?void 0:n.first_name,n==null?void 0:n.nickname,n==null?void 0:n.last_name)||"",open:!!n,onOpenChange:l=>!l&&N(null)})]});const g=s.reduce((l,h)=>{const f=t==="department"?h.department||"Unassigned":h.role||"Unassigned";return{...l,[f]:[...l[f]||[],h]}},{});return e.jsxs(e.Fragment,{children:[e.jsx(Ws,{type:"multiple",className:"w-full",children:Object.entries(g).map(([l,h])=>e.jsxs($s,{value:l,children:[e.jsx(zs,{className:"hover:no-underline",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:l}),e.jsx(pe,{variant:"secondary",className:"ml-2",children:h.length})]})}),e.jsx(Hs,{children:e.jsx(Me,{className:"h-[300px]",children:e.jsx("div",{className:"space-y-2",children:h.map(f=>f!=null&&f.id?e.jsx($e,{user:f,onEdit:_,onDelete:v,onManageSkills:d?N:void 0},f.id):null)})})})]},l))}),e.jsx(ze,{user:w,onOpenChange:l=>!l&&m(null),onSave:D}),e.jsx(He,{user:c,onConfirm:()=>c&&x(c),onCancel:()=>r(null)}),e.jsx(Pe,{profileId:(n==null?void 0:n.id)||null,fullName:be(n==null?void 0:n.first_name,n==null?void 0:n.nickname,n==null?void 0:n.last_name)||"",open:!!n,onOpenChange:l=>!l&&N(null)})]})},ms=({className:s,...t})=>e.jsx("nav",{role:"navigation","aria-label":"pagination",className:Se("mx-auto flex w-full justify-center",s),...t});ms.displayName="Pagination";const hs=i.forwardRef(({className:s,...t},d)=>e.jsx("ul",{ref:d,className:Se("flex flex-row items-center gap-1",s),...t}));hs.displayName="PaginationContent";const je=i.forwardRef(({className:s,...t},d)=>e.jsx("li",{ref:d,className:Se("",s),...t}));je.displayName="PaginationItem";const us=({className:s,isActive:t,size:d="icon",...w})=>e.jsx("a",{"aria-current":t?"page":void 0,className:Se(ps({variant:t?"outline":"ghost",size:d}),s),...w});us.displayName="PaginationLink";const ke=10,ga=({searchQuery:s="",roleFilter:t="",departmentFilter:d="",isManagementUser:w=!1})=>{var F;Ks(["profiles"]);const[m,c]=i.useState(!1),[r,n]=i.useState(1),[N,x]=i.useState(null),[D,_]=i.useState("name"),[v,g]=i.useState("asc");i.useEffect(()=>{(async()=>{const{data:{session:O}}=await Q.auth.getSession();c(!!O);const{data:{subscription:B}}=Q.auth.onAuthStateChange((y,j)=>{c(!!j)});return()=>B.unsubscribe()})()},[]);const{data:l,isLoading:h,error:f,isFetching:S,refetch:o}=Ze({queryKey:["profiles",s,t,d,r,D,v],queryFn:async()=>{if(!m)return{data:[],count:0};try{let b=Q.from("profiles").select("id, first_name, nickname, last_name, email, role, phone, department, dni, residencia, assignable_as_tech, flex_resource_id, soundvision_access_enabled, autonomo",{count:"exact"});t&&(b=b.eq("role",t)),d&&(b=b.eq("department",d)),s&&(b=b.or(`first_name.ilike.%${s}%,nickname.ilike.%${s}%,last_name.ilike.%${s}%,email.ilike.%${s}%`)),D==="name"?b=b.order("first_name",{ascending:v==="asc"}):b=b.order(D,{ascending:v==="asc"});const O=(r-1)*ke;b=b.range(O,O+ke-1);const{data:B,error:y,count:j}=await b;if(y)throw y;return B?{data:B.filter(a=>a&&a.id),count:j||0}:{data:[],count:0}}catch(b){throw b}},enabled:m,staleTime:1e3*60*2,gcTime:1e3*60*5,refetchOnMount:!0,refetchOnWindowFocus:!0,refetchOnReconnect:!0,retry:3,retryDelay:b=>Math.min(1e3*2**b,3e4)}),C=l!=null&&l.count?Math.ceil(l.count/ke):0;return m?f?e.jsx(ae,{variant:"destructive",className:"mb-4",children:e.jsxs(te,{className:"flex items-center justify-between",children:[e.jsxs("span",{children:["Error loading users: ",f instanceof Error?f.message:"Network error occurred"]}),e.jsxs(k,{variant:"outline",size:"sm",onClick:()=>o(),disabled:S,className:"ml-2",children:[e.jsx(Ge,{className:`h-4 w-4 mr-1 ${S?"animate-spin":""}`}),"Retry"]})]})}):h?e.jsx("div",{className:"flex items-center justify-center p-4",children:e.jsx(ce,{className:"h-6 w-6 animate-spin"})}):(F=l==null?void 0:l.data)!=null&&F.length?e.jsxs("div",{className:"space-y-4",children:[S&&!h&&e.jsx("div",{className:"text-xs text-muted-foreground",children:"Refreshing..."}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Z,{value:N||"none",onValueChange:b=>x(b==="none"?null:b),children:[e.jsx(X,{className:"w-[180px]",children:e.jsx(ee,{placeholder:"Group by..."})}),e.jsxs(se,{children:[e.jsx(M,{value:"none",children:"No grouping"}),e.jsx(M,{value:"department",children:"By Department"}),e.jsx(M,{value:"role",children:"By Role"})]})]}),e.jsxs(Z,{value:D,onValueChange:b=>_(b),children:[e.jsx(X,{className:"w-[180px]",children:e.jsx(ee,{placeholder:"Sort by..."})}),e.jsxs(se,{children:[e.jsx(M,{value:"name",children:"Sort by Name"}),e.jsx(M,{value:"email",children:"Sort by Email"}),e.jsx(M,{value:"role",children:"Sort by Role"}),e.jsx(M,{value:"department",children:"Sort by Department"})]})]}),e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>g(v==="asc"?"desc":"asc"),children:v==="asc"?"â†‘":"â†“"})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Total: ",l.count," users"]})]}),e.jsx(fa,{users:l.data,groupBy:N,isManagementUser:w}),C>1&&e.jsx(ms,{children:e.jsxs(hs,{children:[e.jsx(je,{children:e.jsx(k,{variant:"outline",size:"sm",onClick:()=>n(b=>Math.max(1,b-1)),disabled:r===1,children:"Previous"})}),Array.from({length:C},(b,O)=>O+1).map(b=>e.jsx(je,{children:e.jsx(us,{isActive:r===b,onClick:()=>n(b),children:b})},b)),e.jsx(je,{children:e.jsx(k,{variant:"outline",size:"sm",onClick:()=>n(b=>Math.min(C,b+1)),disabled:r===C,children:"Next"})})]})})]}):e.jsx(ae,{children:e.jsx(te,{children:"No users found."})}):e.jsx(ae,{children:e.jsx(te,{children:"Please sign in to view users."})})},ja=({searchQuery:s,onSearchChange:t,selectedRole:d,onRoleChange:w,selectedDepartment:m,onDepartmentChange:c,onClearFilters:r})=>{const n=["admin","management","logistics","technician","house_tech"],N=["sound","lights","video","production"];return e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-4",children:[e.jsx($,{placeholder:"Search by name or email...",value:s,onChange:x=>t(x.target.value),className:"md:w-1/3",onKeyDown:x=>x.stopPropagation(),onKeyUp:x=>x.stopPropagation(),onKeyPress:x=>x.stopPropagation()}),e.jsxs(Z,{value:d,onValueChange:w,children:[e.jsx(X,{className:"md:w-1/4",children:e.jsx(ee,{placeholder:"Filter by role"})}),e.jsxs(se,{children:[e.jsx(M,{value:"all",children:"All roles"}),n.map(x=>e.jsx(M,{value:x,children:x.charAt(0).toUpperCase()+x.slice(1)},x))]})]}),e.jsxs(Z,{value:m,onValueChange:c,children:[e.jsx(X,{className:"md:w-1/4",children:e.jsx(ee,{placeholder:"Filter by department"})}),e.jsxs(se,{children:[e.jsx(M,{value:"all",children:"All departments"}),N.map(x=>e.jsx(M,{value:x,children:x.charAt(0).toUpperCase()+x.slice(1)},x))]})]}),(s||d||m)&&e.jsx(k,{variant:"ghost",size:"icon",onClick:r,className:"shrink-0",children:e.jsx(De,{className:"h-4 w-4"})})]})},va=({open:s,onOpenChange:t})=>{const[d,w]=i.useState(null),[m,c]=i.useState(!1),[r,n]=i.useState(null),{toast:N}=fe(),x=v=>{var l;const g=(l=v.target.files)==null?void 0:l[0];if(g&&g.type!=="text/csv"){n("Please upload a CSV file");return}w(g||null),n(null)},D=()=>{const v=`email,firstName,nickname,lastName,role,department,phone,dni,residencia
`,g=new Blob([v],{type:"text/csv"}),l=window.URL.createObjectURL(g),h=document.createElement("a");h.href=l,h.download="users_template.csv",document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(l)},_=async()=>{if(d){c(!0),n(null);try{const v=new FormData;v.append("file",d);const{data:g,error:l}=await Q.functions.invoke("import-users",{body:v});if(l)throw l;N({title:"Import successful",description:`Successfully imported ${g.successful.length} users`}),t(!1)}catch(v){n(v.message||"Failed to import users"),N({title:"Import failed",description:"There was an error importing users",variant:"destructive"})}finally{c(!1)}}};return e.jsx(ye,{open:s,onOpenChange:t,children:e.jsxs(Ne,{children:[e.jsx(we,{children:e.jsx(Ce,{children:"Import Users"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(k,{variant:"outline",onClick:D,className:"w-full",children:[e.jsx(Xe,{className:"mr-2 h-4 w-4"}),"Download Template"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"file",accept:".csv",onChange:x,className:"w-full"}),r&&e.jsx(ae,{variant:"destructive",children:e.jsx(te,{children:r})})]}),e.jsx(k,{onClick:_,disabled:!d||m,className:"w-full",children:m?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"mr-2 h-4 w-4 animate-spin"}),"Processing..."]}):"Import Users"})]})]})})},ba=()=>{const[s,t]=i.useState(!1),d=async w=>{var c;const m=(c=w.target.files)==null?void 0:c[0];if(m){if(!m.type.startsWith("image/")){q.error("Invalid file type",{description:"Please upload an image file"});return}t(!0);try{const{error:r}=await Q.storage.from("company-assets").upload("sector-pro-logo.png",m,{upsert:!0});if(r)throw r;q.success("Success",{description:"Company logo has been uploaded"})}catch{q.error("Error",{description:"Could not upload logo"})}finally{t(!1)}}};return e.jsxs("div",{children:[e.jsx("input",{type:"file",id:"company-logo-upload",accept:"image/*",className:"hidden",onChange:d,disabled:s}),e.jsx(k,{asChild:!0,variant:"outline",disabled:s,children:e.jsx("label",{htmlFor:"company-logo-upload",className:"cursor-pointer",children:s?"Uploading...":e.jsxs(e.Fragment,{children:[e.jsx(Js,{className:"h-4 w-4 mr-2"}),"Upload Company Logo"]})})})]})},ya=({open:s,onOpenChange:t,defaultCategory:d})=>{var y;const{department:w}=Te(),m=Ie(w),{toast:c}=fe(),[r,n]=i.useState(""),[N,x]=i.useState(""),[D,_]=i.useState(d||((y=m[0])==null?void 0:y.value)||""),[v,g]=i.useState(""),[l,h]=i.useState(""),[f,S]=i.useState(""),[o,C]=i.useState(!1),{createModel:F,isCreating:b}=Ee();i.useEffect(()=>{d?_(d):m[0]&&_(m[0].value)},[d,m]);const O=j=>{var T;j.preventDefault(),r.trim()&&(F({name:r.trim(),category:D,resource_id:v.trim()||void 0,manufacturer:N.trim()||void 0,image_id:l.trim()||void 0}),n(""),x(""),_(d||((T=m[0])==null?void 0:T.value)||""),g(""),h(""),S(""),t(!1))},B=j=>{var T;j||(n(""),x(""),_(d||((T=m[0])==null?void 0:T.value)||""),g(""),h(""),S("")),t(j)};return e.jsx(ye,{open:s,onOpenChange:B,children:e.jsxs(Ne,{children:[e.jsx(we,{children:e.jsx(Ce,{children:"Add Equipment Model"})}),e.jsxs("form",{onSubmit:O,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"name",children:"Model Name"}),e.jsx($,{id:"name",value:r,onChange:j=>n(j.target.value),placeholder:"Enter model name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"manufacturer",children:"Manufacturer"}),e.jsx($,{id:"manufacturer",value:N,onChange:j=>x(j.target.value),placeholder:"Enter manufacturer (optional)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"category",children:"Category"}),e.jsxs(Z,{value:D,onValueChange:_,children:[e.jsx(X,{children:e.jsx(ee,{})}),e.jsx(se,{children:m.map(j=>e.jsx(M,{value:j.value,children:j.label},j.value))})]})]}),e.jsxs("div",{className:"space-y-3 border rounded-md p-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"resourceId",children:"Flex Resource ID (optional)"}),e.jsx($,{id:"resourceId",type:"text",placeholder:"adcf7550-4fa3-11eb-815f-2a0a4490a7fb",value:v,onChange:j=>g(j.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"flexUrl",children:"Flex URL (paste and extract)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx($,{id:"flexUrl",type:"text",placeholder:"https://sectorpro.flexrentalsolutions.com/f5/ui/#inventory-model/UUID/quantity",value:f,onChange:j=>S(j.target.value)}),e.jsx(k,{type:"button",variant:"secondary",onClick:()=>{var a;const j=/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}/,T=(a=(f||"").match(j))==null?void 0:a[0];T&&g(T)},children:"Extract"}),e.jsx(k,{type:"button",variant:"outline",onClick:async()=>{var j;try{const T=await navigator.clipboard.readText(),a=/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}/,p=(j=(T||"").match(a))==null?void 0:j[0];S(T),p&&g(p)}catch{}},children:"Paste URL"}),e.jsx(k,{type:"button",variant:"default",disabled:o||!(v||f),onClick:async()=>{try{C(!0);const{data:j,error:T}=await Q.functions.invoke("fetch-flex-inventory-model",{body:v?{model_id:v}:{url:f}});if(T)throw T;if(j!=null&&j.error)throw new Error(j.error);const a=(j==null?void 0:j.mapped)||{};n(a.name||r),x(a.manufacturer||N),g((j==null?void 0:j.model_id)||v),h(a.imageId||l),c({title:"Fetched from Flex",description:"Equipment data has been auto-filled."})}catch(j){c({title:"Failed to fetch from Flex",description:(j==null?void 0:j.message)||"Unknown error",variant:"destructive"})}finally{C(!1)}},children:o?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"mr-2 h-4 w-4 animate-spin"}),"Fetchingâ€¦"]}):"Fetch from Flex"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Example: https://sectorpro.flexrentalsolutions.com/f5/ui/#inventory-model/adcf7550-4fa3-11eb-815f-2a0a4490a7fb/quantity"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(k,{type:"button",variant:"outline",onClick:()=>B(!1),children:"Cancel"}),e.jsx(k,{type:"submit",disabled:b,children:b?"Creating...":"Create"})]})]})]})})},Na=({open:s,onOpenChange:t,model:d})=>{const{department:w}=Te(),m=Ie(w),{toast:c}=fe(),[r,n]=i.useState(""),[N,x]=i.useState(""),[D,_]=i.useState(""),[v,g]=i.useState(""),[l,h]=i.useState(""),[f,S]=i.useState(""),[o,C]=i.useState(!1),{updateModel:F,isUpdating:b}=Ee();i.useEffect(()=>{d&&(n(d.name),x(d.manufacturer||""),_(d.category),g(d.resource_id||""),h(d.image_id||""))},[d]);const O=y=>{y.preventDefault(),!(!d||!r.trim())&&(F({id:d.id,name:r.trim(),category:D,resource_id:v.trim()||void 0,manufacturer:N.trim()||void 0,image_id:l.trim()||void 0}),t(!1))},B=y=>{y||(n(""),x(""),_(""),g(""),h(""),S("")),t(y)};return e.jsx(ye,{open:s,onOpenChange:B,children:e.jsxs(Ne,{children:[e.jsx(we,{children:e.jsx(Ce,{children:"Edit Equipment Model"})}),e.jsxs("form",{onSubmit:O,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"name",children:"Model Name"}),e.jsx($,{id:"name",value:r,onChange:y=>n(y.target.value),placeholder:"Enter model name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"manufacturer",children:"Manufacturer"}),e.jsx($,{id:"manufacturer",value:N,onChange:y=>x(y.target.value),placeholder:"Enter manufacturer (optional)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"category",children:"Category"}),e.jsxs(Z,{value:D,onValueChange:_,children:[e.jsx(X,{children:e.jsx(ee,{})}),e.jsx(se,{children:m.map(y=>e.jsx(M,{value:y.value,children:y.label},y.value))})]})]}),e.jsxs("div",{className:"space-y-3 border rounded-md p-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"resourceId",children:"Flex Resource ID (optional)"}),e.jsx($,{id:"resourceId",type:"text",placeholder:"adcf7550-4fa3-11eb-815f-2a0a4490a7fb",value:v,onChange:y=>g(y.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"flexUrl",children:"Flex URL (paste and extract)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx($,{id:"flexUrl",type:"text",placeholder:"https://sectorpro.flexrentalsolutions.com/f5/ui/#inventory-model/UUID/quantity",value:f,onChange:y=>S(y.target.value)}),e.jsx(k,{type:"button",variant:"secondary",onClick:()=>{var T;const y=/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}/,j=(T=(f||"").match(y))==null?void 0:T[0];j&&g(j)},children:"Extract"}),e.jsx(k,{type:"button",variant:"outline",onClick:async()=>{var y;try{const j=await navigator.clipboard.readText(),T=/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}/,a=(y=(j||"").match(T))==null?void 0:y[0];S(j),a&&g(a)}catch{}},children:"Paste URL"}),e.jsx(k,{type:"button",variant:"default",disabled:o||!(v||f),onClick:async()=>{try{C(!0);const{data:y,error:j}=await Q.functions.invoke("fetch-flex-inventory-model",{body:v?{model_id:v}:{url:f}});if(j)throw j;if(y!=null&&y.error)throw new Error(y.error);const T=(y==null?void 0:y.mapped)||{};n(T.name||r),x(T.manufacturer||N),g((y==null?void 0:y.model_id)||v),h(T.imageId||l),c({title:"Fetched from Flex",description:"Equipment data has been auto-filled."})}catch(y){c({title:"Failed to fetch from Flex",description:(y==null?void 0:y.message)||"Unknown error",variant:"destructive"})}finally{C(!1)}},children:o?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"mr-2 h-4 w-4 animate-spin"}),"Fetchingâ€¦"]}):"Fetch from Flex"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Example: https://sectorpro.flexrentalsolutions.com/f5/ui/#inventory-model/adcf7550-4fa3-11eb-815f-2a0a4490a7fb/quantity"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(k,{type:"button",variant:"outline",onClick:()=>B(!1),children:"Cancel"}),e.jsx(k,{type:"submit",disabled:b,children:b?"Updating...":"Update"})]})]})]})})},wa=()=>{var S;const{department:s}=Te(),t=Ie(s),[d,w]=i.useState(!1),[m,c]=i.useState(!1),[r,n]=i.useState(null),[N,x]=i.useState(((S=t[0])==null?void 0:S.value)||""),{models:D,isLoading:_,deleteModel:v,isDeleting:g}=Ee(),l=D.filter(o=>o.category===N),h=o=>{n(o),c(!0)},f=o=>{confirm("Are you sure you want to delete this equipment model?")&&v(o)};return _?e.jsx("div",{className:"text-center py-4",children:"Loading equipment models..."}):t.length===0?e.jsx("div",{className:"text-center py-4",children:"No categories available for this department"}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h4",{className:"text-sm font-medium",children:"Equipment Models"}),e.jsxs(k,{size:"sm",onClick:()=>w(!0),children:[e.jsx(Qs,{className:"h-4 w-4 mr-2"}),"Add Model"]})]}),e.jsxs(es,{value:N,onValueChange:x,children:[e.jsx(ss,{className:`grid w-full grid-cols-${t.length}`,children:t.map(o=>e.jsx(oe,{value:o.value,children:o.label},o.value))}),t.map(o=>e.jsx(Ys,{value:o.value,className:"space-y-2",children:l.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No models in this category"}):e.jsx("div",{className:"space-y-2",children:l.map(C=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg",children:[e.jsx("span",{className:"text-sm",children:C.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{size:"sm",variant:"ghost",onClick:()=>h(C),children:e.jsx(Zs,{className:"h-3 w-3"})}),e.jsx(k,{size:"sm",variant:"ghost",onClick:()=>f(C.id),disabled:g,children:e.jsx(Je,{className:"h-3 w-3"})})]})]},C.id))})},o.value))]}),e.jsx(ya,{open:d,onOpenChange:w,defaultCategory:N}),e.jsx(Na,{open:m,onOpenChange:c,model:r})]})},Ca=()=>{const[s,t]=i.useState([]),d=i.useRef(!1);return i.useEffect(()=>{var r;d.current=!0;const c=n=>{const N=n.data;!N||N.source!=="sw"||d.current&&t(x=>[...x,N].slice(-20))};return"serviceWorker"in navigator&&(navigator.serviceWorker.addEventListener("message",c),(r=navigator.serviceWorker.controller)==null||r.postMessage({type:"sw:ping"})),()=>{d.current=!1,"serviceWorker"in navigator&&navigator.serviceWorker.removeEventListener("message",c)}},[]),{events:s,showLocalTest:async()=>{if(!("Notification"in window)||!("serviceWorker"in navigator))return;const c=await navigator.serviceWorker.getRegistration("/")||await navigator.serviceWorker.ready,r=navigator.serviceWorker.controller||(c==null?void 0:c.active);r==null||r.postMessage({type:"sw:show-test",data:{title:"Local SW test",body:"Testing notification display"}})},getSubscriptionInfo:async()=>{if(!("serviceWorker"in navigator))return null;try{const c=await navigator.serviceWorker.getRegistration("/")||await navigator.serviceWorker.ready,r=await(c==null?void 0:c.pushManager.getSubscription());return(r==null?void 0:r.toJSON())??null}catch{return null}}}},_e=[{id:"sound",label:"Sound"},{id:"lights",label:"Lights"},{id:"video",label:"Video"},{id:"logistics",label:"Logistics"},{id:"production",label:"Production"}],Ke=[{code:"job.created",label:"Job created"},{code:"job.updated",label:"Job updated"},{code:"job.requirements.updated",label:"Job requirements updated"},{code:"job.deleted",label:"ðŸ—‘ï¸ Job deleted (CRITICAL)"},{code:"job.status.confirmed",label:"Job confirmed"},{code:"job.status.cancelled",label:"Job cancelled"},{code:"job.invoicing_company.changed",label:"Invoicing company changed"},{code:"job.assignment.confirmed",label:"Assignment confirmed"},{code:"job.assignment.direct",label:"Direct job assignment"},{code:"assignment.removed",label:"ðŸš« Assignment removed (CRITICAL)"},{code:"job.type.changed",label:"Job type changed"},{code:"job.type.changed.single",label:"Job changed to Single"},{code:"job.type.changed.tour",label:"Job changed to Tour"},{code:"job.type.changed.festival",label:"Job changed to Festival"},{code:"job.type.changed.dryhire",label:"Job changed to Dry Hire"},{code:"job.type.changed.tourdate",label:"Job changed to Tour Date"},{code:"document.uploaded",label:"Document uploaded"},{code:"document.deleted",label:"Document deleted"},{code:"document.tech_visible.enabled",label:"Document visible to technicians"},{code:"document.tech_visible.disabled",label:"Document hidden from technicians"},{code:"incident.report.uploaded",label:"âš ï¸ Incident report uploaded (CRITICAL)"},{code:"staffing.availability.sent",label:"Availability requested"},{code:"staffing.availability.confirmed",label:"Availability confirmed"},{code:"staffing.availability.declined",label:"Availability declined"},{code:"staffing.availability.cancelled",label:"Availability cancelled"},{code:"staffing.offer.sent",label:"Offer sent"},{code:"staffing.offer.confirmed",label:"Offer accepted"},{code:"staffing.offer.declined",label:"Offer declined"},{code:"timesheet.submitted",label:"Timesheet submitted"},{code:"timesheet.approved",label:"âœ… Timesheet approved"},{code:"timesheet.rejected",label:"âŒ Timesheet rejected"},{code:"task.assigned",label:"Task assigned"},{code:"task.updated",label:"Task updated"},{code:"task.completed",label:"Task completed"},{code:"logistics.transport.requested",label:"Transport requested"},{code:"logistics.event.created",label:"Logistics event created"},{code:"logistics.event.updated",label:"Logistics event updated"},{code:"logistics.event.cancelled",label:"Logistics event cancelled"},{code:"flex.folders.created",label:"Flex folders created"},{code:"flex.tourdate_folder.created",label:"Tour date folder created"},{code:"message.received",label:"Message received"},{code:"tourdate.created",label:"Tour date created"},{code:"tourdate.updated",label:"Tour date updated"},{code:"tourdate.deleted",label:"Tour date deleted"},{code:"tourdate.type.changed",label:"Tour date type changed"},{code:"tourdate.type.changed.show",label:"Tour date changed to Show"},{code:"tourdate.type.changed.rehearsal",label:"Tour date changed to Rehearsal"},{code:"tourdate.type.changed.travel",label:"Tour date changed to Travel"},{code:"tourdate.type.changed.setup",label:"Tour date changed to Setup"},{code:"tourdate.type.changed.off",label:"Tour date changed to Day Off"},{code:"jobdate.type.changed",label:"Job date type changed"},{code:"jobdate.type.changed.show",label:"Job date changed to Show"},{code:"jobdate.type.changed.rehearsal",label:"Job date changed to Rehearsal"},{code:"jobdate.type.changed.travel",label:"Job date changed to Travel"},{code:"jobdate.type.changed.setup",label:"Job date changed to Setup"},{code:"jobdate.type.changed.off",label:"Job date changed to Day Off"},{code:"soundvision.file.uploaded",label:"SoundVision file uploaded"},{code:"soundvision.file.downloaded",label:"SoundVision file downloaded"},{code:"changelog.updated",label:"ðŸ“ Changelog updated"}];function K(s,t,d){return`${s}|${t}|${d??""}`}function Sa(){const{userRole:s}=Ae(),t=["admin","management"].includes(s||""),d=fs(),[w,m]=i.useState(!0),[c,r]=i.useState(!1),[n,N]=i.useState([]),[x,D]=i.useState([]),[_,v]=i.useState({}),[g,l]=i.useState(new Set),[h,f]=i.useState(!1),S=g.size,o=i.useMemo(()=>x.slice().sort((a,p)=>a.name.localeCompare(p.name)),[x]),C=(a,p,I)=>(_[a]||[]).some(u=>u.recipient_type===p&&(u.target_id??"")===(I??"")),F=a=>a.startsWith("job.")||a.startsWith("document.")||a.startsWith("staffing.")||a.startsWith("jobdate.")||a==="flex.folders.created",b=a=>(_[a]||[]).some(I=>I.recipient_type==="natural"||I.include_natural_recipients===!0),O=(a,p,I,V)=>{v(u=>{const A={...u},R=(A[a]||[]).slice(),W=R.findIndex(U=>U.recipient_type===p&&(U.target_id??"")===(I??""));return V?W===-1&&R.push({id:`temp-${Math.random().toString(36).slice(2)}`,event_code:a,recipient_type:p,target_id:I,include_natural_recipients:p==="natural"}):W!==-1&&R.splice(W,1),A[a]=R,A})},B=(a,p)=>{v(I=>{const V={...I};let u=(V[a]||[]).slice();return p?u.some(R=>R.recipient_type==="natural")||u.push({id:`temp-${Math.random().toString(36).slice(2)}`,event_code:a,recipient_type:"natural",target_id:null,include_natural_recipients:!0}):u=u.filter(A=>A.recipient_type!=="natural").map(A=>({...A,include_natural_recipients:!1})),V[a]=u,V})},y=async(a,p,I,V)=>{const u=K(a,p,I);l(R=>new Set(R).add(u));const A=()=>l(R=>{const W=new Set(R);return W.delete(u),W});O(a,p,I,V);try{if(V){const{error:R}=await H.from("push_notification_routes").insert({event_code:a,recipient_type:p,target_id:I,include_natural_recipients:p==="natural"});if(R)throw R;q({title:"Saved",description:"Routing updated."})}else{let R=H.from("push_notification_routes").delete().eq("event_code",a).eq("recipient_type",p);I===null?R=R.is("target_id",null):R=R.eq("target_id",I);const{error:W}=await R;if(W)throw W;q({title:"Removed",description:"Routing removed."})}}catch(R){O(a,p,I,!V),q({title:"Save failed",description:(R==null?void 0:R.message)||"Unknown error",variant:"destructive"})}finally{A()}},j=async(a,p)=>{const I=K(a,"natural","*");l(u=>new Set(u).add(I));const V=()=>l(u=>{const A=new Set(u);return A.delete(I),A});B(a,p);try{if(p){const{error:u}=await H.from("push_notification_routes").insert({event_code:a,recipient_type:"natural",target_id:null,include_natural_recipients:!0});if(u)throw u;q({title:"Enabled",description:"Natural recipients will be included."})}else{const{error:u}=await H.from("push_notification_routes").delete().eq("event_code",a).eq("recipient_type","natural");if(u)throw u;await H.from("push_notification_routes").update({include_natural_recipients:!1}).eq("event_code",a),q({title:"Disabled",description:"Natural recipients excluded for this event."})}}catch(u){B(a,!p),q({title:"Save failed",description:(u==null?void 0:u.message)||"Unknown error",variant:"destructive"})}finally{V()}},T=async()=>{r(!0);try{const[a,p,I]=await Promise.all([H.from("profiles").select("id, first_name, last_name, nickname, email, department, role").in("role",["admin","management"]),H.from("activity_catalog").select("code, label").order("code",{ascending:!0}),H.from("push_notification_routes").select("id, event_code, recipient_type, target_id, include_natural_recipients")]),V=(a.data||[]).map(U=>({id:U.id,name:`${U.first_name||""} ${U.last_name||""}`.trim()||U.nickname||U.email,email:U.email,department:U.department??null}));D(V);const u=Array.isArray(p.data)?p.data.map(U=>({code:U.code,label:U.label||U.code})):[],A=new Map;for(const U of Ke)A.set(U.code,U);for(const U of u)A.set(U.code,U);const R=Array.from(A.values()).sort((U,ne)=>U.code.localeCompare(ne.code));N(R);const W={};for(const U of I.data||[])W[U.event_code]=W[U.event_code]||[],W[U.event_code].push(U);v(W)}catch(a){q({title:"Load failed",description:(a==null?void 0:a.message)||"Unknown error",variant:"destructive"}),n.length===0&&N(Ke)}finally{m(!1),r(!1)}};return i.useEffect(()=>{T()},[]),d?e.jsx(as,{open:h,onOpenChange:f,className:"fixed bottom-[calc(4rem+env(safe-area-inset-bottom))] left-0 right-0 z-30",children:e.jsxs(de,{className:"rounded-t-lg rounded-b-none border-x-0 border-b-0 shadow-lg",children:[e.jsx(ts,{asChild:!0,children:e.jsx(ue,{className:"cursor-pointer hover:bg-accent/50 transition-colors pb-3",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(xe,{className:"text-base",children:"Push Routing Matrix"}),e.jsx(ve,{className:"text-xs",children:h?"Configure notification routing":"Tap to configure notifications"})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[S>0&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Saving ",S,"â€¦"]}),h?e.jsx(Qe,{className:"h-5 w-5"}):e.jsx(gs,{className:"h-5 w-5"})]})]})})}),e.jsx(ns,{children:e.jsxs(me,{className:"max-h-[60vh] overflow-y-auto pt-0",children:[w?e.jsx("div",{className:"p-4 text-sm text-muted-foreground",children:"Loadingâ€¦"}):e.jsxs("div",{children:[e.jsx("div",{className:"flex justify-end mb-3",children:e.jsx(k,{variant:"outline",size:"sm",onClick:()=>void T(),disabled:c,children:c?"Refreshingâ€¦":"Refresh"})}),e.jsx("div",{className:"space-y-4",children:n.map(a=>e.jsxs("div",{className:"rounded-md border p-3",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("div",{className:"font-medium leading-tight",children:a.label}),e.jsx("div",{className:"text-xs text-muted-foreground break-all",children:a.code})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm",children:"Natural recipients"}),e.jsx(z,{checked:b(a.code),onCheckedChange:p=>t&&j(a.code,!!p),disabled:!t||g.has(K(a.code,"natural","*"))})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm",children:"Broadcast to management"}),e.jsx(z,{checked:C(a.code,"broadcast",null),onCheckedChange:p=>t&&y(a.code,"broadcast",null,!!p),disabled:!t||g.has(K(a.code,"broadcast",null))})]}),F(a.code)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm",children:"Assigned technicians"}),e.jsx(z,{checked:C(a.code,"assigned_technicians",null),onCheckedChange:p=>t&&y(a.code,"assigned_technicians",null,!!p),disabled:!t||g.has(K(a.code,"assigned_technicians",null))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-muted-foreground mb-1",children:"Departments"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:_e.map(p=>e.jsxs("label",{className:"flex items-center justify-between rounded border px-2 py-1 text-sm",children:[e.jsx("span",{children:p.label}),e.jsx(z,{checked:C(a.code,"department",p.id),onCheckedChange:I=>t&&y(a.code,"department",p.id,!!I),disabled:!t||g.has(K(a.code,"department",p.id))})]},`${a.code}|${p.id}`))})]}),o.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-muted-foreground mb-1",children:"Management users"}),e.jsx("div",{className:"space-y-2",children:o.map(p=>e.jsxs("label",{className:"flex items-center justify-between rounded border px-2 py-1 text-sm",children:[e.jsx("span",{className:"min-w-0 truncate pr-2",children:p.name}),e.jsx(z,{checked:C(a.code,"management_user",p.id),onCheckedChange:I=>t&&y(a.code,"management_user",p.id,!!I),disabled:!t||g.has(K(a.code,"management_user",p.id))})]},`${a.code}|${p.id}`))})]})]})]},a.code))})]}),!t&&e.jsx("p",{className:"mt-3 text-xs text-muted-foreground",children:"Viewing only â€” editing requires management role."})]})})]})}):e.jsxs(de,{children:[e.jsx(ue,{children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 min-w-0",children:[e.jsxs("div",{children:[e.jsx(xe,{children:"Push Routing Matrix"}),e.jsx(ve,{children:"Configure which management users, departments, and assigned technicians receive each event. Natural recipients toggle preserves default recipients."})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-sm min-w-0",children:[S>0&&e.jsxs("span",{className:"text-muted-foreground",children:["Saving ",S,"â€¦"]}),e.jsx(k,{variant:"outline",size:"sm",onClick:()=>void T(),disabled:c,children:c?"Refreshingâ€¦":"Refresh"})]})]})}),e.jsxs(me,{children:[w?e.jsx("div",{className:"p-4 text-sm text-muted-foreground",children:"Loadingâ€¦"}):e.jsx("div",{children:e.jsx("div",{className:"relative overflow-x-auto border rounded-md",children:e.jsxs(Xs,{children:[e.jsx(ea,{children:e.jsxs(Oe,{children:[e.jsx(le,{className:"min-w-[220px] sticky left-0 z-20 bg-background border-r shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]",children:"Event"}),e.jsx(le,{className:"min-w-[120px]",children:"Natural"}),e.jsx(le,{className:"min-w-[120px]",children:"Broadcast"}),e.jsx(le,{className:"min-w-[180px]",children:"Assigned technicians"}),_e.map(a=>e.jsx(le,{className:"min-w-[140px]",children:a.label},a.id)),o.map(a=>e.jsx(le,{className:"min-w-[180px]",children:a.name},a.id))]})}),e.jsx(sa,{children:n.map(a=>e.jsxs(Oe,{children:[e.jsx(re,{className:"sticky left-0 z-10 bg-background border-r shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:a.label}),e.jsx("span",{className:"text-xs text-muted-foreground",children:a.code})]})}),e.jsx(re,{children:e.jsx(z,{checked:b(a.code),onCheckedChange:p=>t&&j(a.code,!!p),disabled:!t||g.has(K(a.code,"natural","*"))})}),e.jsx(re,{children:e.jsx(z,{checked:C(a.code,"broadcast",null),onCheckedChange:p=>t&&y(a.code,"broadcast",null,!!p),disabled:!t||g.has(K(a.code,"broadcast",null))})}),e.jsx(re,{children:e.jsx(z,{checked:C(a.code,"assigned_technicians",null),onCheckedChange:p=>t&&y(a.code,"assigned_technicians",null,!!p),disabled:!t||!F(a.code)||g.has(K(a.code,"assigned_technicians",null))})}),_e.map(p=>e.jsx(re,{children:e.jsx(z,{checked:C(a.code,"department",p.id),onCheckedChange:I=>t&&y(a.code,"department",p.id,!!I),disabled:!t||g.has(K(a.code,"department",p.id))})},`${a.code}|${p.id}`)),o.map(p=>e.jsx(re,{children:e.jsx(z,{checked:C(a.code,"management_user",p.id),onCheckedChange:I=>t&&y(a.code,"management_user",p.id,!!I),disabled:!t||g.has(K(a.code,"management_user",p.id))})},`${a.code}|${p.id}`))]},a.code))})]})})}),!t&&e.jsx("p",{className:"mt-3 text-xs text-muted-foreground",children:"Viewing only â€” editing requires management role."})]})]})}function ka(s){const{toast:t}=fe(),d=Ye(),{data:w,isLoading:m,error:c}=Ze({queryKey:["push-notification-schedule",s],queryFn:async()=>{const{data:n,error:N}=await H.from("push_notification_schedules").select("*").eq("event_type",s).maybeSingle();if(N)throw N;return n}}),r=aa({mutationFn:async n=>{const{data:N,error:x}=await H.from("push_notification_schedules").update(n).eq("event_type",s).select().single();if(x)throw x;return N},onSuccess:()=>{d.invalidateQueries({queryKey:["push-notification-schedule",s]}),t({title:"ConfiguraciÃ³n actualizada",description:"Los cambios en la programaciÃ³n se han guardado correctamente."})},onError:n=>{t({title:"Error al actualizar",description:n.message,variant:"destructive"})}});return{schedule:w,isLoading:m,error:c,updateSchedule:r.mutate,isUpdating:r.isPending}}function _a(){const{schedule:s,isLoading:t,updateSchedule:d,isUpdating:w}=ka("daily.morning.summary"),[m,c]=i.useState(!1),[r,n]=i.useState("08:00"),[N,x]=i.useState([1,2,3,4,5]);i.useEffect(()=>{s&&(c(s.enabled),n(s.schedule_time.substring(0,5)),x(s.days_of_week||[1,2,3,4,5]))},[s]);const D=()=>{d({enabled:m,schedule_time:`${r}:00`,days_of_week:N})},_=f=>{x(S=>S.includes(f)?S.filter(o=>o!==f):[...S,f].sort())},v=[{value:1,label:"Lun"},{value:2,label:"Mar"},{value:3,label:"MiÃ©"},{value:4,label:"Jue"},{value:5,label:"Vie"},{value:6,label:"SÃ¡b"},{value:7,label:"Dom"}],g=Array.from({length:7},(f,S)=>{const o=S+6;return{value:`${o.toString().padStart(2,"0")}:00`,label:`${o}:00`}}),h=(()=>{if(!m||N.length===0)return null;const f=new Date,[S,o]=r.split(":").map(Number);for(let C=0;C<8;C++){const F=new Date(f);F.setDate(F.getDate()+C),F.setHours(S,o,0,0);const b=F.getDay()===0?7:F.getDay();if(N.includes(b)&&F>f)return F.toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long",hour:"2-digit",minute:"2-digit"})}return null})();return t?e.jsxs(de,{children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-5 w-5"}),"NotificaciÃ³n Diaria Matutina"]})}),e.jsx(me,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Cargando configuraciÃ³n..."})})]}):e.jsxs(de,{children:[e.jsxs(ue,{children:[e.jsxs(xe,{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-5 w-5"}),"NotificaciÃ³n Diaria Matutina"]}),e.jsx(ve,{children:"EnvÃ­a un resumen automÃ¡tico cada maÃ±ana con el estado del personal del dÃ­a (trabajos, almacÃ©n, vacaciones, etc.)"})]}),e.jsxs(me,{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(P,{htmlFor:"schedule-enabled",className:"text-base",children:"Activar notificaciÃ³n diaria"}),e.jsx(is,{id:"schedule-enabled",checked:m,onCheckedChange:c})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"schedule-time",className:"text-sm font-medium",children:"Hora de envÃ­o"}),e.jsxs(Z,{value:r,onValueChange:n,disabled:!m,children:[e.jsx(X,{id:"schedule-time",className:"w-full",children:e.jsx(ee,{})}),e.jsx(se,{children:g.map(f=>e.jsx(M,{value:f.value,children:f.label},f.value))})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Hora de EspaÃ±a (Europe/Madrid, UTC+1/+2)"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(P,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(ta,{className:"h-4 w-4"}),"DÃ­as de la semana"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:v.map(f=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(z,{id:`day-${f.value}`,checked:N.includes(f.value),onCheckedChange:()=>_(f.value),disabled:!m}),e.jsx(P,{htmlFor:`day-${f.value}`,className:"text-sm font-normal cursor-pointer",children:f.label})]},f.value))})]}),m&&h&&e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-md",children:[e.jsx(Be,{className:"h-5 w-5 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium text-blue-900 dark:text-blue-100",children:"PrÃ³ximo envÃ­o programado:"}),e.jsx("p",{className:"text-blue-700 dark:text-blue-300 capitalize",children:h})]})]}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-muted rounded-md",children:[e.jsx(Be,{className:"h-5 w-5 text-muted-foreground mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-muted-foreground space-y-1",children:[e.jsxs("p",{children:["Los usuarios (management, admin, house tech) pueden suscribirse individualmente en la secciÃ³n ",e.jsx("strong",{children:'"Mi SuscripciÃ³n al Resumen Diario"'})," mÃ¡s abajo."]}),e.jsx("p",{children:"Cada usuario elige quÃ© departamentos quiere recibir y puede ver mÃºltiples departamentos en un solo resumen."})]})]}),(s==null?void 0:s.last_sent_at)&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Ãšltimo envÃ­o: ",new Date(s.last_sent_at).toLocaleString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})]}),e.jsx(k,{onClick:D,disabled:w||!m&&!(s!=null&&s.enabled),className:"w-full",children:w?"Guardando...":"Guardar cambios"})]})]})}function Da({currentKeybind:s,onSave:t,onCancel:d}){const[w,m]=i.useState(!1),[c,r]=i.useState(""),n=i.useRef(null);i.useEffect(()=>{w&&n.current&&n.current.focus()},[w]);const N=v=>{if(!w||(v.preventDefault(),v.stopPropagation(),["Control","Shift","Alt","Meta"].includes(v.key)))return;const g=[];(v.ctrlKey||v.metaKey)&&g.push("Ctrl"),v.shiftKey&&g.push("Shift"),v.altKey&&g.push("Alt");let l=v.key;l===" "&&(l="Space"),l.length===1&&(l=l.toUpperCase()),g.push(l);const h=g.join("+");r(h)},x=()=>{m(!0),r("")},D=()=>{c&&(t(c),m(!1),r(""))},_=()=>{m(!1),r(""),d==null||d()};return w?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{ref:n,type:"text",value:c||"Press keys...",onKeyDown:N,readOnly:!0,className:"flex-1 font-mono text-sm",placeholder:"Press a key combination"}),e.jsxs(k,{size:"sm",variant:"default",onClick:D,disabled:!c,children:[e.jsx(js,{className:"h-3 w-3 mr-1"}),"Save"]}),e.jsx(k,{size:"sm",variant:"ghost",onClick:_,children:e.jsx(De,{className:"h-3 w-3"})})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1",children:s?e.jsx("kbd",{className:"px-2 py-1 bg-muted rounded text-sm font-mono border",children:s}):e.jsx("span",{className:"text-sm text-muted-foreground italic",children:"No keybind"})}),e.jsxs(k,{size:"sm",variant:"outline",onClick:x,children:[e.jsx(ia,{className:"h-3 w-3 mr-1"}),"Edit"]}),s&&e.jsx(k,{size:"sm",variant:"ghost",onClick:()=>t(""),title:"Clear keybind",children:e.jsx(De,{className:"h-3 w-3"})})]})}const Fa={navigation:e.jsx(ds,{className:"h-4 w-4"}),"job-card":e.jsx(rs,{className:"h-4 w-4"}),matrix:e.jsx(os,{className:"h-4 w-4"}),global:e.jsx(cs,{className:"h-4 w-4"})},Aa={navigation:"NavegaciÃ³n","job-card":"Acciones de Trabajo",matrix:"Matriz",global:"Global"};function Ea(){const{getAllShortcuts:s,getShortcutsByCategory:t,updateKeybind:d,enableShortcut:w,disableShortcut:m,exportConfig:c,importConfig:r}=vs(),[n,N]=i.useState(""),[x,D]=i.useState("all"),[_,v]=i.useState(!1);bs.useEffect(()=>{const o=Le();v(o.getConnectionStatus());const C=setInterval(()=>{v(o.getConnectionStatus())},2e3);return()=>clearInterval(C)},[]);const g=i.useMemo(()=>{let o=x==="all"?s():t(x);if(n){const C=n.toLowerCase();o=o.filter(F=>{var b;return F.label.toLowerCase().includes(C)||((b=F.description)==null?void 0:b.toLowerCase().includes(C))||F.id.toLowerCase().includes(C)})}return o.sort((C,F)=>C.label.localeCompare(F.label))},[n,x,s,t]),l=()=>{const o=c(),C=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),F=URL.createObjectURL(C),b=document.createElement("a");b.href=F,b.download="shortcuts-config.json",b.click(),URL.revokeObjectURL(F),ge.success("ConfiguraciÃ³n exportada",{description:"Archivo descargado: shortcuts-config.json"})},h=()=>{const o=document.createElement("input");o.type="file",o.accept="application/json",o.onchange=async C=>{var b;const F=(b=C.target.files)==null?void 0:b[0];if(F)try{const O=await F.text(),B=JSON.parse(O);r(B),ge.success("ConfiguraciÃ³n importada",{description:"Los atajos han sido actualizados"})}catch{ge.error("Error al importar",{description:"El archivo no es vÃ¡lido"})}},o.click()},f=()=>{Le().connect(),ge.info("Reconectando...",{description:"Intentando conectar con Stream Deck"})},S=i.useMemo(()=>({all:s().length,navigation:t("navigation").length,"job-card":t("job-card").length,matrix:t("matrix").length,global:t("global").length}),[s,t]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(ae,{variant:_?"default":"destructive",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[_?e.jsx(la,{className:"h-4 w-4"}):e.jsx(ra,{className:"h-4 w-4"}),e.jsxs(he,{children:["Stream Deck: ",_?"Conectado":"Desconectado"]})]}),e.jsx(te,{children:_?"El WebSocket estÃ¡ activo. Los botones del Stream Deck funcionarÃ¡n correctamente.":e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("span",{children:"No se pudo conectar a ws://localhost:3001. AsegÃºrate de que el servidor WebSocket estÃ¡ ejecutÃ¡ndose."}),e.jsxs(k,{size:"sm",variant:"outline",onClick:f,className:"w-fit",children:[e.jsx(Ge,{className:"h-3 w-3 mr-1"}),"Reconectar"]})]})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsx(xa,{className:"inline h-4 w-4 mr-1"}),"Gestiona los atajos de teclado y botones de Stream Deck"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(k,{size:"sm",variant:"outline",onClick:l,children:[e.jsx(Xe,{className:"h-3 w-3 mr-1"}),"Exportar"]}),e.jsxs(k,{size:"sm",variant:"outline",onClick:h,children:[e.jsx(ls,{className:"h-3 w-3 mr-1"}),"Importar"]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(oa,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx($,{type:"text",placeholder:"Buscar atajos...",value:n,onChange:o=>N(o.target.value),className:"pl-9"})]}),e.jsx(es,{value:x,onValueChange:o=>D(o),children:e.jsxs(ss,{className:"w-full grid grid-cols-5 gap-1",children:[e.jsxs(oe,{value:"all",className:"text-xs",children:["Todos (",S.all,")"]}),e.jsxs(oe,{value:"navigation",className:"text-xs",children:[e.jsx(ds,{className:"h-3 w-3 mr-1"}),"(",S.navigation,")"]}),e.jsxs(oe,{value:"job-card",className:"text-xs",children:[e.jsx(rs,{className:"h-3 w-3 mr-1"}),"(",S["job-card"],")"]}),e.jsxs(oe,{value:"matrix",className:"text-xs",children:[e.jsx(os,{className:"h-3 w-3 mr-1"}),"(",S.matrix,")"]}),e.jsxs(oe,{value:"global",className:"text-xs",children:[e.jsx(cs,{className:"h-3 w-3 mr-1"}),"(",S.global,")"]})]})})]}),e.jsx("div",{className:"space-y-2",children:g.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No se encontraron atajos"}):g.map(o=>e.jsx("div",{className:"border rounded-lg p-4 hover:bg-accent/50 transition-colors",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"mt-1",children:Fa[o.category]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-medium text-sm",children:o.label}),e.jsx(pe,{variant:"outline",className:"text-xs",children:Aa[o.category]}),o.requiresSelection&&e.jsx(pe,{variant:"secondary",className:"text-xs",children:"Requiere selecciÃ³n"})]}),o.description&&e.jsx("p",{className:"text-xs text-muted-foreground mb-3",children:o.description}),e.jsx(Da,{currentKeybind:o.customKeybind||o.defaultKeybind,onSave:C=>d(o.id,C)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:o.enabled?"Activo":"Inactivo"}),e.jsx(is,{checked:o.enabled,onCheckedChange:C=>{C?w(o.id):m(o.id)}})]})]})},o.id))}),e.jsxs("div",{className:"text-xs text-muted-foreground text-center pt-4 border-t",children:["Mostrando ",g.length," de ",S.all," atajos totales"]})]})}function Ta(){const[s,t]=i.useState([]),[d,w]=i.useState(!0),[m,c]=i.useState(!1),[r,n]=i.useState(""),[N,x]=i.useState(null),D=new Date().getFullYear(),_=[D,D+1];i.useEffect(()=>{v()},[]);async function v(){w(!0),x(null);try{const h=await ca();t(h);const f=new Set(h.map(o=>o.year)),S=_.find(o=>!f.has(o));S?n(String(S)):_.length>0&&n(String(_[0]))}catch{x("Failed to load folder statuses")}finally{w(!1)}}async function g(){if(!r)return;const h=parseInt(r,10),f=s.find(S=>S.year===h);if(f&&f.sound===12&&f.lights===12){q({title:"Folders already exist",description:`Dryhire folders for ${h} have already been created.`,variant:"destructive"});return}c(!0),x(null);try{await da(h),q({title:"Folders created",description:`Successfully created dryhire folders for ${h}.`}),await v()}catch(S){const o=S instanceof Error?S.message:"Unknown error";x(`Failed to create folders: ${o}`),q({title:"Failed to create folders",description:o,variant:"destructive"})}finally{c(!1)}}const l=h=>{const f=s.find(S=>S.year===h);return f&&f.sound===12&&f.lights===12};return d?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(ce,{className:"h-4 w-4 animate-spin"}),"Loading folder status..."]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Manage Flex folders for dry hire jobs. Each year needs a set of monthly folders for Sound and Lights departments."}),s.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-sm font-medium",children:"Existing years"}),e.jsx("div",{className:"space-y-1",children:s.map(h=>e.jsxs("div",{className:"flex items-center gap-3 text-sm p-2 bg-muted/50 rounded",children:[e.jsx("span",{className:"font-medium w-12",children:h.year}),e.jsxs("div",{className:"flex items-center gap-1",children:[h.sound===12?e.jsx(Ve,{className:"h-4 w-4 text-green-600"}):e.jsx(We,{className:"h-4 w-4 text-red-500"}),e.jsxs("span",{children:["Sound (",h.sound,"/12)"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[h.lights===12?e.jsx(Ve,{className:"h-4 w-4 text-green-600"}):e.jsx(We,{className:"h-4 w-4 text-red-500"}),e.jsxs("span",{children:["Lights (",h.lights,"/12)"]})]})]},h.year))})]}),e.jsxs("div",{className:"space-y-3 pt-2",children:[e.jsx("h4",{className:"text-sm font-medium",children:"Create folders for new year"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs(Z,{value:r,onValueChange:n,children:[e.jsx(X,{className:"w-full sm:w-32",children:e.jsx(ee,{placeholder:"Year"})}),e.jsx(se,{children:_.map(h=>e.jsxs(M,{value:String(h),disabled:l(h),children:[h," ",l(h)&&"(created)"]},h))})]}),e.jsx(k,{onClick:g,disabled:m||!r||l(parseInt(r,10)),className:"w-full sm:w-auto",children:m?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"mr-2 h-4 w-4 animate-spin"}),"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ma,{className:"mr-2 h-4 w-4"}),"Create Dry Hire Folders"]})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"This will create 2 main folders (Sound + Lights) with 12 monthly subfolders each in Flex."})]}),N&&e.jsxs(ae,{variant:"destructive",children:[e.jsx(he,{children:"Error"}),e.jsx(te,{children:N})]})]})}function Ia(){const[s,t]=i.useState({hasController:!1,registration:!1,buildVersion:"2026-01-09T10:30:18.965Z",buildTimestamp:1767954618965});i.useEffect(()=>{const w=async()=>{var r,n;const m=!!((r=navigator.serviceWorker)!=null&&r.controller),c=await((n=navigator.serviceWorker)==null?void 0:n.getRegistration("/"));t(N=>({...N,hasController:m,registration:!!c,lastUpdateCheck:new Date().toLocaleTimeString()}))};if("serviceWorker"in navigator)return w(),navigator.serviceWorker.addEventListener("controllerchange",w),()=>{navigator.serviceWorker.removeEventListener("controllerchange",w)}},[]);const d=s.buildTimestamp!=="N/A"?new Date(parseInt(s.buildTimestamp)).toLocaleString():"N/A";return e.jsx(de,{className:"max-w-md",children:e.jsxs(me,{className:"pt-6 space-y-2 text-sm",children:[e.jsx("div",{className:"font-semibold text-base mb-3",children:"App Version Info"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("div",{className:"text-muted-foreground",children:"Build Version:"}),e.jsx("div",{className:"font-mono text-xs",children:s.buildVersion.slice(0,19)}),e.jsx("div",{className:"text-muted-foreground",children:"Build Date:"}),e.jsx("div",{className:"text-xs",children:d}),e.jsx("div",{className:"text-muted-foreground",children:"SW Registered:"}),e.jsx("div",{className:s.registration?"text-green-600":"text-red-600",children:s.registration?"âœ“ Yes":"âœ— No"}),e.jsx("div",{className:"text-muted-foreground",children:"SW Active:"}),e.jsx("div",{className:s.hasController?"text-green-600":"text-red-600",children:s.hasController?"âœ“ Yes":"âœ— No"}),s.lastUpdateCheck&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-muted-foreground",children:"Last Check:"}),e.jsx("div",{className:"text-xs",children:s.lastUpdateCheck})]})]}),e.jsx("div",{className:"pt-2 text-xs text-muted-foreground border-t mt-3",children:"Refresh this page after deployment to verify new version"})]})})}const G=({id:s,title:t,description:d,children:w,defaultOpen:m=!1,isOpen:c,onOpenChange:r})=>{const n=c??m;return e.jsx(as,{open:n,onOpenChange:r,className:"border rounded-lg",children:e.jsxs(de,{className:"border-none shadow-none",children:[e.jsxs(ue,{className:"flex flex-row items-start justify-between gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(xe,{children:t}),d&&e.jsx(ve,{children:d})]}),e.jsx(ts,{asChild:!0,children:e.jsxs("button",{className:"rounded-md border px-2 py-1 text-sm text-muted-foreground hover:bg-muted flex items-center gap-1",children:[e.jsx(Qe,{className:"h-4 w-4 transition-transform duration-200 data-[state=open]:rotate-180"}),"Toggle"]})})]}),e.jsx(ns,{children:e.jsx(me,{className:"pt-0",children:w})})]})})},$t=()=>{const s=ys(),[t,d]=i.useState(!1),[w,m]=i.useState(!1),[c,r]=i.useState(""),[n,N]=i.useState("all"),[x,D]=i.useState("all"),[_,v]=i.useState("sound"),{userRole:g,isLoading:l}=Ae(),h=["admin","management"].includes(g||"");i.useEffect(()=>{if(!l&&g&&!["admin","management"].includes(g)){const E=Ns(g);s(E,{replace:!0})}},[g,l,s]);const{isSupported:f,permission:S,subscription:o,isInitializing:C,isEnabling:F,isDisabling:b,error:O,enable:B,disable:y,canEnable:j}=Rs(),T=S==="granted"?"Granted":S==="denied"?"Blocked":"Not requested",a=!!o,p=j&&!C,I=S==="denied",V=()=>{r(""),N("all"),D("all")},u=async()=>{var E;try{const{data:L,error:Re}=await H.functions.invoke("push",{body:{action:"test",url:"/settings"}});if(Re)throw Re;const Ue=L;Ue.status==="sent"?((E=Ue.results)==null?void 0:E.every(xs=>xs.skipped))?q({title:"Test notification skipped",description:"Push notifications are configured but the server doesn't have VAPID keys set up yet.",variant:"destructive"}):q({title:"Test notification sent",description:"Check your device for the notification!"}):q({title:"No subscriptions found",description:"Enable push notifications first before testing.",variant:"destructive"})}catch(L){q({title:"Failed to send test",description:L instanceof Error?L.message:"Unknown error",variant:"destructive"})}},A=async()=>{try{q({title:"Background test scheduled",description:"Press Home now. A test push will be sent in 5 seconds."}),setTimeout(async()=>{try{const{error:E}=await H.functions.invoke("push",{body:{action:"test",url:"/settings"}});if(E)throw E}catch{}},5e3)}catch{}},{events:R,showLocalTest:W,getSubscriptionInfo:U}=Ca(),[ne,ie]=i.useState(null);i.useEffect(()=>{(async()=>ie(await U()))()},[o]);const[J,Y]=i.useState({"push-notifications":!1,"push-diagnostics":!1,"push-matrix":!1,"push-schedule":!1,"morning-summary":!1,shortcuts:!1,users:!1,"company-settings":!1,"equipment-models":!1,"dryhire-folders":!1,"version-info":!1});return e.jsx("div",{className:"min-h-screen bg-background text-foreground",children:e.jsxs("div",{className:"mx-auto w-full max-w-full px-4 sm:px-6 lg:px-8 py-4 space-y-4 md:space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:justify-between md:items-center",children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Settings"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(k,{onClick:()=>m(!0),variant:"outline",className:"w-full sm:w-auto",children:[e.jsx(ls,{className:"mr-2 h-4 w-4"}),"Import Users"]}),e.jsxs(k,{onClick:()=>d(!0),className:"w-full sm:w-auto",children:[e.jsx(ws,{className:"mr-2 h-4 w-4"}),"Add User"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-4 md:gap-6 auto-rows-fr",children:[e.jsxs("div",{className:"space-y-4 md:space-y-6",children:[e.jsx(G,{id:"push-notifications",title:"Push notifications",description:"Get real-time updates about jobs, assignments, and documents directly on your device.",isOpen:J["push-notifications"],onOpenChange:E=>Y(L=>({...L,"push-notifications":E})),children:f?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Permission:"})," ",T]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Subscription:"})," ",a?"Active on this device":"Not active yet"]})]}),C&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Checking your device for an existing subscriptionâ€¦"}),O&&e.jsxs(ae,{variant:"destructive",children:[e.jsx(he,{children:"Notification error"}),e.jsx(te,{children:O})]}),I&&e.jsxs(ae,{variant:"info",children:[e.jsx(he,{children:"Notifications blocked"}),e.jsx(te,{children:"Enable notifications from your browser settings and reload the page to subscribe."})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsx(k,{onClick:()=>{B().catch(()=>{})},disabled:!p||F,className:"w-full",children:F?"Enablingâ€¦":"Enable push"}),e.jsx(k,{variant:"outline",onClick:()=>{y().catch(()=>{})},disabled:!a||b||C,className:"w-full",children:b?"Disablingâ€¦":"Disable push"}),e.jsxs(k,{variant:"secondary",onClick:u,disabled:!a||C,className:"w-full",children:[e.jsx(ha,{className:"mr-2 h-4 w-4"}),"Send Test"]}),e.jsx(k,{variant:"secondary",onClick:A,disabled:!a||C,title:"Schedules a test push in 5s so you can background the app",className:"w-full",children:"Background test (5s)"})]})]}):e.jsxs(ae,{variant:"info",children:[e.jsx(he,{children:"Unsupported browser"}),e.jsx(te,{children:"Your current browser does not support web push. Try using the latest version of Chrome, Edge, or Safari."})]})}),f&&e.jsxs(G,{id:"push-diagnostics",title:"Push diagnostics",description:"Useful when you can't access Safari's Web Inspector.",isOpen:J["push-diagnostics"],onOpenChange:E=>Y(L=>({...L,"push-diagnostics":E})),children:[e.jsxs("div",{className:"text-sm space-y-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Permission:"})," ",T]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Has subscription:"})," ",a?"Yes":"No"]}),(ne==null?void 0:ne.endpoint)&&e.jsxs("p",{className:"break-words",children:[e.jsx("span",{className:"font-medium",children:"Endpoint:"})," ",String(ne.endpoint).slice(0,64),"â€¦"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 mt-3",children:[e.jsx(k,{variant:"secondary",onClick:()=>void W(),disabled:S!=="granted",className:"w-full sm:w-auto",children:"Show local SW test"}),e.jsx(k,{variant:"outline",onClick:async()=>ie(await U()),className:"w-full sm:w-auto",children:"Refresh subscription info"})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-3",children:[e.jsx("p",{className:"font-medium mb-1",children:"Recent SW events"}),R.length===0?e.jsx("p",{children:"No events yet. Try Send Test or Local SW test."}):e.jsx("ul",{className:"space-y-1 max-h-40 overflow-auto border rounded p-2 bg-muted/30",children:R.slice().reverse().map((E,L)=>e.jsxs("li",{className:"font-mono",children:[new Date(E.ts).toLocaleTimeString()," â€” ",E.type]},L))})]})]}),h&&e.jsx(G,{id:"push-matrix",title:"Push notification matrix",isOpen:J["push-matrix"],onOpenChange:E=>Y(L=>({...L,"push-matrix":E})),children:e.jsx(Sa,{})}),h&&e.jsx(G,{id:"push-schedule",title:"Push notification schedule",isOpen:J["push-schedule"],onOpenChange:E=>Y(L=>({...L,"push-schedule":E})),children:e.jsx(_a,{})}),e.jsx(G,{id:"shortcuts",title:"Keyboard shortcuts & Stream Deck",description:"Manage keyboard shortcuts and Stream Deck button integration",isOpen:J.shortcuts,onOpenChange:E=>Y(L=>({...L,shortcuts:E})),children:e.jsx(Ea,{})})]}),e.jsxs("div",{className:"space-y-4 md:space-y-6",children:[e.jsx(G,{id:"morning-summary",title:"Morning summary",isOpen:J["morning-summary"],onOpenChange:E=>Y(L=>({...L,"morning-summary":E})),children:e.jsx(na,{})}),e.jsxs(G,{id:"users",title:"Users",isOpen:J.users,onOpenChange:E=>Y(L=>({...L,users:E})),children:[e.jsx(ja,{searchQuery:c,onSearchChange:r,selectedRole:n,onRoleChange:N,selectedDepartment:x,onDepartmentChange:D,onClearFilters:V}),e.jsx(ga,{searchQuery:c,roleFilter:n==="all"?"":n,departmentFilter:x==="all"?"":x,isManagementUser:h})]}),e.jsx(G,{id:"company-settings",title:"Company settings",isOpen:J["company-settings"],onOpenChange:E=>Y(L=>({...L,"company-settings":E})),children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-sm font-medium",children:"Company Logo"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Upload your company logo. This will be used in the Memoria TÃ©cnica PDFs and other documents."}),e.jsx(ba,{})]})}),h&&e.jsx(G,{id:"equipment-models",title:"Equipment models",isOpen:J["equipment-models"],onOpenChange:E=>Y(L=>({...L,"equipment-models":E})),children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Manage equipment models used in festival forms and gear setup."}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Department"}),e.jsxs("select",{className:"border rounded px-3 py-2 text-sm min-w-[120px]",value:_,onChange:E=>v(E.target.value),children:[e.jsx("option",{value:"sound",children:"Sound"}),e.jsx("option",{value:"lights",children:"Lights"}),e.jsx("option",{value:"video",children:"Video"})]})]})]}),e.jsx(Gs,{department:_,children:e.jsx(wa,{})})]})}),h&&e.jsx(G,{id:"dryhire-folders",title:"Dry hire folders",description:"Manage Flex folder structure for dry hire jobs",isOpen:J["dryhire-folders"],onOpenChange:E=>Y(L=>({...L,"dryhire-folders":E})),children:e.jsx(Ta,{})}),e.jsx(G,{id:"version-info",title:"Version info",description:"Build and service worker version details for testing updates.",isOpen:J["version-info"],onOpenChange:E=>Y(L=>({...L,"version-info":E})),children:e.jsx(Ia,{})})]})]}),e.jsx(Cs,{open:t,onOpenChange:d}),e.jsx(va,{open:w,onOpenChange:m})]})})};export{$t as default};
