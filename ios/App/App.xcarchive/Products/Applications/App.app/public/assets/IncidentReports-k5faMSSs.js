import{e as B,f as I,m as x,r as p,c as L,s as w,j as e,B as v,a4 as M,C as E,W as T,Y as k,$ as q,A as S,I as U,i as F,V as z}from"./index-NZ6jJLfQ.js";import{B as $}from"./badge-vNTKF5RD.js";import{A as H,h as P,a as V,b as K,c as O,d as Q,e as W,f as G,g as Y}from"./alert-dialog-CtyYUxwH.js";import{u as J}from"./useQuery-kdg2pmgf.js";import{u as X}from"./useMutation-DluhVBs1.js";import{u as Z}from"./useAppBadgeSource-megIXC92.js";import{C as ee}from"./clipboard-list-wtFE30Ps.js";import{F as N}from"./file-text-igU140SQ.js";import{S as te}from"./search-D-OiWg8h.js";import{F as se}from"./filter-D0HnK7Nz.js";import{C as ae}from"./calendar-_Cj_Sgy-.js";import{D as re}from"./download-C1rVE0-J.js";import{e as A}from"./es-CSiFCUGj.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";const ie=()=>{const{toast:d}=B(),j=I(),{data:g=[],isLoading:_,error:u}=J({queryKey:["incident-reports"],queryFn:async()=>{const{data:i,error:o}=await x.from("job_documents").select(`
          *,
          job:jobs(id, title, start_time, end_time)
        `).like("file_path","incident-reports/%").order("uploaded_at",{ascending:!1});if(o)throw o;const r=[...new Set(i.map(s=>s.uploaded_by).filter(Boolean))],{data:n}=await x.from("profiles").select("id, first_name, last_name").in("id",r);return i.map(s=>({...s,uploaded_by_profile:(n==null?void 0:n.find(c=>c.id===s.uploaded_by))||null}))}}),f=X({mutationFn:async i=>{const o=g.find(m=>m.id===i);if(!o)throw new Error("Report not found");const{error:r}=await x.storage.from("job-documents").remove([o.file_path]);if(r)throw r;const{error:n}=await x.from("job_documents").delete().eq("id",i);if(n)throw n},onSuccess:(i,o)=>{try{const r=g.find(n=>n.id===o);r&&x.functions.invoke("push",{body:{action:"broadcast",type:"document.deleted",job_id:r.job_id,file_name:r.file_name}})}catch{}j.invalidateQueries({queryKey:["incident-reports"]}),d({title:"Reporte eliminado",description:"El reporte de incidencia ha sido eliminado correctamente."})},onError:i=>{d({title:"Error",description:"No se pudo eliminar el reporte de incidencia.",variant:"destructive"})}}),b=async i=>{try{const{data:o,error:r}=await x.storage.from("job-documents").download(i.file_path);if(r)throw r;const n=new Blob([o],{type:"application/pdf"}),m=URL.createObjectURL(n),s=document.createElement("a");s.href=m,s.download=i.file_name,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(m),d({title:"Descarga iniciada",description:"El reporte de incidencia se está descargando."})}catch{d({title:"Error",description:"No se pudo descargar el reporte de incidencia.",variant:"destructive"})}};return{reports:g,isLoading:_,error:u,deleteReport:f.mutate,isDeleting:f.isPending,downloadReport:b}},oe=({userRole:d,lastReadTimestamp:j})=>{const[g,_]=p.useState(!1),[u,f]=p.useState(0),[b,i]=p.useState(!1),o=L(),r=p.useCallback(async()=>{if(!b)try{if(i(!0),!["management","admin"].includes(d))return;let s=w.from("job_documents").select("id, uploaded_at").like("file_path","incident-reports/%");if(j)s=s.gt("uploaded_at",j);else{const a=new Date;a.setDate(a.getDate()-1),s=s.gt("uploaded_at",a.toISOString())}const{data:c,error:y}=await s.limit(50);if(y)return;const t=(c==null?void 0:c.length)||0;f(t),_(t>0)}catch{}finally{i(!1)}},[d,j,b]);p.useEffect(()=>{const s=setTimeout(()=>{r()},1e3),c=w.channel("incident-reports-notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"job_documents",filter:"file_path=like.incident-reports/*"},y=>{setTimeout(r,500)}).subscribe(y=>{});return()=>{clearTimeout(s),w.removeChannel(c)}},[r]);const n=()=>{o("/incident-reports"),_(!1),f(0)},m=["management","admin"].includes(d);return Z("incident-reports",{count:u,enabled:m&&u>0}),!m||!g?null:e.jsxs(v,{variant:"ghost",className:"w-full justify-start gap-2 text-orange-500 relative",onClick:n,disabled:b,children:[e.jsx(ee,{className:"h-4 w-4"}),e.jsx("span",{children:"New Incident Reports"}),u>0&&e.jsx("span",{className:"absolute right-2 top-1/2 -translate-y-1/2 bg-orange-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center",children:u>9?"9+":u})]})},ne=()=>{const{reports:d,isLoading:j,deleteReport:g,isDeleting:_,downloadReport:u}=ie(),[f,b]=p.useState(""),[i,o]=p.useState("uploaded_at"),[r,n]=p.useState("desc"),[m,s]=p.useState("");M.useEffect(()=>{(async()=>{const{data:{user:a}}=await x.auth.getUser();if(a){const{data:l}=await x.from("profiles").select("role").eq("id",a.id).single();l&&s(l.role)}})()},[]);const c=d.filter(t=>{var l,h,C,R,D;const a=f.toLowerCase();return t.file_name.toLowerCase().includes(a)||((l=t.job)==null?void 0:l.title.toLowerCase().includes(a))||((C=(h=t.uploaded_by_profile)==null?void 0:h.first_name)==null?void 0:C.toLowerCase().includes(a))||((D=(R=t.uploaded_by_profile)==null?void 0:R.last_name)==null?void 0:D.toLowerCase().includes(a))}).sort((t,a)=>{const l=t[i],h=a[i];return r==="asc"?l>h?1:-1:l<h?1:-1}),y=t=>{if(t===0)return"0 Bytes";const a=1024,l=["Bytes","KB","MB","GB"],h=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,h)).toFixed(2))+" "+l[h]};return j?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx("div",{className:"text-muted-foreground",children:"Cargando reportes de incidencias..."})}):e.jsx("div",{className:"space-y-6",children:e.jsxs(E,{children:[e.jsx(T,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(N,{className:"h-5 w-5"}),"Incident Reports Management"]}),e.jsx(q,{children:"View, download, and manage incident reports from all jobs"})]}),e.jsx(oe,{userRole:m})]})}),e.jsxs(S,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(te,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(U,{placeholder:"Buscar por nombre de archivo, trabajo o técnico...",value:f,onChange:t=>b(t.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(v,{variant:"outline",size:"sm",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Filtros"]}),e.jsxs(v,{variant:"outline",size:"sm",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Fechas"]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:c.length===0?e.jsxs("div",{className:"col-span-full text-center py-8 text-muted-foreground",children:[e.jsx(N,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No se encontraron reportes de incidencias"}),f&&e.jsx("p",{className:"text-sm",children:"Intenta con otros términos de búsqueda"})]}):c.map(t=>{var a,l;return e.jsx(E,{className:"hover:bg-muted/50 transition-colors flex flex-col",children:e.jsxs(S,{className:"pt-6 flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-start gap-2 mb-3",children:[e.jsx(N,{className:"h-4 w-4 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-medium text-sm truncate",title:t.file_name,children:t.file_name}),e.jsx($,{variant:"secondary",className:"text-xs mt-1",children:"PDF"})]})]}),e.jsxs("div",{className:"space-y-2 text-sm text-muted-foreground mb-3 flex-1",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"text-foreground",children:"Trabajo:"}),e.jsx("div",{className:"truncate",title:(a=t.job)==null?void 0:a.title,children:((l=t.job)==null?void 0:l.title)||"N/A"})]}),e.jsxs("div",{children:[e.jsx("strong",{className:"text-foreground",children:"Técnico:"}),e.jsx("div",{className:"truncate",title:t.uploaded_by_profile?`${t.uploaded_by_profile.first_name} ${t.uploaded_by_profile.last_name}`:"N/A",children:t.uploaded_by_profile?`${t.uploaded_by_profile.first_name} ${t.uploaded_by_profile.last_name}`:"N/A"})]}),e.jsxs("div",{children:[e.jsx("strong",{className:"text-foreground",children:"Fecha:"}),e.jsx("div",{children:F(new Date(t.uploaded_at),"dd/MM/yyyy HH:mm",{locale:A})})]})]}),e.jsxs("div",{className:"space-y-1 text-xs text-muted-foreground border-t pt-3 mb-3",children:[e.jsxs("div",{children:["Tamaño: ",y(t.file_size)]}),t.job&&e.jsxs("div",{children:["Trabajo: ",F(new Date(t.job.start_time),"dd/MM/yyyy",{locale:A})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>u(t),className:"flex-1",children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Descargar"]}),e.jsxs(H,{children:[e.jsx(P,{asChild:!0,children:e.jsx(v,{variant:"outline",size:"sm",disabled:_,children:e.jsx(z,{className:"h-4 w-4"})})}),e.jsxs(V,{children:[e.jsxs(K,{children:[e.jsx(O,{children:"¿Eliminar reporte?"}),e.jsxs(Q,{children:['Esta acción no se puede deshacer. El reporte "',t.file_name,'" será eliminado permanentemente del sistema.']})]}),e.jsxs(W,{children:[e.jsx(G,{children:"Cancelar"}),e.jsx(Y,{onClick:()=>g(t.id),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Eliminar"})]})]})]})]})]})},t.id)})}),c.length>0&&e.jsxs("div",{className:"mt-6 text-sm text-muted-foreground text-center",children:["Mostrando ",c.length," de ",d.length," reportes"]})]})]})})},we=()=>e.jsx("div",{className:"w-full px-4 sm:px-6 py-4",children:e.jsx(ne,{})});export{we as default};
