import{c as Ne,e as be,b as ve,r as ee,a4 as we,j as e,C as ke,W as ye,Y as De,B as P,L as A,S as se,t as te,v as ne,w as ae,x as ie,A as Ce,I as z,V as oe,s as Se}from"./index-NZ6jJLfQ.js";import{B as ce}from"./badge-vNTKF5RD.js";import{C as Pe}from"./checkbox-BsRNEGV1.js";import{e as Ae}from"./pdfExport-DjZPdCcG.js";import{u as Le}from"./useJobSelection-B9iLNF5-.js";import{F as Te}from"./file-text-igU140SQ.js";import{P as de}from"./plus-C3JQqq7t.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./lazyPdf-xVUlxKNu.js";import"./useQuery-kdg2pmgf.js";const O=[{id:"H30V-8",name:"Prolyte H30V (8 m)",lengthM:8,selfWeightKgPerM:8.2,EI:32e8,allowableM_Nm:9500,allowableDeflectionM:8/200},{id:"52x52-10",name:"52x52 (10 m)",lengthM:10,selfWeightKgPerM:7.5,EI:46e8,allowableM_Nm:12e3,allowableDeflectionM:10/200}],Ke=[{id:"cm500",name:"CM 500 kg D8+",WLL_kg:500,selfWeightKg:50},{id:"cm750",name:"Chainmaster 750 kg D8+",WLL_kg:750,selfWeightKg:69},{id:"cm1000",name:"CM 1000 kg D8+",WLL_kg:1e3,selfWeightKg:70},{id:"cm2000",name:"CM 2000 kg D8+",WLL_kg:2e3,selfWeightKg:75}];function Ee(a,t,n){const r=t.g??9.81,p=t.dynamicFactor,d=Math.max(8,n.nElements),o=a.lengthM,h=a.EI;if(h<=0)throw new Error("Truss EI must be > 0 (from datasheet).");const j=d+1,f=Array.from({length:j},(u,b)=>o*b/d),M=2*j,C=fe(M,M),L=me(M),v=0;for(let u=0;u<d;u++){const b=f[u],S=f[u+1],W=S-b,Q=ge(h,W),Y=a.selfWeightKgPerM*r+v,Z=je(Y,W),q=2*u,le=q+2;Fe(C,Q,q,le),Ie(L,Z,q,le)}for(const u of t.fixtures){const b=u.qty*u.weightKg*r*p,S=ue(f,u.x);L[2*S]-=b}const R=n.supports.map(u=>ue(f,u.x)),$=n.supports.map((u,b)=>u.label??`H${b+1}`),_=(n.tiltDeg??0)*Math.PI/180,B=f[R[0]],U=u=>Math.tan(_)*(u-B),y=[],F=[];for(const u of R)y.push(2*u),F.push(U(f[u]));const s=Array.from({length:M},(u,b)=>b),g=new Set(y),i=s.filter(u=>!g.has(u)),l=X(C,i,i),c=X(C,i,y),m=X(C,y,i),x=X(C,y,y),N=xe(L,i),T=xe(L,y),I=he(N,J(c,F)),H=_e(l,I),V=he(We(J(m,H),J(x,F)),T),k=me(M);i.forEach((u,b)=>k[u]=H[b]),y.forEach((u,b)=>k[u]=F[b]);let K=0,w=0;const D=[];for(let u=0;u<d;u++){const b=f[u+1]-f[u],S=2*u,W=S+2,Q=[k[S],k[S+1],k[W],k[W+1]];D.push(k[S]);const Y=a.selfWeightKgPerM*r+v,{wMid:Z,Mabs:q}=Be(h,b,Q,Y);K=Math.max(K,Math.abs(k[S]),Math.abs(Z)),w=Math.max(w,q),u===d-1&&D.push(k[W])}const E=V.slice(),Me=E.map(u=>u/r);return{supportReactionsN:E,supportReactionsKg:Me,supportLabels:$,maxMomentNm:w,maxDeflectionM:K,deflectionsM:D,xNodesM:f,okAgainstAllowables:{moment:a.allowableM_Nm===void 0?void 0:w<=a.allowableM_Nm,deflection:a.allowableDeflectionM===void 0?void 0:K<=a.allowableDeflectionM}}}function Re(a,t){const n=[...t].sort((r,p)=>r.WLL_kg-p.WLL_kg);return a.map((r,p)=>{const d=n.find(o=>o.WLL_kg>=r)??n[n.length-1];return{support:`H${p+1}`,requiredKg:Math.ceil(r),hoist:d}})}function fe(a,t){return Array.from({length:a},()=>Array(t).fill(0))}function me(a){return Array(a).fill(0)}function ge(a,t){const n=t*t,r=n*t,p=12*a/r,d=6*a/n,o=4*a/t,h=2*a/t;return[[p,d,-p,d],[d,o,-d,h],[-p,-d,p,-d],[d,h,-d,o]]}function je(a,t){const n=a*t/2;return[n,n*(t/6),n,-n*(t/6)]}function Fe(a,t,n,r){const p=[n,n+1,r,r+1];for(let d=0;d<4;d++)for(let o=0;o<4;o++)a[p[d]][p[o]]+=t[d][o]}function Ie(a,t,n,r){a[n+0]+=t[0],a[n+1]+=t[1],a[r+0]+=t[2],a[r+1]+=t[3]}function ue(a,t){let n=0,r=1/0;return a.forEach((p,d)=>{const o=Math.abs(p-t);o<r&&(r=o,n=d)}),n}function X(a,t,n){return t.map(r=>n.map(p=>a[r][p]))}function xe(a,t){return t.map(n=>a[n])}function We(a,t){return a.map((n,r)=>n+t[r])}function he(a,t){return a.map((n,r)=>n-t[r])}function J(a,t){return a.map(n=>n.reduce((r,p,d)=>r+p*t[d],0))}function _e(a,t){const n=a.length,r=fe(n,n);for(let o=0;o<n;o++)for(let h=0;h<=o;h++){let j=a[o][h];for(let f=0;f<h;f++)j-=r[o][f]*r[h][f];if(o===h){if(j<=0)throw new Error("Matrix not SPD.");r[o][h]=Math.sqrt(j)}else r[o][h]=j/r[h][h]}const p=Array(n).fill(0);for(let o=0;o<n;o++)p[o]=(t[o]-r[o].slice(0,o).reduce((h,j,f)=>h+j*p[f],0))/r[o][o];const d=Array(n).fill(0);for(let o=n-1;o>=0;o--){let h=0;for(let j=o+1;j<n;j++)h+=r[j][o]*d[j];d[o]=(p[o]-h)/r[o][o]}return d}function Be(a,t,n,r){const p=ge(a,t),d=je(r,t),o=J(p,n).map((_,B)=>_-d[B]),h=o[1],j=o[3],f=r*t*t/8,M=Math.max(Math.abs(h),Math.abs(j),Math.abs(f)),C=1-3*.25+2*.125,L=t*(.5-2*.25+.125),v=3*.25-2*.125,R=t*(-.25+.125);return{wMid:C*n[0]+L*n[1]+v*n[2]+R*n[3],Mabs:M}}const G=[{id:7,name:"MARTIN MAC VIPER",weight:39},{id:8,name:"ROBE BMFL BLADE",weight:40},{id:10,name:"ROBE BMFL WASHBEAM",weight:41},{id:11,name:"ROBE MEGAPOINTE",weight:24},{id:33,name:"SUNSTRIP",weight:7}],He=a=>`lt${a}`,re=a=>O.find(t=>t.id===a),Ze=()=>{Ne();const{toast:a}=be(),{data:t}=Le(),[n]=ve(),r=n.get("jobId");n.get("tourId");const d=n.get("mode")==="tour-defaults",[o,h]=ee.useState(""),j=ee.useMemo(()=>t==null?void 0:t.find(s=>s.id===o),[t,o]),[f,M]=ee.useState([]);we.useEffect(()=>{r&&h(r)},[r]);const C=()=>{var l,c;const s=He(f.length+1),g=((l=O[0])==null?void 0:l.id)??"",i=((c=O[0])==null?void 0:c.lengthM)??8;M(m=>[...m,{id:s,modelId:g,tiltDeg:0,fixtures:[],supports:[{x:Math.max(.5,.1*i),label:"H1"},{x:Math.min(i-.5,.9*i),label:"H2"}],addCablePick:!1}])},L=s=>M(g=>g.filter(i=>i.id!==s)),v=(s,g)=>M(i=>i.map(l=>l.id===s?{...l,...g}:l)),R=s=>M(g=>g.map(i=>i.id===s?{...i,fixtures:[...i.fixtures,{fixtureId:G[0].id,qty:1,x:.5}]}:i)),$=(s,g)=>M(i=>i.map(l=>l.id===s?{...l,fixtures:l.fixtures.filter((c,m)=>m!==g)}:l)),_=s=>M(g=>g.map(i=>{if(i.id!==s)return i;const l=re(i.modelId),c=(l==null?void 0:l.lengthM)??8,m=i.supports.length+1;return{...i,supports:[...i.supports,{x:Math.min(c-.3,m/(m+1)*c),label:`H${m}`}]}})),B=(s,g)=>M(i=>i.map(l=>l.id===s?{...l,supports:l.supports.filter((c,m)=>m!==g).map((c,m)=>({...c,label:`H${m+1}`}))}:l)),U=s=>{const g=re(s.modelId);if(!g){v(s.id,{suggestion:{message:"Select a truss model.",severity:"warn"}});return}const i=g.lengthM,l=s.fixtures.map(N=>{const T=G.find(I=>I.id===N.fixtureId);return{x:pe(N.x,0,i),qty:N.qty,weightKg:T.weight,name:T.name}}),c=Ee(g,{fixtures:l,dynamicFactor:1.2},{supports:s.supports,tiltDeg:s.tiltDeg,nElements:32}),m=Re(c.supportReactionsKg,Ke).map(N=>({support:N.support,requiredKg:N.requiredKg,hoistName:N.hoist.name}));let x;c.okAgainstAllowables.moment===!1||c.okAgainstAllowables.deflection===!1?x={severity:"warn",message:"Truss model may be insufficient (moment/deflection). Consider upgrading model or adding supports."}:x=void 0,v(s.id,{results:{reactionsKg:c.supportReactionsKg,hoistPicks:m,maxMomentNm:Math.round(c.maxMomentNm),maxDeflMm:Math.round(c.maxDeflectionM*1e3),okMoment:c.okAgainstAllowables.moment,okDefl:c.okAgainstAllowables.deflection},suggestion:x})},y=()=>f.forEach(U),F=async()=>{if(!d&&!o){a({title:"No job selected",description:"Select a job before exporting.",variant:"destructive"});return}try{const s=f.map(x=>{var I,H,V,k,K;const N=[...x.fixtures.map(w=>{const D=G.find(E=>E.id===w.fixtureId);return{quantity:String(w.qty),componentName:D.name,weight:String(D.weight),x:w.x}}),...((I=x.results)==null?void 0:I.hoistPicks.map((w,D)=>{var E;return{componentName:w.support,reactionKg:(E=x.results)==null?void 0:E.reactionsKg[D],hoistName:w.hoistName}}))??[]],T=x.results?x.results.reactionsKg.reduce((w,D)=>w+D,0):0;return{name:x.id,rows:N,totalWeight:T,toolType:"rigging",maxMomentNm:(H=x.results)==null?void 0:H.maxMomentNm,maxDeflectionMm:(V=x.results)==null?void 0:V.maxDeflMm,okMoment:(k=x.results)==null?void 0:k.okMoment,okDefl:(K=x.results)==null?void 0:K.okDefl,cablePick:x.addCablePick}}),g=d?"Tour Lights Rigging Defaults":(j==null?void 0:j.title)??"Rigging Report",i=await Ae(g,s,"rigging",g,(j==null?void 0:j.start_time)||new Date().toISOString(),f.map(x=>({clusterName:x.id,riggingPoints:String(x.supports.length),clusterWeight:x.results?Math.round(x.results.reactionsKg.reduce((N,T)=>N+T,0)):0}))),l=`${g} - Rigging.pdf`,c=window.URL.createObjectURL(i),m=document.createElement("a");if(m.href=c,m.download=l,document.body.appendChild(m),m.click(),window.URL.revokeObjectURL(c),document.body.removeChild(m),!d&&o){const x=new File([i],l,{type:"application/pdf"}),N=`lights/${o}/${crypto.randomUUID()}.pdf`;await Se.storage.from("task_documents").upload(N,x)}a({title:"Success",description:"PDF generated."})}catch{a({title:"Error",description:"Failed to export PDF.",variant:"destructive"})}};return e.jsxs(ke,{className:"w-full max-w-5xl mx-auto my-6",children:[e.jsxs(ye,{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(De,{className:"text-2xl font-bold",children:"Rigging Planner (Tilt-accurate)"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[d&&e.jsx(ce,{variant:"outline",children:"Tour Defaults"}),e.jsx(P,{variant:"secondary",onClick:y,children:"Solve All"}),f.length>0&&e.jsxs(P,{variant:"outline",onClick:F,className:"gap-2",children:[e.jsx(Te,{className:"h-4 w-4"})," Export PDF"]})]})]}),!d&&!r&&e.jsxs("div",{className:"grid gap-2 max-w-sm",children:[e.jsx(A,{children:"Select Job"}),e.jsxs(se,{value:o,onValueChange:h,children:[e.jsx(te,{children:e.jsx(ne,{placeholder:"Select job"})}),e.jsx(ae,{children:t==null?void 0:t.map(s=>e.jsx(ie,{value:s.id,children:s.title},s.id))})]})]})]}),e.jsxs(Ce,{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-between",children:e.jsxs(P,{onClick:C,className:"gap-2",children:[e.jsx(de,{className:"h-4 w-4"})," Add Truss"]})}),f.map(s=>{const g=re(s.modelId)??O[0];return e.jsxs("div",{className:"border rounded-lg p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:s.id}),e.jsxs(se,{value:s.modelId,onValueChange:i=>v(s.id,{modelId:i}),children:[e.jsx(te,{className:"w-64",children:e.jsx(ne,{placeholder:"Truss model"})}),e.jsx(ae,{children:O.map(i=>e.jsx(ie,{value:i.id,children:i.name},i.id))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"whitespace-nowrap",children:"Tilt (°)"}),e.jsx(z,{type:"number",value:s.tiltDeg,onChange:i=>v(s.id,{tiltDeg:Number(i.target.value)}),className:"w-24"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pe,{id:`${s.id}-cable`,checked:s.addCablePick,onCheckedChange:i=>v(s.id,{addCablePick:!!i})}),e.jsx(A,{htmlFor:`${s.id}-cable`,children:"Cable pick"})]})]}),e.jsx(P,{variant:"destructive",size:"sm",onClick:()=>L(s.id),children:e.jsx(oe,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Rigging points (supports)"}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[s.supports.map((i,l)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{children:i.label??`H${l+1}`}),e.jsx(A,{children:"X (m)"}),e.jsx(z,{type:"number",value:i.x,onChange:c=>{const m=Number(c.target.value),x=[...s.supports];x[l]={...x[l],x:pe(m,0,g.lengthM)},v(s.id,{supports:x})},className:"w-24",step:"0.1"}),e.jsx(P,{variant:"ghost",size:"icon",onClick:()=>B(s.id,l),children:e.jsx(oe,{className:"h-4 w-4"})})]},l)),e.jsx(P,{variant:"secondary",onClick:()=>_(s.id),children:"Add support"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{children:"Fixtures on truss (x in meters from left)"}),e.jsxs(P,{variant:"secondary",size:"sm",onClick:()=>R(s.id),children:[e.jsx(de,{className:"h-4 w-4"})," Add fixture"]})]}),e.jsx("div",{className:"space-y-2",children:s.fixtures.map((i,l)=>e.jsxs("div",{className:"grid grid-cols-12 gap-2 items-center",children:[e.jsx("div",{className:"col-span-5",children:e.jsxs(se,{value:String(i.fixtureId),onValueChange:c=>{const m=[...s.fixtures];m[l]={...m[l],fixtureId:Number(c)},v(s.id,{fixtures:m})},children:[e.jsx(te,{children:e.jsx(ne,{placeholder:"Fixture"})}),e.jsx(ae,{children:G.map(c=>e.jsx(ie,{value:String(c.id),children:c.name},c.id))})]})}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(A,{className:"text-xs",children:"Qty"}),e.jsx(z,{type:"number",value:i.qty,onChange:c=>{const m=[...s.fixtures];m[l]={...m[l],qty:Number(c.target.value)},v(s.id,{fixtures:m})}})]}),e.jsxs("div",{className:"col-span-3",children:[e.jsx(A,{className:"text-xs",children:"X (m)"}),e.jsx(z,{type:"number",step:"0.1",value:i.x,onChange:c=>{const m=[...s.fixtures];m[l]={...m[l],x:Number(c.target.value)},v(s.id,{fixtures:m})}})]}),e.jsx("div",{className:"col-span-2 flex justify-end",children:e.jsx(P,{variant:"ghost",size:"icon",onClick:()=>$(s.id,l),children:e.jsx(oe,{className:"h-4 w-4"})})})]},l))})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(P,{onClick:()=>U(s),children:"Solve"})}),s.results&&e.jsxs("div",{className:"rounded-md border p-3 bg-muted/50",children:[e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm",children:[e.jsxs("span",{children:["Max M: ",e.jsxs("b",{children:[s.results.maxMomentNm," N·m"]})]}),e.jsxs("span",{children:["Max defl: ",e.jsxs("b",{children:[s.results.maxDeflMm," mm"]})]}),s.results.okMoment!==void 0&&e.jsxs("span",{children:["Moment check: ",e.jsx("b",{children:s.results.okMoment?"OK":"FAIL"})]}),s.results.okDefl!==void 0&&e.jsxs("span",{children:["Deflection check: ",e.jsx("b",{children:s.results.okDefl?"OK":"FAIL"})]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx(A,{children:"Per-hoist loads & suggestions"}),e.jsx("ul",{className:"list-disc pl-6 text-sm",children:s.results.hoistPicks.map((i,l)=>{var c;return e.jsxs("li",{children:[i.support,": need ~",(c=s.results)==null?void 0:c.reactionsKg[l].toFixed(0)," kg → ",e.jsx("b",{children:i.hoistName})]},l)})})]}),s.suggestion&&e.jsx("div",{className:`mt-2 text-sm ${s.suggestion.severity==="error"?"text-red-700":"text-amber-700"}`,children:s.suggestion.message})]})]},s.id)})]})]})};function pe(a,t,n){return Math.max(t,Math.min(n,a))}export{Ze as default};
