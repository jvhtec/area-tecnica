import{l as R,r as g,e as M,j as t,D as k,q as A,F as T,G as P,aK as U,S as V,t as F,v as L,w as O,x as z,ac as G,aL as K,B as y,s as f,i as S,V as E,f as q}from"./index-NZ6jJLfQ.js";import{M as N}from"./message-square-a2K2ewo9.js";import{C}from"./circle-check-big-CilmNGCn.js";import{U as Q}from"./user-check-CYYJtyVp.js";import{e as $}from"./es-CSiFCUGj.js";import{u as Y}from"./useQuery-kdg2pmgf.js";import{u as B}from"./useTabVisibility-TU5j192j.js";import{u as I}from"./useTableSubscription-Cu79jct8.js";import{S as H}from"./subscription-indicator-DAcdH7Ud.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=R("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]),J=({open:e,onOpenChange:u,recipientId:d,recipientName:p})=>{const[h,o]=g.useState(""),[m,i]=g.useState(!1),[s,n]=g.useState([]),[c,w]=g.useState(d),{toast:_}=M();g.useEffect(()=>{(async()=>{const{data:x,error:v}=await f.from("profiles").select("id, first_name, last_name").order("first_name");v||n(x||[])})()},[]);const l=async()=>{if(!(!h.trim()||!c))try{i(!0);const{data:{session:a}}=await f.auth.getSession();if(!(a!=null&&a.user))throw new Error("No authenticated user found");const{error:x}=await f.from("direct_messages").insert({sender_id:a.user.id,recipient_id:c,content:h.trim(),status:"unread"});if(x)throw x;_({title:"Message sent",description:"Your message has been sent successfully."}),o(""),u(!1)}catch{_({title:"Error",description:"Failed to send message. Please try again.",variant:"destructive"})}finally{i(!1)}},r=a=>{const x=s.find(v=>v.id===a);return x?`${x.first_name} ${x.last_name}`:""};return t.jsx(k,{open:e,onOpenChange:u,children:t.jsxs(A,{children:[t.jsxs(T,{children:[t.jsxs(P,{className:"flex items-center gap-2",children:[t.jsx(N,{className:"h-5 w-5"}),"New Message"]}),t.jsx(U,{children:"Send a direct message to another user"})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-sm font-medium",children:"To:"}),t.jsxs(V,{value:c,onValueChange:w,disabled:!!d,children:[t.jsx(F,{children:t.jsx(L,{placeholder:"Select recipient",children:c?r(c):"Select recipient"})}),t.jsx(O,{children:s.map(a=>t.jsxs(z,{value:a.id,children:[a.first_name," ",a.last_name]},a.id))})]})]}),t.jsx(G,{value:h,onChange:a=>o(a.target.value),placeholder:"Type your message...",className:"min-h-[100px]"})]}),t.jsx(K,{children:t.jsx(y,{onClick:l,disabled:m||!h.trim()||!c,children:m?"Sending...":"Send Message"})})]})})},X=({message:e,currentUserId:u,onDelete:d,onMarkAsRead:p,onGrantSoundVisionAccess:h,isManagement:o,theme:m,isDark:i=!1})=>{var a,x;const[s,n]=g.useState(!1),c=o&&e.status==="unread",w=o&&!!e.sender_id,_=((a=e.metadata)==null?void 0:a.type)==="soundvision_access_request",l=(x=e.metadata)==null?void 0:x.vacation_request_id,r=m||{textMain:i?"text-white":"text-slate-900",textMuted:i?"text-[#94a3b8]":"text-slate-500",accent:"bg-blue-600 hover:bg-blue-500 text-white",divider:i?"border-[#1f232e]":"border-slate-100"};return t.jsxs("div",{className:`rounded-xl border ${r.divider} p-4 ${i?"bg-white/5":"bg-white"} transition-colors`,children:[t.jsxs("div",{className:"flex items-start justify-between mb-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:`p-2 rounded-lg ${i?"bg-blue-500/10 text-blue-400":"bg-blue-50 text-blue-600"}`,children:t.jsx(N,{className:"h-4 w-4"})}),t.jsxs("div",{className:"flex flex-col",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("span",{className:`font-bold text-sm ${r.textMain}`,children:[e.sender.first_name," ",e.sender.last_name]}),_&&t.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-500/10 text-purple-500 border border-purple-500/20 uppercase font-medium",children:"SV Access"})]}),t.jsxs("span",{className:`text-xs ${r.textMuted}`,children:[e.department," • ",S(new Date(e.created_at),"PPp",{locale:$})]})]})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[w&&t.jsx(y,{variant:"ghost",size:"sm",onClick:()=>n(!0),title:"Responder al remitente",className:`h-8 w-8 p-0 ${r.textMuted} hover:${r.textMain}`,children:t.jsx(W,{className:"h-4 w-4"})}),c&&p&&t.jsx(y,{variant:"ghost",size:"sm",onClick:()=>p(e.id),title:"Marcar como leído",className:`h-8 w-8 p-0 ${r.textMuted} hover:text-emerald-500`,children:t.jsx(C,{className:"h-4 w-4"})}),(e.sender_id===u||o)&&d&&t.jsx(y,{variant:"ghost",size:"sm",onClick:()=>d(e.id),title:"Eliminar mensaje",className:`h-8 w-8 p-0 ${r.textMuted} hover:text-red-500`,children:t.jsx(E,{className:"h-4 w-4"})})]})]}),t.jsx("p",{className:`text-sm ${r.textMain} whitespace-pre-wrap pl-[44px]`,children:e.content}),_&&o&&l&&h&&t.jsx("div",{className:`mt-4 pt-3 border-t ${r.divider} pl-[44px]`,children:t.jsxs(y,{variant:"default",size:"sm",onClick:()=>h(e.id,l),className:`gap-2 ${r.accent}`,children:[t.jsx(Q,{className:"h-4 w-4"}),"Conceder Acceso SoundVision"]})}),w&&t.jsx(J,{open:s,onOpenChange:n,recipientId:e.sender_id,recipientName:`${e.sender.first_name} ${e.sender.last_name}`})]})},Z=(e,u)=>{g.useEffect(()=>{if(!e)return;const d=f.channel("direct-messages-changes").on("postgres_changes",{event:"*",schema:"public",table:"direct_messages"},async p=>{p.new&&(p.new.sender_id===e||p.new.recipient_id===e)&&u()}).subscribe(p=>{});return()=>{f.removeChannel(d)}},[e,u])},ee=(e,u)=>{const[d,p]=g.useState([]),{data:h,isLoading:o,isFetching:m}=Y({queryKey:["messages",e,u],queryFn:async()=>{if(!e)return[];const n=f.from("messages").select(`
          id,
          content,
          created_at,
          department,
          sender_id,
          status,
          metadata,
          sender:profiles!messages_sender_id_fkey (
            id,
            first_name,
            last_name
          )
        `).order("created_at",{ascending:!1});e==="management"?n.eq("department",u):n.eq("sender_id",await f.auth.getUser().then(l=>{var r;return(r=l.data.user)==null?void 0:r.id}));const{data:c,error:w}=await n;if(w)throw w;return(c||[]).map(l=>({...l,sender:Array.isArray(l.sender)&&l.sender.length>0?l.sender[0]:l.sender||{id:"",first_name:"",last_name:""}}))},staleTime:1e3*60*2,gcTime:1e3*60*5,refetchOnMount:!0,refetchOnWindowFocus:!0,refetchOnReconnect:!0,retry:3,retryDelay:n=>Math.min(1e3*2**n,3e4),enabled:!!e});g.useEffect(()=>{h&&p(h)},[h]);const[i,s]=g.useState(void 0);return g.useEffect(()=>{let n=!0;return(async()=>{const{data:{user:c}}=await f.auth.getUser();n&&s(c==null?void 0:c.id)})(),()=>{n=!1}},[]),Z(i,()=>{h&&p(h)}),{messages:d,loading:o,isFetching:m,setMessages:p}},te=(e,u,d)=>{const p=q();return{handleDeleteMessage:async i=>{try{const{error:s}=await f.from("messages").delete().eq("id",i);if(s)throw s;d({title:"Message deleted",description:"The message has been permanently deleted."}),u(e.filter(n=>n.id!==i))}catch{d({title:"Error",description:"Failed to delete the message. Please try again.",variant:"destructive"})}},handleMarkAsRead:async i=>{try{const{data:s,error:n}=await f.from("messages").update({status:"read"}).eq("id",i).select("id");if(n)throw n;if(!s||s.length===0)throw new Error("No rows updated. You may not have permission to update this message.");d({title:"Message marked as read",description:"The message has been marked as read."}),u(e.map(c=>c.id===i?{...c,status:"read"}:c));try{window.dispatchEvent(new Event("messages_invalidated"))}catch{}}catch{d({title:"Error",description:"Failed to mark the message as read. Please try again.",variant:"destructive"})}},handleGrantSoundVisionAccess:async(i,s)=>{try{const{data:{user:n}}=await f.auth.getUser();if(!n)throw new Error("User not authenticated");const{data:c,error:w}=await f.from("vacation_requests").select("technician_id, status").eq("id",s).single();if(w)throw w;if(!c)throw new Error("Vacation request not found");if(c.status==="approved"){d({title:"Already Granted",description:"SoundVision access has already been granted for this request.",variant:"default"});return}const{error:_}=await f.from("profiles").update({soundvision_access_enabled:!0}).eq("id",c.technician_id);if(_)throw _;const{error:l}=await f.from("vacation_requests").update({status:"approved",approved_by:n.id,approved_at:new Date().toISOString()}).eq("id",s);if(l)throw l;const{error:r}=await f.from("messages").update({status:"read"}).eq("id",i);if(r)throw r;u(e.map(a=>a.id===i?{...a,status:"read"}:a)),p.invalidateQueries({queryKey:["messages"]}),p.invalidateQueries({queryKey:["vacation_requests"]});try{window.dispatchEvent(new Event("messages_invalidated"))}catch{}d({title:"Access Granted",description:"SoundVision access has been successfully granted."})}catch(n){d({title:"Error",description:n instanceof Error?n.message:"Failed to grant SoundVision access. Please try again.",variant:"destructive"})}}}},me=({theme:e,isDark:u=!1})=>{const[d,p]=g.useState(null),[h,o]=g.useState(null),{toast:m}=M();B(["messages","direct_messages"]),g.useEffect(()=>{(async()=>{try{const{data:{user:a}}=await f.auth.getUser();if(!a)return;const{data:x}=await f.from("profiles").select("role, department").eq("id",a.id).single();x&&(p(x.role),o(x.department))}catch{}})()},[]);const{messages:i,loading:s,isFetching:n,setMessages:c}=ee(d,h),{handleDeleteMessage:w,handleMarkAsRead:_,handleGrantSoundVisionAccess:l}=te(i,c,m);return s?t.jsx("div",{className:`text-sm ${(e==null?void 0:e.textMuted)||"text-muted-foreground"} animate-pulse`,children:"Cargando mensajes..."}):t.jsxs("div",{className:"space-y-4",children:[n&&!s&&t.jsx("div",{className:`text-xs ${(e==null?void 0:e.textMuted)||"text-muted-foreground"} mb-2`,children:"Actualizando mensajes..."}),i.length===0?t.jsx("p",{className:(e==null?void 0:e.textMuted)||"text-muted-foreground",children:"No hay mensajes en este departamento."}):i.map(r=>t.jsx(X,{message:r,currentUserId:d==="management"?r.sender_id:void 0,onDelete:w,onMarkAsRead:_,onGrantSoundVisionAccess:l,isManagement:d==="management",theme:e,isDark:u},r.id))]})},se=({message:e,currentUserId:u,onDelete:d,onMarkAsRead:p,theme:h,isDark:o=!1})=>{const i=e.recipient_id===u&&e.status==="unread",s=h||{textMain:o?"text-white":"text-slate-900",textMuted:o?"text-[#94a3b8]":"text-slate-500",divider:o?"border-[#1f232e]":"border-slate-100"},n=()=>{window.confirm("¿Seguro que deseas eliminar este mensaje de forma permanente?")&&d(e.id)},c=e.status==="unread",w=c?o?"border-blue-500/50":"border-blue-400":s.divider;return t.jsxs("div",{className:`rounded-xl border ${w} p-4 ${o?"bg-white/5":"bg-white"} transition-colors relative`,children:[c&&t.jsx("div",{className:"absolute top-4 right-4 w-2 h-2 rounded-full bg-blue-500"}),t.jsxs("div",{className:"flex items-start justify-between mb-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:`p-2 rounded-lg ${o?"bg-purple-500/10 text-purple-400":"bg-purple-50 text-purple-600"}`,children:t.jsx(N,{className:"h-4 w-4"})}),t.jsxs("div",{className:"flex flex-col",children:[t.jsxs("span",{className:`font-bold text-sm ${s.textMain}`,children:[e.sender.first_name," ",e.sender.last_name]}),t.jsxs("span",{className:`text-xs ${s.textMuted}`,children:["para ",e.recipient.first_name," ",e.recipient.last_name," • ",S(new Date(e.created_at),"PPp",{locale:$})]})]})]}),t.jsxs("div",{className:"flex items-center gap-1 pr-4",children:[i&&t.jsx(y,{variant:"ghost",size:"sm",onClick:()=>p(e.id),title:"Marcar como leído",className:`h-8 w-8 p-0 ${s.textMuted} hover:text-emerald-500`,children:t.jsx(C,{className:"h-4 w-4"})}),(u===e.sender_id||u===e.recipient_id)&&t.jsx(y,{variant:"ghost",size:"sm",onClick:n,title:"Eliminar mensaje",className:`h-8 w-8 p-0 ${s.textMuted} hover:text-red-500`,children:t.jsx(E,{className:"h-4 w-4"})})]})]}),t.jsx("p",{className:`text-sm ${s.textMain} whitespace-pre-wrap pl-[44px]`,children:e.content})]})},ae=(e,u,d)=>({handleDeleteMessage:async o=>{try{const{data:m,error:i}=await f.from("direct_messages").delete().eq("id",o).select("id");if(i)throw i;if(!m||m.length===0)throw new Error("No rows deleted. You may not have permission to delete this direct message.");u(s=>s.filter(n=>n.id!==o));try{window.dispatchEvent(new Event("direct_messages_invalidated"))}catch{}d({title:"Success",description:"Message deleted successfully"})}catch{d({title:"Error",description:"Failed to delete message",variant:"destructive"})}},handleMarkAsRead:async o=>{try{const{data:m,error:i}=await f.from("direct_messages").update({status:"read"}).eq("id",o).select("id");if(i)throw i;if(!m||m.length===0)throw new Error("No rows updated. You may not have permission to update this direct message.");u(e.map(s=>s.id===o?{...s,status:"read"}:s));try{window.dispatchEvent(new Event("direct_messages_invalidated"))}catch{}d({title:"Success",description:"Message marked as read"})}catch{d({title:"Error",description:"Failed to mark message as read",variant:"destructive"})}}}),fe=({theme:e,isDark:u=!1})=>{const[d,p]=g.useState([]),[h,o]=g.useState(!0),[m,i]=g.useState(),{toast:s}=M(),n=q(),{handleDeleteMessage:c,handleMarkAsRead:w}=ae(d,p,s);I("direct_messages"),g.useEffect(()=>{(async()=>{try{const{data:{user:r},error:a}=await f.auth.getUser();if(a)return;r&&(i(r.id),await _(r.id))}catch{}})()},[]);const _=async l=>{try{o(!0);const[r,a]=await Promise.all([f.from("direct_messages").select(`
            *,
            sender:profiles!direct_messages_sender_id_fkey(id, first_name, last_name),
            recipient:profiles!direct_messages_recipient_id_fkey(id, first_name, last_name)
          `).eq("recipient_id",l).order("created_at",{ascending:!1}),f.from("direct_messages").select(`
            *,
            sender:profiles!direct_messages_sender_id_fkey(id, first_name, last_name),
            recipient:profiles!direct_messages_recipient_id_fkey(id, first_name, last_name)
          `).eq("sender_id",l).order("created_at",{ascending:!1})]);if(r.error)throw r.error;if(a.error)throw a.error;const x=[...r.data||[],...a.data||[]],j=Array.from(new Map(x.map(b=>[b.id,b])).values()).sort((b,D)=>new Date(D.created_at).getTime()-new Date(b.created_at).getTime());p(j)}catch{s({title:"Error",description:"No se pudieron obtener los mensajes",variant:"destructive"})}finally{o(!1)}};return g.useEffect(()=>{if(!m)return;const l=()=>{_(m)},r=n.getQueryCache().subscribe(x=>{var v;if(x.type==="updated"||x.type==="added"){const j=(v=x.query)==null?void 0:v.queryKey;j&&j[0]==="direct_messages"&&l()}}),a=()=>l();return window.addEventListener("direct_messages_invalidated",a),()=>{r(),window.removeEventListener("direct_messages_invalidated",a)}},[m,n]),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between pb-2",children:[t.jsx("h3",{className:`text-lg font-medium ${(e==null?void 0:e.textMain)||""}`,children:"Mensajes directos"}),t.jsx(H,{tables:["direct_messages"],variant:"compact"})]}),h?t.jsx("p",{className:(e==null?void 0:e.textMuted)||"text-muted-foreground",children:"Cargando mensajes..."}):d.length===0?t.jsx("p",{className:(e==null?void 0:e.textMuted)||"text-muted-foreground",children:"No hay mensajes directos."}):d.map(l=>t.jsx(se,{message:l,currentUserId:m,onDelete:c,onMarkAsRead:w,theme:e,isDark:u},l.id))]})};export{fe as D,me as M,J as a};
