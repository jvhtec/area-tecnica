import{e as q,f as R,u as C,m as g,r as x,j as e,C as f,W as j,Y as N,A as v,$ as M,L as p,B as h}from"./index-NZ6jJLfQ.js";import{S as z}from"./switch-DUBpZhIC.js";import{C as A}from"./checkbox-BsRNEGV1.js";import{u as L}from"./useQuery-kdg2pmgf.js";import{u as T}from"./useMutation-DluhVBs1.js";import{B as y}from"./bell-eCP3MIu-.js";import{I as S}from"./info-CpCfiYD2.js";function B(){const{toast:l}=q(),t=R(),{user:o}=C(),r=o==null?void 0:o.id,{data:d,isLoading:n,error:m}=L({queryKey:["morning-summary-subscription",r],queryFn:async()=>{if(!r)return null;const{data:a,error:c}=await g.from("morning_summary_subscriptions").select("*").eq("user_id",r).maybeSingle();if(c)throw c;return a},enabled:!!r}),i=T({mutationFn:async a=>{if(!r)throw new Error("User not authenticated");const{data:c,error:u}=await g.from("morning_summary_subscriptions").upsert({user_id:r,subscribed_departments:a.subscribed_departments,enabled:a.enabled}).select().single();if(u)throw u;return c},onSuccess:()=>{t.invalidateQueries({queryKey:["morning-summary-subscription",r]}),l({title:"Suscripci贸n actualizada",description:"Tus preferencias de resumen diario se han guardado correctamente."})},onError:a=>{l({title:"Error al actualizar",description:a.message,variant:"destructive"})}});return{subscription:d,isLoading:n,error:m,upsertSubscription:i.mutate,isUpdating:i.isPending}}const k=[{value:"sound",label:"Sonido",emoji:""},{value:"lights",label:"Iluminaci贸n",emoji:""},{value:"video",label:"V铆deo",emoji:""},{value:"logistics",label:"Log铆stica",emoji:""},{value:"production",label:"Producci贸n",emoji:""}];function H(){const{userRole:l}=C(),{subscription:t,isLoading:o,upsertSubscription:r,isUpdating:d}=B(),[n,m]=x.useState(!1),[i,a]=x.useState([]),c=l&&["admin","management","house_tech"].includes(l);x.useEffect(()=>{t&&(m(t.enabled),a(t.subscribed_departments||[]))},[t]);const u=()=>{r({enabled:n,subscribed_departments:i})},w=s=>{a(b=>b.includes(s)?b.filter(D=>D!==s):[...b,s])},_=()=>{a(k.map(s=>s.value))},E=()=>{a([])};return c?o?e.jsxs(f,{children:[e.jsx(j,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(y,{className:"h-5 w-5"}),"Mi Suscripci贸n al Resumen Diario"]})}),e.jsx(v,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Cargando configuraci贸n..."})})]}):e.jsxs(f,{children:[e.jsxs(j,{children:[e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(y,{className:"h-5 w-5"}),"Mi Suscripci贸n al Resumen Diario"]}),e.jsx(M,{children:"Elige qu茅 departamentos quieres recibir en tu resumen matutino autom谩tico"})]}),e.jsxs(v,{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(p,{htmlFor:"subscription-enabled",className:"text-base",children:"Recibir resumen diario"}),e.jsx(z,{id:"subscription-enabled",checked:n,onCheckedChange:m})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(p,{className:"text-sm font-medium",children:"Departamentos"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{type:"button",variant:"ghost",size:"sm",onClick:_,disabled:!n,className:"h-7 text-xs",children:"Todos"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",onClick:E,disabled:!n,className:"h-7 text-xs",children:"Ninguno"})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:k.map(s=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 border rounded-md hover:bg-accent/50 transition-colors",children:[e.jsx(A,{id:`dept-${s.value}`,checked:i.includes(s.value),onCheckedChange:()=>w(s.value),disabled:!n}),e.jsxs(p,{htmlFor:`dept-${s.value}`,className:"flex items-center gap-2 text-sm font-normal cursor-pointer flex-1",children:[e.jsx("span",{className:"text-lg",children:s.emoji}),e.jsx("span",{children:s.label})]})]},s.value))})]}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-md",children:[e.jsx(S,{className:"h-5 w-5 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-blue-900 dark:text-blue-100 space-y-1",children:[e.jsx("p",{className:"font-medium",children:"驴C贸mo funciona?"}),e.jsx("p",{className:"text-blue-700 dark:text-blue-300",children:"Recibir谩s una notificaci贸n cada ma帽ana con el estado del personal de los departamentos seleccionados: qui茅n est谩 en trabajos, en almac茅n, de vacaciones, etc."}),i.length>1&&e.jsxs("p",{className:"text-blue-700 dark:text-blue-300 font-medium mt-2",children:["Has seleccionado ",i.length," departamentos. Recibir谩s un solo resumen con todos ellos."]})]})]}),n&&i.length===0&&e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-md",children:[e.jsx(S,{className:"h-5 w-5 text-amber-600 dark:text-amber-400 mt-0.5 flex-shrink-0"}),e.jsx("p",{className:"text-sm text-amber-900 dark:text-amber-100",children:"Selecciona al menos un departamento para recibir el resumen."})]}),e.jsx(h,{onClick:u,disabled:d||n&&i.length===0,className:"w-full",children:d?"Guardando...":"Guardar preferencias"}),(t==null?void 0:t.updated_at)&&e.jsxs("p",{className:"text-xs text-muted-foreground text-center",children:["ltima actualizaci贸n: ",new Date(t.updated_at).toLocaleString("es-ES",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]}):null}export{H as M};
