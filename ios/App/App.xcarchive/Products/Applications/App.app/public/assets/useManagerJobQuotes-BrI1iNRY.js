import{l as Me,i as ee,h as x,m as G,c2 as Z}from"./index-NZ6jJLfQ.js";import{f as ge,g as Ue,s as Be}from"./tourRateMath-BOmIkfWO.js";import{getCompanyLogo as ye,fetchTourLogo as We,fetchJobLogo as Xe}from"./logoUtils-D2o1jUVg.js";import{a as Te}from"./lazyPdf-xVUlxKNu.js";import{e as ce}from"./es-CSiFCUGj.js";import{F as je,R as He}from"./constants-DoXhG9KB.js";import{u as qe}from"./useQuery-kdg2pmgf.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ct=Me("ShieldCheck",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),De="No autónomo – €30 descuento",Le=o=>o!==!1,Rt=o=>Le(o)?null:De,ne=(o,a,i)=>{if(Le(a))return o;const r=De;return(i==null?void 0:i.multiline)===!1?`${o} (${r})`:`${o}
${r}`},be=30,Ae="* Se ha aplicado una deducción de 30€/día en concepto de IRPF por condición de no autónomo.",N=[125,1,1],re=[31,41,55],Y=[100,116,139],de=[248,248,248],we=[250,250,250],pe=44,Je=pe+18,W=38,Ge=(o,a)=>new Promise(i=>{if(!o||typeof Image>"u"){i(null);return}const r=new Image;r.crossOrigin="anonymous",r.onload=()=>i(r),r.onerror=()=>{i(null)},r.src=o}),j=(o,{title:a,subtitle:i,metadata:r,logo:n})=>{const e=o.internal.pageSize.getWidth();if(o.setFillColor(...N),o.rect(0,0,e,pe,"F"),n)try{const m=n.width&&n.height?n.width/n.height:1,s=26,t=s*m;o.addImage(n,"PNG",16,9,t,s)}catch{}return o.setFont("helvetica","bold"),o.setFontSize(18),o.setTextColor(255,255,255),o.text(a,e/2,20,{align:"center"}),i&&(o.setFont("helvetica","normal"),o.setFontSize(12),o.text(i,e/2,31,{align:"center"})),r&&(o.setFont("helvetica","normal"),o.setFontSize(9),o.text(r,e-18,pe-10,{align:"right"})),o.setTextColor(...re),Je},xe=(o,a)=>{const i=o.getNumberOfPages();for(let r=1;r<=i;r++){o.setPage(r);const n=o.internal.pageSize.getWidth(),m=o.internal.pageSize.getHeight()-12;if(a)try{const t=a.width&&a.height?a.width/a.height:1,d=12,p=d*t,y=(n-p)/2;o.addImage(a,"PNG",y,m-d-3,p,d)}catch{}o.setFont("helvetica","normal"),o.setFontSize(8),o.setTextColor(...Y),o.text("Sector-Pro",18,m);const s=`Página ${r} de ${i}`;o.text(s,n-18,m,{align:"right"})}o.setTextColor(...re)},Se=async({jobId:o,tourId:a})=>{const[i,r]=await Promise.all([a?We(a):Promise.resolve(void 0),o?Xe(o):Promise.resolve(void 0)]),n=i||r;return n?Ge(n):null},Ie=o=>{const a=new Map(o.map(i=>[i.id,i]));return i=>{const r=a.get(i);if(!r)return{name:"Unknown",profile:void 0,autonomo:!0};const n=`${r.first_name??""} ${r.last_name??""}`.trim()||"Unknown",e=r.autonomo!==!1;return{name:n,profile:r,autonomo:e}}},Ee=o=>ee(new Date(o),"PPP",{locale:ce}),Ye=.5,Qe=1e-4,Ve=o=>Math.round((o+Number.EPSILON)*100)/100,me=o=>{var p,y;const a=Ue(o),i=a??1,r=((p=o.breakdown)==null?void 0:p.after_discount)??((y=o.breakdown)==null?void 0:y.base_calculation)??void 0,n=Number(o.base_day_eur??0),e=Number(r??n),m=Ve(e*i),s=Number(o.extras_total_eur??0),t=r==null;let d=m;return(t||a==null||Math.abs(m-n)<=Ye)&&(d=n),{effectiveBase:d,extrasTotal:s,preMultiplierBase:e,rawMultiplier:a,usedFallbackBase:t}},ke=(o,a)=>a?`${o}
LPO: ${a}`:o;async function Ke(o,a,i,r,n){var T,k;const{jsPDF:e,autoTable:m}=await Te(),s=new e,t=(T=o.find(f=>f.tour_id))==null?void 0:T.tour_id,[d,p]=await Promise.all([Se({jobId:a.id,tourId:a.tour_id??t}),ye()]),y={title:"Presupuesto de Tarifas",subtitle:a.title,metadata:`Generado: ${ee(new Date,"PPP",{locale:ce})}`,logo:d},b=j(s,y);let _=b;s.setFont("helvetica","bold"),s.setFontSize(12),s.setTextColor(...N),s.text("Detalles del Trabajo",14,_),_+=6,s.setFont("helvetica","normal"),s.setFontSize(10),s.setTextColor(...Y),s.text(`Nombre: ${a.title}`,14,_),_+=5,s.text(`Fecha: ${Ee(a.start_time)}`,14,_),_+=10,s.setTextColor(...re);const l=Ie(i),C=o.map(f=>({quote:f,computed:me(f)})),I=C.map(({quote:f,computed:F})=>{var ie;const{name:O,autonomo:v}=l(f.technician_id),R=(r==null?void 0:r.get(f.technician_id))??null,g=ne(O,v),{effectiveBase:S,extrasTotal:c,preMultiplierBase:w,rawMultiplier:D,usedFallbackBase:X}=F,z=(ie=f.breakdown)==null?void 0:ie.error,U=!X&&D!=null&&Be(D),P=f.start_time?f.start_time.split("T")[0]:null;let J=!1;if(n!=null&&n.timesheetMap&&P){const ae=n.timesheetMap.get(f.technician_id);ae&&ae.has(P)&&(J=!0)}else J=!0,n!=null&&n.timesheetMap&&(J=!1);const K=!v&&J?be:0,te=S+c-K;let V;z?V=f.breakdown.error==="category_missing"?"ERROR: Falta categoría":f.breakdown.error==="house_rate_missing"?"ERROR: Falta tarifa":f.breakdown.error==="tour_base_missing"?"ERROR: Falta tarifa base":"ERROR: "+f.breakdown.error:U&&D!=null?V=`${x(w)} ${ge(D)} = ${x(S)}`:V=x(S);let oe=ke(g,R);return K>0&&(oe+=`
(Deducción IRPF: -${x(K)})`),[oe,f.is_house_tech?"Plantilla":f.category||"—",V,z?"—":ge(D),z?"—":x(c),z?"€0.00":x(te)]});m(s,{startY:_,head:[["Técnico","Categoría","Base (calc.)","Mult.","Extras","Total"]],body:I,theme:"grid",headStyles:{fillColor:N,textColor:255,fontStyle:"bold"},styles:{fontSize:9,cellPadding:3},alternateRowStyles:{fillColor:de},columnStyles:{1:{cellWidth:34},2:{halign:"right",cellWidth:68},3:{halign:"center"},4:{halign:"right"},5:{halign:"right",fontStyle:"bold"}},margin:{left:14,right:14,top:b,bottom:W},didDrawPage:f=>{f.pageNumber>1&&j(s,y)}});const u=(((k=s.lastAutoTable)==null?void 0:k.finalY)??_)+10,H=s.internal.pageSize.getWidth()-28,A=C.reduce((f,{computed:F})=>f+F.effectiveBase,0),h=C.reduce((f,{computed:F})=>f+F.extrasTotal,0),$=C.reduce((f,{quote:F,computed:O})=>{const{autonomo:v}=l(F.technician_id),R=F.start_time?F.start_time.split("T")[0]:null;let g=!1;if(n!=null&&n.timesheetMap){if(R){const c=n.timesheetMap.get(F.technician_id);c&&c.has(R)&&(g=!0)}}else g=!0;const S=!v&&g?be:0;return f+O.effectiveBase+O.extrasTotal-S},0),B=C.some(({quote:f})=>{var v;const{autonomo:F}=l(f.technician_id);if(F)return!1;const O=f.start_time?f.start_time.split("T")[0]:null;return n!=null&&n.timesheetMap?!!O&&!!((v=n.timesheetMap.get(f.technician_id))!=null&&v.has(O)):!0});s.setFillColor(...we),s.roundedRect(14,u,H,32,3,3,"F"),s.setFont("helvetica","bold"),s.setFontSize(11),s.setTextColor(...N),s.text("Resumen",18,u+10),s.setFont("helvetica","normal"),s.setFontSize(10),s.setTextColor(...Y),s.text(`Total Base: ${x(A)}`,18,u+18),s.text(`Total Extras: ${x(h)}`,18,u+26);const M=`Total General: ${x($)}`;s.setFont("helvetica","bold"),s.setFontSize(12),s.setTextColor(...N);const E=s.getTextWidth(M);s.text(M,14+H-E-6,u+22),B&&(s.setFont("helvetica","italic"),s.setFontSize(8),s.setTextColor(...N),s.text(Ae,14,u+38)),xe(s,p??d);const q=`presupuesto_${a.title.replace(/[^\w\s-]/g,"").replace(/\s+/g,"_")}_${ee(new Date,"yyyy-MM-dd")}.pdf`;if((n==null?void 0:n.download)===!1)return s.output("blob");s.save(q)}async function Pt(o,a,i){var E,Q,q;const{jsPDF:r,autoTable:n}=await Te(),e=new r,m=(Q=(E=a.find(T=>T.quotes.length))==null?void 0:E.quotes[0])==null?void 0:Q.tour_id,[s,t]=await Promise.all([Se({tourId:m}),ye()]),d={title:"Resumen de Tarifas",subtitle:o,metadata:`Generado: ${ee(new Date,"PPP",{locale:ce})}`,logo:s},p=j(e,d),y=Ie(i),b=[...a].sort((T,k)=>new Date(T.job.start_time).getTime()-new Date(k.job.start_time).getTime());let _=p;e.setFont("helvetica","bold"),e.setFontSize(11),e.setTextColor(...N),e.text(`Total de fechas: ${b.length}`,14,_),_+=6,e.setFont("helvetica","normal"),e.setFontSize(10),e.setTextColor(...Y),e.text("Resumen general por técnico",14,_),_+=6,e.setTextColor(...re);const l=new Map;b.forEach(({quotes:T,lpoMap:k})=>{T.forEach(f=>{var D;const F=f.technician_id;if(!F||((D=f.breakdown)==null?void 0:D.error))return;const{effectiveBase:v,extrasTotal:R}=me(f),g=v+R,S=y(F),c=l.get(F)||{info:S,dates:0,total:0,lpos:new Set};c.info=S,c.dates+=1,c.total+=g;const w=k==null?void 0:k.get(F);w&&c.lpos.add(w),l.set(F,c)})});const C=Array.from(l.values()).sort((T,k)=>T.info.name.localeCompare(k.info.name)).map(T=>[ne(T.info.name,T.info.autonomo,{multiline:!1}),T.dates.toString(),T.lpos.size?Array.from(T.lpos).join(", "):"—",x(T.total)]);n(e,{startY:_,head:[["Técnico","Fechas","LPOs","Total Gira"]],body:C,theme:"grid",headStyles:{fillColor:N,textColor:255,fontStyle:"bold"},styles:{fontSize:10,cellPadding:3},alternateRowStyles:{fillColor:de},columnStyles:{1:{halign:"center"},2:{halign:"left"},3:{halign:"right",fontStyle:"bold"}},margin:{left:14,right:14,top:p,bottom:W},didDrawPage:T=>{T.pageNumber>1&&j(e,d)}});const I=(((q=e.lastAutoTable)==null?void 0:q.finalY)??_)+10,L=e.internal.pageSize.getWidth()-28,H=Array.from(l.values()).reduce((T,k)=>T+k.total,0);e.setFillColor(...we),e.roundedRect(14,I,L,26,3,3,"F"),e.setFont("helvetica","bold"),e.setFontSize(12),e.setTextColor(...N),e.text(`Total General de Gira: ${x(H)}`,18,I+16),e.setFont("helvetica","normal"),e.setFontSize(10),e.setTextColor(...Y),e.text(`Total de técnicos: ${l.size}`,18,I+22),e.addPage();let A=j(e,d);e.setFont("helvetica","bold"),e.setFontSize(14),e.setTextColor(...N),e.text("Desglose por Fecha",14,A);let h=A+8;const $=e.internal.pageSize.getHeight();b.forEach((T,k)=>{var R;if(!T.quotes.length)return;h>$-(W+60)&&(e.addPage(),A=j(e,d),e.setFont("helvetica","bold"),e.setFontSize(14),e.setTextColor(...N),e.text("Desglose por Fecha (cont.)",14,A),h=A+8),e.setFont("helvetica","bold"),e.setFontSize(11),e.setTextColor(...N),e.text(`${Ee(T.job.start_time)} • ${T.job.title}`,14,h),h+=6,e.setFont("helvetica","normal"),e.setFontSize(9),e.setTextColor(...Y),e.text(`${T.quotes.length} asignaciones`,14,h),h+=4;const f=T.quotes.map(g=>{var oe,ie,ae,Ce,Re;const{name:S,autonomo:c}=y(g.technician_id),w=((oe=T.lpoMap)==null?void 0:oe.get(g.technician_id))??null,D=ne(S,c),X=(ie=g.breakdown)==null?void 0:ie.error,{effectiveBase:z,extrasTotal:U,preMultiplierBase:P,rawMultiplier:J,usedFallbackBase:K}=me(g);let te;X?te=g.breakdown.error==="category_missing"?"ERROR: Falta categoría":g.breakdown.error==="house_rate_missing"?"ERROR: Falta tarifa":g.breakdown.error==="tour_base_missing"?"ERROR: Falta tarifa base":"ERROR: "+g.breakdown.error:te=!K&&J!=null&&Math.abs(J-1)>=Qe?`${x(P)} ${ge(J)} = ${x(z)}`:x(z);let V=ke(D,w);if(!X){const ue=Number(g.breakdown&&(g.breakdown.single_hours_total??g.breakdown.hours_rounded??g.breakdown.worked_hours_rounded)||0),Pe=Number(((ae=g.breakdown)==null?void 0:ae.single_plus_10_12_total_eur)??0),Ne=Number(((Ce=g.breakdown)==null?void 0:Ce.single_overtime_hours_total)??0),ze=Number(((Re=g.breakdown)==null?void 0:Re.single_overtime_amount_total_eur)??0),se=[];ue>0&&se.push(`Horas: ${ue}h`),Pe>0&&se.push(`+10–12: ${x(Pe)}`),Ne>0&&se.push(`HE: ${Ne}h = ${x(ze)}`),se.length&&(V=`${V}
${se.join(" · ")}`)}return[V,g.is_house_tech?"Plantilla":g.category||"—",te,X?"—":x(U),X?"€0.00":x(z+U)]});n(e,{startY:h,head:[["Técnico","Categoría","Base","Extras","Total"]],body:f,theme:"grid",headStyles:{fillColor:N,textColor:255,fontStyle:"bold"},styles:{fontSize:9,cellPadding:3},alternateRowStyles:{fillColor:de},columnStyles:{2:{halign:"right"},3:{halign:"right"},4:{halign:"right",fontStyle:"bold"}},margin:{left:14,right:14,top:A,bottom:W},didDrawPage:g=>{g.pageNumber>1&&j(e,d)}}),h=(((R=e.lastAutoTable)==null?void 0:R.finalY)??h)+6;const{jobBaseTotal:F,jobExtrasTotal:O,jobGrandTotal:v}=T.quotes.reduce((g,S)=>{const{effectiveBase:c,extrasTotal:w}=me(S);return g.jobBaseTotal+=c,g.jobExtrasTotal+=w,g.jobGrandTotal+=c+w,g},{jobBaseTotal:0,jobExtrasTotal:0,jobGrandTotal:0});h>$-(W+16)&&(e.addPage(),A=j(e,d),h=A+8),e.setFont("helvetica","bold"),e.setFontSize(10),e.setTextColor(...N),e.text(`Totales — Base: ${x(F)} · Extras: ${x(O)} · General: ${x(v)}`,18,h),h+=10,e.setTextColor(...re)}),xe(e,t??s);const M=`resumen_gira_${o.replace(/[^\w\s-]/g,"").replace(/\s+/g,"_")}_${ee(new Date,"yyyy-MM-dd")}.pdf`;e.save(M)}async function Nt(o,a,i,r,n,e){var R,g,S;const{jsPDF:m,autoTable:s}=await Te(),t=new m,[d,p]=await Promise.all([Se({jobId:a.id,tourId:a.tour_id}),ye()]),y={title:"Informe de Pagos",subtitle:a.title,metadata:`Generado: ${ee(new Date,"PPP",{locale:ce})}`,logo:d},b=j(t,y);let _=b;t.setFont("helvetica","bold"),t.setFontSize(12),t.setTextColor(...N),t.text("Detalles del Trabajo",14,_),_+=6,t.setFont("helvetica","normal"),t.setFontSize(10),t.setTextColor(...Y),t.text(`Nombre: ${a.title}`,14,_),_+=5,t.text(`Fecha: ${Ee(a.start_time)}`,14,_),_+=10,t.setTextColor(...re);const l=Ie(i),C=o.map(c=>{const{name:w,autonomo:D}=l(c.technician_id),X=(r==null?void 0:r.get(c.technician_id))??null,z=ne(w,D);let U=0,P=0;if(!D){const te=(n==null?void 0:n.get(c.technician_id))||[];if(te.length>0){const V=new Set(te.map(oe=>oe.date).filter(Boolean));P=V.size>0?V.size:1}else c.timesheets_total_eur>0&&(P=1);U=P*be}const J=c.total_eur-U;let K=ke(z,X);return U>0&&(K+=`
(Deducción IRPF ${P}d: -${x(U)})`),[K,x(c.timesheets_total_eur),x(c.extras_total_eur),x(c.expenses_total_eur),x(J)]}),I=o.some(c=>{const{autonomo:w}=l(c.technician_id);return!w});if(s(t,{startY:_,head:[["Técnico","Partes","Extras","Gastos","Total"]],body:C,theme:"grid",headStyles:{fillColor:N,textColor:255,fontStyle:"bold"},styles:{fontSize:10,cellPadding:3},alternateRowStyles:{fillColor:de},columnStyles:{1:{halign:"right"},2:{halign:"right"},3:{halign:"right"},4:{halign:"right",fontStyle:"bold"}},margin:{left:14,right:14,top:b,bottom:W},didDrawPage:c=>{c.pageNumber>1&&j(t,y)}}),I){const c=((R=t.lastAutoTable)==null?void 0:R.finalY)??_;t.setFont("helvetica","italic"),t.setFontSize(8),t.setTextColor(...N),t.text(Ae,14,c+8)}let u=(((g=t.lastAutoTable)==null?void 0:g.finalY)??_)+12;const L=t.internal.pageSize.getHeight(),H=o.filter(c=>{var w;return((w=c.extras_breakdown)==null?void 0:w.items)&&c.extras_breakdown.items.length>0}),A=o.filter(c=>{var w;return(c.expenses_total_eur??0)>0||(((w=c.expenses_breakdown)==null?void 0:w.length)??0)>0});if(Array.from(new Set((o||[]).map(c=>c.technician_id))).filter(c=>((n==null?void 0:n.get(c))||[]).length>0).length>0){u>L-(W+60)&&(t.addPage(),u=j(t,y)+2),t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(...N),t.text("Desglose de Partes",14,u),u+=7;for(const c of o){const w=(n==null?void 0:n.get(c.technician_id))||[];if(!w.length)continue;u>L-(W+40)&&(t.addPage(),u=j(t,y)+2);const{name:D,autonomo:X}=l(c.technician_id),z=ne(D,X,{multiline:!1});t.setFont("helvetica","bold"),t.setFontSize(10),t.setTextColor(...N),t.text(z,14,u),u+=5;const U=w.map(P=>[P.date?ee(new Date(P.date),"P",{locale:ce}):"—",`${P.hours_rounded??0}h`,x(P.base_day_eur??0),P.plus_10_12_amount_eur?`${P.plus_10_12_hours??0}h = ${x(P.plus_10_12_amount_eur)}`:"—",(P.overtime_hours??0)>0?`${P.overtime_hours}h × ${x(P.overtime_hour_eur??0)} = ${x(P.overtime_amount_eur??0)}`:"—",x(P.total_eur??0)]);s(t,{startY:u,head:[["Fecha","Horas","Base día","+10–12","OT","Total Parte"]],body:U,theme:"grid",headStyles:{fillColor:N,textColor:255,fontStyle:"bold"},styles:{fontSize:9,cellPadding:3},alternateRowStyles:{fillColor:de},columnStyles:{1:{halign:"center"},2:{halign:"right"},3:{halign:"right"},4:{halign:"right"},5:{halign:"right",fontStyle:"bold"}},margin:{left:14,right:14,top:b,bottom:W},didDrawPage:P=>{P.pageNumber>1&&j(t,y)}}),u=(((S=t.lastAutoTable)==null?void 0:S.finalY)??u)+8}}H.length>0&&(u>L-(W+60)&&(t.addPage(),u=j(t,y)+2),t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(...N),t.text("Desglose de Extras",14,u),u+=7,H.forEach(c=>{u>L-(W+40)&&(t.addPage(),u=j(t,y)+2);const{name:w,autonomo:D}=l(c.technician_id),X=ne(w,D,{multiline:!1});t.setFont("helvetica","bold"),t.setFontSize(10),t.setTextColor(...N),t.text(X,14,u),u+=5,t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(...Y),c.extras_breakdown.items.forEach(z=>{const U=`• ${z.extra_type.replace("_"," ")} × ${z.quantity} = ${x(z.amount_eur)}`;t.text(U,18,u),u+=5,u>L-(W+20)&&(t.addPage(),u=j(t,y)+2,t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(...Y))}),u+=4})),A.length>0&&(u>L-(W+60)&&(t.addPage(),u=j(t,y)+2),t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(...N),t.text("Desglose de Gastos",14,u),u+=7,A.forEach(c=>{u>L-(W+40)&&(t.addPage(),u=j(t,y)+2);const{name:w,autonomo:D}=l(c.technician_id),X=ne(w,D,{multiline:!1});t.setFont("helvetica","bold"),t.setFontSize(10),t.setTextColor(...N),t.text(X,14,u),u+=5,t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(...Y);const z={dietas:"Dietas",transporte:"Transporte",alojamiento:"Alojamiento",material:"Material",otros:"Otros"};c.expenses_breakdown&&c.expenses_breakdown.length>0&&c.expenses_breakdown.forEach(U=>{const P=z[U.category_slug]||U.category_slug,J=U.approved_total_eur||0,K=`• ${P}: ${x(J)}`;t.text(K,18,u),u+=5,u>L-(W+20)&&(t.addPage(),u=j(t,y)+2,t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(...Y))}),u+=4})),u>L-(W+40)&&(t.addPage(),u=j(t,y)+4);const $=o.reduce((c,w)=>c+w.timesheets_total_eur,0),B=o.reduce((c,w)=>c+w.extras_total_eur,0),M=o.reduce((c,w)=>c+(w.expenses_total_eur||0),0),E=o.reduce((c,w)=>c+w.total_eur,0),q=t.internal.pageSize.getWidth()-28,T=M>0?40:32;t.setFillColor(...we),t.roundedRect(14,u,q,T,3,3,"F"),t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(...N),t.text("Totales del Trabajo",18,u+10),t.setFont("helvetica","normal"),t.setFontSize(10),t.setTextColor(...Y),t.text(`Total Partes: ${x($)}`,18,u+18),t.text(`Total Extras: ${x(B)}`,18,u+26);let k=u+22;M>0&&(t.text(`Total Gastos: ${x(M)}`,18,u+34),k=u+30);const f=`Total General: ${x(E)}`;t.setFont("helvetica","bold"),t.setFontSize(12),t.setTextColor(...N);const F=t.getTextWidth(f);t.text(f,14+q-F-6,k),xe(t,p??d);const v=`pago_${a.title.replace(/[^\w\s-]/g,"").replace(/\s+/g,"_")}_${ee(new Date,"yyyy-MM-dd")}.pdf`;if((e==null?void 0:e.download)===!1)return t.output("blob");t.save(v)}const Ze=30;function $e(o){return o.replace(/[^\w\s-]/g,"").replace(/\s+/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"").toLowerCase()}async function et(o){const a=await o.arrayBuffer(),i=new Uint8Array(a);let r="";const n=32768;for(let e=0;e<i.length;e+=n){const m=i.subarray(e,e+n);r+=String.fromCharCode(...m)}return btoa(r)}async function tt(o,a){const{data:i,error:r}=await o.from("jobs").select("id, title, start_time, tour_id, job_type, rates_approved").eq("id",a).maybeSingle();if(r||!i)throw r||new Error("Job not found");return i}async function ot(o,a){const{data:i,error:r}=await o.from("flex_work_orders").select("technician_id, lpo_number").eq("job_id",a);if(r)throw r;return new Map((i||[]).map(n=>[n.technician_id,n.lpo_number||null]))}async function nt(o,a){const{data:i,error:r}=await o.from("timesheets").select("technician_id, date, approved_by_manager").eq("job_id",a).eq("approved_by_manager",!0);if(r)throw r;return i||[]}async function at(o){var _;const{jobId:a,supabase:i,quotes:r,profiles:n}=o,e=await tt(i,a),m=await ot(i,a),s=await nt(i,a),t=new Map;s.forEach(l=>{!l.technician_id||!l.date||(t.has(l.technician_id)||t.set(l.technician_id,new Set),t.get(l.technician_id).add(l.date))});const d=new Map(n.map(l=>[l.id,l])),p=[],y=Array.from(new Set(r.map(l=>l.technician_id)));for(const l of y){const C=r.filter(E=>E.technician_id===l);if(!C.length)continue;const I=d.get(l),u=`${(I==null?void 0:I.first_name)??""} ${(I==null?void 0:I.last_name)??""}`.trim()||l;let L=0;(I==null?void 0:I.autonomo)===!1&&(L=(((_=t.get(l))==null?void 0:_.size)||0)*Ze);const H=await Ke(C,{id:e.id,title:e.title,start_time:e.start_time,tour_id:e.tour_id,job_type:e.job_type},n,m,{download:!1,timesheetMap:t});if(!H)continue;const A=await et(H),h=$e(e.title||e.id),$=$e(u),B=ee(new Date,"yyyy-MM-dd"),M=`pago_${h||e.id}_${$||l}_${B}.pdf`;p.push({technician_id:l,email:(I==null?void 0:I.email)??null,full_name:u,quote:C[0],deduction_eur:L,pdfBase64:A,filename:M,autonomo:(I==null?void 0:I.autonomo)??null})}const b=p.filter(l=>!l.email).map(l=>l.technician_id);return{job:e,quotes:r,profiles:n,lpoMap:m,attachments:p,missingEmails:b}}async function $t(o){const a=await at(o),i=new Set((o.technicianIds&&o.technicianIds.length?o.technicianIds:void 0)||a.attachments.map(s=>s.technician_id)),r=a.attachments.filter(s=>s.email&&i.has(s.technician_id));if(!r.length)return{success:!1,missingEmails:a.missingEmails,context:a,error:new Error("No technicians with email available")};const n={job:{id:a.job.id,title:a.job.title,start_time:a.job.start_time,tour_id:a.job.tour_id??null},technicians:r.map(s=>{const t=s.quote,d=Number(t.total_eur||0),p=Number(t.extras_total_eur||0),y=Number(t.total_with_extras_eur!=null?t.total_with_extras_eur:d+p),b=s.deduction_eur||0;return{technician_id:s.technician_id,email:s.email,full_name:s.full_name,totals:{timesheets_total_eur:d,extras_total_eur:p,total_eur:y-b,deduction_eur:b},pdf_base64:s.pdfBase64,filename:s.filename,autonomo:s.autonomo??null}}),missing_emails:a.missingEmails,requested_at:new Date().toISOString()},{data:e,error:m}=await o.supabase.functions.invoke("send-job-payout-email",{body:n});return{success:!m&&(e==null?void 0:e.success)!==!1,missingEmails:a.missingEmails,response:e,error:m,context:a}}const rt={responsable:"2915a190-c515-11ea-a087-2a0a4490a7fb",especialista:"f1224528-9038-486b-b1b8-a8085cb24651",tecnico:"2f6bdee0-c5c1-11ea-a087-2a0a4490a7fb"},Oe={responsable:"ec63fd59-d71f-4118-b016-0873451cb6e2",tecnico:"8505f640-caa0-11ea-a087-2a0a4490a7fb"},ve={transit:"d75261e0-caa0-11ea-a087-2a0a4490a7fb",dayOff:"cf6c13d0-caa6-11ea-a087-2a0a4490a7fb"};function it(o){return o?o.includes("-R")?"responsable":o.includes("-E")?"especialista":o.includes("-T")?"tecnico":null:null}function st(o,a){const i=it(a);if(!i)return null;switch(o){case"sound":return rt[i]||null;case"lights":return i==="responsable"?Oe.responsable:Oe.tecnico;case"video":return null;default:return null}}const lt=je.ordenTrabajo,ct=He.personnel,dt="d3d53320-6926-11ea-9bb5-2a0a4490a7fb",ut="a4307bf9-cd39-4df1-9d6d-48932120c4bd",mt="04c62780-c51d-11ea-a087-2a0a4490a7fb";let fe=null;async function _t(){if(fe)return fe;const{data:o,error:a}=await G.functions.invoke("get-secret",{body:{secretName:"X_AUTH_TOKEN"}});if(a)throw new Error(a.message||"Failed to resolve Flex auth token");const i=o==null?void 0:o.X_AUTH_TOKEN;if(!i)throw new Error("Flex auth token response missing X_AUTH_TOKEN");return fe=i,i}function _e(o){if(!o)return null;const a=new Date(o);return Number.isNaN(a.getTime())?null:a.toISOString().slice(0,10)}function ft(o){var n,e;const a=(n=o==null?void 0:o.first_name)==null?void 0:n.trim(),i=(e=o==null?void 0:o.last_name)==null?void 0:e.trim();return[a,i].filter(Boolean).join(" ")||"Sin nombre"}async function ht(o){var b,_,l,C;const{parentElementId:a,job:i,technicianName:r,vendorId:n,token:e}=o,m=_e(i.start_time)??new Date().toISOString().slice(0,10);_e(i.end_time);const s={definitionId:lt,parentElementId:a,open:!0,locked:!1,name:`Orden de Trabajo - ${i.title} (${r})`,personResponsibleId:ct,vendorId:n,currencyId:dt},t=await fetch(`${Z}/element`,{method:"POST",headers:{"Content-Type":"application/json",accept:"application/json","X-Auth-Token":e,apikey:e},body:JSON.stringify(s)});if(!t.ok){const I=await t.json().catch(()=>null),u=(I==null?void 0:I.exceptionMessage)||t.statusText||"Failed to create work order";throw new Error(u)}const d=await t.json().catch(()=>({})),p=(d==null?void 0:d.id)||(d==null?void 0:d.elementId)||((b=d==null?void 0:d.data)==null?void 0:b.id)||((_=d==null?void 0:d.data)==null?void 0:_.elementId)||((l=d==null?void 0:d.element)==null?void 0:l.id)||null,y=(d==null?void 0:d.documentNumber)||(d==null?void 0:d.elementNumber)||(d==null?void 0:d.number)||((C=d==null?void 0:d.data)==null?void 0:C.documentNumber)||null;if(!p)throw new Error("Flex work order creation succeeded without returning an element id");return{documentId:p,raw:{...d,documentNumber:y}}}async function gt(o,a){var r;const i=`${Z}/element/${encodeURIComponent(o)}/key-info/`;try{const n=await fetch(i,{headers:{"Content-Type":"application/json","X-Auth-Token":a,apikey:a}});if(!n.ok)return null;const e=await n.json().catch(()=>null),m=((r=e==null?void 0:e.documentNumber)==null?void 0:r.data)||(e==null?void 0:e.documentNumber)||null;return typeof m=="string"&&m.trim()?m:null}catch{return null}}async function le(o){var _;const{documentId:a,parentElementId:i,resourceId:r,quantity:n=1,token:e,managedResourceLineItemType:m="service-offering",parentLineItemId:s}=o,t=`${Z}/financial-document-line-item/${encodeURIComponent(a)}/add-resource/${encodeURIComponent(r)}`,d=new URLSearchParams({resourceParentId:i,managedResourceLineItemType:m,quantity:String(n)}),p=async l=>{try{const C=await fetch(`${t}?${d.toString()}`,l);return C.ok?await C.json().catch(()=>null):null}catch{return null}},y={accept:"*/*","X-Auth-Token":e,apikey:e};let b=null;if(s||(b=await p({method:"POST",headers:y})),!b){const l={...y,"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},C=new URLSearchParams({resourceParentId:i,managedResourceLineItemType:m,quantity:String(n),parentLineItemId:s??"",nextSiblingId:""});b=await p({method:"POST",headers:l,body:C.toString()})}return b?(b==null?void 0:b.id)||(b==null?void 0:b.lineItemId)||((_=b==null?void 0:b.data)==null?void 0:_.id)||(Array.isArray(b==null?void 0:b.addedResourceLineIds)?b.addedResourceLineIds[0]:null):null}async function he(o){const{documentId:a,lineItemId:i,pricingModelId:r,token:n}=o,e=`${Z}/financial-document-line-item/${encodeURIComponent(a)}/row-data/`;try{const m={"Content-Type":"application/json",accept:"application/json","X-Auth-Token":n,apikey:n,"X-Requested-With":"XMLHttpRequest","X-API-Client":"flex5-desktop"};if(await Fe({documentId:a,lineItemId:i,fieldType:"pricingModel",payloadValue:r,token:n}))return!0;let t=await fetch(e,{method:"POST",headers:m,body:JSON.stringify({lineItemId:i,fieldType:"pricingModel",payloadValue:r})});return t.ok?!0:(t=await fetch(e,{method:"POST",headers:m,body:JSON.stringify({lineItemId:i,fieldType:"pricing-model",payloadValue:r})}),t.ok)}catch{return!1}}async function bt(o){const{documentId:a,lineItemId:i,timeQty:r,token:n}=o,e=`${Z}/financial-document-line-item/${encodeURIComponent(a)}/row-data/`;try{const m={"Content-Type":"application/json",accept:"application/json","X-Auth-Token":n,apikey:n,"X-Requested-With":"XMLHttpRequest","X-API-Client":"flex5-desktop"};if(await Fe({documentId:a,lineItemId:i,fieldType:"timeQty",payloadValue:r,token:n}))return!0;let t=await fetch(e,{method:"POST",headers:m,body:JSON.stringify({lineItemId:i,fieldType:"timeQty",payloadValue:r})});return t.ok||(t=await fetch(e,{method:"POST",headers:m,body:JSON.stringify({lineItemId:i,fieldType:"time-qty",payloadValue:r})}),t.ok)?!0:(t=await fetch(e,{method:"POST",headers:m,body:JSON.stringify({lineItemId:i,fieldType:"timeQty",payloadValue:String(r)})}),t.ok)}catch{return!1}}async function pt(o){const{documentId:a,lineItemId:i,timeQty:r,token:n}=o,e=`${Z}/financial-document-line-item/${encodeURIComponent(a)}/bulk-update`;try{return(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",accept:"*/*","X-Auth-Token":n,apikey:n,"X-Requested-With":"XMLHttpRequest","X-API-Client":"flex5-desktop"},body:JSON.stringify({bulkData:[{itemId:i,timeQty:r}]})})).ok}catch{return!1}}async function Fe(o){const{documentId:a,lineItemId:i,fieldType:r,payloadValue:n,token:e}=o,m=`${Z}/financial-document-line-item/${encodeURIComponent(a)}/update`;try{return(await fetch(m,{method:"POST",headers:{"Content-Type":"application/json",accept:"application/json","X-Auth-Token":e,apikey:e,"X-Requested-With":"XMLHttpRequest","X-API-Client":"flex5-desktop"},body:JSON.stringify({lineItemId:i,fieldType:r,payloadValue:n})})).ok}catch{return!1}}async function yt(o){const{documentId:a,lineItemId:i,quantity:r,token:n}=o,e=`${Z}/financial-document-line-item/${encodeURIComponent(a)}/row-data/`;try{const m={"Content-Type":"application/json",accept:"application/json","X-Auth-Token":n,apikey:n,"X-Requested-With":"XMLHttpRequest","X-API-Client":"flex5-desktop"};if(await Fe({documentId:a,lineItemId:i,fieldType:"quantity",payloadValue:r,token:n}))return!0;let t=await fetch(e,{method:"POST",headers:m,body:JSON.stringify({lineItemId:i,fieldType:"quantity",payloadValue:r})});return t.ok?!0:(t=await fetch(e,{method:"POST",headers:m,body:JSON.stringify({lineItemId:i,fieldType:"quantity",payloadValue:String(r)})}),t.ok)}catch{return!1}}async function Tt(o){const{documentId:a,lineItemId:i,quantity:r,token:n}=o,e=`${Z}/financial-document-line-item/${encodeURIComponent(a)}/bulk-update`;try{return(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",accept:"*/*","X-Auth-Token":n,apikey:n,"X-Requested-With":"XMLHttpRequest","X-API-Client":"flex5-desktop"},body:JSON.stringify({bulkData:[{itemId:i,quantity:r}]})})).ok}catch{return!1}}async function Ot(o){var H,A;if(!o)throw new Error("Job id is required to sync Flex work orders");const a=[];let i=0,r=0;const n=await _t(),[{data:e,error:m}]=await Promise.all([G.from("jobs").select("id, title, start_time, end_time, location_id, job_type, tour_date_id").eq("id",o).maybeSingle()]);if(m)throw m;if(!e)throw new Error("Job not found");const s={folder_type:"work_orders",department:"personnel"};if(e.job_type==="tourdate"){if(!e.tour_date_id)throw new Error(`Tourdate job ${o} is missing tour_date_id`);s.tour_date_id=e.tour_date_id}else s.job_id=o;const{data:t,error:d}=await G.from("flex_folders").select("element_id, department").match(s);if(d)throw d;let p=(t||[]).find(h=>(h==null?void 0:h.department)==="personnel")||(t==null?void 0:t[0]);if(!(p!=null&&p.element_id)){const $={folder_type:e.job_type==="tourdate"?"tourdate":"department",department:"personnel"};e.job_type==="tourdate"?$.tour_date_id=e.tour_date_id:$.job_id=o;const{data:B,error:M}=await G.from("flex_folders").select("element_id").match($).maybeSingle();if(M)throw M;if(!(B!=null&&B.element_id))throw new Error(`Personnel folder not found for ${e.job_type==="tourdate"?"tour_date_id":"job_id"}: ${e.job_type==="tourdate"?e.tour_date_id:o}. Please create folders first.`);const E=_e(e.start_time)??new Date().toISOString().slice(0,10),Q=_e(e.end_time)??E,q={definitionId:je.subFolder,parentElementId:B.element_id,open:!0,locked:!1,name:`Órdenes de Trabajo - ${e.title} [${E} – ${Q}]`},T=await fetch(`${Z}/element`,{method:"POST",headers:{"Content-Type":"application/json",accept:"application/json","X-Auth-Token":n,apikey:n},body:JSON.stringify(q)});if(!T.ok){const R=await T.json().catch(()=>null);throw new Error(`Failed to create work orders folder in Flex: ${(R==null?void 0:R.exceptionMessage)||T.statusText}`)}const k=await T.json(),f=(k==null?void 0:k.id)||(k==null?void 0:k.elementId)||((H=k==null?void 0:k.data)==null?void 0:H.id);if(!f)throw new Error("Flex API created folder but returned no element ID");const F={parent_id:B.element_id,element_id:f,department:"personnel",folder_type:"work_orders"};e.job_type==="tourdate"?F.tour_date_id=e.tour_date_id:F.job_id=o;const{data:O,error:v}=await G.from("flex_folders").insert(F).select("element_id, department").single();if(v)throw v;p=O}const{data:y,error:b}=await G.from("job_assignments").select(`technician_id, sound_role, lights_role, video_role, status,
       profiles!job_assignments_technician_id_fkey(first_name, last_name, flex_resource_id, department)`).eq("job_id",o);if(b)throw b;const{data:_,error:l}=await G.from("job_rate_extras").select("technician_id, extra_type, quantity, status").eq("job_id",o);if(l)throw l;const C=new Map;_==null||_.forEach(h=>{if(!h||h.quantity<=0||h.status&&h.status!=="approved")return;const $=C.get(h.technician_id)||[];$.push(h),C.set(h.technician_id,$)});const{data:I,error:u}=await G.from("flex_work_orders").select("technician_id, flex_document_id").eq("job_id",o);if(u)throw u;const L=new Map((I||[]).map(h=>[h.technician_id,h.flex_document_id]));for(const h of y||[]){const $=h.technician_id;if(!$)continue;if(h.status==="declined"){r+=1;continue}if(L.has($)){r+=1;continue}const B=((A=h.profiles)==null?void 0:A.flex_resource_id)||null;if(!B){a.push(`Técnico ${$} no tiene Flex Resource ID, se omite la orden de trabajo.`),r+=1;continue}try{const M=ft(h.profiles||void 0),{documentId:E,raw:Q}=await ht({parentElementId:p.element_id,job:e,technicianName:M,vendorId:B,token:n});let q=Q&&(Q.documentNumber||Q.elementNumber||Q.number)||null;q||(q=await gt(E,n));const T=[];h.sound_role&&T.push({dept:"sound",role:h.sound_role}),h.lights_role&&T.push({dept:"lights",role:h.lights_role});for(const O of T){const v=st(O.dept,O.role);if(!v)continue;const R=e.job_type&&(e.job_type==="single"||e.job_type==="festival")?3:1,g=e.job_type&&(e.job_type==="tour"||e.job_type==="tourdate")?mt:ut,S=await le({documentId:E,parentElementId:p.element_id,resourceId:v,quantity:R,token:n,managedResourceLineItemType:"service-offering"});if(S||a.push(`No se pudo añadir el line item de ${O.dept} (${O.role}) para el técnico ${$}.`),S&&(await he({documentId:E,lineItemId:S,pricingModelId:g,token:n}),await yt({documentId:E,lineItemId:S,quantity:R,token:n}),await Tt({documentId:E,lineItemId:S,quantity:R,token:n}),await bt({documentId:E,lineItemId:S,timeQty:R,token:n}),await pt({documentId:E,lineItemId:S,timeQty:R,token:n})),S&&e.job_type&&(e.job_type==="single"||e.job_type==="festival")&&(O.dept==="sound"||O.dept==="lights")){const c=await le({documentId:E,parentElementId:p.element_id,resourceId:"14b84b51-2a96-4afd-a384-f86f18f039da",quantity:0,token:n,managedResourceLineItemType:"service-offering",parentLineItemId:S}),w=await le({documentId:E,parentElementId:p.element_id,resourceId:"7d5eaf16-4499-45e1-b705-b5f1513ea71f",quantity:0,token:n,managedResourceLineItemType:"service-offering",parentLineItemId:S});c&&await he({documentId:E,lineItemId:c,pricingModelId:g,token:n}),w&&await he({documentId:E,lineItemId:w,pricingModelId:g,token:n})}}const k=C.get($)||[];if(k.length>0){let O=0,v=0,R=0;for(const S of k)S.extra_type==="travel_half"&&(O+=S.quantity),S.extra_type==="travel_full"&&(v+=S.quantity),S.extra_type==="day_off"&&(R+=S.quantity);const g=O*1+v*2;g>0&&await le({documentId:E,parentElementId:p.element_id,resourceId:ve.transit,quantity:g,token:n,managedResourceLineItemType:"service-offering"}),R>0&&await le({documentId:E,parentElementId:p.element_id,resourceId:ve.dayOff,quantity:R,token:n,managedResourceLineItemType:"service-offering"})}const f={job_id:o,technician_id:$,flex_document_id:E,flex_element_id:E,folder_element_id:p==null?void 0:p.element_id,flex_vendor_id:B},{error:F}=await G.from("flex_work_orders").insert({...f,lpo_number:q});if(F)throw F;L.set($,E),i+=1}catch(M){a.push(`Fallo al crear orden de trabajo para técnico ${$}: ${M.message||"Error desconocido"}`)}}return{created:i,skipped:r,errors:a}}function vt(o,a,i){return qe({queryKey:["manager-job-quotes",o,a,i],enabled:!!o,queryFn:async()=>{if(!o)return[];const r=String(a||"").toLowerCase();if(r==="tourdate"){const{data:s,error:t}=await G.from("job_assignments").select("technician_id").eq("job_id",o);if(t)throw t;const d=Array.from(new Set((s||[]).map(y=>y.technician_id).filter(Boolean)));return d.length===0?[]:await Promise.all(d.map(async y=>{const{data:b,error:_}=await G.rpc("compute_tour_job_rate_quote_2025",{_job_id:o,_tech_id:y});if(_){const C=_.message||_.details||_.hint||String(_);return{job_id:o,technician_id:y,start_time:new Date().toISOString(),end_time:new Date().toISOString(),job_type:"tourdate",tour_id:i||"",title:"",is_house_tech:!1,is_tour_team_member:!1,category:"",base_day_eur:0,week_count:1,multiplier:1,per_job_multiplier:1,iso_year:null,iso_week:null,total_eur:0,extras:void 0,extras_total_eur:void 0,total_with_extras_eur:void 0,breakdown:{error:C,error_details:_}}}const l=b||{};return{job_id:l.job_id??o,technician_id:l.technician_id??y,start_time:l.start_time,end_time:l.end_time,job_type:l.job_type??"tourdate",tour_id:l.tour_id??i??"",title:l.title??"",is_house_tech:!!l.is_house_tech,is_tour_team_member:!!l.is_tour_team_member,category:l.category??"",base_day_eur:Number(l.base_day_eur??0),week_count:Number(l.week_count??1),multiplier:Number(l.multiplier??1),per_job_multiplier:l.per_job_multiplier!=null?Number(l.per_job_multiplier):void 0,iso_year:l.iso_year??null,iso_week:l.iso_week??null,total_eur:Number(l.total_eur??0),extras:l.extras,extras_total_eur:l.extras_total_eur!=null?Number(l.extras_total_eur):void 0,total_with_extras_eur:l.total_with_extras_eur!=null?Number(l.total_with_extras_eur):void 0,vehicle_disclaimer:l.vehicle_disclaimer,vehicle_disclaimer_text:l.vehicle_disclaimer_text,breakdown:l.breakdown??{}}}))}const{data:n,error:e}=await G.from("v_job_tech_payout_2025").select("job_id, technician_id, timesheets_total_eur, extras_total_eur, total_eur").eq("job_id",o);if(e)throw e;return(n||[]).map(s=>({job_id:s.job_id,technician_id:s.technician_id,start_time:new Date().toISOString(),end_time:new Date().toISOString(),job_type:r||"single",tour_id:i||"",title:"",is_house_tech:!1,is_tour_team_member:!1,category:"",base_day_eur:Number(s.timesheets_total_eur||0),week_count:1,multiplier:1,per_job_multiplier:1,iso_year:null,iso_week:null,total_eur:Number(s.timesheets_total_eur||0),extras:void 0,extras_total_eur:Number(s.extras_total_eur||0),total_with_extras_eur:Number(s.total_eur||0),breakdown:{}}))},staleTime:30*1e3})}export{Ct as S,Ot as a,Ke as b,Nt as c,Pt as d,Rt as g,$t as s,vt as u};
