import{s as d}from"./index-NZ6jJLfQ.js";const y={sound:"sound_job_tasks",lights:"lights_job_tasks",video:"video_job_tasks"};async function v(l){var m;const{taskId:s,department:u,actorId:i,source:o="manual",jobId:_,tourId:p}=l;try{const e=y[u];let a=i;if(!a){const{data:r,error:n}=await d.auth.getUser();a=((m=r==null?void 0:r.user)==null?void 0:m.id)||null}const{data:t,error:f}=await d.from(e).select("id, task_type, assigned_to, job_id, tour_id").eq("id",s).maybeSingle();if(f)throw new Error(f.message);const{error:c}=await d.from(e).update({status:"completed",progress:100,completed_at:new Date().toISOString(),completed_by:a,completion_source:o,updated_at:new Date().toISOString()}).eq("id",s);if(c)throw new Error(c.message);if(a){const r=new Set;a&&r.add(a),t!=null&&t.assigned_to&&r.add(t.assigned_to);try{d.functions.invoke("push",{body:{action:"broadcast",type:"task.completed",job_id:_||(t==null?void 0:t.job_id)||void 0,tour_id:p||(t==null?void 0:t.tour_id)||void 0,recipient_id:(t==null?void 0:t.assigned_to)||void 0,user_ids:Array.from(r),task_id:s,task_type:t==null?void 0:t.task_type,completion_source:o}})}catch{}}return{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function S(l){const{taskId:s,department:u,newStatus:i}=l;try{const o=y[u],_=i==="in_progress"?50:0,{error:p}=await d.from(o).update({status:i,progress:_,completed_at:null,completed_by:null,completion_source:null,updated_at:new Date().toISOString()}).eq("id",s);if(p)throw new Error(p.message);return{success:!0}}catch(o){return{success:!1,error:o instanceof Error?o.message:"Unknown error"}}}async function j(l){var m;const{jobId:s,tourId:u,taskType:i,department:o,actorId:_,source:p}=l;if(!s&&!u)return{success:!1,completedCount:0,error:"Either jobId or tourId must be provided"};try{let e=_;if(e===void 0){const{data:c,error:r}=await d.auth.getUser();e=((m=c==null?void 0:c.user)==null?void 0:m.id)||null}const a=p||`auto_${i.toLowerCase()}_doc`,t=o?[o]:["sound","lights","video"];let f=0;for(const c of t){const r=y[c];try{let n=d.from(r).select("id, task_type, status, assigned_to, job_id, tour_id").eq("task_type",i).neq("status","completed");s?n=n.eq("job_id",s):u&&(n=n.eq("tour_id",u));const{data:g,error:h}=await n;if(h||!g||g.length===0)continue;const w=g.map(b=>b.id),{error:k}=await d.from(r).update({status:"completed",progress:100,completed_at:new Date().toISOString(),completed_by:e,completion_source:a,updated_at:new Date().toISOString()}).in("id",w);if(k)continue;f+=g.length;for(const b of g)try{d.functions.invoke("push",{body:{action:"broadcast",type:"task.completed",job_id:b.job_id||void 0,tour_id:b.tour_id||void 0,task_id:b.id,task_type:i,completion_source:a}})}catch{}}catch{}}return{success:!0,completedCount:f}}catch(e){return{success:!1,completedCount:0,error:e instanceof Error?e.message:"Unknown error"}}}export{j as b,v as c,S as r};
