import{l as xe,u as Me,s as P,aa as Se,o as _e,j as e,M as Ne,r as b,i as O,c as Je,C as fs,W as bs,Y as vs,A as Ns,h as ve,m as js,a as V,f as Ye,n as W,B as L,ab as Xe,V as ys,I as J,Z as ws,_ as Ms,X as ge,R as ze,S as $s,t as _s,v as ks,w as Cs,x as ke,ac as Ze,U as Ss,e as zs,ad as Re,ae as Ue,a2 as Es,P as Ts,af as As}from"./index-NZ6jJLfQ.js";import{B as fe}from"./badge-vNTKF5RD.js";import{u as oe}from"./useQuery-kdg2pmgf.js";import{g as es}from"./roleCategory-BtQgWHfO.js";import{fetchTourLogo as ss}from"./logoUtils-D2o1jUVg.js";import{E as Ls}from"./ellipsis-vertical-zRAfIP3L.js";import{C as ie}from"./calendar-_Cj_Sgy-.js";import{F as je}from"./file-text-igU140SQ.js";import{C as ye}from"./chevron-right-Bn7Eu0F7.js";import{U as we}from"./user-E3OATBQk.js";import{C as Fs}from"./camera-DACJL5j2.js";import{e as K}from"./es-CSiFCUGj.js";import{R as Is}from"./receipt-CWKVL4Rh.js";import{M as as}from"./map-BKqH24gv.js";import{M as ts}from"./message-square-a2K2ewo9.js";import{E as Le}from"./euro-DgRTeGAz.js";import{B as ns}from"./briefcase-BrpPecAy.js";import{T as Rs}from"./TechnicianIncidentReportDialog-Bb0qWmts.js";import{L as is}from"./lightbulb-BU2ctenD.js";import{C as Ee}from"./clock-BXPvTWvY.js";import{a as pe,e as Us}from"./endOfWeek-BYLwoWuZ.js";import{a as he}from"./addMonths-j-Bb577B.js";import{u as Te}from"./useMutation-DluhVBs1.js";import{S as Ds,b as qs,c as Hs,d as Os}from"./sheet-DFFfLazF.js";import{S as Fe}from"./scroll-area-BHjMXddA.js";import{P as Bs}from"./plus-C3JQqq7t.js";import{C as Ie}from"./chevron-left-rq2ui83a.js";import{T as Ws}from"./tree-palm-s3dDhxOJ.js";import{s as De}from"./startOfMonth-B5dVCv8B.js";import{e as qe}from"./endOfMonth-Byhxb84j.js";import{e as Vs}from"./eachDayOfInterval-CPmiA2bk.js";import{i as Gs}from"./isSameDay-m1OvdnsV.js";import{A as rs,a as ls,b as Ks}from"./avatar-QSp4LpEt.js";import{u as Ps,P as Qs}from"./usePushNotifications-DXTVLUyg.js";import{P as ds}from"./phone-BlFwiuho.js";import{S as os}from"./save-z_re-Mcq.js";import{B as Js}from"./bell-eCP3MIu-.js";import{T as re}from"./triangle-alert-D6qN0F8g.js";import{L as He}from"./lock-Cr7oPkPT.js";import{S as Ys}from"./shield-DTqNciIb.js";import{E as Oe}from"./external-link-QJoXZ6ES.js";import{U as Xs}from"./user-x-CkJG0NMy.js";import{L as Zs}from"./log-out-ByMqfvmj.js";import{A as ea,b as sa,a as aa}from"./alert-BqA-5jRM.js";import{u as ta}from"./useTimesheets-C6aFxEBN.js";import{u as na}from"./useJobPayoutTotals-CXAavZS-.js";import{u as ia,a as ra}from"./useJobRatesApproval-DsfA8V9C.js";import{P as la,S as da}from"./index-vfKqQWY5.js";import{C as Be}from"./circle-alert-LZYNzZ7F.js";import{M as oa}from"./moon-Bp9lP4EQ.js";import{C as Ce}from"./circle-check-C0N48OpO.js";import{u as ca,c as We,a as xa}from"./useWeatherData-d0TEdKFc.js";import{G as Ae,P as ma}from"./places-restaurant-service-CakuSyx6.js";import{E as ua}from"./eye-BE_DouVP.js";import{D as cs}from"./download-C1rVE0-J.js";import{U as Ve,C as Ge}from"./utensils-Dv9wAVOh.js";import{S as pa}from"./sparkles-BZkmCd_8.js";import{M as ha,D as ga}from"./DirectMessagesList-C-bJnXYG.js";import{S as fa}from"./send-Uvkx0r_O.js";import{A as ba}from"./arrow-left-VpQwT4cv.js";import{U as va}from"./users-DMnpVLUq.js";import{S as Na}from"./SoundVisionInteractiveMap-BcnXjj1l.js";import{u as ja}from"./useTourRatesApproval-CR_t91JW.js";import{c as ya,g as wa,f as Ke,s as Pe}from"./tourRateMath-BOmIkfWO.js";import{I as Ma}from"./info-CpCfiYD2.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $a=xe("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _a=xe("BellOff",[["path",{d:"M8.7 3A6 6 0 0 1 18 8a21.3 21.3 0 0 0 .6 5",key:"o7mx20"}],["path",{d:"M17 17H3s3-2 3-9a4.67 4.67 0 0 1 .3-1.7",key:"16f1lm"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ka=xe("CreditCard",[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ca=xe("Radio",[["path",{d:"M4.9 19.1C1 15.2 1 8.8 4.9 4.9",key:"1vaf9d"}],["path",{d:"M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5",key:"u1ii0m"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5",key:"1j5fej"}],["path",{d:"M19.1 4.9C23 8.8 23 15.1 19.1 19",key:"10b0cb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sa=xe("Shuffle",[["path",{d:"m18 14 4 4-4 4",key:"10pe0f"}],["path",{d:"m18 2 4 4-4 4",key:"pucp1d"}],["path",{d:"M2 18h1.973a4 4 0 0 0 3.3-1.7l5.454-8.6a4 4 0 0 1 3.3-1.7H22",key:"1ailkh"}],["path",{d:"M2 6h1.972a4 4 0 0 1 3.6 2.2",key:"km57vx"}],["path",{d:"M22 18h-6.041a4 4 0 0 1-3.3-1.8l-.359-.45",key:"os18l9"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const za=xe("SlidersVertical",[["line",{x1:"4",x2:"4",y1:"21",y2:"14",key:"1p332r"}],["line",{x1:"4",x2:"4",y1:"10",y2:"3",key:"gb41h5"}],["line",{x1:"12",x2:"12",y1:"21",y2:"12",key:"hf2csr"}],["line",{x1:"12",x2:"12",y1:"8",y2:"3",key:"1kfi7u"}],["line",{x1:"20",x2:"20",y1:"21",y2:"16",key:"1lhrwl"}],["line",{x1:"20",x2:"20",y1:"12",y2:"3",key:"16vvfq"}],["line",{x1:"2",x2:"6",y1:"14",y2:"14",key:"1uebub"}],["line",{x1:"10",x2:"14",y1:"8",y2:"8",key:"1yglbp"}],["line",{x1:"18",x2:"22",y1:"16",y2:"16",key:"1jxqpz"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ea=xe("Speaker",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["circle",{cx:"12",cy:"14",r:"4",key:"1jruaj"}],["path",{d:"M12 14h.01",key:"1etili"}]]),Ta=()=>{const{user:s}=Me(),{data:t=[],isLoading:a,error:l,refetch:g}=oe({queryKey:["my-tours",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{data:r,error:M}=await P.from("tour_assignments").select(`
          role,
          department,
          notes,
          tours!inner (
            id,
            name,
            description,
            color,
            status,
            start_date,
            end_date,
            tour_dates (
              id,
              date
            )
          )
        `).eq("technician_id",s.id).eq("tours.status","active").order("tours(start_date)",{ascending:!0});if(M)throw M;return r.map(x=>{const N=x.tours,I=N.tour_dates||[],F=new Date,n=I.filter(f=>new Date(f.date)>=F).length;return{id:N.id,name:N.name,description:N.description,color:N.color,start_date:N.start_date,end_date:N.end_date,assignment_role:x.role,assignment_department:x.department,assignment_notes:x.notes,total_dates:I.length,upcoming_dates:n}})},enabled:!!(s!=null&&s.id)}),k=t.filter(r=>r.end_date?new Date(r.end_date)>=new Date:!0),p=t.filter(r=>r.end_date?new Date(r.end_date)<new Date:!1);return{tours:t,activeTours:k,completedTours:p,isLoading:a,error:l,refetch:g}},xs=({job:s,theme:t,isDark:a,onAction:l,isCrewChief:g,techName:k,onOpenObliqueStrategy:p})=>{var q,T;const r=s.jobs||s,M=(r==null?void 0:r.timezone)||"Europe/Madrid";let z="";if(r!=null&&r.start_time&&(r!=null&&r.end_time))try{const y=Se(new Date(r.start_time),M,"HH:mm"),u=Se(new Date(r.end_time),M,"HH:mm");z=`${y} - ${u}`}catch{z="Hora no disponible"}let x="Técnico";s.sound_role?x=_e(s.sound_role)||s.sound_role:s.lights_role?x=_e(s.lights_role)||s.lights_role:s.video_role?x=_e(s.video_role)||s.video_role:s.role&&(x=s.role);const N=((q=r==null?void 0:r.location)==null?void 0:q.name)||"Sin ubicación",F={production:"border-l-emerald-500",planning:"border-l-blue-500",confirmed:"border-l-emerald-500",pending:"border-l-amber-500"}[r==null?void 0:r.status]||"border-l-blue-500",n=((T=r==null?void 0:r.job_type)==null?void 0:T.toLowerCase())||"",f=n==="tourdate",E=n==="dryhire"||n==="dry_hire",C=!f&&!E,U=!E;return e.jsxs("div",{className:`rounded-xl border border-l-4 ${F} ${t.card} p-5 relative overflow-hidden group mb-4`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:`font-bold text-lg ${t.textMain}`,children:(r==null?void 0:r.title)||"Sin título"}),g&&p&&e.jsx("button",{onClick:y=>{y.stopPropagation(),p()},className:"text-purple-500/40 hover:text-purple-400 transition-colors p-1",title:"Estrategias Oblicuas",children:e.jsx(is,{size:16})})]}),e.jsxs("div",{className:`text-xs ${t.textMuted} flex items-center gap-2 mt-1`,children:[e.jsx(Ne,{size:12})," ",N]})]}),e.jsx("span",{className:`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${t.success}`,children:"Activo"})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-400 mb-5 flex-wrap",children:[z&&e.jsxs("div",{className:`flex items-center gap-1.5 px-2 py-1 rounded ${a?"bg-white/5 border border-white/5":"bg-slate-100 border border-slate-200"}`,children:[e.jsx(Ee,{size:12})," ",z]}),e.jsxs("div",{className:`flex items-center gap-1.5 px-2 py-1 rounded ${a?"bg-white/5 border border-white/5":"bg-slate-100 border border-slate-200"}`,children:[e.jsx(we,{size:12})," ",x]})]}),e.jsxs("div",{className:`grid gap-3 ${C?"grid-cols-2":"grid-cols-1"}`,children:[e.jsxs("button",{onClick:()=>l("details",r),className:`py-2.5 rounded-lg border border-dashed ${t.divider} ${t.textMuted} text-xs font-bold hover:bg-white/5 transition-colors flex items-center justify-center gap-2`,children:[e.jsx(je,{size:14})," Ver detalles"]}),C&&e.jsxs("button",{onClick:()=>l("timesheet",r),className:`py-2.5 rounded-lg ${t.accent} text-xs font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-900/20`,children:[e.jsx(Ee,{size:14})," Horas"]}),U&&e.jsx(Rs,{job:r,techName:k||"",labeled:!0,className:C?"col-span-2":"",theme:t,isDark:a})]})]})},Aa=({tour:s,theme:t,isDark:a,onNavigate:l})=>{const[g,k]=b.useState(null);b.useEffect(()=>{s.id&&ss(s.id).then(x=>k(x||null))},[s.id]);const p=s.total_dates>0?(s.total_dates-s.upcoming_dates)/s.total_dates*100:0,r=x=>{switch(x==null?void 0:x.toLowerCase()){case"sound":return e.jsx(Ea,{size:14,className:"text-blue-400"});case"lights":return e.jsx(za,{size:14,className:"text-amber-400"});case"video":return e.jsx(Fs,{size:14,className:"text-purple-400"});default:return e.jsx(we,{size:14,className:"text-gray-400"})}},M=x=>{switch(x==null?void 0:x.toLowerCase()){case"sound":return"Sonido";case"lights":return"Luces";case"video":return"Vídeo";default:return x||"Técnico"}},z=()=>{if(!s.start_date&&!s.end_date)return"Sin fechas";const x=s.start_date?O(new Date(s.start_date),"d 'de' MMM",{locale:K}):"",N=s.end_date?O(new Date(s.end_date),"d 'de' MMM, yyyy",{locale:K}):"";return x&&N?`${x} - ${N}`:x||N};return e.jsxs("div",{onClick:()=>l(s.id),className:`
        group relative overflow-hidden rounded-2xl border transition-all duration-300 cursor-pointer
        ${t.card} hover:border-blue-500/50
      `,children:[e.jsxs("div",{className:"h-28 w-full relative overflow-hidden",children:[e.jsx("div",{className:"w-full h-full flex items-center justify-center",style:{background:`linear-gradient(135deg, ${s.color||"#3b82f6"}33, ${a?"#0f1219":"#ffffff"})`},children:g?e.jsx("img",{src:g,alt:`${s.name} logo`,width:192,height:64,loading:"lazy",decoding:"async",className:"h-16 w-48 object-contain opacity-90",onError:x=>{const N=x.target;N.style.display="none"}}):e.jsx(Ca,{size:48,className:"opacity-10"})}),e.jsx("button",{onClick:x=>{x.stopPropagation()},className:"absolute top-3 right-3 p-1.5 rounded-lg bg-black/20 hover:bg-black/40 text-white backdrop-blur-sm transition-colors",children:e.jsx(Ls,{size:16})}),e.jsxs("div",{className:"absolute bottom-3 left-4 right-4",children:[e.jsx("h3",{className:`text-lg font-bold truncate ${t.textMain}`,children:s.name}),s.description&&e.jsx("p",{className:`text-xs ${t.textMuted} truncate`,children:s.description})]})]}),e.jsxs("div",{className:`px-4 py-3 flex items-center justify-between border-b border-dashed ${t.divider}`,children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs font-medium",children:[e.jsx(ie,{size:14,className:"text-blue-500"}),e.jsx("span",{className:t.textMain,children:z()})]}),e.jsxs("div",{className:`text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded ${a?"bg-gray-500/10 text-gray-400":"bg-slate-100 text-slate-500"}`,children:[s.total_dates," Fechas"]})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:`text-[10px] font-bold uppercase mb-2 ${t.textMuted}`,children:"Tu asignación"}),e.jsxs("div",{className:`p-3 rounded-xl border flex items-center justify-between ${a?"bg-[#151820] border-[#2a2e3b]":"bg-slate-50 border-slate-200"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[r(s.assignment_department),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:`font-bold text-sm ${t.textMain}`,children:s.assignment_role||"Técnico"}),e.jsx("span",{className:`text-[10px] ${t.textMuted}`,children:M(s.assignment_department)})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:`block font-mono text-xs font-bold ${t.textMain}`,children:s.upcoming_dates}),e.jsx("span",{className:"text-[10px] text-blue-500 font-bold",children:"próximas"})]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between text-[10px] mb-1",children:[e.jsx("span",{className:t.textMuted,children:"Progreso"}),e.jsxs("span",{className:t.textMain,children:[Math.round(p),"%"]})]}),e.jsx("div",{className:`h-1.5 w-full rounded-full overflow-hidden ${a?"bg-gray-800":"bg-gray-200"}`,children:e.jsx("div",{className:"h-full rounded-full transition-all duration-500",style:{width:`${p}%`,backgroundColor:s.color||"#3b82f6"}})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2",children:s.assignment_notes&&e.jsxs("span",{className:`flex items-center gap-1 px-2 py-1 rounded text-[10px] font-bold border ${a?"bg-[#1a1d26] text-gray-300 border-[#2a2e3b]":"bg-slate-100 text-slate-600 border-slate-200"}`,children:[e.jsx(je,{size:10})," Notas"]})}),e.jsx(ye,{size:16,className:`${t.textMuted} group-hover:translate-x-1 transition-transform`})]})]})]})},La=()=>{const{user:s}=Me(),t=Je(),{data:a=[],isLoading:l}=oe({queryKey:["pending-expenses-summary",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:r,error:M}=await js.from("job_expenses").select(`
          job_id,
          amount_eur,
          status,
          job:jobs(title)
        `).eq("technician_id",s.id).in("status",["draft","submitted"]);if(M)throw M;const z=new Map;return(r||[]).forEach(x=>{var I;const N=z.get(x.job_id)||{job_id:x.job_id,job_title:((I=x.job)==null?void 0:I.title)||"Sin título",count:0,total_eur:0};z.set(x.job_id,{...N,count:N.count+1,total_eur:N.total_eur+(x.amount_eur||0)})}),Array.from(z.values()).sort((x,N)=>N.total_eur-x.total_eur)},enabled:!!(s!=null&&s.id),staleTime:30*1e3}),g=r=>{t(`/jobs/${r}/timesheets`)};if(l||a.length===0)return null;const k=a.reduce((r,M)=>r+M.count,0),p=a.reduce((r,M)=>r+M.total_eur,0);return e.jsxs(fs,{children:[e.jsx(bs,{children:e.jsxs(vs,{className:"flex items-center gap-2 text-base",children:[e.jsx(Is,{className:"w-4 h-4"}),"Gastos Pendientes",e.jsx(fe,{variant:"secondary",className:"ml-auto",children:k})]})}),e.jsxs(Ns,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between pb-2 border-b",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Total pendiente"}),e.jsx("span",{className:"text-lg font-bold",children:ve(p)})]}),e.jsx("div",{className:"space-y-2",children:a.slice(0,5).map(r=>e.jsxs("div",{className:"flex items-center justify-between gap-2 p-2 rounded-md hover:bg-muted/50 transition-colors cursor-pointer",onClick:()=>g(r.job_id),children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:r.job_title}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r.count," ",r.count===1?"gasto":"gastos"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-semibold",children:ve(r.total_eur)}),e.jsx($a,{className:"w-4 h-4 text-muted-foreground"})]})]},r.job_id))}),a.length>5&&e.jsxs("p",{className:"text-xs text-center text-muted-foreground pt-2",children:["Y ",a.length-5," trabajo",a.length-5===1?"":"s"," más..."]})]})]})},Pt=({theme:s,isDark:t,user:a,userProfile:l,assignments:g,isLoading:k,onOpenAction:p,onOpenSV:r,onOpenObliqueStrategy:M,onOpenTour:z,onOpenRates:x,onOpenMessages:N,hasSoundVisionAccess:I})=>{var q,T,y,u;const{activeTours:F}=Ta(),n=l!=null&&l.first_name&&(l!=null&&l.last_name)?`${l.first_name[0]}${l.last_name[0]}`.toUpperCase():((T=(q=a==null?void 0:a.email)==null?void 0:q[0])==null?void 0:T.toUpperCase())||"?",f=l!=null&&l.first_name&&(l!=null&&l.last_name)?`${l.first_name} ${l.last_name}`:(a==null?void 0:a.email)||"Técnico",E=(l==null?void 0:l.role)==="house_tech"||g.some(m=>es(m)==="responsable"),C=g.find(m=>{const c=m.jobs||m;if(!(c!=null&&c.start_time))return!1;const $=new Date(c.start_time),H=new Date;return $.toDateString()===H.toDateString()});g.length*8;const U=(u=(y=g[0])==null?void 0:y.jobs)!=null&&u.start_time?Se(new Date(g[0].jobs.start_time),"Europe/Madrid","HH:mm"):"--:--";return e.jsxs("div",{className:"space-y-6 animate-in fade-in",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:`text-2xl font-bold ${s.textMain}`,children:"Panel"}),e.jsxs("p",{className:`text-xs ${s.textMuted}`,children:["Bienvenido, ",f]})]}),e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold shadow-lg",children:n})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:`p-2 rounded-xl border ${s.card}`,children:[e.jsx("div",{className:`text-[10px] font-bold uppercase ${s.textMuted} mb-1`,children:"Próximo turno"}),e.jsx("div",{className:`text-lg font-bold ${s.textMain}`,children:U})]}),e.jsxs("div",{className:`p-2 rounded-xl border ${s.card}`,children:[e.jsx("div",{className:`text-[10px] font-bold uppercase ${s.textMuted} mb-1`,children:"Esta semana"}),e.jsxs("div",{className:`text-lg font-bold ${s.textMain}`,children:[g.length," trabajos"]})]}),e.jsxs("div",{className:`p-2 rounded-xl border ${s.card} relative overflow-hidden`,children:[e.jsx("div",{className:"absolute inset-0 bg-blue-600/10"}),e.jsx("div",{className:"text-[10px] font-bold uppercase text-blue-400 mb-1",children:"Tours"}),e.jsx("div",{className:"text-lg font-bold text-blue-400",children:F.length})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:`text-xs font-bold uppercase ${s.textMuted} mb-3`,children:"Herramientas"}),e.jsxs("div",{className:"flex gap-3 overflow-x-auto no-scrollbar pb-2",children:[I&&e.jsxs("button",{onClick:r,className:`flex-shrink-0 w-28 h-24 p-3 rounded-xl border ${s.card} flex flex-col justify-between hover:border-blue-500 transition-colors text-left group`,children:[e.jsx(as,{size:20,className:"text-blue-500 group-hover:scale-110 transition-transform"}),e.jsxs("span",{className:`text-xs font-bold ${s.textMain}`,children:["SoundVision",e.jsx("br",{}),"Database"]})]}),e.jsxs("button",{onClick:N,className:`flex-shrink-0 w-28 h-24 p-3 rounded-xl border ${s.card} flex flex-col justify-between hover:border-purple-500 transition-colors text-left group`,children:[e.jsx(ts,{size:20,className:"text-purple-500 group-hover:scale-110 transition-transform"}),e.jsx("span",{className:`text-xs font-bold ${s.textMain}`,children:"Mensajes"})]}),e.jsxs("button",{onClick:x,className:`flex-shrink-0 w-28 h-24 p-3 rounded-xl border ${s.card} flex flex-col justify-between hover:border-emerald-500 transition-colors text-left group`,children:[e.jsx(Le,{size:20,className:"text-emerald-500 group-hover:scale-110 transition-transform"}),e.jsxs("span",{className:`text-xs font-bold ${s.textMain}`,children:["Mis",e.jsx("br",{}),"tarifas"]})]})]})]}),F.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h2",{className:`text-sm font-bold uppercase tracking-wider ${s.textMuted}`,children:"Mis giras"}),e.jsx(fe,{variant:"outline",children:F.length})]}),e.jsx("div",{className:"flex gap-4 overflow-x-auto no-scrollbar pb-2 -mx-2 px-2",children:F.map(m=>e.jsx("div",{className:"flex-shrink-0 w-72",children:e.jsx(Aa,{tour:m,theme:s,isDark:t,onNavigate:z})},m.id))})]}),e.jsx(La,{}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h2",{className:`text-sm font-bold uppercase tracking-wider ${s.textMuted}`,children:"Asignación de hoy"}),e.jsx("span",{className:"text-[10px] text-blue-500 font-bold",children:O(new Date,"dd MMM",{locale:K})})]}),k?e.jsx("div",{className:`p-8 rounded-xl border ${s.card} flex items-center justify-center`,children:e.jsx(V,{className:"h-6 w-6 animate-spin text-blue-500"})}):C?e.jsx(xs,{job:C,theme:s,isDark:t,onAction:p,isCrewChief:E,techName:f,onOpenObliqueStrategy:M}):e.jsxs("div",{className:`p-8 rounded-xl border ${s.card} text-center`,children:[e.jsx(ns,{size:32,className:`mx-auto mb-2 ${s.textMuted}`}),e.jsx("p",{className:`text-sm ${s.textMuted}`,children:"Sin asignaciones para hoy"})]})]})]})},Qt=({theme:s,isDark:t,assignments:a,isLoading:l,onOpenAction:g,techName:k,onOpenObliqueStrategy:p})=>{const[r,M]=b.useState("upcoming"),[z,x]=b.useState("2weeks"),N=a.some(f=>es(f)==="responsable"),I=()=>{const f=new Date;let E,C;if(r==="upcoming")switch(E=f,z){case"1week":C=pe(f,1);break;case"2weeks":C=pe(f,2);break;case"1month":C=he(f,1);break;case"3months":C=he(f,3);break;default:C=pe(f,2)}else switch(C=f,z){case"1week":E=pe(f,-1);break;case"2weeks":E=pe(f,-2);break;case"1month":E=he(f,-1);break;case"3months":E=he(f,-3);break;default:E=pe(f,-2)}return{startDate:E,endDate:C}},F=a.filter(f=>{const E=f.jobs||f;if(!(E!=null&&E.start_time))return!1;const C=new Date(E.start_time),{startDate:U,endDate:q}=I();return r==="upcoming"?C>=U&&C<=q:C>=U&&C<q}),n=r==="upcoming"?[{value:"1week",label:"Próxima semana"},{value:"2weeks",label:"Próximas 2 semanas"},{value:"1month",label:"Próximo mes"},{value:"3months",label:"Próximos 3 meses"}]:[{value:"1week",label:"Semana pasada"},{value:"2weeks",label:"Últimas 2 semanas"},{value:"1month",label:"Mes pasado"},{value:"3months",label:"Últimos 3 meses"}];return e.jsxs("div",{className:"space-y-4 animate-in fade-in",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:`text-2xl font-bold ${s.textMain}`,children:"Mis trabajos"}),e.jsxs(fe,{variant:"outline",children:[F.length," asignaciones"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs("div",{className:`flex rounded-xl p-1 ${t?"bg-[#0a0c10]":"bg-slate-100"}`,children:[e.jsx("button",{onClick:()=>M("upcoming"),className:`flex-1 px-4 py-2 rounded-lg text-xs font-bold transition-all ${r==="upcoming"?`${s.accent} shadow-md`:s.textMuted}`,children:"Próximos"}),e.jsx("button",{onClick:()=>M("past"),className:`flex-1 px-4 py-2 rounded-lg text-xs font-bold transition-all ${r==="past"?`${s.accent} shadow-md`:s.textMuted}`,children:"Pasados"})]}),e.jsx("div",{className:"flex-1 sm:flex-none",children:e.jsx("select",{value:z,onChange:f=>x(f.target.value),className:`w-full sm:w-auto px-4 py-2 rounded-xl text-xs font-bold border ${s.input} ${s.card} appearance-none cursor-pointer`,children:n.map(f=>e.jsx("option",{value:f.value,children:f.label},f.value))})})]}),l?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(V,{className:"h-8 w-8 animate-spin text-blue-500"})}):F.length===0?e.jsxs("div",{className:`p-12 rounded-xl border ${s.card} text-center`,children:[e.jsx(ns,{size:48,className:`mx-auto mb-4 ${s.textMuted}`}),e.jsx("p",{className:s.textMuted,children:r==="upcoming"?"No tienes asignaciones próximas en este periodo":"No tienes asignaciones pasadas en este periodo"})]}):e.jsx("div",{className:"space-y-4",children:F.map((f,E)=>e.jsx(xs,{job:f,theme:s,isDark:t,onAction:g,isCrewChief:N,techName:k,onOpenObliqueStrategy:p},f.id||E))})]})},Jt=({theme:s,isDark:t})=>{const{user:a}=Me(),l=Ye(),[g,k]=b.useState(new Date),[p,r]=b.useState(!1),[M,z]=b.useState(""),[x,N]=b.useState(""),[I,F]=b.useState(null),{data:n=[],isLoading:f}=oe({queryKey:["my-unavailability",a==null?void 0:a.id],queryFn:async()=>{if(!(a!=null&&a.id))return[];const{data:c,error:$}=await P.from("technician_availability").select("id, technician_id, date, status, created_at").eq("technician_id",a.id).order("date",{ascending:!0});if($)throw $;return c||[]},enabled:!!(a!=null&&a.id)}),E=Te({mutationFn:async c=>{if(!(a!=null&&a.id))return;const $=[],H=new Date(c.startDate+"T00:00"),R=new Date(c.endDate+"T00:00");if(isNaN(H.getTime())||isNaN(R.getTime())||R<H)throw new Error("Invalid date range");const d=new Intl.DateTimeFormat("en-CA",{timeZone:"Europe/Madrid",year:"numeric",month:"2-digit",day:"2-digit"});for(let S=new Date(H);S<=R;S.setDate(S.getDate()+1)){const D=d.format(S);$.push({technician_id:a.id,date:D,status:"day_off"})}const{error:A}=await P.from("technician_availability").upsert($,{onConflict:"technician_id,date"});if(A)throw A},onSuccess:()=>{W.success("Fechas marcadas como no disponibles"),l.invalidateQueries({queryKey:["my-unavailability"]}),r(!1),z(""),N("")},onError:c=>{const $=c instanceof Error?c.message:"No se pudo crear";W.error($)}}),C=Te({mutationFn:async c=>{const{error:$}=await P.from("technician_availability").delete().eq("id",c);if($)throw $},onMutate:c=>{F(c)},onSuccess:()=>{W.success("Disponibilidad restaurada"),l.invalidateQueries({queryKey:["my-unavailability"]})},onError:c=>{const $=c instanceof Error?c.message:"No se pudo eliminar";W.error($)},onSettled:()=>{F(null)}}),U=De(g),q=qe(g),T=Vs({start:U,end:q}),y=c=>{const $=O(c,"yyyy-MM-dd");return n.find(H=>H.date===$)},u={vacation:"bg-amber-500/20 text-amber-500",travel:"bg-sky-500/20 text-sky-500",sick:"bg-rose-500/20 text-rose-500",day_off:"bg-emerald-500/20 text-emerald-500"},m=b.useMemo(()=>{if(!n.length)return[];const c=De(g),$=qe(g),H=O(c,"yyyy-MM-dd"),R=O($,"yyyy-MM-dd");return n.filter(d=>d.date>=H&&d.date<=R)},[n,g]);return e.jsxs("div",{className:"space-y-6 animate-in fade-in",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:`text-2xl font-bold ${s.textMain}`,children:"Disponibilidad"}),e.jsxs(L,{size:"sm",onClick:()=>r(!0),children:[e.jsx(Bs,{size:14,className:"mr-1"})," Añadir"]})]}),e.jsx("div",{className:`p-4 rounded-xl border ${s.card} ${s.textMuted} text-sm`,children:e.jsxs("p",{className:"leading-relaxed",children:[e.jsx("strong",{className:s.textMain,children:"¿Cómo funciona?"}),e.jsx("br",{}),"Marca aquí los días en los que ",e.jsx("strong",{children:"no estás disponible"})," para trabajar con nosotros. Esto puede ser por vacaciones, compromisos con otros clientes, o cualquier otro motivo. Así evitamos enviarte ofertas para fechas en las que no puedes trabajar."]})}),e.jsxs("div",{className:`p-4 rounded-2xl border ${s.card}`,children:[e.jsxs("div",{className:"flex justify-between mb-4",children:[e.jsx("span",{className:`font-bold ${s.textMain}`,children:O(g,"MMMM yyyy",{locale:K})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{variant:"ghost",size:"icon",onClick:()=>k(he(g,-1)),children:e.jsx(Ie,{size:16,className:s.textMuted})}),e.jsx(L,{variant:"ghost",size:"icon",onClick:()=>k(he(g,1)),children:e.jsx(ye,{size:16,className:s.textMuted})})]})]}),e.jsx("div",{className:"grid grid-cols-7 gap-2 text-center text-xs font-bold text-gray-500 mb-2",children:["L","M","X","J","V","S","D"].map(c=>e.jsx("span",{children:c},c))}),e.jsxs("div",{className:"grid grid-cols-7 gap-2",children:[Array.from({length:(U.getDay()+6)%7}).map((c,$)=>e.jsx("div",{className:"h-9"},`empty-${$}`)),T.map((c,$)=>{const H=y(c),R=Gs(c,new Date);return e.jsx("div",{className:`h-9 rounded-lg flex items-center justify-center text-sm transition-colors ${R?"bg-blue-600 text-white shadow-lg font-bold":H?u[H.status]||"bg-emerald-500/20 text-emerald-500":s.textMuted}`,children:O(c,"d")},$)})]})]}),f?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(V,{className:"h-5 w-5 animate-spin text-blue-500"})}):m.length===0?e.jsx("div",{className:`p-4 rounded-xl border ${s.card} text-center`,children:e.jsxs("p",{className:`text-sm ${s.textMuted}`,children:["No hay fechas marcadas como no disponibles para ",O(g,"MMMM yyyy",{locale:K})]})}):e.jsx(Fe,{className:"h-[400px] rounded-xl",children:e.jsx("div",{className:"space-y-2 pr-4",children:m.map(c=>e.jsxs("div",{className:`p-3 rounded-xl border ${s.card} flex items-center justify-between`,children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center ${u[c.status]||"bg-emerald-500/10"}`,children:e.jsx(Ws,{size:18})}),e.jsxs("div",{children:[e.jsx("div",{className:`text-sm font-bold ${s.textMain}`,children:c.status==="vacation"?"Vacaciones":c.status==="travel"?"Viaje":c.status==="sick"?"Baja médica":"No disponible"}),e.jsx("div",{className:`text-xs ${s.textMuted}`,children:O(Xe(c.date),"PPP",{locale:K})})]})]}),e.jsx(L,{variant:"ghost",size:"icon",onClick:()=>C.mutate(c.id),disabled:C.isPending&&I===c.id,children:C.isPending&&I===c.id?e.jsx(V,{className:"h-4 w-4 animate-spin"}):e.jsx(ys,{size:16,className:s.textMuted})})]},c.id))})}),e.jsx(Ds,{open:p,onOpenChange:r,children:e.jsxs(qs,{side:"bottom",className:`rounded-t-2xl ${t?"bg-[#0f1219]":"bg-white"}`,children:[e.jsx(Hs,{className:"mb-6",children:e.jsx(Os,{className:s.textMain,children:"Marcar no disponible"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold uppercase mb-2 block ${s.textMuted}`,children:"Fecha inicio"}),e.jsx(J,{type:"date",value:M,onChange:c=>z(c.target.value),className:s.input})]}),e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold uppercase mb-2 block ${s.textMuted}`,children:"Fecha fin"}),e.jsx(J,{type:"date",value:x,onChange:c=>N(c.target.value),className:s.input})]}),e.jsx(L,{className:"w-full",disabled:!M||!x||E.isPending,onClick:()=>E.mutate({startDate:M,endDate:x}),children:E.isPending?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"h-4 w-4 animate-spin mr-2"}),"Guardando..."]}):"Marcar no disponible"})]})]})})]})},Yt=({theme:s,isDark:t,user:a,userProfile:l,toggleTheme:g})=>{var B,Y,se;const k=Je(),p=Ye(),[r,M]=b.useState((l==null?void 0:l.bg_color)||"#3b82f6"),{isSupported:z,permission:x,subscription:N,isInitializing:I,isEnabling:F,isDisabling:n,error:f,enable:E,disable:C,canEnable:U}=Ps(),[q,T]=b.useState(!1),[y,u]=b.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[m,c]=b.useState(!1),[$,H]=b.useState((l==null?void 0:l.calendar_ics_token)||""),[R,d]=b.useState((l==null?void 0:l.first_name)||""),[A,S]=b.useState((l==null?void 0:l.last_name)||""),[D,G]=b.useState((l==null?void 0:l.phone)||""),[Z,ae]=b.useState((l==null?void 0:l.residencia)||""),[te,X]=b.useState((l==null?void 0:l.dni)||"");b.useEffect(()=>{l&&(d(l.first_name||""),S(l.last_name||""),G(l.phone||""),ae(l.residencia||""),X(l.dni||""),M(l.bg_color||"#3b82f6"),H(l.calendar_ics_token||""))},[l]);const ne=R&&A?`${R[0]}`.toUpperCase():((Y=(B=a==null?void 0:a.email)==null?void 0:B[0])==null?void 0:Y.toUpperCase())||"?",Q=R&&A?`${R} ${A}`:(a==null?void 0:a.email)||"Técnico",ee={technician:"Técnico",house_tech:"Técnico de sala",admin:"Administrador",management:"Gestión"}[l==null?void 0:l.role]||(l==null?void 0:l.role)||"Técnico",me={sound:"Sonido",lights:"Luces",video:"Vídeo"}[(se=l==null?void 0:l.department)==null?void 0:se.toLowerCase()]||(l==null?void 0:l.department)||"",ue=async()=>{await P.auth.signOut(),k("/")},ce=async()=>{if(y.newPassword!==y.confirmPassword){W.error("Las contraseñas nuevas no coinciden");return}if(y.newPassword.length<6){W.error("La contraseña debe tener al menos 6 caracteres");return}c(!0);try{const{error:j}=await P.auth.signInWithPassword({email:(a==null?void 0:a.email)||"",password:y.currentPassword});if(j){W.error("La contraseña actual no es correcta");return}const{error:v}=await P.auth.updateUser({password:y.newPassword});if(v)throw v;W.success("Contraseña actualizada correctamente"),T(!1),u({currentPassword:"",newPassword:"",confirmPassword:""})}catch(j){const v=j instanceof Error?j.message:"Error al cambiar la contraseña";W.error(v)}finally{c(!1)}},w=$&&(a!=null&&a.id)?`webcal://${ws.replace(/^https?:\/\//,"")}/functions/v1/tech-calendar-ics?tid=${a.id}&token=${$}&apikey=${Ms}&back=90&fwd=365`:"",i=()=>{if(!w){W.error("No tienes un enlace de calendario configurado");return}window.location.href=w},o=async()=>{try{await E(),W.success("Notificaciones push activadas")}catch(j){const v=j instanceof Error?j.message:"Error al activar notificaciones";W.error(v)}},h=async()=>{try{await C(),W.success("Notificaciones push desactivadas")}catch(j){const v=j instanceof Error?j.message:"Error al desactivar notificaciones";W.error(v)}},_=Te({mutationFn:async()=>{if(!(a!=null&&a.id))throw new Error("No user");const j={first_name:R,last_name:A,phone:D,dni:te,residencia:Z,bg_color:r},{data:v,error:be}=await P.from("profiles").update(j).eq("id",a.id).select().single();if(be)throw be;return v},onSuccess:j=>{W.success("Perfil actualizado"),p.setQueryData(["user-profile",a==null?void 0:a.id],v=>({...v,...j})),p.invalidateQueries({queryKey:["user-profile",a==null?void 0:a.id]})},onError:j=>{const v=j instanceof Error?j.message:"Error desconocido";W.error(`Error: ${v}`)}});return e.jsxs("div",{className:"space-y-6 animate-in fade-in pb-8",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:`text-2xl font-bold ${s.textMain}`,children:"Perfil"}),e.jsx("button",{onClick:g,className:`text-xs font-bold px-3 py-1.5 rounded-lg border ${s.card} ${s.textMuted}`,children:t?"Modo claro":"Modo oscuro"})]}),e.jsxs("div",{className:`p-6 rounded-2xl border flex flex-col items-center text-center relative overflow-hidden ${s.card}`,children:[e.jsx("div",{className:"absolute top-0 left-0 w-full h-24 opacity-20",style:{backgroundColor:r}}),e.jsx("div",{className:"relative mt-4 mb-4",children:a!=null&&a.id?e.jsx(Qs,{userId:a.id,currentPictureUrl:l==null?void 0:l.profile_picture_url,userInitials:ne,onUploadComplete:j=>{p.setQueryData(["user-profile",a.id],v=>({...v??{},profile_picture_url:j}))},onRemove:()=>{p.setQueryData(["user-profile",a.id],j=>({...j??{},profile_picture_url:null}))},size:"lg",showCameraIcon:!0}):e.jsx(rs,{className:"h-32 w-32",children:e.jsx(ls,{className:"text-lg font-semibold",children:ne})})}),e.jsx("h2",{className:`text-xl font-bold ${s.textMain}`,children:Q}),e.jsxs("p",{className:`text-sm ${s.textMuted}`,children:[ee," • ",me]})]}),e.jsxs("div",{className:`p-5 rounded-2xl border ${s.card}`,children:[e.jsxs("h3",{className:`flex items-center gap-2 font-bold mb-4 ${s.textMain}`,children:[e.jsx(we,{size:18,className:"text-blue-500"})," Información Personal"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold mb-1.5 block ml-1 ${s.textMuted}`,children:"Nombre"}),e.jsx(J,{value:R,onChange:j=>d(j.target.value),className:s.input})]}),e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold mb-1.5 block ml-1 ${s.textMuted}`,children:"Apellidos"}),e.jsx(J,{value:A,onChange:j=>S(j.target.value),className:s.input})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold mb-1.5 block ml-1 ${s.textMuted}`,children:"Teléfono"}),e.jsxs("div",{className:"relative",children:[e.jsx(ds,{size:16,className:`absolute left-3 top-3 ${s.textMuted}`}),e.jsx(J,{value:D,onChange:j=>G(j.target.value),className:`pl-10 ${s.input}`})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold mb-1.5 block ml-1 ${s.textMuted}`,children:"Ciudad"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{size:16,className:`absolute left-3 top-3 ${s.textMuted}`}),e.jsx(J,{value:Z,onChange:j=>ae(j.target.value),className:`pl-10 ${s.input}`})]})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:`text-xs font-bold mb-1.5 block ml-1 ${s.textMuted}`,children:"DNI / NIE"}),e.jsxs("div",{className:"relative",children:[e.jsx(ka,{size:16,className:`absolute left-3 top-3 ${s.textMuted}`}),e.jsx(J,{value:te,onChange:j=>X(j.target.value),className:`pl-10 ${s.input}`})]})]}),e.jsx(L,{className:"w-full mt-4",onClick:()=>_.mutate(),disabled:_.isPending,children:_.isPending?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"h-4 w-4 animate-spin mr-2"})," Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(os,{size:16,className:"mr-2"})," Guardar cambios"]})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:`text-xs font-bold uppercase tracking-wider mb-3 mt-6 px-1 ${s.textMuted}`,children:"Ajustes de App"}),e.jsxs("div",{className:`p-4 rounded-xl border mb-3 ${s.card}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${N?"bg-emerald-500/10 text-emerald-500":"bg-blue-500/10 text-blue-400"}`,children:N?e.jsx(Js,{size:18}):e.jsx(_a,{size:18})}),e.jsxs("div",{children:[e.jsx("div",{className:`font-bold text-sm ${s.textMain}`,children:"Notificaciones Push"}),e.jsx("div",{className:`text-xs mt-0.5 ${s.textMuted}`,children:I?"Cargando...":x==="denied"?"Bloqueadas en el navegador":N?"Activadas":"Desactivadas"})]})]}),I?e.jsx(V,{size:20,className:"animate-spin text-blue-500"}):x==="denied"?e.jsx("span",{className:`text-xs px-2 py-1 rounded ${t?"bg-red-500/10 text-red-400":"bg-red-50 text-red-600"}`,children:"Bloqueado"}):N?e.jsxs(L,{size:"sm",variant:"outline",onClick:h,disabled:n,className:"text-xs",children:[n?e.jsx(V,{size:14,className:"animate-spin mr-1"}):null,"Desactivar"]}):U?e.jsxs(L,{size:"sm",onClick:o,disabled:F,className:"text-xs bg-blue-600 hover:bg-blue-500 text-white",children:[F?e.jsx(V,{size:14,className:"animate-spin mr-1"}):null,"Activar"]}):null]}),f&&e.jsxs("div",{className:`mt-3 p-2 rounded-lg text-xs flex items-center gap-2 ${t?"bg-amber-500/10 text-amber-400":"bg-amber-50 text-amber-700"}`,children:[e.jsx(re,{size:14}),f]}),x==="denied"&&e.jsx("div",{className:`mt-3 p-2 rounded-lg text-xs ${t?"bg-white/5":"bg-slate-50"} ${s.textMuted}`,children:"Para activar las notificaciones, debes desbloquearlas en la configuración de tu navegador."}),!z&&e.jsx("div",{className:`mt-3 p-2 rounded-lg text-xs ${t?"bg-white/5":"bg-slate-50"} ${s.textMuted}`,children:"Las notificaciones push no están soportadas en este navegador."})]}),e.jsxs("div",{onClick:i,className:`p-4 rounded-xl border mb-3 flex items-center justify-between cursor-pointer ${t?"hover:bg-white/5":"hover:bg-slate-50"} transition-colors ${s.card}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-500/10 rounded-lg text-purple-400",children:e.jsx(ie,{size:18})}),e.jsxs("div",{children:[e.jsx("div",{className:`font-bold text-sm ${s.textMain}`,children:"Sincronizar Calendario"}),e.jsx("div",{className:`text-xs ${s.textMuted}`,children:"Google / Apple Calendar (ICS)"})]})]}),e.jsx(ye,{size:18,className:s.textMuted})]}),e.jsxs("div",{onClick:()=>T(!0),className:`p-4 rounded-xl border mb-3 flex items-center justify-between cursor-pointer ${t?"hover:bg-white/5":"hover:bg-slate-50"} transition-colors ${s.card}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-500/10 rounded-lg text-blue-400",children:e.jsx(He,{size:18})}),e.jsxs("div",{children:[e.jsx("div",{className:`font-bold text-sm ${s.textMain}`,children:"Cambiar Contraseña"}),e.jsx("div",{className:`text-xs ${s.textMuted}`,children:"Gestiona tu contraseña de acceso"})]})]}),e.jsx(ye,{size:18,className:s.textMuted})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:`text-xs font-bold uppercase tracking-wider mb-3 mt-6 px-1 ${s.textMuted}`,children:"Datos y Privacidad"}),e.jsxs("a",{href:"/privacy",target:"_blank",rel:"noreferrer",className:`p-4 rounded-xl border mb-3 flex items-center justify-between ${t?"hover:bg-white/5":"hover:bg-slate-50"} transition-colors ${s.card}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-500/10 rounded-lg text-blue-400",children:e.jsx(Ys,{size:18})}),e.jsxs("div",{children:[e.jsx("div",{className:`font-bold text-sm ${s.textMain}`,children:"Política de Privacidad"}),e.jsx("div",{className:`text-xs ${s.textMuted}`,children:"Consulta cómo tratamos tus datos"})]})]}),e.jsx(Oe,{size:18,className:s.textMuted})]}),e.jsxs("a",{href:"mailto:info@sector-pro.com?subject=Solicitud%20de%20eliminacion%20de%20cuenta",className:`p-4 rounded-xl border mb-3 flex items-center justify-between hover:bg-red-500/5 transition-colors ${s.card} border-red-500/20`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-red-500/10 rounded-lg text-red-400",children:e.jsx(Xs,{size:18})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-bold text-sm text-red-500",children:"Eliminar mi cuenta"}),e.jsx("div",{className:`text-xs ${s.textMuted}`,children:"Solicita la eliminación permanente de tus datos"})]})]}),e.jsx(Oe,{size:18,className:"text-red-400"})]})]}),e.jsxs("button",{onClick:ue,className:"w-full py-4 mt-4 text-red-500 font-bold text-sm bg-red-500/5 border border-red-500/20 rounded-xl flex items-center justify-center gap-2 hover:bg-red-500/10 transition-colors",children:[e.jsx(Zs,{size:18})," Cerrar Sesión"]}),e.jsx("div",{className:`text-center text-xs mt-6 ${s.textMuted}`,children:"Versión 2.4.1 (Build 2930)"}),q&&e.jsx("div",{className:`fixed inset-0 z-[70] flex items-center justify-center ${s.modalOverlay} p-4 animate-in fade-in duration-200`,children:e.jsxs("div",{className:`w-full max-w-md ${t?"bg-[#0f1219]":"bg-white"} rounded-2xl border ${s.divider} shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200`,children:[e.jsxs("div",{className:`p-4 border-b ${s.divider} flex justify-between items-center`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-500 text-white",children:e.jsx(He,{size:18})}),e.jsx("h2",{className:`text-lg font-bold ${s.textMain}`,children:"Cambiar Contraseña"})]}),e.jsx("button",{onClick:()=>T(!1),className:`p-2 ${s.textMuted} hover:${s.textMain} rounded-full transition-colors`,children:e.jsx(ge,{size:20})})]}),e.jsxs("div",{className:"p-5 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold mb-1.5 block ${s.textMuted}`,children:"Contraseña actual"}),e.jsx(J,{type:"password",value:y.currentPassword,onChange:j=>u({...y,currentPassword:j.target.value}),className:s.input,placeholder:"••••••••"})]}),e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold mb-1.5 block ${s.textMuted}`,children:"Nueva contraseña"}),e.jsx(J,{type:"password",value:y.newPassword,onChange:j=>u({...y,newPassword:j.target.value}),className:s.input,placeholder:"••••••••"})]}),e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold mb-1.5 block ${s.textMuted}`,children:"Confirmar nueva contraseña"}),e.jsx(J,{type:"password",value:y.confirmPassword,onChange:j=>u({...y,confirmPassword:j.target.value}),className:s.input,placeholder:"••••••••"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx(L,{variant:"outline",className:"flex-1",onClick:()=>{T(!1),u({currentPassword:"",newPassword:"",confirmPassword:""})},disabled:m,children:"Cancelar"}),e.jsx(L,{className:"flex-1",onClick:ce,disabled:m||!y.currentPassword||!y.newPassword||!y.confirmPassword,children:m?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"h-4 w-4 animate-spin mr-2"})," Actualizando..."]}):"Actualizar"})]})]})]})})]})},Qe=(s,t,a,l)=>{if(!s||!t)return 0;const g=new Date(`2000-01-01T${s}`);let p=new Date(`2000-01-01T${t}`).getTime()-g.getTime();(l||p<0)&&(p+=1440*60*1e3);const r=p/(1e3*60*60);return Math.max(0,r-a/60)},Fa=(s,t)=>{switch(s){case"draft":return{bg:t?"bg-gray-500/20":"bg-slate-100",text:t?"text-gray-400":"text-slate-600",label:"Borrador"};case"submitted":return{bg:"bg-amber-500/20",text:"text-amber-500",label:"Pendiente"};case"approved":return{bg:"bg-emerald-500/20",text:"text-emerald-500",label:"Aprobado"};case"rejected":return{bg:"bg-red-500/20",text:"text-red-500",label:"Rechazado"};default:return{bg:t?"bg-gray-500/20":"bg-slate-100",text:t?"text-gray-400":"text-slate-600",label:s}}},Xt=({theme:s,isDark:t,job:a,onClose:l,userRole:g,userId:k})=>{var ce;const{user:p}=Me(),{timesheets:r,isLoading:M,isError:z,updateTimesheet:x,submitTimesheet:N,signTimesheet:I,refetch:F}=ta(a==null?void 0:a.id,{userRole:g}),n=g==="technician"||g==="house_tech",{data:f=[],isLoading:E}=na(a==null?void 0:a.id,n?k:void 0),{data:C}=ia(a==null?void 0:a.id),U=(C==null?void 0:C.rates_approved)??!1,q=b.useMemo(()=>!r||!k?[]:r.filter(w=>w.technician_id===k),[r,k]),[T,y]=b.useState(null),[u,m]=b.useState({date:"",start_time:"09:00",end_time:"17:00",break_minutes:30,overtime_hours:0,notes:"",ends_next_day:!1,category:void 0}),[c,$]=b.useState(!1),[H,R]=b.useState(null),[d,A]=b.useState(!1),S=b.useRef(null),D=w=>{y(w.id),m({date:w.date,start_time:w.start_time||"09:00",end_time:w.end_time||"17:00",break_minutes:w.break_minutes||0,overtime_hours:w.overtime_hours||0,notes:w.notes||"",ends_next_day:w.ends_next_day||!1,category:w.category??void 0})};b.useEffect(()=>{if(T&&u.start_time&&u.end_time){const w=u.end_time<u.start_time;w&&!u.ends_next_day?m(i=>({...i,ends_next_day:!0})):!w&&u.ends_next_day&&m(i=>({...i,ends_next_day:!1}))}},[u.start_time,u.end_time,T]);const G=()=>{y(null)},Z=async w=>{try{await x(w,{start_time:u.start_time,end_time:u.end_time,break_minutes:u.break_minutes,overtime_hours:u.overtime_hours,notes:u.notes,ends_next_day:u.ends_next_day,category:u.category}),y(null)}catch(i){const o=i instanceof Error?i.message:"Error desconocido";W.error(`No se pudo guardar el parte: ${o}`)}},ae=async w=>{try{await N(w)}catch(i){const o=i instanceof Error?i.message:"Error desconocido";W.error(`No se pudo enviar el parte: ${o}`)}},te=w=>{R(w),$(!0)},X=async()=>{if(!(!S.current||!H)){A(!0);try{const w=S.current.toDataURL();await I(H,w),$(!1),R(null)}catch{W.error("No se pudo guardar la firma")}finally{A(!1)}}},ne=()=>{var w;(w=S.current)==null||w.clear()},Q=f[0],le=(Q==null?void 0:Q.timesheets_total_eur)||0,ee=(Q==null?void 0:Q.extras_total_eur)||0,de=(Q==null?void 0:Q.total_eur)||0,me=q.reduce((w,i)=>(w[i.date]||(w[i.date]=[]),w[i.date].push(i),w),{}),ue=a!=null&&a.start_time?O(new Date(a.start_time),"EEEE, d 'de' MMMM",{locale:K}):"Fecha no disponible";return e.jsxs("div",{className:`fixed inset-0 z-[60] ${s.bg} flex flex-col`,children:[e.jsx("div",{className:`sticky top-0 z-10 px-5 py-4 border-b ${s.divider} ${s.bg}`,children:e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsxs("button",{onClick:l,className:`flex items-center gap-1 text-xs font-bold mb-1 ${s.textMuted}`,children:[e.jsx(Ie,{size:14})," Volver"]}),e.jsx("h1",{className:`text-xl font-bold ${s.textMain}`,children:"Mis partes de horas"})]})})}),e.jsx(Fe,{className:"flex-1",children:e.jsx("div",{className:"p-5 space-y-5 pb-8",children:M?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(V,{className:"h-8 w-8 animate-spin text-blue-500"})}):z?e.jsxs("div",{className:`text-center py-8 ${s.textMuted}`,children:[e.jsx(Be,{size:40,className:"mx-auto mb-3 text-red-500"}),e.jsx("p",{className:`font-medium ${s.textMain}`,children:"Error al cargar los partes"}),e.jsx("p",{className:"text-sm mt-1",children:"No se pudieron obtener los datos"}),e.jsxs(L,{variant:"outline",size:"sm",onClick:()=>F(),className:"mt-4",children:[e.jsx(ze,{size:14,className:"mr-2"}),"Reintentar"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`p-4 rounded-2xl border ${s.card}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Le,{size:18,className:"text-blue-500"}),e.jsx("h2",{className:`font-bold ${s.textMain}`,children:"Mi total en este trabajo"})]}),E?e.jsx("div",{className:`text-sm ${s.textMuted}`,children:"Cargando..."}):!U&&n?e.jsxs("div",{className:`text-sm ${s.textMuted} flex items-center gap-2`,children:[e.jsx(Be,{size:14}),"Tarifas pendientes de aprobación"]}):f.length===0?e.jsx("div",{className:`text-sm ${s.textMuted}`,children:"Sin importes aprobados aún"}):e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:`text-sm ${s.textMuted}`,children:[e.jsxs("div",{children:["Partes: ",e.jsx("span",{className:`font-medium ${s.textMain}`,children:ve(le)})]}),ee>0&&e.jsxs("div",{children:["+ Extras: ",e.jsx("span",{className:`font-medium ${s.textMain}`,children:ve(ee)})]})]}),e.jsx("div",{className:"px-4 py-2 bg-blue-500/20 text-blue-500 rounded-xl font-bold text-lg",children:ve(de)})]})]}),e.jsxs("div",{className:`p-4 rounded-2xl border ${s.card}`,children:[e.jsx("h3",{className:`font-bold mb-2 ${s.textMain}`,children:(a==null?void 0:a.title)||"Sin título"}),e.jsxs("div",{className:`text-xs ${s.textMuted} flex items-center gap-1.5`,children:[e.jsx(Ne,{size:12})," ",((ce=a==null?void 0:a.location)==null?void 0:ce.name)||"Sin ubicación"]}),e.jsxs("div",{className:`text-xs ${s.textMuted} flex items-center gap-1.5 mt-1`,children:[e.jsx(ie,{size:12})," ",ue]})]}),q.length===0&&e.jsxs("div",{className:`text-center py-8 ${s.textMuted}`,children:[e.jsx(Ee,{size:40,className:"mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"font-medium",children:"No hay partes de horas"}),e.jsx("p",{className:"text-sm mt-1",children:"Los partes se crean automáticamente"})]}),Object.entries(me).map(([w,i])=>e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`flex items-center gap-2 ${s.textMuted}`,children:[e.jsx(ie,{size:14}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-wider",children:O(Xe(w),"EEEE, d MMM",{locale:K})})]}),i.map(o=>{const h=T===o.id,_=Fa(o.status,t),B=["draft","rejected"],Y=B.includes(o.status),se=B.includes(o.status),j=h?Qe(u.start_time,u.end_time,u.break_minutes,u.ends_next_day):o.start_time&&o.end_time?Qe(o.start_time,o.end_time,o.break_minutes||0,o.ends_next_day):0;return e.jsxs("div",{className:`p-4 rounded-2xl border ${s.card}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("span",{className:`px-2.5 py-1 rounded text-[10px] font-bold uppercase ${_.bg} ${_.text}`,children:_.label}),o.ends_next_day&&e.jsxs("span",{className:`flex items-center gap-1 text-xs ${s.textMuted}`,children:[e.jsx(oa,{size:12})," Noche"]})]}),o.status==="rejected"&&e.jsxs(ea,{variant:"destructive",className:"mb-4",children:[e.jsx(re,{className:"h-4 w-4"}),e.jsx(sa,{children:"Parte rechazado"}),e.jsx(aa,{children:o.rejection_reason||"Por favor revisa las horas y vuelve a enviar."})]}),h?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold ${s.textMuted} mb-1 block`,children:"Entrada"}),e.jsx(J,{type:"time",value:u.start_time,onChange:v=>m({...u,start_time:v.target.value}),className:`${s.input} font-mono`})]}),e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold ${s.textMuted} mb-1 block`,children:"Salida"}),e.jsx(J,{type:"time",value:u.end_time,onChange:v=>m({...u,end_time:v.target.value}),className:`${s.input} font-mono`})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold ${s.textMuted} mb-1 block`,children:"Descanso (min)"}),e.jsx(J,{type:"number",value:u.break_minutes,onChange:v=>m({...u,break_minutes:parseInt(v.target.value)||0}),className:`${s.input} font-mono`,min:0,max:180,step:15}),e.jsx("p",{className:"text-[9px] text-muted-foreground mt-1",children:"Solo para descansos por convenio o montajes/desmontajes, no para comidas."})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:u.ends_next_day,onChange:v=>m({...u,ends_next_day:v.target.checked}),className:"w-4 h-4 rounded"}),e.jsx("span",{className:`text-xs ${s.textMuted}`,children:"Termina al día siguiente"}),u.end_time<u.start_time&&e.jsx(fe,{variant:"secondary",className:"ml-2 bg-blue-100 text-blue-800 text-[9px] px-1.5 py-0.5",children:"Auto"})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold ${s.textMuted} mb-1 block`,children:"Categoría"}),e.jsxs($s,{value:u.category||"",onValueChange:v=>{m({...u,category:v==="tecnico"||v==="especialista"||v==="responsable"?v:void 0})},children:[e.jsx(_s,{className:s.input,children:e.jsx(ks,{placeholder:"Seleccionar categoría"})}),e.jsxs(Cs,{children:[e.jsx(ke,{value:"tecnico",children:"Técnico"}),e.jsx(ke,{value:"especialista",children:"Especialista"}),e.jsx(ke,{value:"responsable",children:"Responsable"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold ${s.textMuted} mb-1 block`,children:"Horas extra"}),e.jsx(J,{type:"number",value:u.overtime_hours,onChange:v=>m({...u,overtime_hours:parseFloat(v.target.value)||0}),className:`${s.input} font-mono`,min:0,step:.5})]}),e.jsxs("div",{children:[e.jsx("label",{className:`text-xs font-bold ${s.textMuted} mb-1 block`,children:"Notas"}),e.jsx(Ze,{value:u.notes,onChange:v=>m({...u,notes:v.target.value}),className:s.input,placeholder:"Notas adicionales...",rows:2})]}),e.jsxs("div",{className:`p-3 rounded-xl ${t?"bg-white/5":"bg-slate-100"}`,children:[e.jsx("div",{className:`text-xs font-bold ${s.textMuted} mb-1`,children:"Horas trabajadas"}),e.jsxs("div",{className:`text-2xl font-mono font-bold ${s.textMain}`,children:[j.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{variant:"outline",className:"flex-1",onClick:v=>{v.stopPropagation(),v.preventDefault(),G()},children:"Cancelar"}),e.jsxs(L,{className:"flex-1 bg-blue-600 hover:bg-blue-500 text-white",onClick:v=>{v.stopPropagation(),v.preventDefault(),Z(o.id)},children:[e.jsx(os,{size:16,className:"mr-2"}),"Guardar"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:`text-[10px] font-bold uppercase ${s.textMuted}`,children:"Entrada"}),e.jsx("div",{className:`font-mono font-bold ${s.textMain}`,children:o.start_time||"--:--"})]}),e.jsxs("div",{children:[e.jsx("div",{className:`text-[10px] font-bold uppercase ${s.textMuted}`,children:"Salida"}),e.jsx("div",{className:`font-mono font-bold ${s.textMain}`,children:o.end_time||"--:--"})]}),e.jsxs("div",{children:[e.jsx("div",{className:`text-[10px] font-bold uppercase ${s.textMuted}`,children:"Descanso"}),e.jsxs("div",{className:`font-mono font-bold ${s.textMain}`,children:[o.break_minutes||0," min"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:`text-[10px] font-bold uppercase ${s.textMuted}`,children:"Categoría"}),e.jsx("div",{className:`font-medium ${s.textMain}`,children:o.category||"Sin asignar"})]}),e.jsxs("div",{children:[e.jsx("div",{className:`text-[10px] font-bold uppercase ${s.textMuted}`,children:"Horas totales"}),e.jsxs("div",{className:`text-xl font-mono font-bold ${s.textMain}`,children:[j.toFixed(1),"h"]})]})]}),(o.overtime_hours||0)>0&&e.jsxs("div",{children:[e.jsx("div",{className:`text-[10px] font-bold uppercase ${s.textMuted}`,children:"Horas extra"}),e.jsxs("div",{className:"text-amber-500 font-mono font-bold",children:[o.overtime_hours,"h"]})]}),o.notes&&e.jsxs("div",{children:[e.jsx("div",{className:`text-[10px] font-bold uppercase ${s.textMuted}`,children:"Notas"}),e.jsx("div",{className:`text-sm ${s.textMain}`,children:o.notes})]}),o.amount_breakdown_visible&&e.jsxs("div",{className:`p-3 rounded-xl ${t?"bg-emerald-500/10":"bg-emerald-50"} border border-emerald-500/20`,children:[e.jsx("div",{className:"text-xs font-bold text-emerald-600 mb-2",children:"Desglose de tarifa"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:s.textMuted,children:"Horas: "}),e.jsxs("span",{className:s.textMain,children:[o.amount_breakdown_visible.worked_hours_rounded||0,"h"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:s.textMuted,children:"Base: "}),e.jsxs("span",{className:s.textMain,children:["€",(o.amount_breakdown_visible.base_amount_eur??0).toFixed(2)]})]}),(o.amount_breakdown_visible.overtime_hours||0)>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("span",{className:s.textMuted,children:"HE: "}),e.jsxs("span",{className:s.textMain,children:[o.amount_breakdown_visible.overtime_hours||0,"h"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:s.textMuted,children:"+HE: "}),e.jsxs("span",{className:s.textMain,children:["€",(o.amount_breakdown_visible.overtime_amount_eur??0).toFixed(2)]})]})]})]}),e.jsx("div",{className:"mt-2 pt-2 border-t border-emerald-500/20",children:e.jsxs("span",{className:"text-emerald-600 font-bold",children:["Total: €",(o.amount_breakdown_visible.total_eur??0).toFixed(2)]})})]}),o.signature_data&&e.jsxs("div",{className:`p-3 rounded-xl border ${s.divider}`,children:[e.jsx("div",{className:`text-[10px] font-bold uppercase ${s.textMuted} mb-2`,children:"Firma digital"}),e.jsx("img",{src:o.signature_data,alt:"Firma",width:400,height:150,loading:"lazy",decoding:"async",className:"max-h-16 object-contain"}),e.jsxs("div",{className:"text-xs text-emerald-500 mt-1 flex items-center gap-1",children:[e.jsx(Ce,{size:12})," Firmado"]})]})]}),e.jsxs("div",{className:"mt-4 space-y-2",children:[Y&&e.jsx(L,{variant:"outline",className:"w-full",onClick:v=>{v.stopPropagation(),v.preventDefault(),D(o)},children:"Editar horario"}),!o.signature_data&&se&&e.jsxs(L,{variant:"outline",className:"w-full",onClick:v=>{v.stopPropagation(),v.preventDefault(),te(o.id)},children:[e.jsx(la,{size:16,className:"mr-2"}),"Añadir firma"]}),se&&e.jsxs(L,{className:"w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold",onClick:v=>{v.stopPropagation(),v.preventDefault(),ae(o.id)},children:[e.jsx(Ce,{size:16,className:"mr-2"}),"ENVIAR PARTE"]}),o.status==="submitted"&&e.jsx("div",{className:`text-center text-sm ${s.textMuted}`,children:"Pendiente de aprobación"}),o.status==="approved"&&e.jsxs("div",{className:"text-center text-sm text-emerald-500 flex items-center justify-center gap-1",children:[e.jsx(Ce,{size:14})," Aprobado"]})]})]})]},o.id)})]},w))]})})}),c&&e.jsx("div",{className:`fixed inset-0 z-[80] flex items-center justify-center ${s.modalOverlay||"bg-black/90 backdrop-blur-md"} p-4 animate-in fade-in duration-200`,children:e.jsxs("div",{className:`w-full max-w-md ${t?"bg-[#0f1219]":"bg-white"} rounded-2xl border ${s.divider} shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200`,children:[e.jsxs("div",{className:`p-4 border-b ${s.divider} flex justify-between items-center`,children:[e.jsx("h3",{className:`font-bold ${s.textMain}`,children:"Firma Digital"}),e.jsx("button",{onClick:()=>{$(!1),R(null)},className:`p-1 ${s.textMuted} hover:opacity-70`,children:e.jsx(ge,{size:18})})]}),e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:`border-2 border-dashed ${t?"border-gray-700 bg-white/5":"border-slate-300 bg-slate-50"} rounded-xl overflow-hidden mb-4`,children:e.jsx(da,{ref:S,canvasProps:{className:"signature-canvas w-full h-40",style:{width:"100%",height:"160px"}},backgroundColor:"transparent",penColor:t?"white":"black"})}),e.jsx("p",{className:`text-xs ${s.textMuted} text-center mb-4`,children:"Al firmar, certifico que las horas registradas son correctas."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(L,{variant:"outline",onClick:ne,className:"flex-1",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Limpiar"]}),e.jsxs(L,{onClick:X,disabled:d,className:"flex-1 bg-blue-600 hover:bg-blue-500 text-white",children:[e.jsx(Ss,{className:"h-4 w-4 mr-2"}),d?"Guardando...":"Guardar"]})]})]})]})})]})},Zt=({theme:s,isDark:t,job:a,onClose:l})=>{var ae,te,X,ne,Q,le,ee,de,me,ue,ce,w;const[g,k]=b.useState("Info"),[p,r]=b.useState(new Set),[M,z]=b.useState(void 0),[x,N]=b.useState(null),[I,F]=b.useState(!1),{data:n,isLoading:f}=oe({queryKey:["job-details-modal",a==null?void 0:a.id],queryFn:async()=>{if(!(a!=null&&a.id))return null;const{data:i,error:o}=await P.from("jobs").select(`
          *,
          locations(id, name, formatted_address, latitude, longitude)
        `).eq("id",a.id).single();if(o)throw o;return i},enabled:!!(a!=null&&a.id)}),{data:E=[],isLoading:C}=oe({queryKey:["job-staff",a==null?void 0:a.id],queryFn:async()=>{if(!(a!=null&&a.id))return[];const{data:i,error:o}=await P.from("job_assignments").select(`
          sound_role,
          lights_role,
          video_role,
          technician:profiles(id, first_name, last_name, email, profile_picture_url)
        `).eq("job_id",a.id).eq("status","confirmed");if(o)throw o;return i||[]},enabled:!!(a!=null&&a.id)}),{data:U=[],isLoading:q}=oe({queryKey:["job-restaurants-modal",a==null?void 0:a.id,(ae=n==null?void 0:n.locations)==null?void 0:ae.formatted_address],queryFn:async()=>{const i=n==null?void 0:n.locations,o=(i==null?void 0:i.formatted_address)||(i==null?void 0:i.name);if(!o&&!(i!=null&&i.latitude))return[];const h=i!=null&&i.latitude&&(i!=null&&i.longitude)?{lat:Number(i.latitude),lng:Number(i.longitude)}:void 0;return await ma.searchRestaurantsNearVenue(o||`${h==null?void 0:h.lat},${h==null?void 0:h.lng}`,2e3,10,h)},enabled:!!(n!=null&&n.locations)&&(!!((te=n==null?void 0:n.locations)!=null&&te.formatted_address)||!!((X=n==null?void 0:n.locations)!=null&&X.name)||!!((ne=n==null?void 0:n.locations)!=null&&ne.latitude)&&!!((Q=n==null?void 0:n.locations)!=null&&Q.longitude))}),T=(n!=null&&n.start_time||a!=null&&a.start_time)&&(n!=null&&n.end_time||a!=null&&a.end_time)?new Date((n==null?void 0:n.start_time)||(a==null?void 0:a.start_time)).toLocaleDateString("en-GB").split("/").join("/")+(new Date((n==null?void 0:n.start_time)||(a==null?void 0:a.start_time)).toDateString()!==new Date((n==null?void 0:n.end_time)||(a==null?void 0:a.end_time)).toDateString()?" - "+new Date((n==null?void 0:n.end_time)||(a==null?void 0:a.end_time)).toLocaleDateString("en-GB").split("/").join("/"):""):"",y={address:((le=n==null?void 0:n.locations)==null?void 0:le.formatted_address)||((ee=n==null?void 0:n.locations)==null?void 0:ee.name),coordinates:(de=n==null?void 0:n.locations)!=null&&de.latitude&&((me=n==null?void 0:n.locations)!=null&&me.longitude)?{lat:typeof n.locations.latitude=="number"?n.locations.latitude:parseFloat(n.locations.latitude),lng:typeof n.locations.longitude=="number"?n.locations.longitude:parseFloat(n.locations.longitude)}:void 0},{isLoading:u,error:m,fetchWeather:c}=ca({venue:y,eventDates:T,onWeatherUpdate:z});b.useEffect(()=>{const i=async()=>{try{const o=n==null?void 0:n.locations;if(!o){N(null);return}const h=typeof o.latitude=="number"?o.latitude:typeof o.latitude=="string"?parseFloat(o.latitude):void 0,_=typeof o.longitude=="number"?o.longitude:typeof o.longitude=="string"?parseFloat(o.longitude):void 0,B=o.formatted_address||o.name||"";F(!0);const{data:Y,error:se}=await P.functions.invoke("get-google-maps-key");if(se||!(Y!=null&&Y.apiKey)){N(null),F(!1);return}const j=Y.apiKey,v=15,be=600,ms=300,us=2,ps=Number.isFinite(h)&&Number.isFinite(_)?`${h},${_}`:encodeURIComponent(B),hs=Number.isFinite(h)&&Number.isFinite(_)?`&markers=color:red|label:A|${h},${_}`:B?`&markers=color:red|label:A|${encodeURIComponent(B)}`:"",gs=`https://maps.googleapis.com/maps/api/staticmap?center=${ps}&zoom=${v}&size=${be}x${ms}&scale=${us}${hs}&key=${encodeURIComponent(j)}`;N(gs)}catch(o){o instanceof Error?o.message:String(o),N(null)}finally{F(!1)}};n!=null&&n.locations&&i()},[n==null?void 0:n.locations]);const $=async i=>{const o=i.id;r(h=>new Set(h).add(o));try{const h=await We(P,i.file_path,60);window.open(h,"_blank")}catch(h){const _=h instanceof Error?h.message:"Error desconocido";W.error(`No se pudo abrir el documento: ${_}`)}finally{r(h=>{const _=new Set(h);return _.delete(o),_})}},H=async i=>{const o=i.id;r(h=>new Set(h).add(o));try{const h=await We(P,i.file_path,60),_=document.createElement("a");_.href=h,_.download=i.file_name,document.body.appendChild(_),_.click(),document.body.removeChild(_)}catch(h){const _=h instanceof Error?h.message:"Error desconocido";W.error(`No se pudo descargar el documento: ${_}`)}finally{r(h=>{const _=new Set(h);return _.delete(o),_})}},R=()=>{var h,_,B;const i=((h=n==null?void 0:n.locations)==null?void 0:h.formatted_address)||((_=n==null?void 0:n.locations)==null?void 0:_.name)||((B=a==null?void 0:a.location)==null?void 0:B.name)||"",o=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i)}`;window.open(o,"_blank")},d=(n==null?void 0:n.locations)||(a==null?void 0:a.location),A=n!=null&&n.start_time||a!=null&&a.start_time?O(new Date((n==null?void 0:n.start_time)||(a==null?void 0:a.start_time)),"d 'de' MMMM 'de' yyyy 'a las' HH:mm",{locale:K}):"Fecha no disponible",S=n!=null&&n.end_time||a!=null&&a.end_time?O(new Date((n==null?void 0:n.end_time)||(a==null?void 0:a.end_time)),"d 'de' MMMM 'de' yyyy 'a las' HH:mm",{locale:K}):"Fecha no disponible",D=[{id:"Info",label:"Info"},{id:"Ubicación",label:"Ubicación"},{id:"Personal",label:"Personal"},{id:"Docs",label:"Docs"},{id:"Restau.",label:"Restau."},{id:"Clima",label:"Clima"}],G=i=>i.sound_role?"sound":i.lights_role?"lights":i.video_role?"video":"unknown",Z=i=>{const o=i.sound_role||i.lights_role||i.video_role;return o?_e(o)||o:"Técnico"};return e.jsx("div",{className:`fixed inset-0 z-50 flex items-center justify-center ${s.modalOverlay} p-4 animate-in fade-in duration-200`,children:e.jsxs("div",{className:`w-full max-w-md md:max-w-lg lg:max-w-xl h-[85vh] ${t?"bg-[#0f1219]":"bg-white"} rounded-2xl border ${s.divider} shadow-2xl flex flex-col overflow-hidden animate-in zoom-in-95 duration-200`,children:[e.jsxs("div",{className:`p-4 border-b ${s.divider} flex justify-between items-center shrink-0`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{size:18,className:s.textMuted}),e.jsx("h2",{className:`text-lg font-bold ${s.textMain}`,children:(a==null?void 0:a.title)||"Sin título"})]}),e.jsx("button",{onClick:l,className:`p-2 ${s.textMuted} hover:${s.textMain} rounded-full transition-colors`,children:e.jsx(ge,{size:20})})]}),e.jsx("div",{className:`flex border-b ${s.divider} ${t?"bg-[#0a0c10]":"bg-slate-50"} overflow-x-auto shrink-0`,children:D.map(i=>e.jsx("button",{onClick:()=>k(i.id),className:`
                flex-1 py-3 px-4 text-xs font-bold uppercase tracking-wide whitespace-nowrap transition-colors
                ${g===i.id?`${t?"bg-[#151820]":"bg-white"} ${s.textMain} border-b-2 border-blue-500`:`${s.textMuted} hover:${s.textMain}`}
              `,children:i.label},i.id))}),e.jsxs(Fe,{className:"flex-1 p-5",children:[g==="Info"&&e.jsxs("div",{className:"space-y-6 animate-in slide-in-from-right-4 duration-300",children:[e.jsxs("div",{children:[e.jsx("h1",{className:`text-2xl font-bold ${s.textMain} mb-4`,children:a==null?void 0:a.title}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:`text-xs ${s.textMuted} font-bold uppercase`,children:"Hora de inicio"}),e.jsx("div",{className:`text-sm ${s.textMain} mt-1 leading-relaxed`,children:A})]}),e.jsxs("div",{children:[e.jsx("label",{className:`text-xs ${s.textMuted} font-bold uppercase`,children:"Hora de finalización"}),e.jsx("div",{className:`text-sm ${s.textMain} mt-1 leading-relaxed`,children:S})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:`text-xs ${s.textMuted} font-bold uppercase`,children:"Tipo de trabajo"}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:`px-3 py-1 rounded-full ${t?"bg-[#1a1d26] border-[#2a2e3b]":"bg-slate-100 border-slate-200"} border text-xs ${s.textMain} font-medium`,children:(a==null?void 0:a.job_type)==="multi_day"?"Varios días":(a==null?void 0:a.job_type)==="single"?"Un solo día":(a==null?void 0:a.job_type)||"Un solo día"})})]})]}),(a==null?void 0:a.description)&&e.jsxs("div",{children:[e.jsx("label",{className:`text-xs ${s.textMuted} font-bold uppercase`,children:"Descripción"}),e.jsx("p",{className:`text-sm ${s.textMain} mt-2 leading-relaxed`,children:a.description})]}),e.jsxs("div",{children:[e.jsx("label",{className:`text-xs ${s.textMuted} font-bold uppercase`,children:"Recinto"}),e.jsx("div",{className:`text-sm ${s.textMain} mt-1 leading-relaxed`,children:((ue=a==null?void 0:a.location)==null?void 0:ue.name)||"Sin ubicación"})]})]}),g==="Ubicación"&&e.jsx("div",{className:"space-y-4 animate-in slide-in-from-right-4 duration-300",children:f?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(V,{className:"h-8 w-8 animate-spin text-blue-500"})}):d?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h2",{className:`text-lg font-bold ${s.textMain}`,children:(d==null?void 0:d.name)||"Sin ubicación"}),e.jsx("p",{className:`text-sm ${s.textMuted} mt-1 max-w-xs leading-relaxed`,children:(d==null?void 0:d.formatted_address)||(d==null?void 0:d.address)||"Dirección no disponible"})]}),e.jsxs(L,{onClick:R,size:"sm",className:"whitespace-nowrap",children:[e.jsx(as,{size:14,className:"mr-2"})," Abrir mapas"]})]}),I&&e.jsx("div",{className:`rounded-xl overflow-hidden border ${s.divider} h-48 ${t?"bg-[#0a0c10]":"bg-slate-100"} flex items-center justify-center`,children:e.jsxs("div",{className:"text-center",children:[e.jsx(V,{className:"h-8 w-8 animate-spin text-blue-500 mx-auto mb-2"}),e.jsx("p",{className:`text-sm ${s.textMuted}`,children:"Cargando vista previa del mapa..."})]})}),!I&&x&&e.jsxs("div",{className:`rounded-xl overflow-hidden border ${s.divider}`,children:[e.jsx("img",{src:x,alt:"Mapa del recinto",width:600,height:300,loading:"lazy",decoding:"async",className:"w-full h-auto"}),e.jsx("div",{className:"p-3 flex justify-end",children:e.jsx(L,{size:"sm",onClick:R,children:"Ver indicaciones"})})]}),!I&&!x&&e.jsx("div",{className:`rounded-xl overflow-hidden border ${s.divider} relative h-48 ${t?"bg-[#0a0c10]":"bg-slate-100"}`,children:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ne,{size:32,className:s.textMuted}),e.jsx("p",{className:`text-xs ${s.textMuted} mt-2`,children:"Vista previa del mapa no disponible"}),e.jsx(L,{size:"sm",onClick:R,className:"mt-3",children:"Abrir Google Maps"})]})})})]}):e.jsxs("div",{className:`h-48 border border-dashed ${s.divider} rounded-xl flex flex-col items-center justify-center ${s.textMuted}`,children:[e.jsx(Ne,{size:32,className:"mb-2 opacity-50"}),e.jsx("span",{className:"text-sm",children:"No hay información de ubicación disponible"})]})}),g==="Personal"&&e.jsxs("div",{className:"space-y-4 animate-in slide-in-from-right-4 duration-300",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(we,{size:18,className:s.textMuted}),e.jsx("h3",{className:`text-lg font-bold ${s.textMain}`,children:"Personal asignado"})]}),C?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(V,{className:"h-6 w-6 animate-spin text-blue-500"})}):E.length===0?e.jsxs("div",{className:`h-32 border border-dashed ${s.divider} rounded-xl flex flex-col items-center justify-center ${s.textMuted}`,children:[e.jsx(we,{size:24,className:"mb-2 opacity-50"}),e.jsx("span",{className:"text-xs",children:"No hay personal asignado"})]}):e.jsx("div",{className:"space-y-2",children:E.map((i,o)=>{var se,j;const h=i.technician,_=G(i),B=Z(i),Y={sound:"text-blue-400 bg-blue-900/30 border-blue-900/50",lights:"text-amber-400 bg-amber-900/30 border-amber-900/50",video:"text-purple-400 bg-purple-900/30 border-purple-900/50"};return e.jsxs("div",{className:`${t?"bg-[#151820] border-[#2a2e3b]":"bg-slate-50 border-slate-200"} border rounded-lg p-4 flex items-start gap-3`,children:[e.jsxs(rs,{className:"h-12 w-12 shrink-0",children:[(h==null?void 0:h.profile_picture_url)&&e.jsx(Ks,{src:h.profile_picture_url,alt:`${h.first_name} ${h.last_name}`}),e.jsx(ls,{className:"text-sm",children:`${((se=h==null?void 0:h.first_name)==null?void 0:se[0])||""}${((j=h==null?void 0:h.last_name)==null?void 0:j[0])||""}`.toUpperCase()||"T"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:`font-bold text-sm ${s.textMain} mb-1`,children:[h==null?void 0:h.first_name," ",h==null?void 0:h.last_name]}),e.jsx("div",{className:`text-xs ${s.textMuted}`,children:B}),e.jsx("div",{className:`mt-2 inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase border ${Y[_]||s.textMuted}`,children:_})]})]},o)})})]}),g==="Docs"&&e.jsx("div",{className:"space-y-6 animate-in slide-in-from-right-4 duration-300",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(je,{size:18,className:s.textMuted}),e.jsx("h3",{className:`text-lg font-bold ${s.textMain}`,children:"Documentos del trabajo"})]}),a!=null&&a.job_documents&&a.job_documents.filter(i=>i.visible_to_tech).length>0?e.jsx("div",{className:"space-y-2",children:a.job_documents.filter(i=>i.visible_to_tech).map(i=>e.jsxs("div",{className:`${t?"bg-[#151820] border-[#2a2e3b]":"bg-slate-50 border-slate-200"} border rounded-lg p-4 flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3`,children:[e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("div",{className:`text-sm font-bold ${s.textMain} leading-snug break-words line-clamp-2 sm:truncate mb-1`,title:i.file_name,children:i.file_name}),e.jsx("div",{className:`text-xs ${s.textMuted}`,children:i.uploaded_at&&`Subido el ${O(new Date(i.uploaded_at),"d 'de' MMMM 'de' yyyy",{locale:K})}`}),e.jsxs("div",{className:"flex gap-1 mt-1 flex-wrap",children:[i.template_type==="soundvision"&&e.jsx(fe,{variant:"outline",className:"text-[10px]",children:"SoundVision"}),i.read_only&&e.jsx(fe,{variant:"outline",className:"text-[10px] text-amber-500 border-amber-500/50",children:"Solo lectura"})]})]}),e.jsxs("div",{className:"flex flex-col gap-2 shrink-0 w-full sm:w-auto",children:[e.jsx(L,{variant:"outline",size:"sm",onClick:()=>$(i),disabled:p.has(i.id),className:"w-full sm:min-w-[90px]",children:p.has(i.id)?e.jsx(V,{className:"h-4 w-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(ua,{size:14,className:"mr-1"})," Ver"]})}),e.jsx(L,{variant:"outline",size:"sm",onClick:()=>H(i),disabled:p.has(i.id),className:"w-full sm:min-w-[90px]",children:p.has(i.id)?e.jsx(V,{className:"h-4 w-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(cs,{size:14,className:"mr-1"})," Descargar"]})})]})]},i.id))}):e.jsxs("div",{className:`h-32 border border-dashed ${s.divider} rounded-xl flex flex-col items-center justify-center ${s.textMuted}`,children:[e.jsx(je,{size:24,className:"mb-2 opacity-50"}),e.jsx("span",{className:"text-xs",children:"No hay documentos disponibles"})]})]})}),g==="Restau."&&e.jsxs("div",{className:"space-y-4 animate-in slide-in-from-right-4 duration-300",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ve,{size:18,className:s.textMuted}),e.jsx("h3",{className:`text-lg font-bold ${s.textMain}`,children:"Restaurantes cercanos"})]}),f||q?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(V,{className:"h-8 w-8 animate-spin text-blue-500 mb-2"}),e.jsx("p",{className:`text-sm ${s.textMuted}`,children:"Buscando restaurantes cercanos..."})]}):U&&U.length>0?e.jsx("div",{className:"space-y-3",children:U.map(i=>e.jsx("div",{className:`p-4 rounded-xl border ${s.card}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0 pr-3",children:[e.jsx("p",{className:`font-bold text-sm ${s.textMain} truncate`,children:i.name}),e.jsx("p",{className:`text-xs ${s.textMuted} mt-1 line-clamp-2`,children:i.address}),e.jsxs("div",{className:"flex items-center gap-2 mt-3 flex-wrap",children:[i.rating&&e.jsxs("span",{className:`px-2 py-0.5 rounded text-[10px] font-bold ${t?"bg-amber-500/20 text-amber-400":"bg-amber-100 text-amber-700"}`,children:["⭐ ",i.rating]}),i.priceLevel!==void 0&&e.jsx("span",{className:`px-2 py-0.5 rounded text-[10px] font-bold ${t?"bg-emerald-500/20 text-emerald-400":"bg-emerald-100 text-emerald-700"}`,children:"€".repeat(i.priceLevel+1)}),i.distance&&e.jsxs("span",{className:`px-2 py-0.5 rounded text-[10px] font-bold ${t?"bg-blue-500/20 text-blue-400":"bg-blue-100 text-blue-700"}`,children:["A ",Math.round(i.distance)," m"]})]})]}),e.jsxs("div",{className:"flex gap-1 shrink-0",children:[i.phone&&e.jsx("a",{href:`tel:${i.phone}`,className:`p-2 rounded-lg border ${s.divider} hover:bg-white/5`,children:e.jsx(ds,{size:14,className:s.textMuted})}),i.website&&e.jsx("a",{href:i.website,target:"_blank",rel:"noopener noreferrer",className:`p-2 rounded-lg border ${s.divider} hover:bg-white/5`,children:e.jsx(Ae,{size:14,className:s.textMuted})})]})]})},i.id))}):e.jsxs("div",{className:`h-48 border border-dashed ${s.divider} rounded-xl flex flex-col items-center justify-center ${s.textMuted}`,children:[e.jsx(Ve,{size:32,className:"mb-2 opacity-50"}),e.jsx("span",{className:"text-sm",children:(ce=n==null?void 0:n.locations)!=null&&ce.formatted_address||(w=n==null?void 0:n.locations)!=null&&w.name?"No se encontraron restaurantes cercanos":"No hay dirección del recinto para buscar restaurantes"}),e.jsxs(L,{variant:"outline",size:"sm",className:"mt-4",onClick:()=>{var o,h,_;const i=((o=n==null?void 0:n.locations)==null?void 0:o.formatted_address)||((h=n==null?void 0:n.locations)==null?void 0:h.name)||((_=a==null?void 0:a.location)==null?void 0:_.name)||"";window.open(`https://www.google.com/maps/search/restaurants+near+${encodeURIComponent(i)}`,"_blank")},children:[e.jsx(Ae,{size:14,className:"mr-2"})," Buscar en Google Maps"]})]})]}),g==="Clima"&&e.jsxs("div",{className:"space-y-4 animate-in slide-in-from-right-4 duration-300",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ge,{size:18,className:s.textMuted}),e.jsx("h3",{className:`text-lg font-bold ${s.textMain}`,children:"Pronóstico del Tiempo"})]}),!f&&y.address&&T&&e.jsxs(L,{variant:"outline",size:"sm",onClick:c,disabled:u,children:[u?e.jsx(V,{className:"h-4 w-4 animate-spin mr-1"}):e.jsx(ze,{size:14,className:"mr-1"}),u?"Cargando...":"Actualizar"]})]}),f?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(V,{className:"h-8 w-8 animate-spin text-blue-500"})}):!y.address&&!y.coordinates?e.jsxs("div",{className:`flex items-center gap-2 text-sm ${s.textMuted} py-4`,children:[e.jsx(re,{size:16}),"El pronóstico del tiempo requiere ubicación del lugar"]}):T?m?e.jsxs("div",{className:`flex items-center gap-2 text-sm py-4 ${t?"text-red-400":"text-red-600"}`,children:[e.jsx(re,{size:16}),m]}):u?e.jsxs("div",{className:`flex items-center gap-2 text-sm ${s.textMuted} py-4`,children:[e.jsx(V,{className:"h-4 w-4 animate-spin"}),"Obteniendo pronóstico del tiempo..."]}):M&&M.length>0?e.jsxs("div",{className:"space-y-2",children:[M.map((i,o)=>{const h=B=>B.toLowerCase().includes("sun")?"☀️":B.toLowerCase().includes("cloud")?"☁️":B.toLowerCase().includes("rain")?"🌧️":B.toLowerCase().includes("snow")?"❄️":B.toLowerCase().includes("storm")?"⛈️":"🌤️",_=B=>{try{return new Date(B).toLocaleDateString("es-ES",{month:"long",day:"numeric"})}catch{return B}};return e.jsx("div",{className:`flex items-center justify-between p-4 rounded-xl ${t?"bg-white/5":"bg-slate-100"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-2xl",children:h(i.condition)}),e.jsxs("div",{children:[e.jsxs("div",{className:`font-bold text-sm ${s.textMain}`,children:[_(i.date)," – ",i.condition]}),e.jsxs("div",{className:`text-xs ${s.textMuted}`,children:[Math.round(i.maxTemp),"°C / ",Math.round(i.minTemp),"°C",i.precipitationProbability>0&&e.jsxs("span",{children:[", ",i.precipitationProbability,"% lluvia"]})]})]})]})},o)}),e.jsxs("div",{className:`text-xs ${s.textMuted} mt-4`,children:[e.jsx("strong",{children:"Fuente:"})," Los datos del tiempo se obtienen de Open-Meteo y se actualizan automáticamente."]})]}):e.jsxs("div",{className:`h-48 border border-dashed ${s.divider} rounded-xl flex flex-col items-center justify-center ${s.textMuted}`,children:[e.jsx(Ge,{size:32,className:"mb-2 opacity-50"}),e.jsx("span",{className:"text-sm text-center",children:"Datos del tiempo no disponibles para las fechas y ubicación seleccionadas."}),e.jsxs(L,{variant:"outline",size:"sm",className:"mt-4",onClick:c,disabled:u,children:[e.jsx(ze,{size:14,className:"mr-2"})," Obtener pronóstico"]})]}):e.jsxs("div",{className:`flex items-center gap-2 text-sm ${s.textMuted} py-4`,children:[e.jsx(re,{size:16}),"El pronóstico del tiempo requiere fechas del evento"]})]})]})]})})},$e=[{english:"Remove specifics and convert to ambiguities",spanish:"Elimina detalles específicos y conviértelos en ambigüedades"},{english:"Think of the radio",spanish:"Piensa en la radio"},{english:"Don’t be frightened of clichés",spanish:"No temas a los clichés"},{english:"What is the reality of the situation?",spanish:"¿Cuál es la realidad de la situación?"},{english:"Are there sections? Consider transitions",spanish:"¿Hay secciones? Considera las transiciones"},{english:"Turn it upside down",spanish:"Dale la vuelta"},{english:"Allow an easement (an easement is the abandonment of a stricture)",spanish:"Permite una servidumbre (una servidumbre es el abandono de una restricción)"},{english:"Simple subtraction",spanish:"Sustracción simple"},{english:"Remove specifics and convert to ambiguities",spanish:"Elimina detalles específicos y conviértelos en ambigüedades"},{english:"Go slowly all the way round the outside",spanish:"Ve despacio por todo el exterior"},{english:"A line has two sides",spanish:"Una línea tiene dos lados"},{english:"Infinitesimal gradations",spanish:"Gradaciones infinitesimales"},{english:"Make an exhaustive list of everything you might do and do the last thing on the list",spanish:"Haz una lista exhaustiva de todo lo que podrías hacer y haz lo último de la lista"},{english:"Into the impossible",spanish:"Hacia lo imposible"},{english:"Ask people to work against their better judgment",spanish:"Pide a la gente que actúe contra su mejor juicio"},{english:"Take away the elements in order of apparent non-importance",spanish:"Quita los elementos en orden de aparente poca importancia"},{english:"Change instrument roles",spanish:"Cambia los roles de los instrumentos"},{english:"Accretion",spanish:"Acreción"},{english:"Disconnect from desire",spanish:"Desconéctate del deseo"},{english:"Emphasize repetitions",spanish:"Enfatiza las repeticiones"},{english:"Don’t be afraid of things because they’re easy to do",spanish:"No temas a las cosas porque sean fáciles de hacer"},{english:"Is there something missing?",spanish:"¿Falta algo?"},{english:"Don’t be frightened to display your talents",spanish:"No temas mostrar tus talentos"},{english:"Breathe more deeply",spanish:"Respira más profundamente"},{english:"Honor thy error as a hidden intention",spanish:"Honra tu error como una intención oculta"},{english:"Only one element of each kind",spanish:"Solo un elemento de cada tipo"},{english:"Use unqualified people",spanish:"Usa gente no calificada"},{english:"How would you have done it?",spanish:"¿Cómo lo habrías hecho tú?"},{english:"Emphasize differences",spanish:"Enfatiza las diferencias"},{english:"Do nothing for as long as possible",spanish:"No hagas nada el mayor tiempo posible"},{english:"Bridges (build / burn)",spanish:"Puentes (construir / quemar)"},{english:"Water",spanish:"Agua"},{english:"You don’t have to be ashamed of using your own ideas",spanish:"No tienes que avergonzarte de usar tus propias ideas"},{english:"Tidy up",spanish:"Ordena"},{english:"Do the words need changing?",spanish:"¿Hay que cambiar las palabras?"},{english:"Ask your body",spanish:"Pregunta a tu cuerpo"},{english:"Make a sudden, destructive unpredictable action; incorporate",spanish:"Haz una acción repentina, destructiva e impredecible; incorpórala"},{english:"Consult other sources",spanish:"Consulta otras fuentes"},{english:"Use an unacceptable color",spanish:"Usa un color inaceptable"},{english:"Humanize something free of error",spanish:"Humaniza algo libre de errores"},{english:"Use filters",spanish:"Usa filtros"},{english:"Balance the consistency principle with the inconsistency principle",spanish:"Equilibra el principio de consistencia con el de inconsistencia"},{english:"Fill every beat with something",spanish:"Rellena cada pulso con algo"},{english:"Discard an axiom",spanish:"Descarta un axioma"},{english:"What wouldn’t you do?",spanish:"¿Qué no harías?"},{english:"Decorate, decorate",spanish:"Decora, decora"},{english:"Do nothing for as long as possible",spanish:"No hagas nada el mayor tiempo posible"},{english:"Listen to the quiet voice",spanish:"Escucha la voz tranquila"},{english:"Is it finished?",spanish:"¿Está terminado?"},{english:"Put in earplugs",spanish:"Ponte tapones en los oídos"},{english:"Give the game away",spanish:"Revela el secreto"},{english:"Reverse",spanish:"Invertir"},{english:"Abandon normal instruments",spanish:"Abandona los instrumentos normales"},{english:"Use fewer notes",spanish:"Usa menos notas"},{english:"Repetition is a form of change",spanish:"La repetición es una forma de cambio"},{english:"Give way to your worst impulse",spanish:"Cede a tu peor impulso"},{english:"Trust in the you of now",spanish:"Confía en tu yo de ahora"},{english:"What would your closest friend do?",spanish:"¿Qué haría tu amigo más cercano?"},{english:"Distorting time",spanish:"Distorsionando el tiempo"},{english:"Make a blank valuable by putting it in an exquisite frame",spanish:"Haz valioso un vacío poniéndolo en un marco exquisito"},{english:"The inconsistency principle",spanish:"El principio de inconsistencia"},{english:"Ghost echoes",spanish:"Ecos fantasma"},{english:"You can only make one dot at a time",spanish:"Solo puedes hacer un punto a la vez"},{english:"Just carry on",spanish:"Sigue adelante"},{english:"(Organic) machinery",spanish:"Maquinaria (orgánica)"},{english:"Don’t break the silence",spanish:"No rompas el silencio"},{english:"Discover the recipes you are using and abandon them",spanish:"Descubre las recetas que usas y abandónalas"},{english:"Cascades",spanish:"Cascadas"},{english:"Courage!",spanish:"¡Coraje!"},{english:"What mistakes did you make last time?",spanish:"¿Qué errores cometiste la última vez?"},{english:"You are an engineer",spanish:"Eres un ingeniero"},{english:"Consider different fading systems",spanish:"Considera diferentes sistemas de desvanecimiento"},{english:"Mute and continue",spanish:"Silencia y continúa"},{english:"It is quite possible (after all)",spanish:"Es bastante posible (después de todo)"},{english:"Don’t stress one thing more than another",spanish:"No estreses una cosa más que otra"},{english:"Remove ambiguities and convert to specifics",spanish:"Elimina ambigüedades y conviértelas en específicas"},{english:"Look at the order in which you do things",spanish:"Mira el orden en que haces las cosas"},{english:"Go outside. Shut the door.",spanish:"Sal afuera. Cierra la puerta."},{english:"Do we need holes?",spanish:"¿Necesitamos agujeros?"},{english:"Cluster analysis",spanish:"Análisis de conglomerados"},{english:"Work at a different speed",spanish:"Trabaja a una velocidad diferente"},{english:"Do something boring",spanish:"Haz algo aburrido"},{english:"Define an area as “safe” and use it as an anchor",spanish:"Define un área como “segura” y úsala como ancla"},{english:"Overtly resist change",spanish:"Resiste abiertamente el cambio"},{english:"Accept advice",spanish:"Acepta consejos"},{english:"Look closely at the most embarrassing details and amplify them",spanish:"Mira de cerca los detalles más vergonzosos y amplifícalos"},{english:"Mechanicalize something idiosyncratic",spanish:"Mecaniza algo idiosincrático"},{english:"Emphasize the flaws",spanish:"Enfatiza los defectos"},{english:"Remember those quiet evenings",spanish:"Recuerda aquellas noches tranquilas"},{english:"Take a break",spanish:"Tómate un descanso"},{english:"The tape is now the music",spanish:"La cinta ahora es la música"},{english:"Short circuit (example: a man eating peas with the idea that they will improve his virility shovels them straight into his lap)",spanish:"Cortocircuito (ejemplo: un hombre que come guisantes con la idea de que mejorarán su virilidad se los echa directamente en el regazo)"},{english:"Use an old idea",spanish:"Usa una idea antigua"},{english:"Destroy nothing / the most important thing",spanish:"Destruye nada / lo más importante"},{english:"Change nothing and continue with immaculate consistency",spanish:"No cambies nada y continúa con una consistencia inmaculada"},{english:"Imagine the music as a moving chain or caterpillar",spanish:"Imagina la música como una cadena o una oruga en movimiento"},{english:"Intentions (credibility of / nobility of / humility of)",spanish:"Intenciones (credibilidad / nobleza / humildad)"},{english:"Imagine the music as a set of disconnected events",spanish:"Imagina la música como un conjunto de eventos desconectados"},{english:"Imagine the piece as a set of disconnected events",spanish:"Imagina la pieza como un conjunto de eventos desconectados"},{english:"What are you really thinking about just now? Incorporate.",spanish:"¿En qué estás pensando realmente ahora? Incorpóralo."},{english:"Children’s voices (speaking / singing)",spanish:"Voces de niños (hablando / cantando)"},{english:"Assemble some of the instruments in a group and treat the group",spanish:"Reúne algunos instrumentos en un grupo y trata al grupo"},{english:"Shut the door and listen from outside",spanish:"Cierra la puerta y escucha desde fuera"},{english:"Is the tuning appropriate?",spanish:"¿Es adecuada la afinación?"},{english:"Look at a very small object, look at its centre",spanish:"Mira un objeto muy pequeño, mira su centro"},{english:"Feedback recordings into an acoustic situation",spanish:"Retroalimenta grabaciones en una situación acústica"},{english:"Towards the insignificant",spanish:"Hacia lo insignificante"},{english:"Simply a matter of work",spanish:"Simplemente una cuestión de trabajo"},{english:"Not building a wall but making a brick",spanish:"No construir un muro sino hacer un ladrillo"},{english:"Revaluation (a warm feeling)",spanish:"Revalorización (una sensación cálida)"},{english:"Disciplined self-indulgence",spanish:"Autoindulgencia disciplinada"},{english:"The most important thing is the thing most easily forgotten",spanish:"Lo más importante es lo más fácilmente olvidado"},{english:"Idiot glee",spanish:"Gozo idiota"},{english:"Be extravagant",spanish:"Sé extravagante"},{english:"State the problem in words as clearly as possible",spanish:"Expón el problema en palabras lo más claramente posible"},{english:"Always first steps",spanish:"Siempre los primeros pasos"},{english:"Question the heroic approach",spanish:"Cuestiona el enfoque heroico"},{english:"Always give yourself credit for having more than personality",spanish:"Siempre date crédito por tener más que personalidad"},{english:"Faced with a choice, do both",spanish:"Ante una elección, haz ambas"},{english:"Tape your mouth",spanish:"Cierra la boca con cinta"},{english:"Twist the spine",spanish:"Gira la columna"},{english:"Get your neck massaged",spanish:"Recibe un masaje en el cuello"},{english:"Do the washing up",spanish:"Lava los platos"},{english:"Convert a melodic element into a rhythmic element",spanish:"Convierte un elemento melódico en un elemento rítmico"},{english:"Spectrum analysis",spanish:"Análisis de espectro"},{english:"Lowest common denominator check (single beat / single note / single riff)",spanish:"Chequeo del mínimo común denominador (un solo pulso / una sola nota / un solo riff)"},{english:"Listen in total darkness, or in a very large room, very quietly",spanish:"Escucha en completa oscuridad, o en una habitación muy grande, muy silenciosamente"},{english:"Would anybody want it?",spanish:"¿Alguien lo querría?"},{english:"Retrace your steps",spanish:"Rehaz tus pasos"},{english:"Go to an extreme, move back to a more comfortable place",spanish:"Ve a un extremo, regresa a un lugar más cómodo"},{english:"Once the search is in progress, something will be found",spanish:"Una vez iniciada la búsqueda, se encontrará algo"},{english:"Only a part, not the whole",spanish:"Solo una parte, no el todo"},{english:"From nothing to more than nothing",spanish:"De nada a más que nada"},{english:"Be less critical more often",spanish:"Sé menos crítico más a menudo"}],en=({theme:s,isDark:t,onClose:a})=>{const[l,g]=b.useState(()=>$e[Math.floor(Math.random()*$e.length)]),[k,p]=b.useState(!1),r=()=>{p(!0),setTimeout(()=>{g($e[Math.floor(Math.random()*$e.length)]),p(!1)},300)};return e.jsx("div",{className:`fixed inset-0 z-[70] flex items-center justify-center ${s.modalOverlay} p-4 animate-in fade-in duration-200`,children:e.jsxs("div",{className:`w-full max-w-sm ${t?"bg-[#0f1219]":"bg-white"} rounded-2xl border ${s.divider} shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200`,children:[e.jsxs("div",{className:`p-4 border-b ${s.divider} flex justify-between items-center bg-gradient-to-r ${t?"from-purple-900/30 to-blue-900/30":"from-purple-100 to-blue-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-purple-500 to-blue-500 text-white",children:e.jsx(is,{size:18})}),e.jsxs("div",{children:[e.jsx("h2",{className:`text-lg font-bold ${s.textMain}`,children:"Estrategias Oblicuas"}),e.jsx("p",{className:`text-xs ${s.textMuted}`,children:"Brian Eno & Peter Schmidt"})]})]}),e.jsx("button",{onClick:a,className:`p-2 ${s.textMuted} hover:${s.textMain} rounded-full transition-colors`,children:e.jsx(ge,{size:20})})]}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:`relative min-h-[200px] rounded-xl border-2 border-dashed ${t?"border-purple-500/30 bg-purple-500/5":"border-purple-200 bg-purple-50"} p-6 flex flex-col items-center justify-center text-center transition-all duration-300 ${k?"opacity-0 scale-95":"opacity-100 scale-100"}`,children:[e.jsx(pa,{size:24,className:`mb-4 ${t?"text-purple-400":"text-purple-500"}`}),e.jsx("p",{className:`text-lg font-bold ${s.textMain} mb-3 leading-relaxed`,children:l.spanish}),e.jsxs("p",{className:`text-sm ${s.textMuted} italic`,children:['"',l.english,'"']})]})}),e.jsxs("div",{className:`p-4 border-t ${s.divider} flex gap-3`,children:[e.jsx(L,{variant:"outline",className:"flex-1",onClick:a,children:"Cerrar"}),e.jsxs(L,{className:"flex-1 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white",onClick:r,disabled:k,children:[e.jsx(Sa,{size:16,className:`mr-2 ${k?"animate-spin":""}`}),"Nueva carta"]})]})]})})},Ia=({department:s})=>{const[t,a]=b.useState(""),[l,g]=b.useState(!1),{toast:k}=zs(),p=async r=>{if(r.preventDefault(),!!t.trim())try{g(!0);const{data:M}=await P.auth.getUser();if(!M.user)throw new Error("No user found");if(!["sound","lights","video"].includes(s))throw new Error("Invalid department");const{error:z}=await P.from("messages").insert({content:t,sender_id:M.user.id,department:s});if(z)throw z;a(""),k({title:"Mensaje enviado",description:"Tu mensaje se ha enviado a la dirección."})}catch{k({title:"Error",description:"No se pudo enviar el mensaje. Inténtalo de nuevo.",variant:"destructive"})}finally{g(!1)}};return e.jsxs("form",{onSubmit:p,className:"space-y-4",children:[e.jsx(Ze,{value:t,onChange:r=>a(r.target.value),placeholder:"Escribe tu mensaje aquí...",className:"min-h-[100px]"}),e.jsx(L,{type:"submit",disabled:l||!t.trim(),className:"w-full",children:l?"Enviando...":e.jsxs(e.Fragment,{children:[e.jsx(fa,{className:"mr-2 h-4 w-4"}),"Enviar mensaje"]})})]})},sn=({theme:s,isDark:t,userProfile:a,onClose:l})=>{const[g,k]=b.useState("department"),p=(a==null?void 0:a.department)||null;return e.jsx("div",{className:`fixed inset-0 z-[70] flex items-center justify-center ${s.modalOverlay} p-4 animate-in fade-in duration-200`,children:e.jsxs("div",{className:`w-full max-w-2xl max-h-[85vh] ${t?"bg-[#0f1219]":"bg-white"} rounded-2xl border ${s.divider} shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200 flex flex-col`,children:[e.jsxs("div",{className:`p-4 border-b ${s.divider} flex justify-between items-center shrink-0`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-2 rounded-lg bg-purple-500 text-white",children:e.jsx(ts,{size:18})}),e.jsx("h2",{className:`text-lg font-bold ${s.textMain}`,children:"Mensajes"})]}),e.jsx("button",{onClick:l,className:`p-2 ${s.textMuted} hover:${s.textMain} rounded-full transition-colors`,children:e.jsx(ge,{size:20})})]}),e.jsxs("div",{className:`flex border-b ${s.divider} shrink-0`,children:[e.jsx("button",{onClick:()=>k("department"),className:`flex-1 py-3 text-sm font-medium transition-colors ${g==="department"?`${s.textMain} border-b-2 border-purple-500`:`${s.textMuted} hover:${s.textMain}`}`,children:"Departamento"}),e.jsx("button",{onClick:()=>k("direct"),className:`flex-1 py-3 text-sm font-medium transition-colors ${g==="direct"?`${s.textMain} border-b-2 border-purple-500`:`${s.textMuted} hover:${s.textMain}`}`,children:"Directos"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:g==="department"?e.jsxs("div",{className:"space-y-4",children:[p&&e.jsx(Ia,{department:p}),e.jsx(ha,{theme:s,isDark:t})]}):e.jsx(ga,{theme:s,isDark:t})})]})})},an=({tourId:s,theme:t,isDark:a,onClose:l,onOpenJob:g})=>{var T,y,u;const[k,p]=b.useState(null);b.useEffect(()=>{s&&ss(s).then(m=>p(m||null))},[s]);const{data:r,isLoading:M}=oe({queryKey:["tour-detail-tech",s],queryFn:async()=>{const{data:m,error:c}=await P.from("tours").select(`
          id, name, description, color, status, start_date, end_date,
          tour_dates (
            id,
            date,
            start_date,
            end_date,
            location_id,
            tour_date_type,
            location:locations (id, name, formatted_address)
          ),
          tour_assignments (
            id, role, department, notes,
            profiles:technician_id (id, first_name, last_name)
          )
        `).eq("id",s).single();if(c)throw c;return m},enabled:!!s}),{data:z=[]}=oe({queryKey:["tour-docs-tech",s],queryFn:async()=>{const{data:m,error:c}=await P.from("tour_documents").select("id, file_name, file_path, uploaded_at, file_type").eq("tour_id",s).order("uploaded_at",{ascending:!1}).limit(5);return c?[]:m||[]},enabled:!!s});if(M)return e.jsx("div",{className:`fixed inset-0 z-[60] ${t.bg} flex items-center justify-center`,children:e.jsx(V,{className:"h-8 w-8 animate-spin text-blue-500"})});if(!r)return e.jsx("div",{className:`fixed inset-0 z-[60] ${t.bg} flex items-center justify-center`,children:e.jsxs("div",{className:"text-center",children:[e.jsx(re,{size:48,className:t.textMuted}),e.jsx("p",{className:`mt-4 ${t.textMuted}`,children:"No se pudo cargar la gira"}),e.jsx(L,{onClick:l,className:"mt-4",children:"Volver"})]})});const x=r.tour_dates||[],N=new Date,I=x.filter(m=>new Date(m.date)<N),n=x.filter(m=>new Date(m.date)>=N).sort((m,c)=>new Date(m.date).getTime()-new Date(c.date).getTime())[0],f=x.length>0?I.length/x.length*100:0,E=((T=r.tour_assignments)==null?void 0:T.length)||0,C=()=>{if(!r.start_date&&!r.end_date)return"Sin fechas";const m=r.start_date?O(new Date(r.start_date),"d 'de' MMM",{locale:K}):"",c=r.end_date?O(new Date(r.end_date),"d 'de' MMM, yyyy",{locale:K}):"";return m&&c?`${m} - ${c}`:m||c},U=m=>new Date(m.date)<N?"done":n&&m.id===n.id?"next":"upcoming",q=async m=>{try{const{data:c,error:$}=await P.storage.from("tour-documents").createSignedUrl(m.file_path,60);if($||!(c!=null&&c.signedUrl))throw $||new Error("Failed to generate URL");window.open(c.signedUrl,"_blank")}catch{W.error("No se pudo abrir el documento")}};return e.jsxs("div",{className:`fixed inset-0 z-[60] ${t.bg} overflow-y-auto`,children:[e.jsxs("div",{className:`relative pt-6 pb-5 px-5 border-b ${t.divider} overflow-hidden`,children:[e.jsx("div",{className:"absolute inset-0 opacity-30",style:{background:`linear-gradient(to bottom, ${r.color||"#3b82f6"}40, transparent)`}}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("button",{onClick:l,className:`flex items-center gap-1 text-xs font-bold ${t.textMuted} mb-4`,children:[e.jsx(ba,{size:14})," Volver"]}),e.jsxs("div",{className:"flex items-start gap-4",children:[k&&e.jsx("img",{src:k,alt:`${r.name} logo`,width:64,height:64,loading:"lazy",decoding:"async",className:"w-16 h-16 object-contain rounded-lg border border-white/20 bg-black/20 backdrop-blur-sm",onError:m=>{const c=m.target;c.style.display="none"}}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:`text-2xl font-bold ${t.textMain} mb-1`,children:r.name}),e.jsxs("div",{className:`flex items-center gap-3 text-sm ${t.textMuted}`,children:[r.description&&e.jsx("span",{children:r.description}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ie,{size:14})," ",C()]})]})]})]})]})]}),e.jsxs("div",{className:"p-5 space-y-5",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:`p-4 rounded-xl border ${t.card}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("span",{className:`text-[10px] font-bold uppercase ${t.textMuted}`,children:"Fechas"}),e.jsx(ie,{size:14,className:"text-blue-500"})]}),e.jsxs("div",{className:`text-xl font-bold ${t.textMain}`,children:[I.length," / ",x.length]}),e.jsxs("div",{className:`text-xs ${t.textMuted}`,children:[Math.round(f),"% completado"]})]}),e.jsxs("div",{className:`p-4 rounded-xl border ${t.card}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("span",{className:`text-[10px] font-bold uppercase ${t.textMuted}`,children:"Equipo"}),e.jsx(va,{size:14,className:"text-emerald-500"})]}),e.jsx("div",{className:`text-xl font-bold ${t.textMain}`,children:E}),e.jsx("div",{className:`text-xs ${t.textMuted}`,children:"técnicos asignados"})]})]}),n&&e.jsxs("div",{className:`p-5 rounded-xl border relative overflow-hidden ${t.card}`,children:[e.jsx("div",{className:"absolute top-0 right-0 p-4 opacity-5",children:e.jsx(Ae,{size:80})}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("div",{className:`text-[10px] font-bold uppercase tracking-wider ${t.textMuted} mb-1`,children:"Próximo"}),e.jsxs("div",{className:"flex justify-between items-end",children:[e.jsxs("div",{children:[e.jsx("h2",{className:`text-xl font-bold ${t.textMain}`,children:((y=n.location)==null?void 0:y.name)||"Recinto"}),e.jsx("div",{className:`text-sm ${t.textMuted}`,children:((u=n.location)==null?void 0:u.formatted_address)||n.tour_date_type||"Concierto"})]}),e.jsx("div",{className:"text-right",children:e.jsx("div",{className:"text-lg font-mono font-bold text-blue-500",children:O(new Date(n.date),"d 'de' MMM",{locale:K})})})]})]})]}),z.length>0&&e.jsxs("div",{className:`p-4 rounded-xl border ${t.card}`,children:[e.jsx("div",{className:"flex justify-between items-center mb-3",children:e.jsx("h3",{className:`font-bold text-sm ${t.textMain}`,children:"Documentos recientes"})}),e.jsx("div",{className:"space-y-2",children:z.map(m=>e.jsxs("button",{onClick:()=>q(m),className:`w-full flex items-center gap-3 p-2 rounded-lg ${a?"hover:bg-white/5":"hover:bg-slate-50"} text-left`,children:[e.jsx(je,{size:16,className:"text-blue-400 shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:`text-xs font-bold truncate ${t.textMain}`,children:m.file_name}),e.jsx("div",{className:`text-[10px] ${t.textMuted}`,children:O(new Date(m.uploaded_at),"d MMM, HH:mm",{locale:K})})]}),e.jsx(cs,{size:14,className:t.textMuted})]},m.id))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:`font-bold ${t.textMain} mb-3`,children:"Itinerario"}),e.jsx("div",{className:"space-y-2",children:x.length===0?e.jsxs("div",{className:`p-8 rounded-xl border ${t.card} text-center`,children:[e.jsx(ie,{size:32,className:`mx-auto mb-2 ${t.textMuted}`}),e.jsx("p",{className:`text-sm ${t.textMuted}`,children:"No hay fechas programadas"})]}):[...x].sort((m,c)=>new Date(m.date).getTime()-new Date(c.date).getTime()).map(m=>{var R,d;const c=U(m),$={done:"bg-emerald-500/10 text-emerald-500",next:"bg-blue-500/10 text-blue-500",upcoming:a?"bg-gray-500/10 text-gray-400":"bg-slate-100 text-slate-500"},H={done:"Hecho",next:"Próximo",upcoming:"Pendiente"};return e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-xl border ${t.card}`,children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-center w-10",children:[e.jsx("div",{className:`text-[10px] font-bold uppercase ${t.textMuted}`,children:O(new Date(m.date),"MMM",{locale:K})}),e.jsx("div",{className:`text-lg font-bold ${t.textMain}`,children:O(new Date(m.date),"d")})]}),e.jsxs("div",{children:[e.jsx("div",{className:`font-bold text-sm ${t.textMain}`,children:((R=m.location)==null?void 0:R.name)||"Recinto"}),e.jsx("div",{className:`text-xs ${t.textMuted}`,children:((d=m.location)==null?void 0:d.formatted_address)||m.tour_date_type||"Concierto"})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:`px-2 py-1 rounded text-[10px] font-bold uppercase ${$[c]}`,children:H[c]})})]},m.id)})})]})]})]})},tn=({theme:s,isDark:t,onClose:a})=>e.jsx("div",{className:"fixed inset-0 z-[60] bg-black",children:e.jsx(Na,{theme:s,isDark:t,onClose:a})}),nn=({theme:s,isDark:t=!1})=>{const{data:a,isLoading:l,error:g}=xa(),{userRole:k}=Me(),p=s||{card:t?"bg-[#0f1219] border-[#1f232e]":"bg-white border-slate-200 shadow-sm",textMain:t?"text-white":"text-slate-900",textMuted:t?"text-[#94a3b8]":"text-slate-500",divider:t?"border-[#1f232e]":"border-slate-100",danger:t?"text-red-400 bg-red-500/10 border-red-500/20":"text-red-700 bg-red-50 border-red-200",warning:t?"text-amber-400 bg-amber-500/10 border-amber-500/20":"text-amber-700 bg-amber-50 border-amber-200"},r=b.useMemo(()=>Array.from(new Set((a||[]).map(d=>d.tour_id).filter(Boolean))),[a]),M=b.useMemo(()=>Array.from(new Set((a||[]).map(d=>d.job_id).filter(Boolean))),[a]),{data:z}=ja(r),{data:x}=ra(M),[N,I]=b.useState(!0),F=d=>new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR",minimumFractionDigits:2}).format(d),n=d=>d===1?"1 fecha esta semana":`${d} fechas esta semana`,f=b.useMemo(()=>(a||[]).reduce((A,S)=>{const D=S.iso_year&&S.iso_week?`${S.iso_year}-W${S.iso_week.toString().padStart(2,"0")}`:`${Re(new Date(S.start_time))}-W${Ue(new Date(S.start_time)).toString().padStart(2,"0")}`;return A[D]||(A[D]=[]),A[D].push(S),A},{}),[a]),E=b.useMemo(()=>Object.keys(f).sort((d,A)=>{const[S,D]=d.split("-W").map(Number),[G,Z]=A.split("-W").map(Number);return S===G?D-Z:S-G}),[f]),C=b.useMemo(()=>{const d=new Date;return`${Re(d)}-W${Ue(d).toString().padStart(2,"0")}`},[]),[U,q]=b.useState(null),T=b.useMemo(()=>{const[d,A]=C.split("-W").map(Number);return E.filter(S=>{const[D,G]=S.split("-W").map(Number);return D<d||D===d&&G<=A})},[E,C]);b.useEffect(()=>{if(T.length===0){q(null);return}const d=T.find(A=>A===C);q(d??T[T.length-1])},[T,C]);const y=U?T.indexOf(U):-1,u=U?f[U]??[]:[],m=d=>{var A,S;return(d.extras_total_eur??0)>0?!0:((S=(A=d.extras)==null?void 0:A.items)==null?void 0:S.some(D=>D.quantity>0&&D.amount_eur>0))??!1},c=d=>d.tour_id?(z==null?void 0:z.get(d.tour_id))??!1?m(d)?d.job_id?(x==null?void 0:x.get(d.job_id))??!1:!1:!0:!1:m(d)?d.job_id?(x==null?void 0:x.get(d.job_id))??!1:!1:!0,$=u.filter(d=>c(d)),H=u.filter(d=>!c(d)),R=a&&a[0]?a[0].is_house_tech:!1;return e.jsxs("div",{className:`rounded-2xl border ${p.card} overflow-hidden`,children:[e.jsxs("div",{className:"p-4 flex items-center justify-between cursor-pointer hover:bg-white/5 transition-colors",onClick:()=>I(d=>!d),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${t?"bg-emerald-500/10 text-emerald-500":"bg-emerald-50 text-emerald-600"}`,children:e.jsx(Le,{size:20})}),e.jsxs("div",{children:[e.jsx("h3",{className:`font-bold ${p.textMain}`,children:"Tus tarifas de gira"}),e.jsx("div",{className:`text-xs ${p.textMuted} flex items-center gap-2`,children:n(u.length)})]})]}),e.jsx("div",{className:p.textMuted,children:N?e.jsx(Es,{size:20}):e.jsx(Ts,{size:20})})]}),N&&e.jsx("div",{className:`p-4 border-t ${p.divider} space-y-4`,children:l?e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:`h-4 ${t?"bg-white/10":"bg-slate-200"} rounded w-3/4`}),e.jsx("div",{className:`h-4 ${t?"bg-white/10":"bg-slate-200"} rounded w-1/2`})]}):g?e.jsxs("div",{className:`p-3 rounded-lg ${p.danger} flex items-start gap-2 text-sm`,children:[e.jsx(re,{className:"h-4 w-4 mt-0.5 shrink-0"}),e.jsxs("span",{children:["No se pudieron cargar tus tarifas de gira: ",g.message]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`p-3 rounded-lg ${t?"bg-blue-500/10 text-blue-400 border border-blue-500/20":"bg-blue-50 text-blue-700 border border-blue-200"} text-xs flex gap-2`,children:[e.jsx(Ma,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{children:R?"Como técnico residente, recibes la tarifa base específica de tu perfil. Los multiplicadores semanales se aplican cuando formas parte del equipo de la gira.":"Las tarifas de gira usan tu tarifa base de categoría. Los multiplicadores semanales solo se aplican si estás en el equipo de la gira para ese itinerario."})]}),(!a||a.length===0)&&e.jsx("div",{className:`text-sm ${p.textMuted} text-center py-4`,children:"No tienes asignaciones de fechas de gira próximas."}),T.length>0&&U&&e.jsxs("div",{className:`flex items-center justify-between p-2 rounded-lg ${t?"bg-white/5":"bg-slate-100"}`,children:[e.jsx(L,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>y>0&&q(T[y-1]),disabled:y<=0,children:e.jsx(Ie,{className:"h-4 w-4"})}),e.jsx("div",{className:"text-xs font-bold text-center",children:(()=>{const[d,A]=U.split("-W").map(Number),S=u[0]?new Date(u[0].start_time):new Date,D=As(S,{weekStartsOn:1}),G=Us(S,{weekStartsOn:1});return e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("span",{className:p.textMain,children:["Semana ",A," de ",d]}),e.jsxs("span",{className:p.textMuted,children:[O(D,"d MMM",{locale:K})," - ",O(G,"d MMM",{locale:K})]})]})})()}),e.jsx(L,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>y>=0&&y<T.length-1&&q(T[y+1]),disabled:y===T.length-1,children:e.jsx(ye,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"space-y-3",children:$.length>0?$.map(d=>{var le,ee,de;const A=ya(d),S=d.base_day_eur??0,D=d.extras_total_eur??0,G=wa(d),Z=((le=d.breakdown)==null?void 0:le.after_discount)??((ee=d.breakdown)==null?void 0:ee.base_calculation),ae=typeof G=="number"&&G>0,te=Z??(ae?S/G:S),X=Ke(G),ne=X.startsWith("×")?X.slice(1):X,Q=(de=d.breakdown)==null?void 0:de.error;return e.jsxs("div",{className:`rounded-xl border ${p.divider} p-3 ${t?"bg-white/5":"bg-white"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:`font-bold text-sm ${p.textMain}`,children:d.title}),e.jsxs("div",{className:`text-xs ${p.textMuted} flex items-center gap-1 mt-0.5`,children:[e.jsx(ie,{size:10}),O(new Date(d.start_time),"EEEE, d 'de' MMM",{locale:K})]})]}),e.jsx("div",{className:`font-bold text-lg ${p.textMain}`,children:F(A)})]}),e.jsxs("div",{className:"flex flex-wrap gap-1.5 mb-3",children:[d.category&&e.jsx("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-medium uppercase border ${p.divider} ${p.textMuted}`,children:d.category}),d.is_house_tech&&e.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-medium uppercase bg-purple-500/10 text-purple-500 border border-purple-500/20",children:"Fija"}),d.is_tour_team_member&&Pe(d.multiplier)&&e.jsxs("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-medium uppercase bg-blue-500/10 text-blue-500 border border-blue-500/20",children:["Multiplicador ",Ke(d.multiplier)]})]}),!d.is_tour_team_member&&!Q&&e.jsx("div",{className:`text-xs ${p.textMuted} mb-2 italic`,children:"Multiplicador de gira no aplicado: no formas parte del equipo de la gira para este recorrido."}),Q&&e.jsx("div",{className:"p-2 rounded bg-red-500/10 text-red-400 border border-red-500/20 text-xs mb-2",children:e.jsxs("div",{className:"flex gap-1.5",children:[e.jsx(re,{size:12,className:"mt-0.5"}),e.jsxs("span",{children:[d.breakdown.error==="category_missing"&&"Falta configurar tu categoría de técnico.",d.breakdown.error==="house_rate_missing"&&"Falta configurar tu tarifa de técnico residente.",d.breakdown.error==="tour_base_missing"&&"Falta la tarifa base de gira para tu categoría.",!["category_missing","house_rate_missing","tour_base_missing"].includes(d.breakdown.error)&&`Error: ${d.breakdown.error}`]})]})}),e.jsxs("div",{className:`text-xs ${p.textMuted} pt-2 border-t ${p.divider} flex justify-between items-center`,children:[e.jsx("span",{children:d.is_tour_team_member&&Pe(G)?e.jsxs(e.Fragment,{children:["Base ",F(te)," × ",ne]}):e.jsxs(e.Fragment,{children:["Base ",F(S)]})}),D>0&&e.jsxs("span",{className:"text-emerald-500 font-medium",children:["+ Extras ",F(D)]})]})]},d.job_id)}):e.jsx("div",{className:`text-sm ${p.textMuted} text-center py-6 italic`,children:H.length>0?"Las tarifas de esta semana están pendientes de aprobación.":"No hay tarifas de gira registradas para esta semana."})}),H.length>0&&e.jsxs("div",{className:`p-3 rounded-lg ${p.warning} text-xs flex gap-2`,children:[e.jsx(re,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{children:"Algunas fechas no se muestran hasta que la dirección apruebe tanto la tarifa base del tour como cada fecha individual."})]}),e.jsx("div",{className:`border-t ${p.divider} pt-3 text-[10px] ${p.textMuted} text-center`,children:"Los importes mostrados son por fecha de gira. Usa la paginación para revisar recorridos pasados o futuros."})]})})]})};export{Jt as A,Pt as D,Qt as J,sn as M,en as O,Yt as P,tn as S,Xt as T,Zt as a,nn as b,an as c};
