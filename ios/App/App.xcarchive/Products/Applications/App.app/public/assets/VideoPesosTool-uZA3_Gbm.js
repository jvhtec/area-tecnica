const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/logoUtils-D2o1jUVg.js","assets/index-NZ6jJLfQ.js","assets/vite-preload-helper-ckwbz45p.js","assets/commonjs-helpers-Cpj98o6Y.js","assets/index-DFO7exW2.css","assets/logo-url-cache-eY6nfvu7.js"])))=>i.map(i=>d[i]);
import{_ as le}from"./vite-preload-helper-ckwbz45p.js";import{c as de,e as ce,b as me,r as c,j as e,C as q,A as V,W as ue,B as u,Y as he,L as b,S as J,t as U,v as A,w as B,x as z,I as P,V as xe,s as ge}from"./index-NZ6jJLfQ.js";import{C as G}from"./checkbox-BsRNEGV1.js";import{e as pe}from"./pdfExport-DjZPdCcG.js";import{u as fe}from"./useJobSelection-B9iLNF5-.js";import{u as je,T as ve}from"./TourOverrideModeHeader-C5X_h6fg.js";import{B as X}from"./badge-vNTKF5RD.js";import{A as Ne}from"./arrow-left-VpQwT4cv.js";import{F as we}from"./file-text-igU140SQ.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./lazyPdf-xVUlxKNu.js";import"./useQuery-kdg2pmgf.js";import"./settings-egXcSQW9.js";import"./calendar-_Cj_Sgy-.js";const M=[{id:1,name:"Pantalla Central",weight:32},{id:2,name:"IMAGE Left",weight:32},{id:3,name:"IMAGE Right",weight:32},{id:4,name:"LED Screen",weight:32}];let p=0;const Le=()=>{const H=de(),{toast:h}=ce(),{data:m}=fe(),[y]=me(),x=y.get("jobId"),S=y.get("tourId"),Q=y.get("tourDateId"),{isOverrideMode:i,overrideData:n,isLoading:Y,saveOverride:K}=je(S||void 0,Q||void 0,"video"),[W,R]=c.useState(""),[Z,C]=c.useState(null),[f,_]=c.useState(""),[j,T]=c.useState([]),[N,ee]=c.useState([]),[v,k]=c.useState(!1),[L,E]=c.useState(!1),[D,w]=c.useState({name:"",rows:[{quantity:"",componentId:"",weight:""}]});c.useEffect(()=>{(async()=>{if(x)try{R(x);const s=(m||[]).find(r=>r.id===x)||null;if(s){C(s);return}const{data:a}=await ge.from("jobs").select("id, title, start_time").eq("id",x).single();a&&C(a)}catch{}})()},[x,m]);const I=()=>{if(v){p++;const t=p.toString().padStart(2,"0");p++;const s=p.toString().padStart(2,"0");return`VX${t}, VX${s}`}else return p++,`VX${p.toString().padStart(2,"0")}`},te=()=>{w(t=>({...t,rows:[...t.rows,{quantity:"",componentId:"",weight:""}]}))},se=t=>{w(s=>{const a=s.rows.filter((r,o)=>o!==t);return{...s,rows:a.length>0?a:[{quantity:"",componentId:"",weight:""}]}})},$=(t,s,a)=>{const r=[...D.rows];if(s==="componentId"){const o=M.find(l=>l.id.toString()===a);r[t]={...r[t],[s]:a,weight:o?o.weight.toString():""}}else r[t]={...r[t],[s]:a};w(o=>({...o,rows:r}))},ae=t=>{R(t);const s=(m==null?void 0:m.find(a=>a.id===t))||null;C(s)},F=async t=>{if(i&&n){await K("weight",{item_name:t.name,weight_kg:t.totalWeight||0,quantity:1,category:"video",override_data:{rows:t.rows,dualMotors:t.dualMotors,riggingPoints:t.riggingPoints,clusterId:t.clusterId,toolType:"pesos"}})&&h({title:"Success",description:"Weight override saved for tour date"});return}W&&h({title:"Success",description:"Weight table created successfully"})},re=()=>{if(!f){h({title:"Missing table name",description:"Please enter a name for the table",variant:"destructive"});return}const t=D.rows.map(r=>{const o=M.find(d=>d.id.toString()===r.componentId),l=parseFloat(r.quantity)&&parseFloat(r.weight)?parseFloat(r.quantity)*parseFloat(r.weight):0;return{...r,componentName:(o==null?void 0:o.name)||"",totalWeight:l}}),s=t.reduce((r,o)=>r+(o.totalWeight||0),0),a=Date.now().toString();if(L){const r=I(),o=I(),l={name:`${f} L (${r})`,riggingPoints:r,rows:t,totalWeight:s,id:Date.now(),dualMotors:v,clusterId:a},d={name:`${f} R (${o})`,riggingPoints:o,rows:t,totalWeight:s,id:Date.now()+1,dualMotors:v,clusterId:a};T(g=>[...g,l,d]),F(l),F(d)}else{const r=I(),o={name:`${f} (${r})`,riggingPoints:r,rows:t,totalWeight:s,id:Date.now(),dualMotors:v,clusterId:a};T(l=>[...l,o]),F(o)}O()},O=()=>{w({name:"",rows:[{quantity:"",componentId:"",weight:""}]}),_(""),k(!1),E(!1)},oe=t=>{typeof t=="number"&&T(s=>s.filter(a=>a.id!==t))},ie=async()=>{const t=i&&n?{id:"override",title:`${n.tourName} - ${n.locationName}`}:Z;if(!t){h({title:i?"No tour data":"No job selected",description:i?"Tour data not loaded":"Please select a job before exporting.",variant:"destructive"});return}try{const s=i?[...N,...j]:j;let a;try{if(i&&S){const{fetchTourLogo:g}=await le(async()=>{const{fetchTourLogo:ne}=await import("./logoUtils-D2o1jUVg.js");return{fetchTourLogo:ne}},__vite__mapDeps([0,1,2,3,4,5]));a=await g(S)}}catch{}const r=await pe(t.title,s.map(g=>({...g,toolType:"pesos"})),"weight",t.title,(t==null?void 0:t.start_time)||new Date().toISOString(),void 0,void 0,0,a),o=`Video Weight Report - ${t.title}.pdf`,l=window.URL.createObjectURL(r),d=document.createElement("a");d.href=l,d.download=o,document.body.appendChild(d),d.click(),window.URL.revokeObjectURL(l),document.body.removeChild(d),h({title:"Success",description:"PDF has been generated successfully."})}catch{h({title:"Error",description:"Failed to generate the PDF.",variant:"destructive"})}};return c.useEffect(()=>{if(i&&n){const t=n.defaults.filter(s=>s.table_type==="weight").map(s=>({name:`${s.table_name} (Default)`,rows:s.table_data.rows||[],totalWeight:s.total_value,id:`default-${s.id}`,isDefault:!0}));ee(t)}},[i,n]),Y?e.jsx(q,{className:"w-full max-w-4xl mx-auto my-6",children:e.jsx(V,{className:"pt-6",children:e.jsx("p",{children:"Loading tour override data..."})})}):e.jsxs(q,{className:"w-full max-w-4xl mx-auto my-6",children:[e.jsx(ue,{className:"space-y-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(u,{variant:"ghost",size:"icon",onClick:()=>H("/video"),children:e.jsx(Ne,{className:"h-4 w-4"})}),e.jsxs(he,{className:"text-2xl font-bold",children:[i?"Override Mode - ":"","Video Weight Calculator"]})]})}),e.jsx(V,{children:e.jsxs("div",{className:"space-y-6",children:[i&&n&&e.jsx(ve,{tourName:n.tourName,tourDate:n.tourDate,locationName:n.locationName,defaultsCount:N.length,overridesCount:j.length,department:"video"}),i&&N.length>0&&e.jsxs("div",{className:"border rounded-lg p-4 bg-green-50",children:[e.jsx("h3",{className:"font-semibold mb-3 text-green-800",children:"Tour Defaults (Read-Only)"}),N.map(t=>{var s;return e.jsxs("div",{className:"border rounded-lg overflow-x-auto mt-4 bg-white",children:[e.jsx("div",{className:"bg-green-100 px-4 py-3 flex justify-between items-center",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold",children:t.name}),e.jsx(X,{variant:"outline",className:"bg-green-50 text-green-700",children:"Default"})]})}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Total Weight:"})," ",(s=t.totalWeight)==null?void 0:s.toFixed(2)," kg"]})})]},t.id)})]}),!x&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"jobSelect",children:"Select Job"}),e.jsxs(J,{value:W,onValueChange:ae,children:[e.jsx(U,{children:e.jsx(A,{placeholder:"Select a job"})}),e.jsx(B,{children:m==null?void 0:m.map(t=>e.jsx(z,{value:t.id,children:t.title},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"tableName",children:"Table Name"}),e.jsx(P,{id:"tableName",value:f,onChange:t=>_(t.target.value),placeholder:"Enter table name"}),e.jsxs("div",{className:"flex items-center space-x-2 mt-2",children:[e.jsx(G,{id:"dualMotors",checked:v,onCheckedChange:t=>k(t)}),e.jsx(b,{htmlFor:"dualMotors",className:"text-sm font-medium",children:"Dual Motors Configuration"})]}),e.jsxs("div",{className:"flex items-center space-x-2 mt-2",children:[e.jsx(G,{id:"mirroredCluster",checked:L,onCheckedChange:t=>E(t)}),e.jsx(b,{htmlFor:"mirroredCluster",className:"text-sm font-medium",children:"Mirrored Cluster"})]})]}),e.jsx("div",{className:"border rounded-lg overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Quantity"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Component"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Weight (per unit)"}),e.jsx("th",{className:"w-12 px-4 py-3 text-left font-medium",children:"Â "})]})}),e.jsx("tbody",{children:D.rows.map((t,s)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-4",children:e.jsx(P,{type:"number",value:t.quantity,onChange:a=>$(s,"quantity",a.target.value),min:"0",className:"w-full"})}),e.jsx("td",{className:"p-4",children:e.jsxs(J,{value:t.componentId,onValueChange:a=>$(s,"componentId",a),children:[e.jsx(U,{className:"w-full",children:e.jsx(A,{placeholder:"Select component"})}),e.jsx(B,{children:M.map(a=>e.jsx(z,{value:a.id.toString(),children:a.name},a.id))})]})}),e.jsx("td",{className:"p-4",children:e.jsx(P,{type:"number",value:t.weight,readOnly:!0,className:"w-full bg-muted"})}),e.jsx("td",{className:"p-4",children:e.jsx(u,{type:"button",variant:"ghost",size:"icon",onClick:()=>se(s),className:"text-destructive hover:text-destructive","aria-label":"Delete row",children:e.jsx(xe,{className:"h-4 w-4"})})})]},s))})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{onClick:te,children:"Add Row"}),e.jsx(u,{onClick:re,variant:"secondary",children:"Generate Table"}),e.jsx(u,{onClick:O,variant:"destructive",children:"Reset"}),j.length>0&&e.jsxs(u,{onClick:ie,variant:"outline",className:"ml-auto gap-2",children:[e.jsx(we,{className:"h-4 w-4"}),"Export PDF"]})]}),j.map(t=>{var s;return e.jsxs("div",{className:"border rounded-lg overflow-x-auto mt-6",children:[e.jsxs("div",{className:"bg-muted px-4 py-3 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold",children:t.name}),i&&e.jsx(X,{variant:"outline",className:"bg-orange-50 text-orange-700",children:"Override"})]}),typeof t.id=="number"&&e.jsx(u,{variant:"destructive",size:"sm",onClick:()=>oe(t.id),children:"Remove Table"})]}),e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-muted/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Quantity"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Component"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Weight (per unit)"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Total Weight"})]})}),e.jsxs("tbody",{children:[t.rows.map((a,r)=>{var o;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:a.quantity}),e.jsx("td",{className:"px-4 py-3",children:a.componentName}),e.jsx("td",{className:"px-4 py-3",children:a.weight}),e.jsx("td",{className:"px-4 py-3",children:(o=a.totalWeight)==null?void 0:o.toFixed(2)})]},r)}),e.jsxs("tr",{className:"border-t bg-muted/50 font-medium",children:[e.jsx("td",{colSpan:3,className:"px-4 py-3 text-right",children:"Total Weight:"}),e.jsxs("td",{className:"px-4 py-3",children:[(s=t.totalWeight)==null?void 0:s.toFixed(2)," kg"]})]})]})]}),t.dualMotors&&e.jsx("div",{className:"px-4 py-2 text-sm text-gray-500 bg-muted/30 italic",children:"*This configuration uses dual motors. Load is distributed between two motors for safety and redundancy."}),t.riggingPoints&&e.jsxs("div",{className:"px-4 py-2 text-sm text-blue-600 bg-blue-50 border-t",children:[e.jsx("strong",{children:"Rigging Points:"})," ",t.riggingPoints]})]},t.id)})]})})]})};export{Le as default};
