import{u as f}from"./useQuery-kdg2pmgf.js";import{m as h,r as u}from"./index-NZ6jJLfQ.js";import{parseEventDates as g,getWeatherForJob as y}from"./weatherApi-BatwQpQy.js";const x=new Set(["sound","lights","video","production","logistics","administrative"]),q=t=>{const r=(t||"").replace(/^\/+/,""),e=r.split("/"),a=e[0]??"";return a==="soundvision-files"?{bucket:"soundvision-files",path:e.slice(1).join("/")}:{bucket:x.has(a)?"job_documents":"job-documents",path:r}},k=async(t,r,e=60)=>{const{bucket:a,path:o}=q(r),{data:n,error:s}=await t.storage.from(a).createSignedUrl(o,e);if(s)throw s;if(!(n!=null&&n.signedUrl))throw new Error("Failed to generate signed URL");return n.signedUrl};function S(t){return f({queryKey:["tour-job-rate-quotes",t],queryFn:async()=>{const r=h.from("v_tour_job_rate_quotes_2025").select("*");t&&r.eq("job_id",t);const{data:e,error:a}=await r;if(a)throw a;return(e||[]).map(o=>({...o,per_job_multiplier:o.per_job_multiplier!=null?Number(o.per_job_multiplier):void 0,is_tour_team_member:o.is_tour_team_member??!1,extras_total_eur:o.extras_total_eur??void 0,total_with_extras_eur:o.total_with_extras_eur??void 0,extras:o.extras,breakdown:o.breakdown}))},enabled:!!t,staleTime:30*1e3})}function T(){return f({queryKey:["technician-tour-rate-quotes"],queryFn:async()=>{const{data:t,error:r}=await h.from("v_tour_job_rate_quotes_2025").select("*").order("start_time",{ascending:!0});if(r)throw r;return(t||[]).map(e=>({...e,per_job_multiplier:e.per_job_multiplier!=null?Number(e.per_job_multiplier):void 0,is_tour_team_member:e.is_tour_team_member??!1,extras_total_eur:e.extras_total_eur??void 0,total_with_extras_eur:e.total_with_extras_eur??void 0,extras:e.extras,breakdown:e.breakdown}))},staleTime:30*1e3})}const z=({venue:t,eventDates:r,onWeatherUpdate:e})=>{var d,b;const[a,o]=u.useState(!1),[n,s]=u.useState(null),[m,p]=u.useState(null),c=u.useCallback(async()=>{if(!r||!t.address&&!t.coordinates)return s("Se requieren fechas del evento y ubicación para obtener el clima"),null;try{const i=g(r);if(i){const l=new Date,_=new Date(l);if(_.setDate(_.getDate()+16),i.startDate>_){const w=`Requested weather starts beyond available forecast horizon: ${r}`;return s(w),e(void 0),null}}}catch{}o(!0),s(null);try{const i=await y(t,r);return e(i||void 0),p(new Date),i||s("No se pudieron obtener datos meteorológicos para esta ubicación y fecha"),i}catch{return s("Error al obtener datos meteorológicos. Verifique la conexión a internet."),null}finally{o(!1)}},[t.address,t.coordinates,r,e]);return u.useEffect(()=>{if(r&&(t.address||t.coordinates)&&!a){const l=setTimeout(()=>{c()},500);return()=>clearTimeout(l)}},[c,r,t.address,(d=t.coordinates)==null?void 0:d.lat,(b=t.coordinates)==null?void 0:b.lng,a]),{isLoading:a,error:n,lastFetch:m,fetchWeather:c}};export{T as a,S as b,k as c,q as r,z as u};
