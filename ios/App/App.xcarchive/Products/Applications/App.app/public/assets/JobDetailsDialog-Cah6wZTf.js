import{l as Ve,a4 as Q,j as e,C as q,W as me,Y as ue,A as ie,B as z,n as C,m as P,i as Y,h as W,f as Se,a as xe,L as ne,S as Te,t as Ee,v as Pe,w as Me,x as Ae,I as pe,ac as Fe,D as be,q as ke,F as We,G as qe,aL as Ye,r as B,M as _e,o as ve,R as Je,u as Ze}from"./index-NZ6jJLfQ.js";import{u as I}from"./useQuery-kdg2pmgf.js";import{c as ae,T as De,a as es,b as se}from"./tabs-BdaywI_b.js";import{u as ss}from"./useTourRateSubscriptions-Dd0aSU9f.js";import{u as as}from"./JobExtrasEditor-gQe73Sd8.js";import{u as rs}from"./useJobRatesApproval-DsfA8V9C.js";import{B as O}from"./badge-vNTKF5RD.js";import{S as ts}from"./switch-DUBpZhIC.js";import{A as ce,a as de}from"./alert-BqA-5jRM.js";import{b as ns,r as Le,u as is}from"./useWeatherData-d0TEdKFc.js";import{u as cs,s as ds,J as ls}from"./JobPayoutTotalsPanel-BSlgp62i.js";import{g as os,f as ms,c as ye,s as us}from"./tourRateMath-BOmIkfWO.js";import{s as $e,g as xs,S as hs,a as Re,b as ps,c as fs}from"./useManagerJobQuotes-BrI1iNRY.js";import{E as Ne}from"./euro-DgRTeGAz.js";import{T as Ce}from"./triangle-alert-D6qN0F8g.js";import{U as he}from"./users-DMnpVLUq.js";import{S as gs}from"./send-Uvkx0r_O.js";import{C as Ge}from"./calendar-_Cj_Sgy-.js";import{C as le}from"./circle-alert-LZYNzZ7F.js";import{J as _s}from"./JobExtrasManagement-CpH8R_KL.js";import{S as He}from"./separator-E-JdTFOv.js";import{R as ze}from"./receipt-CWKVL4Rh.js";import{C as vs}from"./clock-BXPvTWvY.js";import{C as ys}from"./circle-check-C0N48OpO.js";import{C as Ns}from"./circle-x-DDzV-xk_.js";import{e as te}from"./es-CSiFCUGj.js";import{F as je}from"./file-text-igU140SQ.js";import{E as Ue}from"./eye-BE_DouVP.js";import{D as Ke}from"./download-C1rVE0-J.js";import{mergePDFs as js}from"./pdfMerge-DXtLP7Xx.js";import{g as ws}from"./timesheet-pdf-82e1LStH.js";import{E as bs}from"./external-link-QJoXZ6ES.js";import{T as ks}from"./truck-Br5sduv3.js";import{A as Cs,b as Ss,a as Ts}from"./avatar-QSp4LpEt.js";import{G as Es,P as Ps}from"./places-restaurant-service-CakuSyx6.js";import{U as Be}from"./utensils-crossed-CZeagqP3.js";import{P as Ms}from"./phone-BlFwiuho.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const As=Ve("CloudUpload",[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=Ve("Cloud",[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]]),we=30,Fs=({jobId:i})=>{const{data:t,isLoading:s,error:m}=ns(i),N=cs(),{data:v=[]}=I({queryKey:["profiles-for-tour-rates",t==null?void 0:t.map(c=>c.technician_id)],queryFn:async()=>{if(!(t!=null&&t.length))return[];const c=[...new Set(t.map(x=>x.technician_id))],{data:u,error:a}=await P.from("profiles").select("id, first_name, last_name, role, email, autonomo").in("id",c);if(a)throw a;return u},enabled:!!(t!=null&&t.length)}),T=v,d=Q.useMemo(()=>new Map(T.map(c=>[c.id,c])),[T]),{data:h}=I({queryKey:["tour-rates-job-meta",i],enabled:!!i,queryFn:async()=>{const{data:c,error:u}=await P.from("jobs").select("id, title, start_time, tour_id, rates_approved").eq("id",i).maybeSingle();if(u)throw u;return c},staleTime:6e4});h!=null&&h.rates_approved;const[p,y]=Q.useState(!1),[j,r]=Q.useState({}),w=Q.useMemo(()=>[...new Set(t==null?void 0:t.map(c=>c.job_id).filter(Boolean))],[t]),{data:k=new Map}=I({queryKey:["tour-rates-approvals",w],enabled:w.length>0,queryFn:async()=>{const{data:c,error:u}=await P.from("timesheets").select("job_id, technician_id, approved_by_manager").in("job_id",w);if(u)throw u;const a=new Map;c==null||c.forEach(l=>{if(!l.technician_id||!l.job_id)return;const g=`${l.job_id}-${l.technician_id}`,E=a.get(g)||[];E.push(l.approved_by_manager||!1),a.set(g,E)});const x=new Map;return a.forEach((l,g)=>{x.set(g,l.every(E=>E===!0))}),x},staleTime:30*1e3}),{data:F=new Map}=I({queryKey:["job-tech-days-set",i],enabled:!!i,queryFn:async()=>{const{data:c,error:u}=await P.from("timesheets").select("technician_id, date").eq("job_id",i).eq("approved_by_manager",!0);if(u)throw u;const a=new Map;return c==null||c.forEach(x=>{!x.technician_id||!x.date||(a.has(x.technician_id)||a.set(x.technician_id,new Set),a.get(x.technician_id).add(x.date))}),a},staleTime:6e4}),V=Q.useCallback((c,u)=>k.get(`${c}-${u}`)??!1,[k]);if(s)return e.jsxs(q,{children:[e.jsx(me,{children:e.jsxs(ue,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5"}),"Tour Rates"]})}),e.jsx(ie,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-muted rounded w-3/4"}),e.jsx("div",{className:"h-4 bg-muted rounded w-1/2"})]})})]});if(m)return e.jsxs(ce,{variant:"destructive",children:[e.jsx(Ce,{className:"h-4 w-4"}),e.jsxs(de,{children:["Failed to load tour rates: ",m.message]})]});if(!(t!=null&&t.length))return e.jsxs(q,{children:[e.jsx(me,{children:e.jsxs(ue,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5"}),"Tour Rates"]})}),e.jsx(ie,{children:e.jsx("p",{className:"text-muted-foreground",children:"No tour rate assignments found for this job."})})]});const f=t.reduce((c,u)=>{const a=u.iso_year||new Date().getFullYear(),x=u.iso_week||1,l=`${a}-W${x.toString().padStart(2,"0")}`;return c[l]||(c[l]=[]),c[l].push(u),c},{}),_=c=>{const u=d.get(c);return u&&`${u.first_name??""} ${u.last_name??""}`.trim()||"Unknown"};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5"}),"Tour Rates (No Timesheets)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(O,{variant:"outline",className:"flex items-center gap-1",children:[e.jsx(he,{className:"h-3 w-3"}),t.length," assignments"]}),e.jsxs(z,{size:"sm",disabled:p||!t.length,onClick:async()=>{var c;try{const u=t.filter(x=>x.job_id&&x.technician_id&&V(x.job_id,x.technician_id));if(u.length===0){C.warning("No hay tarifas aprobadas para enviar");return}y(!0);const a=await $e({jobId:i,supabase:P,quotes:u,profiles:T});if(a.error)C.error("No se pudieron enviar los correos");else{const x=Array.isArray((c=a.response)==null?void 0:c.results)?a.response.results.some(l=>!l.sent):!1;a.success&&!x?C.success("Correos enviados"):C.warning("Algunos correos no se pudieron enviar")}a.missingEmails.length&&C.warning("Hay técnicos sin correo configurado")}catch{C.error("Se produjo un error al enviar")}finally{y(!1)}},title:"Enviar correos a los técnicos con tarifas aprobadas",children:[e.jsx(gs,{className:"h-3.5 w-3.5 mr-1"}),p?"Enviando…":"Enviar aprobados"]})]})]}),e.jsx(ce,{children:e.jsx(de,{children:"Tour dates use fixed rates without timesheet logging. Weekly multipliers apply only to technicians on the tour team for this routing (including house technicians when they are on the tour team)."})}),Object.entries(f).map(([c,u])=>e.jsxs(q,{children:[e.jsx(me,{children:e.jsxs(ue,{className:"flex items-center gap-2 text-base",children:[e.jsx(Ge,{className:"h-4 w-4"}),"Week ",c]})}),e.jsxs(ie,{children:[e.jsx("div",{className:"space-y-4",children:u.map(a=>{var o,M,K;const x=d.get(a.technician_id),l=xs(x==null?void 0:x.autonomo),g=os(a),E=((o=a.breakdown)==null?void 0:o.after_discount)??((M=a.breakdown)==null?void 0:M.base_calculation),$=a.base_day_eur??0,L=typeof g=="number"&&g>0,G=E??(L?$/g:$),X=ms(g),re=X.startsWith("×")?X.slice(1):X,n=a.job_id?V(a.job_id,a.technician_id):!1;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1 flex-wrap",children:[e.jsx("span",{className:"font-medium",children:_(a.technician_id)}),l&&e.jsxs(O,{variant:"destructive",className:"flex items-center gap-1 text-xs",children:[e.jsx(le,{className:"h-3 w-3"}),l]}),a.is_house_tech&&e.jsx(O,{variant:"secondary",className:"text-xs",children:"House Tech"}),a.category&&e.jsx(O,{variant:"outline",className:"text-xs",children:a.category.charAt(0).toUpperCase()+a.category.slice(1)})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[Y(new Date(a.start_time),"MMM d, yyyy")," • ",a.title]})]}),e.jsxs("div",{className:"text-right flex flex-col items-end gap-2",children:[a.job_id&&e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("label",{htmlFor:`switch-${a.job_id}-${a.technician_id}`,className:"text-xs text-muted-foreground cursor-pointer select-none",children:n?"Aprobado":"Pendiente"}),e.jsx(ts,{id:`switch-${a.job_id}-${a.technician_id}`,checked:n,onCheckedChange:A=>a.job_id&&N.mutate({jobId:a.job_id,technicianId:a.technician_id,approved:A}),disabled:N.isPending})]}),e.jsx("div",{className:"font-semibold text-lg",children:(()=>{var H;const A=ye(a),U=d.get(a.technician_id),b=a.start_time?a.start_time.split("T")[0]:null,S=b?(H=F.get(a.technician_id))==null?void 0:H.has(b):!1,R=(U==null?void 0:U.autonomo)===!1&&S?we:0;return W(A-R)})()}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[us(g)?e.jsxs(e.Fragment,{children:["Base ",W(G)," × ",re," ="," ",W($),a.week_count>1&&` (${a.week_count} fechas en la semana)`]}):e.jsxs(e.Fragment,{children:["Base ",W($)]}),a.extras_total_eur&&a.extras_total_eur>0&&e.jsxs("div",{className:"text-green-600 mt-1",children:["+",W(a.extras_total_eur)," extras"]}),(()=>{var S;const A=d.get(a.technician_id),U=a.start_time?a.start_time.split("T")[0]:null,b=U?(S=F.get(a.technician_id))==null?void 0:S.has(U):!1;return(A==null?void 0:A.autonomo)===!1&&b?e.jsx("div",{className:"text-red-400 mt-1 text-[11px]",children:"-30,00€ IRPF por alta obligatoria"}):null})()]}),e.jsx(z,{size:"sm",variant:"outline",disabled:!n||!!j[a.technician_id]||!(x!=null&&x.email),onClick:async()=>{var A;r(U=>({...U,[a.technician_id]:!0}));try{const U=t.filter(S=>S.technician_id===a.technician_id&&S.job_id&&V(S.job_id,S.technician_id));if(U.length===0){C.warning("No hay tarifas aprobadas para este técnico");return}const b=await $e({jobId:i,supabase:P,quotes:U,profiles:T,technicianIds:[a.technician_id]});if(b.error)C.error("No se pudo enviar el correo a este técnico");else{const S=Array.isArray((A=b.response)==null?void 0:A.results)?b.response.results.find(R=>R.technician_id===a.technician_id):{sent:b.success};S!=null&&S.sent?C.success("Correo enviado a este técnico"):C.warning("No se pudo enviar el correo a este técnico")}}catch{C.error("Se produjo un error al enviar")}finally{r(U=>({...U,[a.technician_id]:!1}))}},title:n?x!=null&&x.email?"Enviar a este técnico":"Sin correo configurado":"Aprueba las tarifas para habilitar el envío",children:j[a.technician_id]?"Enviando…":"Enviar"})]})]}),a.extras&&a.extras.items&&a.extras.items.length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("div",{className:"text-sm font-medium text-green-800 mb-2",children:"Job Extras:"}),e.jsxs("div",{className:"space-y-1",children:[a.extras.items.map((A,U)=>e.jsxs("div",{className:"flex justify-between text-sm text-green-700",children:[e.jsxs("span",{children:[A.extra_type.replace("_"," ")," × ",A.quantity]}),e.jsx("span",{children:W(A.amount_eur)})]},U)),e.jsxs("div",{className:"flex justify-between font-medium text-green-800 border-t border-green-300 pt-1 mt-2",children:[e.jsx("span",{children:"Extras Total:"}),e.jsx("span",{children:W(a.extras.total_eur)})]})]})]}),a.vehicle_disclaimer&&a.vehicle_disclaimer_text&&e.jsxs("div",{className:"flex items-start gap-2 text-sm text-amber-700 bg-amber-50 p-3 rounded-lg border border-amber-200 w-full",children:[e.jsx(le,{className:"h-4 w-4 mt-0.5 shrink-0"}),e.jsx("span",{className:"break-words whitespace-pre-wrap leading-snug w-full",children:a.vehicle_disclaimer_text.includes("Fuel/drive compensation")?"Puede aplicarse compensación de combustible/conducción al usar vehículo propio. Coordina con RR. HH. por cada trabajo.":a.vehicle_disclaimer_text})]}),((K=a.breakdown)==null?void 0:K.error)&&e.jsxs(ce,{variant:"destructive",children:[e.jsx(Ce,{className:"h-3 w-3"}),e.jsxs(de,{className:"text-xs",children:[a.breakdown.error==="category_missing"&&"Missing category - please set technician category",a.breakdown.error==="house_rate_missing"&&"Missing house tech rate - please configure in settings",a.breakdown.error==="tour_base_missing"&&"Missing tour base rate for category"]})]})]},`${a.job_id}-${a.technician_id}`)})}),e.jsxs("div",{className:"mt-6 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center font-semibold",children:[e.jsx("span",{children:"Week Total:"}),e.jsx("span",{className:"text-lg",children:W(u.reduce((a,x)=>{var G;const l=ye(x),g=d.get(x.technician_id),E=x.start_time?x.start_time.split("T")[0]:null,$=E?(G=F.get(x.technician_id))==null?void 0:G.has(E):!1,L=(g==null?void 0:g.autonomo)===!1&&$?we:0;return a+(l-L)},0))})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-2 space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Base rates:"}),e.jsx("span",{children:W(u.reduce((a,x)=>a+x.total_eur,0))})]}),u.some(a=>a.extras_total_eur&&a.extras_total_eur>0)&&e.jsxs("div",{className:"flex justify-between text-green-600",children:[e.jsx("span",{children:"Extras:"}),e.jsx("span",{children:W(u.reduce((a,x)=>a+(x.extras_total_eur||0),0))})]})]})]})]})]},c)),e.jsx(q,{children:e.jsxs(ie,{className:"pt-6",children:[e.jsxs("div",{className:"flex justify-between items-center font-bold text-lg",children:[e.jsx("span",{children:"Total Job Amount:"}),e.jsx("span",{className:"text-xl",children:W(t.reduce((c,u)=>{var $;const a=ye(u),x=d.get(u.technician_id),l=u.start_time?u.start_time.split("T")[0]:null,g=l?($=F.get(u.technician_id))==null?void 0:$.has(l):!1,E=(x==null?void 0:x.autonomo)===!1&&g?we:0;return c+(a-E)},0))})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-2 space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total base rates:"}),e.jsx("span",{children:W(t.reduce((c,u)=>c+u.total_eur,0))})]}),t.some(c=>c.extras_total_eur&&c.extras_total_eur>0)&&e.jsxs("div",{className:"flex justify-between text-green-600",children:[e.jsx("span",{children:"Total extras:"}),e.jsx("span",{children:W(t.reduce((c,u)=>c+(u.extras_total_eur||0),0))})]})]})]})})]})},Ls={draft:{label:"Borradores",tone:"text-foreground/70 dark:text-slate-300 border-border",description:"Visible para el técnico antes de enviar"},submitted:{label:"Pendientes",tone:"text-amber-700 dark:text-amber-300 border-amber-500",description:"Requieren revisión y aprobación"},approved:{label:"Aprobados",tone:"text-emerald-700 dark:text-emerald-300 border-emerald-500",description:"Incluidos en pagos y resúmenes"},rejected:{label:"Rechazados",tone:"text-rose-700 dark:text-rose-300 border-rose-500",description:"Devueltos al técnico con comentarios"}},Qe=["submitted","draft","approved","rejected"],$s=(i,t)=>{var v,T;const s=((v=i.technician)==null?void 0:v.first_name)??"",m=((T=i.technician)==null?void 0:T.last_name)??"";return`${s} ${m}`.trim()||t||i.technician_id},Rs=({jobId:i,jobTitle:t,technicians:s,canManage:m})=>{const N=Se(),v=Q.useMemo(()=>new Map(s.map(n=>[n.id,n.name])),[s]),{data:T=[],isLoading:d}=I({queryKey:["expense-categories"],queryFn:async()=>{const{data:n,error:o}=await P.from("expense_categories").select("slug,label_es,requires_receipt").eq("is_active",!0).order("label_es",{ascending:!0});if(o)throw o;return n||[]},staleTime:300*1e3}),{data:h=[],isLoading:p,refetch:y}=I({queryKey:["job-expenses",i],queryFn:async()=>{const{data:n,error:o}=await P.from("job_expenses").select(`
          id,
          job_id,
          technician_id,
          category_slug,
          permission_id,
          expense_date,
          amount_original,
          currency_code,
          fx_rate,
          amount_eur,
          description,
          receipt_path,
          status,
          status_history,
          submitted_at,
          approved_at,
          rejected_at,
          rejection_reason,
          technician:profiles!job_expenses_technician_id_fkey(id, first_name, last_name, email),
          submitted_by_profile:profiles!job_expenses_submitted_by_fkey(first_name, last_name),
          approved_by_profile:profiles!job_expenses_approved_by_fkey(first_name, last_name),
          rejected_by_profile:profiles!job_expenses_rejected_by_fkey(first_name, last_name),
          category:expense_categories(label_es)
        `).eq("job_id",i).order("expense_date",{ascending:!1}).order("created_at",{ascending:!1});if(o)throw o;return n||[]},enabled:!!i}),{data:j=[],isLoading:r,refetch:w}=I({queryKey:["expense-permissions",i],queryFn:async()=>{const{data:n,error:o}=await P.from("expense_permissions").select(`
          id,
          job_id,
          technician_id,
          category_slug,
          valid_from,
          valid_to,
          daily_cap_eur,
          total_cap_eur,
          notes,
          technician:profiles!expense_permissions_technician_id_fkey(first_name,last_name),
          category:expense_categories(label_es,requires_receipt)
        `).eq("job_id",i).order("technician_id",{ascending:!0}).order("category_slug",{ascending:!0});if(o)throw o;return n||[]},enabled:!!i}),[k,F]=Q.useState({technicianId:"",categorySlug:"",validFrom:"",validTo:"",dailyCap:"",totalCap:"",notes:"",editingId:""}),[V,f]=Q.useState(null),[_,c]=Q.useState(null),u=Q.useCallback((n,o)=>{const M=v.get(n);return o?$s(o,M):M||n},[v]),a=Q.useMemo(()=>{const n=Qe.reduce((o,M)=>(o[M]=new Map,o),{draft:new Map,submitted:new Map,approved:new Map,rejected:new Map});return h.forEach(o=>{const M=o.status??"draft",K=n[M],A=K.get(o.technician_id)??[];A.push(o),K.set(o.technician_id,A)}),n},[h]),x=Q.useMemo(()=>h.reduce((n,o)=>(n.count+=1,n.amount+=o.amount_eur,o.status==="submitted"&&(n.pendingCount+=1,n.pendingAmount+=o.amount_eur),o.status==="approved"&&(n.approvedAmount+=o.amount_eur),n),{count:0,amount:0,pendingCount:0,pendingAmount:0,approvedAmount:0}),[h]),l=Q.useCallback(()=>{F({technicianId:"",categorySlug:"",validFrom:"",validTo:"",dailyCap:"",totalCap:"",notes:"",editingId:""})},[]),g=Q.useCallback(async()=>{await Promise.all([N.invalidateQueries({queryKey:["job-expenses",i]}),N.invalidateQueries({queryKey:["job-tech-payout",i]}),N.invalidateQueries({queryKey:["job-totals",i]}),N.invalidateQueries({queryKey:["dashboard-expenses-summary"]}),N.invalidateQueries({queryKey:["expenses-page"]})])},[i,N]),E=Q.useCallback(async n=>{try{const{error:o}=await P.rpc("approve_job_expense",{p_expense_id:n,p_approved:!0,p_rejection_reason:null});if(o)throw o;C.success("Gasto aprobado"),await g()}catch{C.error("No se pudo aprobar el gasto")}},[g]),$=Q.useCallback(async(n,o)=>{try{const{error:M}=await P.rpc("approve_job_expense",{p_expense_id:n,p_approved:!1,p_rejection_reason:o??null});if(M)throw M;C.success("Gasto rechazado"),await g()}catch{C.error("No se pudo rechazar el gasto")}},[g]),L=Q.useCallback(async n=>{if(!n.receipt_path){C.warning("Este gasto no tiene recibo adjunto");return}c({expenseId:n.id,loading:!0});try{const{data:o,error:M}=await P.storage.from("expense-receipts").createSignedUrl(n.receipt_path,3600);if(M||!(o!=null&&o.signedUrl))throw M||new Error("No se pudo generar el enlace");window.open(o.signedUrl,"_blank","noopener")}catch{C.error("No se pudo abrir el recibo")}finally{c(null)}},[]),G=Q.useCallback(n=>{F({technicianId:n.technician_id,categorySlug:n.category_slug,validFrom:n.valid_from??"",validTo:n.valid_to??"",dailyCap:n.daily_cap_eur!=null?String(n.daily_cap_eur):"",totalCap:n.total_cap_eur!=null?String(n.total_cap_eur):"",notes:n.notes??"",editingId:n.id})},[]),X=Q.useCallback(async n=>{if(n.preventDefault(),!k.technicianId||!k.categorySlug){C.error("Selecciona un técnico y una categoría");return}try{const{error:o}=await P.rpc("set_expense_permission",{p_job_id:i,p_technician_id:k.technicianId,p_category_slug:k.categorySlug,p_valid_from:k.validFrom||null,p_valid_to:k.validTo||null,p_daily_cap_eur:k.dailyCap.trim()!==""?Number(k.dailyCap):null,p_total_cap_eur:k.totalCap.trim()!==""?Number(k.totalCap):null,p_notes:k.notes||null});if(o)throw o;C.success("Permiso guardado"),l(),w(),await g()}catch{C.error("No se pudo guardar el permiso")}},[i,k,l,w,g]),re=d||p||r;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(q,{className:"bg-card border-border text-card-foreground",children:[e.jsx(me,{children:e.jsxs(ue,{className:"text-lg flex items-center gap-2",children:[e.jsx(ze,{className:"h-5 w-5 text-blue-600 dark:text-blue-300"}),"Gestión de gastos ",t?`— ${t}`:""]})}),e.jsx(ie,{className:"space-y-3 text-sm text-foreground/80 dark:text-slate-200",children:re?e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(xe,{className:"h-4 w-4 animate-spin"}),"Cargando datos de gastos…"]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs(O,{variant:"outline",className:"border-border",children:["Total: ",x.count," registros · ",W(x.amount)]}),e.jsxs(O,{variant:"outline",className:"border-amber-500/40 text-amber-700 dark:text-amber-200",children:["Pendientes: ",x.pendingCount," · ",W(x.pendingAmount)]}),e.jsxs(O,{variant:"outline",className:"border-emerald-500/40 text-emerald-700 dark:text-emerald-200",children:["Aprobados: ",W(x.approvedAmount)]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Los importes aprobados se incluyen automáticamente en las nóminas, emails y PDFs de pago."})]})})]}),m&&e.jsxs(q,{className:"bg-card border-border text-card-foreground",children:[e.jsx(me,{children:e.jsxs(ue,{className:"text-lg flex items-center gap-2",children:[e.jsx(hs,{className:"h-5 w-5 text-emerald-600 dark:text-emerald-300"}),"Permisos por categoría"]})}),e.jsxs(ie,{className:"space-y-5",children:[e.jsxs("form",{onSubmit:X,className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{htmlFor:"expense-tech",children:"Técnico"}),e.jsxs(Te,{value:k.technicianId,onValueChange:n=>F(o=>({...o,technicianId:n})),children:[e.jsx(Ee,{id:"expense-tech",className:"bg-background border-input",children:e.jsx(Pe,{placeholder:"Selecciona un técnico"})}),e.jsx(Me,{children:s.map(n=>e.jsx(Ae,{value:n.id,children:n.name},n.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{htmlFor:"expense-category",children:"Categoría"}),e.jsxs(Te,{value:k.categorySlug,onValueChange:n=>F(o=>({...o,categorySlug:n})),disabled:d,children:[e.jsx(Ee,{id:"expense-category",className:"bg-background border-input",children:e.jsx(Pe,{placeholder:"Selecciona una categoría"})}),e.jsx(Me,{children:T.map(n=>e.jsxs(Ae,{value:n.slug,children:[n.label_es," ",n.requires_receipt?"· requiere recibo":""]},n.slug))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{htmlFor:"expense-valid-from",children:"Válido desde"}),e.jsx(pe,{id:"expense-valid-from",type:"date",value:k.validFrom,onChange:n=>F(o=>({...o,validFrom:n.target.value})),className:"bg-background border-input"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{htmlFor:"expense-valid-to",children:"Válido hasta"}),e.jsx(pe,{id:"expense-valid-to",type:"date",value:k.validTo,onChange:n=>F(o=>({...o,validTo:n.target.value})),className:"bg-background border-input"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{htmlFor:"expense-daily-cap",children:"Tope diario (€)"}),e.jsx(pe,{id:"expense-daily-cap",type:"number",min:"0",step:"0.01",value:k.dailyCap,onChange:n=>F(o=>({...o,dailyCap:n.target.value})),className:"bg-background border-input"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{htmlFor:"expense-total-cap",children:"Tope total (€)"}),e.jsx(pe,{id:"expense-total-cap",type:"number",min:"0",step:"0.01",value:k.totalCap,onChange:n=>F(o=>({...o,totalCap:n.target.value})),className:"bg-background border-input"})]}),e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(ne,{htmlFor:"expense-notes",children:"Notas internas"}),e.jsx(Fe,{id:"expense-notes",rows:2,value:k.notes,onChange:n=>F(o=>({...o,notes:n.target.value})),className:"bg-background border-input",placeholder:"Indicaciones para aprobación, justificantes requeridos, etc."})]}),e.jsxs("div",{className:"md:col-span-2 flex flex-wrap gap-2 justify-end",children:[k.editingId&&e.jsx(z,{type:"button",variant:"ghost",onClick:l,className:"text-muted-foreground hover:text-foreground",children:"Cancelar edición"}),e.jsxs(z,{type:"submit",className:"bg-blue-600 hover:bg-blue-500",children:[e.jsx(As,{className:"h-4 w-4 mr-1"}),"Guardar permiso"]})]})]}),e.jsx(He,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Permisos actuales"}),j.length===0?e.jsx("p",{className:"text-xs text-muted-foreground",children:"Todavía no hay permisos configurados para este trabajo."}):e.jsx("div",{className:"space-y-2",children:j.map(n=>{var o;return e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-2 p-3 rounded-lg border border-border bg-muted/30",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"font-medium",children:[u(n.technician_id)," ·"," ",((o=n.category)==null?void 0:o.label_es)||n.category_slug]}),e.jsxs("div",{className:"text-xs text-muted-foreground space-x-2",children:[n.valid_from&&e.jsxs("span",{children:["Desde ",Y(new Date(n.valid_from),"PPP",{locale:te})]}),n.valid_to&&e.jsxs("span",{children:["Hasta ",Y(new Date(n.valid_to),"PPP",{locale:te})]}),(n.daily_cap_eur!=null||n.total_cap_eur!=null)&&e.jsxs("span",{children:["Topes · Diario: ",n.daily_cap_eur!=null?W(n.daily_cap_eur):"—"," · Total: ",n.total_cap_eur!=null?W(n.total_cap_eur):"—"]})]}),n.notes&&e.jsx("div",{className:"text-xs text-foreground/70 dark:text-slate-300 mt-1",children:n.notes})]}),e.jsx(z,{variant:"outline",size:"sm",className:"self-start md:self-center",onClick:()=>G(n),children:"Editar"})]},n.id)})})]})]})]}),e.jsxs(q,{className:"bg-card border-border text-card-foreground",children:[e.jsx(me,{children:e.jsxs(ue,{className:"text-lg flex items-center gap-2",children:[e.jsx(vs,{className:"h-5 w-5 text-amber-600 dark:text-amber-200"}),"Registro de gastos"]})}),e.jsx(ie,{className:"space-y-5",children:Qe.map(n=>{const o=a[n],M=Ls[n],K=Array.from(o.values()).flat();return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:`font-semibold text-base ${M.tone}`,children:M.label}),e.jsx("p",{className:"text-xs text-muted-foreground",children:M.description})]}),e.jsxs(O,{variant:"outline",className:"border-border text-xs",children:[K.length," gasto",K.length===1?"":"s"]})]}),K.length===0?e.jsx("div",{className:"text-xs text-muted-foreground border border-dashed border-border rounded p-3",children:"No hay gastos en este estado."}):e.jsx("div",{className:"space-y-3",children:Array.from(o.entries()).map(([A,U])=>e.jsxs("div",{className:"border border-border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"px-3 py-2 bg-muted/50 flex items-center justify-between",children:[e.jsx("div",{className:"font-medium text-sm",children:u(A,U[0])}),e.jsxs("div",{className:"text-xs text-foreground/70 dark:text-slate-300",children:["Total: ",W(U.reduce((b,S)=>b+S.amount_eur,0))]})]}),e.jsx("div",{className:"divide-y divide-border",children:U.map(b=>{var S,R;return e.jsxs("div",{className:"px-3 py-3 text-sm space-y-2",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:((S=b.category)==null?void 0:S.label_es)||b.category_slug}),e.jsx("span",{className:"text-xs text-muted-foreground",children:Y(new Date(b.expense_date),"PPP",{locale:te})})]}),e.jsx(O,{variant:"outline",className:"border-border",children:W(b.amount_eur)})]}),b.description&&e.jsx("div",{className:"text-xs text-foreground/70 dark:text-slate-300 bg-muted/30 rounded p-2",children:b.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["Original: ",b.amount_original.toFixed(2)," ",b.currency_code]}),e.jsxs("span",{children:["· FX: ",b.fx_rate.toFixed(4)]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[b.receipt_path?e.jsxs(z,{variant:"ghost",size:"sm",className:"text-blue-200 hover:text-blue-100",onClick:()=>L(b),disabled:(_==null?void 0:_.expenseId)===b.id&&_.loading,children:[(_==null?void 0:_.expenseId)===b.id&&_.loading?e.jsx(xe,{className:"h-4 w-4 animate-spin"}):e.jsx(ze,{className:"h-4 w-4 mr-1"}),"Ver recibo"]}):e.jsx(O,{variant:"outline",className:"border-amber-500/40 text-amber-700 dark:text-amber-300 bg-amber-500/5",children:"Sin recibo"}),b.status==="submitted"&&m&&e.jsxs(e.Fragment,{children:[e.jsxs(z,{size:"sm",className:"bg-emerald-600 hover:bg-emerald-500",onClick:()=>E(b.id),children:[e.jsx(ys,{className:"h-4 w-4 mr-1"})," Aprobar"]}),e.jsxs(z,{size:"sm",variant:"destructive",onClick:()=>f({expenseId:b.id,technicianName:u(b.technician_id,b),reason:b.rejection_reason??""}),children:[e.jsx(Ns,{className:"h-4 w-4 mr-1"})," Rechazar"]})]})]}),e.jsx("div",{className:"flex flex-wrap gap-2 text-xs text-muted-foreground",children:(R=b.status_history)==null?void 0:R.map((H,J)=>e.jsxs("span",{className:"px-2 py-1 bg-muted rounded",children:[H.status,": ",H.changed_at?Y(new Date(H.changed_at),"dd/MM HH:mm"):"—"]},`${b.id}-hist-${J}`))})]},b.id)})})]},`${n}-${A}`))})]},n)})})]}),e.jsx(be,{open:!!V,onOpenChange:n=>!n&&f(null),children:e.jsxs(ke,{className:"max-w-md",children:[e.jsx(We,{children:e.jsx(qe,{children:"Rechazar gasto"})}),e.jsx("div",{className:"space-y-3 text-sm",children:V&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["¿Quieres rechazar el gasto de ",e.jsx("strong",{children:V.technicianName}),"? Añade el motivo para que quede registrado."]}),e.jsx(Fe,{value:V.reason,onChange:n=>f(o=>o&&{...o,reason:n.target.value}),placeholder:"Motivo del rechazo",className:"bg-background border-input",rows:3})]})}),e.jsxs(Ye,{className:"flex gap-2",children:[e.jsx(z,{variant:"ghost",onClick:()=>f(null),children:"Cancelar"}),e.jsx(z,{variant:"destructive",onClick:()=>{V&&($(V.expenseId,V.reason),f(null))},children:"Rechazar"})]})]})})]})},zs=({open:i,jobId:t,resolvedDocuments:s,documentsLoading:m,jobDocumentsError:N})=>{const{data:v=[],isLoading:T,error:d}=I({queryKey:["job-artists",t],enabled:i&&!!t,queryFn:async()=>{const{data:f,error:_}=await P.from("festival_artists").select("id, name").eq("job_id",t);if(_)throw _;return f||[]}}),h=B.useMemo(()=>v.map(_=>_.id),[v]),p=B.useMemo(()=>new Map(v.map(f=>[f.id,f.name])),[v]),{data:y=[],isLoading:j,error:r}=I({queryKey:["job-rider-files",t,h],enabled:i&&!!t&&h.length>0,queryFn:async()=>{let f=P.from("festival_artist_files").select("id, file_name, file_path, uploaded_at, artist_id").order("uploaded_at",{ascending:!1});if(h.length===1)f=f.eq("artist_id",h[0]);else{const u=h.map(a=>`artist_id.eq.${a}`).join(",");f=f.or(u)}const{data:_,error:c}=await f;if(c)throw c;return _||[]}}),w=async f=>{try{const{data:_,error:c}=await P.storage.from("festival_artist_files").createSignedUrl(f.file_path,3600);if(c)throw c;if(_!=null&&_.signedUrl)window.open(_.signedUrl,"_blank","noopener");else throw new Error("No se pudo generar el enlace de visualización")}catch(_){C.error(`Error al visualizar el rider: ${_.message||"Error desconocido"}`)}},k=async f=>{try{const{data:_,error:c}=await P.storage.from("festival_artist_files").download(f.file_path);if(c)throw c;const u=window.URL.createObjectURL(_),a=document.createElement("a");a.href=u,a.download=f.file_name,document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(u),C.success("Descargando rider")}catch(_){C.error(`Error al descargar el rider: ${_.message||"Error desconocido"}`)}},F=async f=>{try{const{bucket:_,path:c}=Le(f.file_path),{data:u,error:a}=await P.storage.from(_).createSignedUrl(c,3600);if(a)throw a;if(u!=null&&u.signedUrl){const x=document.createElement("a");x.href=u.signedUrl,x.download=f.file_name,document.body.appendChild(x),x.click(),document.body.removeChild(x),C.success("Descargando documento")}else throw new Error("No se pudo generar el enlace de descarga")}catch(_){C.error(`Error al descargar el documento: ${_.message||"Error desconocido"}`)}},V=async f=>{try{const{bucket:_,path:c}=Le(f.file_path),{data:u,error:a}=await P.storage.from(_).createSignedUrl(c,3600);if(a)throw a;if(u!=null&&u.signedUrl)window.open(u.signedUrl,"_blank","noopener");else throw new Error("No se pudo generar el enlace de visualización")}catch(_){C.error(`Error al visualizar el documento: ${_.message||"Error desconocido"}`)}};return e.jsxs(ae,{value:"documents",className:"space-y-4 min-w-0 overflow-x-hidden",children:[e.jsxs(q,{className:"p-4 w-full min-w-0 overflow-hidden",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(je,{className:"h-4 w-4"}),"Documentos del trabajo"]}),N&&e.jsx(ce,{variant:"destructive",className:"mb-4",children:e.jsxs(de,{children:["No se pudieron cargar todos los documentos. ",N.message]})}),m?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):s.length>0?e.jsx("div",{className:"space-y-2",children:s.map(f=>{const _=f.template_type==="soundvision",c=!!f.read_only;return e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-3 bg-[#0f1219] border border-[#1f232e] rounded min-w-0",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("p",{className:"font-medium flex items-center gap-2 break-words",children:[f.file_name,_&&e.jsx(O,{variant:"outline",className:"text-[10px] uppercase tracking-wide",children:"Plantilla SoundVision"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground break-words",children:[f.uploaded_at?`Subido el ${Y(new Date(f.uploaded_at),"PPP",{locale:te})}`:"Fecha de subida desconocida",c&&e.jsx("span",{className:"ml-2 italic",children:"Solo lectura"})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto sm:shrink-0",children:[e.jsxs(z,{onClick:()=>V(f),size:"sm",variant:"outline",className:"w-full sm:w-auto",children:[e.jsx(Ue,{className:"h-4 w-4 mr-2"}),"Ver"]}),e.jsxs(z,{onClick:()=>F(f),size:"sm",variant:"outline",className:"w-full sm:w-auto",children:[e.jsx(Ke,{className:"h-4 w-4 mr-2"}),"Descargar"]})]})]},f.id)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(je,{className:"h-8 w-8 mx-auto mb-2 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"No se han subido documentos"})]})]}),e.jsxs(q,{className:"p-4",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4"}),"Riders de artistas",v.length>0&&e.jsxs(O,{variant:"secondary",className:"ml-2",children:[v.length," ",v.length===1?"artista":"artistas"]})]}),d&&e.jsxs(ce,{variant:"destructive",className:"mb-4",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsxs(de,{children:["Error al cargar artistas: ",d.message]})]}),r&&e.jsxs(ce,{variant:"destructive",className:"mb-4",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsxs(de,{children:["Error al cargar riders: ",r.message]})]}),T||j?e.jsxs("div",{className:"text-center py-4 text-muted-foreground",children:[e.jsx(xe,{className:"h-6 w-6 animate-spin mx-auto mb-2"}),"Cargando riders…"]}):v.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(he,{className:"h-8 w-8 mx-auto mb-2 text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"No hay artistas asociados a este trabajo"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Los riders aparecerán aquí cuando se agreguen artistas al trabajo"})]}):y.length>0?e.jsx("div",{className:"space-y-2",children:y.map(f=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-3 bg-muted rounded min-w-0",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"font-medium break-words",children:f.file_name}),e.jsxs("p",{className:"text-sm text-muted-foreground break-words",children:["Artista: ",p.get(f.artist_id)||"Desconocido"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto sm:shrink-0",children:[e.jsxs(z,{size:"sm",variant:"outline",onClick:()=>w({file_path:f.file_path,file_name:f.file_name}),className:"w-full sm:w-auto",children:[e.jsx(Ue,{className:"h-4 w-4 mr-1"})," Ver"]}),e.jsxs(z,{size:"sm",variant:"outline",onClick:()=>k({file_path:f.file_path,file_name:f.file_name}),className:"w-full sm:w-auto",children:[e.jsx(Ke,{className:"h-4 w-4 mr-1"})," Descargar"]})]})]},f.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(je,{className:"h-8 w-8 mx-auto mb-2 text-muted-foreground"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["No se han subido riders para los ",v.length," ",v.length===1?"artista":"artistas"," de este trabajo"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:v.map(f=>f.name).join(", ")})]})]})]})};function Us(i){return I({queryKey:["job-approval-status",i],enabled:!!i,queryFn:async()=>{if(!i)return{jobId:"",totalTimesheets:0,approvedTimesheets:0,rejectedTimesheets:0,pendingExtras:0,rejectedExtras:0,blockingReasons:[],canApprove:!1};const[{data:t,error:s},{data:m,error:N}]=await Promise.all([P.from("timesheets").select("status").eq("job_id",i).eq("is_active",!0),P.from("job_rate_extras").select("status").eq("job_id",i)]);if(s)throw s;if(N)throw N;const v=(t==null?void 0:t.length)??0,T=(t==null?void 0:t.filter(w=>String(w.status??"").toLowerCase()==="approved").length)??0,d=(t==null?void 0:t.filter(w=>String(w.status??"").toLowerCase()==="rejected").length)??0,h=(m==null?void 0:m.filter(w=>String(w.status??"").toLowerCase()==="pending").length)??0,p=(m==null?void 0:m.filter(w=>String(w.status??"").toLowerCase()==="rejected").length)??0,y=[];v===0?y.push("No timesheets"):d>0?y.push("Timesheets rejected"):T<v&&y.push("Timesheets pending"),h>0&&y.push("Extras pending"),p>0&&y.push("Extras rejected");const j=Array.from(new Set(y)),r=j.length===0&&v>0;return{jobId:i,totalTimesheets:v,approvedTimesheets:T,rejectedTimesheets:d,pendingExtras:h,rejectedExtras:p,blockingReasons:j,canApprove:r}}})}const Ie=async(i,t)=>{const s=new Map,m=Array.from(new Set((t||[]).map(d=>d.technician_id).filter(d=>typeof d=="string"&&d.length>0)));if(!m.length)return{timesheets:t,profileMap:s};const{data:N,error:v}=await i.from("profiles").select("id, first_name, last_name, department, autonomo").in("id",m);return v?{timesheets:t,profileMap:s}:((N||[]).forEach(d=>{d!=null&&d.id&&s.set(d.id,d)}),{timesheets:t.map(d=>{const h=s.get(d.technician_id);if(!h)return d;const p=d.technician?{...h,...d.technician}:h;return{...d,technician:p}}),profileMap:s})},Ks=({open:i,job:t,jobDetails:s,resolvedJobId:m,isManager:N,isTechnicianRole:v,isDryhire:T,jobRatesApproved:d})=>{const h=Se(),p=!T&&(s==null?void 0:s.job_type)==="tourdate"&&!N&&v&&!d,{data:y,isLoading:j}=Us(m),[r,w]=B.useState(!1),k=Q.useCallback(async l=>{var g;if(!(!l||r)){w(!0);try{const E=await ds({jobId:l,supabase:P});if(E.error)C.error("No se pudieron enviar los correos de pagos");else{const $=Array.isArray((g=E.response)==null?void 0:g.results)?E.response.results.some(L=>!L.sent):!1;E.success&&!$?C.success("Pagos enviados por correo"):C.warning("Algunos correos no se pudieron enviar. Revisa el registro."),E.missingEmails.length&&C.warning("Hay técnicos sin correo configurado.")}}catch{C.error("Se produjo un error al enviar los correos de pagos")}finally{w(!1)}}},[r]),F=l=>{if(!l)return"Sin definir";try{const g=new Date(l);return isNaN(g.getTime())?"Fecha no válida":Y(g,"PPPp",{locale:te})}catch{return"Fecha no válida"}},[V,f]=B.useState(!1),{data:_}=I({queryKey:["flex-workorders-folder",m,s==null?void 0:s.job_type,s==null?void 0:s.tour_date_id],enabled:i&&N&&!!m,queryFn:async()=>{const l={folder_type:"work_orders",department:"personnel"};((s==null?void 0:s.job_type)||(t==null?void 0:t.job_type))==="tourdate"?l.tour_date_id=(s==null?void 0:s.tour_date_id)||(t==null?void 0:t.tour_date_id):l.job_id=m;const{data:g,error:E}=await P.from("flex_folders").select("element_id").match(l).maybeSingle();return E?null:g||null}}),{data:c=[]}=I({queryKey:["flex-workorders-rows",m],enabled:i&&N&&!!m,queryFn:async()=>{const{data:l,error:g}=await P.from("flex_work_orders").select(`
          technician_id,
          flex_element_id,
          flex_document_id,
          folder_element_id,
          flex_vendor_id,
          lpo_number,
          profiles:profiles!flex_work_orders_technician_id_fkey(first_name,last_name)
        `).eq("job_id",m);return g?[]:l||[]}}),u=B.useMemo(()=>((s==null?void 0:s.job_assignments)||[]).filter(g=>g&&g.status!=="declined").length,[s==null?void 0:s.job_assignments]),a=c.length,x=async l=>{try{if(!l)return;await navigator.clipboard.writeText(l),C.success("Copiado al portapapeles")}catch{C.error("No se pudo copiar")}};return e.jsxs(ae,{value:"info",className:"space-y-4 min-w-0 overflow-x-hidden",children:[e.jsx(q,{className:"p-4 w-full min-w-0 overflow-hidden",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:s==null?void 0:s.title}),(s==null?void 0:s.description)&&e.jsx("p",{className:"text-muted-foreground mt-1",children:s.description})]}),e.jsx(He,{}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Hora de inicio"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:F(s==null?void 0:s.start_time)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Hora de finalización"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:F(s==null?void 0:s.end_time)})]})]}),e.jsxs("div",{className:"flex items-center gap-4 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Tipo de trabajo"}),e.jsx(O,{variant:"outline",children:s==null?void 0:s.job_type})]}),(s==null?void 0:s.invoicing_company)&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Empresa facturadora"}),e.jsx(O,{variant:"secondary",children:s.invoicing_company})]})]}),N&&!T&&e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-md bg-muted/30",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{variant:d?"default":"secondary",children:d?"Tarifas aprobadas":"Aprobación necesaria"}),e.jsx("span",{className:"text-xs text-muted-foreground dark:text-muted-foreground",children:"Controla la visibilidad de los pagos por trabajo para los técnicos"})]}),e.jsx("div",{children:d?e.jsx(z,{size:"sm",variant:"outline",onClick:async()=>{m&&(await P.from("jobs").update({rates_approved:!1,rates_approved_at:null,rates_approved_by:null}).eq("id",m),h.invalidateQueries({queryKey:["job-details",m]}),h.invalidateQueries({queryKey:["job-rates-approval",m]}),h.invalidateQueries({queryKey:["job-rates-approval-map"]}),h.invalidateQueries({queryKey:["job-approval-status",m]}))},children:"Revocar"}):e.jsx(z,{size:"sm",disabled:!j&&!!y&&!y.canApprove,onClick:async()=>{var g;if(!m)return;if(y&&!y.canApprove){const E=y.blockingReasons.join(", ");C.error(E?`No se puede aprobar: ${E}`:"No se puede aprobar mientras haya elementos pendientes");return}let l=!1;try{const{data:E}=await P.auth.getUser(),{error:$}=await P.from("jobs").update({rates_approved:!0,rates_approved_at:new Date().toISOString(),rates_approved_by:((g=E==null?void 0:E.user)==null?void 0:g.id)||null}).eq("id",m);if($)throw $;l=!0;try{const L=await Re(m);L.created>0&&C.success(`Órdenes de trabajo creadas en Flex: ${L.created}`),L.errors.forEach(G=>C.error(G))}catch(L){C.error(`No se pudieron generar las órdenes de trabajo en Flex: ${L.message}`)}}catch{C.error("No se pudieron aprobar las tarifas del trabajo.")}finally{h.invalidateQueries({queryKey:["job-details",m]}),h.invalidateQueries({queryKey:["job-rates-approval",m]}),h.invalidateQueries({queryKey:["job-rates-approval-map"]}),h.invalidateQueries({queryKey:["job-approval-status",m]}),l&&C.success("Tarifas aprobadas",{description:"¿Quieres enviar los resúmenes de pagos por correo ahora?",action:m?{label:"Enviar ahora",onClick:()=>{r||k(m)}}:void 0})}},children:"Aprobar"})})]}),p&&e.jsxs(ce,{variant:"default",className:"border-amber-200 bg-amber-50 text-amber-900 dark:border-amber-500/40 dark:bg-amber-500/10 dark:text-amber-50",children:[e.jsx(Ce,{className:"h-4 w-4"}),e.jsx(de,{className:"text-sm text-amber-800 dark:text-amber-100",children:"Las tarifas de este trabajo están pendientes de aprobación y no son visibles por el momento."})]}),y&&y.blockingReasons.length>0&&e.jsxs("div",{className:"mt-2 text-xs text-foreground/70 dark:text-muted-foreground",children:["Pendiente: ",y.blockingReasons.join(", ")]}),(s==null?void 0:s.locations)&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Recinto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.locations.name}),s.locations.formatted_address&&e.jsx("p",{className:"text-sm text-muted-foreground",children:s.locations.formatted_address})]})]})}),N&&m&&e.jsx(ls,{jobId:m}),N&&!T&&e.jsx(q,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:"Órdenes de Trabajo (Flex)"}),e.jsxs("div",{className:"text-muted-foreground",children:["Progreso: ",a,"/",u," ",u>0?"técnicos":""]}),e.jsxs("div",{className:"text-muted-foreground",children:["Carpeta: ",_!=null&&_.element_id?"creada":"no creada"]})]}),e.jsx(z,{size:"sm",onClick:async()=>{if(m){f(!0);try{const l=await Re(m);l.created>0?C.success(`Órdenes de trabajo creadas en Flex: ${l.created}`):l.skipped>0&&C(`Sin cambios. Técnicos omitidos: ${l.skipped}`),l.errors.forEach(g=>C.error(g))}catch(l){C.error(`No se pudo sincronizar con Flex: ${l.message}`)}finally{f(!1),h.invalidateQueries({queryKey:["flex-workorders-folder",m]}),h.invalidateQueries({queryKey:["flex-workorders-rows",m]})}}},disabled:V,children:V?"Sincronizando…":"Sincronizar órdenes de trabajo"})]})}),N&&!T&&e.jsx(q,{className:"p-3 mt-2",children:e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"font-medium",children:"Impresión rápida"}),e.jsx(z,{size:"sm",variant:"default",onClick:async()=>{if(m)try{const{data:l}=await P.from("timesheets").select("*").eq("job_id",m).eq("is_active",!0).eq("approved_by_manager",!0);let g=l||[];if(!g.length){const{data:S}=await P.rpc("get_timesheet_amounts_visible");g=(S==null?void 0:S.filter(R=>R.job_id===m))||[]}const{timesheets:E,profileMap:$}=await Ie(P,g);g=E;const L={id:m,title:(s==null?void 0:s.title)||(t==null?void 0:t.title)||"Job",start_time:(s==null?void 0:s.start_time)||(t==null?void 0:t.start_time),end_time:(s==null?void 0:s.end_time)||(t==null?void 0:t.end_time),job_type:(s==null?void 0:s.job_type)||(t==null?void 0:t.job_type),created_at:(s==null?void 0:s.created_at)||new Date().toISOString()},X=(await ws({job:L,timesheets:g,date:"all-dates"})).output("blob"),{data:re}=await P.from("flex_work_orders").select("technician_id, lpo_number").eq("job_id",m),n=new Map((re||[]).map(S=>[S.technician_id,S.lpo_number||null])),o=new Map;(g||[]).forEach(S=>{const R=S.amount_breakdown||S.amount_breakdown_visible||{},H={date:S.date,hours_rounded:Number(R.hours_rounded??R.worked_hours_rounded??0)||0,base_day_eur:R.base_day_eur!=null?Number(R.base_day_eur):void 0,plus_10_12_hours:R.plus_10_12_hours!=null?Number(R.plus_10_12_hours):void 0,plus_10_12_amount_eur:R.plus_10_12_amount_eur!=null?Number(R.plus_10_12_amount_eur):void 0,overtime_hours:R.overtime_hours!=null?Number(R.overtime_hours):void 0,overtime_hour_eur:R.overtime_hour_eur!=null?Number(R.overtime_hour_eur):void 0,overtime_amount_eur:R.overtime_amount_eur!=null?Number(R.overtime_amount_eur):void 0,total_eur:R.total_eur!=null?Number(R.total_eur):void 0},J=o.get(S.technician_id)||[];J.push(H),o.set(S.technician_id,J)});let M;if(((s==null?void 0:s.job_type)||(t==null?void 0:t.job_type))==="tourdate"){const{data:S,error:R}=await P.from("job_assignments").select("technician_id").eq("job_id",m),H=Array.from(new Set((S||[]).map(D=>D.technician_id).filter(Boolean)));let J=[];H.length>0&&(J=await Promise.all(H.map(async D=>{const{data:ge,error:ee}=await P.rpc("compute_tour_job_rate_quote_2025",{_job_id:m,_tech_id:D});return ee?{job_id:m,technician_id:D,start_time:L.start_time,end_time:L.end_time,job_type:"tourdate",tour_id:(s==null?void 0:s.tour_id)??null,title:L.title,is_house_tech:!1,is_tour_team_member:!1,category:"",base_day_eur:0,week_count:1,multiplier:1,per_job_multiplier:1,iso_year:null,iso_week:null,total_eur:0,extras:void 0,extras_total_eur:void 0,total_with_extras_eur:void 0,breakdown:{error:ee.message||String(ee)}}:ge})));const Z=H.filter(D=>typeof D=="string"&&!$.has(D));if(Z.length){const{data:D,error:ge}=await P.from("profiles").select("id, first_name, last_name, department, autonomo").in("id",Z);ge||(D||[]).forEach(ee=>{ee!=null&&ee.id&&$.set(ee.id,ee)})}const fe=Array.from($.values());M=await ps(J,{id:L.id,title:L.title,start_time:L.start_time,tour_id:(s==null?void 0:s.tour_id)??null,job_type:L.job_type},fe,n,{download:!1})}else{const{data:S}=await P.from("v_job_tech_payout_2025").select("*").eq("job_id",m),H=Array.from(new Set((S||[]).map(Z=>Z.technician_id))).filter(Z=>typeof Z=="string"&&!$.has(Z));if(H.length){const{data:Z,error:fe}=await P.from("profiles").select("id, first_name, last_name, department, autonomo").in("id",H);fe||(Z||[]).forEach(oe=>{oe!=null&&oe.id&&$.set(oe.id,oe)})}const J=Array.from($.values());M=await fs(S||[],{id:L.id,title:L.title,start_time:L.start_time,end_time:L.end_time,tour_id:(s==null?void 0:s.tour_id)??null},J,n,o,{download:!1})}const A=await js([X,M]),U=URL.createObjectURL(A),b=document.createElement("a");b.href=U,b.download=`pack_${(L.title||"job").replace(/[^\w\s-]/g,"").replace(/\s+/g,"_")}.pdf`,document.body.appendChild(b),b.click(),b.remove(),URL.revokeObjectURL(U)}catch{C.error("No se pudo generar el pack de documentos")}},children:"Imprimir Pack (Partes + Pagos)"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Mapa de LPO (depuración)"}),e.jsxs("div",{className:"text-muted-foreground",children:["Carpeta padre (work_orders): ",(_==null?void 0:_.element_id)||"—"]})]}),e.jsx(z,{size:"sm",variant:"outline",onClick:()=>x(_==null?void 0:_.element_id),children:"Copiar carpeta"})]}),c&&c.length>0?e.jsx("div",{className:"border-t pt-2 space-y-1",children:c.map(l=>{var G,X;const g=[(G=l==null?void 0:l.profiles)==null?void 0:G.first_name,(X=l==null?void 0:l.profiles)==null?void 0:X.last_name].filter(Boolean).join(" ")||l.technician_id,E=(l==null?void 0:l.flex_element_id)||(l==null?void 0:l.flex_document_id)||"—",$=(l==null?void 0:l.flex_vendor_id)||"—",L=(l==null?void 0:l.lpo_number)||"—";return e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate",children:e.jsx("span",{className:"font-medium",children:g})}),e.jsxs("div",{className:"text-xs text-muted-foreground truncate",children:["LPO: ",E,e.jsxs("a",{className:"ml-2 text-primary hover:underline inline-flex items-center",href:`https://sectorpro.flexrentalsolutions.com/f5/ui/?desktop#fin-doc/${encodeURIComponent(E)}/doc-view/8238f39c-f42e-11e0-a8de-00e08175e43e/detail`,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(bs,{className:"h-3 w-3 mr-1"})," Abrir en Flex"]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground truncate",children:["Vendor: ",$]}),e.jsxs("div",{className:"text-xs text-muted-foreground truncate",children:["Número: ",L]})]}),e.jsxs("div",{className:"flex gap-1 shrink-0",children:[e.jsx(z,{size:"sm",variant:"outline",onClick:()=>x(String(E)),children:"Copiar LPO"}),e.jsx(z,{size:"sm",variant:"outline",onClick:()=>x(String(L)),children:"Copiar Nº"}),e.jsx(z,{size:"sm",variant:"outline",onClick:()=>x(String($)),children:"Copiar Vendor"})]})]},`${l.technician_id}-${E}`)})}):e.jsx("div",{className:"text-xs text-muted-foreground",children:"No hay LPO registrados en BD para este trabajo."})]})})]})},Bs=({open:i,jobDetails:t,isJobLoading:s})=>{const[m,N]=B.useState(null),[v,T]=B.useState(null),[d,h]=B.useState(!1);B.useEffect(()=>{(async()=>{try{if(!i)return;const j=t==null?void 0:t.locations;if(!j){T(null);return}const r=typeof j.latitude=="number"?j.latitude:typeof j.latitude=="string"?parseFloat(j.latitude):void 0,w=typeof j.longitude=="number"?j.longitude:typeof j.longitude=="string"?parseFloat(j.longitude):void 0,k=j.formatted_address||j.address||j.name||"";h(!0);let F=m;if(!F){const{data:l,error:g}=await P.functions.invoke("get-google-maps-key");if(g||!(l!=null&&l.apiKey)){T(null),h(!1);return}F=l.apiKey,N(F)}const V=15,f=600,_=300,c=2,u=Number.isFinite(r)&&Number.isFinite(w)?`${r},${w}`:encodeURIComponent(k),a=Number.isFinite(r)&&Number.isFinite(w)?`&markers=color:red|label:A|${r},${w}`:k?`&markers=color:red|label:A|${encodeURIComponent(k)}`:"",x=`https://maps.googleapis.com/maps/api/staticmap?center=${u}&zoom=${V}&size=${f}x${_}&scale=${c}${a}&key=${encodeURIComponent(F)}`;T(x)}catch{T(null)}finally{h(!1)}})()},[i,t,m]);const p=()=>{if(t!=null&&t.locations){const y=encodeURIComponent(t.locations.formatted_address||t.locations.name||"");window.open(`https://www.google.com/maps/search/?api=1&query=${y}`,"_blank")}};return e.jsx(ae,{value:"location",className:"space-y-4 min-w-0 overflow-x-hidden",children:e.jsx(q,{className:"p-4 w-full min-w-0 overflow-hidden",children:s?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):t!=null&&t.locations?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:t.locations.name}),t.locations.formatted_address&&e.jsx("p",{className:"text-muted-foreground",children:t.locations.formatted_address})]}),e.jsxs(z,{onClick:p,size:"sm",children:[e.jsx(_e,{className:"h-4 w-4 mr-2"}),"Abrir mapas"]})]}),d&&e.jsx("div",{className:"aspect-[2/1] bg-muted rounded-lg flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Cargando vista previa del mapa..."})]})}),!d&&v&&e.jsxs("div",{className:"rounded-lg overflow-hidden border",children:[e.jsx("img",{src:v,alt:"Mapa del recinto",width:600,height:300,loading:"lazy",decoding:"async",className:"w-full h-auto"}),e.jsx("div",{className:"p-2 flex justify-end",children:e.jsx(z,{onClick:p,size:"sm",children:"Ver indicaciones"})})]}),!d&&!v&&e.jsx("div",{className:"aspect-[2/1] bg-muted rounded-lg flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(_e,{className:"h-8 w-8 mx-auto mb-2 text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Vista previa del mapa no disponible"}),e.jsx(z,{onClick:p,size:"sm",className:"mt-2",children:"Abrir Google Maps"})]})}),t.logistics_events&&t.logistics_events.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold mb-2 flex items-center gap-2",children:[e.jsx(ks,{className:"h-4 w-4"}),"Logística"]}),e.jsx("div",{className:"space-y-2",children:t.logistics_events.map(y=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-muted rounded",children:[e.jsxs("div",{children:[e.jsx("span",{className:"capitalize font-medium",children:y.event_type}),e.jsxs("span",{className:"text-muted-foreground ml-2",children:["(",y.transport_type,")"]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[y.event_date?Y(new Date(y.event_date),"PPP",{locale:te}):"Sin fecha"," a las"," ",y.event_time||"sin hora"]})]},y.id))})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(_e,{className:"h-8 w-8 mx-auto mb-2 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"No hay información de ubicación disponible"})]})})})},Os=({jobDetails:i,isJobLoading:t,department:s})=>{var T;const m=((T=s==null?void 0:s.toLowerCase)==null?void 0:T.call(s))??null,N=B.useMemo(()=>{const d=(i==null?void 0:i.job_assignments)??[];return m?d.filter(h=>{var y,j,r;return!!(((r=(j=(y=h.profiles)==null?void 0:y.department)==null?void 0:j.toLowerCase)==null?void 0:r.call(j))===m||m==="sound"&&h.sound_role||m==="lights"&&h.lights_role||m==="video"&&h.video_role)}):d},[i==null?void 0:i.job_assignments,m]),v=B.useMemo(()=>{const d=new Map;return i!=null&&i.timesheets&&i.timesheets.forEach(h=>{var p;h.technician_id&&h.date&&(d.has(h.technician_id)||d.set(h.technician_id,new Set),(p=d.get(h.technician_id))==null||p.add(h.date))}),d},[i==null?void 0:i.timesheets]);return e.jsx(ae,{value:"personnel",className:"space-y-4 min-w-0 overflow-x-hidden",children:e.jsxs(q,{className:"p-4 w-full min-w-0 overflow-hidden",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4"}),"Personal asignado"]}),t?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):N.length>0?e.jsx("div",{className:"space-y-3",children:N.map(d=>{var h,p,y,j;return e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-3 bg-muted rounded min-w-0",children:[e.jsxs("div",{className:"min-w-0 flex-1 flex items-center gap-3",children:[e.jsxs(Cs,{className:"h-10 w-10 shrink-0",children:[((h=d.profiles)==null?void 0:h.profile_picture_url)&&e.jsx(Ss,{src:d.profiles.profile_picture_url,alt:`${d.profiles.first_name} ${d.profiles.last_name}`}),e.jsx(Ts,{className:"text-sm",children:d.profiles?`${((p=d.profiles.first_name)==null?void 0:p[0])||""}${((y=d.profiles.last_name)==null?void 0:y[0])||""}`.toUpperCase():"EX"})]}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium break-words",children:d.profiles?`${d.profiles.first_name} ${d.profiles.last_name}`:d.external_technician_name||"Desconocido"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:((j=d.profiles)==null?void 0:j.department)||"Externo"}),d.single_day&&e.jsx("p",{className:"text-xs text-muted-foreground break-words",children:(()=>{const r=v.get(d.technician_id);if(r&&r.size>0){const w=Array.from(r).sort();return w.length===1?`Solo día: ${Y(new Date(w[0]),"PPP",{locale:te})}`:`Días: ${w.map(k=>Y(new Date(k),"dd/MM")).join(", ")}`}return d.assignment_date?`Solo día: ${Y(new Date(d.assignment_date),"PPP",{locale:te})}`:"Sin fecha definida"})()})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-1 w-full sm:w-auto sm:shrink-0",children:[d.sound_role&&e.jsxs(O,{variant:"outline",className:"text-xs",children:["Sonido: ",ve(d.sound_role)]}),d.lights_role&&e.jsxs(O,{variant:"outline",className:"text-xs",children:["Luces: ",ve(d.lights_role)]}),d.video_role&&e.jsxs(O,{variant:"outline",className:"text-xs",children:["Vídeo: ",ve(d.video_role)]}),d.single_day&&e.jsx(O,{variant:"secondary",className:"text-xs",children:(()=>{const r=v.get(d.technician_id);return r&&r.size>0?r.size===1?"Día único":"Varios días":"Día único"})()})]})]},d.technician_id)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(he,{className:"h-8 w-8 mx-auto mb-2 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"No hay personal asignado aún"})]})]})})},Qs=({open:i,jobId:t,jobDetails:s,isJobLoading:m})=>{var T,d,h,p,y,j;const{data:N=[],isLoading:v}=I({queryKey:["job-restaurants",t,(T=s==null?void 0:s.locations)==null?void 0:T.formatted_address],queryFn:async()=>{const r=s==null?void 0:s.locations,w=(r==null?void 0:r.formatted_address)||(r==null?void 0:r.name);if(!w&&!(r!=null&&r.latitude))return[];const k=r!=null&&r.latitude&&(r!=null&&r.longitude)?{lat:Number(r.latitude),lng:Number(r.longitude)}:void 0;return await Ps.searchRestaurantsNearVenue(w||`${k==null?void 0:k.lat},${k==null?void 0:k.lng}`,2e3,10,k)},enabled:i&&!m&&!!(s!=null&&s.locations)&&(!!((d=s==null?void 0:s.locations)!=null&&d.formatted_address)||!!((h=s==null?void 0:s.locations)!=null&&h.name)||!!((p=s==null?void 0:s.locations)!=null&&p.latitude)&&!!((y=s==null?void 0:s.locations)!=null&&y.longitude))});return e.jsx(ae,{value:"restaurants",className:"space-y-4 min-w-0 overflow-x-hidden",children:e.jsxs(q,{className:"p-4 w-full min-w-0 overflow-hidden",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Be,{className:"h-4 w-4"}),"Restaurantes cercanos"]}),m||v?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"Buscando restaurantes cercanos..."})]}):N&&N.length>0?e.jsx("div",{className:"space-y-3",children:N.map(r=>e.jsx("div",{className:"p-3 bg-[#0f1219] border border-[#1f232e] rounded",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 min-w-0",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium break-words",children:r.name}),e.jsx("p",{className:"text-sm text-muted-foreground break-words",children:r.address}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[r.rating&&e.jsxs(O,{variant:"outline",className:"text-xs",children:["⭐ ",r.rating]}),r.priceLevel!==void 0&&e.jsx(O,{variant:"outline",className:"text-xs",children:"€".repeat(r.priceLevel+1)}),r.distance&&e.jsxs(O,{variant:"outline",className:"text-xs",children:["A ",Math.round(r.distance)," m"]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto sm:shrink-0",children:[r.phone&&e.jsx(z,{size:"sm",variant:"outline",asChild:!0,className:"w-full sm:w-auto",children:e.jsxs("a",{href:`tel:${r.phone}`,children:[e.jsx(Ms,{className:"h-4 w-4 sm:mr-0"}),e.jsx("span",{className:"sm:hidden ml-2",children:"Llamar"})]})}),r.website&&e.jsx(z,{size:"sm",variant:"outline",asChild:!0,className:"w-full sm:w-auto",children:e.jsxs("a",{href:r.website,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(Es,{className:"h-4 w-4 sm:mr-0"}),e.jsx("span",{className:"sm:hidden ml-2",children:"Sitio web"})]})})]})]})},r.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Be,{className:"h-8 w-8 mx-auto mb-2 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:(j=s==null?void 0:s.locations)!=null&&j.formatted_address?"No se encontraron restaurantes cercanos":"No hay dirección del recinto para buscar restaurantes"})]})]})})},Vs=({jobDetails:i,isJobLoading:t})=>{const[s,m]=B.useState(void 0),N=B.useMemo(()=>{if(!(i!=null&&i.start_time)||!(i!=null&&i.end_time))return"";const p=new Date(i.start_time),y=new Date(i.end_time),j=p.toLocaleDateString("en-GB").split("/").join("/"),r=y.toLocaleDateString("en-GB").split("/").join("/");return p.toDateString()!==y.toDateString()?`${j} - ${r}`:j},[i==null?void 0:i.start_time,i==null?void 0:i.end_time]),v=B.useMemo(()=>{const p=i==null?void 0:i.locations;return{address:(p==null?void 0:p.formatted_address)||(p==null?void 0:p.name),coordinates:p!=null&&p.latitude&&(p!=null&&p.longitude)?{lat:typeof p.latitude=="number"?p.latitude:parseFloat(p.latitude),lng:typeof p.longitude=="number"?p.longitude:parseFloat(p.longitude)}:void 0}},[i==null?void 0:i.locations]),{isLoading:T,error:d,fetchWeather:h}=is({venue:v,eventDates:N,onWeatherUpdate:m});return e.jsx(ae,{value:"weather",className:"space-y-4 min-w-0 overflow-x-hidden",children:e.jsxs(q,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Oe,{className:"h-4 w-4"}),"Pronóstico del Tiempo"]}),!t&&v.address&&N&&e.jsxs(z,{variant:"outline",size:"sm",onClick:h,disabled:T,className:"flex items-center gap-1",children:[T?e.jsx(xe,{className:"h-4 w-4 animate-spin"}):e.jsx(Je,{className:"h-4 w-4"}),T?"Cargando...":"Actualizar"]})]}),t?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):!v.address&&!v.coordinates?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground py-4",children:[e.jsx(le,{className:"h-4 w-4"}),"El pronóstico del tiempo requiere ubicación del lugar"]}):N?d?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive py-4",children:[e.jsx(le,{className:"h-4 w-4"}),d]}):T?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground py-4",children:[e.jsx(xe,{className:"h-4 w-4 animate-spin"}),"Obteniendo pronóstico del tiempo..."]}):s&&s.length>0?e.jsxs("div",{className:"space-y-2",children:[s.map((p,y)=>{const j=w=>w.toLowerCase().includes("sun")?"☀️":w.toLowerCase().includes("cloud")?"☁️":w.toLowerCase().includes("rain")?"🌧️":w.toLowerCase().includes("snow")?"❄️":w.toLowerCase().includes("storm")?"⛈️":"🌤️",r=w=>{try{return new Date(w).toLocaleDateString("es-ES",{month:"long",day:"numeric"})}catch{return w}};return e.jsx("div",{className:"flex items-center justify-between p-3 rounded-lg bg-muted/50",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-2xl",children:j(p.condition)}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-sm",children:[r(p.date)," – ",p.condition]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[Math.round(p.maxTemp),"°C / ",Math.round(p.minTemp),"°C",p.precipitationProbability>0&&e.jsxs("span",{children:[", ",p.precipitationProbability,"% lluvia"]})]})]})]})},y)}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-4",children:[e.jsx("strong",{children:"Fuente:"})," Los datos del tiempo se obtienen de Open-Meteo y se actualizan automáticamente."]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Oe,{className:"h-8 w-8 mx-auto mb-2 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Datos del tiempo no disponibles para las fechas y ubicación seleccionadas."})]}):e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground py-4",children:[e.jsx(le,{className:"h-4 w-4"}),"El pronóstico del tiempo requiere fechas del evento"]})]})})},Ws=({open:i,onOpenChange:t,job:s,department:m="sound"})=>{const[N,v]=B.useState("info"),{userRole:T,user:d}=Ze(),h=["admin","management"].includes(T||""),p=["technician","house_tech"].includes(T||""),y=T==="house_tech",j=Se(),{data:r,isLoading:w,error:k}=I({queryKey:["job-details",s.id],queryFn:async()=>{const{data:M,error:K}=await P.from("jobs").select(`
          *,
          locations(id, name, formatted_address, latitude, longitude),
          job_assignments(
            job_id, technician_id, assigned_by, assigned_at,
            sound_role, lights_role, video_role, status,
            single_day, assignment_date,
            profiles(id, first_name, last_name, department, role, profile_picture_url)
          ),
          timesheets(technician_id, date),
          job_documents(id, file_name, file_path, uploaded_at, file_size, visible_to_tech, read_only, template_type),
          logistics_events(id, event_type, transport_type, event_date, event_time, license_plate)
        `).eq("id",s.id).single();if(K)throw K;return M},enabled:i}),F=(r==null?void 0:r.id)||s.id,{data:V=[]}=as(F),{data:f}=rs(F),_=(f==null?void 0:f.rates_approved)??!!(r!=null&&r.rates_approved),c=((r==null?void 0:r.job_type)||(s==null?void 0:s.job_type))==="dryhire",u=!c&&(h||y||_&&V.length>0),a=(h||_)&&!y,x=!c&&(r==null?void 0:r.job_type)==="tourdate"&&a,l=["admin","management","logistics"].includes(T||""),g=!c&&l,E=(r==null?void 0:r.job_documents)||(s==null?void 0:s.job_documents)||[],$=w,L=B.useMemo(()=>{const M=new Map;return((r==null?void 0:r.job_assignments)??[]).forEach(K=>{var b,S;const A=K.technician_id;if(!A||M.has(A))return;const U=[(b=K.profiles)==null?void 0:b.first_name,(S=K.profiles)==null?void 0:S.last_name].filter(Boolean).join(" ").trim();M.set(A,U||A)}),((r==null?void 0:r.timesheets)??[]).forEach(K=>{var b,S;const A=K.technician_id;if(!A||M.has(A))return;const U=[(b=K.technician)==null?void 0:b.first_name,(S=K.technician)==null?void 0:S.last_name].filter(Boolean).join(" ").trim();M.set(A,U||A)}),Array.from(M.entries()).map(([K,A])=>({id:K,name:A||K}))},[r==null?void 0:r.job_assignments,r==null?void 0:r.timesheets]);B.useEffect(()=>{!x&&N==="tour-rates"&&v("info"),!u&&N==="extras"&&v("info"),!g&&N==="expenses"&&v("info")},[x,u,g,N]);const[G,X]=B.useState(!1),[re,n]=B.useState(null);if(B.useEffect(()=>{const M=s.id!==re;(i&&!G||i&&M)&&(v("info"),n(s.id)),X(i)},[i,G,s.id,re]),B.useEffect(()=>{},[N]),B.useEffect(()=>{i&&s.id&&(j.invalidateQueries({queryKey:["job-details",s.id]}),j.invalidateQueries({queryKey:["job-artists",s.id]}),j.invalidateQueries({queryKey:["job-restaurants",s.id]}),j.invalidateQueries({queryKey:["job-rider-files",s.id]}))},[s.id,i,j]),B.useEffect(()=>{i&&c&&["location","personnel","documents","restaurants","weather","extras","expenses"].includes(N)&&v("info")},[i,c,N]),ss(),w)return e.jsx(be,{open:i,onOpenChange:t,children:e.jsx(ke,{className:"w-[95vw] max-w-4xl max-h-[90vh] flex flex-col overflow-y-auto",children:e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})})});const o=c?"grid-cols-1":"grid-cols-2 sm:grid-cols-4 md:grid-cols-8";return e.jsx(be,{open:i,onOpenChange:t,children:e.jsxs(ke,{className:"w-[98vw] sm:w-[96vw] max-w-[1200px] xl:max-w-[1400px] max-h-[92vh] flex flex-col overflow-y-auto overflow-x-hidden px-3 sm:px-6",children:[e.jsx(We,{className:"flex-shrink-0",children:e.jsxs(qe,{className:"flex items-center gap-2 text-base md:text-lg",children:[e.jsx(Ge,{className:"h-4 w-4 md:h-5 md:w-5"}),e.jsx("span",{className:"truncate",children:(r==null?void 0:r.title)||"Detalles del trabajo"})]})}),e.jsx("div",{className:"min-h-0 overflow-y-auto overflow-x-hidden max-h-[75vh]",children:e.jsxs(De,{value:N,onValueChange:v,className:"flex flex-col min-w-0",children:[e.jsxs(es,{className:`grid w-full ${o} flex-shrink-0 h-auto text-xs md:text-sm overflow-x-auto no-scrollbar`,children:[e.jsx(se,{value:"info",className:"py-2",children:"Información"}),!c&&e.jsx(se,{value:"location",className:"py-2",children:"Ubicación"}),!c&&e.jsx(se,{value:"personnel",className:"py-2",children:"Personal"}),!c&&e.jsx(se,{value:"documents",className:"py-2",children:"Documentos"}),!c&&e.jsx(se,{value:"restaurants",className:"py-2",children:"Restaurantes"}),!c&&e.jsx(se,{value:"weather",className:"py-2",children:"Clima"}),x&&e.jsx(se,{value:"tour-rates",className:"py-2",children:"Tarifas"}),!c&&u&&e.jsx(se,{value:"extras",className:"py-2",children:"Extras"}),g&&e.jsx(se,{value:"expenses",className:"py-2",children:"Gastos"})]}),e.jsxs("div",{className:"mt-3 md:mt-4 px-1 pr-1 min-w-0 overflow-x-hidden",children:[e.jsx(Ks,{open:i,job:s,jobDetails:r,resolvedJobId:F,isManager:h,isTechnicianRole:p,isDryhire:c,jobRatesApproved:_}),!c&&e.jsx(Bs,{open:i,jobDetails:r,isJobLoading:w}),!c&&e.jsx(Os,{jobDetails:r,isJobLoading:w,department:m}),!c&&e.jsx(zs,{open:i,jobId:s.id,resolvedDocuments:E,documentsLoading:$,jobDocumentsError:k}),!c&&e.jsx(Qs,{open:i,jobId:s.id,jobDetails:r,isJobLoading:w}),!c&&e.jsx(Vs,{jobDetails:r,isJobLoading:w}),x&&F&&e.jsx(ae,{value:"tour-rates",className:"space-y-4 min-w-0 overflow-x-hidden",children:e.jsx(Fs,{jobId:F})}),!c&&u&&e.jsx(ae,{value:"extras",className:"space-y-4 min-w-0 overflow-x-hidden",children:e.jsx(_s,{jobId:F,isManager:h,technicianId:h?void 0:(d==null?void 0:d.id)||void 0})}),g&&e.jsx(ae,{value:"expenses",className:"space-y-4 min-w-0 overflow-x-hidden",children:e.jsx(Rs,{jobId:F||s.id,jobTitle:(r==null?void 0:r.title)||(s==null?void 0:s.title),technicians:L,canManage:l})})]})]})})]})})},Xe=Q.memo(Ws);Xe.displayName="JobDetailsDialog";const Ta=Object.freeze(Object.defineProperty({__proto__:null,JobDetailsDialog:Xe,enrichTimesheetsWithProfiles:Ie},Symbol.toStringTag,{value:"Module"}));export{Oe as C,Xe as J,Fs as T,Ta as a,Us as u};
