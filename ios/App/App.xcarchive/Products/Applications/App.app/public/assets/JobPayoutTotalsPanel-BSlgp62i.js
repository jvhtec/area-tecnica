import{f as je,n as u,m as v,i as Xe,j as r,h as T,B as O,I as Ye,a4 as f,u as Ze,C as re,W as te,Y as ae,A as se,Q as Ie}from"./index-NZ6jJLfQ.js";import{B as Q}from"./badge-vNTKF5RD.js";import{S as ge}from"./separator-E-JdTFOv.js";import{u as er}from"./useJobPayoutTotals-CXAavZS-.js";import{c as De,u as rr,b as tr,s as Se,g as ar}from"./useManagerJobQuotes-BrI1iNRY.js";import{u as J}from"./useQuery-kdg2pmgf.js";import{u as ye}from"./useMutation-DluhVBs1.js";import{S as sr}from"./switch-DUBpZhIC.js";import{P as ve}from"./pen-D_H3YLSb.js";import{E as ne}from"./euro-DgRTeGAz.js";import{F as nr}from"./file-down-Buu6FgvW.js";import{S as Me}from"./send-Uvkx0r_O.js";import{C as Pe}from"./circle-alert-LZYNzZ7F.js";import{E as ir}from"./external-link-QJoXZ6ES.js";import{C as or}from"./clock-BXPvTWvY.js";import{C as cr}from"./circle-check-big-CilmNGCn.js";function lr(){const t=je();return ye({mutationFn:async({jobId:s,technicianId:a,approved:i})=>{const{error:m}=await v.from("timesheets").update({approved_by_manager:i}).eq("job_id",s).eq("technician_id",a);if(m)throw m},onSuccess:(s,{jobId:a,technicianId:i})=>{t.invalidateQueries({queryKey:["job-tech-payout",a]}),t.invalidateQueries({queryKey:["job-tech-payout",a,i]}),u.success("Estado de aprobación actualizado")},onError:s=>{u.error("Error al actualizar la aprobación")}})}const dr=30;function Ae(t){return t.replace(/[^\w\s-]/g,"").replace(/\s+/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"").toLowerCase()}async function ur(t){const s=await t.arrayBuffer(),a=new Uint8Array(s);let i="";const m=32768;for(let l=0;l<a.length;l+=m){const n=a.subarray(l,l+m);i+=String.fromCharCode(...n)}return btoa(i)}function mr(t){const s=new Map;return t.forEach(a=>{const i=a.amount_breakdown||a.amount_breakdown_visible||{},m={date:a.date??null,hours_rounded:Number(i.hours_rounded??i.worked_hours_rounded??0)||0,base_day_eur:i.base_day_eur!=null?Number(i.base_day_eur):void 0,plus_10_12_hours:i.plus_10_12_hours!=null?Number(i.plus_10_12_hours):void 0,plus_10_12_amount_eur:i.plus_10_12_amount_eur!=null?Number(i.plus_10_12_amount_eur):void 0,overtime_hours:i.overtime_hours!=null?Number(i.overtime_hours):void 0,overtime_hour_eur:i.overtime_hour_eur!=null?Number(i.overtime_hour_eur):void 0,overtime_amount_eur:i.overtime_amount_eur!=null?Number(i.overtime_amount_eur):void 0,total_eur:i.total_eur!=null?Number(i.total_eur):void 0},l=s.get(a.technician_id)||[];l.push(m),s.set(a.technician_id,l)}),s}async function hr(t,s,a){if(a)return a;const{data:i,error:m}=await t.from("jobs").select("id, title, start_time, tour_id, rates_approved").eq("id",s).maybeSingle();if(m||!i)throw m||new Error("Job not found");return i}async function _r(t,s,a){if(a&&a.length)return a;const{data:i,error:m}=await t.from("v_job_tech_payout_2025").select("*").eq("job_id",s);if(m)throw m;return i||[]}async function fr(t,s,a){if(a){const l=a.every(p=>Object.prototype.hasOwnProperty.call(p,"email")),n=a.every(p=>Object.prototype.hasOwnProperty.call(p,"autonomo"));if(l&&n)return a}if(!s.length)return a||[];const{data:i,error:m}=await t.from("profiles").select("id, first_name, last_name, email, autonomo").in("id",s);if(m)throw m;return i||[]}async function pr(t,s,a,i){if(i)return i;if(!a.length)return new Map;const{data:m,error:l}=await t.from("flex_work_orders").select("technician_id, lpo_number").eq("job_id",s).in("technician_id",a);if(l)throw l;return new Map((m||[]).map(n=>[n.technician_id,n.lpo_number||null]))}async function xr(t,s){const{data:a,error:i}=await t.from("timesheets").select("technician_id, job_id, date, amount_breakdown, approved_by_manager").eq("job_id",s).eq("approved_by_manager",!0);if(i)throw i;if(a&&a.length)return a;const{data:m,error:l}=await t.rpc("get_timesheet_amounts_visible");if(l)throw l;return(m||[]).filter(n=>n.job_id===s&&n.approved_by_manager===!0)}async function Be(t){const{jobId:s,supabase:a,jobDetails:i,payouts:m,profiles:l,lpoMap:n}=t,p=await hr(a,s,i),S=await _r(a,s,m),k=Array.from(new Set(S.map(h=>h.technician_id).filter(Boolean))),A=await fr(a,k,l),q=await pr(a,s,k,n),R=await xr(a,s),K=mr(R),ce=new Map(A.map(h=>[h.id,h])),L=[];for(const h of S){const j=ce.get(h.technician_id),w=`${(j==null?void 0:j.first_name)??""} ${(j==null?void 0:j.last_name)??""}`.trim()||h.technician_id,le=new Map([[h.technician_id,K.get(h.technician_id)||[]]]);let F=0;if((j==null?void 0:j.autonomo)===!1){let B=0;const W=K.get(h.technician_id)||[];if(W.length>0){const y=new Set(W.map(z=>z.date).filter(Boolean));B=y.size>0?y.size:1}else h.timesheets_total_eur>0&&(B=1);F=B*dr}const D=await De([h],p,A,q,le,{download:!1});if(!D)continue;const C=await ur(D),de=Ae(p.title||p.id),ue=Ae(w),me=Xe(new Date,"yyyy-MM-dd"),he=`pago_${de||p.id}_${ue||h.technician_id}_${me}.pdf`;L.push({technician_id:h.technician_id,email:(j==null?void 0:j.email)??null,full_name:w,payout:h,deduction_eur:F,pdfBase64:C,filename:he,autonomo:(j==null?void 0:j.autonomo)??null,lpo_number:q.get(h.technician_id)??null})}const U=L.filter(h=>!h.email).map(h=>h.technician_id);return{job:p,payouts:S,profiles:A,lpoMap:q,timesheetMap:K,attachments:L,missingEmails:U}}async function Fe(t){const s=t.existingContext??await Be(t),a=s.attachments.filter(n=>n.email);if(!a.length)return{success:!1,missingEmails:s.missingEmails,context:s,error:new Error("No technicians with email available")};const i={job:{id:s.job.id,title:s.job.title,start_time:s.job.start_time,tour_id:s.job.tour_id??null},technicians:a.map(n=>({technician_id:n.technician_id,email:n.email,full_name:n.full_name,totals:{timesheets_total_eur:n.payout.timesheets_total_eur,extras_total_eur:n.payout.extras_total_eur,total_eur:n.payout.total_eur-(n.deduction_eur||0),deduction_eur:n.deduction_eur},pdf_base64:n.pdfBase64,filename:n.filename,autonomo:n.autonomo??null,lpo_number:n.lpo_number??null})),missing_emails:s.missingEmails,requested_at:new Date().toISOString()},{data:m,error:l}=await t.supabase.functions.invoke("send-job-payout-email",{body:i});return{success:!l&&(m==null?void 0:m.success)!==!1,missingEmails:s.missingEmails,response:m,error:l,context:s}}function br(){const t=je();return ye({mutationFn:async({jobId:s,technicianId:a,amountEur:i,calculatedTotal:m})=>{const{data:l,error:n}=await v.rpc("set_technician_payout_override",{_job_id:s,_technician_id:a,_amount_eur:i});if(n)throw n;const p=l;if(p.success)try{const{error:S}=await v.functions.invoke("send-payout-override-notification",{body:{jobId:p.job_id,jobTitle:p.job_title,jobStartTime:p.job_start_time,technicianId:p.technician_id,technicianName:p.technician_name,technicianDepartment:p.technician_department,actorId:p.actor_id,oldOverrideAmountEur:p.old_override_amount_eur,newOverrideAmountEur:p.new_override_amount_eur,calculatedTotal:p.calculated_total_eur}})}catch{}return p},onSuccess:s=>{t.invalidateQueries({queryKey:["job-tech-payout",s.job_id]}),t.invalidateQueries({queryKey:["job-tech-payout-overrides",s.job_id]});const a=s.old_override_amount_eur===null?"activado":"modificado";u.success(`Override de pago ${a} para ${s.technician_name}`)},onError:s=>{s.message.includes("Permission denied")?u.error("No tienes permiso para modificar el override de este técnico"):s.message.includes("must be a positive number")?u.error("El monto debe ser un número positivo"):s.message.includes("not assigned to this job")?u.error("Este técnico no está asignado a este trabajo"):u.error("Error al guardar el override de pago")}})}function gr(){const t=je();return ye({mutationFn:async({jobId:s,technicianId:a})=>{const{data:i,error:m}=await v.rpc("remove_technician_payout_override",{_job_id:s,_technician_id:a});if(m)throw m;const l=i;if(l.success)try{const{error:n}=await v.functions.invoke("send-payout-override-notification",{body:{jobId:l.job_id,jobTitle:l.job_title,jobStartTime:l.job_start_time,technicianId:l.technician_id,technicianName:l.technician_name,technicianDepartment:l.technician_department,actorId:l.actor_id,oldOverrideAmountEur:l.old_override_amount_eur,newOverrideAmountEur:null,calculatedTotal:l.calculated_total_eur}})}catch{}return l},onSuccess:s=>{t.invalidateQueries({queryKey:["job-tech-payout",s.job_id]}),t.invalidateQueries({queryKey:["job-tech-payout-overrides",s.job_id]}),u.success(`Override removido para ${s.technician_name}`)},onError:s=>{u.error("Error al remover el override de pago")}})}function vr(t){return J({queryKey:["job-tech-payout-overrides",t],queryFn:async()=>{const{data:s,error:a}=await v.from("job_technician_payout_overrides").select("*").eq("job_id",t);if(a)throw a;return s||[]},enabled:!!t,staleTime:3e4})}const jr=({override:t,isEditing:s,techName:a,calculatedTotalEur:i,editingAmount:m,onEditingAmountChange:l,onStartEdit:n,onSave:p,onCancel:S,onRemove:k,isSaving:A,isRemoving:q})=>r.jsxs("div",{className:"space-y-2",children:[t&&!s&&r.jsxs("div",{className:"text-xs bg-amber-500/10 p-2 rounded border border-amber-500/30 text-amber-700 dark:text-amber-200",children:[r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsx("span",{className:"font-medium",children:"Override activo:"}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{className:"font-bold",children:T(t.override_amount_eur)}),r.jsx(O,{size:"sm",variant:"ghost",onClick:n,className:"h-6 px-2 text-amber-700 dark:text-amber-200 hover:text-amber-800 dark:hover:text-amber-100 hover:bg-amber-500/20",children:r.jsx(ve,{className:"h-3 w-3"})}),r.jsx(O,{size:"sm",variant:"ghost",onClick:k,disabled:q,className:"h-6 px-2 text-red-600 dark:text-red-300 hover:text-red-700 dark:hover:text-red-200 hover:bg-red-500/20",children:"×"})]})]}),r.jsxs("div",{className:"text-xs mt-1 opacity-75",children:["Calculado: ",T(i)]})]}),s&&r.jsxs("div",{className:"bg-amber-500/10 p-3 rounded border border-amber-500/30 space-y-2",children:[r.jsxs("div",{className:"flex items-center gap-2 text-xs text-amber-700 dark:text-amber-200",children:[r.jsx(ve,{className:"h-3.5 w-3.5"}),r.jsxs("span",{className:"font-medium",children:["Override de pago para ",a]})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(Ye,{type:"number",step:"0.01",min:"0",value:m,onChange:R=>l(R.target.value),placeholder:"0.00",className:"flex-1 bg-background border-input text-foreground placeholder:text-muted-foreground h-8",autoFocus:!0}),r.jsx(O,{size:"sm",onClick:p,disabled:A,className:"bg-amber-600 hover:bg-amber-500 text-white h-8",children:A?"Guardando...":"Guardar"}),r.jsx(O,{size:"sm",variant:"ghost",onClick:S,className:"text-foreground hover:bg-muted h-8",children:"Cancelar"})]}),r.jsxs("div",{className:"text-xs text-amber-700 dark:text-amber-200",children:["Calculado: ",T(i)]})]}),!t&&!s&&r.jsxs(O,{size:"sm",variant:"outline",onClick:n,className:"w-full border-amber-500/30 text-amber-700 dark:text-amber-200 hover:bg-amber-500/10 hover:text-amber-800 dark:hover:text-amber-100",children:[r.jsx(ve,{className:"h-3 w-3 mr-1"}),"Establecer override de pago"]})]}),ie="bg-card border-border text-card-foreground overflow-hidden",yr="bg-muted/30 border-border",Oe="text-muted-foreground",qe="variant-outline border-border",oe=30;function Rr({jobId:t,technicianId:s}){const{data:a,isLoading:i,error:m}=J({queryKey:["job-payout-metadata",t],enabled:!!t,queryFn:async()=>{const{data:e,error:o}=await v.from("jobs").select("id, title, start_time, tour_id, rates_approved, job_type").eq("id",t).maybeSingle();if(o)throw o;return e},staleTime:6e4}),l=(a==null?void 0:a.job_type)??null,n=l==="tourdate",p=!!t&&!n&&!i,S=!!t&&n,{data:k=[],isLoading:A,error:q}=er(t,s,{enabled:p}),{data:R=[],isLoading:K,error:ce}=rr(S?t:void 0,l??void 0,(a==null?void 0:a.tour_id)??void 0),{data:L=new Map}=J({queryKey:["job-tech-payout",t,"approvals"],enabled:!!t&&n,queryFn:async()=>{const{data:e,error:o}=await v.from("timesheets").select("technician_id, approved_by_manager").eq("job_id",t);if(o)throw o;const d=new Map;(e||[]).forEach(_=>{if(!_.technician_id)return;const b=d.get(_.technician_id)||[];b.push(_.approved_by_manager||!1),d.set(_.technician_id,b)});const c=new Map;return d.forEach((_,b)=>{const P=_.length>0&&_.every(g=>g===!0);c.set(b,P)}),c},staleTime:30*1e3}),{data:U=new Map}=J({queryKey:["job-tech-days",t],enabled:!!t&&!n&&!i,queryFn:async()=>{const{data:e,error:o}=await v.from("timesheets").select("technician_id, date").eq("job_id",t).eq("approved_by_manager",!0);if(o)throw o;const d=new Map;e==null||e.forEach(_=>{!_.technician_id||!_.date||(d.has(_.technician_id)||d.set(_.technician_id,new Set),d.get(_.technician_id).add(_.date))});const c=new Map;return d.forEach((_,b)=>c.set(b,_.size)),c},staleTime:6e4}),h=f.useMemo(()=>{const e=R||[];return s?e.filter(o=>o.technician_id===s):e},[R,s]),j=f.useMemo(()=>h.map(e=>{var b;const o=Number(e.total_eur??0),d=Number(e.extras_total_eur??(((b=e.extras)==null?void 0:b.total_eur)!=null?e.extras.total_eur:0)),c=Number(e.total_with_extras_eur!=null?e.total_with_extras_eur:o+d),_=e.extras!=null?e.extras:{items:[],total_eur:d};return{job_id:e.job_id,technician_id:e.technician_id,timesheets_total_eur:o,extras_total_eur:d,total_eur:c,extras_breakdown:{items:_.items??[],total_eur:_.total_eur??d},vehicle_disclaimer:!!e.vehicle_disclaimer,vehicle_disclaimer_text:e.vehicle_disclaimer_text??void 0,payout_approved:L.get(e.technician_id)??!1,expenses_total_eur:0,expenses_breakdown:[]}}),[h,L]),w=n?j:k,le=i||(n?K:A),F=m??(n?ce:q),{data:D=[]}=J({queryKey:["flex-work-orders-by-job",t,s],queryFn:async()=>{let e=v.from("flex_work_orders").select("technician_id, lpo_number, flex_element_id").eq("job_id",t);s&&(e=e.eq("technician_id",s));const{data:o,error:d}=await e;if(d)throw d;return o||[]},enabled:!!t,staleTime:3e4}),C=f.useMemo(()=>new Map(D.map(e=>[e.technician_id,e.lpo_number||null])),[D]),de=f.useMemo(()=>new Map(D.map(e=>[e.technician_id,e.flex_element_id||null])),[D]),ue="https://sectorpro.flexrentalsolutions.com/f5/ui/?desktop",me="8238f39c-f42e-11e0-a8de-00e08175e43e",he=f.useCallback(e=>e?`${ue}#fin-doc/${encodeURIComponent(e)}/doc-view/${me}/detail`:null,[]),B=f.useMemo(()=>Array.from(new Set(w.map(e=>e.technician_id).filter(Boolean))),[w]),{data:W=[]}=J({queryKey:["profiles-for-job-payout",t,B],enabled:B.length>0,queryFn:async()=>{const{data:e,error:o}=await v.from("profiles").select("id, first_name, last_name, email, autonomo").in("id",B);if(o)throw o;return e||[]},staleTime:6e4}),y=W,z=f.useMemo(()=>new Map(y.map(e=>[e.id,e.autonomo??null])),[y]),M=f.useMemo(()=>new Map(y.map(e=>[e.id,e])),[y]),V=f.useCallback(e=>{const o=M.get(e);return o&&`${o.first_name??""} ${o.last_name??""}`.trim()||e},[M]);a!=null&&a.rates_approved;const[we,X]=f.useState(!1),[Ne,Y]=f.useState(!1),[Ee,_e]=f.useState({}),[$e,H]=f.useState([]),Z=f.useRef(null),{userRole:ke}=Ze(),Re=ke==="admin"||ke==="management",{data:$=[]}=vr(t),fe=br(),pe=gr(),Ce=lr(),[Le,xe]=f.useState(null),[be,I]=f.useState("");f.useEffect(()=>{H([]),Z.current=null},[t,n]);const ze=f.useMemo(()=>w.reduce((e,o)=>{const d=$.find(P=>P.technician_id===o.technician_id);let c=0;z.get(o.technician_id)===!1&&!d&&(n?c=oe:c=(U.get(o.technician_id)||(o.timesheets_total_eur>0?1:0))*oe);const b=((d==null?void 0:d.override_amount_eur)??o.total_eur)-(d?0:c);return e+b},0),[w,$,z,n,U]),ee=f.useCallback(e=>$.find(o=>o.technician_id===e),[$]),Qe=f.useCallback((e,o)=>{xe(e);const d=ee(e);I(((d==null?void 0:d.override_amount_eur)??o).toString())},[ee]),Je=f.useCallback((e,o,d)=>{const c=parseFloat(be);if(isNaN(c)||c<0||!Number.isFinite(c)||c>9999999999e-2){u.error("El monto debe ser un número válido entre 0 y 99.999.999,99");return}fe.mutate({jobId:t,technicianId:e,amountEur:c,calculatedTotal:d,technicianName:o},{onSuccess:()=>{xe(null),I("")}})},[t,be,fe]),Ke=f.useCallback(e=>{pe.mutate({jobId:t,technicianId:e,technicianName:V(e)})},[t,pe,V]),Ue=f.useCallback(()=>{xe(null),I("")},[]),Te=f.useCallback(async e=>{const o=await Be({jobId:t,supabase:v,payouts:e,profiles:y,lpoMap:C,jobDetails:a||void 0});return Z.current=o,H(o.missingEmails),o},[t,y,C,a]),He=f.useCallback(async()=>{if(t){if(n){if(h.length===0||!a)return;X(!0);try{await tr(h,{id:a.id,title:a.title,start_time:a.start_time,tour_id:a.tour_id??void 0,job_type:a.job_type??void 0},y,C),u.success("PDF de tarifas generado")}catch{u.error("No se pudo generar el PDF de pagos de gira")}finally{X(!1)}return}if(k.length!==0){X(!0);try{const e=await Te(k);await De(e.payouts,e.job,e.profiles,e.lpoMap??C,e.timesheetMap),u.success("PDF de pagos generado")}catch{u.error("No se pudo generar el PDF de pagos")}finally{X(!1)}}}},[t,n,h,a,y,C,k,Te]),Ge=f.useCallback(async()=>{var o,d;if(!t)return;if(n){if(h.length===0)return;Y(!0);try{const c=await Se({jobId:t,supabase:v,quotes:h,profiles:y,technicianIds:s?[s]:void 0});if(H(c.context.missingEmails),c.error)u.error("No se pudieron enviar los correos de pagos");else{const _=Array.isArray((o=c.response)==null?void 0:o.results)?c.response.results.some(b=>!b.sent):!1;c.success&&!_?u.success("Pagos enviados por correo"):u.warning("Algunos correos no se pudieron enviar. Revisa el registro."),c.missingEmails.length&&u.warning("Hay técnicos sin correo configurado.")}}catch{u.error("Se produjo un error al enviar los correos de pagos")}finally{Y(!1)}return}const e=k.filter(c=>c.payout_approved);if(e.length===0){u.warning("No hay técnicos aprobados para enviar correos.");return}Y(!0);try{const c=await Fe({jobId:t,supabase:v,payouts:e,profiles:y,lpoMap:C,jobDetails:a||void 0,existingContext:Z.current??void 0});if(Z.current=c.context,H(c.context.missingEmails),c.error){u.error("No se pudieron enviar los correos de pagos");return}const _=Array.isArray((d=c.response)==null?void 0:d.results)?c.response.results.some(b=>!b.sent):!1;c.success&&!_?u.success("Pagos enviados por correo"):u.warning("Algunos correos no se pudieron enviar. Revisa el registro."),c.missingEmails.length&&u.warning("Hay técnicos sin correo configurado.")}catch{u.error("Se produjo un error al enviar los correos de pagos")}finally{Y(!1)}},[t,n,h,v,y,s,k,C,a]),We=f.useCallback(async(e,o)=>{var c,_,b,P;if(!t)return;if(!n&&!o){u.warning("Debes aprobar el pago de este técnico antes de enviar el correo.");return}if(!!!((c=M.get(e))!=null&&c.email)){u.warning("Este técnico no tiene correo configurado.");return}if(_e(g=>({...g,[e]:!0})),n){try{const g=h.filter(x=>x.technician_id===e);if(g.length===0){u.warning("No hay tarifas disponibles para este técnico.");return}const N=await Se({jobId:t,supabase:v,quotes:g,profiles:y,technicianIds:[e]});if(H(N.context.missingEmails),N.error)u.error("No se pudo enviar el correo a este técnico");else{const x=Array.isArray((_=N.response)==null?void 0:_.results)?N.response.results.find(E=>E.technician_id===e):{sent:N.success};x!=null&&x.sent?u.success("Correo enviado a este técnico"):u.warning("No se pudo enviar el correo a este técnico")}}catch{u.error("Se produjo un error al enviar el correo")}finally{_e(g=>({...g,[e]:!1}))}return}try{const g=await Fe({jobId:t,supabase:v,payouts:k.filter(N=>N.technician_id===e),profiles:y.filter(N=>N.id===e),lpoMap:C,jobDetails:a||void 0});if(g.error)u.error("No se pudo enviar el correo a este técnico");else{const N=Array.isArray((b=g.response)==null?void 0:b.results)?(P=g.response.results.find(x=>x.technician_id===e))==null?void 0:P.sent:!0;g.success&&N?u.success("Correo enviado a este técnico"):u.warning("No se pudo enviar el correo a este técnico")}}catch{u.error("Se produjo un error al enviar el correo")}finally{_e(g=>({...g,[e]:!1}))}},[t,n,M,h,v,y,k,C,a]);return le?r.jsxs(re,{className:`${ie} w-full`,children:[r.jsx(te,{children:r.jsxs(ae,{className:"flex items-center gap-2 text-lg",children:[r.jsx(ne,{className:"h-5 w-5"}),"Pagos del trabajo"]})}),r.jsx(se,{children:r.jsx("div",{className:Oe,children:"Cargando información de pagos..."})})]}):F?r.jsxs(re,{className:`${ie} w-full`,children:[r.jsx(te,{children:r.jsxs(ae,{className:"flex items-center gap-2 text-lg",children:[r.jsx(ne,{className:"h-5 w-5"}),"Pagos del trabajo"]})}),r.jsxs(se,{children:[r.jsx("div",{className:"text-red-400",children:"Error al cargar los pagos"}),F&&r.jsx("div",{className:"text-xs text-red-300 mt-2 font-mono whitespace-pre-wrap",children:F instanceof Error?F.message:JSON.stringify(F,null,2)})]})]}):w.length===0?r.jsxs(re,{className:`${ie} w-full`,children:[r.jsx(te,{children:r.jsxs(ae,{className:"flex items-center gap-2 text-lg",children:[r.jsx(ne,{className:"h-5 w-5"}),"Pagos del trabajo"]})}),r.jsx(se,{children:r.jsx("div",{className:Oe,children:"No hay información de pagos para este trabajo."})})]}):r.jsxs(re,{className:`${ie} w-full`,children:[r.jsx(te,{children:r.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[r.jsxs(ae,{className:"flex items-center gap-2 text-lg",children:[r.jsx(ne,{className:"h-5 w-5"}),"Pagos del trabajo"]}),r.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[r.jsxs(O,{variant:"outline",size:"sm",onClick:He,disabled:we||w.length===0,className:qe,children:[r.jsx(nr,{className:"h-4 w-4 mr-1"}),we?"Generando…":"Exportar PDF"]}),r.jsxs(O,{size:"sm",onClick:Ge,disabled:Ne||w.length===0,variant:"default",className:"bg-blue-600 hover:bg-blue-500 text-white",children:[r.jsx(Me,{className:"h-4 w-4 mr-1"}),Ne?"Enviando…":"Enviar aprobados"]})]})]})}),r.jsxs(se,{className:"space-y-4 w-full overflow-hidden",children:[w.map(e=>{var o,d,c,_,b,P,g,N;return r.jsxs("div",{className:Ie("border rounded-lg p-4 space-y-3 transition-colors w-full min-w-0",yr,(!((o=M.get(e.technician_id))!=null&&o.email)||$e.includes(e.technician_id))&&"border-amber-400/70 bg-amber-500/10"),children:[r.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start justify-between gap-3",children:[r.jsxs("div",{className:"min-w-0 space-y-1",children:[r.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[r.jsx("h4",{className:"font-medium text-base",children:V(e.technician_id)}),(()=>{const x=ar(z.get(e.technician_id));return x?r.jsxs(Q,{variant:"destructive",className:"flex items-center gap-1 text-xs",children:[r.jsx(Pe,{className:"h-3 w-3"}),x]}):null})()]}),r.jsxs("div",{className:"flex flex-col gap-1 text-xs text-foreground/70 dark:text-muted-foreground break-words",children:[r.jsxs("span",{children:["Trabajo: ",e.job_id]}),r.jsxs("span",{children:["Correo:"," ",(d=M.get(e.technician_id))!=null&&d.email?(c=M.get(e.technician_id))==null?void 0:c.email:r.jsx("span",{className:"text-amber-700 dark:text-amber-300 font-medium",children:"Sin correo configurado"})]})]}),!((_=M.get(e.technician_id))!=null&&_.email)&&r.jsx(Q,{variant:"outline",className:"mt-2 text-amber-600 border-amber-500/40 bg-amber-500/10 dark:text-amber-300",children:"Sin correo"}),C.has(e.technician_id)&&r.jsxs("div",{className:"text-xs text-muted-foreground flex items-center gap-2",children:[r.jsxs("span",{children:["LPO Nº: ",C.get(e.technician_id)||"—"]}),(()=>{const x=de.get(e.technician_id)||null,E=he(x);return E?r.jsxs("a",{href:E,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center text-primary hover:underline",title:"Abrir en Flex",children:[r.jsx(ir,{className:"h-3 w-3 mr-1"})," Abrir en Flex"]}):null})()]})]}),r.jsxs("div",{className:"text-right flex flex-col items-end gap-2 sm:min-w-[140px]",children:[!n&&r.jsxs("div",{className:"flex items-center gap-2 mb-1 bg-muted p-1.5 rounded-md border border-border",children:[r.jsx("label",{htmlFor:`approve-${e.technician_id}`,className:"text-xs text-muted-foreground cursor-pointer select-none",children:e.payout_approved?"Aprobado":"Pendiente"}),r.jsx(sr,{id:`approve-${e.technician_id}`,checked:!!e.payout_approved,onCheckedChange:x=>Ce.mutate({jobId:t,technicianId:e.technician_id,approved:x}),disabled:Ce.isPending})]}),r.jsx("div",{className:"text-xl font-bold leading-tight",children:(()=>{const x=z.get(e.technician_id)===!1;let E=0,G=0;x&&(n?E=oe:(G=U.get(e.technician_id)||(e.timesheets_total_eur>0?1:0),E=G*oe));const Ve=e.total_eur-E;return r.jsxs("div",{className:"flex flex-col items-end",children:[r.jsx("span",{children:T(Ve)}),E>0&&r.jsxs("span",{className:"text-[10px] text-red-400 font-normal",children:["(-",T(E)," IRPF por alta obligatoria)"]})]})})()}),r.jsxs(O,{variant:"outline",size:"sm",onClick:()=>We(e.technician_id,e.payout_approved),disabled:Ee[e.technician_id]||!n&&!e.payout_approved||!((b=M.get(e.technician_id))!=null&&b.email),title:!n&&!e.payout_approved?"Aprueba el pago para habilitar el envío":(P=M.get(e.technician_id))!=null&&P.email?"Enviar sólo a este técnico":"Sin correo configurado",className:qe,children:[r.jsx(Me,{className:"h-3.5 w-3.5 mr-1"}),Ee[e.technician_id]?"Enviando…":"Enviar a este"]})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center justify-between text-sm",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(or,{className:"h-4 w-4 text-muted-foreground"}),r.jsx("span",{children:"Partes aprobados:"})]}),r.jsx(Q,{variant:e.timesheets_total_eur>0?"default":"secondary",children:T(e.timesheets_total_eur)})]}),e.extras_total_eur>0&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"flex items-center justify-between text-sm",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(cr,{className:"h-4 w-4 text-muted-foreground"}),r.jsx("span",{children:"Extras del trabajo:"})]}),r.jsx(Q,{variant:"outline",children:T(e.extras_total_eur)})]}),((g=e.extras_breakdown)==null?void 0:g.items)&&e.extras_breakdown.items.length>0&&r.jsx("div",{className:"ml-6 space-y-1",children:e.extras_breakdown.items.map((x,E)=>r.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[r.jsxs("span",{children:[x.extra_type.replace("_"," ")," × ",x.quantity]}),r.jsx("span",{children:T(x.amount_eur)})]},E))})]})]}),e.vehicle_disclaimer&&e.vehicle_disclaimer_text&&r.jsxs(r.Fragment,{children:[r.jsx(ge,{className:"border-border"}),r.jsxs("div",{className:"flex items-start gap-2 text-sm text-yellow-800 bg-yellow-500/10 p-3 rounded border border-yellow-500/30 dark:text-amber-200 dark:bg-amber-500/10 dark:border-amber-500/30 w-full",children:[r.jsx(Pe,{className:"h-4 w-4 mt-0.5 shrink-0 text-yellow-600 dark:text-amber-300"}),r.jsx("span",{className:"break-words whitespace-pre-wrap leading-snug w-full",children:e.vehicle_disclaimer_text.includes("Fuel/drive compensation")?"Puede aplicarse compensación de combustible/conducción al usar vehículo propio. Coordina con RR. HH. por cada trabajo.":e.vehicle_disclaimer_text})]})]}),r.jsx(ge,{className:"border-border"}),Re&&(()=>{const x=ee(e.technician_id),E=Le===e.technician_id,G=V(e.technician_id);return r.jsx(jr,{override:x,isEditing:E,techName:G,calculatedTotalEur:e.total_eur,editingAmount:be,onEditingAmountChange:I,onStartEdit:()=>Qe(e.technician_id,e.total_eur),onSave:()=>Je(e.technician_id,G,e.total_eur),onCancel:Ue,onRemove:()=>Ke(e.technician_id),isSaving:fe.isPending,isRemoving:pe.isPending})})(),r.jsx(ge,{className:"border-border"}),r.jsxs("div",{className:"flex items-center justify-between font-medium",children:[r.jsx("span",{children:"Total final:"}),r.jsx(Q,{variant:"default",className:"text-base px-3 py-1",children:T(((N=ee(e.technician_id))==null?void 0:N.override_amount_eur)??e.total_eur)})]})]},e.technician_id)}),w.length>1&&r.jsxs("div",{className:"mt-6 p-4 bg-muted/50 rounded-lg border border-border",children:[r.jsxs("div",{className:"flex justify-between items-center text-lg font-bold",children:[r.jsx("span",{children:"Total global del trabajo:"}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{className:"text-blue-600 dark:text-blue-300",children:T(ze)}),$.length>0&&r.jsxs(Q,{variant:"outline",className:"text-amber-700 border-amber-500/30 bg-amber-500/10 dark:text-amber-300 dark:border-amber-500/40 dark:bg-amber-500/10",children:[$.length," override",$.length>1?"s":""]})]})]}),r.jsxs("div",{className:"text-sm text-foreground/70 dark:text-muted-foreground mt-2 space-y-1",children:[r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Total partes:"}),r.jsx("span",{children:T(w.reduce((e,o)=>e+o.timesheets_total_eur,0))})]}),r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Total extras:"}),r.jsx("span",{children:T(w.reduce((e,o)=>e+o.extras_total_eur,0))})]})]})]})]})]})}export{Rr as J,Fe as s,lr as u};
