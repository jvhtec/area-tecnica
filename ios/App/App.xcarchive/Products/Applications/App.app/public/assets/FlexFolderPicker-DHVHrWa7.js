import{l as G,r as f,j as e,D as B,q as H,F as q,G as U,B as _,a as W,R as J,s as $,aK as Q,L as S,I as w,aL as Y}from"./index-NZ6jJLfQ.js";import{B as ee}from"./badge-vNTKF5RD.js";import{S as se}from"./scroll-area-BHjMXddA.js";import{C as z}from"./checkbox-BsRNEGV1.js";import{a as V,g as K,s as te,b as ae}from"./folders-Scoqgw4s.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=G("Archive",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=G("RotateCw",[["path",{d:"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8",key:"1p45f6"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=G("Scale",[["path",{d:"m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z",key:"7g6ntu"}],["path",{d:"m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z",key:"ijws7r"}],["path",{d:"M7 21h10",key:"1b0cd5"}],["path",{d:"M12 3v18",key:"108xh3"}],["path",{d:"M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2",key:"3gwbw2"}]]),fe=({jobId:a,open:r,onOpenChange:x})=>{const[d,h]=f.useState(!1),[u,c]=f.useState([]),[b,j]=f.useState([]),k=f.useMemo(()=>u.map(i=>i.id),[u]),y=async()=>{h(!0);try{const{data:i,error:v}=await $.from("flex_folders").select("id, parent_id, current_status").eq("job_id",a);if(v||c(i||[]),i&&i.length){const{data:p,error:N}=await $.from("flex_status_log").select("id, folder_id, previous_status, new_status, action_type, processed_by, processed_at, success, flex_response, error").in("folder_id",i.map(s=>s.id)).order("processed_at",{ascending:!1}).limit(200);N||j(p||[])}else j([])}catch{}finally{h(!1)}};return f.useEffect(()=>{r&&y()},[r,a]),e.jsx(B,{open:r,onOpenChange:x,children:e.jsxs(H,{className:"w-[95vw] max-w-3xl max-h-[90vh] flex flex-col overflow-hidden",children:[e.jsx(q,{className:"flex-shrink-0",children:e.jsx(U,{className:"text-base md:text-lg",children:"Flex Sync Logs"})}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2 flex-shrink-0",children:[e.jsxs("div",{className:"text-xs md:text-sm text-muted-foreground",children:[k.length," folder(s) • ",b.length," entries"]}),e.jsxs(_,{variant:"ghost",size:"sm",onClick:y,disabled:d,className:"gap-2 w-full sm:w-auto",children:[d?e.jsx(W,{className:"h-4 w-4 animate-spin"}):e.jsx(J,{className:"h-4 w-4"}),"Refresh"]})]}),e.jsx(se,{className:"flex-1 pr-2",children:d?e.jsx("div",{className:"flex items-center justify-center h-40 text-xs md:text-sm text-muted-foreground",children:"Loading..."}):b.length===0?e.jsx("div",{className:"text-xs md:text-sm text-muted-foreground",children:"No logs yet for this job."}):e.jsx("div",{className:"space-y-2",children:b.map(i=>{const v=(()=>{const p=i.flex_response;if(p&&typeof p=="object")try{const N=p.primaryMessage||p.message||p.error||"";return String(N)}catch{}return""})();return e.jsxs("div",{className:"border rounded p-2 md:p-3 text-xs md:text-sm",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(ee,{variant:i.success?"default":"destructive",className:"text-xs",children:i.success?"OK":"FAIL"}),e.jsxs("span",{className:"font-medium text-xs md:text-sm",children:[i.previous_status||"—"," → ",i.new_status]})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:new Date(i.processed_at).toLocaleString()})]}),v&&e.jsx("div",{className:"mt-2 text-muted-foreground break-words",children:v}),i.error&&e.jsx("div",{className:"mt-2 text-red-500 break-words",children:i.error})]},i.id)})})})]})})},R={sound:{label:"Sonido",items:[{key:"documentacionTecnica",label:"Documentación Técnica"},{key:"presupuestosRecibidos",label:"Presupuestos Recibidos"},{key:"hojaGastos",label:"Hoja de Gastos"},{key:"pullSheetTP",label:"Pull Sheet Tour Pack"},{key:"pullSheetPA",label:"Pull Sheet PA"}]},lights:{label:"Luces",items:[{key:"documentacionTecnica",label:"Documentación Técnica"},{key:"presupuestosRecibidos",label:"Presupuestos Recibidos"},{key:"hojaGastos",label:"Hoja de Gastos"}]},video:{label:"Video",items:[{key:"documentacionTecnica",label:"Documentación Técnica"},{key:"presupuestosRecibidos",label:"Presupuestos Recibidos"},{key:"hojaGastos",label:"Hoja de Gastos"}]},production:{label:"Producción",items:[{key:"documentacionTecnica",label:"Documentación Técnica"},{key:"presupuestosRecibidos",label:"Presupuestos Recibidos"},{key:"hojaGastos",label:"Hoja de Gastos"}]},personnel:{label:"Personal",items:[{key:"workOrder",label:"Orden de Trabajo"},{key:"gastosDePersonal",label:"Gastos de Personal"},{key:"crewCallSound",label:"Crew Call Sonido"},{key:"crewCallLights",label:"Crew Call Luces"}]},comercial:{label:"Comercial",items:[{key:"extrasSound",label:"Extras Sonido",description:"Genera la carpeta de extras para el equipo de sonido."},{key:"extrasLights",label:"Extras Luces",description:"Genera la carpeta de extras para el equipo de luces."},{key:"presupuestoSound",label:"Presupuesto Sonido",description:"Crea el presupuesto principal para sonido usando el nombre del departamento/fecha en lugar de Comercial."},{key:"presupuestoLights",label:"Presupuesto Luces",description:"Crea el presupuesto principal para luces usando el nombre del departamento/fecha en lugar de Comercial."}]}},re={sound:[],lights:[],video:[],production:[],personnel:[],comercial:[]},X=Object.entries(R),L=a=>{var r;return((r=R[a])==null?void 0:r.items.length)>0},I=(a,r)=>{var d;const x=((d=R[a])==null?void 0:d.items.map(h=>h.key))??[];return[...r].sort((h,u)=>{const c=x.indexOf(h),b=x.indexOf(u),j=c===-1?Number.MAX_SAFE_INTEGER:c,k=b===-1?Number.MAX_SAFE_INTEGER:b;return j-k})},le=["sound","lights","video"],oe=new Set(le),Z=a=>I(a,[...re[a]]),T=(a,r)=>{const x=V(r)??{},u=(x.subfolders!==void 0?x.subfolders:Z(a)).filter(b=>R[a].items.some(j=>j.key===b)),c=I(a,u);return{...x,subfolders:c}},M=()=>{const a={};for(const[r]of X)L(r)&&(a[r]={subfolders:Z(r)});return a},O=a=>{const r=M();if(!a)return r;const x={...r};for(const[d,h]of Object.entries(a))!L(d)||!h||(x[d]=T(d,h));return x},ne=a=>{var h;const r=M(),x={};let d=!1;for(const[u,c]of Object.entries(a)){if(!L(u))continue;const b=T(u,c),j=r[u],k=(j==null?void 0:j.subfolders)??[],{keys:y}=K(b),i=y.length!==k.length||y.some((n,t)=>n!==k[t]),v=te(b.customPullsheet),p=ae(b.extrasPresupuesto),N=y.includes("extrasSound")||y.includes("extrasLights"),s=!!(p&&((((h=p.entries)==null?void 0:h.length)??0)>0||p.startDate||p.endDate)),m=N||s;(i||v||m&&p)&&(x[u]={subfolders:y,...v?{customPullsheet:v}:{},...m&&p?{extrasPresupuesto:p}:{}},d=!0)}if(!d){const u={};for(const[c]of Object.entries(a))L(c)&&(u[c]={subfolders:[]});return u}return x};function be({open:a,onOpenChange:r,onConfirm:x,initialOptions:d}){const[h,u]=f.useState(()=>O(d));f.useEffect(()=>{a&&u(O(d))},[a,d]);const c=f.useCallback((s,m)=>{u(n=>{const t=n[s],g=T(s,t),l=m(g);return{...n,[s]:l}})},[]),b=f.useCallback((s,m,n)=>{c(s,t=>{const g=new Set(t.subfolders);return n?g.add(m):g.delete(m),{...t,subfolders:I(s,Array.from(g))}})},[c]),j=f.useCallback((s,m)=>{c(s,n=>{const t=n.customPullsheet;return m?{...n,customPullsheet:{enabled:!0,name:(t==null?void 0:t.name)??"",startDate:t==null?void 0:t.startDate,endDate:t==null?void 0:t.endDate}}:t?{...n,customPullsheet:{...t,enabled:!1}}:{...n}})},[c]),k=f.useCallback((s,m,n)=>{c(s,t=>{const g=t.customPullsheet??{enabled:!0,name:"",startDate:void 0,endDate:void 0},l=m==="name"?n:n||void 0;return{...t,customPullsheet:{...g,enabled:!0,[m]:l}}})},[c]),y=f.useCallback((s,m)=>{c("comercial",n=>{var E,D,o,C;const t=V(n)??{},g=m||void 0,l={...t.extrasPresupuesto??{},[s]:g},P=(((D=(E=t.extrasPresupuesto)==null?void 0:E.entries)==null?void 0:D.length)??0)>0;if(P&&(l.entries=(C=(o=t.extrasPresupuesto)==null?void 0:o.entries)==null?void 0:C.map(F=>({...F}))),!l.startDate&&!l.endDate&&!P){const{extrasPresupuesto:F,...A}=t;return A}return{...t,extrasPresupuesto:l}})},[c]),i=f.useCallback(()=>{u(M())},[]),v=f.useCallback(()=>{r(!1)},[r]),p=f.useCallback(()=>{x(ne(h)),r(!1)},[x,r,h]),N=X.filter(([,s])=>s.items.length>0);return e.jsx(B,{open:a,onOpenChange:r,children:e.jsxs(H,{className:"flex max-h-[85vh] w-full max-w-2xl flex-col gap-0",children:[e.jsxs(q,{className:"flex-shrink-0",children:[e.jsx(U,{children:"Seleccionar estructura de Flex"}),e.jsx(Q,{children:"Marca las carpetas y elementos que deseas crear en Flex."})]}),e.jsxs("div",{className:"flex flex-shrink-0 items-center justify-between border-b pb-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Usa las casillas para personalizar cada departamento."}),e.jsx(_,{variant:"ghost",size:"sm",onClick:i,children:"Usar preset"})]}),e.jsx("div",{className:"mt-4 grid max-h-[50vh] flex-1 gap-6 overflow-y-auto pr-2",children:N.map(([s,m])=>{const n=T(s,h[s]),{keys:t}=K(n),g=oe.has(s),l=n.customPullsheet,P=g&&((l==null?void 0:l.enabled)??!1),E=s==="comercial"&&(t.includes("extrasSound")||t.includes("extrasLights")),D=n.extrasPresupuesto??{};return e.jsxs("section",{className:"space-y-3",children:[e.jsx("header",{children:e.jsx("h3",{className:"text-sm font-semibold uppercase tracking-wide text-muted-foreground",children:m.label})}),e.jsx("div",{className:"grid gap-2 sm:grid-cols-2",children:m.items.map(o=>{const C=`${s}-${o.key}`,F=t.includes(o.key);return e.jsxs("div",{className:"flex items-start gap-3 rounded-md border p-3",children:[e.jsx(z,{id:C,checked:F,onCheckedChange:A=>b(s,o.key,A===!0)}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(S,{htmlFor:C,className:"text-sm font-medium",children:o.label}),o.description?e.jsx("p",{className:"text-xs text-muted-foreground",children:o.description}):null]})]},o.key)})}),g?e.jsxs("div",{className:"rounded-md border p-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{id:`${s}-custom-pullsheet`,checked:(l==null?void 0:l.enabled)??!1,onCheckedChange:o=>j(s,o===!0)}),e.jsx(S,{htmlFor:`${s}-custom-pullsheet`,className:"text-sm font-medium",children:"Pull sheet personalizado"})]}),P?e.jsxs("div",{className:"mt-3 grid gap-3 sm:grid-cols-2",children:[e.jsxs("div",{className:"sm:col-span-2 space-y-1",children:[e.jsx(S,{htmlFor:`${s}-custom-pullsheet-name`,children:"Nombre"}),e.jsx(w,{id:`${s}-custom-pullsheet-name`,value:(l==null?void 0:l.name)??"",placeholder:"Nombre del pull sheet",onChange:o=>k(s,"name",o.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(S,{htmlFor:`${s}-custom-pullsheet-start`,children:"Fecha de inicio"}),e.jsx(w,{id:`${s}-custom-pullsheet-start`,type:"date",value:(l==null?void 0:l.startDate)??"",onChange:o=>k(s,"startDate",o.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(S,{htmlFor:`${s}-custom-pullsheet-end`,children:"Fecha de fin"}),e.jsx(w,{id:`${s}-custom-pullsheet-end`,type:"date",value:(l==null?void 0:l.endDate)??"",onChange:o=>k(s,"endDate",o.target.value)})]})]}):null]}):null,s==="comercial"&&E?e.jsxs("div",{className:"rounded-md border p-3",children:[e.jsx("h4",{className:"text-sm font-semibold",children:"Extras Presupuesto"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Define fechas específicas para los presupuestos de extras."}),e.jsxs("div",{className:"mt-3 grid gap-3 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(S,{htmlFor:"extras-presupuesto-start",children:"Fecha de inicio"}),e.jsx(w,{id:"extras-presupuesto-start",type:"date",value:D.startDate??"",onChange:o=>y("startDate",o.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(S,{htmlFor:"extras-presupuesto-end",children:"Fecha de fin"}),e.jsx(w,{id:"extras-presupuesto-end",type:"date",value:D.endDate??"",onChange:o=>y("endDate",o.target.value)})]})]})]}):null]},s)})}),e.jsxs(Y,{className:"mt-4 flex-shrink-0 gap-2 border-t pt-4",children:[e.jsx(_,{variant:"outline",onClick:v,children:"Cancelar"}),e.jsx(_,{onClick:p,children:"Crear"})]})]})})}export{xe as A,fe as F,he as R,pe as S,be as a};
