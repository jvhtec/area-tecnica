import{r as l,e as L,s as c}from"./index-NZ6jJLfQ.js";const k=()=>{const[r,u]=l.useState(null),[E,h]=l.useState(!0),{toast:f}=L(),w=async a=>{var n;try{const{data:{session:e}}=await c.auth.getSession();if(!((n=e==null?void 0:e.user)!=null&&n.id))return;const{error:i}=await c.from("profiles").update({...a,last_activity:new Date().toISOString()}).eq("id",e.user.id);if(i)throw i;u(t=>t?{...t,...a}:null)}catch{f({title:"Error",description:"Failed to update preferences",variant:"destructive"})}},_=async()=>{if(!(r!=null&&r.last_activity))return;const a=new Date(r.last_activity);(new Date().getTime()-a.getTime())/(1e3*60*60)>=8&&(await c.auth.signOut(),f({title:"Session Expired",description:"You have been logged out due to inactivity"}),window.location.href="/auth")};return l.useEffect(()=>{(async()=>{var s;try{const{data:{session:o}}=await c.auth.getSession();if(!((s=o==null?void 0:o.user)!=null&&s.id))return;const{data:d,error:y}=await c.from("profiles").select("dark_mode, time_span, last_activity, custom_folder_structure, custom_tour_folder_structure").eq("id",o.user.id).maybeSingle();if(y)throw y;d&&(u(d),d.dark_mode?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"))}catch{}finally{h(!1)}})();let n=0;const e=900*1e3;let i=!0;const t=()=>{if(!i)return;const s=Date.now();s-n>=e&&(n=s,w({last_activity:new Date().toISOString()}))},v=()=>{i=!0},m=()=>{i=!1},p=setInterval(_,6e4);return window.addEventListener("click",t),window.addEventListener("keydown",t),window.addEventListener("online",v),window.addEventListener("offline",m),()=>{clearInterval(p),window.removeEventListener("click",t),window.removeEventListener("keydown",t),window.removeEventListener("online",v),window.removeEventListener("offline",m)}},[]),{preferences:r,isLoading:E,updatePreferences:w}};export{k as u};
