import{l as At,e as pt,f as xt,r as b,i as x,s as ie,c as ss,u as as,d as Lt,j as e,C as Jt,Q as ft,B as C,a as _t,V as rs,D as gt,q as yt,F as jt,G as vt,L as Be,k as Ye,A as ns,P as ct,a2 as os,U as kt,T as is,J as ls,K as cs,O as ds,aB as Tt,M as ms,aC as Ft}from"./index-NZ6jJLfQ.js";import{B as We}from"./badge-vNTKF5RD.js";import{D as dt,a as mt,b as ht,c as oe,d as at,e as St}from"./dropdown-menu-Dn1SMjj1.js";import{P as hs,a as us,b as ps}from"./popover-Dl-b1R8L.js";import{C as xs}from"./calendar--BDVgnXu.js";import{u as fs,D as qt}from"./DateTypeContextMenu-D-zx4rHd.js";import{u as gs,a as ys,b as js,S as vs,L as ws,V as bs}from"./VideoTaskDialog-jFo9WRqF.js";import{d as Cs}from"./optimisticJobDeletionService-Bq-53fU4.js";import{c as Ns,J as Ds}from"./folders-Scoqgw4s.js";import{c as Ms,s as rt}from"./folderNameSanitizer-DNdk00QU.js";import{E as _s}from"./EditJobDialog-DRKRzgWP.js";import{J as ks}from"./JobDetailsDialog-Cah6wZTf.js";import{o as Ts}from"./flexUuidService-C9yZjzP-.js";import{E as Fs}from"./ellipsis-vertical-zRAfIP3L.js";import{C as ut}from"./calendar-_Cj_Sgy-.js";import{F as Et}from"./file-text-igU140SQ.js";import{U as $t}from"./users-DMnpVLUq.js";import{C as Wt}from"./clock-BXPvTWvY.js";import{S as Ut}from"./star-icpn3ybK.js";import{F as Ss}from"./folder-plus-DTUhlRcm.js";import{H as Es}from"./hard-drive-DZn0Cm3i.js";import{S as Os}from"./square-pen-BMpSgZGa.js";import{E as Ps}from"./external-link-QJoXZ6ES.js";import{C as Vt}from"./checkbox-BsRNEGV1.js";import{P as Fe}from"./printer-De77t3j8.js";import{a as zs}from"./useMobileRealtimeSubscriptions-CkyUxSWV.js";import{u as Rt}from"./useQuery-kdg2pmgf.js";import{C as Qt}from"./chevron-left-rq2ui83a.js";import{i as Is}from"./isToday-BbpdYtC3.js";import{T as Hs}from"./target-kNjpphh3.js";import{C as Yt}from"./chevron-right-Bn7Eu0F7.js";import{F as Ot}from"./filter-D0HnK7Nz.js";import{s as As}from"./subDays-D4REtaCB.js";import{a as Ls,s as qe}from"./startOfMonth-B5dVCv8B.js";import{i as $e}from"./isSameMonth-BQ4F6s8O.js";import{M as Js}from"./mic-l4q2dREA.js";import{M as qs}from"./moon-Bp9lP4EQ.js";import{W as $s}from"./wrench-DzMvZxmF.js";import{P as Ws}from"./plane-NSG-_bNT.js";import{V as Us}from"./video-BcyQPYgx.js";import{L as Vs}from"./lightbulb-BU2ctenD.js";import{M as Rs}from"./music-2-DRJ2zGwb.js";import{T as nt,l as Qs}from"./lazyXlsx-BrFBF17_.js";import{l as Ys}from"./lazyPdf-xVUlxKNu.js";import{e as ot}from"./eachDayOfInterval-CPmiA2bk.js";import{e as Pt}from"./endOfYear-D08D-xBX.js";import{s as zt,e as It,a as Ht}from"./endOfQuarter-BH4-YKz9.js";import{e as Oe}from"./endOfMonth-Byhxb84j.js";import{a as Qe}from"./addMonths-j-Bb577B.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./index-D9TsP8oP.js";import"./index-hC3MxXep.js";import"./circle-CWxDyDxx.js";import"./isSameDay-m1OvdnsV.js";import"./differenceInCalendarMonths-6exvViir.js";import"./endOfWeek-BYLwoWuZ.js";import"./context-menu-DYP7Nyzl.js";import"./useTableSubscription-Cu79jct8.js";import"./useJobRequiredRoles-Bz0ibKHS.js";import"./useMutation-DluhVBs1.js";import"./useWeatherData-d0TEdKFc.js";import"./weatherApi-BatwQpQy.js";import"./icon-D8sTZPYx.js";import"./progress-C8XsV-Me.js";import"./table-DnQAmABX.js";import"./download-C1rVE0-J.js";import"./upload-DF4rjO7T.js";import"./alert-dialog-CtyYUxwH.js";import"./useJobAssignmentsRealtime-7FZn5naq.js";import"./useRealtimeQuery-DRd58t-I.js";import"./technicianAvailability-gbYgVBKV.js";import"./roleCategory-BtQgWHfO.js";import"./api-C9EDenHJ.js";import"./config-DVV3VxR4.js";import"./constants-DoXhG9KB.js";import"./dryhireFolderService-Bb-tDpoa.js";import"./tabs-BdaywI_b.js";import"./useTourRateSubscriptions-Dd0aSU9f.js";import"./JobExtrasEditor-gQe73Sd8.js";import"./separator-E-JdTFOv.js";import"./ratesQueryKeys-DgMsgg6U.js";import"./euro-DgRTeGAz.js";import"./minus-InO4I9Ks.js";import"./plus-C3JQqq7t.js";import"./circle-alert-LZYNzZ7F.js";import"./useJobRatesApproval-DsfA8V9C.js";import"./switch-DUBpZhIC.js";import"./alert-BqA-5jRM.js";import"./JobPayoutTotalsPanel-BSlgp62i.js";import"./useJobPayoutTotals-CXAavZS-.js";import"./useManagerJobQuotes-BrI1iNRY.js";import"./tourRateMath-BOmIkfWO.js";import"./logoUtils-D2o1jUVg.js";import"./logo-url-cache-eY6nfvu7.js";import"./es-CSiFCUGj.js";import"./pen-D_H3YLSb.js";import"./file-down-Buu6FgvW.js";import"./send-Uvkx0r_O.js";import"./circle-check-big-CilmNGCn.js";import"./triangle-alert-D6qN0F8g.js";import"./JobExtrasManagement-CpH8R_KL.js";import"./receipt-CWKVL4Rh.js";import"./circle-check-C0N48OpO.js";import"./circle-x-DDzV-xk_.js";import"./eye-BE_DouVP.js";import"./pdfMerge-DXtLP7Xx.js";import"./pdf-libs-BqoGqu1a.js";import"./timesheet-pdf-82e1LStH.js";import"./truck-Br5sduv3.js";import"./avatar-QSp4LpEt.js";import"./places-restaurant-service-CakuSyx6.js";import"./utensils-crossed-CZeagqP3.js";import"./phone-BlFwiuho.js";import"./useSubscription-C3wu6ko-.js";import"./constructNow-u0VlpghF.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const it=At("FileSpreadsheet",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M8 13h2",key:"yr2amv"}],["path",{d:"M14 13h2",key:"un5t4a"}],["path",{d:"M8 17h2",key:"2yhykz"}],["path",{d:"M14 17h2",key:"10kma7"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bs=At("FileUp",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M12 12v6",key:"3ahymv"}],["path",{d:"m15 15-3-3-3 3",key:"15xj92"}]]),Ks=(t,p,c)=>{const{toast:i}=pt(),y=xt(),{addDeletingJob:l,removeDeletingJob:j,isDeletingJob:m}=gs(),[f,g]=b.useState(!1),[u,N]=b.useState(!1),n=m(t.id);return{handleDeleteClick:async z=>{if(z.stopPropagation(),!n){if(!["admin","management"].includes(p||"")){i({title:"Permission denied",description:"Only admin and management users can delete jobs",variant:"destructive"});return}if(window.confirm("Are you sure you want to delete this job? This action cannot be undone and will remove all related data."))try{l(t.id);const D=await Cs(t.id);if(D.success)i({title:"Job deleted",description:D.details||"The job has been removed and cleanup is running in background."}),c&&c(t.id),await y.invalidateQueries({queryKey:["jobs"]}),await y.invalidateQueries({queryKey:["optimized-jobs"]});else throw new Error(D.error||"Unknown deletion error")}catch(D){i({title:"Error deleting job",description:D.message,variant:"destructive"})}finally{j(t.id)}}},createFlexFoldersHandler:async z=>{if(z.stopPropagation(),!f)try{g(!0);const{data:D}=await ie.from("flex_folders").select("id").eq("job_id",t.id).limit(1);if(D&&D.length>0){i({title:"Folders already exist",description:"Flex folders have already been created for this job.",variant:"destructive"});return}const X=new Date(t.start_time).toISOString().slice(2,10).replace(/-/g,""),R=new Date(t.start_time).toISOString().split(".")[0]+".000Z",I=new Date(t.end_time).toISOString().split(".")[0]+".000Z";i({title:"Creating folders...",description:"Setting up Flex folder structure for this job."}),await Ns(t,R,I,X);const{error:le}=await ie.from("jobs").update({flex_folders_created:!0}).eq("id",t.id);try{ie.functions.invoke("push",{body:{action:"broadcast",type:"flex.folders.created",job_id:t.id}})}catch{}i({title:"Success!",description:"Flex folders have been created successfully."}),y.invalidateQueries({queryKey:["optimized-jobs"]}),y.invalidateQueries({queryKey:["jobs"]}),y.invalidateQueries({queryKey:["folder-existence"]})}catch(D){i({title:"Error",description:D.message||"Failed to create Flex folders",variant:"destructive"})}finally{g(!1)}},createLocalFoldersHandler:async z=>{if(z.stopPropagation(),!u){if(!("showDirectoryPicker"in window)){i({title:"Not supported",description:"Your browser doesn't support local folder creation. Please use Chrome, Edge, or another Chromium-based browser.",variant:"destructive"});return}try{N(!0);const D=await window.showDirectoryPicker(),xe=new Date(t.start_time),X=x(xe,"yyMMdd"),{name:R,wasSanitized:I}=Ms(t.title,X),le=await D.getDirectoryHandle(R,{create:!0}),{data:{user:ce}}=await ie.auth.getUser();let te=null;if(ce){const{data:k}=await ie.from("profiles").select("custom_folder_structure, role").eq("id",ce.id).single();k&&(k.role==="admin"||k.role==="management")&&k.custom_folder_structure&&(te=k.custom_folder_structure)}if(te||(te=["CAD","QT","Material","DocumentaciÃ³n","Rentals","Compras","Rider","Predicciones"]),Array.isArray(te)){for(const k of te)if(typeof k=="string"){const fe=rt(k);await(await le.getDirectoryHandle(fe,{create:!0})).getDirectoryHandle("OLD",{create:!0})}else if(k&&typeof k=="object"&&k.name){const fe=rt(k.name),de=await le.getDirectoryHandle(fe,{create:!0});if(k.subfolders&&Array.isArray(k.subfolders))for(const we of k.subfolders){const o=rt(we);await de.getDirectoryHandle(o,{create:!0})}else await de.getDirectoryHandle("OLD",{create:!0})}}i({title:"Success!",description:`${ce&&te!==null?"Custom":"Default"} folder structure created at "${R}"`})}catch(D){if(D.name==="AbortError")return;i({title:"Error",description:D.message||"Failed to create local folder structure",variant:"destructive"})}finally{N(!1)}}},isCreatingFolders:f,isCreatingLocalFolders:u,isJobBeingDeleted:n}},lt=[{value:"travel",label:"Travel",emoji:"âœˆï¸"},{value:"setup",label:"Setup",emoji:"ðŸ”§"},{value:"show",label:"Show",emoji:"ðŸŽ­"},{value:"off",label:"Off",emoji:"ðŸ˜´"},{value:"rehearsal",label:"Rehearsal",emoji:"ðŸŽµ"}];function Xs({job:t,department:p="sound",currentDate:c,dateTypes:i,onDateTypeChange:y,onEditClick:l,onDeleteClick:j,onJobClick:m}){var ze,Ne,O,_,S;const f=ss(),{toast:g}=pt(),u=xt(),{userRole:N}=as(),[n,P]=b.useState(!1),[Z,ee]=b.useState("show"),[z,D]=b.useState(!1),xe=Lt(),{uuid:X,isLoading:R,error:I,hasChecked:le,fetchFlexUuid:ce}=fs(),{appliedBorderColor:te,appliedBgColor:Pe,soundTaskDialogOpen:k,lightsTaskDialogOpen:fe,videoTaskDialogOpen:de,editJobDialogOpen:we,assignmentDialogOpen:o,isHouseTech:T,canEditJobs:_e,canManageArtists:ke,canUploadDocuments:be,canCreateFlexFolders:ge,handleEditButtonClick:Ce,handleFileUpload:He,setSoundTaskDialogOpen:Ke,setLightsTaskDialogOpen:Xe,setVideoTaskDialogOpen:Ge,setEditJobDialogOpen:Ze,setAssignmentDialogOpen:Ue}=ys(t,p,N,l,j,m,{enableRoleSummary:!1,enableSoundTasks:!1}),{handleDeleteClick:a,createFlexFoldersHandler:d,createLocalFoldersHandler:h,isCreatingFolders:s,isCreatingLocalFolders:v,isJobBeingDeleted:w}=Ks(t,N,j),{data:se,isLoading:G}=js(t.id,t.tour_date_id),me=se===!0,ye=`${t.id}-${x(c,"yyyy-MM-dd")}`,F=(i==null?void 0:i[ye])||(Array.isArray(t==null?void 0:t.job_date_types)?t.job_date_types.find(r=>{const ne=r!=null&&r.date?new Date(r.date):null;return!!ne&&ne.toDateString()===c.toDateString()}):null),E=F?F.type||F.date_type:void 0,M=((ze=lt.find(r=>r.value===E))==null?void 0:ze.emoji)||"ðŸŽ­",L=(t.title||t.job_name||"Untitled Job").length>26?(t.title||t.job_name||"Untitled Job").substring(0,26)+"...":t.title||t.job_name||"Untitled Job",J=(((Ne=t.location)==null?void 0:Ne.name)||t.venue||"No venue").length>26?(((O=t.location)==null?void 0:O.name)||t.venue||"No venue").substring(0,26)+"...":((_=t.location)==null?void 0:_.name)||t.venue||"No venue",he=t.start_time?x(new Date(t.start_time),"HH:mm"):"",Q=t.end_time?x(new Date(t.end_time),"HH:mm"):"",je=he&&Q?`${he} - ${Q}`:he,q=t.job_type==="festival",H=()=>{T||w||N!=="logistics"&&m&&m(t.id)},Y=r=>{r.stopPropagation(),!w&&f("/timesheets")},U=r=>{r.stopPropagation(),!w&&f(`/festival-management/${t.id}`)},ue=async r=>{var ne;try{const Te=x(c,"yyyy-MM-dd"),{error:Ie}=await ie.from("job_date_types").upsert({job_id:t.id,date:Te,type:r},{onConflict:"job_id,date"});if(Ie)throw Ie;g({title:"Date type updated",description:`Set to ${(ne=lt.find(W=>W.value===r))==null?void 0:ne.label}`}),u.invalidateQueries({queryKey:["job_date_types",Te]}),u.invalidateQueries({predicate:W=>Array.isArray(W.queryKey)&&W.queryKey[0]==="date-types"}),y&&y()}catch{g({title:"Error",description:"Failed to update date type",variant:"destructive"})}},V=r=>{r.stopPropagation(),ee((F==null?void 0:F.type)||"show"),P(!0)},ae=async()=>{try{if(!le){await ce(t.id);return}if(R){g({title:"Loading",description:"Please wait while we load the Flex folder..."});return}X?await Ts({elementId:X,context:{jobType:t.job_type},onError:r=>{g({title:"Error",description:r.message||"Failed to open Flex",variant:"destructive"})},onWarning:r=>{g({title:"Warning",description:r})}}):g(I?{title:"Error",description:String(I),variant:"destructive"}:{title:"Info",description:"Flex folder not available for this job"})}catch{}},re=()=>le?R?"Loading Flex...":X?"Open Flex":"Flex":"Check Flex",pe=()=>R?e.jsx(_t,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(Ps,{className:"mr-2 h-4 w-4"});return e.jsxs(e.Fragment,{children:[e.jsxs(Jt,{className:ft("mb-3 transition-all duration-200",!T&&!w&&"cursor-pointer hover:shadow-md",w&&"opacity-50 pointer-events-none"),onClick:H,style:{borderLeftColor:te,backgroundColor:Pe,borderLeftWidth:"4px"},children:[w&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center z-10 rounded",children:e.jsx("div",{className:"bg-background px-3 py-2 rounded shadow-lg",children:e.jsx("span",{className:"text-sm font-medium",children:"Deleting job..."})})}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(dt,{children:[e.jsx(mt,{asChild:!0,children:e.jsx(C,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:r=>r.stopPropagation(),children:e.jsx(Fs,{className:"h-4 w-4"})})}),e.jsxs(ht,{align:"end",side:"top",sideOffset:-4,collisionPadding:-8,avoidCollisions:!0,className:"w-48 bg-popover border shadow-md z-50",children:[e.jsxs(oe,{onClick:V,children:[e.jsx(ut,{className:"mr-2 h-4 w-4"}),"Change Date Type"]}),e.jsxs(oe,{onClick:r=>{r.stopPropagation(),ae()},disabled:R,children:[pe(),re()]}),e.jsx(at,{}),(N==="technician"||N==="house_tech")&&e.jsxs(oe,{onClick:r=>{r.stopPropagation(),D(!0)},children:[e.jsx(Et,{className:"mr-2 h-4 w-4"}),"View Details"]}),e.jsxs(oe,{onClick:r=>{r.stopPropagation(),Ue(!0)},children:[e.jsx($t,{className:"mr-2 h-4 w-4"}),"Assign Users"]}),e.jsxs(oe,{onClick:Y,children:[e.jsx(Wt,{className:"mr-2 h-4 w-4"}),"Timesheets"]}),q&&ke&&e.jsxs(oe,{onClick:U,children:[e.jsx(Ut,{className:"mr-2 h-4 w-4"}),"Manage Artists"]}),e.jsx(at,{}),be&&e.jsx(oe,{asChild:!0,children:e.jsxs("label",{className:"cursor-pointer",children:[e.jsx(Bs,{className:"mr-2 h-4 w-4"}),"Upload Document",e.jsx("input",{type:"file",className:"hidden",multiple:!0,onChange:He})]})}),ge&&e.jsxs(oe,{onClick:r=>{r.stopPropagation(),d(r)},disabled:s||G||me,children:[s?e.jsx(_t,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(Ss,{className:"mr-2 h-4 w-4"}),s?"Creating...":me?"Flex Folders Created":"Create Flex Folders"]}),!xe&&e.jsxs(oe,{onClick:r=>{r.stopPropagation(),h(r)},disabled:v,children:[e.jsx(Es,{className:"mr-2 h-4 w-4"}),v?"Creating...":"Create Local Folders"]}),e.jsx(at,{}),(N==="technician"||N==="house_tech")&&e.jsxs(oe,{onClick:r=>{r.stopPropagation(),D(!0)},children:[e.jsx(Et,{className:"mr-2 h-4 w-4"}),"View Details"]}),_e&&e.jsxs(oe,{onClick:Ce,children:[e.jsx(Os,{className:"mr-2 h-4 w-4"}),"Edit Job"]}),["admin","management"].includes(N||"")&&e.jsxs(oe,{onClick:a,className:"text-destructive focus:text-destructive",children:[e.jsx(rs,{className:"mr-2 h-4 w-4"}),"Delete Job"]})]})]})}),e.jsxs("div",{className:"flex-1 min-w-0 mx-3 overflow-hidden",children:[e.jsx("h3",{className:"font-semibold text-sm leading-tight mb-1 truncate max-w-full",children:L}),e.jsx("p",{className:"text-xs text-muted-foreground truncate mb-1 max-w-full",children:J}),je&&e.jsx("p",{className:"text-xs text-muted-foreground truncate max-w-full",children:je})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(We,{variant:"secondary",className:"text-xs cursor-pointer hover:bg-secondary/80 transition-colors",onClick:V,children:M})})]}),e.jsx("div",{className:"flex gap-1 flex-wrap",children:(S=t.job_departments)==null?void 0:S.map(r=>e.jsx(We,{variant:"outline",className:"text-xs",children:r.department},r.department))})]})]}),e.jsx(gt,{open:n,onOpenChange:P,children:e.jsxs(yt,{className:"sm:max-w-md",children:[e.jsx(jt,{children:e.jsx(vt,{children:"Change Date Type"})}),e.jsx("div",{className:"grid gap-2",children:lt.map(r=>e.jsxs(C,{variant:Z===r.value?"default":"outline",className:"justify-start",onClick:()=>{ee(r.value),ue(r.value),P(!1)},children:[e.jsx("span",{className:"mr-2",children:r.emoji}),r.label]},r.value))})]})}),e.jsx(vs,{jobId:t.id,open:k,onOpenChange:Ke}),e.jsx(ws,{jobId:t.id,open:fe,onOpenChange:Xe}),e.jsx(bs,{jobId:t.id,open:de,onOpenChange:Ge}),e.jsx(_s,{open:we,onOpenChange:Ze,job:t}),e.jsx(Ds,{isOpen:o,onClose:()=>Ue(!1),onAssignmentChange:()=>{},jobId:t.id}),e.jsx(ks,{open:z,onOpenChange:D,job:t,department:p})]})}const Gs=({showDialog:t,setShowDialog:p,printSettings:c,setPrintSettings:i,generatePDF:y,generateXLS:l,currentMonth:j,selectedJobTypes:m})=>(b.useEffect(()=>{if(t){const f={tourdate:m.includes("tourdate"),tour:m.includes("tour"),single:m.includes("single"),dryhire:m.includes("dryhire"),festival:m.includes("festival")};i(g=>({...g,jobTypes:f}))}},[t,m,i]),e.jsx(gt,{open:t,onOpenChange:p,children:e.jsxs(yt,{children:[e.jsx(jt,{children:e.jsx(vt,{children:"Select Print Range"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Be,{children:"Job Types to Include:"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:Object.entries(c.jobTypes).map(([f,g])=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Vt,{id:`print-${f}`,checked:g,onCheckedChange:u=>{i(N=>({...N,jobTypes:{...N.jobTypes,[f]:!!u}}))}}),e.jsx(Be,{htmlFor:`print-${f}`,className:"capitalize",children:f})]},f))})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"font-semibold text-base",children:"Print to PDF"}),e.jsxs(C,{onClick:()=>{y("month")},children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"})," Current Month (",x(j,"MMMM yyyy"),")"]}),e.jsxs(C,{onClick:()=>{y("quarter")},children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"})," Next Quarter"]}),e.jsxs(C,{onClick:()=>{y("year")},children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"})," Whole Year (",x(j,"yyyy"),")"]})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"font-semibold text-base",children:"Export to Excel"}),e.jsxs(C,{onClick:()=>{l("month")},variant:"outline",children:[e.jsx(it,{className:"h-4 w-4 mr-2"})," Current Month (",x(j,"MMMM yyyy"),")"]}),e.jsxs(C,{onClick:()=>{l("quarter")},variant:"outline",children:[e.jsx(it,{className:"h-4 w-4 mr-2"})," Next Quarter"]}),e.jsxs(C,{onClick:()=>{l("year")},variant:"outline",children:[e.jsx(it,{className:"h-4 w-4 mr-2"})," Whole Year (",x(j,"yyyy"),")"]})]})]})]})})),Zs=({date:t=new Date,onDateSelect:p,jobs:c=[],department:i,onDateTypeChange:y,selectedJobTypes:l,onJobTypeSelection:j,selectedJobStatuses:m=[],onJobStatusSelection:f,onEditClick:g,onDeleteClick:u,onJobClick:N})=>{const[n,P]=b.useState(t),Z=xt();zs();const[ee,z]=b.useState(!1),[D,xe]=b.useState({jobTypes:{tourdate:!0,tour:!0,single:!0,dryhire:!0,festival:!0}}),X=c?Array.from(new Set(c.map(o=>o.job_type).filter(Boolean))):[],R=c?Array.from(new Set(c.map(o=>o.status).filter(Boolean))):[];b.useEffect(()=>{t&&P(t)},[t]);const I=b.useCallback(o=>c?c.filter(T=>{try{if(!T.start_time||!T.end_time)return!1;const _e=T.timezone||"Europe/Madrid",ke=Ye(T.start_time,T.end_time,o,_e),be=i?ke&&T.job_departments.some(He=>He.department===i):ke,ge=l.length===0||l.includes(T.job_type),Ce=m.length===0||m.includes(T.status);return be&&ge&&Ce}catch{return!1}}):[],[c,i,l,m]),{data:le={}}=Rt({queryKey:["job_date_types",x(n,"yyyy-MM-dd")],queryFn:async()=>{const T=I(n).map(ge=>ge.id),_e=x(n,"yyyy-MM-dd");if(T.length===0)return{};const{data:ke,error:be}=await ie.from("job_date_types").select("*").in("job_id",T).eq("date",_e);return be?{}:ke.reduce((ge,Ce)=>({...ge,[`${Ce.job_id}-${Ce.date}`]:Ce}),{})},enabled:I(n).length>0,staleTime:1e3*60*5}),ce=o=>{z(!1)},te=o=>{z(!1)},Pe=()=>{const o=As(n,1);P(o),p(o)},k=()=>{const o=Ls(n,1);P(o),p(o)},fe=()=>{const o=new Date;P(o),p(o)},de=I(n).sort((o,T)=>o.job_type==="dryhire"&&T.job_type!=="dryhire"?1:o.job_type!=="dryhire"&&T.job_type==="dryhire"?-1:0),we=o=>e.jsx(qt,{jobId:o.id,date:n,onTypeChange:()=>{Z.invalidateQueries({queryKey:["job_date_types",x(n,"yyyy-MM-dd")]}),y()},children:e.jsx(Xs,{job:o,department:i||"sound",currentDate:n,dateTypes:le,onDateTypeChange:()=>{Z.invalidateQueries({queryKey:["job_date_types",x(n,"yyyy-MM-dd")]}),y()},onEditClick:g,onDeleteClick:u,onJobClick:N})},o.id);return e.jsx(Jt,{className:"h-full flex flex-col",children:e.jsxs(ns,{className:"flex-grow p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx(C,{variant:"ghost",size:"sm",onClick:Pe,className:"p-2",children:e.jsx(Qt,{className:"h-4 w-4"})}),e.jsxs("div",{className:"text-center flex-1",children:[e.jsx("div",{className:"text-lg font-semibold",children:x(n,"EEEE")}),e.jsx("div",{className:ft("text-sm",Is(n)?"text-primary font-medium":"text-muted-foreground"),children:x(n,"MMM d, yyyy")})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(C,{variant:"outline",size:"sm",onClick:fe,children:e.jsx(Hs,{className:"h-4 w-4"})}),e.jsxs(hs,{children:[e.jsx(us,{asChild:!0,children:e.jsx(C,{variant:"outline",size:"sm",children:e.jsx(ut,{className:"h-4 w-4"})})}),e.jsx(ps,{className:"w-auto p-0 pointer-events-auto",align:"end",children:e.jsx(xs,{mode:"single",selected:n,onSelect:o=>{o&&(P(o),p(o))},initialFocus:!0,className:"pointer-events-auto"})})]})]}),e.jsx(C,{variant:"ghost",size:"sm",onClick:k,className:"p-2",children:e.jsx(Yt,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4 gap-2",children:[e.jsxs("div",{className:"flex gap-2",children:[X.length>0&&j?e.jsxs(dt,{children:[e.jsx(mt,{asChild:!0,children:e.jsxs(C,{variant:"outline",size:"sm",children:[e.jsx(Ot,{className:"h-4 w-4 mr-1"}),"Types",l.length>0&&l.length<X.length&&e.jsx(We,{variant:"secondary",className:"ml-1 text-xs",children:l.length})]})}),e.jsx(ht,{align:"start",className:"w-48 z-50 bg-background border shadow-lg",sideOffset:4,children:X.map(o=>e.jsx(St,{checked:l.length===0||l.includes(o),onCheckedChange:()=>j(o),className:"capitalize",children:o},o))})]}):null,R.length>0&&f?e.jsxs(dt,{children:[e.jsx(mt,{asChild:!0,children:e.jsxs(C,{variant:"outline",size:"sm",children:[e.jsx(Ot,{className:"h-4 w-4 mr-1"}),"Status",m.length>0&&m.length<R.length&&e.jsx(We,{variant:"secondary",className:"ml-1 text-xs",children:m.length})]})}),e.jsx(ht,{align:"start",className:"w-48 z-50 bg-background border shadow-lg",sideOffset:4,children:R.map(o=>e.jsx(St,{checked:m.length===0||m.includes(o),onCheckedChange:()=>f(o),className:"capitalize",children:o},o))})]}):null]}),e.jsxs(C,{variant:"outline",size:"sm",onClick:()=>z(!0),children:[e.jsx(Fe,{className:"h-4 w-4 mr-1"}),"Print"]})]}),e.jsx("div",{className:"flex-grow overflow-y-auto",children:de.length>0?e.jsx("div",{className:"space-y-2",children:de.map(we)}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-32 text-muted-foreground",children:[e.jsx(ut,{className:"h-8 w-8 mb-2"}),e.jsx("p",{className:"text-sm",children:"No jobs scheduled"})]})}),e.jsx(Gs,{showDialog:ee,setShowDialog:z,printSettings:D,setPrintSettings:xe,generatePDF:ce,generateXLS:te,currentMonth:n,selectedJobTypes:l})]})})},ea=({currentMonth:t,onPreviousMonth:p,onNextMonth:c,onTodayClick:i,isCollapsed:y,onToggleCollapse:l,onPrintClick:j})=>e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"flex items-center space-x-4",children:e.jsx("h2",{className:"text-xl font-semibold",children:x(t,"MMMM yyyy")})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(C,{variant:"ghost",size:"icon",onClick:p,children:e.jsx(Qt,{className:"h-4 w-4"})}),e.jsx(C,{variant:"ghost",size:"icon",onClick:c,children:e.jsx(Yt,{className:"h-4 w-4"})}),e.jsx(C,{variant:"ghost",size:"sm",onClick:i,children:"Today"}),e.jsx(C,{variant:"ghost",size:"icon",onClick:l,children:y?e.jsx(ct,{className:"h-4 w-4"}):e.jsx(os,{className:"h-4 w-4"})}),e.jsx(C,{variant:"ghost",size:"icon",onClick:j,children:e.jsx(Fe,{className:"h-4 w-4"})})]})]}),ta=({distinctJobTypes:t,selectedJobTypes:p,isDropdownOpen:c,setIsDropdownOpen:i,onJobTypeSelection:y,distinctJobStatuses:l,selectedJobStatuses:j,isStatusDropdownOpen:m,setIsStatusDropdownOpen:f,onJobStatusSelection:g})=>e.jsxs("div",{className:"flex gap-4 mb-4",children:[e.jsxs("div",{className:"relative",children:[e.jsxs("button",{className:"border border-gray-300 rounded-md py-1 px-2 text-sm w-full flex items-center justify-between",onClick:()=>i(!c),children:[p.length>0?p.join(", "):"Select Job Types",e.jsx(ct,{className:"h-4 w-4 ml-2"})]}),c&&e.jsx("div",{className:"absolute z-10 mt-2 w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-md",children:t.map(u=>e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",onClick:()=>y(u),children:[e.jsx("span",{className:"text-sm text-black dark:text-white",children:u}),p.includes(u)&&e.jsx(kt,{className:"h-4 w-4 text-blue-500"})]},u))})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{className:"border border-gray-300 rounded-md py-1 px-2 text-sm w-full flex items-center justify-between",onClick:()=>f(!m),children:[j.length>0?j.join(", "):"Select Job Status",e.jsx(ct,{className:"h-4 w-4 ml-2"})]}),m&&e.jsx("div",{className:"absolute z-10 mt-2 w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-md",children:l.map(u=>e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",onClick:()=>g(u),children:[e.jsx("span",{className:"text-sm text-black dark:text-white",children:u}),j.includes(u)&&e.jsx(kt,{className:"h-4 w-4 text-blue-500"})]},u))})]})]}),sa=({allDays:t,currentMonth:p,getJobsForDate:c,renderJobCard:i,onDateSelect:y})=>e.jsx("div",{className:"border rounded-lg overflow-x-auto",children:e.jsxs("div",{className:"grid grid-cols-7 gap-px bg-muted",style:{minWidth:"980px"},children:[["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map(l=>e.jsx("div",{className:"bg-background p-2 text-center text-sm text-muted-foreground font-medium",children:l},l)),t.map((l,j)=>{const m=c(l),f=$e(l,p),g=7;return e.jsxs("div",{className:ft("bg-background p-1 min-h-[120px] border-t relative cursor-pointer hover:bg-accent/50 transition-colors calendar-cell",!f&&"text-muted-foreground/50"),onClick:()=>y(l),children:[e.jsx("span",{className:"text-sm font-medium ml-1",children:x(l,"d")}),e.jsxs("div",{className:"space-y-1 mt-1 calendar-job-list",children:[m.slice(0,g).map(u=>i(u,l)),m.length>g&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1 bg-accent/30 p-0.5 rounded text-center",children:["+ ",m.length-g," more"]})]})]},j)})]})}),aa=({job:t,date:p,dateTypes:c})=>{var u,N;const i=(n,P)=>{var z;const Z=`${n}-${x(P,"yyyy-MM-dd")}`;switch((z=c[Z])==null?void 0:z.type){case"travel":return e.jsx(Ws,{className:"h-3 w-3 text-blue-500"});case"setup":return e.jsx($s,{className:"h-3 w-3 text-yellow-500"});case"show":return e.jsx(Ut,{className:"h-3 w-3 text-green-500"});case"off":return e.jsx(qs,{className:"h-3 w-3 text-gray-500"});case"rehearsal":return e.jsx(Js,{className:"h-3 w-3 text-violet-500"});default:return null}},y=n=>{switch(n){case"sound":return e.jsx(Rs,{className:"h-3 w-3"});case"lights":return e.jsx(Vs,{className:"h-3 w-3"});case"video":return e.jsx(Us,{className:"h-3 w-3"});default:return null}},j=(n=>{var Z,ee,z;let P=0;return((Z=n.sound_job_personnel)==null?void 0:Z.length)>0&&(P+=(n.sound_job_personnel[0].foh_engineers||0)+(n.sound_job_personnel[0].mon_engineers||0)+(n.sound_job_personnel[0].pa_techs||0)+(n.sound_job_personnel[0].rf_techs||0)),((ee=n.lights_job_personnel)==null?void 0:ee.length)>0&&(P+=(n.lights_job_personnel[0].lighting_designers||0)+(n.lights_job_personnel[0].lighting_techs||0)+(n.lights_job_personnel[0].spot_ops||0)+(n.lights_job_personnel[0].riggers||0)),((z=n.video_job_personnel)==null?void 0:z.length)>0&&(P+=(n.video_job_personnel[0].video_directors||0)+(n.video_job_personnel[0].camera_ops||0)+(n.video_job_personnel[0].playback_techs||0)+(n.video_job_personnel[0].video_techs||0)),P})(t),m=((u=t.job_assignments)==null?void 0:u.length)||0,f=t.timezone||"Europe/Madrid",g=i(t.id,p);return e.jsx(qt,{jobId:t.id,date:p,onTypeChange:()=>{},children:e.jsx(is,{children:e.jsxs(ls,{children:[e.jsx(cs,{asChild:!0,children:e.jsxs("div",{className:"px-1.5 py-0.5 rounded text-xs truncate hover:bg-accent/50 transition-colors flex items-center gap-1 cursor-pointer",style:{backgroundColor:`${t.color}20`,color:t.color},children:[g,e.jsx("span",{children:t.title})]})}),e.jsx(ds,{className:"w-64 p-2",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),t.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t.description}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Wt,{className:"h-4 w-4"}),e.jsxs("span",{children:[Tt(t.start_time,"MMM d, HH:mm",f)," -"," ",Tt(t.end_time,"MMM d, HH:mm",f)]})]}),((N=t.location)==null?void 0:N.name)&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ms,{className:"h-4 w-4"}),e.jsx("span",{children:t.location.name})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-sm font-medium",children:"Departments:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:t.job_departments.map(n=>e.jsxs(We,{variant:"secondary",className:"flex items-center gap-1",children:[y(n.department),e.jsx("span",{className:"capitalize",children:n.department})]},n.department))})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($t,{className:"h-4 w-4"}),e.jsxs("span",{children:[m,"/",j," assigned"]})]})]})})]})})},t.id)},ra=({showDialog:t,setShowDialog:p,printSettings:c,setPrintSettings:i,generatePDF:y,generateXLS:l,currentMonth:j,selectedJobTypes:m})=>(b.useEffect(()=>{if(t){const f={tourdate:m.includes("tourdate"),tour:m.includes("tour"),single:m.includes("single"),dryhire:m.includes("dryhire"),festival:m.includes("festival")};i(g=>({...g,jobTypes:f}))}},[t,m,i]),e.jsx(gt,{open:t,onOpenChange:p,children:e.jsxs(yt,{children:[e.jsx(jt,{children:e.jsx(vt,{children:"Select Print Range"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Be,{children:"Job Types to Include:"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:Object.entries(c.jobTypes).map(([f,g])=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Vt,{id:`print-${f}`,checked:g,onCheckedChange:u=>{i(N=>({...N,jobTypes:{...N.jobTypes,[f]:!!u}}))}}),e.jsx(Be,{htmlFor:`print-${f}`,className:"capitalize",children:f})]},f))})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"font-semibold text-base",children:"Print to PDF"}),e.jsxs(C,{onClick:()=>{y("month")},children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"})," Current Month (",x(j,"MMMM yyyy"),")"]}),e.jsxs(C,{onClick:()=>{y("quarter")},children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"})," Next Quarter"]}),e.jsxs(C,{onClick:()=>{y("year")},children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"})," Whole Year (",x(j,"yyyy"),")"]})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"font-semibold text-base",children:"Export to XLS"}),e.jsxs(C,{onClick:()=>{l("month")},children:[e.jsx(nt,{className:"h-4 w-4 mr-2"})," Current Month (",x(j,"MMMM yyyy"),")"]}),e.jsxs(C,{onClick:()=>{l("quarter")},children:[e.jsx(nt,{className:"h-4 w-4 mr-2"})," Next Quarter"]}),e.jsxs(C,{onClick:()=>{l("year")},children:[e.jsx(nt,{className:"h-4 w-4 mr-2"})," Whole Year (",x(j,"yyyy"),")"]})]})]})]})})),na=(t,p)=>Rt({queryKey:["date-types",t.sort(),p.sort()],queryFn:async()=>{if(!t.length||!p.length)return{};const{data:c,error:i}=await ie.from("job_date_types").select("*").in("job_id",t).in("date",p);if(i)throw i;return c.reduce((y,l)=>({...y,[`${l.job_id}-${l.date}`]:l}),{})},staleTime:1e3*60*10,gcTime:1e3*60*30,enabled:t.length>0&&p.length>0,refetchOnWindowFocus:!1,refetchOnReconnect:!0}),xn=({date:t=new Date,onDateSelect:p,jobs:c=[],department:i,onDateTypeChange:y})=>{const l=Lt(),[j,m]=b.useState(!1),[f,g]=b.useState(!1),[u,N]=b.useState([]),[n,P]=b.useState([]),[Z,ee]=b.useState(!1),[z,D]=b.useState(!1),[xe,X]=b.useState({range:"month",jobTypes:{tourdate:!0,tour:!0,single:!0,dryhire:!0,festival:!0}}),{toast:R}=pt(),I=t||new Date,le=`${I.getFullYear()}-${I.getMonth()}`,ce=b.useMemo(()=>{const a=qe(I),d=Oe(I),h=ot({start:a,end:d}),s=a.getDay(),v=s===0?6:s-1,w=Array.from({length:v}).map((me,ye)=>{const F=new Date(a);return F.setDate(F.getDate()-(v-ye)),F}),G=Array.from({length:42-(w.length+h.length)}).map((me,ye)=>{const F=new Date(d);return F.setDate(F.getDate()+(ye+1)),F});return[...w,...h,...G]},[le]),te=c?Array.from(new Set(c.map(a=>a.job_type).filter(Boolean))):[],Pe=c?Array.from(new Set(c.map(a=>a.status).filter(Boolean))):[];b.useEffect(()=>{(async()=>{var d;try{const{data:{session:h}}=await ie.auth.getSession();if(!((d=h==null?void 0:h.user)!=null&&d.id))return;const{data:s,error:v}=await ie.from("profiles").select("selected_job_types, selected_job_statuses").eq("id",h.user.id).single();if(v)return;s!=null&&s.selected_job_types&&N(s.selected_job_types),s!=null&&s.selected_job_statuses&&P(s.selected_job_statuses)}catch{}})()},[]);const k=async(a,d)=>{var h;try{const{data:{session:s}}=await ie.auth.getSession();if(!((h=s==null?void 0:s.user)!=null&&h.id))return;const v=d!==void 0?{selected_job_types:a,selected_job_statuses:d}:{selected_job_types:a},{error:w}=await ie.from("profiles").update(v).eq("id",s.user.id);w&&R({title:"Error saving preferences",description:"Your filter preferences couldn't be saved.",variant:"destructive"})}catch{}},fe=a=>{const d=u.includes(a)?u.filter(h=>h!==a):[...u,a];N(d),k(d),ee(!1)},de=a=>{const d=n.includes(a)?n.filter(h=>h!==a):[...n,a];P(d),k(u,d),D(!1)},we=b.useMemo(()=>c?c.map(a=>{var d;return{...a,jobTimezone:a.timezone||"Europe/Madrid",departmentIds:((d=a.job_departments)==null?void 0:d.map(h=>h.department))||[]}}):[],[c]),o=b.useMemo(()=>a=>we.length?we.filter(d=>{try{if(!d.start_time||!d.end_time)return!1;const h=Ye(d.start_time,d.end_time,a,d.jobTimezone),s=i?h&&d.departmentIds.some(se=>se===i):h,v=u.length===0||u.includes(d.job_type),w=n.length===0||n.includes(d.status);return s&&v&&w}catch{return!1}}):[],[we,i,u,n]),T=b.useMemo(()=>ce.map(a=>({date:a,formatted:x(a,"yyyy-MM-dd")})),[ce]),_e=b.useMemo(()=>{const a=new Set;return T.forEach(({date:d})=>{o(d).forEach(h=>a.add(h.id))}),Array.from(a)},[T,o]),ke=b.useMemo(()=>Array.from(new Set(T.map(({formatted:a})=>a))),[T]),{data:be={}}=na(_e,ke);if(l)return e.jsx(Zs,{date:t,onDateSelect:p,jobs:c,department:i,onDateTypeChange:y,selectedJobTypes:u,onJobTypeSelection:fe,selectedJobStatuses:n,onJobStatusSelection:de});const ge=a=>{const d=parseInt(a.slice(1,3),16),h=parseInt(a.slice(3,5),16),s=parseInt(a.slice(5,7),16);return[d,h,s]},Ce=a=>{const[d,h,s]=ge(a);return(.299*d+.587*h+.114*s)/255>.6?"#000000":"#ffffff"},He=async a=>{var Ne;const d=c.filter(O=>{var S;const _=(S=O.job_type)==null?void 0:S.toLowerCase();return _&&xe.jobTypes[_]===!0}),h=await Ys(),s=new h("landscape","mm",[420,297]),v=t||new Date;let w,se;const G=await new Promise((O,_)=>{const S=new Image;S.crossOrigin="anonymous",S.src="/lovable-uploads/ce3ff31a-4cc5-43c8-b5bb-a4056d3735e4.png",S.onload=()=>O(S),S.onerror=r=>_(r)}).catch(()=>null),me=s.internal.pageSize.getWidth(),ye=s.internal.pageSize.getHeight(),F=60,E=G?F*(G.height/G.width):0,M=15,L=G?M+E+8:25,J=L+15,he=40,Q=15;switch(a){case"month":w=qe(v),se=Oe(v);break;case"quarter":w=zt(Qe(v,1)),se=It(Qe(w,2));break;case"year":w=Ft(v),se=Pt(v);break;default:w=qe(v),se=Oe(v)}const je=Ht({start:w,end:se}),q=57,H=3.2,Y=.3,U=15,ue=8,V=2,ae=["Lunes","Martes","Miercoles","Jueves","Viernes","Sabado","Domingo"],re={travel:"V",setup:"M",show:"S",off:"O",rehearsal:"E"},pe=O=>d.filter(_=>{try{const S=_.timezone||"Europe/Madrid";return Ye(_.start_time,_.end_time,O,S)}catch{return!1}}),ze=(O,_)=>{const S=ye-J-8-he-Q,r=O.map(W=>{const $=W.map(A=>!A||!$e(A,_)?0:pe(A).length),ve=Math.max(...$),B=$.reduce((A,K)=>A+K,0),Se=B/($.filter(A=>A>0).length||1);return{maxEvents:ve,totalEvents:B,avgEvents:Se,dayEventCounts:$}}),ne=r.map(W=>{const{maxEvents:$}=W,B=Math.min($,12)*(H+Y),Se=$>12?H+Y:0;return ue+V*2+B+Se}),Te=ne.reduce((W,$)=>W+$,0);if(Te<=S){const $=(S-Te)/O.length;return ne.map((ve,B)=>{const Se=r[B],A=Math.max(Se.maxEvents/12,.2),K=$*A;return ve+K})}const Ie=r.reduce((W,$)=>W+Math.max($.maxEvents,1),0);return r.map(W=>{const $=Math.max(W.maxEvents,1)/Ie,ve=S*$,B=ue+V*2+Math.min(W.maxEvents,3)*(H+Y);return Math.max(ve,B)})};for(const[O,_]of je.entries()){let S=function(A){return(A.getDay()+6)%7};O>0&&s.addPage([420,297],"landscape");const r=G?(me-F)/2:0;G&&s.addImage(G,"PNG",r,M,F,E),s.setFontSize(20),s.setTextColor(51,51,51),s.text(x(_,"MMMM yyyy").toUpperCase(),me/2,L,{align:"center"}),ae.forEach((A,K)=>{s.setFillColor(41,128,185),s.rect(U+K*q,J,q,8,"F"),s.setTextColor(255),s.setFontSize(12);const De=U+K*q+q/2;s.text(A,De,J+6,{align:"center"})});const ne=Oe(_),Te=ot({start:_,end:ne}),Ie=S(_),$=[...Array.from({length:Ie},()=>null),...Te],ve=[];for(;$.length>0;)ve.push($.splice(0,7));let B=J+8;const Se=ze(ve,_);for(const[A,K]of ve.entries()){const De=Se[A];for(const[et,Ee]of K.entries()){const Me=U+et*q;if(s.setDrawColor(200),s.setLineWidth(.5),s.rect(Me,B,q,De),!Ee)continue;s.setTextColor($e(Ee,_)?0:150),s.setFontSize(12),s.setFont("helvetica","bold"),s.text(x(Ee,"d"),Me+2,B+6);const Ae=pe(Ee);if(Ae.length===0)continue;const Bt=De-ue-V*2,Kt=Math.floor(Bt/(H+Y)),Ve=Math.min(Ae.length,Math.max(Kt,1)),wt=B+ue+V;for(const[Le,Je]of Ae.slice(0,Ve).entries()){const Xt=`${Je.id}-${x(Ee,"yyyy-MM-dd")}`,bt=(Ne=be[Xt])==null?void 0:Ne.type,tt=bt?re[bt]:"",Ct=Je.color||"#cccccc",[Gt,Zt,es]=ge(Ct),Nt=Ce(Ct),st=wt+Le*(H+Y);s.setFillColor(Gt,Zt,es),s.rect(Me+1,st,q-2,H,"F"),tt&&(s.setFont("helvetica","bold"),s.setFontSize(7),s.setTextColor(Nt),s.text(tt,Me+2,st+2.2)),s.setFont("helvetica","normal"),s.setFontSize(6.5),s.setTextColor(Nt);const Dt=tt?Me+8:Me+2,ts=q-(Dt-Me)-2,Mt=Math.floor(ts/1.2);let Re=Je.title;Re.length>Mt&&(Re=Re.substring(0,Mt-3)+"..."),s.text(Re,Dt,st+2.2)}if(Ae.length>Ve){const Le=wt+Ve*(H+Y);if(Le+H<B+De-V){s.setFillColor(240,240,240),s.rect(Me+1,Le,q-2,H,"F"),s.setFont("helvetica","italic"),s.setFontSize(6),s.setTextColor(100);const Je=`+${Ae.length-Ve} more`;s.text(Je,Me+2,Le+2.2)}}}B+=De}if(O===0){let A=B+8;s.setFont("helvetica","bold"),s.setFontSize(9),s.setTextColor(0),s.text("Date Types:",U,A);let K=U+50;Object.entries(re).forEach(([De,et],Ee)=>{s.setFont("helvetica","normal"),s.setFontSize(8),s.text(`${et} = ${De.charAt(0).toUpperCase()+De.slice(1)}`,K,A),K+=60,K>me-60&&Ee<Object.entries(re).length-1&&(K=U+50,A+=10)})}}s.save(`calendar-${a}-${x(new Date,"yyyy-MM-dd")}.pdf`),g(!1)},Ke=async a=>{const d=c.filter(E=>{var L;const M=(L=E.job_type)==null?void 0:L.toLowerCase();return M&&xe.jobTypes[M]===!0}),h=await Qs(),s=t||new Date;let v,w;switch(a){case"month":v=qe(s),w=Oe(s);break;case"quarter":v=zt(Qe(s,1)),w=It(Qe(v,2));break;case"year":v=Ft(s),w=Pt(s);break;default:v=qe(s),w=Oe(s)}const se=["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES","SABADO","DOMINGO"],G={travel:"V",setup:"M",show:"S",off:"O",rehearsal:"E"},me=E=>d.filter(M=>{try{const L=M.timezone||"Europe/Madrid";return Ye(M.start_time,M.end_time,E,L)}catch{return!1}}),ye=E=>{var ue;const M=[];M.push([x(E,"MMMM yyyy").toUpperCase(),null,null,null,null,null,null]),M.push(se);const L=Oe(E),J=ot({start:E,end:L});function he(V){return(V.getDay()+6)%7}const Q=he(E),q=[...Array.from({length:Q},()=>null),...J],H=[];for(;q.length>0;)H.push(q.splice(0,7));let Y=0;for(const V of H)for(const ae of V)if(ae&&$e(ae,E)){const re=me(ae);re.length>Y&&(Y=re.length)}const U=Math.max(1,Y+1);for(const V of H){const ae=Array.from({length:U},()=>Array(7).fill(null));for(const[re,pe]of V.entries()){if(!pe)continue;const ze=x(pe,"d"),Ne=me(pe);ae[0][re]=$e(pe,E)?ze:`${x(pe,"d")}`;for(let O=0;O<Ne.length;O++)if(O+1<U){const _=Ne[O],S=`${_.id}-${x(pe,"yyyy-MM-dd")}`,r=(ue=be[S])==null?void 0:ue.type,ne=r?G[r]+" ":"";ae[O+1][re]=`${ne}${_.title}`}else{ae[U-1][re]=`+${Ne.length-O} more...`;break}}M.push(...ae)}return M},F=h.utils.book_new();if(a==="year"||a==="quarter"){const E=Ht({start:v,end:w});for(const M of E){const L=ye(M),J=h.utils.aoa_to_sheet(L),he=L.reduce((Q,je)=>(je.forEach((q,H)=>{const U=(q?q.toString():"").split(`
`).reduce((ue,V)=>Math.max(ue,V.length),0);Q[H]=Math.max(Q[H]||0,U)}),Q),Array(7).fill(0));J["!cols"]=he.map(Q=>({wch:Q+2})),L.length>0&&(J["!merges"]=[{s:{r:0,c:0},e:{r:0,c:6}}]),h.utils.book_append_sheet(F,J,x(M,"MMM yyyy"))}}else{const E=ye(s),M=h.utils.aoa_to_sheet(E),L=E.reduce((J,he)=>(he.forEach((Q,je)=>{const H=(Q?Q.toString():"").split(`
`).reduce((Y,U)=>Math.max(Y,U.length),0);J[je]=Math.max(J[je]||0,H)}),J),Array(7).fill(0));M["!cols"]=L.map(J=>({wch:J+2})),E.length>0&&(M["!merges"]=[{s:{r:0,c:0},e:{r:0,c:6}}]),h.utils.book_append_sheet(F,M,x(s,"MMMM yyyy"))}h.writeFile(F,`calendar-${a}-${x(new Date,"yyyy-MM-dd")}.xlsx`),g(!1)},Xe=()=>{const a=new Date(I);a.setMonth(a.getMonth()-1),p(a)},Ge=()=>{const a=new Date(I);a.setMonth(a.getMonth()+1),p(a)},Ze=()=>{p(new Date)},Ue=(a,d)=>e.jsx(aa,{job:a,date:d,dateTypes:be},a.id);return e.jsx("div",{className:"h-full flex flex-col bg-transparent",children:e.jsxs("div",{className:"flex-grow p-4",children:[e.jsx(ea,{currentMonth:I,onPreviousMonth:Xe,onNextMonth:Ge,onTodayClick:Ze,isCollapsed:j,onToggleCollapse:()=>m(!j),onPrintClick:()=>g(!0)}),e.jsx(ra,{showDialog:f,setShowDialog:g,printSettings:xe,setPrintSettings:X,generatePDF:He,generateXLS:Ke,currentMonth:I,selectedJobTypes:u}),e.jsx(ta,{distinctJobTypes:te,selectedJobTypes:u,isDropdownOpen:Z,setIsDropdownOpen:ee,onJobTypeSelection:fe,distinctJobStatuses:Pe,selectedJobStatuses:n,isStatusDropdownOpen:z,setIsStatusDropdownOpen:D,onJobStatusSelection:de}),!j&&e.jsx(sa,{allDays:ce,currentMonth:I,getJobsForDate:o,renderJobCard:Ue,onDateSelect:p})]})})};export{xn as CalendarSection};
