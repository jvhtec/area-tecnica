const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/DashboardMobileHub-BgKFEc5P.js","assets/index-NZ6jJLfQ.js","assets/vite-preload-helper-ckwbz45p.js","assets/commonjs-helpers-Cpj98o6Y.js","assets/index-DFO7exW2.css","assets/dropdown-menu-Dn1SMjj1.js","assets/index-D9TsP8oP.js","assets/index-hC3MxXep.js","assets/chevron-right-Bn7Eu0F7.js","assets/circle-CWxDyDxx.js","assets/popover-Dl-b1R8L.js","assets/calendar--BDVgnXu.js","assets/isSameDay-m1OvdnsV.js","assets/isSameMonth-BQ4F6s8O.js","assets/addMonths-j-Bb577B.js","assets/differenceInCalendarMonths-6exvViir.js","assets/startOfMonth-B5dVCv8B.js","assets/endOfWeek-BYLwoWuZ.js","assets/endOfMonth-Byhxb84j.js","assets/subDays-D4REtaCB.js","assets/chevron-left-rq2ui83a.js","assets/badge-vNTKF5RD.js","assets/message-square-a2K2ewo9.js","assets/mail-1T3Omkp6.js","assets/filter-D0HnK7Nz.js","assets/calendar-_Cj_Sgy-.js","assets/ellipsis-vertical-zRAfIP3L.js","assets/square-pen-BMpSgZGa.js","assets/isWithinInterval-CV3kanO0.js","assets/isToday-BbpdYtC3.js","assets/constructNow-u0VlpghF.js","assets/DashboardHeader-CrPTl7Xd.js","assets/useUserPreferences-D4k5KjWa.js","assets/CalendarSection-DRcHiGMy.js","assets/DateTypeContextMenu-D-zx4rHd.js","assets/context-menu-DYP7Nyzl.js","assets/useTableSubscription-Cu79jct8.js","assets/flexUuidService-C9yZjzP-.js","assets/config-DVV3VxR4.js","assets/constants-DoXhG9KB.js","assets/plane-NSG-_bNT.js","assets/wrench-DzMvZxmF.js","assets/star-icpn3ybK.js","assets/mic-l4q2dREA.js","assets/moon-Bp9lP4EQ.js","assets/external-link-QJoXZ6ES.js","assets/VideoTaskDialog-jFo9WRqF.js","assets/useQuery-kdg2pmgf.js","assets/useJobRequiredRoles-Bz0ibKHS.js","assets/useMutation-DluhVBs1.js","assets/useWeatherData-d0TEdKFc.js","assets/weatherApi-BatwQpQy.js","assets/icon-D8sTZPYx.js","assets/progress-C8XsV-Me.js","assets/table-DnQAmABX.js","assets/lazyXlsx-BrFBF17_.js","assets/download-C1rVE0-J.js","assets/upload-DF4rjO7T.js","assets/optimisticJobDeletionService-Bq-53fU4.js","assets/folders-Scoqgw4s.js","assets/alert-dialog-CtyYUxwH.js","assets/useJobAssignmentsRealtime-7FZn5naq.js","assets/useRealtimeQuery-DRd58t-I.js","assets/technicianAvailability-gbYgVBKV.js","assets/roleCategory-BtQgWHfO.js","assets/api-C9EDenHJ.js","assets/dryhireFolderService-Bb-tDpoa.js","assets/folderNameSanitizer-DNdk00QU.js","assets/EditJobDialog-DRKRzgWP.js","assets/checkbox-BsRNEGV1.js","assets/JobDetailsDialog-Cah6wZTf.js","assets/tabs-BdaywI_b.js","assets/useTourRateSubscriptions-Dd0aSU9f.js","assets/JobExtrasEditor-gQe73Sd8.js","assets/separator-E-JdTFOv.js","assets/ratesQueryKeys-DgMsgg6U.js","assets/euro-DgRTeGAz.js","assets/minus-InO4I9Ks.js","assets/plus-C3JQqq7t.js","assets/circle-alert-LZYNzZ7F.js","assets/useJobRatesApproval-DsfA8V9C.js","assets/switch-DUBpZhIC.js","assets/alert-BqA-5jRM.js","assets/JobPayoutTotalsPanel-BSlgp62i.js","assets/useJobPayoutTotals-CXAavZS-.js","assets/useManagerJobQuotes-BrI1iNRY.js","assets/tourRateMath-BOmIkfWO.js","assets/logoUtils-D2o1jUVg.js","assets/logo-url-cache-eY6nfvu7.js","assets/lazyPdf-xVUlxKNu.js","assets/es-CSiFCUGj.js","assets/pen-D_H3YLSb.js","assets/file-down-Buu6FgvW.js","assets/send-Uvkx0r_O.js","assets/clock-BXPvTWvY.js","assets/circle-check-big-CilmNGCn.js","assets/triangle-alert-D6qN0F8g.js","assets/users-DMnpVLUq.js","assets/JobExtrasManagement-CpH8R_KL.js","assets/receipt-CWKVL4Rh.js","assets/circle-check-C0N48OpO.js","assets/circle-x-DDzV-xk_.js","assets/file-text-igU140SQ.js","assets/eye-BE_DouVP.js","assets/pdfMerge-DXtLP7Xx.js","assets/pdf-libs-BqoGqu1a.js","assets/timesheet-pdf-82e1LStH.js","assets/truck-Br5sduv3.js","assets/avatar-QSp4LpEt.js","assets/places-restaurant-service-CakuSyx6.js","assets/utensils-crossed-CZeagqP3.js","assets/phone-BlFwiuho.js","assets/folder-plus-DTUhlRcm.js","assets/hard-drive-DZn0Cm3i.js","assets/printer-De77t3j8.js","assets/useMobileRealtimeSubscriptions-CkyUxSWV.js","assets/useSubscription-C3wu6ko-.js","assets/target-kNjpphh3.js","assets/video-BcyQPYgx.js","assets/lightbulb-BU2ctenD.js","assets/music-2-DRJ2zGwb.js","assets/eachDayOfInterval-CPmiA2bk.js","assets/endOfYear-D08D-xBX.js","assets/endOfQuarter-BH4-YKz9.js","assets/TodaySchedule-xMAV31Nm.js","assets/JobCardNew-ZLL_Hd_i.js","assets/ModernHojaDeRuta-DrMmS05m.js","assets/useJobSelection-B9iLNF5-.js","assets/MultiDayScheduleBuilder-DmGkt0fN.js","assets/building-BdT03Y2e.js","assets/arrow-up-BTt-lBKB.js","assets/copy-Dez5r9kU.js","assets/calendar-days-DcwEz6pd.js","assets/building-2-nIk8XRuA.js","assets/zap-QKspq41J.js","assets/sparkles-BZkmCd_8.js","assets/image--Pql38nK.js","assets/settings-egXcSQW9.js","assets/user-E3OATBQk.js","assets/briefcase-BrpPecAy.js","assets/search-D-OiWg8h.js","assets/id-card-oCs3SPbN.js","assets/car-vrO_NvCk.js","assets/package-Oxfj-CNq.js","assets/activity-BNQuCEmB.js","assets/save-z_re-Mcq.js","assets/FlexFolderPicker-DHVHrWa7.js","assets/scroll-area-BHjMXddA.js","assets/LogisticsEventDialog-WK7mGk6y.js","assets/transportOptions-CtHnG2xX.js","assets/transportProviders-CPS1W6Xy.js","assets/TaskManagerDialog-WHCTXr5s.js","assets/taskCompletion-NTcmWFA_.js","assets/TechnicianIncidentReportDialog-Bb0qWmts.js","assets/index-vfKqQWY5.js","assets/logo-service-SlbhM6-i.js","assets/jobDocumentsUpload-BaycvzFe.js","assets/clipboard-list-wtFE30Ps.js","assets/useFlexUuid-C0fmwl_8.js","assets/command-D3uMBT-Z.js","assets/message-circle-Bh9rUoQO.js","assets/info-CpCfiYD2.js","assets/userName-BCcvOtN-.js","assets/MessagesDialog-zbCGLT8o.js","assets/DirectMessagesList-C-bJnXYG.js","assets/user-check-CYYJtyVp.js","assets/useTabVisibility-TU5j192j.js","assets/subscription-indicator-DAcdH7Ud.js","assets/formatDistanceToNow-Bbdi_GlK.js","assets/wifi-C3_7SFyW.js","assets/EmailComposerDialog-fRolO6hn.js"])))=>i.map(i=>d[i]);
import{_ as d}from"./vite-preload-helper-ckwbz45p.js";import{c as ee,d as se,u as ae,r as s,g as te,e as ne,f as oe,j as e,B as N,a as I,h as V,i as re,k as ie,s as le}from"./index-NZ6jJLfQ.js";import{u as de}from"./useOptimizedJobs-BQ4L7-2d.js";import{B as ce}from"./badge-vNTKF5RD.js";import{u as ue}from"./useQuery-kdg2pmgf.js";import{d as me}from"./optimisticJobDeletionService-Bq-53fU4.js";import{u as pe}from"./useOptimizedSubscriptions-BXgl5mid.js";import{s as he}from"./subDays-D4REtaCB.js";import{s as xe,a as be}from"./startOfMonth-B5dVCv8B.js";import{e as fe}from"./endOfMonth-Byhxb84j.js";import{M as ge}from"./message-square-a2K2ewo9.js";import{M as je}from"./mail-1T3Omkp6.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./useSubscription-C3wu6ko-.js";const ve=s.lazy(()=>d(()=>import("./DashboardMobileHub-BgKFEc5P.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30])).then(a=>({default:a.DashboardMobileHub}))),_e=s.lazy(()=>d(()=>import("./DashboardHeader-CrPTl7Xd.js"),__vite__mapDeps([31,1,2,3,4,32])).then(a=>({default:a.DashboardHeader}))),ye=s.lazy(()=>d(()=>import("./CalendarSection-DRcHiGMy.js"),__vite__mapDeps([33,1,2,3,4,21,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,25,98,99,100,101,102,103,104,105,106,107,108,109,110,111,26,112,113,27,114,115,116,29,30,117,24,118,119,120,121,122,123])).then(a=>({default:a.CalendarSection}))),De=s.lazy(()=>d(()=>import("./TodaySchedule-xMAV31Nm.js"),__vite__mapDeps([124,1,2,3,4,125,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,36,63,64,45,65,38,39,66,67,70,71,7,72,73,21,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,25,98,99,100,101,102,103,104,105,106,107,108,109,110,111,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,40,69,143,144,9,42,114,145,146,147,68,148,149,150,151,152,153,154,155,156,157,158,37,159,160,161,27,112,162,5,6,8,43,44,41])).then(a=>({default:a.TodaySchedule}))),q=s.lazy(()=>d(()=>import("./MessagesDialog-zbCGLT8o.js"),__vite__mapDeps([163,1,2,3,4,164,22,95,165,90,47,166,36,167,168,30,15,18,169,96,93])).then(a=>({default:a.MessagesDialog}))),H=s.lazy(()=>d(()=>import("./EmailComposerDialog-fRolO6hn.js"),__vite__mapDeps([170,2,1,3,4])).then(a=>({default:a.EmailComposerDialog}))),B=s.lazy(()=>d(()=>import("./EditJobDialog-DRKRzgWP.js").then(a=>a.a),__vite__mapDeps([68,1,2,3,4,69,48,47,49])).then(a=>({default:a.EditJobDialog}))),Ce=s.lazy(()=>d(()=>import("./JobDetailsDialog-Cah6wZTf.js").then(a=>a.a),__vite__mapDeps([70,1,2,3,4,47,71,7,72,73,21,74,49,75,76,77,78,79,80,81,82,50,51,83,84,85,86,87,88,89,90,39,91,92,93,45,94,95,96,97,25,98,99,100,101,102,103,56,104,105,106,107,108,109,110,111])).then(a=>({default:a.JobDetailsDialog}))),ke=(a,f)=>!a||!f?[]:f.filter(t=>{if(t.job_type==="tour")return!1;const p=t.timezone||"Europe/Madrid";return ie(t.start_time,t.end_time,a,p)}),qe=()=>{const a=ee(),f=se(),{userRole:t,user:p,isLoading:h}=ae(),F=(p==null?void 0:p.id)??"",r=e.jsx("div",{className:"flex items-center justify-center py-6",children:e.jsx(I,{className:"h-5 w-5 animate-spin text-muted-foreground"})});s.useEffect(()=>{if(!h&&t&&!["admin","management","logistics"].includes(t)){const n=te(t);a(n,{replace:!0})}},[t,h,a]);const[c,E]=s.useState(new Date),[Q,G]=s.useState("1week"),[g,D]=s.useState(!1),[O,S]=s.useState(!1),[u,M]=s.useState(null),[j,v]=s.useState(!1),[_,C]=s.useState(!1),T=c??new Date,K=he(xe(T),7),U=be(fe(T),14),{data:m=[],isLoading:we}=de(void 0,K,U),{toast:y}=ne(),J=oe();pe(F);const{data:l,isLoading:W}=ue({queryKey:["dashboard-expenses-summary"],enabled:!!t&&["admin","management","logistics"].includes(t),queryFn:async()=>{const{data:n,error:o}=await le.from("job_expenses").select("amount_eur, job_id").eq("status","submitted");if(o)throw o;const x=n||[],Z=x.reduce((i,b)=>i+Number(b.amount_eur??0),0),w=new Map;x.forEach(i=>{i.job_id&&w.set(i.job_id,(w.get(i.job_id)||0)+Number(i.amount_eur??0))});const $=Array.from(w.entries()).sort((i,b)=>b[1]-i[1]).slice(0,3).map(([i,b])=>({jobId:i,amount:b}));return{count:x.length,total:Z,jobs:$}},staleTime:15e3});s.useEffect(()=>{if(h||!t||!["admin","management"].includes(t))return;new URLSearchParams(window.location.search).get("showMessages")==="true"&&v(!0)},[h,t]);const k=t==="admin"||t==="management",z=s.useCallback(()=>v(!0),[]),L=s.useCallback(()=>C(!0),[]),A=s.useCallback(n=>{const o=m.find(x=>x.id===n);o&&(M(o),S(!0))},[m]),P=s.useCallback(n=>{t!=="logistics"&&(M(n),D(!0))},[t]),R=s.useCallback(async n=>{if(!["admin","management"].includes(t||"")){y({title:"Permission denied",description:"Only admin and management users can delete jobs",variant:"destructive"});return}if(window.confirm("Are you sure you want to delete this job? This action cannot be undone and will remove all related data."))try{const o=await me(n);if(o.success)y({title:"Job deleted",description:o.details||"The job has been removed and cleanup is running in background."}),await J.invalidateQueries({queryKey:["optimized-jobs"]});else throw new Error(o.error||"Unknown deletion error")}catch(o){y({title:"Error deleting job",description:o.message,variant:"destructive"})}},[J,y,t]),X=s.useCallback(()=>{},[]),Y=s.useMemo(()=>ke(c,m),[c,m]);return h?e.jsx("div",{className:"flex min-h-screen items-center justify-center",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-b-2 border-gray-900 dark:border-white"})}):!t||!["admin","management","logistics"].includes(t)?null:f?e.jsxs(e.Fragment,{children:[e.jsx(s.Suspense,{fallback:r,children:e.jsx(ve,{jobs:m,date:c,onDateSelect:E,userRole:t,onEditClick:P,onDeleteClick:R,onJobClick:A,onMessagesClick:k?z:void 0,onEmailClick:k?L:void 0})}),u&&g?e.jsx(s.Suspense,{fallback:r,children:e.jsx(B,{open:g,onOpenChange:D,job:u})}):null,u&&O?e.jsx(s.Suspense,{fallback:r,children:e.jsx(Ce,{open:O,onOpenChange:S,job:u})}):null,j?e.jsx(s.Suspense,{fallback:r,children:e.jsx(q,{open:j,onOpenChange:v})}):null,_?e.jsx(s.Suspense,{fallback:r,children:e.jsx(H,{open:_,onOpenChange:C})}):null]}):e.jsx("div",{className:"min-h-screen bg-background text-foreground p-4 md:p-8 font-sans",children:e.jsxs("div",{className:"mx-auto w-full max-w-full space-y-6",children:[e.jsx(s.Suspense,{fallback:r,children:e.jsx(_e,{timeSpan:Q,onTimeSpanChange:G})}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-12 gap-6",children:[e.jsx("div",{className:"xl:col-span-8 2xl:col-span-9 space-y-6",children:e.jsx("div",{className:"bg-card rounded-xl border border-border overflow-hidden shadow-sm",children:e.jsx(s.Suspense,{fallback:r,children:e.jsx(ye,{date:c,onDateSelect:E,jobs:m,onDateTypeChange:X})})})}),e.jsxs("div",{className:"space-y-6 xl:col-span-4 2xl:col-span-3",children:[k&&e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(N,{variant:"outline",className:"bg-card border-border hover:bg-accent hover:text-accent-foreground text-foreground/80 h-auto py-4 flex flex-col gap-2",onClick:z,children:[e.jsx(ge,{className:"w-5 h-5 text-blue-500"}),e.jsx("span",{className:"text-xs font-medium",children:"Mensajes"})]}),e.jsxs(N,{variant:"outline",className:"bg-card border-border hover:bg-accent hover:text-accent-foreground text-foreground/80 h-auto py-4 flex flex-col gap-2",onClick:L,children:[e.jsx(je,{className:"w-5 h-5 text-emerald-500"}),e.jsx("span",{className:"text-xs font-medium",children:"Email"})]})]}),["admin","management","logistics"].includes(t)&&e.jsxs("div",{className:"bg-card rounded-xl border border-border overflow-hidden shadow-sm",children:[e.jsxs("div",{className:"p-4 border-b border-border flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-sm text-muted-foreground uppercase tracking-wider",children:"Gastos pendientes"}),e.jsx("p",{className:"text-xs text-muted-foreground/70",children:"Aprobaciones antes de continuar con los pagos"})]}),e.jsx(ce,{variant:"outline",className:"text-xs",children:(l==null?void 0:l.count)??0})]}),e.jsxs("div",{className:"p-4 space-y-3 text-sm text-muted-foreground",children:[W?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4 animate-spin"})," Calculando pendientes…"]}):l&&l.count>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between text-base font-semibold text-foreground",children:[e.jsx("span",{children:"Total por aprobar"}),e.jsx("span",{children:V(l.total)})]}),l.jobs.length>0&&e.jsx("div",{className:"space-y-1 text-xs text-muted-foreground",children:l.jobs.map(({jobId:n,amount:o})=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{children:["Job ",n.substring(0,8),"…"]}),e.jsx("span",{children:V(o)})]},n))})]}):e.jsx("div",{className:"text-xs text-muted-foreground",children:"No hay gastos pendientes de aprobación."}),e.jsx(N,{variant:"outline",size:"sm",className:"w-full",onClick:()=>a("/gastos"),children:"Ir a Gastos"})]})]}),e.jsxs("div",{className:"bg-card rounded-xl border border-border overflow-hidden shadow-sm",children:[e.jsxs("div",{className:"p-4 border-b border-border flex items-center justify-between",children:[e.jsx("h3",{className:"font-medium text-sm text-muted-foreground uppercase tracking-wider",children:"Agenda de Hoy"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:re(new Date,"d MMM")})]}),e.jsx("div",{className:"p-2",children:e.jsx(s.Suspense,{fallback:r,children:e.jsx(De,{jobs:Y,onEditClick:P,onDeleteClick:R,onJobClick:A,userRole:t,selectedDate:c,detailsOnlyMode:!0,hideTasks:!0,viewMode:"sidebar"})})})]})]})]}),u&&g?e.jsx(s.Suspense,{fallback:r,children:e.jsx(B,{open:g,onOpenChange:D,job:u})}):null,j?e.jsx(s.Suspense,{fallback:r,children:e.jsx(q,{open:j,onOpenChange:v})}):null,_?e.jsx(s.Suspense,{fallback:r,children:e.jsx(H,{open:_,onOpenChange:C})}):null]})})};export{qe as default};
