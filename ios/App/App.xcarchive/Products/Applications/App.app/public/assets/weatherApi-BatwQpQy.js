const y={0:{condition:"Despejado",icon:"â˜€ï¸"},1:{condition:"Mayormente despejado",icon:"ðŸŒ¤ï¸"},2:{condition:"Parcialmente nublado",icon:"â›…"},3:{condition:"Nublado",icon:"â˜ï¸"},45:{condition:"Niebla",icon:"ðŸŒ«ï¸"},48:{condition:"Niebla con escarcha",icon:"ðŸŒ«ï¸"},51:{condition:"Llovizna ligera",icon:"ðŸŒ¦ï¸"},53:{condition:"Llovizna moderada",icon:"ðŸŒ¦ï¸"},55:{condition:"Llovizna intensa",icon:"ðŸŒ§ï¸"},61:{condition:"Lluvia ligera",icon:"ðŸŒ§ï¸"},63:{condition:"Lluvia moderada",icon:"ðŸŒ§ï¸"},65:{condition:"Lluvia intensa",icon:"â›ˆï¸"},71:{condition:"Nieve ligera",icon:"ðŸŒ¨ï¸"},73:{condition:"Nieve moderada",icon:"â„ï¸"},75:{condition:"Nieve intensa",icon:"â„ï¸"},80:{condition:"Chubascos ligeros",icon:"ðŸŒ¦ï¸"},81:{condition:"Chubascos moderados",icon:"ðŸŒ§ï¸"},82:{condition:"Chubascos intensos",icon:"â›ˆï¸"},95:{condition:"Tormenta",icon:"â›ˆï¸"},96:{condition:"Tormenta con granizo ligero",icon:"â›ˆï¸"},99:{condition:"Tormenta con granizo intenso",icon:"â›ˆï¸"}},w=new Map,f=1800*1e3,D=new Map,I=async e=>{if(!(e!=null&&e.trim()))return null;const i=e.toLowerCase().trim(),t=D.get(i);if(t&&Date.now()-t.timestamp<f)return t.data;try{const a=encodeURIComponent(e),o=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${a}&limit=1&addressdetails=1`,{headers:{"User-Agent":"HojaDeRuta-WeatherApp/1.0"}});if(!o.ok)throw new Error(`Geocoding failed: ${o.status}`);const n=await o.json();if(n&&n.length>0){const r={lat:parseFloat(n[0].lat),lng:parseFloat(n[0].lon),display_name:n[0].display_name};return D.set(i,{data:r,timestamp:Date.now()}),r}return null}catch{return null}},_=async(e,i,t,a)=>{const o=d=>d.toISOString().split("T")[0],n=o(t),r=o(a),l=`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${i}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode&timezone=auto&start_date=${n}&end_date=${r}`,s=await fetch(l);if(!s.ok){let d="";try{d=await s.text()}catch{}throw new Error(`Weather API failed: ${s.status}${d?` - ${d}`:""}`)}const c=await s.json();return c.daily.time.map((d,m)=>{var h,g;const u=c.daily.weathercode[m],p=y[u]||{condition:"Condiciones variables",icon:"ðŸŒ¤ï¸"};return{date:d,condition:p.condition,weatherCode:u,maxTemp:Math.round(c.daily.temperature_2m_max[m]),minTemp:Math.round(c.daily.temperature_2m_min[m]),precipitationProbability:(((g=(h=c.daily)==null?void 0:h.precipitation_sum)==null?void 0:g[m])||0)>0?100:0,icon:p.icon}})},$=e=>{if(!(e!=null&&e.trim()))return null;try{const i=e.trim(),t=i.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/),a=i.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4}).*?(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);if(a){const n=new Date(parseInt(a[3]),parseInt(a[2])-1,parseInt(a[1])),r=new Date(parseInt(a[6]),parseInt(a[5])-1,parseInt(a[4]));return{startDate:n,endDate:r}}else if(t){const n=new Date(parseInt(t[3]),parseInt(t[2])-1,parseInt(t[1]));return{startDate:n,endDate:n}}const o=new Date(i);return isNaN(o.getTime())?null:{startDate:o,endDate:o}}catch{return null}},C=async(e,i)=>{try{const t=$(i);if(!t)return null;const a=new Date,o=new Date(a);if(o.setDate(o.getDate()+16),t.startDate>o)return null;t.endDate>o&&(t.endDate=o);let n=null;if(e.coordinates)n=e.coordinates;else if(e.address){const c=await I(e.address);c&&(n={lat:c.lat,lng:c.lng})}if(!n)return null;const r=`${n.lat},${n.lng},${t.startDate.toISOString()},${t.endDate.toISOString()}`,l=w.get(r);if(l&&Date.now()-l.timestamp<f)return l.data;const s=await _(n.lat,n.lng,t.startDate,t.endDate);return w.set(r,{data:s,timestamp:Date.now()}),s}catch{return null}};export{I as geocodeAddress,C as getWeatherForJob,$ as parseEventDates};
