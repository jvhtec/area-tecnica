import{e as fe,r as d,j as e,C as le,W as ne,Y as ie,A as B,I as x,B as g,V as be,L as b,S as je,t as ve,v as we,w as Ne,x as ye,s as D}from"./index-NZ6jJLfQ.js";import{u as _e}from"./useRoleGuard-DLTKaScw.js";import{C as de}from"./copy-Dez5r9kU.js";import{P as Ce}from"./plus-C3JQqq7t.js";import{R as Se}from"./rotate-ccw-DZI_fTg_.js";import{a as Ee,A as ke}from"./arrow-up-BTt-lBKB.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";const V={},Le="f3c98b2df1a4e7650fbd44c9ce19ab73c6d7a0e49b3f25ea18fd6740a2ce9b1d",h={overview:"Resumen de Trabajos",crew:"Asignaciones de Equipo",logistics:"Logística",calendar:"Calendario",pending:"Acciones Pendientes"},q=["overview","crew","logistics","calendar","pending"],T=r=>[...r].sort((u,m)=>u.slug.localeCompare(m.slug));function oe(r){const u=new Set,m=[];return(r??[]).forEach(i=>{const f=i;f in h&&!u.has(f)&&(m.push(f),u.add(f))}),m.length===0?[...q]:m}function c(r,u,m,i){return Number.isFinite(r)?r<u?u:r>m?m:Math.round(r):i}function N(r,u){var C;const m=(r||"").trim();if(m)return m;const i=typeof window<"u"&&((C=window.location)!=null&&C.origin)?window.location.origin:"",f=(V==null?void 0:V.VITE_WALLBOARD_TOKEN)||Le,j=((u==null?void 0:u.trim())||"default").toLowerCase();return`${i||""}/wallboard/public/${encodeURIComponent(f)}/${encodeURIComponent(j)}`}function ze(){_e(["admin","management"]);const{toast:r}=fe(),[u,m]=d.useState(!1),[i,f]=d.useState(!1),[j,C]=d.useState(!1),[v,R]=d.useState([]),[y,_]=d.useState(null),[K,M]=d.useState(null),z=d.useRef(!1),l=d.useMemo(()=>v.find(s=>s.slug===y)||null,[v,y]),[S,A]=d.useState(""),[O,U]=d.useState(""),[G,H]=d.useState(""),[Y,J]=d.useState(""),[Q,X]=d.useState(""),[w,E]=d.useState([...q]),[Z,I]=d.useState({overview:12,crew:12,docs:12,logistics:12,calendar:12,pending:12}),[k,F]=d.useState(12),[ee,W]=d.useState(300),[se,$]=d.useState(20);d.useEffect(()=>{(async()=>{m(!0);const{data:a,error:t}=await D.from("wallboard_presets").select("id, slug, name, description, display_url, panel_order, panel_durations, rotation_fallback_seconds, highlight_ttl_seconds, ticker_poll_interval_seconds, created_at, updated_at").order("slug",{ascending:!0});if(t)r({title:"Error al cargar configuraciones",description:t.message,variant:"destructive"});else{const n=a||[];R(T(n)),n.length>0&&_(o=>o??n[0].slug)}m(!1)})()},[r]),d.useEffect(()=>{!l||z.current||(A(l.slug),U(N(l.display_url,l.slug)),E(oe(l.panel_order)),I(s=>{const a={...s};return Object.keys(h).forEach(t=>{const n=(l.panel_durations||{})[t];a[t]=c(Number(n??l.rotation_fallback_seconds??12),1,600,12)}),a}),F(c(l.rotation_fallback_seconds??12,1,600,12)),W(c(l.highlight_ttl_seconds??300,30,3600,300)),$(c(l.ticker_poll_interval_seconds??20,10,600,20)))},[l]);const ae=(s,a)=>{E(t=>{const n=[...t],o=s+a;if(o<0||o>=n.length)return t;const[p]=n.splice(s,1);return n.splice(o,0,p),n})},ce=s=>{E(a=>a.filter(t=>t!==s))},ue=s=>{E(a=>a.includes(s)?a:[...a,s])},me=(s,a)=>{const t=c(Number(a),1,600,k??12);I(n=>({...n,[s]:t}))},pe=async()=>{if(!l)return;const s=S.trim(),a=N(O,s);if(!s){r({title:"Se requiere slug",description:"Proporcione un slug único para esta configuración de wallboard.",variant:"destructive"});return}if(!a){r({title:"Se requiere URL",description:"Agregue una URL de visualización para que el wallboard pueda compartirse (verifique VITE_WALLBOARD_TOKEN).",variant:"destructive"});return}f(!0),z.current=!0;const n={panel_order:w.length?w:[...q],panel_durations:Object.keys(h).reduce((o,p)=>(o[p]=c(Z[p]??k??12,1,600,12),o),{}),rotation_fallback_seconds:c(k,1,600,12),highlight_ttl_seconds:c(ee,30,3600,300),ticker_poll_interval_seconds:c(se,10,600,20),slug:s,display_url:a,updated_at:new Date().toISOString()};try{const{error:o}=await D.from("wallboard_presets").update(n).eq("id",l.id);if(o)r({title:"Error al guardar configuración",description:o.message,variant:"destructive"});else{r({title:"Configuración guardada"});const p=new Date().toISOString();A(s),U(a),_(s),R(L=>T(L.map(P=>P.id===l.id?{...P,...n,updated_at:p}:P)))}}catch{r({title:"Error al guardar configuración",description:"Error inesperado al guardar la configuración.",variant:"destructive"})}finally{f(!1),z.current=!1}},ge=()=>{l&&(A(l.slug),U(N(l.display_url,l.slug)),E(oe(l.panel_order)),I(s=>{const a={...s};return Object.keys(h).forEach(t=>{const n=(l.panel_durations||{})[t];a[t]=c(Number(n??l.rotation_fallback_seconds??12),1,600,12)}),a}),F(c(l.rotation_fallback_seconds??12,1,600,12)),W(c(l.highlight_ttl_seconds??300,30,3600,300)),$(c(l.ticker_poll_interval_seconds??20,10,600,20)))},re=Object.keys(h).filter(s=>!w.includes(s)),te=async(s,a)=>{const t=N(s,a||S||y||"default");try{if(typeof navigator>"u"||!navigator.clipboard)throw new Error("Clipboard API unavailable");await navigator.clipboard.writeText(t),r({title:"Copiado",description:"URL copiada al portapapeles."})}catch{r({title:"Error al copiar",description:"No se pudo copiar esta URL automáticamente.",variant:"destructive"})}},xe=async()=>{const s=G.trim(),a=Y.trim(),t=N(Q,a);if(!s||!a||!t){r({title:"Faltan detalles",description:"Se requieren nombre, slug y URL para crear un wallboard (verifique VITE_WALLBOARD_TOKEN).",variant:"destructive"});return}C(!0);const n={name:s,slug:a,description:null,display_url:t,panel_order:[...q],panel_durations:Object.keys(h).reduce((o,p)=>(o[p]=12,o),{}),rotation_fallback_seconds:12,highlight_ttl_seconds:300,ticker_poll_interval_seconds:20};try{const{data:o,error:p}=await D.from("wallboard_presets").insert(n).select("id, slug, name, description, display_url, panel_order, panel_durations, rotation_fallback_seconds, highlight_ttl_seconds, ticker_poll_interval_seconds, created_at, updated_at").single();if(p)r({title:"Error al crear",description:p.message,variant:"destructive"});else if(o){const L=o;r({title:"Wallboard creado",description:`${L.name} está listo para configurar.`}),R(P=>T([...P,L])),_(L.slug),H(""),J(""),X("")}}catch{r({title:"Error al crear",description:"Error inesperado al crear el wallboard.",variant:"destructive"})}finally{C(!1)}},he=async s=>{if(!(typeof window<"u"&&!window.confirm(`¿Eliminar wallboard "${s.name}"? Esta acción no se puede deshacer y cualquier pantalla que lo use dejará de actualizarse.`))){M(s.id);try{const{error:a}=await D.from("wallboard_presets").delete().eq("id",s.id);if(a)r({title:"Error al eliminar",description:a.message,variant:"destructive"});else{const t=T(v.filter(n=>n.id!==s.id));R(t),_(n=>n===s.slug?t.length>0?t[0].slug:null:n),r({title:"Wallboard eliminado",description:`${s.name} ha sido eliminado.`})}}catch{r({title:"Error al eliminar",description:"Error inesperado al eliminar el wallboard.",variant:"destructive"})}finally{M(null)}}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Configuraciones de Wallboard"}),e.jsx("p",{className:"text-muted-foreground",children:"Configure el orden de rotación y el tiempo para los paneles del wallboard. Los cambios se aplican inmediatamente para los usuarios que referencian la configuración seleccionada."})]}),e.jsxs(le,{children:[e.jsx(ne,{children:e.jsxs("div",{children:[e.jsx(ie,{className:"text-xl",children:"Wallboards"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Administre los slugs de configuración y las URLs de visualización para cada pantalla de wallboard."})]})}),e.jsxs(B,{className:"space-y-6",children:[e.jsx("div",{className:"space-y-3",children:v.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No hay wallboards configurados aún."}):v.map(s=>e.jsxs("div",{className:"flex flex-col gap-3 rounded-md border p-3 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Slug: ",s.slug]})]}),e.jsxs("div",{className:"flex flex-col gap-2 md:w-[28rem]",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[e.jsx(x,{readOnly:!0,value:N(s.display_url,s.slug),className:"flex-1"}),e.jsxs(g,{type:"button",variant:"outline",size:"sm",onClick:()=>te(s.display_url,s.slug),children:[e.jsx(de,{className:"mr-2 h-4 w-4"})," Copiar URL"]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 justify-end",children:[e.jsx(g,{type:"button",variant:"secondary",size:"sm",onClick:()=>_(s.slug),disabled:y===s.slug||i,children:"Editar configuración"}),e.jsx(g,{type:"button",variant:"destructive",size:"sm",onClick:()=>he(s),disabled:K===s.id||i||j,children:K===s.id?"Eliminando…":e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4"})," Eliminar"]})})]})]})]},s.id))}),e.jsxs("div",{className:"space-y-4 rounded-md border border-dashed p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-base font-semibold",children:[e.jsx(Ce,{className:"h-4 w-4"})," Agregar nuevo wallboard"]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"new-wallboard-name",children:"Nombre"}),e.jsx(x,{id:"new-wallboard-name",value:G,onChange:s=>H(s.target.value),placeholder:"Piso de Producción",disabled:j})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"new-wallboard-slug",children:"Slug"}),e.jsx(x,{id:"new-wallboard-slug",value:Y,onChange:s=>J(s.target.value),placeholder:"piso-produccion",disabled:j}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Se usa para referenciar la configuración en las URLs."})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(b,{htmlFor:"new-wallboard-url",children:"URL de Visualización"}),e.jsx(x,{id:"new-wallboard-url",value:Q,onChange:s=>X(s.target.value),placeholder:"https://ejemplo.com/wallboard/piso-produccion",disabled:j}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Envíe este enlace al dispositivo que muestra el wallboard."})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(g,{type:"button",onClick:xe,disabled:j,children:j?"Creando…":"Crear wallboard"})})]})]})]}),e.jsxs(le,{children:[e.jsxs(ne,{className:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx(ie,{className:"text-xl",children:"Configuración"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Seleccione una configuración existente para revisar o actualizar."})]}),e.jsx("div",{className:"w-full md:w-64",children:e.jsxs(je,{value:y??void 0,onValueChange:_,disabled:u,children:[e.jsx(ve,{children:e.jsx(we,{placeholder:u?"Cargando…":"Elegir configuración"})}),e.jsx(Ne,{children:v.map(s=>e.jsxs(ye,{value:s.slug,children:[s.name," (",s.slug,")"]},s.id))})]})})]}),l&&e.jsxs(B,{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"preset-slug",children:"Slug de configuración"}),e.jsx(x,{id:"preset-slug",value:S,onChange:s=>A(s.target.value),placeholder:"piso-produccion",disabled:i}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Debe ser único y actualizará la ruta del wallboard."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"preset-display-url",children:"URL de Visualización"}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[e.jsx(x,{id:"preset-display-url",value:O,onChange:s=>U(s.target.value),placeholder:"https://ejemplo.com/wallboard/public/TOKEN/slug"}),e.jsxs(g,{type:"button",variant:"outline",size:"sm",onClick:()=>te(O,S||y||"default"),children:[e.jsx(de,{className:"mr-2 h-4 w-4"})," Copiar"]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["URL pública resultante:"," ",e.jsx("span",{className:"font-mono break-all",children:N(O,S)}),". Comparta este enlace con cualquier dispositivo que deba mostrar el wallboard."]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Orden de Paneles"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(g,{variant:"outline",size:"sm",onClick:ge,disabled:i,children:[e.jsx(Se,{className:"mr-2 h-4 w-4"})," Restablecer"]}),e.jsx(g,{onClick:pe,disabled:i,children:i?"Guardando…":"Guardar Cambios"})]})]}),e.jsxs("div",{className:"space-y-3",children:[w.map((s,a)=>e.jsxs("div",{className:"flex flex-col gap-3 rounded-md border p-3 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-medium",children:h[s]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(g,{type:"button",variant:"ghost",size:"icon",onClick:()=>ae(a,-1),disabled:a===0||i,"aria-label":`Move ${h[s]} up`,children:e.jsx(Ee,{className:"h-4 w-4"})}),e.jsx(g,{type:"button",variant:"ghost",size:"icon",onClick:()=>ae(a,1),disabled:a===w.length-1||i,"aria-label":`Move ${h[s]} down`,children:e.jsx(ke,{className:"h-4 w-4"})}),e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>ce(s),disabled:w.length<=1||i,children:"Eliminar"})]})]}),e.jsxs("div",{className:"flex flex-col items-start gap-1 md:flex-row md:items-center",children:[e.jsx(b,{htmlFor:`${s}-duration`,className:"text-sm text-muted-foreground",children:"Duración (segundos)"}),e.jsx(x,{id:`${s}-duration`,type:"number",min:1,max:600,value:Z[s]??k,onChange:t=>me(s,t.target.value),className:"w-28",disabled:i})]})]},s)),w.length===0&&e.jsx("div",{className:"rounded-md border border-dashed p-6 text-center text-sm text-muted-foreground",children:"No hay paneles seleccionados. Agregue un panel desde el menú desplegable a continuación."})]}),re.length>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Agregar panel:"}),re.map(s=>e.jsx(g,{type:"button",variant:"secondary",size:"sm",onClick:()=>ue(s),disabled:i,children:h[s]},s))]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"fallback-seconds",children:"Rotación de respaldo (segundos)"}),e.jsx(x,{id:"fallback-seconds",type:"number",min:1,max:600,value:k,onChange:s=>F(c(Number(s.target.value),1,600,12)),disabled:i}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Se usa cuando un panel no tiene una duración o se requiere tiempo de respaldo."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"highlight-seconds",children:"TTL de resaltado (segundos)"}),e.jsx(x,{id:"highlight-seconds",type:"number",min:30,max:3600,value:ee,onChange:s=>W(c(Number(s.target.value),30,3600,300)),disabled:i}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Controla cuánto tiempo permanecen resaltados los trabajos."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"ticker-seconds",children:"Actualización del ticker (segundos)"}),e.jsx(x,{id:"ticker-seconds",type:"number",min:10,max:600,value:se,onChange:s=>$(c(Number(s.target.value),10,600,20)),disabled:i}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Con qué frecuencia el ticker de anuncios recarga los mensajes."})]})]})]}),!l&&!u&&v.length===0&&e.jsx(B,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"No hay configuraciones disponibles aún."})})]})]})}export{ze as default};
