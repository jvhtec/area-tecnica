import{e as T,m as R,r as $,f as P,s as f,n as w}from"./index-NZ6jJLfQ.js";import{u as k}from"./useRealtimeQuery-DRd58t-I.js";import{u as z}from"./useQuery-kdg2pmgf.js";const E=()=>{const{toast:r}=T();return{manageFlexCrewAssignment:async(u,_,a,d)=>{try{const{data:l,error:g}=await R.functions.invoke("manage-flex-crew-assignments",{body:{job_id:u,technician_id:_,department:a,action:d}});return g?(r({title:"Error",description:`Failed to ${d} crew assignment: ${g.message}`,variant:"destructive"}),!1):l!=null&&l.error?(r({title:"Error",description:`Failed to ${d} crew assignment: ${l.error}`,variant:"destructive"}),!1):(l!=null&&l.message&&!l.message.includes("skipped")&&!l.message.includes("already exists")&&!l.message.includes("No assignment to remove")&&r({title:"Success",description:`Successfully ${d==="add"?"added to":"removed from"} Flex crew call`}),!0)}catch{return r({title:"Error",description:`Failed to ${d} crew assignment`,variant:"destructive"}),!1}},useCrewCallData:(u,_)=>z({queryKey:["crew-call-data",u,_],queryFn:async()=>{if(!u||!_)return null;const{data:a,error:d}=await R.from("flex_crew_calls").select("flex_element_id").eq("job_id",u).eq("department",_).maybeSingle();return d?null:a},enabled:!!u&&!!_})}},K=(r,F,q,u,_,a)=>{const d=q!=="none"?q:null,l=u!=="none"?u:null,g=!!(a!=null&&a.singleDay)&&!!(a!=null&&a.singleDayDate),p=!!(a!=null&&a.addAsConfirmed);return{job_id:r,technician_id:F,sound_role:d,lights_role:l,assigned_by:_,assigned_at:new Date().toISOString(),status:p?"confirmed":"invited",response_time:p?new Date().toISOString():null,single_day:g,assignment_date:g?(a==null?void 0:a.singleDayDate)??null:null}},W=r=>{const[F,q]=$.useState(!1),[u,_]=$.useState({}),a=P(),{data:d=[],isLoading:l,manualRefresh:g,isRefreshing:p}=k(["job-assignments",r],async()=>{const i=async(n=3)=>{try{const{data:h,error:t}=await f.from("timesheets").select(`
              job_id,
              technician_id,
              date,
              profiles!fk_timesheets_technician_id (
                first_name,
                last_name,
                email,
                department
              )
            `).eq("job_id",r).eq("is_active",!0).not("is_schedule_only","is",!0);let o=[];if((t==null?void 0:t.code)==="PGRST200"||(t==null?void 0:t.code)==="PGRST301"||(t==null?void 0:t.code)==="42501")try{const{data:s,error:e}=await f.rpc("get_timesheet_amounts_visible").eq("job_id",r);!e&&Array.isArray(s)&&(o=s)}catch{}const m=[...h||[],...o];if(t&&!o.length)throw t;const A=s=>Array.isArray(s)?s[0]:s,c=new Map;for(const s of m){const e=s==null?void 0:s.technician_id;if(!e)continue;c.has(e)||c.set(e,{profile:A(s==null?void 0:s.profiles)??null,dates:new Set});const b=c.get(e);!b.profile&&(s!=null&&s.profiles)&&(b.profile=A(s.profiles)),s!=null&&s.date&&b.dates.add(s.date)}const D=Array.from(c.keys());if(D.length===0)return[];const{data:y,error:v}=await f.from("job_assignments").select(`
              technician_id,
              sound_role,
              lights_role,
              video_role,
              status,
              single_day,
              assignment_date,
              assigned_at,
              assigned_by,
              profiles (
                first_name,
                last_name,
                email,
                department
              )
            `).eq("job_id",r).in("technician_id",D),S=new Map((y||[]).map(s=>[s.technician_id,{...s,profiles:A(s==null?void 0:s.profiles)}]));return D.map(s=>{const e=S.get(s),b=c.get(s),Q=b?Array.from(b.dates).sort():[];return{job_id:r,technician_id:s,profiles:(e==null?void 0:e.profiles)||(b==null?void 0:b.profile),sound_role:e==null?void 0:e.sound_role,lights_role:e==null?void 0:e.lights_role,video_role:e==null?void 0:e.video_role,status:e==null?void 0:e.status,single_day:e==null?void 0:e.single_day,assignment_date:e==null?void 0:e.assignment_date,assigned_at:e==null?void 0:e.assigned_at,assigned_by:e==null?void 0:e.assigned_by,_timesheet_dates:Q}})}catch(h){if(n>0)return await new Promise(t=>setTimeout(t,1e3)),i(n-1);throw h}};return i()},"timesheets",{staleTime:1e3*60*2,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:!1});$.useEffect(()=>{if(!r)return;const i=f.channel(`assignments-${r}`).on("postgres_changes",{event:"*",schema:"public",table:"timesheets",filter:`job_id=eq.${r}`},n=>{g()}).on("postgres_changes",{event:"*",schema:"public",table:"job_assignments",filter:`job_id=eq.${r}`},n=>{g()}).subscribe();return()=>{f.removeChannel(i)}},[r,g,a]);const{manageFlexCrewAssignment:C}=E();return{assignments:d,isLoading:l,isRefreshing:F||p,refetch:async()=>{q(!0);try{await g(),w.success("Assignments refreshed")}catch{w.error("Failed to refresh assignments")}finally{q(!1)}},addAssignment:async(i,n,h,t)=>{var o;try{const{data:m}=await f.auth.getUser(),A=((o=m==null?void 0:m.user)==null?void 0:o.id)??null,c=K(r,i,n,h,A,t);a.setQueryData(["jobs"],y=>Array.isArray(y)?y.map(v=>{if(v.id!==r)return v;const S={job_id:r,technician_id:i,sound_role:c.sound_role,lights_role:c.lights_role,single_day:c.single_day,assignment_date:c.assignment_date??null,assigned_at:c.assigned_at,assigned_by:c.assigned_by,profiles:{first_name:"",last_name:""}},x=Array.isArray(v.job_assignments)?v.job_assignments:[];return{...v,job_assignments:[...x,S]}}):y);const{error:D}=await f.from("job_assignments").insert(c);if(D){w.error("Failed to add assignment");return}try{const{data:y}=await f.from("profiles").select("first_name, last_name").eq("id",i).single(),v=y?`${y.first_name??""} ${y.last_name??""}`.trim():void 0;f.functions.invoke("push",{body:{action:"broadcast",type:"job.assignment.direct",job_id:r,recipient_id:i,recipient_name:v||void 0,assignment_status:t!=null&&t.addAsConfirmed?"confirmed":"invited",target_date:t!=null&&t.singleDayDate?`${t.singleDayDate}T00:00:00Z`:void 0,single_day:(t==null?void 0:t.singleDay)||!1}})}catch{}n&&n!=="none"&&await C(r,i,"sound","add"),h&&h!=="none"&&await C(r,i,"lights","add"),w.success("Assignment added successfully"),a.invalidateQueries({queryKey:["optimized-jobs"]}),a.invalidateQueries({queryKey:["jobs"]})}catch{w.error("Failed to add assignment")}},removeAssignment:async i=>{try{_(o=>({...o,[i]:!0})),a.setQueryData(["jobs"],o=>Array.isArray(o)?o.map(m=>{if(m.id!==r)return m;const A=Array.isArray(m.job_assignments)?m.job_assignments:[];return{...m,job_assignments:A.filter(c=>c.technician_id!==i)}}):o);const n=d.find(o=>o.technician_id===i),{error:h}=await f.from("timesheets").delete().eq("job_id",r).eq("technician_id",i);if(h){w.error("Failed to remove assignment timesheets");return}const{error:t}=await f.from("job_assignments").delete().eq("job_id",r).eq("technician_id",i);if(t){w.error("Failed to remove assignment");return}n&&(n.sound_role&&n.sound_role!=="none"&&await C(r,i,"sound","remove"),n.lights_role&&n.lights_role!=="none"&&await C(r,i,"lights","remove")),w.success("Assignment removed successfully"),a.invalidateQueries({queryKey:["optimized-jobs"]}),a.invalidateQueries({queryKey:["jobs"]})}catch{w.error("Failed to remove assignment")}finally{_(n=>({...n,[i]:!1}))}},isRemoving:u}};export{E as a,W as u};
