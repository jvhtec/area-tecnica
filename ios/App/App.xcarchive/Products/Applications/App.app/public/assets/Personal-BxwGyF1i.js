var Rs=Object.defineProperty;var Ls=(n,r,t)=>r in n?Rs(n,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[r]=t;var w=(n,r,t)=>Ls(n,typeof r!="symbol"?r+"":r,t);import{l as He,al as qe,am as Me,an as Hs,ao as qs,ap as Ws,aq as zs,af as ft,ar as Zt,as as Ys,ae as Us,at as Vs,au as Jt,av as Bs,aw as Qs,ax as qt,ay as Xs,az as Wt,aA as Gs,a9 as Ks,j as e,D as jt,q as wt,F as Nt,G as Mt,i as C,B as W,X as Zs,aB as zt,M as Js,o as es,r as T,e as _t,s as L,Q as Ae,L as Ye,ab as kt,aC as ts,C as ue,A as me,P as bt,a2 as gt,W as dt,Y as ut,f as ea,I as Yt,ac as ta,a as sa,m as ss,a4 as Pe,d as Tt,u as aa,c as na}from"./index-NZ6jJLfQ.js";import{B as ke}from"./badge-vNTKF5RD.js";import{f as ra}from"./userName-BCcvOtN-.js";import{U as ia}from"./user-E3OATBQk.js";import{B as Ue}from"./briefcase-BrpPecAy.js";import{P as oa}from"./phone-BlFwiuho.js";import{C as Dt}from"./clock-BXPvTWvY.js";import{C as Re}from"./calendar-_Cj_Sgy-.js";import{P as nt}from"./plane-NSG-_bNT.js";import{H as ze}from"./house-CkarjnP3.js";import{s as Ct}from"./subDays-D4REtaCB.js";import{a as Ke,s as Le}from"./startOfMonth-B5dVCv8B.js";import{e as Fe}from"./endOfMonth-Byhxb84j.js";import{C as yt}from"./checkbox-BsRNEGV1.js";import{P as Ve}from"./printer-De77t3j8.js";import{T as xt,l as la}from"./lazyXlsx-BrFBF17_.js";import{l as as}from"./lazyPdf-xVUlxKNu.js";import{i as ns}from"./isWeekend-Du4Xt_tj.js";import{e as rs}from"./endOfYear-D08D-xBX.js";import{s as is,e as os,a as ls}from"./endOfQuarter-BH4-YKz9.js";import{a as rt}from"./addMonths-j-Bb577B.js";import{e as $t}from"./eachDayOfInterval-CPmiA2bk.js";import{i as Ge}from"./isSameMonth-BQ4F6s8O.js";import{i as it}from"./isSameDay-m1OvdnsV.js";import{C as Be}from"./chevron-left-rq2ui83a.js";import{C as Qe}from"./chevron-right-Bn7Eu0F7.js";import{U as Ee}from"./users-DMnpVLUq.js";import{S as ca}from"./sun-DEWOIVS5.js";import{C as da}from"./car-vrO_NvCk.js";import{i as cs}from"./isToday-BbpdYtC3.js";import{C as ua,a as ma,b as xa,c as ha,d as pa,e as fa,f as Se,g as ba}from"./context-menu-DYP7Nyzl.js";import{T as ds}from"./tree-palm-s3dDhxOJ.js";import{T as ga}from"./triangle-alert-D6qN0F8g.js";import{L as ya}from"./lightbulb-BU2ctenD.js";import{T as va}from"./truck-Br5sduv3.js";import{T as us,a as ms,b as ot,c as pe,d as xs,e as fe}from"./table-DnQAmABX.js";import{H as ja,a as wa,b as Na}from"./hover-card-BMjtHitm.js";import{T as Ut,a as Vt,b as tt,c as st}from"./tabs-BdaywI_b.js";import{u as ht}from"./useQuery-kdg2pmgf.js";import{u as pt}from"./useMutation-DluhVBs1.js";import{C as lt}from"./calendar-days-DcwEz6pd.js";import{D as vt}from"./download-C1rVE0-J.js";import{S as Bt}from"./send-Uvkx0r_O.js";import{C as hs}from"./circle-x-DDzV-xk_.js";import{C as ps}from"./circle-check-big-CilmNGCn.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./constructNow-u0VlpghF.js";import"./index-D9TsP8oP.js";import"./index-hC3MxXep.js";import"./circle-CWxDyDxx.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const At=He("CalendarOff",[["path",{d:"M4.2 4.2A2 2 0 0 0 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 1.82-1.18",key:"16swn3"}],["path",{d:"M21 15.5V6a2 2 0 0 0-2-2H9.5",key:"yhw86o"}],["path",{d:"M16 2v4",key:"4m81vk"}],["path",{d:"M3 10h7",key:"1wap6i"}],["path",{d:"M21 10h-5.5",key:"quycpq"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qt=He("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pt=He("Stethoscope",[["path",{d:"M11 2v2",key:"1539x4"}],["path",{d:"M5 2v2",key:"1yf1q8"}],["path",{d:"M5 3H4a2 2 0 0 0-2 2v4a6 6 0 0 0 12 0V5a2 2 0 0 0-2-2h-1",key:"rb5t3r"}],["path",{d:"M8 15a6 6 0 0 0 12 0v-3",key:"x18d4x"}],["circle",{cx:"20",cy:"10",r:"2",key:"ts1r5v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ma=He("Thermometer",[["path",{d:"M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z",key:"17jzev"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _a=He("Volume2",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Et=He("Warehouse",[["path",{d:"M22 8.35V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8.35A2 2 0 0 1 3.26 6.5l8-3.2a2 2 0 0 1 1.48 0l8 3.2A2 2 0 0 1 22 8.35Z",key:"gksnxg"}],["path",{d:"M6 18h12",key:"9pbo8z"}],["path",{d:"M6 14h12",key:"4cwo0f"}],["rect",{width:"12",height:"12",x:"6",y:"10",key:"apd30q"}]]);function ka(n){let t=qe(n).getDay();return t===0&&(t=7),t}function Ta(n,r){const t=r instanceof Date?Me(r,0):new r(0);return t.setFullYear(n.getFullYear(),n.getMonth(),n.getDate()),t.setHours(n.getHours(),n.getMinutes(),n.getSeconds(),n.getMilliseconds()),t}const Da=10;class fs{constructor(){w(this,"subPriority",0)}validate(r,t){return!0}}class Ca extends fs{constructor(r,t,s,a,i){super(),this.value=r,this.validateValue=t,this.setValue=s,this.priority=a,i&&(this.subPriority=i)}validate(r,t){return this.validateValue(r,this.value,t)}set(r,t,s){return this.setValue(r,t,this.value,s)}}class $a extends fs{constructor(){super(...arguments);w(this,"priority",Da);w(this,"subPriority",-1)}set(t,s){return s.timestampIsSet?t:Me(t,Ta(t,Date))}}class B{run(r,t,s,a){const i=this.parse(r,t,s,a);return i?{setter:new Ca(i.value,this.validate,this.set,this.priority,this.subPriority),rest:i.rest}:null}validate(r,t,s){return!0}}class Aa extends B{constructor(){super(...arguments);w(this,"priority",140);w(this,"incompatibleTokens",["R","u","t","T"])}parse(t,s,a){switch(s){case"G":case"GG":case"GGG":return a.era(t,{width:"abbreviated"})||a.era(t,{width:"narrow"});case"GGGGG":return a.era(t,{width:"narrow"});case"GGGG":default:return a.era(t,{width:"wide"})||a.era(t,{width:"abbreviated"})||a.era(t,{width:"narrow"})}}set(t,s,a){return s.era=a,t.setFullYear(a,0,1),t.setHours(0,0,0,0),t}}const le={month:/^(1[0-2]|0?\d)/,date:/^(3[0-1]|[0-2]?\d)/,dayOfYear:/^(36[0-6]|3[0-5]\d|[0-2]?\d?\d)/,week:/^(5[0-3]|[0-4]?\d)/,hour23h:/^(2[0-3]|[0-1]?\d)/,hour24h:/^(2[0-4]|[0-1]?\d)/,hour11h:/^(1[0-1]|0?\d)/,hour12h:/^(1[0-2]|0?\d)/,minute:/^[0-5]?\d/,second:/^[0-5]?\d/,singleDigit:/^\d/,twoDigits:/^\d{1,2}/,threeDigits:/^\d{1,3}/,fourDigits:/^\d{1,4}/,anyDigitsSigned:/^-?\d+/,singleDigitSigned:/^-?\d/,twoDigitsSigned:/^-?\d{1,2}/,threeDigitsSigned:/^-?\d{1,3}/,fourDigitsSigned:/^-?\d{1,4}/},Te={basicOptionalMinutes:/^([+-])(\d{2})(\d{2})?|Z/,basic:/^([+-])(\d{2})(\d{2})|Z/,basicOptionalSeconds:/^([+-])(\d{2})(\d{2})((\d{2}))?|Z/,extended:/^([+-])(\d{2}):(\d{2})|Z/,extendedOptionalSeconds:/^([+-])(\d{2}):(\d{2})(:(\d{2}))?|Z/};function ce(n,r){return n&&{value:r(n.value),rest:n.rest}}function se(n,r){const t=r.match(n);return t?{value:parseInt(t[0],10),rest:r.slice(t[0].length)}:null}function De(n,r){const t=r.match(n);if(!t)return null;if(t[0]==="Z")return{value:0,rest:r.slice(1)};const s=t[1]==="+"?1:-1,a=t[2]?parseInt(t[2],10):0,i=t[3]?parseInt(t[3],10):0,c=t[5]?parseInt(t[5],10):0;return{value:s*(a*Hs+i*qs+c*Ws),rest:r.slice(t[0].length)}}function bs(n){return se(le.anyDigitsSigned,n)}function re(n,r){switch(n){case 1:return se(le.singleDigit,r);case 2:return se(le.twoDigits,r);case 3:return se(le.threeDigits,r);case 4:return se(le.fourDigits,r);default:return se(new RegExp("^\\d{1,"+n+"}"),r)}}function ct(n,r){switch(n){case 1:return se(le.singleDigitSigned,r);case 2:return se(le.twoDigitsSigned,r);case 3:return se(le.threeDigitsSigned,r);case 4:return se(le.fourDigitsSigned,r);default:return se(new RegExp("^-?\\d{1,"+n+"}"),r)}}function Ft(n){switch(n){case"morning":return 4;case"evening":return 17;case"pm":case"noon":case"afternoon":return 12;case"am":case"midnight":case"night":default:return 0}}function gs(n,r){const t=r>0,s=t?r:1-r;let a;if(s<=50)a=n||100;else{const i=s+50,c=Math.trunc(i/100)*100,g=n>=i%100;a=n+c-(g?100:0)}return t?a:1-a}function ys(n){return n%400===0||n%4===0&&n%100!==0}class Pa extends B{constructor(){super(...arguments);w(this,"priority",130);w(this,"incompatibleTokens",["Y","R","u","w","I","i","e","c","t","T"])}parse(t,s,a){const i=c=>({year:c,isTwoDigitYear:s==="yy"});switch(s){case"y":return ce(re(4,t),i);case"yo":return ce(a.ordinalNumber(t,{unit:"year"}),i);default:return ce(re(s.length,t),i)}}validate(t,s){return s.isTwoDigitYear||s.year>0}set(t,s,a){const i=t.getFullYear();if(a.isTwoDigitYear){const g=gs(a.year,i);return t.setFullYear(g,0,1),t.setHours(0,0,0,0),t}const c=!("era"in s)||s.era===1?a.year:1-a.year;return t.setFullYear(c,0,1),t.setHours(0,0,0,0),t}}class Ea extends B{constructor(){super(...arguments);w(this,"priority",130);w(this,"incompatibleTokens",["y","R","u","Q","q","M","L","I","d","D","i","t","T"])}parse(t,s,a){const i=c=>({year:c,isTwoDigitYear:s==="YY"});switch(s){case"Y":return ce(re(4,t),i);case"Yo":return ce(a.ordinalNumber(t,{unit:"year"}),i);default:return ce(re(s.length,t),i)}}validate(t,s){return s.isTwoDigitYear||s.year>0}set(t,s,a,i){const c=zs(t,i);if(a.isTwoDigitYear){const d=gs(a.year,c);return t.setFullYear(d,0,i.firstWeekContainsDate),t.setHours(0,0,0,0),ft(t,i)}const g=!("era"in s)||s.era===1?a.year:1-a.year;return t.setFullYear(g,0,i.firstWeekContainsDate),t.setHours(0,0,0,0),ft(t,i)}}class Fa extends B{constructor(){super(...arguments);w(this,"priority",130);w(this,"incompatibleTokens",["G","y","Y","u","Q","q","M","L","w","d","D","e","c","t","T"])}parse(t,s){return ct(s==="R"?4:s.length,t)}set(t,s,a){const i=Me(t,0);return i.setFullYear(a,0,4),i.setHours(0,0,0,0),Zt(i)}}class Ia extends B{constructor(){super(...arguments);w(this,"priority",130);w(this,"incompatibleTokens",["G","y","Y","R","w","I","i","e","c","t","T"])}parse(t,s){return ct(s==="u"?4:s.length,t)}set(t,s,a){return t.setFullYear(a,0,1),t.setHours(0,0,0,0),t}}class Sa extends B{constructor(){super(...arguments);w(this,"priority",120);w(this,"incompatibleTokens",["Y","R","q","M","L","w","I","d","D","i","e","c","t","T"])}parse(t,s,a){switch(s){case"Q":case"QQ":return re(s.length,t);case"Qo":return a.ordinalNumber(t,{unit:"quarter"});case"QQQ":return a.quarter(t,{width:"abbreviated",context:"formatting"})||a.quarter(t,{width:"narrow",context:"formatting"});case"QQQQQ":return a.quarter(t,{width:"narrow",context:"formatting"});case"QQQQ":default:return a.quarter(t,{width:"wide",context:"formatting"})||a.quarter(t,{width:"abbreviated",context:"formatting"})||a.quarter(t,{width:"narrow",context:"formatting"})}}validate(t,s){return s>=1&&s<=4}set(t,s,a){return t.setMonth((a-1)*3,1),t.setHours(0,0,0,0),t}}class Oa extends B{constructor(){super(...arguments);w(this,"priority",120);w(this,"incompatibleTokens",["Y","R","Q","M","L","w","I","d","D","i","e","c","t","T"])}parse(t,s,a){switch(s){case"q":case"qq":return re(s.length,t);case"qo":return a.ordinalNumber(t,{unit:"quarter"});case"qqq":return a.quarter(t,{width:"abbreviated",context:"standalone"})||a.quarter(t,{width:"narrow",context:"standalone"});case"qqqqq":return a.quarter(t,{width:"narrow",context:"standalone"});case"qqqq":default:return a.quarter(t,{width:"wide",context:"standalone"})||a.quarter(t,{width:"abbreviated",context:"standalone"})||a.quarter(t,{width:"narrow",context:"standalone"})}}validate(t,s){return s>=1&&s<=4}set(t,s,a){return t.setMonth((a-1)*3,1),t.setHours(0,0,0,0),t}}class Ra extends B{constructor(){super(...arguments);w(this,"incompatibleTokens",["Y","R","q","Q","L","w","I","D","i","e","c","t","T"]);w(this,"priority",110)}parse(t,s,a){const i=c=>c-1;switch(s){case"M":return ce(se(le.month,t),i);case"MM":return ce(re(2,t),i);case"Mo":return ce(a.ordinalNumber(t,{unit:"month"}),i);case"MMM":return a.month(t,{width:"abbreviated",context:"formatting"})||a.month(t,{width:"narrow",context:"formatting"});case"MMMMM":return a.month(t,{width:"narrow",context:"formatting"});case"MMMM":default:return a.month(t,{width:"wide",context:"formatting"})||a.month(t,{width:"abbreviated",context:"formatting"})||a.month(t,{width:"narrow",context:"formatting"})}}validate(t,s){return s>=0&&s<=11}set(t,s,a){return t.setMonth(a,1),t.setHours(0,0,0,0),t}}class La extends B{constructor(){super(...arguments);w(this,"priority",110);w(this,"incompatibleTokens",["Y","R","q","Q","M","w","I","D","i","e","c","t","T"])}parse(t,s,a){const i=c=>c-1;switch(s){case"L":return ce(se(le.month,t),i);case"LL":return ce(re(2,t),i);case"Lo":return ce(a.ordinalNumber(t,{unit:"month"}),i);case"LLL":return a.month(t,{width:"abbreviated",context:"standalone"})||a.month(t,{width:"narrow",context:"standalone"});case"LLLLL":return a.month(t,{width:"narrow",context:"standalone"});case"LLLL":default:return a.month(t,{width:"wide",context:"standalone"})||a.month(t,{width:"abbreviated",context:"standalone"})||a.month(t,{width:"narrow",context:"standalone"})}}validate(t,s){return s>=0&&s<=11}set(t,s,a){return t.setMonth(a,1),t.setHours(0,0,0,0),t}}function Ha(n,r,t){const s=qe(n),a=Ys(s,t)-r;return s.setDate(s.getDate()-a*7),s}class qa extends B{constructor(){super(...arguments);w(this,"priority",100);w(this,"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","i","t","T"])}parse(t,s,a){switch(s){case"w":return se(le.week,t);case"wo":return a.ordinalNumber(t,{unit:"week"});default:return re(s.length,t)}}validate(t,s){return s>=1&&s<=53}set(t,s,a,i){return ft(Ha(t,a,i),i)}}function Wa(n,r){const t=qe(n),s=Us(t)-r;return t.setDate(t.getDate()-s*7),t}class za extends B{constructor(){super(...arguments);w(this,"priority",100);w(this,"incompatibleTokens",["y","Y","u","q","Q","M","L","w","d","D","e","c","t","T"])}parse(t,s,a){switch(s){case"I":return se(le.week,t);case"Io":return a.ordinalNumber(t,{unit:"week"});default:return re(s.length,t)}}validate(t,s){return s>=1&&s<=53}set(t,s,a){return Zt(Wa(t,a))}}const Ya=[31,28,31,30,31,30,31,31,30,31,30,31],Ua=[31,29,31,30,31,30,31,31,30,31,30,31];class Va extends B{constructor(){super(...arguments);w(this,"priority",90);w(this,"subPriority",1);w(this,"incompatibleTokens",["Y","R","q","Q","w","I","D","i","e","c","t","T"])}parse(t,s,a){switch(s){case"d":return se(le.date,t);case"do":return a.ordinalNumber(t,{unit:"date"});default:return re(s.length,t)}}validate(t,s){const a=t.getFullYear(),i=ys(a),c=t.getMonth();return i?s>=1&&s<=Ua[c]:s>=1&&s<=Ya[c]}set(t,s,a){return t.setDate(a),t.setHours(0,0,0,0),t}}class Ba extends B{constructor(){super(...arguments);w(this,"priority",90);w(this,"subpriority",1);w(this,"incompatibleTokens",["Y","R","q","Q","M","L","w","I","d","E","i","e","c","t","T"])}parse(t,s,a){switch(s){case"D":case"DD":return se(le.dayOfYear,t);case"Do":return a.ordinalNumber(t,{unit:"date"});default:return re(s.length,t)}}validate(t,s){const a=t.getFullYear();return ys(a)?s>=1&&s<=366:s>=1&&s<=365}set(t,s,a){return t.setMonth(0,a),t.setHours(0,0,0,0),t}}function It(n,r,t){var _,f,b,O;const s=Vs(),a=(t==null?void 0:t.weekStartsOn)??((f=(_=t==null?void 0:t.locale)==null?void 0:_.options)==null?void 0:f.weekStartsOn)??s.weekStartsOn??((O=(b=s.locale)==null?void 0:b.options)==null?void 0:O.weekStartsOn)??0,i=qe(n),c=i.getDay(),d=(r%7+7)%7,l=7-a,x=r<0||r>6?r-(c+l)%7:(d+l)%7-(c+l)%7;return Ke(i,x)}class Qa extends B{constructor(){super(...arguments);w(this,"priority",90);w(this,"incompatibleTokens",["D","i","e","c","t","T"])}parse(t,s,a){switch(s){case"E":case"EE":case"EEE":return a.day(t,{width:"abbreviated",context:"formatting"})||a.day(t,{width:"short",context:"formatting"})||a.day(t,{width:"narrow",context:"formatting"});case"EEEEE":return a.day(t,{width:"narrow",context:"formatting"});case"EEEEEE":return a.day(t,{width:"short",context:"formatting"})||a.day(t,{width:"narrow",context:"formatting"});case"EEEE":default:return a.day(t,{width:"wide",context:"formatting"})||a.day(t,{width:"abbreviated",context:"formatting"})||a.day(t,{width:"short",context:"formatting"})||a.day(t,{width:"narrow",context:"formatting"})}}validate(t,s){return s>=0&&s<=6}set(t,s,a,i){return t=It(t,a,i),t.setHours(0,0,0,0),t}}class Xa extends B{constructor(){super(...arguments);w(this,"priority",90);w(this,"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","E","i","c","t","T"])}parse(t,s,a,i){const c=g=>{const d=Math.floor((g-1)/7)*7;return(g+i.weekStartsOn+6)%7+d};switch(s){case"e":case"ee":return ce(re(s.length,t),c);case"eo":return ce(a.ordinalNumber(t,{unit:"day"}),c);case"eee":return a.day(t,{width:"abbreviated",context:"formatting"})||a.day(t,{width:"short",context:"formatting"})||a.day(t,{width:"narrow",context:"formatting"});case"eeeee":return a.day(t,{width:"narrow",context:"formatting"});case"eeeeee":return a.day(t,{width:"short",context:"formatting"})||a.day(t,{width:"narrow",context:"formatting"});case"eeee":default:return a.day(t,{width:"wide",context:"formatting"})||a.day(t,{width:"abbreviated",context:"formatting"})||a.day(t,{width:"short",context:"formatting"})||a.day(t,{width:"narrow",context:"formatting"})}}validate(t,s){return s>=0&&s<=6}set(t,s,a,i){return t=It(t,a,i),t.setHours(0,0,0,0),t}}class Ga extends B{constructor(){super(...arguments);w(this,"priority",90);w(this,"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","E","i","e","t","T"])}parse(t,s,a,i){const c=g=>{const d=Math.floor((g-1)/7)*7;return(g+i.weekStartsOn+6)%7+d};switch(s){case"c":case"cc":return ce(re(s.length,t),c);case"co":return ce(a.ordinalNumber(t,{unit:"day"}),c);case"ccc":return a.day(t,{width:"abbreviated",context:"standalone"})||a.day(t,{width:"short",context:"standalone"})||a.day(t,{width:"narrow",context:"standalone"});case"ccccc":return a.day(t,{width:"narrow",context:"standalone"});case"cccccc":return a.day(t,{width:"short",context:"standalone"})||a.day(t,{width:"narrow",context:"standalone"});case"cccc":default:return a.day(t,{width:"wide",context:"standalone"})||a.day(t,{width:"abbreviated",context:"standalone"})||a.day(t,{width:"short",context:"standalone"})||a.day(t,{width:"narrow",context:"standalone"})}}validate(t,s){return s>=0&&s<=6}set(t,s,a,i){return t=It(t,a,i),t.setHours(0,0,0,0),t}}function Ka(n,r){const t=qe(n),s=ka(t),a=r-s;return Ke(t,a)}class Za extends B{constructor(){super(...arguments);w(this,"priority",90);w(this,"incompatibleTokens",["y","Y","u","q","Q","M","L","w","d","D","E","e","c","t","T"])}parse(t,s,a){const i=c=>c===0?7:c;switch(s){case"i":case"ii":return re(s.length,t);case"io":return a.ordinalNumber(t,{unit:"day"});case"iii":return ce(a.day(t,{width:"abbreviated",context:"formatting"})||a.day(t,{width:"short",context:"formatting"})||a.day(t,{width:"narrow",context:"formatting"}),i);case"iiiii":return ce(a.day(t,{width:"narrow",context:"formatting"}),i);case"iiiiii":return ce(a.day(t,{width:"short",context:"formatting"})||a.day(t,{width:"narrow",context:"formatting"}),i);case"iiii":default:return ce(a.day(t,{width:"wide",context:"formatting"})||a.day(t,{width:"abbreviated",context:"formatting"})||a.day(t,{width:"short",context:"formatting"})||a.day(t,{width:"narrow",context:"formatting"}),i)}}validate(t,s){return s>=1&&s<=7}set(t,s,a){return t=Ka(t,a),t.setHours(0,0,0,0),t}}class Ja extends B{constructor(){super(...arguments);w(this,"priority",80);w(this,"incompatibleTokens",["b","B","H","k","t","T"])}parse(t,s,a){switch(s){case"a":case"aa":case"aaa":return a.dayPeriod(t,{width:"abbreviated",context:"formatting"})||a.dayPeriod(t,{width:"narrow",context:"formatting"});case"aaaaa":return a.dayPeriod(t,{width:"narrow",context:"formatting"});case"aaaa":default:return a.dayPeriod(t,{width:"wide",context:"formatting"})||a.dayPeriod(t,{width:"abbreviated",context:"formatting"})||a.dayPeriod(t,{width:"narrow",context:"formatting"})}}set(t,s,a){return t.setHours(Ft(a),0,0,0),t}}class en extends B{constructor(){super(...arguments);w(this,"priority",80);w(this,"incompatibleTokens",["a","B","H","k","t","T"])}parse(t,s,a){switch(s){case"b":case"bb":case"bbb":return a.dayPeriod(t,{width:"abbreviated",context:"formatting"})||a.dayPeriod(t,{width:"narrow",context:"formatting"});case"bbbbb":return a.dayPeriod(t,{width:"narrow",context:"formatting"});case"bbbb":default:return a.dayPeriod(t,{width:"wide",context:"formatting"})||a.dayPeriod(t,{width:"abbreviated",context:"formatting"})||a.dayPeriod(t,{width:"narrow",context:"formatting"})}}set(t,s,a){return t.setHours(Ft(a),0,0,0),t}}class tn extends B{constructor(){super(...arguments);w(this,"priority",80);w(this,"incompatibleTokens",["a","b","t","T"])}parse(t,s,a){switch(s){case"B":case"BB":case"BBB":return a.dayPeriod(t,{width:"abbreviated",context:"formatting"})||a.dayPeriod(t,{width:"narrow",context:"formatting"});case"BBBBB":return a.dayPeriod(t,{width:"narrow",context:"formatting"});case"BBBB":default:return a.dayPeriod(t,{width:"wide",context:"formatting"})||a.dayPeriod(t,{width:"abbreviated",context:"formatting"})||a.dayPeriod(t,{width:"narrow",context:"formatting"})}}set(t,s,a){return t.setHours(Ft(a),0,0,0),t}}class sn extends B{constructor(){super(...arguments);w(this,"priority",70);w(this,"incompatibleTokens",["H","K","k","t","T"])}parse(t,s,a){switch(s){case"h":return se(le.hour12h,t);case"ho":return a.ordinalNumber(t,{unit:"hour"});default:return re(s.length,t)}}validate(t,s){return s>=1&&s<=12}set(t,s,a){const i=t.getHours()>=12;return i&&a<12?t.setHours(a+12,0,0,0):!i&&a===12?t.setHours(0,0,0,0):t.setHours(a,0,0,0),t}}class an extends B{constructor(){super(...arguments);w(this,"priority",70);w(this,"incompatibleTokens",["a","b","h","K","k","t","T"])}parse(t,s,a){switch(s){case"H":return se(le.hour23h,t);case"Ho":return a.ordinalNumber(t,{unit:"hour"});default:return re(s.length,t)}}validate(t,s){return s>=0&&s<=23}set(t,s,a){return t.setHours(a,0,0,0),t}}class nn extends B{constructor(){super(...arguments);w(this,"priority",70);w(this,"incompatibleTokens",["h","H","k","t","T"])}parse(t,s,a){switch(s){case"K":return se(le.hour11h,t);case"Ko":return a.ordinalNumber(t,{unit:"hour"});default:return re(s.length,t)}}validate(t,s){return s>=0&&s<=11}set(t,s,a){return t.getHours()>=12&&a<12?t.setHours(a+12,0,0,0):t.setHours(a,0,0,0),t}}class rn extends B{constructor(){super(...arguments);w(this,"priority",70);w(this,"incompatibleTokens",["a","b","h","H","K","t","T"])}parse(t,s,a){switch(s){case"k":return se(le.hour24h,t);case"ko":return a.ordinalNumber(t,{unit:"hour"});default:return re(s.length,t)}}validate(t,s){return s>=1&&s<=24}set(t,s,a){const i=a<=24?a%24:a;return t.setHours(i,0,0,0),t}}class on extends B{constructor(){super(...arguments);w(this,"priority",60);w(this,"incompatibleTokens",["t","T"])}parse(t,s,a){switch(s){case"m":return se(le.minute,t);case"mo":return a.ordinalNumber(t,{unit:"minute"});default:return re(s.length,t)}}validate(t,s){return s>=0&&s<=59}set(t,s,a){return t.setMinutes(a,0,0),t}}class ln extends B{constructor(){super(...arguments);w(this,"priority",50);w(this,"incompatibleTokens",["t","T"])}parse(t,s,a){switch(s){case"s":return se(le.second,t);case"so":return a.ordinalNumber(t,{unit:"second"});default:return re(s.length,t)}}validate(t,s){return s>=0&&s<=59}set(t,s,a){return t.setSeconds(a,0),t}}class cn extends B{constructor(){super(...arguments);w(this,"priority",30);w(this,"incompatibleTokens",["t","T"])}parse(t,s){const a=i=>Math.trunc(i*Math.pow(10,-s.length+3));return ce(re(s.length,t),a)}set(t,s,a){return t.setMilliseconds(a),t}}class dn extends B{constructor(){super(...arguments);w(this,"priority",10);w(this,"incompatibleTokens",["t","T","x"])}parse(t,s){switch(s){case"X":return De(Te.basicOptionalMinutes,t);case"XX":return De(Te.basic,t);case"XXXX":return De(Te.basicOptionalSeconds,t);case"XXXXX":return De(Te.extendedOptionalSeconds,t);case"XXX":default:return De(Te.extended,t)}}set(t,s,a){return s.timestampIsSet?t:Me(t,t.getTime()-Jt(t)-a)}}class un extends B{constructor(){super(...arguments);w(this,"priority",10);w(this,"incompatibleTokens",["t","T","X"])}parse(t,s){switch(s){case"x":return De(Te.basicOptionalMinutes,t);case"xx":return De(Te.basic,t);case"xxxx":return De(Te.basicOptionalSeconds,t);case"xxxxx":return De(Te.extendedOptionalSeconds,t);case"xxx":default:return De(Te.extended,t)}}set(t,s,a){return s.timestampIsSet?t:Me(t,t.getTime()-Jt(t)-a)}}class mn extends B{constructor(){super(...arguments);w(this,"priority",40);w(this,"incompatibleTokens","*")}parse(t){return bs(t)}set(t,s,a){return[Me(t,a*1e3),{timestampIsSet:!0}]}}class xn extends B{constructor(){super(...arguments);w(this,"priority",20);w(this,"incompatibleTokens","*")}parse(t){return bs(t)}set(t,s,a){return[Me(t,a),{timestampIsSet:!0}]}}const hn={G:new Aa,y:new Pa,Y:new Ea,R:new Fa,u:new Ia,Q:new Sa,q:new Oa,M:new Ra,L:new La,w:new qa,I:new za,d:new Va,D:new Ba,E:new Qa,e:new Xa,c:new Ga,i:new Za,a:new Ja,b:new en,B:new tn,h:new sn,H:new an,K:new nn,k:new rn,m:new on,s:new ln,S:new cn,X:new dn,x:new un,t:new mn,T:new xn},pn=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,fn=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,bn=/^'([^]*?)'?$/,gn=/''/g,yn=/\S/,vn=/[a-zA-Z]/;function vs(n,r,t,s){var M,D,S,P;const a=Bs(),i=a.locale??Qs,c=a.firstWeekContainsDate??((D=(M=a.locale)==null?void 0:M.options)==null?void 0:D.firstWeekContainsDate)??1,g=a.weekStartsOn??((P=(S=a.locale)==null?void 0:S.options)==null?void 0:P.weekStartsOn)??0,d={firstWeekContainsDate:c,weekStartsOn:g,locale:i},l=[new $a],x=r.match(fn).map(j=>{const $=j[0];if($ in qt){const N=qt[$];return N(j,i.formatLong)}return j}).join("").match(pn),_=[];for(let j of x){Xs(j)&&Wt(j,r,n),Gs(j)&&Wt(j,r,n);const $=j[0],N=hn[$];if(N){const{incompatibleTokens:v}=N;if(Array.isArray(v)){const h=_.find(u=>v.includes(u.token)||u.token===$);if(h)throw new RangeError(`The format string mustn't contain \`${h.fullToken}\` and \`${j}\` at the same time`)}else if(N.incompatibleTokens==="*"&&_.length>0)throw new RangeError(`The format string mustn't contain \`${j}\` and any other token at the same time`);_.push({token:$,fullToken:j});const o=N.run(n,j,i.match,d);if(!o)return Me(t,NaN);l.push(o.setter),n=o.rest}else{if($.match(vn))throw new RangeError("Format string contains an unescaped latin alphabet character `"+$+"`");if(j==="''"?j="'":$==="'"&&(j=jn(j)),n.indexOf(j)===0)n=n.slice(j.length);else return Me(t,NaN)}}if(n.length>0&&yn.test(n))return Me(t,NaN);const f=l.map(j=>j.priority).sort((j,$)=>$-j).filter((j,$,N)=>N.indexOf(j)===$).map(j=>l.filter($=>$.priority===j).sort(($,N)=>N.subPriority-$.subPriority)).map(j=>j[0]);let b=qe(t);if(isNaN(b.getTime()))return Me(t,NaN);const O={};for(const j of f){if(!j.validate(b,d))return Me(t,NaN);const $=j.set(b,O,d);Array.isArray($)?(b=$[0],Object.assign(O,$[1])):b=$}return Me(t,b)}function jn(n){return n.match(bn)[1].replace(gn,"'")}const js=()=>{const{theme:n,setTheme:r}=Ks(),t=n==="dark"||n==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches;return{theme:{bg:t?"bg-[#05070a]":"bg-slate-50",nav:t?"bg-[#0f1219] border-t border-[#1f232e]":"bg-white border-t border-slate-200",card:t?"bg-[#0f1219] border-[#1f232e]":"bg-white border-slate-200 shadow-sm",textMain:t?"text-white":"text-slate-900",textMuted:t?"text-[#94a3b8]":"text-slate-500",accent:"bg-blue-600 hover:bg-blue-500 text-white",input:t?"bg-[#0a0c10] border-[#2a2e3b] text-white focus:border-blue-500":"bg-white border-slate-300 text-slate-900 focus:border-blue-500",modalOverlay:t?"bg-black/90 backdrop-blur-md":"bg-slate-900/40 backdrop-blur-md",divider:t?"border-[#1f232e]":"border-slate-100",danger:t?"text-red-400 bg-red-500/10 border-red-500/20":"text-red-700 bg-red-50 border-red-200",success:t?"text-emerald-400 bg-emerald-500/10 border-emerald-500/20":"text-emerald-700 bg-emerald-50 border-emerald-200",warning:t?"text-amber-400 bg-amber-500/10 border-amber-500/20":"text-amber-700 bg-amber-50 border-amber-200",cluster:t?"bg-white text-black":"bg-slate-900 text-white"},isDark:t,toggleTheme:()=>{r(t?"light":"dark")}}},ws=({open:n,onOpenChange:r,technician:t,assignment:s,date:a,availabilityStatus:i=null,onAvailabilityChange:c,onAvailabilityRemove:g})=>{const{theme:d,isDark:l}=js(),x=()=>ra(t.first_name,t.nickname,t.last_name)||"Unknown",_=()=>{if(!s)return null;const D=s.sound_role||s.lights_role||s.video_role;return D?es(D):null},f=()=>{var S,P;return`${((S=t.department)==null?void 0:S.charAt(0).toUpperCase())+((P=t.department)==null?void 0:P.slice(1))||"Unknown"} House Tech`},b=()=>{if(!i)return null;switch(i){case"vacation":return"On Vacation";case"travel":return"Traveling";case"sick":return"Sick Day";case"day_off":return"Day Off";case"unavailable":return"Unavailable";case"warehouse":return"In Warehouse";default:return null}},O=D=>{c&&(c(t.id,D,a),r(!1))},M=()=>{g&&(g(t.id,a),r(!1))};return e.jsx(jt,{open:n,onOpenChange:r,children:e.jsxs(wt,{className:`max-w-sm ${d.card} border-none shadow-xl`,children:[e.jsx(Nt,{children:e.jsxs(Mt,{className:`flex items-center gap-2 ${d.textMain}`,children:[e.jsx(ia,{className:"h-4 w-4 text-blue-500"}),x()]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:`text-sm flex items-center gap-2 ${d.textMuted}`,children:[e.jsx(Ue,{className:"h-3 w-3"}),f()]}),e.jsx(ke,{variant:i?"destructive":s?"default":"secondary",className:"text-xs",children:i?b():s?"Assigned":"Available"})]}),e.jsx("div",{className:`text-xs ${d.textMuted}`,children:C(a,"MMM d, yyyy")}),t.phone&&e.jsxs("div",{className:`flex items-center gap-2 text-sm ${d.textMain}`,children:[e.jsx(oa,{className:`h-3 w-3 ${d.textMuted}`}),e.jsx("span",{children:t.phone})]}),i?e.jsxs("div",{className:`border-t pt-2 ${d.divider}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("p",{className:`text-sm ${d.textMuted}`,children:[b()," on ",C(a,"MMM d, yyyy")]}),e.jsx(W,{variant:"ghost",size:"sm",onClick:M,className:`h-6 w-6 p-0 ${d.textMuted} hover:text-red-500`,children:e.jsx(Zs,{className:"h-3 w-3"})})]}),e.jsx("p",{className:"text-xs text-orange-600",children:"Not available for assignment"})]}):s?e.jsxs("div",{className:`space-y-2 border-t pt-2 ${d.divider}`,children:[e.jsx("h5",{className:`font-medium text-sm ${d.textMain}`,children:"Assignment Details"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:`rounded-lg p-2 ${l?"bg-slate-800/50":"bg-slate-100"}`,children:[e.jsx("p",{className:`text-sm font-medium ${d.textMain}`,children:s.job.title}),_()&&e.jsx("div",{className:"mt-1",children:e.jsx(ke,{variant:"outline",className:"text-xs",style:{borderColor:s.job.color||"#d1d5db",color:s.job.color||"#6b7280"},children:_()})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:`flex items-center gap-2 text-xs ${d.textMuted}`,children:[e.jsx(Dt,{className:"h-3 w-3"}),e.jsxs("span",{children:[zt(s.job.start_time,"HH:mm","Europe/Madrid")," - ",zt(s.job.end_time,"HH:mm","Europe/Madrid")]})]}),s.job.location&&e.jsxs("div",{className:`flex items-center gap-2 text-xs ${d.textMuted}`,children:[e.jsx(Js,{className:"h-3 w-3"}),e.jsx("span",{children:s.job.location.name})]}),s.job.status&&e.jsxs("div",{className:"text-xs",children:[e.jsx("span",{className:d.textMuted,children:"Status: "}),e.jsx("span",{className:`capitalize font-medium ${d.textMain}`,children:s.job.status})]})]})]})]}):e.jsxs("div",{className:`border-t pt-2 ${d.divider}`,children:[e.jsxs("p",{className:`text-sm ${d.textMuted}`,children:["No assignment for ",C(a,"MMM d, yyyy")]}),e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Available for assignment"})]}),!i&&!s&&e.jsxs("div",{className:`border-t pt-3 ${d.divider}`,children:[e.jsx("h5",{className:`font-medium text-sm mb-2 ${d.textMain}`,children:"Mark as Unavailable"}),e.jsx("div",{className:"grid grid-cols-1 gap-2",children:[{id:"vacation",label:"Vacation",icon:Re},{id:"travel",label:"Travel",icon:nt},{id:"sick",label:"Sick Day",icon:Pt},{id:"day_off",label:"Day Off",icon:ze},{id:"warehouse",label:"Mark as In Warehouse",icon:Et}].map(D=>e.jsxs(W,{variant:"outline",size:"sm",onClick:()=>O(D.id),className:`justify-start ${d.card} ${d.textMain} hover:bg-slate-100 dark:hover:bg-slate-800`,children:[e.jsx(D.icon,{className:"mr-2 h-3 w-3"}),D.label]},D.id))})]})]})]})})},Xe={data:{},listeners:new Set,subscribe(n){return this.listeners.add(n),()=>this.listeners.delete(n)},getSnapshot(){return this.data},setData(n){this.data=n,this.listeners.forEach(r=>r())},updateKey(n,r){if(r===null){const{[n]:t,...s}=this.data;this.data=s}else this.data={...this.data,[n]:r};this.listeners.forEach(t=>t())}},Ns=n=>{const[r,t]=T.useState(!0),{toast:s}=_t(),a=`${n.getFullYear()}-${n.getMonth()}`;T.useEffect(()=>{let d=!0;const l=async()=>{d&&t(!0);try{const M=C(new Date(n.getFullYear(),n.getMonth(),1),"yyyy-MM-dd"),D=C(new Date(n.getFullYear(),n.getMonth()+1,0),"yyyy-MM-dd"),{data:S,error:P}=await L.from("technician_availability").select("*").gte("date",M).lte("date",D);if(P)return;const{data:j,error:$}=await L.from("availability_schedules").select("*").gte("date",M).lte("date",D);if($)return;const N={};S==null||S.forEach(v=>{const o=`${v.technician_id}-${v.date}`;N[o]=v.status}),j==null||j.forEach(v=>{const o=`${v.user_id}-${v.date}`;v.status==="unavailable"&&(v.source==="vacation"?N[o]="vacation":v.source==="warehouse"?N[o]="warehouse":N[o]="unavailable")}),Xe.setData(N)}catch{}finally{d&&(t(!1),d=!1)}};l();let x;const _=()=>{clearTimeout(x),x=setTimeout(()=>{l()},500)},f=L.channel("technician-availability-updates").on("postgres_changes",{event:"*",schema:"public",table:"technician_availability"},()=>{_()}).subscribe(),b=L.channel("availability-schedules-updates").on("postgres_changes",{event:"*",schema:"public",table:"availability_schedules"},()=>{_()}).subscribe(),O=L.channel("vacation-requests-updates").on("postgres_changes",{event:"*",schema:"public",table:"vacation_requests"},()=>{_()}).subscribe();return()=>{clearTimeout(x),L.removeChannel(f),L.removeChannel(b),L.removeChannel(O)}},[a]);const i=T.useCallback(async(d,l,x)=>{var f;const _=C(x,"yyyy-MM-dd");try{if(l==="warehouse"){const{data:O}=await L.from("profiles").select("department").eq("id",d).single(),{error:M}=await L.from("availability_schedules").upsert({user_id:d,department:(O==null?void 0:O.department)||"unknown",date:_,status:"unavailable",source:"warehouse",notes:"Warehouse override"},{onConflict:"user_id,department,date"});if(M){s({title:"Error",description:"Failed to update warehouse status",variant:"destructive"});return}}else{const{error:O}=await L.from("technician_availability").upsert({technician_id:d,date:_,status:l,created_by:(f=(await L.auth.getUser()).data.user)==null?void 0:f.id},{onConflict:"technician_id,date"});if(O){s({title:"Error",description:"Failed to update availability status",variant:"destructive"});return}}s({title:"Availability Updated",description:`Technician marked as ${l==="vacation"?"vacation":l==="travel"?"travel":l==="sick"?"sick day":l==="warehouse"?"warehouse override":"day off"} for ${C(x,"MMM d, yyyy")}`})}catch{s({title:"Error",description:"Failed to update availability status",variant:"destructive"})}},[s]),c=T.useCallback(async(d,l)=>{const x=C(l,"yyyy-MM-dd");try{const{error:_}=await L.from("technician_availability").delete().eq("technician_id",d).eq("date",x),{error:f}=await L.from("availability_schedules").delete().eq("user_id",d).eq("date",x).in("source",["manual","warehouse"]);if(_||f){s({title:"Error",description:"Failed to remove availability status",variant:"destructive"});return}s({title:"Availability Removed",description:`Availability status removed for ${C(l,"MMM d, yyyy")}`})}catch{s({title:"Error",description:"Failed to remove availability status",variant:"destructive"})}},[s]),g=T.useCallback((d,l)=>{const x=`${d}-${C(l,"yyyy-MM-dd")}`;return Xe.data[x]||null},[]);return{availabilityData:Xe.data,isLoading:r,updateAvailability:i,removeAvailability:c,getAvailabilityStatus:g}},wn=(n,r)=>{const t=`${n}-${C(r,"yyyy-MM-dd")}`,s=T.useCallback(i=>Xe.subscribe(i),[]),a=T.useCallback(()=>Xe.data[t]||null,[t]);return T.useSyncExternalStore(s,a,a)},Nn=T.memo(({technician:n,assignment:r,date:t,compact:s=!1,availabilityStatus:a=null,onAvailabilityChange:i,onAvailabilityRemove:c})=>{const[g,d]=T.useState(!1),[l,x]=T.useState(null),_=wn(n.id,t);T.useEffect(()=>{l!==null&&_===l&&x(null)},[_,l]);const f=l??_,b=()=>{var y;const v=((y=n.first_name)==null?void 0:y[0])||"",o=n.nickname||n.last_name||"",h=(o==null?void 0:o[0])||"",u=`${v}${h}`.trim();return u?u.toUpperCase():"HT"},O=()=>{if(!r)return null;const v=r.sound_role||r.lights_role||r.video_role;return v?es(v):null},M=()=>{if(f)switch(f){case"vacation":return"#fbbf24";case"travel":return"#3b82f6";case"sick":return"#ef4444";case"day_off":return"#8b5cf6";case"warehouse":return"#f97316"}return r&&r.job.color?r.job.color:"#6b7280"},D=()=>{if(!f)return null;switch(f){case"vacation":return"ðŸ–ï¸";case"travel":return"âœˆï¸";case"sick":return"ðŸ¤’";case"day_off":return"ðŸ ";case"warehouse":return"ðŸ­";default:return null}},S=M(),P=!!f,j=v=>{v.preventDefault(),v.stopPropagation(),d(!0)},$=(v,o,h)=>{x(o),i&&i(v,o,h)},N=(v,o)=>{x(null),c&&c(v,o)};return e.jsxs(e.Fragment,{children:[e.jsx(ke,{variant:"secondary",className:Ae("cursor-pointer hover:opacity-80 transition-opacity flex items-center justify-center shrink-0 relative",s?"text-xs px-1 py-0.5 h-5 w-8 text-center font-medium":"text-xs gap-0.5 w-16 font-medium px-1.5 py-0.5",r&&!P?"font-medium":"font-normal",P&&"opacity-75"),style:{backgroundColor:r&&!P?`${S}20`:P?`${S}20`:"#f3f4f6",borderColor:S,color:S},onClick:j,children:s?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-xs leading-none",children:b()}),D()&&e.jsx("span",{className:"absolute -top-1 -right-1 text-[8px]",children:D()})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"flex-shrink-0 text-xs",children:b()}),r&&O()&&!P&&e.jsx("span",{className:"truncate text-[10px] opacity-75 max-w-[24px]",children:O().slice(0,3)}),D()&&e.jsx("span",{className:"text-[10px]",children:D()})]})}),e.jsx(ws,{open:g,onOpenChange:d,technician:n,assignment:r,date:t,availabilityStatus:f,onAvailabilityChange:$,onAvailabilityRemove:N})]})}),Xt=n=>n.toISOString().split("T")[0],Ms=n=>{const[r,t]=T.useState([]),[s,a]=T.useState([]),[i,c]=T.useState([]),[g,d]=T.useState(!0),l=`${n.getFullYear()}-${n.getMonth()}`;return T.useEffect(()=>{let x=!0;const _=async()=>{d(!0);try{const O=Ct(Le(n),7),M=Ke(Fe(n),7),{data:D,error:S}=await L.from("profiles").select("id, first_name, last_name, department, phone").eq("role","house_tech").order("first_name");if(S)throw S;const P=(D??[]).map(N=>N.id);let j=[];if(P.length>0){const{data:N,error:v}=await L.from("timesheets").select(`
              technician_id,
              job_id,
              date,
              jobs!inner (
                id,
                title,
                color,
                start_time,
                end_time,
                status,
                locations ( name )
              )
            `).eq("is_active",!0).in("technician_id",P).lte("jobs.start_time",M.toISOString()).gte("jobs.end_time",O.toISOString());if(v)throw v;const o=new Map;(N??[]).forEach(u=>{const y=`${u.job_id}-${u.technician_id}`;if(!o.has(y)){const A=Array.isArray(u.jobs)?u.jobs[0]:u.jobs;A&&o.set(y,{technician_id:u.technician_id,dates:new Set,job:A})}const R=o.get(y);R&&u.date&&R.dates.add(u.date)});const h=Array.from(o.values()).map(u=>{const y=u.job,R=Array.isArray(y.locations)?y.locations[0]:y.locations;return{technician_id:u.technician_id,sound_role:null,lights_role:null,video_role:null,single_day:!1,assignment_date:null,dates:Array.from(u.dates).sort(),job:{id:y.id,title:y.title,color:y.color,start_time:y.start_time,end_time:y.end_time,status:y.status,location:R!=null&&R.name?{name:R.name}:null}}});if(j=h,h.length>0){const u=Array.from(new Set(h.map(y=>y.job.id)));if(u.length>0){const{data:y,error:R}=await L.from("job_assignments").select(`
                  technician_id,
                  job_id,
                  sound_role,
                  lights_role,
                  video_role,
                  single_day,
                  assignment_date
                `).in("job_id",u).in("technician_id",P);if(R)throw R;const A=new Map;(y??[]).forEach(Y=>{const H=`${Y.job_id}-${Y.technician_id}`;A.set(H,{sound_role:Y.sound_role??null,lights_role:Y.lights_role??null,video_role:Y.video_role??null,single_day:Y.single_day??!1,assignment_date:Y.assignment_date??null})}),j=h.map(Y=>{const H=`${Y.job.id}-${Y.technician_id}`,Q=A.get(H);return{...Y,sound_role:(Q==null?void 0:Q.sound_role)??null,lights_role:(Q==null?void 0:Q.lights_role)??null,video_role:(Q==null?void 0:Q.video_role)??null,single_day:(Q==null?void 0:Q.single_day)??!1,assignment_date:(Q==null?void 0:Q.assignment_date)??null}})}}}let $=[];if(P.length>0){const{data:N,error:v}=await L.from("availability_schedules").select("user_id, date, source, notes").in("user_id",P).eq("status","unavailable").eq("source","vacation").gte("date",Xt(O)).lte("date",Xt(M));if(v)throw v;$=(N??[]).map(o=>({technician_id:o.user_id,date:o.date,source:o.source,notes:o.notes??void 0}))}if(!x)return;t(D??[]),a(j),c($)}catch{if(!x)return;t([]),a([]),c([])}finally{x&&d(!1)}};_();const f=L.channel("personal-calendar-timesheets").on("postgres_changes",{event:"*",schema:"public",table:"timesheets"},()=>{_()}).subscribe(),b=L.channel("personal-calendar-job-assignments").on("postgres_changes",{event:"*",schema:"public",table:"job_assignments"},()=>{_()}).subscribe();return()=>{x=!1,L.removeChannel(f),L.removeChannel(b)}},[l]),{houseTechs:r,assignments:s,vacationPeriods:i,isLoading:g}},_s=({showDialog:n,setShowDialog:r,currentMonth:t,onGeneratePDF:s,onGenerateXLS:a,departments:i,selectedDepartments:c,onDepartmentsChange:g})=>{const d=l=>{c.includes(l)?g(c.filter(x=>x!==l)):g([...c,l])};return e.jsx(jt,{open:n,onOpenChange:r,children:e.jsxs(wt,{children:[e.jsx(Nt,{children:e.jsx(Mt,{children:"Exportar Calendario Personal"})}),e.jsxs("div",{className:"space-y-4",children:[i.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ye,{children:"Departamentos a Incluir:"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:i.map(l=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(yt,{id:`dept-${l}`,checked:c.includes(l),onCheckedChange:()=>d(l)}),e.jsx(Ye,{htmlFor:`dept-${l}`,className:"capitalize",children:l})]},l))})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"font-semibold text-base",children:"Imprimir a PDF"}),e.jsxs(W,{onClick:()=>{s("month")},children:[e.jsx(Ve,{className:"h-4 w-4 mr-2"})," Mes Actual (",C(t,"MMMM yyyy"),")"]}),e.jsxs(W,{onClick:()=>{s("quarter")},children:[e.jsx(Ve,{className:"h-4 w-4 mr-2"})," PrÃ³ximo Trimestre"]}),e.jsxs(W,{onClick:()=>{s("year")},children:[e.jsx(Ve,{className:"h-4 w-4 mr-2"})," AÃ±o Completo (",C(t,"yyyy"),")"]})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"font-semibold text-base",children:"Exportar a XLS"}),e.jsxs(W,{onClick:()=>{a("month")},children:[e.jsx(xt,{className:"h-4 w-4 mr-2"})," Mes Actual (",C(t,"MMMM yyyy"),")"]}),e.jsxs(W,{onClick:()=>{a("quarter")},children:[e.jsx(xt,{className:"h-4 w-4 mr-2"})," PrÃ³ximo Trimestre"]}),e.jsxs(W,{onClick:()=>{a("year")},children:[e.jsx(xt,{className:"h-4 w-4 mr-2"})," AÃ±o Completo (",C(t,"yyyy"),")"]})]})]})]})})};async function Mn(n){try{let r=L.from("madrid_holidays").select("*").eq("is_active",!0).order("date");const{data:t,error:s}=await r;return s?[]:t||[]}catch{return[]}}function ks(n,r){const t=typeof n=="string"?kt(n):n;if(ns(t))return!1;const s=C(t,"yyyy-MM-dd");return!r.some(i=>i.date===s)}function St(n,r){const t=typeof n=="string"?kt(n):n,s=C(t,"yyyy-MM-dd"),a=r.find(i=>i.date===s);return a?a.name:null}function Gt(n){const r=typeof n=="string"?kt(n):n;return ns(r)}const Ts=n=>{const r=n.first_name||"",t=n.last_name||"";return r&&t?`${r} ${t}`:r||t||"Unknown"},Ds=n=>{const r=parseInt(n.slice(1,3),16),t=parseInt(n.slice(3,5),16),s=parseInt(n.slice(5,7),16);return[r,t,s]},_n=n=>{const[r,t,s]=Ds(n);return(.299*r+.587*t+.114*s)/255>.6?"#000000":"#ffffff"},kn=n=>{switch(n){case"warehouse":return"#E5E7EB";case"vacation":return"#FEE2E2";case"travel":return"#DBEAFE";case"sick":return"#FCE7F3";case"day_off":return"#FEF9C3";default:return"#BFDBFE"}},Cs=n=>{switch(n){case"warehouse":return"A";case"vacation":return"VC";case"travel":return"VJ";case"sick":return"E";case"day_off":return"L";default:return""}},Tn=n=>{const r=n.getDay();return r===0||r===6},$s=(n,r)=>r.filter(t=>{if(t.single_day&&t.assignment_date){const s=vs(t.assignment_date,"yyyy-MM-dd",new Date);return it(n,s)}if(t.dates&&t.dates.length>0){const s=C(n,"yyyy-MM-dd");return t.dates.includes(s)}return!1}),As=(n,r,t,s,a,i)=>{if(a&&a.length>0&&(!n.department||!a.includes(n.department)))return!1;const c=t.some(l=>l.technician_id===n.id),g=s(n.id,r);return!(!(i?ks(r,i):!Tn(r))&&!c&&!g)},Ps=async(n,r)=>{var ge,Ce;const t=await as(),{houseTechs:s,assignments:a,getAvailabilityStatus:i,currentDate:c,selectedDepartments:g,madridHolidays:d=[]}=r,l=new t("landscape","mm",[420,297]);let x,_;const f=await new Promise((J,F)=>{const X=new Image;X.crossOrigin="anonymous",X.src="/lovable-uploads/ce3ff31a-4cc5-43c8-b5bb-a4056d3735e4.png",X.onload=()=>J(X),X.onerror=Z=>F(Z)}).catch(()=>null),b=l.internal.pageSize.getWidth(),O=l.internal.pageSize.getHeight(),M=60,D=f?M*(f.height/f.width):0,S=15,P=f?S+D+8:25,j=P+15,$=40,N=20;switch(n){case"month":x=Le(c),_=Fe(c);break;case"quarter":x=is(rt(c,1)),_=os(rt(x,2));break;case"year":x=ts(c),_=rs(c);break;default:x=Le(c),_=Fe(c)}const v=ls({start:x,end:_}),o=57,h=3.5,u=.4,y=15,R=8,A=2,Y=["Lunes","Martes","Miercoles","Jueves","Viernes","Sabado","Domingo"],H=J=>{const F=$s(J,a),X=s.filter(V=>As(V,J,F,i,g,d)),Z=X.filter(V=>V.department&&V.department.trim().toLowerCase()==="sound"),ie=X.filter(V=>V.department&&V.department.trim().toLowerCase()==="lights"),de=X.filter(V=>!V.department||V.department.trim().toLowerCase()!=="sound"&&V.department.trim().toLowerCase()!=="lights");return[...Z,...ie,...de].map(V=>{const G=F.find(he=>he.technician_id===V.id),ae=i(V.id,J);return{tech:V,assignment:G,availabilityStatus:ae}})},Q=(J,F)=>{const X=O-j-8-$-N,Z=J.map(G=>{const ae=G.map(oe=>!oe||!Ge(oe,F)?0:H(oe).length);return Math.max(...ae)}),ie=Z.map(G=>{const he=Math.min(G,12)*(h+u),oe=G>12?h+u:0;return R+A*2+he+oe}),de=ie.reduce((G,ae)=>G+ae,0);if(de<=X){const ae=(X-de)/J.length;return ie.map((he,oe)=>{const $e=Math.max(Z[oe]/12,.2),be=ae*$e;return he+be})}const V=Z.reduce((G,ae)=>G+Math.max(ae,1),0);return Z.map(G=>{const ae=Math.max(G,1)/V,he=X*ae,oe=R+A*2+Math.min(G,3)*(h+u);return Math.max(he,oe)})};for(const[J,F]of v.entries()){let X=function(be){return(be.getDay()+6)%7};J>0&&l.addPage([420,297],"landscape");const Z=f?(b-M)/2:0;f&&l.addImage(f,"PNG",Z,S,M,D),l.setFontSize(20),l.setTextColor(51,51,51),l.text(`PERSONAL CALENDAR - ${C(F,"MMMM yyyy").toUpperCase()}`,b/2,P,{align:"center"}),Y.forEach((be,Ne)=>{l.setFillColor(41,128,185),l.rect(y+Ne*o,j,o,8,"F"),l.setTextColor(255),l.setFontSize(12);const xe=y+Ne*o+o/2;l.text(be,xe,j+6,{align:"center"})});const ie=Fe(F),de=$t({start:F,end:ie}),V=X(F),ae=[...Array.from({length:V},()=>null),...de],he=[];for(;ae.length>0;)he.push(ae.splice(0,7));let oe=j+8;const $e=Q(he,F);for(const[be,Ne]of he.entries()){const xe=$e[be];for(const[ye,p]of Ne.entries()){const E=y+ye*o;if(l.setDrawColor(200),l.setLineWidth(.5),l.rect(E,oe,o,xe),!p)continue;l.setTextColor(Ge(p,F)?0:150),l.setFontSize(12),l.setFont("helvetica","bold"),l.text(C(p,"d"),E+2,oe+6),St(p,d)&&(l.setFontSize(8),l.setFont("helvetica","normal"),l.setTextColor(180,100,0),l.text("H",E+o-8,oe+6));const te=H(p);if(te.length===0)continue;const m=xe-R-A*2,k=Math.floor(m/(h+u)),I=Math.min(te.length,Math.max(k,1)),U=oe+R+A;for(const[q,K]of te.slice(0,I).entries()){const{tech:z,assignment:ne,availabilityStatus:ve}=K,je=U+q*(h+u),we=ne?((ge=ne.jobs)==null?void 0:ge.color)||"#BFDBFE":kn(ve),[_e,Ie,We]=Ds(we),Ze=_n(we);l.setFillColor(_e,Ie,We),l.rect(E+1,je,o-2,h,"F"),l.setFont("helvetica","normal"),l.setFontSize(6),l.setTextColor(Ze);const Je=ve?Cs(ve):"",Rt=((Ce=ne==null?void 0:ne.jobs)==null?void 0:Ce.title)||"",mt=Ts(z),et=Je?`${Je} - ${mt}`:Rt?`${mt} (${Rt})`:mt,Os=o-4,Lt=Math.floor(Os/1.2);let Ht=et;et&&et.length>Lt&&(Ht=et.substring(0,Lt-3)+"..."),l.text(Ht,E+2,je+2.5)}if(te.length>I){const q=U+I*(h+u);if(q+h<oe+xe-A){l.setFillColor(240,240,240),l.rect(E+1,q,o-2,h,"F"),l.setFont("helvetica","italic"),l.setFontSize(6),l.setTextColor(100);const K=`+${te.length-I} more`;l.text(K,E+2,q+2.5)}}}oe+=xe}if(J===0){let be=oe+8;l.setFont("helvetica","bold"),l.setFontSize(9),l.setTextColor(0),l.text("Indicadores de Estado:",y,be);let Ne=y+50;const xe=[{label:"A",description:"AlmacÃ©n"},{label:"VC",description:"Vacaciones"},{label:"VJ",description:"Viaje"},{label:"E",description:"Enfermo"},{label:"L",description:"Libre"}];xe.forEach((ye,p)=>{l.setFont("helvetica","normal"),l.setFontSize(8),l.text(`${ye.label} = ${ye.description}`,Ne,be),Ne+=60,Ne>b-60&&p<xe.length-1&&(Ne=y+50,be+=10)})}}l.save(`personal-calendar-${n}-${C(new Date,"yyyy-MM-dd")}.pdf`)},Es=async(n,r)=>{const t=await la(),{houseTechs:s,assignments:a,getAvailabilityStatus:i,currentDate:c,selectedDepartments:g,madridHolidays:d=[]}=r;let l,x;switch(n){case"month":l=Le(c),x=Fe(c);break;case"quarter":l=is(rt(c,1)),x=os(rt(l,2));break;case"year":l=ts(c),x=rs(c);break;default:l=Le(c),x=Fe(c)}const _=["LUNES","MARTES","MIERCOLES","JUEVES","VIERNES","SABADO","DOMINGO"],f=M=>{const D=$s(M,a),S=s.filter(N=>As(N,M,D,i,g,d)),P=S.filter(N=>N.department&&N.department.trim().toLowerCase()==="sound"),j=S.filter(N=>N.department&&N.department.trim().toLowerCase()==="lights"),$=S.filter(N=>!N.department||N.department.trim().toLowerCase()!=="sound"&&N.department.trim().toLowerCase()!=="lights");return[...P,...j,...$].map(N=>{const v=D.find(h=>h.technician_id===N.id),o=i(N.id,M);return{tech:N,assignment:v,availabilityStatus:o}})},b=M=>{var y;const D=[];D.push([`PERSONAL CALENDAR - ${C(M,"MMMM yyyy").toUpperCase()}`,null,null,null,null,null,null]),D.push(_);const S=Fe(M),P=$t({start:M,end:S});function j(R){return(R.getDay()+6)%7}const $=j(M),v=[...Array.from({length:$},()=>null),...P],o=[];for(;v.length>0;)o.push(v.splice(0,7));let h=0;for(const R of o)for(const A of R)if(A&&Ge(A,M)){const Y=f(A);Y.length>h&&(h=Y.length)}const u=Math.max(1,h+1);for(const R of o){const A=Array.from({length:u},()=>Array(7).fill(null));for(const[Y,H]of R.entries()){if(!H)continue;const Q=C(H,"d"),ge=f(H),J=St(H,d)?`${Q} ðŸ–ï¸`:Q;A[0][Y]=Ge(H,M)?J:C(H,"d");for(let F=0;F<ge.length;F++)if(F+1<u){const{tech:X,assignment:Z,availabilityStatus:ie}=ge[F],de=ie?`[${Cs(ie)}]`:"",V=((y=Z==null?void 0:Z.jobs)==null?void 0:y.title)||"",G=Ts(X),ae=de?`${G} ${de}`:V?`${G} (${V})`:G;A[F+1][Y]=ae}else{A[u-1][Y]=`+${ge.length-F} more...`;break}}D.push(...A)}return D},O=t.utils.book_new();if(n==="year"||n==="quarter"){const M=ls({start:l,end:x});for(const D of M){const S=b(D),P=t.utils.aoa_to_sheet(S),j=S.reduce(($,N)=>(N.forEach((v,o)=>{const u=(v?v.toString():"").split(`
`).reduce((y,R)=>Math.max(y,R.length),0);$[o]=Math.max($[o]||0,u)}),$),Array(7).fill(0));P["!cols"]=j.map($=>({wch:$+2})),S.length>0&&(P["!merges"]=[{s:{r:0,c:0},e:{r:0,c:6}}]),t.utils.book_append_sheet(O,P,C(D,"MMM yyyy"))}}else{const M=b(c),D=t.utils.aoa_to_sheet(M),S=M.reduce((P,j)=>(j.forEach(($,N)=>{const o=($?$.toString():"").split(`
`).reduce((h,u)=>Math.max(h,u.length),0);P[N]=Math.max(P[N]||0,o)}),P),Array(7).fill(0));D["!cols"]=S.map(P=>({wch:P+2})),M.length>0&&(D["!merges"]=[{s:{r:0,c:0},e:{r:0,c:6}}]),t.utils.book_append_sheet(O,D,C(c,"MMMM yyyy"))}t.writeFile(O,`personal-calendar-${n}-${C(new Date,"yyyy-MM-dd")}.xlsx`)};function Fs(n){const[r,t]=T.useState([]),[s,a]=T.useState(!0),[i,c]=T.useState(null),g=T.useCallback(async()=>{try{a(!0),c(null);const f=await Mn(n);t(f)}catch(f){c(f instanceof Error?f:new Error("Failed to load Madrid holidays"))}finally{a(!1)}},[n]);T.useEffect(()=>{g()},[g]);const d=T.useCallback(f=>s||r.length===0?!Gt(f):ks(f,r),[r,s]),l=T.useCallback(f=>Gt(f),[]),x=T.useCallback(f=>St(f,r),[r]),_=T.useCallback(f=>!d(f),[d]);return{holidays:r,loading:s,error:i,isWorkingDay:d,isWeekend:l,getHolidayName:x,isNonWorkingDay:_,refresh:g}}const Dn=T.memo(({date:n,onDateSelect:r,readOnly:t=!1})=>{const[s,a]=T.useState(!1),[i,c]=T.useState(new Date),[g,d]=T.useState(null),[l,x]=T.useState(!1),[_,f]=T.useState([]),b=n,O=Le(b),M=Fe(b),D=$t({start:O,end:M}),S=O.getDay(),P=S===0?6:S-1,j=Array.from({length:P}).map((p,E)=>Ct(O,P-E)),N=Array.from({length:42-(j.length+D.length)}).map((p,E)=>Ke(M,E+1)),v=[...j,...D,...N],{houseTechs:o,assignments:h,isLoading:u}=Ms(b),{updateAvailability:y,removeAvailability:R,getAvailabilityStatus:A,isLoading:Y}=Ns(b),{isWorkingDay:H,getHolidayName:Q,holidays:ge,loading:Ce,error:J}=Fs(),F=Array.from(new Set(o.map(p=>p.department).filter(p=>!!p))).sort(),X=()=>{const p=new Date(b);p.setMonth(p.getMonth()-1),r(p)},Z=()=>{const p=new Date(b);p.setMonth(p.getMonth()+1),r(p)},ie=()=>{const p=new Date;r(p),c(p)},de=p=>{r(p),c(p)},V=p=>{const E=p.getDay();return E===0||E===6},G=p=>h.filter(E=>{if(E.single_day&&E.assignment_date){const ee=vs(E.assignment_date,"yyyy-MM-dd",new Date);return it(p,ee)}if(E.dates&&E.dates.length>0){const ee=C(p,"yyyy-MM-dd");return E.dates.includes(ee)}return!1}),ae=T.useCallback((p,E,ee)=>{y(p,E,ee)},[y]),he=T.useCallback((p,E)=>{R(p,E)},[R]),oe=async p=>{await Ps(p,{houseTechs:o,assignments:h,getAvailabilityStatus:A,currentDate:b,selectedDepartments:_.length>0?_:void 0,madridHolidays:ge}),x(!1)},$e=async p=>{await Es(p,{houseTechs:o,assignments:h,getAvailabilityStatus:A,currentDate:b,selectedDepartments:_.length>0?_:void 0,madridHolidays:ge}),x(!1)},be=T.useMemo(()=>{const p=i,E=G(p),ee=H(p);return o.reduce((m,k)=>{const I=k.department||"Unknown";m[I]||(m[I]={total:0,assignedAndAvailable:0,assignedButUnavailable:0,unavailable:0,availableAndNotInWarehouse:0}),m[I].total++;const U=E.some(z=>z.technician_id===k.id),K=!!A(k.id,p);return K&&m[I].unavailable++,U?K?m[I].assignedButUnavailable++:m[I].assignedAndAvailable++:!K&&ee&&m[I].availableAndNotInWarehouse++,m},{})},[i,o,h,A,H]),Ne=(p,E)=>{if(g&&p.department!==g)return!1;const te=G(E).some(k=>k.technician_id===p.id),m=A(p.id,E);return!(!H(E)&&!te&&!m)},xe=T.useMemo(()=>{const p=i,E=G(p),ee=H(p);let te=0,m=0,k=0,I=0,U=0,q=0;return o.forEach(K=>{const z=E.some(je=>je.technician_id===K.id),ne=A(K.id,p);(ne==="warehouse"||!z&&!!!ne&&ee)&&te++,z&&ne!=="warehouse"&&m++,ne==="vacation"?k++:ne==="day_off"?I++:ne==="travel"?U++:ne==="sick"&&q++}),{techsInWarehouse:te,techsOnJobs:m,techsOnVacation:k,techsOnDaysOff:I,techsTravelling:U,techsSick:q}},[i,o,h,A,H]),ye=T.useCallback((p,E,ee=5)=>{const te=p.filter(z=>Ne(z,E)),m=G(E),k=10,I=te.filter(z=>z.department&&z.department.trim().toLowerCase()==="lights"),U=te.filter(z=>z.department&&z.department.trim().toLowerCase()==="sound"),q=te.filter(z=>z.department&&z.department.trim().toLowerCase()!=="lights"&&z.department.trim().toLowerCase()!=="sound"||!z.department),K=(z,ne)=>{const ve=z.slice(0,k),je=[];for(let we=0;we<ve.length;we+=ee)je.push(ve.slice(we,we+ee));return e.jsx("div",{children:je.map((we,_e)=>e.jsx("div",{className:"flex gap-1 mb-1",children:we.map(Ie=>{const We=m.find(Je=>Je.technician_id===Ie.id),Ze=A(Ie.id,E);return e.jsx(Nn,{technician:Ie,assignment:We,date:E,compact:!0,availabilityStatus:Ze==="unavailable"?null:Ze,onAvailabilityChange:t?void 0:ae,onAvailabilityRemove:t?void 0:he},Ie.id)})},_e))},ne)};return e.jsxs(e.Fragment,{children:[K(U,"sound")," ",K(I,"lights")," ",K(q,"other"),te.length>k&&e.jsxs("div",{className:"text-xs text-muted-foreground bg-accent/30 p-0.5 rounded text-center mt-1",children:["+",te.length-k]})]})},[g,h,A,ae,he,t,H]);return J?e.jsx(ue,{className:"h-full flex flex-col",children:e.jsxs(me,{className:"flex-grow p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:C(b,"MMMM yyyy")}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(W,{variant:"ghost",size:"icon",onClick:X,children:e.jsx(Be,{className:"h-4 w-4"})}),e.jsx(W,{variant:"ghost",size:"icon",onClick:Z,children:e.jsx(Qe,{className:"h-4 w-4"})}),e.jsx(W,{variant:"ghost",size:"sm",onClick:ie,children:"Today"})]})]}),e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4",children:[e.jsx("h3",{className:"text-amber-900 dark:text-amber-100 font-semibold mb-2",children:"Error loading Madrid holidays"}),e.jsx("p",{className:"text-amber-800 dark:text-amber-200 text-sm mb-2",children:J.message}),e.jsx("p",{className:"text-amber-700 dark:text-amber-300 text-xs",children:"The calendar will display with limited holiday information (weekends only). Warehouse day counts may be inaccurate until holidays are loaded."})]})]})}):u||Y||Ce?e.jsx(ue,{className:"h-full flex flex-col",children:e.jsx(me,{className:"flex-grow p-4 flex items-center justify-center",children:e.jsx("div",{className:"text-muted-foreground",children:"Loading calendar..."})})}):o.length===0?e.jsx(ue,{className:"h-full flex flex-col",children:e.jsxs(me,{className:"flex-grow p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:C(b,"MMMM yyyy")}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(W,{variant:"ghost",size:"icon",onClick:X,children:e.jsx(Be,{className:"h-4 w-4"})}),e.jsx(W,{variant:"ghost",size:"icon",onClick:Z,children:e.jsx(Qe,{className:"h-4 w-4"})}),e.jsx(W,{variant:"ghost",size:"sm",onClick:ie,children:"Today"})]})]}),e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx("p",{children:"No house technicians found."}),e.jsx("p",{className:"text-sm mt-2",children:"Make sure there are users with the 'house_tech' role in the system."})]})]})}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(ue,{children:e.jsxs(me,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Ee,{className:"h-5 w-5 text-primary"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Sumario de Personal"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",C(i,"MMM d, yyyy"),")"]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:[Object.entries(be).map(([p,E])=>e.jsxs("div",{className:Ae("bg-muted/30 rounded-lg p-3 cursor-pointer transition-colors hover:bg-muted",g===p&&"ring-2 ring-primary ring-inset bg-muted"),onClick:()=>{d(ee=>ee===p?null:p)},children:[e.jsx("div",{className:"text-sm font-medium capitalize mb-1",children:p}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"text-green-600 font-medium",children:["Tecnicos de bolo: ",E.assignedAndAvailable," "]}),e.jsxs("span",{className:"text-muted-foreground",children:["Tecnicos en Almacen: ",E.availableAndNotInWarehouse," "]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["Total: ",E.total]})]},p)),Object.keys(be).length===0&&e.jsx("div",{className:"col-span-full text-center text-muted-foreground py-4",children:"No personnel data available"}),e.jsxs("div",{className:"bg-muted/30 rounded-lg p-3 col-span-1",children:[" ",e.jsx("h4",{className:"text-sm font-medium mb-1",children:"Totales"}),e.jsxs("div",{className:"flex flex-col text-sm space-y-1",children:[e.jsxs("span",{className:"text-muted-foreground flex items-center gap-1",children:[e.jsx(Et,{className:"h-4 w-4"})," Tecnicos en Almacen: ",xe.techsInWarehouse]}),e.jsxs("span",{className:"text-green-600 font-medium flex items-center gap-1",children:[e.jsx(Ue,{className:"h-4 w-4"})," Tecnicos en bolos: ",xe.techsOnJobs]}),e.jsxs("span",{className:"text-red-600 font-medium flex items-center gap-1",children:[e.jsx(ca,{className:"h-4 w-4"})," Tecnicos de Vacaciones: ",xe.techsOnVacation]}),e.jsxs("span",{className:"text-red-600 font-medium flex items-center gap-1",children:[e.jsx(At,{className:"h-4 w-4"})," Tecnicos de Dias Libres: ",xe.techsOnDaysOff]}),e.jsxs("span",{className:"text-red-600 font-medium flex items-center gap-1",children:[e.jsx(da,{className:"h-4 w-4"})," Tecnicos en Viaje: ",xe.techsTravelling]}),e.jsxs("span",{className:"text-red-600 font-medium flex items-center gap-1",children:[e.jsx(Ma,{className:"h-4 w-4"})," Tecnicos Enfermos: ",xe.techsSick]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-2",children:["Total Tecnicos: ",o.length]})]})]})]})}),e.jsx(ue,{className:"h-full flex flex-col",children:e.jsxs(me,{className:"flex-grow p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"flex items-center space-x-4",children:e.jsx("h2",{className:"text-xl font-semibold",children:C(b,"MMMM yyyy")})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(W,{variant:"ghost",size:"icon",onClick:X,children:e.jsx(Be,{className:"h-4 w-4"})}),e.jsx(W,{variant:"ghost",size:"icon",onClick:Z,children:e.jsx(Qe,{className:"h-4 w-4"})}),e.jsx(W,{variant:"ghost",size:"sm",onClick:ie,children:"Today"}),e.jsx(W,{variant:"ghost",size:"icon",onClick:()=>a(!s),children:s?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(gt,{className:"h-4 w-4"})}),e.jsx(W,{variant:"ghost",size:"icon",onClick:()=>x(!0),children:e.jsx(Ve,{className:"h-4 w-4"})})]})]}),e.jsx(_s,{showDialog:l,setShowDialog:x,currentMonth:b,onGeneratePDF:oe,onGenerateXLS:$e,departments:F,selectedDepartments:_,onDepartmentsChange:f}),!s&&e.jsx("div",{className:"border rounded-lg overflow-x-auto",children:e.jsxs("div",{className:"grid grid-cols-7 gap-px bg-muted",style:{minWidth:"980px"},children:[["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map(p=>e.jsx("div",{className:"bg-background p-2 text-center text-sm text-muted-foreground font-medium",children:p},p)),v.map((p,E)=>{const ee=Ge(p,b),te=V(p),m=cs(p),k=it(p,i),I=H(p),U=Q(p);return e.jsxs("div",{className:Ae("p-2 min-h-[140px] border-t relative cursor-pointer hover:bg-accent/50 transition-colors",te?"bg-slate-50 dark:bg-slate-800/50":"bg-background",!I&&ee&&"bg-amber-50/50 dark:bg-amber-900/10",m&&"ring-2 ring-primary ring-inset",k&&"bg-accent/30",!ee&&"text-muted-foreground/50"),onClick:()=>de(p),children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx("span",{className:Ae("text-sm font-medium",m&&"text-primary font-bold",k&&"text-primary"),children:C(p,"d")}),!I&&ee&&e.jsx("span",{className:"text-xs text-amber-600 dark:text-amber-500",title:U||"Non-working day (weekend)",children:"ðŸ–ï¸"})]}),U&&ee&&e.jsx("div",{className:"text-[10px] text-amber-700 dark:text-amber-400 font-medium truncate",title:U,children:U}),e.jsxs("div",{className:"mt-1",children:[ye(o,p)," "]})]},E)})]})})]})})]})}),Cn=({children:n,technician:r,date:t,onAvailabilityChange:s,onAvailabilityRemove:a})=>{const i=g=>{s(r.id,g,t)},c=()=>{a==null||a(r.id,t)};return e.jsxs(ua,{children:[e.jsx(ma,{asChild:!0,children:n}),e.jsxs(xa,{className:"w-56",children:[e.jsxs(ha,{children:[e.jsxs(pa,{children:[e.jsx(Re,{className:"mr-2 h-4 w-4"}),"Mark as Unavailable"]}),e.jsxs(fa,{className:"w-48",children:[e.jsxs(Se,{onClick:()=>i("vacation"),children:[e.jsx(Re,{className:"mr-2 h-4 w-4"}),"Vacation"]}),e.jsxs(Se,{onClick:()=>i("travel"),children:[e.jsx(nt,{className:"mr-2 h-4 w-4"}),"Travel"]}),e.jsxs(Se,{onClick:()=>i("sick"),children:[e.jsx(Pt,{className:"mr-2 h-4 w-4"}),"Sick Day"]}),e.jsxs(Se,{onClick:()=>i("day_off"),children:[e.jsx(At,{className:"mr-2 h-4 w-4"}),"Day Off"]}),e.jsxs(Se,{onClick:()=>i("warehouse"),children:[e.jsx(Et,{className:"mr-2 h-4 w-4"}),"Mark as In Warehouse"]})]})]}),e.jsx(ba,{}),e.jsxs(Se,{onClick:c,children:[e.jsx(Re,{className:"mr-2 h-4 w-4"}),"Remove Override"]})]})]})},$n=({date:n,onDateSelect:r,readOnly:t=!1,theme:s,isDark:a})=>{const[i,c]=T.useState(n),[g,d]=T.useState(null),[l,x]=T.useState("all"),[_,f]=T.useState(!1),[b,O]=T.useState([]),[M,D]=T.useState(!1),[S,P]=T.useState(null),[j,$]=T.useState(void 0),[N,v]=T.useState(null);T.useEffect(()=>{c(n)},[n]);const{houseTechs:o,assignments:h,isLoading:u}=Ms(i),{updateAvailability:y,removeAvailability:R,getAvailabilityStatus:A,isLoading:Y}=Ns(i),{isWorkingDay:H,getHolidayName:Q,holidays:ge,loading:Ce,error:J}=Fs(),F=T.useCallback(m=>h.filter(k=>{if(k.single_day&&k.assignment_date){const I=new Date(k.assignment_date);return it(m,I)}if(k.dates&&k.dates.length>0){const I=C(m,"yyyy-MM-dd");return k.dates.includes(I)}return!1}),[h]);F(i);const X=Array.from(new Set(o.map(m=>m.department).filter(m=>!!m))).sort(),Z=()=>{const m=Ct(i,1);c(m),r(m)},ie=()=>{const m=Ke(i,1);c(m),r(m)},de=(m,k,I)=>{y(m,k,I)},V=(m,k)=>{R(m,k)},G=async m=>{await Ps(m,{houseTechs:o,assignments:h,getAvailabilityStatus:A,currentDate:i,selectedDepartments:b.length>0?b:void 0,madridHolidays:ge}),f(!1)},ae=async m=>{await Es(m,{houseTechs:o,assignments:h,getAvailabilityStatus:A,currentDate:i,selectedDepartments:b.length>0?b:void 0,madridHolidays:ge}),f(!1)},he=(m,k)=>{if(g&&String(m.department||"").trim()!==g)return!1;const U=F(k).some(K=>K.technician_id===m.id),q=A(m.id,k);return!(!H(k)&&!U&&!q)},oe=T.useMemo(()=>F(i),[F,i]),$e=m=>{const I=F(i).find(q=>q.technician_id===m.id),U=A(m.id,i);P(m),$(I),v(U||null),D(!0)},be=()=>{const m=i,k=F(m),I=H(m);return o.reduce((q,K)=>{const z=K.department||"Desconocido";q[z]||(q[z]={total:0,assignedAndAvailable:0,assignedButUnavailable:0,unavailable:0,availableAndNotInWarehouse:0}),q[z].total++;const ne=k.some(we=>we.technician_id===K.id),ve=A(K.id,m),je=!!ve;return je&&q[z].unavailable++,ve==="warehouse"?q[z].availableAndNotInWarehouse++:ne?je?q[z].assignedButUnavailable++:q[z].assignedAndAvailable++:!je&&I&&q[z].availableAndNotInWarehouse++,q},{})},Ne=()=>{const m=i,k=F(m),I=H(m);let U=0,q=0,K=0,z=0,ne=0,ve=0;return o.forEach(je=>{const we=k.some(We=>We.technician_id===je.id),_e=A(je.id,m);(_e==="warehouse"||!we&&!!!_e&&I)&&U++,we&&_e!=="warehouse"&&q++,_e==="vacation"?K++:_e==="day_off"?z++:_e==="travel"?ne++:_e==="sick"&&ve++}),{techsInWarehouse:U,techsOnJobs:q,techsOnVacation:K,techsOnDaysOff:z,techsTravelling:ne,techsSick:ve}},xe=be(),ye=Ne(),p=o.filter(m=>he(m,i)),E=ye.techsOnVacation+ye.techsOnDaysOff+ye.techsTravelling+ye.techsSick,ee=m=>{var U;const k=oe.find(q=>q.technician_id===m.id),I=A(m.id,i);if(I==="vacation")return{key:"off",label:"Vacation",badgeClass:"bg-amber-500/15 text-amber-700 border border-amber-200",Icon:ds,jobTitle:void 0};if(I==="day_off")return{key:"off",label:"Day off",badgeClass:"bg-amber-500/15 text-amber-700 border border-amber-200",Icon:At,jobTitle:void 0};if(I==="travel")return{key:"off",label:"Travel",badgeClass:"bg-blue-500/15 text-blue-700 border border-blue-200",Icon:nt,jobTitle:void 0};if(I==="sick")return{key:"off",label:"Sick day",badgeClass:"bg-red-500/15 text-red-700 border border-red-200",Icon:Pt,jobTitle:void 0};if(I==="unavailable")return{key:"off",label:"Unavailable",badgeClass:"bg-red-500/10 text-red-700 border border-red-200",Icon:ga,jobTitle:void 0};if(I==="warehouse")return{key:"warehouse",label:"Warehouse override",badgeClass:"bg-slate-100 text-slate-700 border border-slate-200",Icon:ze,jobTitle:void 0};if(k){const q=(U=k.job.location)!=null&&U.name?` â€¢ ${k.job.location.name}`:"";return{key:"job",label:"On job",badgeClass:"bg-emerald-500/15 text-emerald-700 border border-emerald-200",Icon:Ue,jobTitle:`${k.job.title}${q}`}}return{key:"warehouse",label:"Warehouse",badgeClass:"bg-slate-100 text-slate-700 border border-slate-200",Icon:ze,jobTitle:void 0}},te=p.filter(m=>{const k=ee(m);return l==="all"?!0:l==="off"?k.key==="off":k.key===l});return J?e.jsx(ue,{className:`h-full flex flex-col ${s.card}`,children:e.jsxs(me,{className:"flex-grow p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:`text-xl font-semibold ${s.textMain}`,children:"Personal Calendar"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{variant:"ghost",size:"icon",onClick:Z,className:s.textMain,children:e.jsx(Be,{className:"h-4 w-4"})}),e.jsx(W,{variant:"ghost",size:"icon",onClick:ie,className:s.textMain,children:e.jsx(Qe,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4",children:[e.jsx("h3",{className:"text-amber-900 dark:text-amber-100 font-semibold mb-2",children:"Error cargando festivos de Madrid"}),e.jsx("p",{className:"text-amber-800 dark:text-amber-200 text-sm mb-2",children:J.message}),e.jsx("p",{className:"text-amber-700 dark:text-amber-300 text-xs",children:"El calendario se mostrarÃ¡ con informaciÃ³n limitada de festivos (solo fines de semana). Los recuentos de almacÃ©n pueden ser inexactos hasta que se carguen los festivos."})]})]})}):u||Y||Ce?e.jsx(ue,{className:`h-full flex flex-col ${s.card}`,children:e.jsx(me,{className:"flex-grow p-4 flex items-center justify-center",children:e.jsx("div",{className:s.textMuted,children:"Cargando calendario..."})})}):o.length===0?e.jsxs(ue,{className:`h-full flex flex-col ${s.card}`,children:[e.jsx(dt,{className:"pb-4",children:e.jsx(ut,{className:`text-lg font-bold ${s.textMain}`,children:"TÃ©cnicos de planta"})}),e.jsxs(me,{className:"flex-grow p-4 flex flex-col items-center justify-center text-center",children:[e.jsx(Ee,{className:`h-8 w-8 mb-2 ${s.textMuted}`}),e.jsx("p",{className:s.textMuted,children:"No se encontraron tÃ©cnicos de planta"}),e.jsx("p",{className:`text-sm mt-1 ${s.textMuted}`,children:'AsegÃºrate de que hay usuarios con el rol "house_tech"'})]})]}):e.jsxs("div",{className:"w-full max-w-[520px] mx-auto space-y-4",children:[e.jsxs("div",{className:`rounded-2xl border px-4 py-3 space-y-3 ${s.card}`,children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-[11px] font-semibold uppercase tracking-[0.08em] text-blue-500",children:"Fecha seleccionada"}),(()=>{const m=Q(i);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`flex items-center gap-2 text-sm font-semibold ${s.textMain}`,children:[e.jsx(Re,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:Ae("",cs(i)&&"text-blue-500"),children:C(i,"EEE, MMM d")}),!H(i)&&e.jsx("span",{className:"text-xs text-amber-600 dark:text-amber-500",title:m||"Non-working day",children:"ðŸ–ï¸"})]}),m&&e.jsx("p",{className:"text-[10px] text-amber-700 dark:text-amber-400 font-medium",children:m})]})})()]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{variant:"ghost",size:"icon",onClick:Z,"aria-label":"DÃ­a anterior",className:s.textMain,children:e.jsx(Be,{className:"h-4 w-4"})}),e.jsx(W,{variant:"ghost",size:"icon",onClick:ie,"aria-label":"DÃ­a siguiente",className:s.textMain,children:e.jsx(Qe,{className:"h-4 w-4"})}),e.jsx(W,{variant:"ghost",size:"icon",onClick:()=>f(!0),"aria-label":"Imprimir calendario",className:s.textMain,children:e.jsx(Ve,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:e.jsxs(W,{variant:"outline",size:"sm",onClick:()=>d(null),disabled:!g,className:`rounded-xl ${s.card} ${s.textMain}`,children:[e.jsx(Ee,{className:"h-4 w-4 mr-2"}),g?`${g}`:"Todos los departamentos"]})}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:`rounded-xl border px-3 py-2 ${a?"bg-slate-900/50 border-slate-800":"bg-slate-50 border-slate-200"}`,children:[e.jsxs("div",{className:`flex items-center gap-1 text-[11px] uppercase font-semibold ${s.textMuted}`,children:[e.jsx(Ue,{className:"h-3.5 w-3.5 text-emerald-600"}),"En trabajo"]}),e.jsx("div",{className:"text-xl font-bold text-emerald-600",children:ye.techsOnJobs})]}),e.jsxs("div",{className:`rounded-xl border px-3 py-2 ${a?"bg-slate-900/50 border-slate-800":"bg-slate-50 border-slate-200"}`,children:[e.jsxs("div",{className:`flex items-center gap-1 text-[11px] uppercase font-semibold ${s.textMuted}`,children:[e.jsx(ze,{className:"h-3.5 w-3.5"}),"AlmacÃ©n"]}),e.jsx("div",{className:`text-xl font-bold ${s.textMain}`,children:ye.techsInWarehouse})]}),e.jsxs("div",{className:`rounded-xl border px-3 py-2 ${a?"bg-slate-900/50 border-slate-800":"bg-slate-50 border-slate-200"}`,children:[e.jsxs("div",{className:`flex items-center gap-1 text-[11px] uppercase font-semibold ${s.textMuted}`,children:[e.jsx(nt,{className:"h-3.5 w-3.5 text-amber-600"}),"Fuera / Viaje"]}),e.jsx("div",{className:"text-xl font-bold text-amber-600",children:E})]})]}),e.jsx("div",{className:"flex items-center gap-2 overflow-x-auto no-scrollbar",children:Object.entries(xe).map(([m,k])=>{const I=U=>{const q=U.toLowerCase();return q==="sound"?e.jsx(_a,{className:"h-4 w-4"}):q==="lights"?e.jsx(ya,{className:"h-4 w-4"}):q==="logistics"?e.jsx(va,{className:"h-4 w-4"}):e.jsx(Ee,{className:"h-4 w-4"})};return e.jsxs("button",{className:Ae("px-3 py-2 rounded-xl border text-left text-xs font-semibold transition-colors flex-shrink-0",g===m?"border-blue-500/70 bg-blue-500/5 text-blue-500":`${a?"bg-slate-900/50 border-slate-800":"bg-slate-50 border-slate-200"} ${s.textMuted} hover:${s.textMain}`),onClick:()=>d(U=>U===m?null:m),children:[e.jsxs("div",{className:"flex items-center gap-1.5 capitalize",children:[I(m),m]}),e.jsxs("div",{className:`text-[11px] ${s.textMuted} mt-0.5`,children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Ue,{className:"h-3 w-3"}),k.assignedAndAvailable]})," â€¢ ",e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(ze,{className:"h-3 w-3"}),k.availableAndNotInWarehouse]})]})]},m)})}),e.jsx("div",{className:`grid grid-cols-4 gap-1 rounded-xl border p-1 ${a?"bg-slate-900/50 border-slate-800":"bg-slate-50 border-slate-200"}`,children:[{key:"all",label:"Todos",count:p.length},{key:"job",label:"Asignados",count:ye.techsOnJobs},{key:"warehouse",label:"Base",count:ye.techsInWarehouse},{key:"off",label:"Fuera",count:E}].map(m=>e.jsxs("button",{onClick:()=>x(m.key),className:Ae("flex flex-col items-center justify-center rounded-lg px-2 py-2 text-[11px] font-semibold transition-colors",l===m.key?`${s.card} shadow-sm text-blue-500`:`${s.textMuted} hover:${s.textMain}`),children:[e.jsx("span",{children:m.label}),e.jsx("span",{className:`text-[10px] ${s.textMuted}`,children:m.count})]},m.key))})]}),e.jsx("div",{className:"space-y-2",children:te.length>0?te.map(m=>{var q,K;const k=ee(m),I=`${m.first_name||""} ${m.last_name||""}`.trim()||"TÃ©cnico sin nombre",U=`${(((q=m.first_name)==null?void 0:q[0])||"").toUpperCase()}${(((K=m.last_name)==null?void 0:K[0])||"").toUpperCase()}`||"HT";return e.jsx(Cn,{technician:m,date:i,onAvailabilityChange:t?void 0:(z,ne,ve)=>de(z,ne,ve),onAvailabilityRemove:t?void 0:V,children:e.jsxs("div",{className:`rounded-2xl border px-4 py-3 shadow-sm transition-colors hover:border-blue-500/50 cursor-pointer ${s.card}`,onClick:()=>$e(m),children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:`h-10 w-10 rounded-full text-sm font-semibold flex items-center justify-center uppercase ${a?"bg-slate-800 text-white":"bg-slate-100 text-slate-900"}`,children:U}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:`text-sm font-semibold truncate ${s.textMain}`,children:I}),m.department&&e.jsx("div",{className:`text-xs capitalize truncate ${s.textMuted}`,children:m.department})]})]}),e.jsxs("span",{className:Ae("inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] font-semibold",k.badgeClass),children:[e.jsx(k.Icon,{className:"h-3 w-3"}),k.label]})]}),k.jobTitle&&e.jsx("div",{className:`mt-2 text-xs line-clamp-1 ${s.textMuted}`,children:k.jobTitle})]})},m.id)}):e.jsxs("div",{className:`flex flex-col items-center justify-center py-10 text-center rounded-2xl border ${s.card}`,children:[e.jsx(Re,{className:`h-8 w-8 mb-2 ${s.textMuted}`}),e.jsx("p",{className:s.textMuted,children:"No hay tÃ©cnicos programados"}),e.jsxs("p",{className:`text-sm ${s.textMuted}`,children:["para ",C(i,"MMMM d, yyyy")]})]})}),e.jsx(_s,{showDialog:_,setShowDialog:f,currentMonth:i,onGeneratePDF:G,onGenerateXLS:ae,departments:X,selectedDepartments:b,onDepartmentsChange:O}),S&&e.jsx(ws,{open:M,onOpenChange:D,technician:S,assignment:j,date:i,availabilityStatus:N,onAvailabilityChange:(m,k,I)=>de(m,k,I),onAvailabilityRemove:(m,k)=>V(m,k)})]})},Oe={async submitRequest(n){const{data:{user:r}}=await L.auth.getUser();if(!r)throw new Error("User not authenticated");const{data:t,error:s}=await L.from("vacation_requests").insert({technician_id:r.id,start_date:n.start_date,end_date:n.end_date,reason:n.reason,status:"pending"}).select().single();if(s)throw s;return t},async getUserRequests(){const{data:{user:n}}=await L.auth.getUser();if(!n)throw new Error("User not authenticated");const{data:r,error:t}=await L.from("vacation_requests").select(`
        *,
        technicians:profiles!technician_id(first_name, last_name, department, email)
      `).eq("technician_id",n.id).order("created_at",{ascending:!1});if(t)throw t;return r},async getDepartmentRequests(){const{data:n,error:r}=await L.from("vacation_requests").select(`
        *,
        technicians:profiles!technician_id(first_name, last_name, department)
      `).order("created_at",{ascending:!1});if(r)throw r;return n},async getPendingRequests(){const{data:n,error:r}=await L.from("vacation_requests").select(`
        *,
        technicians:profiles!technician_id(first_name, last_name, department)
      `).eq("status","pending").order("created_at",{ascending:!0});if(r)throw r;return n},async approveRequests(n){const{data:{user:r}}=await L.auth.getUser();if(!r)throw new Error("User not authenticated");const{data:t,error:s}=await L.from("vacation_requests").update({status:"approved",approved_by:r.id,approved_at:new Date().toISOString()}).in("id",n).select();if(s)throw s;try{const a=(t??[]).map(i=>i.id);a.length&&await L.functions.invoke("send-vacation-decision",{body:{request_ids:a}})}catch{}return t},async rejectRequests(n,r){const{data:{user:t}}=await L.auth.getUser();if(!t)throw new Error("User not authenticated");const{data:s,error:a}=await L.from("vacation_requests").update({status:"rejected",approved_by:t.id,approved_at:new Date().toISOString(),rejection_reason:r}).in("id",n).select();if(a)throw a;try{const i=(s??[]).map(c=>c.id);i.length&&await L.functions.invoke("send-vacation-decision",{body:{request_ids:i}})}catch{}return s},async submitSoundVisionAccessRequest(n,r="sound"){const{data:{user:t}}=await L.auth.getUser();if(!t)throw new Error("User not authenticated");const s=new Date().toISOString().split("T")[0],{data:a,error:i}=await L.from("vacation_requests").insert({technician_id:t.id,start_date:s,end_date:s,reason:n,status:"pending"}).select().single();if(i)throw i;const{data:c}=await L.from("profiles").select("first_name, last_name").eq("id",t.id).single(),g=`SoundVision Access Request from ${c==null?void 0:c.first_name} ${c==null?void 0:c.last_name}:

${n}`,{error:d}=await L.from("messages").insert({content:g,department:r,sender_id:t.id,status:"unread",metadata:{type:"soundvision_access_request",vacation_request_id:a.id}});if(d)throw d;return a}},Ot=()=>{const{toast:n}=_t(),r=ea(),t=ht({queryKey:["vacation-requests","user"],queryFn:Oe.getUserRequests}),s=ht({queryKey:["vacation-requests","department"],queryFn:Oe.getDepartmentRequests}),a=ht({queryKey:["vacation-requests","pending"],queryFn:Oe.getPendingRequests}),i=pt({mutationFn:Oe.submitRequest,onSuccess:()=>{r.invalidateQueries({queryKey:["vacation-requests"]}),n({title:"Request submitted!",description:"Your vacation request has been submitted for approval."})},onError:d=>{n({title:"Error submitting request",description:d.message||"An unexpected error occurred.",variant:"destructive"})}}),c=pt({mutationFn:Oe.approveRequests,onSuccess:d=>{r.invalidateQueries({queryKey:["vacation-requests"]}),n({title:"Requests approved!",description:`${d.length} vacation request(s) have been approved.`})},onError:d=>{n({title:"Approval failed",description:d.message||"Failed to approve selected requests.",variant:"destructive"})}}),g=pt({mutationFn:({requestIds:d,rejectionReason:l})=>Oe.rejectRequests(d,l),onSuccess:d=>{r.invalidateQueries({queryKey:["vacation-requests"]}),n({title:"Requests rejected!",description:`${d.length} vacation request(s) have been rejected.`})},onError:d=>{n({title:"Rejection failed",description:d.message||"Failed to reject selected requests.",variant:"destructive"})}});return{userRequests:t.data||[],pendingRequests:a.data||[],departmentRequests:s.data||[],isLoadingUserRequests:t.isLoading,isLoadingPendingRequests:a.isLoading,isLoadingDepartmentRequests:s.isLoading,submitRequest:i.mutate,approveRequests:c.mutate,rejectRequests:g.mutate,isSubmitting:i.isPending,isApproving:c.isPending,isRejecting:g.isPending}},Kt=({onSubmit:n,isSubmitting:r=!1,theme:t,isDark:s})=>{const[a,i]=T.useState(""),[c,g]=T.useState(""),[d,l]=T.useState(""),x=f=>{f.preventDefault(),!(!a||!c||!d.trim())&&(n({startDate:a,endDate:c,reason:d}),i(""),g(""),l(""))},_=a&&c&&d.trim()&&new Date(a)<=new Date(c);return e.jsxs(ue,{className:`border shadow-sm ${t.card}`,children:[e.jsxs(dt,{className:"px-4 py-5 space-y-2",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-amber-200/60 bg-amber-50 px-3 py-1 text-xs font-semibold text-amber-700 dark:border-amber-500/30 dark:bg-amber-500/10 dark:text-amber-200",children:[e.jsx(ds,{className:"h-4 w-4"}),"Solicitud mÃ³vil"]}),e.jsx(ut,{className:`text-xl font-bold flex items-center gap-2 ${t.textMain}`,children:e.jsx("span",{children:"Nueva solicitud de vacaciones"})}),e.jsxs("p",{className:`text-sm flex items-center gap-2 ${t.textMuted}`,children:[e.jsx(lt,{className:"h-4 w-4"}),"Elige rango de fechas y motivo para enviar a aprobaciÃ³n."]})]}),e.jsx(me,{className:"px-4 pb-5",children:e.jsxs("form",{onSubmit:x,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[e.jsx(Ye,{htmlFor:"startDate",className:`text-xs uppercase tracking-wide ${t.textMuted}`,children:"Fecha de inicio"}),e.jsx(Yt,{id:"startDate",type:"date",value:a,onChange:f=>i(f.target.value),required:!0,disabled:r,className:`rounded-xl ${t.input}`})]}),e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[e.jsx(Ye,{htmlFor:"endDate",className:`text-xs uppercase tracking-wide ${t.textMuted}`,children:"Fecha de fin"}),e.jsx(Yt,{id:"endDate",type:"date",value:c,onChange:f=>g(f.target.value),required:!0,disabled:r,min:a,className:`rounded-xl ${t.input}`})]})]}),e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[e.jsx(Ye,{htmlFor:"reason",className:`text-xs uppercase tracking-wide ${t.textMuted}`,children:"Motivo"}),e.jsx(ta,{id:"reason",value:d,onChange:f=>l(f.target.value),placeholder:"Vacaciones, asuntos personales, viaje, etc.",required:!0,disabled:r,rows:3,className:`rounded-xl ${t.input}`})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx("div",{className:`rounded-xl border border-dashed p-3 text-xs ${s?"border-amber-500/40 bg-amber-500/10 text-amber-100":"border-amber-200 bg-amber-50/60 text-amber-800"}`,children:"EnvÃ­a con antelaciÃ³n para evitar conflictos con asignaciones activas."}),e.jsx("div",{className:`rounded-xl border border-dashed p-3 text-xs ${s?"border-slate-800 bg-slate-900 text-slate-400":"border-slate-200 bg-white text-slate-500"}`,children:"RecibirÃ¡s confirmaciÃ³n por correo cuando sea aprobada o rechazada."})]}),e.jsxs(W,{type:"submit",disabled:!_||r,className:`w-full rounded-xl text-base font-semibold ${t.accent}`,children:[r&&e.jsx(sa,{className:"mr-2 h-4 w-4 animate-spin"}),"Enviar solicitud"]})]})})]})},An=(n,r)=>new Promise(t=>{const s=new Image,a=setTimeout(()=>{t(null)},3e3);s.onload=()=>{clearTimeout(a),t(s)},s.onerror=()=>{clearTimeout(a),t(null)},s.crossOrigin="anonymous",s.src=n}),Pn=async n=>{if(!n)return"Unknown";try{const{data:r,error:t}=await ss.from("profiles").select("first_name, last_name").eq("id",n).single();return t||!r?"Unknown":`${r.first_name||""} ${r.last_name||""}`.trim()||"Unknown"}catch{return"Unknown"}},Is=async n=>{try{const{data:r,error:t}=await ss.from("profiles").select("first_name, last_name, department").eq("id",n).single();if(t||!r)return{name:"Not Available",department:"Not Available"};const s=`${r.first_name||""} ${r.last_name||""}`.trim()||"Not Available",a=r.department||"Not Available";return{name:s,department:a}}catch{return{name:"Not Available",department:"Not Available"}}},En=async({request:n,approverName:r})=>{const t=await as(),s=new t,a=s.internal.pageSize.getWidth(),i=s.internal.pageSize.getHeight(),c=[125,1,1],g=[125,1,25];let d=null;const l=["/sector pro logo.png","/lovable-uploads/ce3ff31a-4cc5-43c8-b5bb-a4056d3735e4.png","./sector pro logo.png","sector pro logo.png"];for(const o of l)if(d=await An(o),d)break;s.setFillColor(c[0],c[1],c[2]),s.rect(0,0,a,25,"F"),s.setTextColor(255,255,255),s.setFontSize(18),s.setFont("helvetica","bold"),s.text("SOLICITUD DE VACACIONES",a/2,15,{align:"center"}),s.setTextColor(0,0,0),s.setFontSize(16),s.setFont("helvetica","bold"),s.text("Detalles",15,45);let x=60,_=r;!_&&n.approved_by&&(_=await Pn(n.approved_by));const f=await Is(n.technician_id),b=f.name,O=f.department;s.setFontSize(12),s.setFont("helvetica","normal");const M=(o,h,u)=>(s.setFont("helvetica","bold"),s.text(o+":",15,u),s.setFont("helvetica","normal"),s.text(h,80,u),u+10);x=M("Nombre del Empleado",b,x),x=M("Departmento",O,x),x=M("Fecha de la Solicitud",C(new Date(n.created_at),"PPP"),x),x+=5,x=M("Periodo",`${C(new Date(n.start_date),"PPP")} - ${C(new Date(n.end_date),"PPP")}`,x);const D=new Date(n.start_date),S=new Date(n.end_date),P=Math.ceil((S.getTime()-D.getTime())/(1e3*60*60*24))+1;x=M("Duracion",`${P} day${P>1?"s":""}`,x),x+=5,s.setFont("helvetica","bold"),s.text("Motivo:",15,x),x+=10,s.setFont("helvetica","normal");const j=s.splitTextToSize(n.reason||"No reason provided",a-30);s.text(j,15,x),x+=j.length*7+10,x=M("Estado",n.status.toUpperCase(),x);const N={pending:[255,193,7],approved:[40,167,69],rejected:[220,53,69]}[n.status]||[108,117,125];if(s.setFillColor(N[0],N[1],N[2]),s.circle(70,x-5,3,"F"),x+=5,n.status==="approved"&&n.approved_at)x=M("Aprobado por",_||"Not Available",x),x=M("Fecha de aprobacion",C(new Date(n.approved_at),"PPP"),x);else if(n.status==="rejected"&&n.approved_at&&(x=M("Rechazado por",_||"Not Available",x),x=M("Fecha de rechazo",C(new Date(n.approved_at),"PPP"),x),n.rejection_reason)){x+=5,s.setFont("helvetica","bold"),s.text("Motivo del Rechazo",15,x),x+=10,s.setFont("helvetica","normal");const o=s.splitTextToSize(n.rejection_reason,a-30);s.text(o,15,x),x+=o.length*7}const v=i-30;if(s.setFillColor(g[0],g[1],g[2]),s.rect(0,v,a,30,"F"),s.setTextColor(255,255,255),s.setFontSize(10),s.setFont("helvetica","normal"),d){const h=10*(d.width/d.height),u=(a-h)/2;s.addImage(d,"PNG",u,v+5,h,10)}return s.text(C(new Date,"PPP p"),a-15,v+10,{align:"right"}),s.text("Page 1 of 1",a/2,v+20,{align:"center"}),new Promise(o=>{const h=s.output("blob");o(h)})},Ss=async n=>{try{const r=await En(n),t=URL.createObjectURL(r),s=document.createElement("a");s.href=t;const i=(await Is(n.request.technician_id)).name.replace(/[^a-zA-Z0-9\s]/g,"").replace(/\s+/g," ").trim().replace(/\s/g,"_"),c=C(new Date(n.request.created_at),"MMM_dd_yyyy");s.download=`vacation_request_${i}_${c}.pdf`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(t)}catch(r){throw r}},at=({theme:n,isDark:r,filter:t,source:s="user"})=>{const{userRequests:a,departmentRequests:i,isLoadingUserRequests:c,isLoadingDepartmentRequests:g}=Ot(),{toast:d}=_t(),[l,x]=Pe.useState(!1),[_,f]=Pe.useState([]),[b,O]=Pe.useState(!1),M=Tt();Pe.useEffect(()=>{let o=!1;return(async()=>{var y,R;const{data:{user:h}}=await L.auth.getUser();let u=((y=h==null?void 0:h.app_metadata)==null?void 0:y.role)||((R=h==null?void 0:h.user_metadata)==null?void 0:R.role)||null;if(!u&&(h!=null&&h.id)){const{data:A}=await L.from("profiles").select("role").eq("id",h.id).maybeSingle();u=(A==null?void 0:A.role)??null}o||x(u==="admin"||u==="management")})(),()=>{o=!0}},[]);const D=async o=>{try{await Ss({request:o})}catch{}},S=async o=>{try{f(u=>[...u,o.id]);const{error:h}=await L.functions.invoke("send-vacation-decision",{body:{request_id:o.id}});if(h)throw h;d({title:"Correo reenviado",description:"El correo con la decisiÃ³n y PDF se ha reenviado."})}catch(h){d({title:"Error al reenviar",description:(h==null?void 0:h.message)||"No se pudo reenviar el correo de decisiÃ³n.",variant:"destructive"})}finally{f(h=>h.filter(u=>u!==o.id))}},P=o=>{switch(o){case"pending":return e.jsxs(ke,{variant:"outline",className:"text-yellow-600",children:[e.jsx(Dt,{className:"h-3 w-3 mr-1"}),"Pendiente"]});case"approved":return e.jsxs(ke,{variant:"default",className:"bg-green-100 text-green-800",children:[e.jsx(ps,{className:"h-3 w-3 mr-1"}),"Aprobada"]});case"rejected":return e.jsxs(ke,{variant:"destructive",children:[e.jsx(hs,{className:"h-3 w-3 mr-1"}),"Rechazada"]});default:return e.jsx(ke,{variant:"secondary",children:o})}},j=s==="department"?i:a,$=t?j.filter(o=>o.status===t):j,N=s==="department"?g:c,v=()=>b?N?e.jsx(ue,{className:n.card,children:e.jsx(me,{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:n.textMuted,children:"Cargando solicitudes..."})})}):$.length===0?e.jsx(ue,{className:`border-dashed ${n.card}`,children:e.jsxs(me,{className:"py-8 text-center space-y-2",children:[e.jsx(lt,{className:`h-8 w-8 mx-auto ${n.textMuted}`}),e.jsx("p",{className:`text-sm ${n.textMuted}`,children:l?"No hay solicitudes de vacaciones en tu departamento.":"AÃºn no has enviado solicitudes de vacaciones."})]})}):e.jsx("div",{className:"space-y-3",children:$.map(o=>{const h=o.technicians&&(`${o.technicians.first_name??""} ${o.technicians.last_name??""}`.trim()||o.technicians.email)||o.technician_id;return e.jsx(ue,{className:`rounded-2xl border ${n.card}`,children:e.jsxs(me,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:`text-xs uppercase tracking-wide ${n.textMuted}`,children:"TÃ©cnico"}),e.jsx("p",{className:`text-sm font-semibold leading-tight ${n.textMain}`,children:h})]}),P(o.status)]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:`rounded-xl px-3 py-2 ${r?"bg-slate-900/50":"bg-slate-100"}`,children:[e.jsx("p",{className:`text-[11px] uppercase ${n.textMuted}`,children:"Inicio"}),e.jsx("p",{className:`font-semibold ${n.textMain}`,children:C(new Date(o.start_date),"d MMM yyyy")})]}),e.jsxs("div",{className:`rounded-xl px-3 py-2 ${r?"bg-slate-900/50":"bg-slate-100"}`,children:[e.jsx("p",{className:`text-[11px] uppercase ${n.textMuted}`,children:"Fin"}),e.jsx("p",{className:`font-semibold ${n.textMain}`,children:C(new Date(o.end_date),"d MMM yyyy")})]})]}),e.jsx("div",{className:`rounded-xl border px-3 py-2 text-sm ${r?"bg-slate-900/30 border-slate-800 text-slate-400":"bg-slate-50 border-slate-200 text-slate-600"}`,children:o.reason}),e.jsxs("div",{className:`flex items-center justify-between text-xs ${n.textMuted}`,children:[e.jsxs("span",{children:["Enviada: ",C(new Date(o.created_at),"d MMM yyyy")]}),e.jsxs("span",{children:["Respuesta: ",o.approved_at?C(new Date(o.approved_at),"d MMM yyyy"):"Pendiente"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(W,{variant:"secondary",className:`flex-1 ${r?"bg-slate-800 text-slate-300 hover:bg-slate-700":""}`,size:"sm",onClick:()=>D(o),"aria-label":"Exportar PDF",children:[e.jsx(vt,{className:"h-4 w-4 mr-2"})," PDF"]}),l&&o.status!=="pending"&&e.jsxs(W,{variant:"outline",className:`flex-1 ${n.card} ${n.textMain}`,size:"sm",onClick:()=>S(o),disabled:_.includes(o.id),children:[e.jsx(Bt,{className:"h-4 w-4 mr-2"})," Reenviar"]})]})]})},o.id)})}):null;return M?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`flex items-center justify-between gap-2 text-sm ${n.textMuted} cursor-pointer`,onClick:()=>O(!b),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qt,{className:"h-4 w-4"}),"Historial de solicitudes"]}),b?e.jsx(gt,{className:"h-4 w-4"}):e.jsx(bt,{className:"h-4 w-4"})]}),v()]}):e.jsxs(ue,{className:`${n.card} w-full`,children:[e.jsx(dt,{className:"px-3 sm:px-6 py-4 sm:py-6 cursor-pointer",onClick:()=>O(!b),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ut,{className:`flex items-center gap-2 ${n.textMain}`,children:[e.jsx(Qt,{className:"h-5 w-5"}),"Historial de solicitudes"]}),b?e.jsx(gt,{className:"h-5 w-5"}):e.jsx(bt,{className:"h-5 w-5"})]})}),b&&e.jsx(me,{className:"px-3 sm:px-6",children:N?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:n.textMuted,children:"Cargando solicitudes..."})}):$.length===0?e.jsx("div",{className:`text-center py-8 ${n.textMuted}`,children:l?"No hay solicitudes de vacaciones en tu departamento.":"AÃºn no has enviado solicitudes de vacaciones."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(us,{children:[e.jsx(ms,{children:e.jsxs(ot,{className:r?"border-slate-800 hover:bg-slate-900/50":"border-slate-200",children:[e.jsx(pe,{className:n.textMuted,children:"TÃ©cnico"}),e.jsx(pe,{className:n.textMuted,children:"Inicio"}),e.jsx(pe,{className:n.textMuted,children:"Fin"}),e.jsx(pe,{className:n.textMuted,children:"Motivo"}),e.jsx(pe,{className:n.textMuted,children:"Estado"}),e.jsx(pe,{className:n.textMuted,children:"Enviada"}),e.jsx(pe,{className:n.textMuted,children:"Respuesta"}),e.jsx(pe,{className:`w-[120px] ${n.textMuted}`,children:"Acciones"})]})}),e.jsx(xs,{children:$.map(o=>e.jsxs(ot,{className:r?"border-slate-800 hover:bg-slate-900/50":"border-slate-200",children:[e.jsx(fe,{className:n.textMain,children:o.technicians&&(`${o.technicians.first_name??""} ${o.technicians.last_name??""}`.trim()||o.technicians.email)||o.technician_id}),e.jsx(fe,{className:n.textMain,children:C(new Date(o.start_date),"d MMM yyyy")}),e.jsx(fe,{className:n.textMain,children:C(new Date(o.end_date),"d MMM yyyy")}),e.jsx(fe,{className:`max-w-[200px] truncate ${n.textMain}`,children:o.reason}),e.jsx(fe,{children:P(o.status)}),e.jsx(fe,{className:n.textMain,children:C(new Date(o.created_at),"d MMM yyyy")}),e.jsx(fe,{className:n.textMain,children:o.approved_at?C(new Date(o.approved_at),"d MMM yyyy"):"-"}),e.jsxs(fe,{className:"space-x-1",children:[e.jsx(W,{variant:"ghost",size:"sm",onClick:h=>{h.stopPropagation(),D(o)},className:`h-8 w-8 p-0 ${n.textMain}`,title:"Exportar PDF",children:e.jsx(vt,{className:"h-4 w-4"})}),l&&o.status!=="pending"&&e.jsx(W,{variant:"ghost",size:"sm",onClick:h=>{h.stopPropagation(),S(o)},className:`h-8 w-8 p-0 ${n.textMain}`,title:"Reenviar correo de decisiÃ³n",disabled:_.includes(o.id),children:e.jsx(Bt,{className:"h-4 w-4"})})]})]},o.id))})]})})})]})},Fn=({userRole:n,onVacationRequestSubmit:r,isSubmitting:t,theme:s,isDark:a})=>{const i=Tt(),[c,g]=T.useState([]),{departmentRequests:d,isLoadingDepartmentRequests:l,approveRequests:x,rejectRequests:_,isApproving:f,isRejecting:b}=Ot(),O=(u,y)=>{g(R=>y?[...R,u]:R.filter(A=>A!==u))},M=(u,y)=>{g(u?y.map(R=>R.id):[])},D=()=>{c.length!==0&&(x(c),g([]))},S=()=>{c.length!==0&&(_({requestIds:c}),g([]))},P=async u=>{try{const y=u.technicians?`${u.technicians.first_name} ${u.technicians.last_name}`:void 0;await Ss({request:u,approverName:y})}catch{}},j=u=>{switch(u){case"pending":return e.jsxs(ke,{variant:"outline",className:"text-yellow-600",children:[e.jsx(Dt,{className:"h-3 w-3 mr-1"}),"Pendiente"]});case"approved":return e.jsxs(ke,{variant:"default",className:"bg-green-100 text-green-800",children:[e.jsx(ps,{className:"h-3 w-3 mr-1"}),"Aprobada"]});case"rejected":return e.jsxs(ke,{variant:"destructive",children:[e.jsx(hs,{className:"h-3 w-3 mr-1"}),"Rechazada"]});default:return e.jsx(ke,{variant:"secondary",children:u})}},$=({request:u})=>{const[y,R]=Pe.useState(!1),[A,Y]=Pe.useState(!1),[H,Q]=Pe.useState(null),ge=async()=>{if(!(!(u!=null&&u.technician_id)||!(u!=null&&u.start_date)||!(u!=null&&u.end_date))){Y(!0);try{const F=new Date(`${u.start_date}T00:00:00`),X=new Date(`${u.end_date}T23:59:59.999`),{data:Z,error:ie}=await L.from("job_assignments").select(`
            jobs!inner (
              id,
              title,
              start_time,
              end_time,
              locations(name)
            )
          `).eq("technician_id",u.technician_id).lte("jobs.start_time",X.toISOString()).gte("jobs.end_time",F.toISOString());if(ie)throw ie;const de=(Z||[]).map(V=>Array.isArray(V.jobs)?V.jobs[0]:V.jobs).filter(Boolean);Q(de)}catch{Q([])}finally{Y(!1)}}},Ce=F=>{R(F),F&&H===null&&ge()};Pe.useEffect(()=>{H===null&&ge()},[]);const J=(H==null?void 0:H.length)??0;return e.jsxs(ja,{open:y,onOpenChange:Ce,children:[e.jsx(wa,{asChild:!0,children:e.jsxs("div",{className:"relative inline-flex cursor-default",title:J>0?`${J} conflictos`:void 0,children:[j(u.status),H&&J>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[16px] h-[16px] px-[3px] rounded-full bg-red-600 text-white text-[10px] leading-[16px] text-center font-semibold shadow",children:J})]})}),e.jsx(Na,{className:"w-96",side:"top",align:"center",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-medium",children:"Conflictos de asignaciÃ³n"}),A&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Comprobandoâ€¦"}),!A&&H&&H.length===0&&e.jsx("div",{className:"text-sm text-green-700",children:"No se detectaron conflictos en este periodo."}),!A&&H&&H.length>0&&e.jsx("div",{className:"max-h-64 overflow-auto space-y-2",children:H.map(F=>{var de;const X=new Date(F.start_time),Z=new Date(F.end_time),ie=F.locations&&Array.isArray(F.locations)&&((de=F.locations[0])!=null&&de.name)?` â€¢ ${F.locations[0].name}`:"";return e.jsxs("div",{className:"rounded-md border p-2",children:[e.jsxs("div",{className:"text-sm font-medium",children:[e.jsx("a",{className:"text-blue-600 hover:underline",href:`/jobs/view/${F.id}`,target:"_blank",rel:"noopener noreferrer",children:F.title||"Trabajo"}),ie]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[C(X,"PPpp")," â€“ ",C(Z,"PPpp")]})]},F.id)})}),!A&&H===null&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Pasa el cursor para comprobar conflictos."})]})})]})},N=()=>{if(l)return e.jsx(ue,{className:s.card,children:e.jsx(me,{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:s.textMuted,children:"Cargando solicitudes del departamento..."})})});const u=d.filter(y=>y.status==="pending");return e.jsxs(ue,{className:s.card,children:[e.jsx(dt,{className:"px-3 sm:px-6 py-4 sm:py-6",children:e.jsxs(ut,{className:`flex items-center gap-2 ${s.textMain}`,children:[e.jsx(Ee,{className:"h-5 w-5"}),"Solicitudes de vacaciones del departamento"]})}),e.jsx(me,{className:"px-3 sm:px-6",children:u.length===0?e.jsx("div",{className:`text-center py-8 ${s.textMuted}`,children:"No hay solicitudes pendientes en tu departamento."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-2 mb-4",children:[e.jsxs(W,{onClick:D,disabled:c.length===0||f,className:"bg-green-600 hover:bg-green-700",children:["Aprobar seleccionadas (",c.length,")"]}),e.jsxs(W,{variant:"outline",onClick:S,disabled:c.length===0||b,className:"border-red-200 text-red-600 hover:bg-red-50",children:["Rechazar seleccionadas (",c.length,")"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(us,{children:[e.jsx(ms,{children:e.jsxs(ot,{className:a?"border-slate-800 hover:bg-slate-900/50":"border-slate-200",children:[e.jsx(pe,{className:"w-[50px]",children:e.jsx(yt,{checked:c.length===u.length&&u.length>0,onCheckedChange:y=>M(y,u)})}),e.jsx(pe,{className:s.textMuted,children:"TÃ©cnico"}),e.jsx(pe,{className:`hidden sm:table-cell ${s.textMuted}`,children:"Departamento"}),e.jsx(pe,{className:s.textMuted,children:"Inicio"}),e.jsx(pe,{className:s.textMuted,children:"Fin"}),e.jsx(pe,{className:`hidden lg:table-cell ${s.textMuted}`,children:"Motivo"}),e.jsx(pe,{className:`hidden md:table-cell ${s.textMuted}`,children:"Solicitada"}),e.jsx(pe,{className:s.textMuted,children:"Estado"}),e.jsx(pe,{className:`w-[80px] ${s.textMuted}`,children:"Acciones"})]})}),e.jsx(xs,{children:u.map(y=>{var R;return e.jsxs(ot,{className:a?"border-slate-800 hover:bg-slate-900/50":"border-slate-200",children:[e.jsx(fe,{children:e.jsx(yt,{checked:c.includes(y.id),onCheckedChange:A=>O(y.id,A)})}),e.jsx(fe,{className:s.textMain,children:y.technicians?`${y.technicians.first_name} ${y.technicians.last_name}`:"N/A"}),e.jsx(fe,{className:`hidden sm:table-cell ${s.textMain}`,children:((R=y.technicians)==null?void 0:R.department)||"N/A"}),e.jsx(fe,{className:s.textMain,children:C(new Date(y.start_date),"d MMM yyyy")}),e.jsx(fe,{className:s.textMain,children:C(new Date(y.end_date),"d MMM yyyy")}),e.jsx(fe,{className:`hidden lg:table-cell max-w-[200px] truncate ${s.textMain}`,children:y.reason}),e.jsx(fe,{className:`hidden md:table-cell ${s.textMain}`,children:C(new Date(y.created_at),"d MMM yyyy")}),e.jsx(fe,{children:e.jsx($,{request:y})}),e.jsx(fe,{children:e.jsx(W,{variant:"ghost",size:"sm",onClick:()=>P(y),className:`h-8 w-8 p-0 ${s.textMain}`,title:"Exportar PDF",children:e.jsx(vt,{className:"h-4 w-4"})})})]},y.id)})})]})})]})})]})},[v,o]=T.useState(null),h=u=>{o(y=>y===u?null:u)};if(i){const u=d,y=u.filter(Y=>Y.status==="pending").length,R=u.filter(Y=>Y.status==="approved").length,A=u.filter(Y=>Y.status==="rejected").length;return e.jsxs("div",{className:`${s.bg} rounded-[28px] p-4 space-y-4 shadow-inner border ${a?"border-[#1f232e]":"border-slate-200"} w-full max-w-full overflow-hidden`,children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] font-semibold uppercase tracking-[0.08em] text-blue-500",children:"Vacaciones"}),e.jsx("h3",{className:`text-xl font-bold ${s.textMain}`,children:"GestiÃ³n de solicitudes"}),e.jsx("p",{className:`text-xs ${s.textMuted}`,children:"EnvÃ­a, revisa y exporta desde el mÃ³vil."})]})}),e.jsxs(Ut,{defaultValue:"my-requests",className:"w-full",children:[e.jsxs(Vt,{className:`w-full ${a?"bg-slate-900":"bg-slate-100"}`,children:[e.jsxs(tt,{value:"my-requests",className:"flex-1 flex items-center justify-center gap-2",children:[e.jsx(lt,{className:"h-4 w-4"}),"Mis solicitudes"]}),(n==="management"||n==="admin")&&e.jsxs(tt,{value:"department-requests",className:"flex-1 flex items-center justify-center gap-2",children:[e.jsx(Ee,{className:"h-4 w-4"}),"Dpto."]})]}),e.jsx(st,{value:"my-requests",className:"space-y-4 mt-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(Kt,{onSubmit:r,isSubmitting:t,theme:s,isDark:a}),e.jsx(at,{theme:s,isDark:a,source:"user"})]})}),(n==="management"||n==="admin")&&e.jsxs(st,{value:"department-requests",className:"space-y-4 mt-4",children:[e.jsx(ue,{className:`${s.card} rounded-2xl`,children:e.jsxs(me,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{onClick:()=>h("pending"),className:`rounded-xl border px-3 py-2 text-center cursor-pointer transition-colors ${v==="pending"||v===null?"bg-amber-500/20 border-amber-500/50 ring-1 ring-amber-500/50":a?"bg-slate-900/50 border-slate-800 hover:bg-slate-900":"bg-slate-50 border-slate-200 hover:bg-slate-100"}`,children:[e.jsx("p",{className:`text-[11px] uppercase font-semibold ${s.textMuted}`,children:"Pendientes"}),e.jsx("p",{className:`text-lg font-bold ${s.textMain}`,children:y})]}),e.jsxs("div",{onClick:()=>h("approved"),className:`rounded-xl border px-3 py-2 text-center cursor-pointer transition-colors ${v==="approved"?"bg-emerald-500/20 border-emerald-500/50 ring-1 ring-emerald-500/50":a?"bg-slate-900/50 border-slate-800 hover:bg-slate-900":"bg-slate-50 border-slate-200 hover:bg-slate-100"}`,children:[e.jsx("p",{className:`text-[11px] uppercase font-semibold ${s.textMuted}`,children:"Aprobadas"}),e.jsx("p",{className:"text-lg font-bold text-emerald-500",children:R})]}),e.jsxs("div",{onClick:()=>h("rejected"),className:`rounded-xl border px-3 py-2 text-center cursor-pointer transition-colors ${v==="rejected"?"bg-red-500/20 border-red-500/50 ring-1 ring-red-500/50":a?"bg-slate-900/50 border-slate-800 hover:bg-slate-900":"bg-slate-50 border-slate-200 hover:bg-slate-100"}`,children:[e.jsx("p",{className:`text-[11px] uppercase font-semibold ${s.textMuted}`,children:"Rechazadas"}),e.jsx("p",{className:"text-lg font-bold text-red-500",children:A})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(Ee,{className:"h-4 w-4"}),v?e.jsxs("span",{children:["Filtrando por: ",e.jsx("span",{className:"font-semibold capitalize",children:v==="pending"?"Pendientes":v==="approved"?"Aprobadas":"Rechazadas"})]}):e.jsx("span",{children:"Mostrando solicitudes pendientes de aprobaciÃ³n."})]})]})}),!v||v==="pending"?N():e.jsx(at,{theme:s,isDark:a,filter:v,source:"department"})]})]})]})}return e.jsxs(Ut,{defaultValue:"my-requests",className:"w-full overflow-x-auto",children:[e.jsxs(Vt,{className:`w-full ${a?"bg-slate-900":"bg-slate-100"}`,children:[e.jsxs(tt,{value:"my-requests",className:"flex-1 flex items-center justify-center gap-2",children:[e.jsx(lt,{className:"h-4 w-4"}),"Mis solicitudes"]}),(n==="management"||n==="admin")&&e.jsxs(tt,{value:"department-requests",className:"flex-1 flex items-center justify-center gap-2",children:[e.jsx(Ee,{className:"h-4 w-4"}),"Solicitudes del departamento"]})]}),e.jsxs(st,{value:"my-requests",className:"space-y-4",children:[e.jsx(Kt,{onSubmit:r,isSubmitting:t,theme:s,isDark:a}),e.jsx(at,{theme:s,isDark:a,source:"user"})]}),(n==="management"||n==="admin")&&e.jsxs(st,{value:"department-requests",className:"space-y-4",children:[e.jsx(ue,{className:`${s.card} rounded-2xl`,children:e.jsx(me,{className:"p-4 space-y-3",children:e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{onClick:()=>h("pending"),className:`rounded-xl border px-3 py-2 text-center cursor-pointer transition-colors ${v==="pending"||v===null?"bg-amber-500/20 border-amber-500/50 ring-1 ring-amber-500/50":a?"bg-slate-900/50 border-slate-800 hover:bg-slate-900":"bg-slate-50 border-slate-200 hover:bg-slate-100"}`,children:[e.jsx("p",{className:`text-[11px] uppercase font-semibold ${s.textMuted}`,children:"Pendientes"}),e.jsx("p",{className:`text-lg font-bold ${s.textMain}`,children:d.filter(u=>u.status==="pending").length})]}),e.jsxs("div",{onClick:()=>h("approved"),className:`rounded-xl border px-3 py-2 text-center cursor-pointer transition-colors ${v==="approved"?"bg-emerald-500/20 border-emerald-500/50 ring-1 ring-emerald-500/50":a?"bg-slate-900/50 border-slate-800 hover:bg-slate-900":"bg-slate-50 border-slate-200 hover:bg-slate-100"}`,children:[e.jsx("p",{className:`text-[11px] uppercase font-semibold ${s.textMuted}`,children:"Aprobadas"}),e.jsx("p",{className:"text-lg font-bold text-emerald-500",children:d.filter(u=>u.status==="approved").length})]}),e.jsxs("div",{onClick:()=>h("rejected"),className:`rounded-xl border px-3 py-2 text-center cursor-pointer transition-colors ${v==="rejected"?"bg-red-500/20 border-red-500/50 ring-1 ring-red-500/50":a?"bg-slate-900/50 border-slate-800 hover:bg-slate-900":"bg-slate-50 border-slate-200 hover:bg-slate-100"}`,children:[e.jsx("p",{className:`text-[11px] uppercase font-semibold ${s.textMuted}`,children:"Rechazadas"}),e.jsx("p",{className:"text-lg font-bold text-red-500",children:d.filter(u=>u.status==="rejected").length})]})]})})}),!v||v==="pending"?N():e.jsx(at,{theme:s,isDark:a,filter:v,source:"department"})]})]})},Er=()=>{const[n,r]=T.useState(new Date),[t,s]=T.useState(!1),{user:a,userRole:i}=aa(),{submitRequest:c,isSubmitting:g}=Ot(),d=Tt(),l=na();T.useEffect(()=>{i==="technician"&&l("/technician-dashboard")},[i,l]);const x=async M=>{a!=null&&a.id&&c({start_date:M.startDate,end_date:M.endDate,reason:M.reason})},_=()=>!a||!i?e.jsx(ue,{children:e.jsx(me,{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Inicia sesiÃ³n para gestionar solicitudes de vacaciones."})})}):i==="house_tech"||i==="management"||i==="admin"?e.jsx(Fn,{userRole:i,onVacationRequestSubmit:x,isSubmitting:g,theme:b,isDark:O}):e.jsx(ue,{children:e.jsx(me,{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Las solicitudes de vacaciones solo estÃ¡n disponibles para tÃ©cnicos de planta, administraciÃ³n y managers."})})}),f=i==="admin"||i==="management",{theme:b,isDark:O}=js();return e.jsxs("div",{className:`min-h-screen flex flex-col ${b.bg} transition-colors duration-300 font-sans`,children:[e.jsx("div",{className:"flex-1 overflow-y-auto p-2 md:p-8 pb-28",children:e.jsxs("div",{className:"w-full mx-auto max-w-full space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-4 items-start",children:[e.jsxs("div",{className:"space-y-1 lg:col-span-8",children:[e.jsx("p",{className:"text-[11px] font-semibold uppercase tracking-[0.08em] text-blue-500",children:"TÃ©cnicos de la casa"}),e.jsx("h1",{className:`text-2xl md:text-3xl font-bold leading-tight ${b.textMain}`,children:"Agenda de tÃ©cnicos de la casa"}),e.jsx("p",{className:`text-sm md:text-base ${b.textMuted}`,children:"Controla asignaciones, disponibilidad y solicitudes de vacaciones en mÃ³vil."})]}),e.jsx("div",{className:"flex gap-2 lg:col-span-4 lg:justify-end",children:e.jsx(W,{variant:"outline",size:"sm",onClick:()=>r(new Date),className:`${b.card} ${b.textMain}`,children:"Ir a hoy"})})]}),e.jsx("div",{className:`${b.card} rounded-xl p-3 sm:p-4 shadow-sm`,children:e.jsxs("div",{className:"flex flex-wrap gap-3 sm:gap-4 items-center justify-end",children:[e.jsx(W,{variant:"outline",size:"sm",onClick:()=>r(new Date),className:`${b.card} ${b.textMain}`,children:"Ir a hoy"}),e.jsx(W,{variant:"outline",size:"sm",onClick:()=>s(!0),className:`${b.card} ${b.textMain}`,children:"Solicitudes de vacaciones"})]})}),d?e.jsx($n,{date:n,onDateSelect:r,readOnly:!f,theme:b,isDark:O}):e.jsx(Dn,{date:n,onDateSelect:r,readOnly:!f})]})}),e.jsx(jt,{open:t,onOpenChange:s,children:e.jsxs(wt,{className:"max-w-4xl",children:[e.jsx(Nt,{children:e.jsx(Mt,{className:b.textMain,children:"Solicitudes de vacaciones"})}),e.jsx("div",{className:"space-y-4",children:_()})]})})]})};export{Er as default};
