const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jszip.min-Diji-d1c.js","assets/commonjs-helpers-Cpj98o6Y.js"])))=>i.map(i=>d[i]);
import{l as Ps,e as xe,u as Ls,r as s,s as g,j as e,B as p,X as ja,C as Y,W as me,Y as ue,a as G,R as bs,A as te,D as ee,aF as va,q as se,F as ne,G as le,L as B,I as he,f as Is,i as ve,ab as ba,S as be,t as Ne,v as ye,w as we,x as $,aG as rt,aH as it,aI as nt,ac as Os,aJ as ie,p as Js,aK as Qe,o as Ms,aL as Ze,n as js,V as zs,M as As,aM as Na,c as ya,aN as wa,aE as Be}from"./index-NZ6jJLfQ.js";import{c as Sa}from"./icon-D8sTZPYx.js";import{I as Ca}from"./image--Pql38nK.js";import{U as lt}from"./upload-DF4rjO7T.js";import{u as _a,r as ka}from"./useWeatherData-d0TEdKFc.js";import{m as Da}from"./MultiDayScheduleBuilder-DmGkt0fN.js";import{C as Ea,J as Aa}from"./JobDetailsDialog-Cah6wZTf.js";import{C as Fs}from"./circle-alert-LZYNzZ7F.js";import{T as Ma}from"./TechnicianIncidentReportDialog-Bb0qWmts.js";import{b as Bs,o as Fa}from"./flexUuidService-C9yZjzP-.js";import{g as Ta}from"./config-DVV3VxR4.js";import{C as Pa}from"./clipboard-paste-CkPncGV3.js";import{S as La}from"./save-z_re-Mcq.js";import{E as Ia}from"./external-link-QJoXZ6ES.js";import{B as Ie}from"./badge-vNTKF5RD.js";import{S as Oa}from"./subscription-indicator-DAcdH7Ud.js";import{u as Hs}from"./useTableSubscription-Cu79jct8.js";import{u as Ke}from"./useQuery-kdg2pmgf.js";import{F as za}from"./FestivalDateNavigation-HWB3qH-8.js";import{C as Gs,a as Qs,b as Zs}from"./collapsible-DWBtmsfD.js";import{C as ot}from"./calculator-jIsLl-gd.js";import{C as ct}from"./clock-BXPvTWvY.js";import{S as Ra}from"./settings-egXcSQW9.js";import{U as cs}from"./users-DMnpVLUq.js";import{S as dt}from"./scroll-area-BHjMXddA.js";import{u as Ns}from"./useMutation-DluhVBs1.js";import{S as qa}from"./switch-DUBpZhIC.js";import{T as $a,a as Ua,b as Ks,c as He,d as Va,e as Ge}from"./table-DnQAmABX.js";import{e as Wa,P as Ja,g as mt}from"./festivalPdfGenerator-gdXb7BRp.js";import{C as ut}from"./copy-Dez5r9kU.js";import{F as Ba}from"./file-down-Buu6FgvW.js";import{S as Ha}from"./square-pen-BMpSgZGa.js";import{P as Ga}from"./plus-C3JQqq7t.js";import{F as Qa,a as Za,A as Ka,R as Ya,S as Xa}from"./FlexFolderPicker-DHVHrWa7.js";import{M as er}from"./ModernHojaDeRuta-DrMmS05m.js";import{J as sr,c as tr}from"./folders-Scoqgw4s.js";import{P as ar}from"./PresetEditor-zAPhu2I0.js";import{P as rr,m as ir}from"./equipment-B5qd5N3O.js";import{D as Ys}from"./DepartmentContext-CUMyywOO.js";import{AmplifierTool as nr}from"./AmplifierTool-B8XV4xmK.js";import{P as lr}from"./pencil-BxZTvEYh.js";import{F as vs}from"./file-text-igU140SQ.js";import{M as or}from"./music-2-DRJ2zGwb.js";import{C as Xs}from"./calendar-_Cj_Sgy-.js";import{P as cr}from"./printer-De77t3j8.js";import{B as dr}from"./box-C0bB0Qui.js";import{L as mr}from"./link-z6ku9ZYO.js";import{F as et}from"./folder-plus-DTUhlRcm.js";import{M as st}from"./message-circle-Bh9rUoQO.js";import{Z as ur}from"./zap-QKspq41J.js";import{E as tt}from"./eye-BE_DouVP.js";import{D as at}from"./download-C1rVE0-J.js";import{u as hr}from"./useFlexUuid-C0fmwl_8.js";import{_ as xr}from"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./weatherApi-BatwQpQy.js";import"./building-BdT03Y2e.js";import"./arrow-up-BTt-lBKB.js";import"./calendar-days-DcwEz6pd.js";import"./tabs-BdaywI_b.js";import"./index-hC3MxXep.js";import"./useTourRateSubscriptions-Dd0aSU9f.js";import"./JobExtrasEditor-gQe73Sd8.js";import"./separator-E-JdTFOv.js";import"./ratesQueryKeys-DgMsgg6U.js";import"./euro-DgRTeGAz.js";import"./minus-InO4I9Ks.js";import"./useJobRatesApproval-DsfA8V9C.js";import"./alert-BqA-5jRM.js";import"./JobPayoutTotalsPanel-BSlgp62i.js";import"./useJobPayoutTotals-CXAavZS-.js";import"./useManagerJobQuotes-BrI1iNRY.js";import"./tourRateMath-BOmIkfWO.js";import"./logoUtils-D2o1jUVg.js";import"./logo-url-cache-eY6nfvu7.js";import"./lazyPdf-xVUlxKNu.js";import"./es-CSiFCUGj.js";import"./constants-DoXhG9KB.js";import"./pen-D_H3YLSb.js";import"./send-Uvkx0r_O.js";import"./circle-check-big-CilmNGCn.js";import"./triangle-alert-D6qN0F8g.js";import"./JobExtrasManagement-CpH8R_KL.js";import"./receipt-CWKVL4Rh.js";import"./circle-check-C0N48OpO.js";import"./circle-x-DDzV-xk_.js";import"./pdfMerge-DXtLP7Xx.js";import"./pdf-libs-BqoGqu1a.js";import"./timesheet-pdf-82e1LStH.js";import"./truck-Br5sduv3.js";import"./avatar-QSp4LpEt.js";import"./places-restaurant-service-CakuSyx6.js";import"./utensils-crossed-CZeagqP3.js";import"./phone-BlFwiuho.js";import"./index-vfKqQWY5.js";import"./logo-service-SlbhM6-i.js";import"./jobDocumentsUpload-BaycvzFe.js";import"./clipboard-list-wtFE30Ps.js";import"./formatDistanceToNow-Bbdi_GlK.js";import"./constructNow-u0VlpghF.js";import"./differenceInCalendarMonths-6exvViir.js";import"./endOfMonth-Byhxb84j.js";import"./wifi-C3_7SFyW.js";import"./DateTypeContextMenu-D-zx4rHd.js";import"./context-menu-DYP7Nyzl.js";import"./index-D9TsP8oP.js";import"./chevron-right-Bn7Eu0F7.js";import"./circle-CWxDyDxx.js";import"./plane-NSG-_bNT.js";import"./wrench-DzMvZxmF.js";import"./star-icpn3ybK.js";import"./mic-l4q2dREA.js";import"./moon-Bp9lP4EQ.js";import"./popover-Dl-b1R8L.js";import"./calendar--BDVgnXu.js";import"./isSameDay-m1OvdnsV.js";import"./isSameMonth-BQ4F6s8O.js";import"./addMonths-j-Bb577B.js";import"./startOfMonth-B5dVCv8B.js";import"./endOfWeek-BYLwoWuZ.js";import"./subDays-D4REtaCB.js";import"./chevron-left-rq2ui83a.js";import"./subWeeks-DXhfE23M.js";import"./filter-D0HnK7Nz.js";import"./index-Bf_BVWwW.js";import"./checkbox-BsRNEGV1.js";import"./artistPdfExport-DnsKQk1F.js";import"./useJobSelection-B9iLNF5-.js";import"./building-2-nIk8XRuA.js";import"./sparkles-BZkmCd_8.js";import"./user-E3OATBQk.js";import"./briefcase-BrpPecAy.js";import"./search-D-OiWg8h.js";import"./id-card-oCs3SPbN.js";import"./car-vrO_NvCk.js";import"./package-Oxfj-CNq.js";import"./activity-BNQuCEmB.js";import"./progress-C8XsV-Me.js";import"./lazyXlsx-BrFBF17_.js";import"./alert-dialog-CtyYUxwH.js";import"./useJobAssignmentsRealtime-7FZn5naq.js";import"./useRealtimeQuery-DRd58t-I.js";import"./technicianAvailability-gbYgVBKV.js";import"./useJobRequiredRoles-Bz0ibKHS.js";import"./roleCategory-BtQgWHfO.js";import"./api-C9EDenHJ.js";import"./dryhireFolderService-Bb-tDpoa.js";import"./flexPullsheets-DscweXrW.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ts=Ps("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pr=Ps("PanelsTopLeft",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fr=Ps("WandSparkles",[["path",{d:"m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72",key:"ul74o6"}],["path",{d:"m14 7 3 3",key:"1r5n42"}],["path",{d:"M5 6v4",key:"ilb8ba"}],["path",{d:"M19 14v4",key:"blhpug"}],["path",{d:"M10 2v2",key:"7u0qdc"}],["path",{d:"M7 8H3",key:"zfb6yr"}],["path",{d:"M21 16h-4",key:"1cnmox"}],["path",{d:"M11 3H9",key:"1obp7u"}]]),gr=({jobId:a})=>{const{toast:o}=xe(),{user:t}=Ls(),[S,k]=s.useState(!1),[r,d]=s.useState(null),[N,y]=s.useState(null),T=s.useCallback(async()=>{try{if(!a)return;const{data:b,error:f}=await g.from("festival_logos").select("file_path").eq("job_id",a).maybeSingle();if(f){y(`Failed to fetch logo: ${f.message}`);return}if(b!=null&&b.file_path)try{const{data:n}=await g.storage.from("festival-logos").createSignedUrl(b.file_path,3600);if(n!=null&&n.signedUrl)d(n.signedUrl);else{const{data:w}=g.storage.from("festival-logos").getPublicUrl(b.file_path);w!=null&&w.publicUrl&&d(w.publicUrl)}}catch(n){y(`Failed to get logo URL: ${n.message}`)}else d(null)}catch(b){y(`Unexpected error: ${b.message}`)}},[a]),A=async b=>{var w;y(null);const f=(w=b.target.files)==null?void 0:w[0];if(!f)return;if(!f.type.startsWith("image/")){o({title:"Tipo de archivo invÃ¡lido",description:"Por favor sube un archivo de imagen",variant:"destructive"});return}if(!t){o({title:"AutenticaciÃ³n requerida",description:"Debes iniciar sesiÃ³n para subir logos",variant:"destructive"});return}const n=t.id;k(!0);try{const{data:j,error:u}=await g.auth.getSession();if(u||!j.session)throw new Error("Authentication error: "+((u==null?void 0:u.message)||"Session not found"));const x=f.name.split(".").pop(),D=`${a}.${x}`,{data:P,error:E}=await g.from("festival_logos").select("file_path").eq("job_id",a).maybeSingle();if(E)throw new Error(`Error fetching existing logo: ${E.message}`);if(P!=null&&P.file_path){const{error:l}=await g.storage.from("festival-logos").remove([P.file_path])}const{error:L}=await g.storage.from("festival-logos").upload(D,f,{upsert:!0,cacheControl:"3600"});if(L)throw new Error(`Error uploading logo: ${L.message}`);const{error:v}=await g.from("festival_logos").upsert({job_id:a,file_path:D,file_name:f.name,content_type:f.type,file_size:f.size,uploaded_by:n});if(v)throw new Error(`Error saving logo information: ${v.message}`);const{data:C}=await g.storage.from("festival-logos").createSignedUrl(D,3600);if(C!=null&&C.signedUrl)d(C.signedUrl);else{const{data:{publicUrl:l}}=g.storage.from("festival-logos").getPublicUrl(D);d(l)}o({title:"Ã‰xito",description:"El logo del festival ha sido actualizado"})}catch(j){const u=j.message||"No se pudo subir el logo";y(u),o({title:"Error",description:u,variant:"destructive"})}finally{k(!1)}},c=async()=>{if(y(null),!t){o({title:"AutenticaciÃ³n requerida",description:"Debes iniciar sesiÃ³n para eliminar logos",variant:"destructive"});return}try{const b=t.id,{data:f,error:n}=await g.auth.getSession();if(n||!f.session)throw new Error("Authentication error: "+((n==null?void 0:n.message)||"Session not found"));const{data:w,error:j}=await g.from("festival_logos").select("file_path").eq("job_id",a).maybeSingle();if(j)throw new Error(`Error fetching logo: ${j.message}`);if(w!=null&&w.file_path){const{error:u}=await g.storage.from("festival-logos").remove([w.file_path]);if(u)throw new Error(`Error removing logo: ${u.message}`);const{error:x}=await g.from("festival_logos").delete().eq("job_id",a);if(x)throw new Error(`Error deleting logo record: ${x.message}`);d(null),o({title:"Ã‰xito",description:"El logo del festival ha sido eliminado"})}}catch(b){const f=b.message||"No se pudo eliminar el logo";y(f),o({title:"Error",description:f,variant:"destructive"})}};return s.useEffect(()=>{a&&T()},[a,T]),e.jsxs("div",{className:"space-y-4",children:[r?e.jsxs("div",{className:"relative w-48 h-48",children:[e.jsx("img",{src:r,alt:"Festival logo",width:192,height:192,loading:"lazy",decoding:"async",className:"w-full h-full object-contain",onError:b=>{const f=b.target;f.onerror=null,f.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMTRIMTRWMTZIMTBWMTRaIiBmaWxsPSJjdXJyZW50Q29sb3IiLz48cGF0aCBkPSJNMTIgMUMxNC4yMDkxIDEgMTYgMi43OTA4NiAxNiA1QzE2IDcuMjA5MTQgMTQuMjA5MSA5IDEyIDlDOS43OTA4NiA5IDggNy4yMDkxNCA4IDVDOCAyLjc5MDg2IDkuNzkwODYgMSAxMiAxWiIgZmlsbD0iY3VycmVudENvbG9yIi8+PHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xIDEzQzEgMTAuNzkwOSAyLjc5MDg2IDkgNSA5SDE5QzIxLjIwOTEgOSAyMyAxMC43OTA5IDIzIDEzVjE5QzIzIDIwLjEwNDYgMjIuMTA0NiAyMSAyMSAyMUgzQzEuODk1NDMgMjEgMSAyMC4xMDQ2IDEgMTlWMTNaTTE5IDExSDVDMy44OTU0MyAxMSAzIDExLjg5NTQgMyAxM0MzIDE1LjIwOTEgNC43OTA5MSAxNyA3IDE3SDE3QzE5LjIwOTEgMTcgMjEgMTUuMjA5MSAyMSAxM0MyMSAxMS44OTU0IDIwLjEwNDYgMTEgMTkgMTFaIiBmaWxsPSJjdXJyZW50Q29sb3IiLz48L3N2Zz4="}}),e.jsx(p,{variant:"destructive",size:"icon",className:"absolute top-2 right-2",onClick:c,children:e.jsx(ja,{className:"h-4 w-4"})})]}):e.jsx("div",{className:"w-48 h-48 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center",children:e.jsx(Ca,{className:"h-12 w-12 text-gray-400"})}),N&&e.jsxs("div",{className:"text-sm text-red-500 mt-1",children:["Error: ",N]}),e.jsxs("div",{children:[e.jsx("input",{type:"file",id:"logo-upload",accept:"image/*",className:"hidden",onChange:A,disabled:S}),e.jsx(p,{asChild:!0,variant:"outline",disabled:S,children:e.jsxs("label",{htmlFor:"logo-upload",className:"cursor-pointer",children:[e.jsx(lt,{className:"h-4 w-4 mr-2"}),S?"Subiendo...":"Subir Logo"]})})]})]})},jr=({jobId:a,venue:o={},jobDates:t})=>{const[S,k]=s.useState(void 0),r=t.length>0?t.length===1?t[0].toISOString().split("T")[0].split("-").reverse().join("/"):`${t[0].toISOString().split("T")[0].split("-").reverse().join("/")} - ${t[t.length-1].toISOString().split("T")[0].split("-").reverse().join("/")}`:"",{isLoading:d,error:N,lastFetch:y,fetchWeather:T}=_a({venue:o,eventDates:r,onWeatherUpdate:k}),A=n=>{try{return new Date(n).toLocaleDateString("en-US",{month:"long",day:"numeric"})}catch{return n}},c=n=>n.toLowerCase().includes("sun")?"â˜€ï¸":n.toLowerCase().includes("cloud")?"â˜ï¸":n.toLowerCase().includes("rain")?"ðŸŒ§ï¸":n.toLowerCase().includes("snow")?"â„ï¸":n.toLowerCase().includes("storm")?"â›ˆï¸":"ðŸŒ¤ï¸",f=(o.address||o.coordinates)&&t.length>0;return e.jsx(Da.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:e.jsxs(Y,{children:[e.jsx(me,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs(ue,{className:"flex items-center gap-2 text-base sm:text-lg",children:[e.jsx(Ea,{className:"h-4 w-4 sm:h-5 sm:w-5"}),"PronÃ³stico del Tiempo"]}),f&&e.jsxs(p,{variant:"outline",size:"sm",onClick:T,disabled:d,className:"flex items-center gap-1 w-fit",children:[d?e.jsx(G,{className:"h-4 w-4 animate-spin"}):e.jsx(bs,{className:"h-4 w-4"}),d?"Cargando...":"Actualizar"]})]})}),e.jsx(te,{children:f?N?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive",children:[e.jsx(Fs,{className:"h-4 w-4"}),N]}):d?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(G,{className:"h-4 w-4 animate-spin"}),"Obteniendo pronÃ³stico del tiempo..."]}):S&&S.length>0?e.jsxs("div",{className:"space-y-2 sm:space-y-3",children:[S.map((n,w)=>e.jsx("div",{className:"flex items-center justify-between p-2 sm:p-3 rounded-lg bg-muted/50",children:e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("span",{className:"text-xl sm:text-2xl",children:c(n.condition)}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-sm sm:text-base",children:[A(n.date)," â€“ ",n.condition]}),e.jsxs("div",{className:"text-xs sm:text-sm text-muted-foreground",children:[Math.round(n.maxTemp),"Â°C / ",Math.round(n.minTemp),"Â°C",n.precipitationProbability>0&&e.jsxs("span",{children:[", ",n.precipitationProbability,"% lluvia"]})]})]})]})},w)),e.jsxs("div",{className:"text-xs text-muted-foreground mt-4 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Consejo:"})," Los datos del tiempo se obtienen de Open-Meteo y se actualizan automÃ¡ticamente."]}),y&&e.jsxs("p",{children:["Ãšltima actualizaciÃ³n: ",y.toLocaleString()]})]})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"Datos del tiempo no disponibles para las fechas y ubicaciÃ³n seleccionadas."}):e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Fs,{className:"h-4 w-4"}),"El pronÃ³stico del tiempo requiere ubicaciÃ³n del lugar y fechas del evento"]})})]})})};function vr({jobId:a,dialogMode:o=!1}){const{toast:t}=xe(),[S,k]=s.useState(!1),[r,d]=s.useState({sound:"",lights:""}),[N,y]=s.useState({sound:"",lights:""}),T=j=>{const u=(j||"").trim();if(!u)return"";const x=/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}/g;try{const D=Ta("crewCall"),P=u.split("#")[1]||u,E=P.indexOf("contact-list/");if(E>=0){const l=P.slice(E+13).match(x);if(l&&l.length)return l[0]}return Array.from(u.matchAll(x)).map(C=>C[0]).find(C=>C.toLowerCase()!==D)||""}catch{return""}},A=async()=>{if(!a)return;const{data:j,error:u}=await g.from("flex_crew_calls").select("department, flex_element_id").eq("job_id",a);if(u)return;const x={sound:"",lights:""};for(const D of j||[]){const P=(D.department||"").toLowerCase();(P==="sound"||P==="lights"||P==="video")&&(x[P]=D.flex_element_id||"")}y(x)};s.useEffect(()=>{A()},[a]);const c=j=>{const u=T(r[j]);u&&y({...N,[j]:u})},b=async j=>{try{const u=await navigator.clipboard.readText();d({...r,[j]:u});const x=T(u);x&&y({...N,[j]:x})}catch{}},f=async j=>{if(!a)return;const u=(N[j]||"").trim();if(!u){t({title:"Missing ID",description:`No Flex element ID for ${j}`});return}try{k(!0);const{data:x}=await g.from("flex_crew_calls").select("id").eq("job_id",a).eq("department",j).maybeSingle();if(x!=null&&x.id){const{error:D}=await g.from("flex_crew_calls").update({flex_element_id:u}).eq("id",x.id);if(D)throw D}else{const{error:D}=await g.from("flex_crew_calls").insert({job_id:a,department:j,flex_element_id:u});if(D)throw D}t({title:"Saved",description:`Linked ${j} crew call`})}catch(x){t({title:"Save failed",description:(x==null?void 0:x.message)||"Unknown error",variant:"destructive"})}finally{k(!1)}},n=j=>{const u=(N[j]||"").trim();if(!u)return;const x=Bs("contact-list",u);window.open(x,"_blank")},w=({label:j,dept:u})=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{className:"text-xs sm:text-sm",children:j}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(he,{className:"flex-1 h-8 text-sm",placeholder:"Paste Flex crew call URL",value:r[u],onChange:x=>d({...r,[u]:x.target.value})}),e.jsxs(p,{type:"button",variant:"secondary",size:"sm",className:"gap-1 h-8 shrink-0",onClick:()=>c(u),children:[e.jsx(fr,{className:"h-3 w-3"})," ",e.jsx("span",{className:"hidden sm:inline",children:"Extract"})]}),e.jsxs(p,{type:"button",variant:"outline",size:"sm",className:"gap-1 h-8 shrink-0",onClick:()=>b(u),children:[e.jsx(Pa,{className:"h-3 w-3"})," ",e.jsx("span",{className:"hidden sm:inline",children:"Paste"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(he,{className:"flex-1 h-8 text-sm",placeholder:"Flex Element ID",value:N[u],onChange:x=>y({...N,[u]:x.target.value})}),e.jsxs(p,{type:"button",variant:"default",size:"sm",className:"gap-1 h-8 shrink-0",onClick:()=>f(u),disabled:S,children:[e.jsx(La,{className:"h-3 w-3"})," ",e.jsx("span",{className:"hidden sm:inline",children:"Save"})]}),e.jsxs(p,{type:"button",variant:"outline",size:"sm",className:"gap-1 h-8 shrink-0",onClick:()=>n(u),disabled:!N[u],children:[e.jsx(Ia,{className:"h-3 w-3"})," ",e.jsx("span",{className:"hidden sm:inline",children:"Open"})]})]})]}),e.jsxs("p",{className:"text-[10px] text-muted-foreground",children:["Example: ",Bs("contact-list","<elementId>")]})]});return o?e.jsxs("div",{className:"space-y-4",children:[e.jsx(w,{label:"Sound Crew Call",dept:"sound"}),e.jsx(w,{label:"Lights Crew Call",dept:"lights"})]}):e.jsxs(Y,{children:[e.jsx(me,{children:e.jsxs(ue,{className:"flex items-center gap-2",children:[e.jsx(Ts,{className:"h-5 w-5"})," Link Flex Crew Calls"]})}),e.jsxs(te,{className:"space-y-4",children:[e.jsx(w,{label:"Sound Crew Call",dept:"sound"}),e.jsx(w,{label:"Lights Crew Call",dept:"lights"})]})]})}function br({jobId:a}){const[o,t]=s.useState(!1);return e.jsxs(ee,{open:o,onOpenChange:t,children:[e.jsx(va,{asChild:!0,children:e.jsxs(p,{variant:"outline",size:"sm",className:"gap-2",children:[e.jsx(Ts,{className:"h-4 w-4"})," Link Crew Calls"]})}),e.jsxs(se,{className:"max-w-[95vw] sm:max-w-[640px] max-h-[90vh] overflow-y-auto",children:[e.jsx(ne,{children:e.jsxs(le,{className:"flex items-center gap-2 text-base sm:text-lg",children:[e.jsx(Ts,{className:"h-4 w-4 sm:h-5 sm:w-5"})," Link Flex Crew Calls"]})}),e.jsx(vr,{jobId:a,dialogMode:!0})]})]})}function Nr({jobId:a,selectedDate:o}){const{toast:t}=xe(),S=Is(),[k,r]=s.useState(!0);Hs("festival_shifts"),Hs("festival_shift_assignments");const d=s.useCallback(async()=>{if(!o||!a)return[];try{const{data:c,error:b}=await g.from("festival_shifts").select("*").eq("job_id",a).eq("date",o).order("start_time");if(b)throw b;if(!c||c.length===0)return[];const f=c.map(D=>D.id),{data:n,error:w}=await g.from("festival_shift_assignments").select("*").in("shift_id",f);if(w)throw w;const j=n.filter(D=>D.technician_id).map(D=>D.technician_id);let u={};if(j.length>0){const{data:D,error:P}=await g.from("profiles").select("id, first_name, last_name, email, department, role").in("id",j);if(P)throw P;u=D.reduce((E,L)=>({...E,[L.id]:L}),{})}return c.map(D=>{const P=n.filter(E=>E.shift_id===D.id).map(E=>({...E,profiles:E.technician_id?u[E.technician_id]:null}));return{...D,assignments:P}})}catch(c){return t({title:"Error",description:"Could not load shifts: "+c.message,variant:"destructive"}),[]}},[o,a,t]),{data:N=[],isLoading:y,refetch:T}=Ke({queryKey:["festival_shifts",a,o],queryFn:d,enabled:!!a&&!!o,staleTime:0,refetchOnWindowFocus:!0,retry:2}),A=s.useCallback(async()=>(await S.invalidateQueries({queryKey:["festival_shifts"]}),await S.invalidateQueries({queryKey:["festival_shift_assignments"]}),await T()),[S,T]);return{shifts:N,isLoading:y,refetch:A}}const yr=(a,o,t,S=30,k=4)=>{const[r,d]=s.useState([]),[N,y]=s.useState(!1),[T,A]=s.useState(!1);return s.useEffect(()=>{(async()=>{if(!(!a||!o)){y(!0);try{let n=g.from("festival_artists").select("id, name, soundcheck, soundcheck_start, show_start, show_end, isaftermidnight, stage").eq("job_id",a).eq("date",o);t!==void 0&&(n=n.eq("stage",t));const{data:w,error:j}=await n;if(j)throw j;const{data:u,error:x}=await g.from("jobs").select("end_time").eq("id",a).single();if(x)throw x;const D=ve(ba(u.end_time),"yyyy-MM-dd");A(o===D),d(w||[])}catch{}finally{y(!1)}}})()},[a,o,t]),{artists:r,isLoading:N,isLastDay:T,calculateOptimalShifts:f=>{if(r.length===0)return[];const n=v=>{const[C,l]=v.split(":").map(Number);return C*60+l},w=v=>{if(v>=1440){const C=v-1440,l=Math.floor(C/60),m=C%60;return`${l.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`}else{const C=Math.floor(v/60),l=v%60;return`${C.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`}};let j=1440,u=0;r.forEach(v=>{if(v.soundcheck&&v.soundcheck_start){const C=n(v.soundcheck_start);C<j&&(j=C)}if(v.show_start){let C=n(v.show_start);v.isaftermidnight&&(C+=1440),!v.isaftermidnight&&C<j&&(j=C)}if(v.show_end){let C=n(v.show_end);v.isaftermidnight&&(C+=1440),C>u&&(u=C)}}),j-=S,T&&(u+=k*60);const x=u-j,D=60,P=Math.ceil((x+D)/f),E=P-D,L=[];for(let v=0;v<f;v++){const C=j+v*E,l=C+P,m={name:`Shift ${v+1}`,start_time:w(C),end_time:w(l),duration:Math.round(P/60*10)/10,overlap:v>0?"1 hour overlap with previous shift":void 0};L.push(m)}return L},getScheduleSummary:()=>{if(r.length===0)return"No artists scheduled";const f=l=>{const[m,h]=l.split(":").map(Number);return m*60+h},n=l=>{if(l>=1440){const m=l-1440,h=Math.floor(m/60),O=m%60;return`${h.toString().padStart(2,"0")}:${O.toString().padStart(2,"0")}`}else{const m=Math.floor(l/60),h=l%60;return`${m.toString().padStart(2,"0")}:${h.toString().padStart(2,"0")}`}};let w=1440,j=0;r.forEach(l=>{if(l.soundcheck&&l.soundcheck_start){const m=f(l.soundcheck_start);m<w&&(w=m)}if(l.show_start){let m=f(l.show_start);l.isaftermidnight&&(m+=1440),!l.isaftermidnight&&m<w&&(w=m)}if(l.show_end){let m=f(l.show_end);l.isaftermidnight&&(m+=1440),m>j&&(j=m)}});const u=w-S,x=T?j+k*60:j,D=Math.round((x-u)/60*10)/10,P=n(u),E=n(x),L=S!==30?` (${S}m buffer)`:"",v=T?` + ${k}h teardown`:"",C=t?` (Stage ${t})`:"";return`${P}${L} â†’ ${E}${v}${C} | Total: ${D}h`}}},ht=({jobId:a,date:o,stage:t,onApplyTimes:S})=>{const[k,r]=s.useState(3),[d,N]=s.useState(!1),[y,T]=s.useState(!1),[A,c]=s.useState(30),[b,f]=s.useState(4),{artists:n,isLoading:w,calculateOptimalShifts:j,getScheduleSummary:u}=yr(a,o,t,A,b),x=j(k),D=E=>{const L=parseInt(E);!isNaN(L)&&L>=0&&L<=120&&c(L)},P=E=>{const L=parseInt(E);!isNaN(L)&&L>=0&&L<=8&&f(L)};return e.jsxs(Gs,{open:d,onOpenChange:N,children:[e.jsx(Qs,{asChild:!0,children:e.jsxs(p,{variant:"outline",type:"button",className:"w-full",children:[e.jsx(ot,{className:"h-4 w-4 mr-2"}),"Calculadora de Horarios de Turnos"]})}),e.jsx(Zs,{className:"mt-4",children:e.jsxs(Y,{children:[e.jsx(me,{className:"pb-3",children:e.jsxs(ue,{className:"text-sm flex items-center gap-2",children:[e.jsx(ct,{className:"h-4 w-4"}),"Calcular Horarios Ã“ptimos de Turnos"]})}),e.jsxs(te,{className:"space-y-4",children:[e.jsxs(Gs,{open:y,onOpenChange:T,children:[e.jsx(Qs,{asChild:!0,children:e.jsxs(p,{variant:"ghost",size:"sm",type:"button",className:"w-full justify-start",children:[e.jsx(Ra,{className:"h-4 w-4 mr-2"}),"ConfiguraciÃ³n",(A!==30||b!==4)&&e.jsx(Ie,{variant:"secondary",className:"ml-2 text-xs",children:"Personalizado"})]})}),e.jsxs(Zs,{className:"mt-3 space-y-3 border rounded-lg p-3 bg-muted/20",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"start-buffer",className:"text-xs",children:"Tiempo de PreparaciÃ³n (minutos)"}),e.jsx(he,{id:"start-buffer",type:"number",min:"0",max:"120",value:A,onChange:E=>D(E.target.value),className:"h-8 text-sm"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"teardown-time",className:"text-xs",children:"Tiempo de Desmontaje (horas)"}),e.jsx(he,{id:"teardown-time",type:"number",min:"0",max:"8",value:b,onChange:E=>P(E.target.value),className:"h-8 text-sm"})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"El tiempo de preparaciÃ³n se aÃ±ade antes del primer soundcheck. El tiempo de desmontaje se aÃ±ade despuÃ©s del Ãºltimo show en el dÃ­a final del festival."})]})]}),w?e.jsx("div",{className:"text-sm text-muted-foreground",children:"Cargando programaciÃ³n de artistas..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:t?`ProgramaciÃ³n Stage ${t}`:"ProgramaciÃ³n del Festival"}),e.jsxs("div",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[e.jsx(cs,{className:"h-3 w-3"}),n.length," artistas programados"]}),e.jsx(Ie,{variant:"outline",className:"text-xs",children:u()})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"NÃºmero de Turnos"}),e.jsxs(be,{value:k.toString(),onValueChange:E=>r(parseInt(E)),children:[e.jsx(Ne,{children:e.jsx(ye,{})}),e.jsxs(we,{children:[e.jsx($,{value:"2",children:"2 Turnos"}),e.jsx($,{value:"3",children:"3 Turnos"}),e.jsx($,{value:"4",children:"4 Turnos"}),e.jsx($,{value:"5",children:"5 Turnos"}),e.jsx($,{value:"6",children:"6 Turnos"})]})]})]}),x.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm font-medium",children:["Turnos Sugeridos (con solapamiento de 1h) - Total: ",Math.round(x.reduce((E,L)=>E+L.duration,0)*10)/10,"h"]}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:x.map((E,L)=>e.jsxs("div",{className:"border rounded-lg p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-sm",children:E.name}),e.jsxs(Ie,{variant:"secondary",className:"text-xs",children:[E.duration,"h"]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[E.start_time," - ",E.end_time]}),E.overlap&&e.jsx("div",{className:"text-xs text-blue-600",children:E.overlap}),e.jsx(p,{variant:"outline",size:"sm",type:"button",onClick:()=>S(E.start_time,E.end_time),className:"w-full mt-2",children:"Aplicar al Formulario"})]},L))})]}),n.length===0&&e.jsx("div",{className:"text-sm text-muted-foreground bg-muted p-3 rounded-lg",children:t?`No hay artistas programados para el Stage ${t} en esta fecha.`:"No hay artistas programados para esta fecha. AÃ±ade artistas primero para calcular horarios Ã³ptimos de turnos."})]})]})]})})]})},wr=nt({name:ie().min(1,"El nombre del turno es requerido"),start_time:ie().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/,"Se requiere formato de hora vÃ¡lido (HH:MM)"),end_time:ie().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/,"Se requiere formato de hora vÃ¡lido (HH:MM)"),stage:ie().optional(),department:ie().optional(),notes:ie().optional()}),xt=({open:a,onOpenChange:o,shift:t,onShiftUpdated:S})=>{var A;const[k,r]=s.useState(!1),{toast:d}=xe(),N=rt({resolver:it(wr),defaultValues:{name:t.name,start_time:t.start_time,end_time:t.end_time,stage:((A=t.stage)==null?void 0:A.toString())||"",department:t.department||"",notes:t.notes||""}}),y=(c,b)=>{N.setValue("start_time",c),N.setValue("end_time",b)},T=async c=>{r(!0);try{const{error:b}=await g.from("festival_shifts").update({name:c.name,start_time:c.start_time,end_time:c.end_time,stage:c.stage&&c.stage!=="none"?parseInt(c.stage):null,department:c.department&&c.department!=="none"?c.department:null,notes:c.notes||null}).eq("id",t.id);if(b)throw b;S(),o(!1),d({title:"Ã‰xito",description:"Turno actualizado exitosamente"})}catch{d({title:"Error",description:"No se pudo actualizar el turno",variant:"destructive"})}finally{r(!1)}};return e.jsx(ee,{open:a,onOpenChange:o,children:e.jsxs(se,{className:"max-w-[95vw] sm:max-w-[500px] max-h-[90vh] overflow-y-auto",children:[e.jsx(ne,{children:e.jsx(le,{className:"text-base sm:text-lg",children:"Editar Turno"})}),e.jsxs("form",{onSubmit:N.handleSubmit(T),className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"name",children:"Nombre del Turno"}),e.jsx(he,{id:"name",placeholder:"Turno MaÃ±ana, Soundcheck, etc.",...N.register("name")}),N.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:N.formState.errors.name.message})]}),e.jsx(ht,{jobId:t.job_id,date:t.date,stage:N.watch("stage")?parseInt(N.watch("stage")):void 0,onApplyTimes:y}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"start_time",children:"Hora de Inicio"}),e.jsx(he,{id:"start_time",type:"time",...N.register("start_time")}),N.formState.errors.start_time&&e.jsx("p",{className:"text-destructive text-sm",children:N.formState.errors.start_time.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"end_time",children:"Hora de Fin"}),e.jsx(he,{id:"end_time",type:"time",...N.register("end_time")}),N.formState.errors.end_time&&e.jsx("p",{className:"text-destructive text-sm",children:N.formState.errors.end_time.message})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"stage",children:"Stage (opcional)"}),e.jsxs(be,{defaultValue:N.getValues("stage")||"none",onValueChange:c=>N.setValue("stage",c),children:[e.jsx(Ne,{children:e.jsx(ye,{placeholder:"Seleccionar stage"})}),e.jsxs(we,{children:[e.jsx($,{value:"none",children:"Sin stage"}),e.jsx($,{value:"1",children:"Stage 1"}),e.jsx($,{value:"2",children:"Stage 2"}),e.jsx($,{value:"3",children:"Stage 3"}),e.jsx($,{value:"4",children:"Stage 4"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"department",children:"Departamento (opcional)"}),e.jsxs(be,{defaultValue:N.getValues("department")||"none",onValueChange:c=>N.setValue("department",c),children:[e.jsx(Ne,{children:e.jsx(ye,{placeholder:"Seleccionar departamento"})}),e.jsxs(we,{children:[e.jsx($,{value:"none",children:"Sin departamento"}),e.jsx($,{value:"sound",children:"Sonido"}),e.jsx($,{value:"lights",children:"Luces"}),e.jsx($,{value:"video",children:"Video"}),e.jsx($,{value:"logistics",children:"LogÃ­stica"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"notes",children:"Notas (opcional)"}),e.jsx(Os,{id:"notes",placeholder:"Cualquier informaciÃ³n adicional sobre este turno",...N.register("notes")})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>o(!1),children:"Cancelar"}),e.jsx(p,{type:"submit",disabled:k,children:k?"Actualizando...":"Actualizar Turno"})]})]})]})})},pt=({open:a,onOpenChange:o,shift:t,onAssignmentsUpdated:S,isViewOnly:k=!1})=>{const[r,d]=s.useState(""),[N,y]=s.useState(""),[T,A]=s.useState(!1),[c,b]=s.useState(""),{toast:f}=xe(),n=Is();s.useEffect(()=>{if(a&&t.department){const l=Js(String(t.department));l.length>0&&b(l[0].code)}},[a,t.department]);const{data:w,isLoading:j,error:u}=Ke({queryKey:["job-technicians",t.job_id,t.department],queryFn:async()=>{const l=t.department||"sound",{data:m,error:h}=await g.from("job_assignments").select(`
          technician_id,
          profiles (
            id, 
            first_name, 
            last_name, 
            email, 
            department, 
            role
          )
        `).eq("job_id",t.job_id);if(h)throw h;return m.filter(R=>R.profiles&&R.profiles.department===l).map(R=>R.profiles)}}),x=l=>Js(String(l)).map(h=>h.code),D=()=>w?[...w].sort((l,m)=>l.role==="house_tech"&&m.role!=="house_tech"?-1:l.role!=="house_tech"&&m.role==="house_tech"?1:(l.first_name+l.last_name).localeCompare(m.first_name+m.last_name)):[],P=l=>{const m=l.role==="house_tech";return`${l.first_name} ${l.last_name}${m?" (House Tech)":""}`},E=Ns({mutationFn:async l=>{if(!(t!=null&&t.id))throw new Error("Shift ID is required");const{data:m,error:h}=await g.from("festival_shift_assignments").insert([l]);if(h)throw h;return m},onSuccess:()=>{n.invalidateQueries({queryKey:["festivalShifts"]}),S(),f({title:"Ã‰xito",description:"TÃ©cnico asignado exitosamente"})},onError:l=>{f({title:"Error",description:"No se pudo asignar el tÃ©cnico",variant:"destructive"})}}),L=Ns({mutationFn:async l=>{const{data:m,error:h}=await g.from("festival_shift_assignments").delete().eq("id",l);if(h)throw h;return m},onSuccess:()=>{n.invalidateQueries({queryKey:["festivalShifts"]}),S(),f({title:"Ã‰xito",description:"TÃ©cnico desasignado exitosamente"})},onError:l=>{f({title:"Error",description:"No se pudo desasignar el tÃ©cnico",variant:"destructive"})}}),v=async()=>{if(!r&&!N||!c){f({title:"Error",description:"Por favor completa todos los campos requeridos",variant:"destructive"});return}try{const l={shift_id:t.id,role:c,...T?{external_technician_name:N}:{technician_id:r}};await E.mutateAsync(l),d(""),y(""),b("")}catch{f({title:"Error",description:"No se pudo asignar el tÃ©cnico",variant:"destructive"})}},C=async l=>{try{await L.mutateAsync(l)}catch{f({title:"Error",description:"No se pudo desasignar el tÃ©cnico",variant:"destructive"})}};return e.jsx(ee,{open:a,onOpenChange:o,children:e.jsxs(se,{className:"max-w-[95vw] sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ne,{children:[e.jsxs(le,{className:"text-base sm:text-lg",children:[k?"Ver Personal para":"Gestionar Personal para"," ",t.name]}),e.jsx(Qe,{className:"text-sm",children:k?"Ver personal asignado a este turno":"AÃ±adir o eliminar personal de este turno"})]}),e.jsx(dt,{className:"max-h-[60vh] px-1",children:e.jsxs("div",{className:"space-y-6",children:[!k&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(qa,{checked:T,onCheckedChange:A}),e.jsx(B,{children:"TÃ©cnico Externo"})]}),T?e.jsxs("div",{className:"grid gap-2",children:[e.jsx(B,{htmlFor:"externalTechnician",children:"Nombre del TÃ©cnico Externo"}),e.jsx(he,{id:"externalTechnician",value:N,onChange:l=>y(l.target.value),placeholder:"Ingresar nombre del tÃ©cnico"})]}):e.jsxs("div",{className:"grid gap-2",children:[e.jsx(B,{htmlFor:"technician",children:"TÃ©cnico"}),e.jsxs(be,{onValueChange:d,children:[e.jsx(Ne,{className:"w-full",children:e.jsx(ye,{placeholder:"Seleccionar un tÃ©cnico"})}),e.jsx(we,{children:D().map(l=>e.jsx($,{value:l.id,children:P(l)},l.id))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(B,{htmlFor:"role",children:"Rol"}),e.jsxs(be,{value:c,onValueChange:b,children:[e.jsx(Ne,{className:"w-full",children:e.jsx(ye,{placeholder:"Seleccionar un rol"})}),e.jsx(we,{children:x(t.department||"sound").map(l=>e.jsx($,{value:l,children:Ms(l)},l))})]})]}),e.jsx(p,{onClick:v,disabled:E.isPending,children:E.isPending?"Asignando...":"Asignar TÃ©cnico"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-sm font-medium",children:"Personal Asignado"}),t.assignments.length>0?e.jsx("div",{className:"space-y-2",children:t.assignments.map(l=>{var m,h;return e.jsxs("div",{className:"flex items-center justify-between p-2 bg-accent/20 rounded-md",children:[e.jsxs("div",{children:[l.external_technician_name||`${(m=l.profiles)==null?void 0:m.first_name} ${(h=l.profiles)==null?void 0:h.last_name}`,"- ",Ms(l.role)||l.role]}),!k&&e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>C(l.id),children:"Eliminar"})]},l.id)})}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"AÃºn no hay personal asignado a este turno."})]})]})}),e.jsx(Ze,{className:"mt-6",children:e.jsx(p,{type:"button",variant:"secondary",onClick:()=>o(!1),children:"Cerrar"})})]})})},ft=({open:a,onOpenChange:o,sourceDate:t,jobDates:S,jobId:k,onShiftsCopied:r})=>{const[d,N]=s.useState(""),[y,T]=s.useState(!1),A=async()=>{if(!d){js.error("Por favor selecciona una fecha destino");return}try{T(!0);const{data:c,error:b}=await g.from("festival_shifts").select(`
          id,
          name,
          start_time,
          end_time,
          department,
          stage,
          notes
        `).eq("job_id",k).eq("date",t);if(b)throw b;if(!c||c.length===0){js.error("No se encontraron turnos para la fecha de origen seleccionada");return}for(const f of c){const{data:n,error:w}=await g.from("festival_shifts").insert({name:f.name,start_time:f.start_time,end_time:f.end_time,department:f.department,stage:f.stage,notes:f.notes,date:d,job_id:k}).select().single();if(w)throw w;const{data:j,error:u}=await g.from("festival_shift_assignments").select("*").eq("shift_id",f.id);if(u)throw u;if(j&&j.length>0){const x=j.map(P=>({shift_id:n.id,technician_id:P.technician_id,external_technician_name:P.external_technician_name,role:P.role})),{error:D}=await g.from("festival_shift_assignments").insert(x);if(D)throw D}}js.success(`Se copiaron exitosamente ${c.length} turnos con todas las asignaciones a ${ve(new Date(d),"MMM d, yyyy")}`),r(),o(!1)}catch(c){js.error(`Error al copiar turnos: ${c.message||"Error desconocido"}`)}finally{T(!1)}};return e.jsx(ee,{open:a,onOpenChange:o,children:e.jsxs(se,{className:"max-w-[95vw] sm:max-w-md max-h-[90vh] overflow-y-auto",children:[e.jsx(ne,{children:e.jsx(le,{className:"text-base sm:text-lg",children:"Copiar Turnos a Otra Fecha"})}),e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-muted-foreground mb-2",children:["Fecha de origen: ",ve(new Date(t),"MMM d, yyyy")]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-4",children:"Esto copiarÃ¡ todos los turnos y sus tÃ©cnicos asignados a la fecha destino."}),e.jsxs(be,{value:d,onValueChange:N,children:[e.jsx(Ne,{children:e.jsx(ye,{placeholder:"Seleccionar fecha destino"})}),e.jsx(we,{children:S.map(c=>{const b=ve(c,"yyyy-MM-dd");return b===t?null:e.jsx($,{value:b,children:ve(c,"MMM d, yyyy")},b)})})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>o(!1),disabled:y,children:"Cancelar"}),e.jsx(p,{onClick:A,disabled:!d||y,children:y?"Copiando...":"Copiar Turnos y Asignaciones"})]})]})]})})},Sr=({shifts:a,onDeleteShift:o,onShiftUpdated:t,jobId:S,isViewOnly:k=!1,jobDates:r,selectedDate:d,onShiftsCopied:N})=>{const[y,T]=s.useState(!1),[A,c]=s.useState(!1),[b,f]=s.useState(!1),[n,w]=s.useState(null),j=x=>{w(x),T(!0)},u=x=>{w(x),c(!0)};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:!k&&a.length>0&&e.jsx(p,{variant:"outline",size:"sm",onClick:()=>f(!0),children:"Copiar Turnos a Otra Fecha"})}),a.map(x=>e.jsxs(Y,{className:"overflow-hidden",children:[e.jsx(me,{className:"p-4 pb-2",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(ue,{className:"text-base",children:x.name}),e.jsxs("div",{className:"flex gap-2",children:[!k&&e.jsxs(e.Fragment,{children:[e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>j(x),children:"Editar"}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>o(x.id),children:"Eliminar"})]}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>u(x),children:k?"Ver Personal":"Gestionar Personal"})]})]})}),e.jsx(te,{className:"p-4 pt-0",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Hora de Inicio:"})," ",x.start_time]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Hora de Fin:"})," ",x.end_time]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Departamento:"})," ",x.department||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Notas:"})," ",x.notes||"N/A"]})]})})]},x.id)),y&&n&&e.jsx(xt,{open:y,onOpenChange:T,shift:n,onShiftUpdated:t}),A&&n&&e.jsx(pt,{open:A,onOpenChange:c,shift:n,onAssignmentsUpdated:t,isViewOnly:k}),b&&e.jsx(ft,{open:b,onOpenChange:f,sourceDate:d,jobDates:r,jobId:S,onShiftsCopied:N})]})},Cr=nt({name:ie().min(1,"El nombre del turno es requerido"),start_time:ie().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/,"Se requiere formato de hora vÃ¡lido (HH:MM)"),end_time:ie().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/,"Se requiere formato de hora vÃ¡lido (HH:MM)"),stage:ie().optional(),department:ie().optional(),notes:ie().optional()}),_r=({open:a,onOpenChange:o,jobId:t,onShiftCreated:S,date:k})=>{const[r,d]=s.useState(!1),{toast:N}=xe(),y=rt({resolver:it(Cr),defaultValues:{name:"",start_time:"09:00",end_time:"18:00",stage:"",department:"",notes:""}}),T=(c,b)=>{y.setValue("start_time",c),y.setValue("end_time",b)},A=async c=>{d(!0);try{const b={job_id:t,date:k,name:c.name,start_time:c.start_time,end_time:c.end_time,stage:c.stage?parseInt(c.stage):null,department:c.department||null,notes:c.notes||null},{data:f,error:n}=await g.from("festival_shifts").insert(b).select();if(n)throw n;y.reset(),S(),N({title:"Ã‰xito",description:"Turno creado exitosamente"})}catch(b){N({title:"Error",description:`No se pudo crear el turno: ${b.message}`,variant:"destructive"})}finally{d(!1)}};return e.jsx(ee,{open:a,onOpenChange:o,children:e.jsxs(se,{className:"max-w-[95vw] sm:max-w-[500px] max-h-[90vh] overflow-y-auto",children:[e.jsx(ne,{children:e.jsx(le,{className:"text-base sm:text-lg",children:"Crear Turno"})}),e.jsxs("form",{onSubmit:y.handleSubmit(A),className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"name",children:"Nombre del Turno"}),e.jsx(he,{id:"name",placeholder:"Turno MaÃ±ana, Soundcheck, etc.",...y.register("name")}),y.formState.errors.name&&e.jsx("p",{className:"text-destructive text-sm",children:y.formState.errors.name.message})]}),e.jsx(ht,{jobId:t,date:k,stage:y.watch("stage")?parseInt(y.watch("stage")):void 0,onApplyTimes:T}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"start_time",children:"Hora de Inicio"}),e.jsx(he,{id:"start_time",type:"time",...y.register("start_time")}),y.formState.errors.start_time&&e.jsx("p",{className:"text-destructive text-sm",children:y.formState.errors.start_time.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"end_time",children:"Hora de Fin"}),e.jsx(he,{id:"end_time",type:"time",...y.register("end_time")}),y.formState.errors.end_time&&e.jsx("p",{className:"text-destructive text-sm",children:y.formState.errors.end_time.message})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"stage",children:"Stage (opcional)"}),e.jsxs(be,{onValueChange:c=>y.setValue("stage",c),children:[e.jsx(Ne,{children:e.jsx(ye,{placeholder:"Seleccionar stage"})}),e.jsxs(we,{children:[e.jsx($,{value:"1",children:"Stage 1"}),e.jsx($,{value:"2",children:"Stage 2"}),e.jsx($,{value:"3",children:"Stage 3"}),e.jsx($,{value:"4",children:"Stage 4"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"department",children:"Departamento (opcional)"}),e.jsxs(be,{onValueChange:c=>y.setValue("department",c),children:[e.jsx(Ne,{children:e.jsx(ye,{placeholder:"Seleccionar departamento"})}),e.jsxs(we,{children:[e.jsx($,{value:"sound",children:"Sonido"}),e.jsx($,{value:"lights",children:"Luces"}),e.jsx($,{value:"video",children:"Video"}),e.jsx($,{value:"logistics",children:"LogÃ­stica"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"notes",children:"Notas (opcional)"}),e.jsx(Os,{id:"notes",placeholder:"Cualquier informaciÃ³n adicional sobre este turno",...y.register("notes")})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>o(!1),children:"Cancelar"}),e.jsx(p,{type:"submit",disabled:r,children:r?"Creando...":"Crear Turno"})]})]})]})})},kr=({shifts:a,onDeleteShift:o,onShiftUpdated:t,date:S,jobId:k,isViewOnly:r=!1,jobDates:d=[],onShiftsCopied:N})=>{const{toast:y}=xe(),[T,A]=s.useState(void 0),[c,b]=s.useState(""),[f,n]=s.useState(null),[w,j]=s.useState(null),[u,x]=s.useState(!1);s.useEffect(()=>{(async()=>{if(k)try{const{data:h,error:O}=await g.from("jobs").select("title").eq("id",k).single();O||h&&b(h.title);const{data:R,error:H}=await g.from("festival_settings").select("logo_url").eq("job_id",k).single();if(H)return;if(R!=null&&R.logo_url){const J=R.logo_url;if(J.startsWith("http"))A(J);else try{let ae="festival-assets",K=J;J.includes("/")&&(ae=J.split("/",1)[0],K=J.substring(ae.length+1));const{data:oe}=g.storage.from(ae).getPublicUrl(K);oe!=null&&oe.publicUrl&&A(oe.publicUrl)}catch{}}}catch{}})()},[k]);const D=[...a].sort((m,h)=>m.start_time.localeCompare(h.start_time)),P=(m,h)=>`${m.slice(0,5)} - ${h.slice(0,5)}`,E=(m,h)=>{m.stopPropagation(),confirm("Â¿EstÃ¡s seguro de que deseas eliminar este turno?")&&o(h)},L=(m,h)=>{m.stopPropagation(),n(h)},v=(m,h)=>{m.stopPropagation(),j(h)},C=new Date(S).toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),l=async()=>{try{const h=await Wa({jobTitle:c,date:S,jobId:k,shifts:D,logoUrl:T}),O=URL.createObjectURL(h),R=document.createElement("a");R.href=O,R.download=`${c.replace(/\s+/g,"_")}_${S}_shifts.pdf`,document.body.appendChild(R),R.click(),document.body.removeChild(R),URL.revokeObjectURL(O),y({title:"Ã‰xito",description:"PDF generado exitosamente"})}catch{y({title:"Error",description:"No se pudo generar el PDF",variant:"destructive"})}};return e.jsxs("div",{className:"print:p-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{className:"print:block hidden",children:[e.jsx("h2",{className:"text-xl font-bold text-center",children:c}),e.jsx("p",{className:"text-center text-muted-foreground",children:C})]}),e.jsxs("div",{className:"flex gap-2 ml-auto mb-2 print:hidden",children:[!r&&D.length>0&&d.length>1&&e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>x(!0),children:[e.jsx(ut,{className:"h-4 w-4 mr-2"}),"Copiar Turnos"]}),e.jsxs(p,{variant:"outline",onClick:l,children:[e.jsx(Ba,{className:"h-4 w-4 mr-2"}),"Exportar a PDF"]})]})]}),e.jsxs($a,{className:"border-collapse border border-border print:border-black",children:[e.jsx(Ua,{children:e.jsxs(Ks,{className:"bg-muted print:bg-gray-200",children:[e.jsx(He,{className:"border border-border print:border-black print:text-black font-medium",children:"Turno"}),e.jsx(He,{className:"border border-border print:border-black print:text-black font-medium",children:"Horario"}),e.jsx(He,{className:"border border-border print:border-black print:text-black font-medium",children:"Stage"}),e.jsx(He,{className:"border border-border print:border-black print:text-black font-medium",children:"Departamento"}),e.jsx(He,{className:"border border-border print:border-black print:text-black font-medium",children:"TÃ©cnicos"}),e.jsx(He,{className:"border border-border print:border-black print:text-black font-medium print:hidden",children:"Acciones"})]})}),e.jsx(Va,{children:D.map(m=>e.jsxs(Ks,{className:"hover:bg-accent/5",children:[e.jsx(Ge,{className:"border border-border print:border-black font-medium print:text-black",children:m.name}),e.jsx(Ge,{className:"border border-border print:border-black print:text-black",children:P(m.start_time,m.end_time)}),e.jsx(Ge,{className:"border border-border print:border-black print:text-black",children:m.stage?`Stage ${m.stage}`:"-"}),e.jsx(Ge,{className:"border border-border print:border-black print:text-black",children:m.department||"-"}),e.jsx(Ge,{className:"border border-border print:border-black print:text-black",children:m.assignments.length>0?e.jsx("ul",{className:"list-disc list-inside",children:m.assignments.map(h=>e.jsxs("li",{className:"text-sm",children:[h.external_technician_name||h.profiles&&`${h.profiles.first_name} ${h.profiles.last_name}`," (",Ms(h.role)||h.role,")"]},h.id))}):e.jsx("span",{className:"text-muted-foreground print:text-gray-500",children:"Sin tÃ©cnicos asignados"})}),e.jsx(Ge,{className:"border border-border print:hidden",children:!r&&e.jsxs("div",{className:"flex gap-1",children:[e.jsx(p,{variant:"ghost",size:"icon",onClick:h=>L(h,m),className:"h-8 w-8",children:e.jsx(Ha,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",onClick:h=>v(h,m),className:"h-8 w-8",children:e.jsx(cs,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",onClick:h=>E(h,m.id),className:"h-8 w-8",children:e.jsx(zs,{className:"h-4 w-4 text-destructive"})})]})})]},m.id))})]}),f&&e.jsx(xt,{open:!!f,onOpenChange:m=>!m&&n(null),shift:f,onShiftUpdated:()=>{t(),n(null)}}),w&&e.jsx(pt,{open:!!w,onOpenChange:m=>!m&&j(null),shift:w,onAssignmentsUpdated:()=>{t()},isViewOnly:r}),u&&e.jsx(ft,{open:u,onOpenChange:x,sourceDate:S,jobDates:d,jobId:k,onShiftsCopied:()=>{N&&N(),x(!1)}})]})},Dr=({jobId:a,jobDates:o,isViewOnly:t=!1})=>{const[S,k]=s.useState(""),[r,d]=s.useState(!1),[N,y]=s.useState("table"),[T,A]=s.useState(!1),[c,b]=s.useState({}),[f,n]=s.useState("07:00"),{toast:w}=xe(),j=s.useCallback(h=>{try{return ve(h,"yyyy-MM-dd")}catch{return""}},[]),{data:u}=Ke({queryKey:["festival-settings",a],queryFn:async()=>{if(!a)return null;const{data:h,error:O}=await g.from("festival_settings").select("*").eq("job_id",a).maybeSingle();return O?null:h},enabled:!!a});s.useEffect(()=>{u!=null&&u.day_start_time&&n(u.day_start_time)},[u]);const{data:x,refetch:D}=Ke({queryKey:["job-date-types",a],queryFn:async()=>{if(!a)return{};const{data:h,error:O}=await g.from("job_date_types").select("*").eq("job_id",a);if(O)return{};const R={};return h.forEach(H=>{R[`${a}-${H.date}`]=H.type}),R},enabled:!!a});s.useEffect(()=>{x&&b(x)},[x]),s.useEffect(()=>{if(o&&o.length>0&&!S)try{const h=j(o[0]);if(h)k(h);else throw new Error("Could not format initial date")}catch{k(j(new Date))}},[o,S,j]);const{shifts:P,isLoading:E,refetch:L}=Nr({jobId:a,selectedDate:S}),v=async()=>{await L(),d(!1)},C=async()=>{setTimeout(async()=>{await L(),w({title:"Datos actualizados",description:"Los turnos y asignaciones han sido actualizados"})},500)},l=async h=>{try{A(!0),await g.from("festival_shift_assignments").delete().eq("shift_id",h);const{error:O}=await g.from("festival_shifts").delete().eq("id",h);if(O)throw O;await L(),w({title:"Ã‰xito",description:"Turno eliminado exitosamente"})}catch(O){w({title:"Error",description:`No se pudo eliminar el turno: ${O.message}`,variant:"destructive"})}finally{A(!1)}},m=async()=>{A(!0);try{await L(),w({title:"Ã‰xito",description:"Turnos actualizados exitosamente"})}catch{w({title:"Error",description:"No se pudieron actualizar los turnos",variant:"destructive"})}finally{A(!1)}};return!o||o.length===0?e.jsx(Y,{children:e.jsx(te,{className:"p-8 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No hay fechas disponibles para programar."})})}):e.jsxs(Y,{className:"mt-4 sm:mt-6",children:[e.jsxs(me,{className:"p-4 sm:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-4",children:[e.jsx(ue,{className:"text-base sm:text-lg",children:"ProgramaciÃ³n del Festival"}),e.jsxs("div",{className:"flex gap-2",children:[!t&&e.jsxs(p,{size:"sm",onClick:()=>d(!0),className:"flex items-center gap-1",children:[e.jsx(Ga,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Crear Turno"})]}),e.jsxs(p,{size:"sm",variant:"outline",className:"flex items-center gap-1",onClick:m,disabled:T,children:[e.jsx(bs,{className:`h-4 w-4 ${T?"animate-spin":""}`}),e.jsx("span",{className:"hidden sm:inline",children:"Actualizar"})]})]})]}),e.jsxs("div",{className:"mt-2 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2",children:[e.jsx(Oa,{tables:["festival_shifts","festival_shift_assignments"],variant:"compact",showRefreshButton:!0,onRefresh:m}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>y(N==="list"?"table":"list"),className:"text-xs w-fit",children:N==="table"?"Vista de Lista":"Vista de Tabla"})]})]}),e.jsx(te,{className:"p-4 sm:p-6",children:e.jsxs("div",{className:"space-y-4",children:[o.length>0&&e.jsx(za,{jobDates:o,selectedDate:S,onDateChange:k,dateTypes:c,jobId:a,onTypeChange:()=>D(),dayStartTime:f}),S&&(E?e.jsx("div",{className:"flex justify-center p-8",children:"Cargando..."}):P.length===0?e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:["No hay turnos programados para esta fecha. ",!t&&'Haz clic en "Crear Turno" para aÃ±adir uno.']}):N==="table"?e.jsx(kr,{shifts:P,onDeleteShift:l,onShiftUpdated:L,date:S,jobId:a,isViewOnly:t,jobDates:o,onShiftsCopied:C}):e.jsx(Sr,{shifts:P,onDeleteShift:l,onShiftUpdated:L,jobId:a,isViewOnly:t,jobDates:o,selectedDate:S,onShiftsCopied:C}))]})}),!t&&e.jsx(_r,{open:r,onOpenChange:d,jobId:a,onShiftCreated:v,date:S})]})};function Er({open:a,onOpenChange:o,jobId:t}){const{toast:S}=xe(),k=Is(),{session:r}=Ls(),[d,N]=s.useState(!1),[y,T]=s.useState(null),[A,c]=s.useState(null),[b,f]=s.useState(null),[n,w]=s.useState("sound"),[j,u]=s.useState(!1),{data:x=[]}=Ke({queryKey:["job-dates",t],queryFn:async()=>{const{data:v,error:C}=await g.from("jobs").select("start_time, end_time").eq("id",t).single();if(C)throw C;if(!v)return[];const l=new Date(v.start_time),m=new Date(v.end_time),h=[],O=new Date(l);for(;O<=m;)h.push(new Date(O)),O.setDate(O.getDate()+1);return h},enabled:!!t}),{data:D=[]}=Ke({queryKey:["job-presets",t,n],queryFn:async()=>{const{data:v,error:C}=await g.from("presets").select(`
          *,
          items:preset_items (
            *,
            equipment:equipment (*)
          )
        `).eq("department",n).eq("job_id",t).order("name");if(C)throw C;return(v||[]).map(ir)}}),P=Ns({mutationFn:async v=>{const C=await Promise.all(x.map(async m=>{var H;const h=ve(m,"yyyy-MM-dd"),{data:O}=await g.from("day_preset_assignments").select("order").eq("date",h).order("order",{ascending:!1}).limit(1),R=O&&O.length>0?(O[0].order||0)+1:0;return{date:h,preset_id:v,user_id:((H=r==null?void 0:r.user)==null?void 0:H.id)||"00000000-0000-0000-0000-000000000000",order:R,source:"job",source_id:t}})),{error:l}=await g.from("day_preset_assignments").insert(C);if(l)throw l},onSuccess:()=>{k.invalidateQueries({queryKey:["preset-assignments"]}),S({title:"Assigned",description:"Preset assigned to job dates"})},onError:v=>{S({title:"Error",description:v instanceof Error?v.message:"Failed to assign preset to job dates",variant:"destructive"})}});Ns({mutationFn:async v=>{const{error:C}=await g.from("preset_items").delete().eq("preset_id",v);if(C)throw C;const{error:l}=await g.from("presets").delete().eq("id",v);if(l)throw l},onSuccess:()=>{k.invalidateQueries({queryKey:["presets",n]}),S({title:"Preset deleted"})},onError:v=>S({title:"Error",description:v instanceof Error?v.message:"Failed to delete preset",variant:"destructive"})});const E=async(v,C)=>{try{const{data:l,error:m}=await g.from("presets").insert({name:v,department:n,job_id:t}).select().single();if(m)throw m;if(C.length>0){const{error:h}=await g.from("preset_items").insert(C.map(O=>({...O,preset_id:l.id})));if(h)throw h}if(x.length>0){const h=await Promise.all(x.map(async R=>{var K;const H=ve(R,"yyyy-MM-dd"),{data:J}=await g.from("day_preset_assignments").select("order").eq("date",H).order("order",{ascending:!1}).limit(1),ae=J&&J.length>0?(J[0].order||0)+1:0;return{date:H,preset_id:l.id,user_id:((K=r==null?void 0:r.user)==null?void 0:K.id)||"00000000-0000-0000-0000-000000000000",order:ae,source:"job",source_id:t}})),{error:O}=await g.from("day_preset_assignments").insert(h);if(O){S({title:"Preset saved",description:"Preset created but could not auto-assign to dates",variant:"default"}),k.invalidateQueries({queryKey:["job-presets",t,n]}),N(!1),T(null),c(null);return}k.invalidateQueries({queryKey:["preset-assignments"]})}k.invalidateQueries({queryKey:["job-presets",t,n]}),N(!1),T(null),c(null),S({title:"Preset saved and assigned to all job dates"})}catch(l){S({title:"Error",description:l instanceof Error?l.message:"Failed to save preset",variant:"destructive"})}},L=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Department"}),e.jsxs("select",{className:"border rounded px-2 py-1 text-sm",value:n,onChange:v=>w(v.target.value),children:[e.jsx("option",{value:"sound",children:"Sound"}),e.jsx("option",{value:"lights",children:"Lights"}),e.jsx("option",{value:"video",children:"Video"})]})]}),e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[n==="sound"&&e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>u(!0),className:"flex-1 sm:flex-initial",children:[e.jsx(ot,{className:"h-4 w-4 mr-2"}),"Create from Calculator"]}),e.jsx(p,{size:"sm",onClick:()=>N(!0),className:"flex-1 sm:flex-initial",children:"Create New Preset"})]})]}),e.jsx(Y,{children:e.jsx(te,{children:e.jsx(dt,{className:"h-[420px]",children:e.jsxs("div",{className:"space-y-3 py-2",children:[D.map(v=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 border rounded p-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:v.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[v.items.length," items Â· ",n]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[x.length>1&&e.jsx(p,{variant:"outline",size:"sm",onClick:()=>P.mutate(v.id),className:"text-xs",children:"Assign to all dates"}),e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>c({...v,name:`Copy of ${v.name}`}),children:e.jsx(ut,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>T(v),children:e.jsx(lr,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>f(v),children:e.jsx(zs,{className:"h-4 w-4"})})]})]},v.id)),D.length===0&&e.jsx("div",{className:"text-center text-sm text-muted-foreground py-6",children:"No presets for this department."})]})})})})]});return e.jsxs(e.Fragment,{children:[e.jsx(ee,{open:a,onOpenChange:o,children:e.jsxs(se,{className:"max-w-[95vw] sm:max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ne,{children:e.jsx(le,{className:"text-base sm:text-lg",children:"Job Presets"})}),d||y||A?e.jsx(Ys,{department:n,children:e.jsx(ar,{preset:y||A,isCopy:!!A,onSave:E,onCancel:()=>{N(!1),T(null),c(null)},jobId:t,allowedCategories:n==="sound"?rr:void 0})}):e.jsx(L,{})]})}),e.jsx(ee,{open:j,onOpenChange:u,children:e.jsxs(se,{className:"max-w-6xl max-h-[90vh]",children:[e.jsx(ne,{children:e.jsx(le,{children:"Amplifier Calculator - Create Preset"})}),e.jsx("div",{className:"text-sm text-muted-foreground mb-4",children:"Configure speakers and calculate amplifiers. Results will be saved as a new preset for this job."}),e.jsx(Ys,{department:n,children:e.jsx(nr,{jobId:t})})]})})]})}const Ar=({vm:a})=>{const{job:o,jobId:t,navigate:S,isSchedulingRoute:k,jobDates:r,isViewOnly:d,isAssignmentDialogOpen:N,setIsAssignmentDialogOpen:y,handleAssignmentChange:T,assignmentDepartment:A,isJobDetailsOpen:c,setIsJobDetailsOpen:b,isFlexLogOpen:f,setIsFlexLogOpen:n,isFlexPickerOpen:w,setIsFlexPickerOpen:j,handleFlexPickerConfirm:u,flexPickerOptions:x,isRouteSheetOpen:D,setIsRouteSheetOpen:P,isPrintDialogOpen:E,setIsPrintDialogOpen:L,handlePrintAllDocumentation:v,maxStages:C,isJobPresetsOpen:l,setIsJobPresetsOpen:m,isArchiveDialogOpen:h,setIsArchiveDialogOpen:O,archiveMode:R,setArchiveMode:H,archiveIncludeTemplates:J,setArchiveIncludeTemplates:ae,archiveDryRun:K,setArchiveDryRun:oe,isArchiving:X,archiveResult:pe,archiveError:Se,handleArchiveToFlex:Oe,isBackfillDialogOpen:Ye,setIsBackfillDialogOpen:ze,bfSound:Ce,setBfSound:Xe,bfLights:Ee,setBfLights:es,bfVideo:Ae,setBfVideo:ss,bfProduction:Me,setBfProduction:Q,uuidSound:Re,setUuidSound:ts,uuidLights:_e,setUuidLights:qe,uuidVideo:as,setUuidVideo:ce,uuidProduction:Fe,setUuidProduction:$e,isBackfilling:ke,backfillMessage:Ue,handleBackfill:Te,isWhatsappDialogOpen:rs,setIsWhatsappDialogOpen:Pe,isSendingWa:z,handleCreateWhatsappGroup:de,isAlmacenDialogOpen:fe,setIsAlmacenDialogOpen:ge,waMessage:ys,setWaMessage:ds,handleSendToAlmacen:ws,isDeleteDialogOpen:ms,setIsDeleteDialogOpen:Ve,isDeleting:is,handleDeleteJob:ns}=a;return e.jsxs(e.Fragment,{children:[o&&e.jsx(sr,{isOpen:N,onClose:()=>y(!1),onAssignmentChange:T,jobId:o.id,department:A}),o&&e.jsx(Aa,{open:c,onOpenChange:b,job:o,department:A}),t&&e.jsx(Qa,{jobId:t,open:f,onOpenChange:n}),e.jsx(Za,{open:w,onOpenChange:j,onConfirm:u,initialOptions:x}),e.jsx(ee,{open:D,onOpenChange:P,children:e.jsx(se,{className:"max-w-[96vw] w-[96vw] max-h-[90vh] md:h-[90vh] p-0 overflow-hidden flex flex-col",children:e.jsx("div",{className:"h-full overflow-auto",children:t&&e.jsx(er,{jobId:t})})})}),k&&e.jsxs("div",{children:[e.jsx("div",{className:"mb-4",children:e.jsx(p,{variant:"outline",onClick:()=>S(`/festival-management/${t}`),className:"flex items-center gap-1",children:"Volver al Festival"})}),r.length>0?e.jsx(Dr,{jobId:t,jobDates:r,isViewOnly:d}):e.jsx(Y,{children:e.jsxs(te,{className:"p-8 text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"No hay fechas disponibles para planificaciÃ³n. Por favor, actualiza primero las fechas del festival."}),e.jsx(p,{onClick:()=>S(`/festival-management/${t}`),children:"Volver"})]})})]}),E&&e.jsx(Ja,{open:E,onOpenChange:L,onConfirm:v,maxStages:C,jobTitle:(o==null?void 0:o.title)||"",jobId:t}),t&&e.jsx(Er,{open:l,onOpenChange:m,jobId:t}),e.jsx(ee,{open:h,onOpenChange:O,children:e.jsxs(se,{className:"sm:max-w-lg",children:[e.jsxs(ne,{children:[e.jsx(le,{children:"Archivar documentos en Flex"}),e.jsx(Qe,{children:"Sube todos los documentos del trabajo a la DocumentaciÃ³n TÃ©cnica de cada departamento en Flex y los elimina de Supabase."})]}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Modo"}),e.jsxs("select",{className:"w-full h-9 rounded-md border bg-background px-3 text-sm",value:R,onChange:U=>H(U.target.value),children:[e.jsx("option",{value:"by-prefix",children:"Por prefijo (predeterminado)"}),e.jsx("option",{value:"all-tech",children:"Todos los depts. tÃ©cnicos"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-6 sm:mt-[30px]",children:[e.jsx("input",{id:"includeTemplates",type:"checkbox",checked:J,onChange:U=>ae(U.target.checked)}),e.jsx("label",{htmlFor:"includeTemplates",className:"text-sm",children:"Incluir templates"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"dryRun",type:"checkbox",checked:K,onChange:U=>oe(U.target.checked)}),e.jsx("label",{htmlFor:"dryRun",className:"text-sm",children:"Prueba (sin eliminar)"})]})]}),X&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(G,{className:"h-4 w-4 animate-spin"})," Archivando..."]}),Se&&e.jsx("div",{className:"text-sm text-red-600",children:Se}),pe&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:"Resumen"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:["Intentados: ",e.jsx("span",{className:"font-medium",children:pe.attempted??0})]}),e.jsxs("div",{children:["Subidos: ",e.jsx("span",{className:"font-medium",children:pe.uploaded??0})]}),e.jsxs("div",{children:["Omitidos: ",e.jsx("span",{className:"font-medium",children:pe.skipped??0})]}),e.jsxs("div",{children:["Fallidos: ",e.jsx("span",{className:"font-medium",children:pe.failed??0})]})]})]})]}),e.jsxs(Ze,{children:[e.jsx(p,{variant:"outline",onClick:()=>O(!1),disabled:X,children:"Cerrar"}),e.jsxs(p,{onClick:Oe,disabled:X,children:[X?e.jsx(G,{className:"h-4 w-4 animate-spin mr-2"}):null,K?"Ejecutar Prueba":"Iniciar"]})]})]})}),e.jsx(ee,{open:Ye,onOpenChange:ze,children:e.jsxs(se,{className:"sm:max-w-lg",children:[e.jsxs(ne,{children:[e.jsx(le,{children:"Rellenar DocumentaciÃ³n TÃ©cnica"}),e.jsx(Qe,{children:"Encuentra y persiste elementos de DocumentaciÃ³n TÃ©cnica faltantes para este trabajo, permitiendo que el archivado los localice de forma fiable."})]}),e.jsxs("div",{className:"space-y-4 py-2 text-sm",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:Ce,onChange:U=>Xe(U.target.checked)})," Sonido"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:Ee,onChange:U=>es(U.target.checked)})," Luces"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:Ae,onChange:U=>ss(U.target.checked)})," Video"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:Me,onChange:U=>Q(U.target.checked)})," ProducciÃ³n"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"UUIDs manuales (opcional)"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"UUID Sonido"}),e.jsx("input",{className:"w-full h-8 rounded border px-2 text-xs",value:Re,onChange:U=>ts(U.target.value),placeholder:"pegar elementId"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"UUID Luces"}),e.jsx("input",{className:"w-full h-8 rounded border px-2 text-xs",value:_e,onChange:U=>qe(U.target.value),placeholder:"pegar elementId"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"UUID Video"}),e.jsx("input",{className:"w-full h-8 rounded border px-2 text-xs",value:as,onChange:U=>ce(U.target.value),placeholder:"pegar elementId"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"UUID ProducciÃ³n"}),e.jsx("input",{className:"w-full h-8 rounded border px-2 text-xs",value:Fe,onChange:U=>$e(U.target.value),placeholder:"pegar elementId"})]})]})]}),ke&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4 animate-spin"})," Rellenandoâ€¦"]}),Ue&&e.jsx("div",{className:"text-muted-foreground",children:Ue})]}),e.jsxs(Ze,{children:[e.jsx(p,{variant:"outline",onClick:()=>ze(!1),disabled:ke,children:"Cerrar"}),e.jsxs(p,{onClick:Te,disabled:ke,children:[ke?e.jsx(G,{className:"h-4 w-4 animate-spin mr-2"}):null,"Iniciar"]})]})]})}),e.jsx(ee,{open:rs,onOpenChange:Pe,children:e.jsxs(se,{children:[e.jsxs(ne,{children:[e.jsx(le,{children:"Crear Grupo de WhatsApp"}),e.jsx(Qe,{children:"Crea un grupo de WhatsApp para coordinar este trabajo con tu equipo."})]}),e.jsx("div",{className:"py-4",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Se crearÃ¡ un grupo de WhatsApp con el tÃ­tulo del trabajo: ",e.jsx("span",{className:"font-semibold",children:o==null?void 0:o.title})]})}),e.jsxs(Ze,{children:[e.jsx(p,{variant:"outline",onClick:()=>Pe(!1),disabled:z,children:"Cancelar"}),e.jsx(p,{onClick:de,disabled:z,children:z?"Creando...":"Crear Grupo"})]})]})}),e.jsx(ee,{open:fe,onOpenChange:ge,children:e.jsxs(se,{children:[e.jsxs(ne,{children:[e.jsx(le,{children:"Enviar a AlmacÃ©n sonido"}),e.jsx(Qe,{children:'Este mensaje se enviarÃ¡ al grupo de WhatsApp "AlmacÃ©n sonido" desde tu endpoint WAHA.'})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Mensaje"}),e.jsx(Os,{value:ys,onChange:U=>ds(U.target.value),placeholder:"Escribe tu mensajeâ€¦",className:"min-h-[100px]"})]}),e.jsxs(Ze,{children:[e.jsx(p,{variant:"outline",onClick:()=>ge(!1),disabled:z,children:"Cancelar"}),e.jsx(p,{onClick:ws,disabled:z,children:z?"Enviandoâ€¦":"Enviar"})]})]})}),e.jsx(ee,{open:ms,onOpenChange:Ve,children:e.jsxs(se,{children:[e.jsxs(ne,{children:[e.jsx(le,{children:"Eliminar Trabajo"}),e.jsx(Qe,{children:"Â¿EstÃ¡s seguro de que quieres eliminar este trabajo? Esta acciÃ³n no se puede deshacer."})]}),e.jsx("div",{className:"py-4",children:e.jsxs("p",{className:"text-sm",children:["Trabajo: ",e.jsx("span",{className:"font-semibold",children:o==null?void 0:o.title})]})}),e.jsxs(Ze,{children:[e.jsx(p,{variant:"outline",onClick:()=>Ve(!1),disabled:is,children:"Cancelar"}),e.jsx(p,{variant:"destructive",onClick:ns,disabled:is,children:is?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"mr-2 h-4 w-4 animate-spin"}),"Eliminando..."]}):"Eliminar"})]})]})})]})},Mr=({vm:a})=>{const{job:o,jobId:t,canEdit:S,isViewOnly:k,navigate:r,isSingleJobMode:d,isSchedulingRoute:N,isArtistRoute:y,isGearRoute:T,venueData:A,mapPreviewUrl:c,isMapLoading:b,handlePrintButtonClick:f,isPrinting:n,folderExists:w,isFlexLoading:j,handleFlexClick:u,flexUuid:x,setIsJobPresetsOpen:D,setIsDeleteDialogOpen:P,artistCount:E,handleRefreshAll:L,isLoading:v,isLoadingDocuments:C,assignmentDepartment:l,humanizeDepartment:m,setAssignmentDepartment:h,departmentOptions:O,handleOpenAssignments:R,isAssignmentDialogOpen:H,handleNavigateTimesheets:J,handleOpenRouteSheet:ae,flexStatus:K,handleCreateFlexFolders:oe,isCreatingFlexFolders:X,handleOpenFlexPicker:pe,handleOpenFlexLogs:Se,flexError:Oe,handleOpenJobDetails:Ye,handleDocumentUpload:ze,isUploadingDocument:Ce,handleCreateLocalFolders:Xe,isCreatingLocalFolders:Ee,setIsArchiveDialogOpen:es,isArchiving:Ae,setIsBackfillDialogOpen:ss,isBackfilling:Me,userRole:Q,setIsWhatsappDialogOpen:Re,setWaMessage:ts,setIsAlmacenDialogOpen:_e,navigateToCalculator:qe,jobDates:as,handleRefreshDocuments:ce,jobDocuments:Fe,formatDateLabel:$e,handleJobDocumentView:ke,handleJobDocumentDownload:Ue,groupedRiderFiles:Te,handleRiderView:rs,handleRiderDownload:Pe}=a;return e.jsxs("div",{className:"max-w-[1920px] mx-auto px-4 py-4 md:py-6 space-y-4 md:space-y-6",children:[e.jsx(Y,{className:"border-0 shadow-lg bg-gradient-to-br from-background via-background to-accent/5",children:e.jsx(me,{className:"pb-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between md:items-start gap-4",children:[e.jsxs("div",{className:"min-w-0 flex-1 space-y-3",children:[e.jsxs(ue,{className:"text-2xl md:text-3xl font-bold flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10 text-primary",children:d?e.jsx(vs,{className:"h-6 w-6 md:h-7 md:w-7"}):e.jsx(or,{className:"h-6 w-6 md:h-7 md:w-7"})}),e.jsx("span",{className:"truncate bg-gradient-to-r from-foreground to-foreground/70 bg-clip-text text-transparent",children:o==null?void 0:o.title})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs md:text-sm text-muted-foreground",children:[e.jsx(Ie,{variant:"secondary",className:"font-normal",children:d?"Single Job":"Festival"}),e.jsx("span",{className:"hidden sm:inline",children:"â€¢"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Xs,{className:"h-3 w-3"}),new Date((o==null?void 0:o.start_time)||"").toLocaleDateString()," - ",new Date((o==null?void 0:o.end_time)||"").toLocaleDateString()]}),A.address&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"hidden sm:inline",children:"â€¢"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(As,{className:"h-3 w-3"}),e.jsx("span",{className:"truncate max-w-xs",children:A.address})]})]})]}),(A.address||A.coordinates)&&e.jsx("div",{className:"mt-3",children:b?e.jsx("div",{className:"w-full aspect-[2/1] bg-muted rounded-lg flex items-center justify-center",children:e.jsx(G,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):c?e.jsxs("button",{onClick:()=>{const z=A.coordinates?`https://www.google.com/maps/search/?api=1&query=${A.coordinates.lat},${A.coordinates.lng}`:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(A.address||"")}`;window.open(z,"_blank","noopener,noreferrer")},className:"w-full rounded-lg overflow-hidden border hover:border-primary transition-all hover:shadow-md group relative",children:[e.jsx("img",{src:c,alt:"Venue location",width:600,height:300,loading:"lazy",decoding:"async",className:"w-full h-auto"}),e.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center",children:e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity bg-background/90 px-3 py-1.5 rounded-full text-sm font-medium flex items-center gap-2",children:[e.jsx(As,{className:"h-4 w-4"}),"Abrir en Google Maps"]})})]}):null})]}),e.jsx("div",{className:"flex flex-wrap gap-2 items-start",children:S&&e.jsxs(e.Fragment,{children:[e.jsxs(p,{variant:"outline",size:"sm",className:"flex items-center gap-2 hover:bg-accent/50 transition-all",onClick:f,disabled:n,children:[n?e.jsx(G,{className:"h-4 w-4 animate-spin"}):e.jsx(cr,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:n?"Generando...":"Imprimir"})]}),(w||j)&&e.jsxs(p,{variant:"outline",size:"sm",className:"flex items-center gap-2 hover:bg-accent/50 transition-all",onClick:u,disabled:!x||j,children:[j?e.jsx(G,{className:"h-4 w-4 animate-spin"}):e.jsx("img",{src:Sa,alt:"Flex",width:16,height:16,loading:"lazy",decoding:"async",className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:j?"Cargando...":"Flex"})]}),e.jsx(gr,{jobId:t}),e.jsxs(p,{variant:"outline",size:"sm",className:"flex items-center gap-2 hover:bg-accent/50 transition-all",onClick:()=>D(!0),children:[e.jsx(dr,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Presets"})]}),e.jsxs(p,{variant:"outline",size:"sm",className:"flex items-center gap-2 hover:bg-destructive/10 hover:text-destructive transition-all",onClick:()=>P(!0),children:[e.jsx(zs,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Eliminar"})]})]})})]})})}),!N&&!y&&!T&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 md:gap-6",children:[e.jsxs(Y,{className:"group hover:shadow-xl hover:scale-[1.02] transition-all duration-300 cursor-pointer border-2 hover:border-primary/50 bg-gradient-to-br from-background to-accent/5",onClick:()=>r(`/festival-management/${t}/artists`),children:[e.jsx(me,{className:"pb-3",children:e.jsxs(ue,{className:"flex items-center gap-3 text-base md:text-lg",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-500/10 text-blue-500 group-hover:bg-blue-500/20 transition-colors",children:e.jsx(cs,{className:"h-5 w-5 md:h-6 md:w-6"})}),e.jsx("span",{className:"group-hover:text-primary transition-colors",children:"Artistas"})]})}),e.jsxs(te,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("p",{className:"text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-600 to-blue-400 bg-clip-text text-transparent",children:E}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Total de Artistas"})]}),e.jsx(p,{className:"w-full group-hover:shadow-md transition-shadow",size:"sm",onClick:z=>{z.stopPropagation(),r(`/festival-management/${t}/artists`)},children:k?"Ver Artistas":"Gestionar Artistas"})]})]}),e.jsxs(Y,{className:"group hover:shadow-xl hover:scale-[1.02] transition-all duration-300 cursor-pointer border-2 hover:border-primary/50 bg-gradient-to-br from-background to-accent/5",onClick:()=>r(`/festival-management/${t}/gear`),children:[e.jsx(me,{className:"pb-3",children:e.jsxs(ue,{className:"flex items-center gap-3 text-base md:text-lg",children:[e.jsx("div",{className:"p-2 rounded-lg bg-purple-500/10 text-purple-500 group-hover:bg-purple-500/20 transition-colors",children:e.jsx(pr,{className:"h-5 w-5 md:h-6 md:w-6"})}),e.jsx("span",{className:"group-hover:text-primary transition-colors",children:"Escenarios y Equipo"})]})}),e.jsxs(te,{className:"space-y-3",children:[e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground min-h-[2.5rem]",children:"Gestiona escenarios y equipo tÃ©cnico"}),e.jsx(p,{className:"w-full group-hover:shadow-md transition-shadow",size:"sm",onClick:z=>{z.stopPropagation(),r(`/festival-management/${t}/gear`)},children:k?"Ver Equipo":"Gestionar Equipo"})]})]}),e.jsxs(Y,{className:"group hover:shadow-xl hover:scale-[1.02] transition-all duration-300 cursor-pointer border-2 hover:border-primary/50 bg-gradient-to-br from-background to-accent/5",onClick:()=>r(`/festival-management/${t}/scheduling`),children:[e.jsx(me,{className:"pb-3",children:e.jsxs(ue,{className:"flex items-center gap-3 text-base md:text-lg",children:[e.jsx("div",{className:"p-2 rounded-lg bg-green-500/10 text-green-500 group-hover:bg-green-500/20 transition-colors",children:e.jsx(Xs,{className:"h-5 w-5 md:h-6 md:w-6"})}),e.jsx("span",{className:"group-hover:text-primary transition-colors",children:"PlanificaciÃ³n"})]})}),e.jsxs(te,{className:"space-y-3",children:[e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground min-h-[2.5rem]",children:"Gestiona turnos y asignaciones de personal"}),e.jsx(p,{className:"w-full group-hover:shadow-md transition-shadow",size:"sm",onClick:z=>{z.stopPropagation(),r(`/festival-management/${t}/scheduling`)},children:k?"Ver PlanificaciÃ³n":"Gestionar PlanificaciÃ³n"})]})]})]}),e.jsxs(Y,{children:[e.jsx(me,{className:"pb-3",children:e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs(ue,{className:"flex items-center gap-2 text-base md:text-lg",children:[e.jsx(bs,{className:"h-4 w-4 md:h-5 md:w-5"}),"Acciones RÃ¡pidas"]}),e.jsxs(p,{variant:"outline",size:"sm",onClick:z=>{z.stopPropagation(),L()},disabled:v||C,className:"w-full sm:w-auto gap-2",children:[v||C?e.jsx(G,{className:"h-4 w-4 animate-spin"}):e.jsx(bs,{className:"h-4 w-4"}),"Actualizar Datos"]})]})}),e.jsx(te,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-3 md:gap-4",children:[e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(cs,{className:"h-4 w-4 flex-shrink-0"}),"Asignaciones"]}),e.jsx(Ie,{variant:"outline",className:"text-xs",children:m(l)})]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Coordina asignaciones de crew por departamento."}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs(be,{value:l,onValueChange:z=>h(z),children:[e.jsx(Ne,{className:"w-full",children:e.jsx(ye,{placeholder:"Department"})}),e.jsx(we,{children:O.map(z=>e.jsx($,{value:z,children:m(z)},z))})]}),e.jsx(p,{onClick:R,disabled:!o||H,size:"sm",className:"w-full",children:"Abrir"})]})]}),e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(mr,{className:"h-4 w-4 flex-shrink-0"}),"Flex Crew Calls"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Vincula los IDs de elementos de crew call de Sonido/Luces."}),e.jsx("div",{className:"flex",children:t&&e.jsx(br,{jobId:t})})]}),e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(ct,{className:"h-4 w-4 flex-shrink-0"}),"Timesheets"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Revisa y aprueba las hojas de tiempo del crew para este trabajo."}),e.jsx(p,{onClick:J,disabled:!t,size:"sm",className:"w-full",children:"Abrir Hojas de Tiempo"})]}),e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(As,{className:"h-4 w-4 flex-shrink-0"}),"Hoja de Ruta"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Genera y revisa la hoja de ruta para este trabajo."}),e.jsx(p,{onClick:ae,disabled:!t,size:"sm",className:"w-full",children:"Abrir Hoja de Ruta"})]}),e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(et,{className:"h-4 w-4 flex-shrink-0"}),"Flex Folders"]}),e.jsx(Ie,{variant:K.variant,className:"text-xs",children:K.label})]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"MantÃ©n las carpetas de Flex sincronizadas con los datos de este trabajo."}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(p,{onClick:oe,disabled:!S||!o||X||j,size:"sm",className:"w-full",children:X?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"mr-2 h-4 w-4 animate-spin"}),"Creandoâ€¦"]}):"Crear / Verificar"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(p,{variant:"secondary",onClick:pe,disabled:!S||!o||X||j||!w,size:"sm",children:X?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"mr-2 h-4 w-4 animate-spin"}),"Actualizandoâ€¦"]}):"AÃ±adir"}),e.jsx(p,{variant:"outline",onClick:Se,disabled:!S,size:"sm",children:"Ver Registros"})]})]}),Oe&&e.jsx("p",{className:"text-xs text-destructive",children:Oe})]}),e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(vs,{className:"h-4 w-4 flex-shrink-0"}),"Detalles del Trabajo"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Ve la configuraciÃ³n completa del trabajo y sus metadatos."}),e.jsx(p,{onClick:Ye,disabled:!o,size:"sm",className:"w-full",children:"Ver Detalles del Trabajo"})]}),S&&e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3 bg-gradient-to-br from-background to-blue-500/5",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(lt,{className:"h-4 w-4 flex-shrink-0 text-blue-500"}),"Subir Documentos"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Sube documentos de trabajo y archivos tÃ©cnicos."}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",onChange:ze,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10",disabled:Ce}),e.jsx(p,{disabled:Ce,size:"sm",className:"w-full relative",children:Ce?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"mr-2 h-4 w-4 animate-spin"}),"Subiendo..."]}):"Elegir Archivo"})]})]}),S&&e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3 bg-gradient-to-br from-background to-purple-500/5",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(et,{className:"h-4 w-4 flex-shrink-0 text-purple-500"}),"Carpetas Locales"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Crea estructura de carpetas locales para este trabajo."}),e.jsx(p,{onClick:Xe,disabled:Ee,size:"sm",className:"w-full",children:Ee?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"mr-2 h-4 w-4 animate-spin"}),"Creando..."]}):"Crear Carpetas"})]}),S&&e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3 bg-gradient-to-br from-background to-orange-500/5",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(Ka,{className:"h-4 w-4 flex-shrink-0 text-orange-500"}),"Archivar en Flex"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Archiva documentos en Flex DocumentaciÃ³n TÃ©cnica."}),e.jsx(p,{onClick:()=>es(!0),disabled:Ae,size:"sm",className:"w-full",variant:"outline",children:Ae?"Archivando...":"Abrir Archivo"})]}),S&&e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3 bg-gradient-to-br from-background to-cyan-500/5",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(Ya,{className:"h-4 w-4 flex-shrink-0 text-cyan-500"}),"Rellenar Doc TÃ©cnica"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Encuentra y persiste documentaciÃ³n tÃ©cnica faltante."}),e.jsx(p,{onClick:()=>ss(!0),disabled:Me,size:"sm",className:"w-full",variant:"outline",children:Me?"Rellenando...":"Abrir Relleno"})]}),(Q==="management"||Q==="admin")&&e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3 bg-gradient-to-br from-background to-green-500/5",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(st,{className:"h-4 w-4 flex-shrink-0 text-green-500"}),"Grupo de WhatsApp"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Crea grupo de WhatsApp para coordinaciÃ³n del trabajo."}),e.jsx(p,{onClick:()=>Re(!0),size:"sm",className:"w-full",variant:"outline",children:"Crear Grupo"})]}),(Q==="management"||Q==="admin")&&e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3 bg-gradient-to-br from-background to-amber-500/5",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(st,{className:"h-4 w-4 flex-shrink-0 text-amber-500"}),"AlmacÃ©n Sonido"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"EnvÃ­a mensaje al equipo de almacÃ©n."}),e.jsx(p,{onClick:()=>{ts(`He hecho cambios en el PS del ${o==null?void 0:o.title} por favor echad un vistazo`),_e(!0)},size:"sm",className:"w-full",variant:"outline",children:"Enviar Mensaje"})]}),Q==="management"&&e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3 bg-gradient-to-br from-background to-indigo-500/5",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(Xa,{className:"h-4 w-4 flex-shrink-0 text-indigo-500"}),"Calculadora de Pesos"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Calcula pesos y distribuciÃ³n de carga."}),e.jsx(p,{onClick:()=>qe("pesos"),size:"sm",className:"w-full",variant:"outline",children:"Abrir Calculadora"})]}),Q==="management"&&e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3 bg-gradient-to-br from-background to-yellow-500/5",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(ur,{className:"h-4 w-4 flex-shrink-0 text-yellow-500"}),"Calculadora de Consumos"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Calcula consumo y requisitos de energÃ­a."}),e.jsx(p,{onClick:()=>qe("consumos"),size:"sm",className:"w-full",variant:"outline",children:"Abrir Calculadora"})]}),Q==="technician"&&e.jsxs("div",{className:"rounded-lg border p-3 md:p-4 space-y-2 md:space-y-3 bg-gradient-to-br from-background to-red-500/5",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm font-semibold text-foreground",children:[e.jsx(Fs,{className:"h-4 w-4 flex-shrink-0 text-red-500"}),"Reporte de Incidencia"]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Crea un reporte de incidencia para este trabajo."}),e.jsx(Ma,{job:o,techName:Q})]})]})})]}),e.jsx(jr,{jobId:t,venue:A,jobDates:as}),e.jsxs(Y,{children:[e.jsx(me,{className:"pb-3",children:e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs(ue,{className:"flex items-center gap-2 text-base md:text-lg",children:[e.jsx(vs,{className:"h-4 w-4 md:h-5 md:w-5"}),"Documentos y Riders"]}),e.jsxs(p,{variant:"outline",size:"sm",onClick:z=>{z.stopPropagation(),ce()},disabled:C,className:"w-full sm:w-auto",children:[C?e.jsx(G,{className:"mr-2 h-4 w-4 animate-spin"}):null,C?"Actualizandoâ€¦":"Actualizar"]})]})}),e.jsx(te,{className:"space-y-4 md:space-y-6",children:C?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(G,{className:"h-4 w-4 animate-spin"}),"Cargando documentosâ€¦"]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs md:text-sm font-semibold text-foreground flex items-center gap-2 mb-3",children:[e.jsx(vs,{className:"h-4 w-4 flex-shrink-0"}),"Documentos del Trabajo"]}),Fe.length>0?e.jsx("div",{className:"space-y-2",children:Fe.map(z=>{const de=z.template_type==="soundvision",fe=!!z.read_only;return e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 rounded-md border bg-card p-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"text-xs md:text-sm font-medium text-foreground flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"truncate",children:z.file_name}),de&&e.jsx(Ie,{variant:"outline",className:"text-[10px] uppercase tracking-wide flex-shrink-0",children:"Template SoundVision File"})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["Uploaded ",$e(z.uploaded_at),fe&&e.jsx("span",{className:"ml-2 italic",children:"Read-only"})]})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:flex-shrink-0",children:[e.jsx(p,{variant:"ghost",size:"sm",onClick:ge=>{ge.stopPropagation(),ke(z)},title:"View",className:"h-8 w-8 p-0",children:e.jsx(tt,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"sm",onClick:ge=>{ge.stopPropagation(),Ue(z)},title:"Download",className:"h-8 w-8 p-0",children:e.jsx(at,{className:"h-4 w-4"})})]})]},z.id)})}):e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"AÃºn no se han subido documentos del trabajo."})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs md:text-sm font-semibold text-foreground flex items-center gap-2 mb-3",children:[e.jsx(cs,{className:"h-4 w-4 flex-shrink-0"}),"Riders de Artistas"]}),Te.length>0?e.jsx("div",{className:"space-y-4",children:Te.map(z=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xs md:text-sm font-medium text-foreground",children:z.artistName}),e.jsx("div",{className:"space-y-2",children:z.files.map(de=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 rounded-md border bg-accent/20 p-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"text-xs md:text-sm font-medium text-foreground truncate",children:de.file_name}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["Uploaded ",$e(de.created_at)]})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:flex-shrink-0",children:[e.jsx(p,{variant:"ghost",size:"sm",onClick:fe=>{fe.stopPropagation(),rs(de)},title:"View",className:"h-8 w-8 p-0",children:e.jsx(tt,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"sm",onClick:fe=>{fe.stopPropagation(),Pe(de)},title:"Download",className:"h-8 w-8 p-0",children:e.jsx(at,{className:"h-4 w-4"})})]})]},de.id))})]},z.artistId))}):e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"AÃºn no se han subido riders de artistas. Los riders aÃ±adidos a travÃ©s de la tabla de artistas aparecerÃ¡n aquÃ­ automÃ¡ticamente."})]})]})})]})]}),e.jsx(Ar,{vm:a})]})},Fr=async(a,o,t,S)=>{const k=(await xr(async()=>{const{default:c}=await import("./jszip.min-Diji-d1c.js").then(b=>b.j);return{default:c}},__vite__mapDeps([0,1]))).default,r=new k,{data:d,error:N}=await g.from("festival_stages").select("number, name").eq("job_id",a).order("number"),y=c=>{const b=d==null?void 0:d.find(f=>f.number===c);return(b==null?void 0:b.name)||`Stage_${c}`};for(let c=1;c<=S;c++)try{const b={...t,generateIndividualStagePDFs:!1,gearSetupStages:t.includeGearSetup?[c]:[],shiftScheduleStages:t.includeShiftSchedules?[c]:[],artistTableStages:t.includeArtistTables?[c]:[],artistRequirementStages:t.includeArtistRequirements?[c]:[],rfIemTableStages:t.includeRfIemTable?[c]:[],infrastructureTableStages:t.includeInfrastructureTable?[c]:[],wiredMicNeedsStages:t.includeWiredMicNeeds?[c]:[]},f=y(c),n=`${o.replace(/[^a-zA-Z0-9\s]/g,"").replace(/\s+/g,"_")}_${f}_Documentation.pdf`,w=await mt(a,o,b,n);r.file(n,w.blob)}catch{}const T=await r.generateAsync({type:"blob"}),A=`${o.replace(/[^a-zA-Z0-9\s]/g,"").replace(/\s+/g,"_")}_Individual_Stage_PDFs.zip`;return{blob:T,filename:A}},Tr=()=>{const{jobId:a}=Na(),o=ya(),t=wa(),k=new URLSearchParams(t.search).get("singleJob")==="true",{toast:r}=xe(),[d,N]=s.useState(null),[y,T]=s.useState(!0),[A,c]=s.useState(0),[b,f]=s.useState([]),[n,w]=s.useState({}),[j,u]=s.useState(null),[x,D]=s.useState(!1),[P,E]=s.useState(!1),[L,v]=s.useState(!1),{userRole:C}=Ls(),[l,m]=s.useState(1),{flexUuid:h,isLoading:O,error:R,folderExists:H,refetch:J}=hr(a||""),[ae,K]=s.useState([]),[oe,X]=s.useState([]),[pe,Se]=s.useState(!1),[Oe,Ye]=s.useState("sound"),[ze,Ce]=s.useState(!1),[Xe,Ee]=s.useState(!1),[es,Ae]=s.useState(!1),[ss,Me]=s.useState(!1),[Q,Re]=s.useState(!1),[ts,_e]=s.useState(!1),[qe,as]=s.useState(void 0),[ce,Fe]=s.useState("add"),[$e,ke]=s.useState(!1),[Ue,Te]=s.useState(!1),[rs,Pe]=s.useState(!1),[z,de]=s.useState(!1),[fe,ge]=s.useState(!1),[ys,ds]=s.useState(null),[ws,ms]=s.useState(null),[Ve,is]=s.useState("by-prefix"),[ns,U]=s.useState(!1),[ls,gt]=s.useState(!1),[jt,vt]=s.useState(!1),[bt,Rs]=s.useState(!1),[Nt,Ss]=s.useState(null),[Pr,qs]=s.useState(null),[Cs,yt]=s.useState(!0),[_s,wt]=s.useState(!0),[ks,St]=s.useState(!0),[Ds,Ct]=s.useState(!0),[us,_t]=s.useState(""),[hs,kt]=s.useState(""),[xs,Dt]=s.useState(""),[ps,Et]=s.useState(""),[At,$s]=s.useState(!1),[Mt,Us]=s.useState(!1),[Es,Ft]=s.useState(""),[Tt,fs]=s.useState(!1),[Pt,Vs]=s.useState(!1),[Lt,Ws]=s.useState(!1),gs=s.useCallback(i=>ka(i),[]),je=s.useCallback(async i=>{const _=(i==null?void 0:i.silent)??!1;if(!a){N(null),c(0),f([]),w({}),_||T(!1);return}_||T(!0);try{const{data:M,error:F}=await g.from("jobs").select("*").eq("id",a).single();if(F)throw F;N(M);const{count:I,error:V}=await g.from("festival_artists").select("*",{count:"exact"}).eq("job_id",a);if(V)throw V;c(I||0);const{data:W,error:os}=await g.from("festival_gear_setups").select("max_stages").eq("job_id",a).order("created_at",{ascending:!1}).limit(1);if(os||W&&W.length>0&&m(W[0].max_stages||1),M.location_id){const{data:q,error:re}=await g.from("locations").select("name, formatted_address, latitude, longitude").eq("id",M.location_id).single();if(!re&&q)w({address:q.formatted_address||q.name||void 0,coordinates:typeof q.latitude=="number"&&typeof q.longitude=="number"?{lat:q.latitude,lng:q.longitude}:void 0});else{const{data:De,error:Je}=await g.from("hoja_de_ruta").select("venue_address, venue_latitude, venue_longitude").eq("job_id",a).maybeSingle();!Je&&De&&w({address:De.venue_address||void 0,coordinates:typeof De.venue_latitude=="number"&&typeof De.venue_longitude=="number"?{lat:De.venue_latitude,lng:De.venue_longitude}:void 0})}}else{const{data:q,error:re}=await g.from("hoja_de_ruta").select("venue_address, venue_latitude, venue_longitude").eq("job_id",a).maybeSingle();!re&&q&&w({address:q.venue_address||void 0,coordinates:typeof q.venue_latitude=="number"&&typeof q.venue_longitude=="number"?{lat:q.venue_latitude,lng:q.venue_longitude}:void 0})}const Le=new Date(M.start_time),We=new Date(M.end_time);if(Be(Le)&&Be(We)){const q=[],re=new Date(Le);for(;re<=We;)q.push(new Date(re)),re.setDate(re.getDate()+1);f(q)}else{const{data:q,error:re}=await g.from("job_date_types").select("*").eq("job_id",a);if(!re)if(q&&q.length>0){const De=Array.from(new Set(q.map(Je=>{try{return new Date(Je.date)}catch{return null}}).filter(Je=>Je&&Be(Je))));f(De)}else f([new Date])}}catch{_||r({title:"Error",description:"Could not load festival details",variant:"destructive"})}finally{_||T(!1)}},[a,r]),Z=s.useCallback(async()=>{if(!a){K([]),X([]),Se(!1);return}Se(!0);try{const{data:i,error:_}=await g.from("job_documents").select("id, file_name, file_path, uploaded_at, read_only, template_type").eq("job_id",a).order("uploaded_at",{ascending:!1});if(_)throw _;K(i||[]);const{data:M,error:F}=await g.from("festival_artists").select("id, name").eq("job_id",a);if(F)throw F;const I=(M||[]).map(W=>W.id);let V=[];if(I.length>0){let W=g.from("festival_artist_files").select("id, file_name, file_path, uploaded_at, artist_id").order("uploaded_at",{ascending:!1});if(I.length===1)W=W.eq("artist_id",I[0]);else{const q=I.map(re=>`artist_id.eq.${re}`).join(",");W=W.or(q)}const{data:os,error:Le}=await W;if(Le)throw Le;V=os||[];const We=new Map((M||[]).map(q=>[q.id,q.name]));V=V.map(q=>({...q,festival_artists:{id:q.artist_id,name:We.get(q.artist_id)||"Unknown"}}))}X(V||[])}catch(i){r({title:"Error al cargar documentos",description:i.message||"No se pudieron cargar los documentos para este trabajo.",variant:"destructive"})}finally{Se(!1)}},[a,r]),It=s.useCallback(async i=>{try{const{bucket:_,path:M}=gs(i.file_path),{data:F,error:I}=await g.storage.from(_).createSignedUrl(M,3600);if(I)throw I;F!=null&&F.signedUrl&&window.open(F.signedUrl,"_blank","noopener")}catch(_){r({title:"No se puede abrir el documento",description:_.message||"Por favor, intÃ©ntalo de nuevo en unos momentos.",variant:"destructive"})}},[gs,r]),Ot=s.useCallback(async i=>{try{const{bucket:_,path:M}=gs(i.file_path),{data:F,error:I}=await g.storage.from(_).download(M);if(I)throw I;const V=window.URL.createObjectURL(F),W=window.document.createElement("a");W.href=V,W.download=i.file_name,window.document.body.appendChild(W),W.click(),window.document.body.removeChild(W),window.URL.revokeObjectURL(V)}catch(_){r({title:"Descarga fallida",description:_.message||"No se pudo descargar ese archivo.",variant:"destructive"})}},[gs,r]),zt=s.useCallback(async i=>{try{const{data:_,error:M}=await g.storage.from("festival_artist_files").createSignedUrl(i.file_path,3600);if(M)throw M;_!=null&&_.signedUrl&&window.open(_.signedUrl,"_blank","noopener")}catch(_){r({title:"No se puede abrir el rider",description:_.message||"Por favor, intÃ©ntalo de nuevo mÃ¡s tarde.",variant:"destructive"})}},[r]),Rt=s.useCallback(async i=>{try{const{data:_,error:M}=await g.storage.from("festival_artist_files").download(i.file_path);if(M)throw M;const F=window.URL.createObjectURL(_),I=window.document.createElement("a");I.href=F,I.download=i.file_name,window.document.body.appendChild(I),I.click(),window.document.body.removeChild(I),window.URL.revokeObjectURL(F)}catch(_){r({title:"Descarga fallida",description:_.message||"No se pudo descargar ese archivo de rider.",variant:"destructive"})}},[r]),qt=s.useCallback(()=>{Z()},[Z]),$t=s.useMemo(()=>{const i=new Map;return oe.forEach(_=>{var I,V;const M=_.artist_id||((I=_.festival_artists)==null?void 0:I.id)||"unknown",F=((V=_.festival_artists)==null?void 0:V.name)||"Unknown Artist";i.has(M)||i.set(M,{artistId:M,artistName:F,files:[]}),i.get(M).files.push(_)}),Array.from(i.values()).sort((_,M)=>_.artistName.localeCompare(M.artistName))},[oe]),Ut=s.useCallback(i=>{if(!i)return"Unknown date";const _=new Date(i);return Be(_)?ve(_,"MMM d, yyyy"):"Unknown date"},[]),Vt=["sound","lights","video","production","logistics","administrative","personnel","comercial"],Wt=s.useCallback(i=>i.charAt(0).toUpperCase()+i.slice(1),[]),Jt=s.useCallback(()=>{je({silent:!0}),Z()},[je,Z]),Bt=s.useCallback(()=>{a&&Ce(!0)},[a]),Ht=s.useCallback(()=>{a&&o(`/timesheets?jobId=${a}`)},[a,o]),Gt=s.useCallback(()=>{Ee(!0)},[]),Qt=s.useCallback(()=>{d&&Ae(!0)},[d]),Zt=s.useCallback(()=>{Me(!0)},[]),Kt=s.useCallback(()=>{!d||Q||(Fe("add"),_e(!0))},[d,Q]),Yt=s.useCallback(()=>{je(),Z(),J()},[je,Z,J]),Xt=s.useCallback(()=>{!d||Q||(Fe("create"),_e(!0))},[d,Q]),ea=s.useCallback(async i=>{if(!d||!a)return;if(as(i),_e(!1),ce==="create")try{const{data:F,error:I}=await g.from("flex_folders").select("id").eq("job_id",a).limit(1);if(I)throw I;if(F&&F.length>0){r({title:"Las carpetas ya existen",description:"Ya se han creado carpetas Flex para este trabajo."});return}}catch(F){r({title:"Error al verificar carpetas",description:F.message||"Por favor, intÃ©ntalo de nuevo en un momento.",variant:"destructive"});return}if(!d.start_time||!d.end_time){r({title:"Fechas del trabajo faltantes",description:`Actualiza las fechas del trabajo antes de ${ce==="create"?"crear":"aÃ±adir"} carpetas Flex.`,variant:"destructive"});return}const _=new Date(d.start_time),M=new Date(d.end_time);if(!Be(_)||!Be(M)){r({title:"Fechas del trabajo invÃ¡lidas",description:"Por favor, verifica las fechas del trabajo antes de crear carpetas Flex.",variant:"destructive"});return}try{Re(!0);const F=_.toISOString().slice(2,10).replace(/-/g,""),I=_.toISOString().split(".")[0]+".000Z",V=M.toISOString().split(".")[0]+".000Z";r({title:ce==="create"?"Creando carpetas Flexâ€¦":"AÃ±adiendo carpetas Flexâ€¦",description:ce==="create"?"Esto puede tardar unos segundos.":"Las carpetas seleccionadas se crearÃ¡n en Flex."}),await tr(d,I,V,F,i);try{g.functions.invoke("push",{body:{action:"broadcast",type:"flex.folders.created",job_id:a}})}catch{}r({title:ce==="create"?"Carpetas Flex listas":"Carpetas Flex actualizadas",description:ce==="create"?"Las carpetas se han creado exitosamente.":"Las carpetas seleccionadas se han aÃ±adido exitosamente."}),await Promise.all([J(),je({silent:!0}),Z()])}catch(F){r({title:"Error al actualizar carpetas Flex",description:F.message||"Por favor, intÃ©ntalo de nuevo en un momento.",variant:"destructive"})}finally{Re(!1)}},[d,a,ce,r,J,je,Z]),sa=s.useMemo(()=>O?{label:"Verificando estadoâ€¦",variant:"outline"}:R?{label:"Error de Flex",variant:"destructive"}:H?{label:"Carpetas listas",variant:"secondary"}:{label:"Carpetas no creadas",variant:"outline"},[O,R,H]),ta=t.pathname.includes("/scheduling"),aa=t.pathname.includes("/artists"),ra=t.pathname.includes("/gear"),ia=["admin","management","logistics"].includes(C||""),na=C==="technician";s.useEffect(()=>{if(je(),!a)return;const i=g.channel(`job-${a}-updates`).on("postgres_changes",{event:"*",schema:"public",table:"jobs",filter:`id=eq.${a}`},()=>{je({silent:!0}),Z()}).subscribe();return()=>{i.unsubscribe()}},[a,je,Z]),s.useEffect(()=>{Z()},[Z]),s.useEffect(()=>{(async()=>{try{if(!n.address&&!n.coordinates){u(null);return}D(!0);const{data:_,error:M}=await g.functions.invoke("get-google-maps-key");if(M||!(_!=null&&_.apiKey)){u(null),D(!1);return}const F=_.apiKey,I=13,V=400,W=200,os=2,Le=n.coordinates?`${n.coordinates.lat},${n.coordinates.lng}`:encodeURIComponent(n.address||""),We=n.coordinates?`&markers=color:red|label:V|${n.coordinates.lat},${n.coordinates.lng}`:n.address?`&markers=color:red|label:V|${encodeURIComponent(n.address)}`:"",q=`https://maps.googleapis.com/maps/api/staticmap?center=${Le}&zoom=${I}&size=${V}x${W}&scale=${os}${We}&key=${encodeURIComponent(F)}`;u(q)}catch{u(null)}finally{D(!1)}})()},[n]);const la=async(i,_)=>{if(a){E(!0);try{let M;if(i.generateIndividualStagePDFs?M=await Fr(a,(d==null?void 0:d.title)||"Festival",i,l):M=await mt(a,(d==null?void 0:d.title)||"Festival",i,_),!M.blob||M.blob.size===0)throw new Error("Generated file is empty");const F=URL.createObjectURL(M.blob),I=document.createElement("a");I.href=F,I.download=M.filename,document.body.appendChild(I),I.click(),document.body.removeChild(I),URL.revokeObjectURL(F),r({title:"Ã‰xito",description:i.generateIndividualStagePDFs?"PDFs individuales de escenarios generados exitosamente":"DocumentaciÃ³n generada exitosamente"})}catch(M){r({title:"Error",description:`Error al generar documentaciÃ³n: ${M.message}`,variant:"destructive"})}finally{E(!1)}}},oa=()=>{v(!0)},ca=async()=>{if(O){r({title:"Cargando",description:"Por favor espera mientras cargamos la carpeta Flex..."});return}h?await Fa({elementId:h,onError:i=>{r({title:"Error",description:i.message||"Error al abrir Flex",variant:"destructive"})},onWarning:i=>{r({title:"Advertencia",description:i})}}):r(R?{title:"Error",description:R,variant:"destructive"}:{title:"Info",description:"Carpeta Flex no disponible para este festival"})},da=s.useCallback(async i=>{var M;const _=(M=i.target.files)==null?void 0:M[0];if(!(!_||!a)){Te(!0);try{const F=`${a}/${_.name}`,{error:I}=await g.storage.from("job_documents").upload(F,_);if(I)throw I;const{error:V}=await g.from("job_documents").insert({job_id:a,file_name:_.name,file_path:F});if(V)throw V;r({title:"Ã‰xito",description:"Documento subido exitosamente"}),Z()}catch(F){r({title:"Error al subir",description:F.message||"Error al subir documento",variant:"destructive"})}finally{Te(!1),i.target.value=""}}},[a,r,Z]),ma=s.useCallback(async()=>{if(d){Pe(!0);try{const{data:i,error:_}=await g.functions.invoke("create-local-folders",{body:{job_id:d.id}});if(_)throw _;r({title:"Ã‰xito",description:(i==null?void 0:i.message)||"Carpetas locales creadas exitosamente"})}catch(i){r({title:"Error",description:i.message||"Error al crear carpetas locales",variant:"destructive"})}finally{Pe(!1)}}},[d,r]),ua=s.useCallback(async()=>{ge(!0),ms(null),ds(null);try{const{data:i,error:_}=await g.functions.invoke("archive-to-flex",{body:{job_id:a,mode:Ve,include_templates:ns,dry_run:ls}});if(_)throw _;ds(i),r({title:ls?"Prueba completada":"Archivo completado",description:`${(i==null?void 0:i.uploaded)??0} subidos, ${(i==null?void 0:i.failed)??0} fallidos`}),!ls&&((i==null?void 0:i.uploaded)??0)>0&&Z()}catch(i){ms((i==null?void 0:i.message)||"Failed to archive"),r({title:"Error al archivar",description:(i==null?void 0:i.message)||"Error al archivar",variant:"destructive"})}finally{ge(!1)}},[a,Ve,ns,ls,r,Z]),ha=s.useCallback(async()=>{Rs(!0),Ss(null),qs(null);try{const i=[];Cs&&i.push("sound"),_s&&i.push("lights"),ks&&i.push("video"),Ds&&i.push("production");const _={job_id:a};i.length&&(_.departments=i);const M=[];us.trim()&&M.push({dept:"sound",element_id:us.trim()}),hs.trim()&&M.push({dept:"lights",element_id:hs.trim()}),xs.trim()&&M.push({dept:"video",element_id:xs.trim()}),ps.trim()&&M.push({dept:"production",element_id:ps.trim()}),M.length&&(_.manual=M);const{data:F,error:I}=await g.functions.invoke("backfill-flex-doc-tecnica",{body:_});if(I)throw I;qs(F),Ss(`Inserted ${(F==null?void 0:F.inserted)??0}, already ${(F==null?void 0:F.already)??0}`),r({title:"Relleno completado",description:`Insertados ${(F==null?void 0:F.inserted)??0}, ya existÃ­an ${(F==null?void 0:F.already)??0}`})}catch(i){Ss((i==null?void 0:i.message)||"Backfill failed"),r({title:"Error al rellenar",description:(i==null?void 0:i.message)||"Error al rellenar",variant:"destructive"})}finally{Rs(!1)}},[a,Cs,_s,ks,Ds,us,hs,xs,ps,r]),xa=s.useCallback(async()=>{try{fs(!0);const{error:i}=await g.functions.invoke("create-whatsapp-group",{body:{job_id:a}});if(i)throw i;r({title:"Ã‰xito",description:"Grupo de WhatsApp creado exitosamente"}),$s(!1)}catch(i){r({title:"Error",description:i.message||"Error al crear grupo de WhatsApp",variant:"destructive"})}finally{fs(!1)}},[a,r]),pa=s.useCallback(async()=>{try{fs(!0);const i=`He hecho cambios en el PS del ${(d==null?void 0:d.title)||"trabajo"} por favor echad un vistazo`,M=(Es||"").trim()||i,F=M.trim().toLowerCase()===i.trim().toLowerCase(),{error:I}=await g.functions.invoke("send-warehouse-message",{body:{message:M,job_id:a,highlight:F}});I?r({title:"Error al enviar",description:I.message,variant:"destructive"}):(r({title:"Enviado",description:"Mensaje enviado a AlmacÃ©n sonido."}),Us(!1))}catch(i){r({title:"Error",description:(i==null?void 0:i.message)||String(i),variant:"destructive"})}finally{fs(!1)}},[d==null?void 0:d.title,a,Es,r]),fa=s.useCallback(async()=>{if(a){Ws(!0);try{const{error:i}=await g.from("jobs").delete().eq("id",a);if(i)throw i;r({title:"Ã‰xito",description:"Trabajo eliminado exitosamente"}),o("/project-management")}catch(i){r({title:"Error",description:i.message||"Error al eliminar trabajo",variant:"destructive"})}finally{Ws(!1),Vs(!1)}}},[a,r,o]),ga=s.useCallback(i=>{const _=new URLSearchParams({jobId:a||""});o(`${i==="pesos"?"/sound/pesos":"/sound/consumos"}?${_.toString()}`)},[a,o]);return a?y?{status:"loading"}:d?{status:"ready",vm:{job:d,jobId:a,navigate:o,isSingleJobMode:k,isSchedulingRoute:ta,isArtistRoute:aa,isGearRoute:ra,canEdit:ia,isViewOnly:na,userRole:C,venueData:n,mapPreviewUrl:j,isMapLoading:x,isLoading:y,isLoadingDocuments:pe,artistCount:A,jobDates:b,maxStages:l,jobDocuments:ae,groupedRiderFiles:$t,assignmentDepartment:Oe,setAssignmentDepartment:Ye,departmentOptions:Vt,humanizeDepartment:Wt,handleRefreshAll:Yt,handleRefreshDocuments:qt,handleJobDocumentView:It,handleJobDocumentDownload:Ot,handleRiderView:zt,handleRiderDownload:Rt,formatDateLabel:Ut,isAssignmentDialogOpen:ze,setIsAssignmentDialogOpen:Ce,handleAssignmentChange:Jt,handleOpenAssignments:Bt,handleNavigateTimesheets:Ht,isRouteSheetOpen:Xe,setIsRouteSheetOpen:Ee,handleOpenRouteSheet:Gt,isJobDetailsOpen:es,setIsJobDetailsOpen:Ae,handleOpenJobDetails:Qt,isFlexLogOpen:ss,setIsFlexLogOpen:Me,handleOpenFlexLogs:Zt,flexUuid:h,isFlexLoading:O,flexError:R,folderExists:H,flexStatus:sa,isFlexPickerOpen:ts,setIsFlexPickerOpen:_e,flexPickerOptions:qe,handleFlexPickerConfirm:ea,handleOpenFlexPicker:Kt,handleCreateFlexFolders:Xt,isCreatingFlexFolders:Q,handleFlexClick:ca,isPrinting:P,handlePrintButtonClick:oa,isPrintDialogOpen:L,setIsPrintDialogOpen:v,handlePrintAllDocumentation:la,isJobPresetsOpen:$e,setIsJobPresetsOpen:ke,isArchiveDialogOpen:z,setIsArchiveDialogOpen:de,archiveMode:Ve,setArchiveMode:is,archiveIncludeTemplates:ns,setArchiveIncludeTemplates:U,archiveDryRun:ls,setArchiveDryRun:gt,isArchiving:fe,archiveResult:ys,archiveError:ws,handleArchiveToFlex:ua,isBackfillDialogOpen:jt,setIsBackfillDialogOpen:vt,bfSound:Cs,setBfSound:yt,bfLights:_s,setBfLights:wt,bfVideo:ks,setBfVideo:St,bfProduction:Ds,setBfProduction:Ct,uuidSound:us,setUuidSound:_t,uuidLights:hs,setUuidLights:kt,uuidVideo:xs,setUuidVideo:Dt,uuidProduction:ps,setUuidProduction:Et,isBackfilling:bt,backfillMessage:Nt,handleBackfill:ha,isWhatsappDialogOpen:At,setIsWhatsappDialogOpen:$s,isSendingWa:Tt,handleCreateWhatsappGroup:xa,isAlmacenDialogOpen:Mt,setIsAlmacenDialogOpen:Us,waMessage:Es,setWaMessage:Ft,handleSendToAlmacen:pa,isDeleteDialogOpen:Pt,setIsDeleteDialogOpen:Vs,isDeleting:Lt,handleDeleteJob:fa,handleDocumentUpload:da,isUploadingDocument:Ue,handleCreateLocalFolders:ma,isCreatingLocalFolders:rs,navigateToCalculator:ga}}:{status:"not_found"}:{status:"missing_job_id"}},Sl=()=>{const a=Tr();return a.status==="missing_job_id"?e.jsx("div",{children:"Se requiere ID del trabajo"}):a.status==="loading"?e.jsx("div",{children:"Cargando..."}):a.status==="not_found"?e.jsx("div",{children:"Festival no encontrado"}):e.jsx(Mr,{vm:a.vm})};export{Sl as default};
