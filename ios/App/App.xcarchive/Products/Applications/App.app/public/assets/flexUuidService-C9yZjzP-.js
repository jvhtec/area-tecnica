import{b as F,g as w,a as T}from"./config-DVV3VxR4.js";import{F as c}from"./constants-DoXhG9KB.js";import{s as u}from"./index-NZ6jJLfQ.js";const S={"fin-doc":"fin-doc","financial-document":"fin-doc","financial-doc":"fin-doc",presupuesto:"fin-doc","dryhire-fin-doc":"fin-doc","expense-sheet":"expense-sheet",expense:"expense-sheet","expense-list":"expense-sheet","expense-report":"expense-sheet","crew-call":"contact-list","contact-list":"contact-list","contact-list-element":"contact-list","equipment-list":"equipment-list",equipment:"equipment-list","equipment-schedule":"equipment-list","equipment-log":"equipment-list","remote-file-list":"remote-file-list","remote-files":"remote-file-list","file-list":"remote-file-list","file-library":"remote-file-list","simple-element":"simple-element","simple-project-element":"simple-element",folder:"simple-element","dryhire-folder":"simple-element","tourdate-folder":"simple-element"};function I(i){if(typeof i!="string")return null;const r=i.trim();return r&&r.replace(/([a-z0-9])([A-Z])/g,"$1-$2").replace(/[\s_]+/g,"-").toLowerCase()||null}function q(i){const r=I(i);return r?S[r]??null:null}const U=[c.hojaGastos],E=[c.presupuesto,c.presupuestoDryHire,c.hojaGastos,c.ordenCompra,c.ordenSubalquiler,c.ordenTrabajo],v=[c.crewCall],D=[c.pullSheet],j=[c.mainFolder,c.subFolder];function y(i){var t;if(!i)return"simple-element";if(i.viewHint&&i.viewHint!=="auto")return i.viewHint;const r=q(i.schemaId);if(r)return r;if(i.definitionId){if(U.includes(i.definitionId))return"expense-sheet";if(v.includes(i.definitionId))return"contact-list";if(D.includes(i.definitionId))return"equipment-list";if(E.includes(i.definitionId))return"fin-doc";if(j.includes(i.definitionId))return"simple-element"}const e=(t=i.domainId)==null?void 0:t.toLowerCase();if(e){if(e==="expense-sheet"||e==="expense"||e==="expense-list")return"expense-sheet";if(e==="fin-doc"||e==="financial-document"||e==="financial-doc"||e==="presupuesto")return"fin-doc";if(e==="crew-call"||e==="contact-list"||e==="contact-list-element")return"contact-list";if(e==="equipment-list"||e==="equipment"||e==="equipment-schedule")return"equipment-list";if(e==="remote-file-list"||e==="remote-files"||e==="file-list")return"remote-file-list"}return i.folderType==="dryhire"||i.folderType==="tourdate"||i.jobType==="dryhire"||i.jobType==="tourdate","simple-element"}function m(i,r,e){if(!r||typeof r!="string"||r.trim().length===0){const o=`Invalid elementId provided to buildFlexUrlByIntent: "${r}" (type: ${typeof r})`;throw new Error(o)}const t=F();switch(i){case"simple-element":return`${t}#element/${r}/view/simple-element/detail`;case"fin-doc":{const o=w("presupuesto");return`${t}#fin-doc/${r}/doc-view/${o}/detail`}case"expense-sheet":{const o=w("expenseSheet");return`${t}#fin-doc/${r}/doc-view/${o}/detail`}case"contact-list":{const o=w("crewCall");return`${t}#contact-list/${r}/view/${o}/detail`}case"equipment-list":return`${t}#element/${r}/view/equipment-list/detail`;case"remote-file-list":return`${t}#element/${r}/view/remote-file-list/detail`;default:return`${t}#element/${r}/view/simple-element/detail`}}async function N(i,r){var e,t,o,s,a;try{const l=T(),d=await fetch(`${l}/element/${i}/key-info/`,{method:"GET",headers:{"Content-Type":"application/json","X-Auth-Token":r,apikey:r}});if(!d.ok)return{elementId:i};const n=await d.json(),f=((e=n==null?void 0:n.elementDefinitionId)==null?void 0:e.data)||((t=n==null?void 0:n.definitionId)==null?void 0:t.data)||(n==null?void 0:n.definitionId),_=((o=n==null?void 0:n.name)==null?void 0:o.data)||((s=n==null?void 0:n.documentName)==null?void 0:s.data),p=(a=n==null?void 0:n.documentNumber)==null?void 0:a.data;return{elementId:i,definitionId:f,name:_,documentNumber:p}}catch{return{elementId:i}}}function h(i,r,e){const o=y({definitionId:r,domainId:e});if(!i||typeof i!="string"||i.trim().length===0){const s=`Invalid elementId provided to buildFlexUrl: "${i}" (type: ${typeof i})`;throw new Error(s)}try{return m(o,i)}catch(s){throw s}}async function $(i,r,e){var d;if(!i||typeof i!="string"||i.trim().length===0){const n=`Invalid elementId in buildFlexUrlWithTypeDetection: "${i}" (type: ${typeof i})`;throw new Error(n)}!r||typeof r!="string"||r.trim().length;const t=!!(e!=null&&e.definitionId),o=!!(e!=null&&e.viewHint&&e.viewHint!=="auto"),s=(e==null?void 0:e.folderType)==="dryhire"||(e==null?void 0:e.folderType)==="tourdate"||(e==null?void 0:e.jobType)==="dryhire"||(e==null?void 0:e.jobType)==="tourdate",a=(d=e==null?void 0:e.domainId)==null?void 0:d.toLowerCase();if(t||o||s||!!a&&(a==="fin-doc"||a==="financial-document"||a==="financial-doc"||a==="presupuesto"||a==="expense-sheet"||a==="expense"||a==="expense-list"||a==="crew-call"||a==="contact-list"||a==="contact-list-element"||a==="equipment-list"||a==="equipment"||a==="equipment-schedule"||a==="remote-file-list"||a==="remote-files"||a==="file-list")){const n=y(e);return m(n,i)}try{const n=await N(i,r);return h(i,n.definitionId)}catch{return h(i)}}function C(i){const{elementId:r,context:e}=i;if(!r||typeof r!="string"||r.trim().length===0)return null;try{const t=y(e);return m(t,r)}catch{return null}}async function k(i){var t;const{elementId:r,context:e}=i;if(!r||typeof r!="string"||r.trim().length===0)return null;try{const o=!!(e!=null&&e.definitionId),s=!!(e!=null&&e.viewHint&&e.viewHint!=="auto"),a=(e==null?void 0:e.folderType)==="dryhire"||(e==null?void 0:e.folderType)==="tourdate"||(e==null?void 0:e.jobType)==="dryhire"||(e==null?void 0:e.jobType)==="tourdate",l=(t=e==null?void 0:e.domainId)==null?void 0:t.toLowerCase(),d=!!l&&(l==="fin-doc"||l==="financial-document"||l==="financial-doc"||l==="presupuesto"||l==="expense-sheet"||l==="expense"||l==="expense-list"||l==="crew-call"||l==="contact-list"||l==="contact-list-element"||l==="equipment-list"||l==="equipment"||l==="equipment-schedule"||l==="remote-file-list"||l==="remote-files"||l==="file-list"),n=!!q(e==null?void 0:e.schemaId);if(o||s||a||d||n){const g=y(e);return m(g,r)}const{data:f,error:_}=await u.functions.invoke("get-secret",{body:{secretName:"X_AUTH_TOKEN"}});if(_)return h(r);const p=(f==null?void 0:f.X_AUTH_TOKEN)||"";return p?await $(r,p,e):h(r)}catch{try{return h(r)}catch{return null}}}async function x(i){const{elementId:r,context:e,onError:t,onWarning:o}=i;if(!r||typeof r!="string"||r.trim().length===0){const n=new Error(`Invalid element ID: "${r}". Cannot navigate to Flex without a valid element identifier.`);t&&t(n);return}const s=typeof(e==null?void 0:e.schemaId)=="string"&&e.schemaId.trim().length>0;if(!!(e!=null&&e.domainId||e!=null&&e.definitionId||e!=null&&e.viewHint&&e.viewHint!=="auto"||s))try{const n=C({elementId:r,context:e});if(n){window.open(n,"_blank","noopener,noreferrer");return}}catch{}let l=null,d=!1;try{if(l=window.open("","_blank"),l)try{l.opener=null,l.location.href="about:blank"}catch{}}catch{d=!0}(!l||d)&&(d=!0);try{const n=await k({elementId:r,context:e});if(!n||typeof n!="string"||n.trim().length===0){const f=m("simple-element",r);if(d){try{l&&l.close()}catch{}b(f)}else l.location.href=f;o&&o("Opened with fallback URL format (resolver failed)");return}if(d){try{l&&l.close()}catch{}b(n)}else l.location.href=n}catch(n){const f=m("simple-element",r);try{d?b(f):l.location.href=f,o&&o("Opened with fallback URL format (error occurred)")}catch{if(!d&&l)try{l.close()}catch{}t&&t(n instanceof Error?n:new Error("Unknown error during navigation"))}}}function b(i){const r=document.createElement("a");r.href=i,r.target="_blank",r.rel="noopener noreferrer",r.style.display="none",document.body.appendChild(r),r.click(),setTimeout(()=>{document.body.removeChild(r)},100)}class V{static async getFlexUuid(r,e){try{switch(await this.determineIdentifierType(r)){case"tour_date":return await this.getTourDateFlexUuidDirect(r,e);case"tour":return await this.getTourFlexUuid(r,e);case"job":return await this.getJobFlexUuid(r,e);default:return{uuid:null,error:"Unknown identifier type"}}}catch{return{uuid:null,error:"Failed to fetch flex UUID"}}}static async determineIdentifierType(r){const{data:e}=await u.from("tour_dates").select("id").eq("id",r).maybeSingle();if(e)return"tour_date";const{data:t}=await u.from("tours").select("id").eq("id",r).maybeSingle();if(t)return"tour";const{data:o}=await u.from("jobs").select("id").eq("id",r).maybeSingle();return o?"job":"unknown"}static async getTourFlexUuid(r,e){const{data:t,error:o}=await u.from("tours").select("flex_sound_folder_id, flex_lights_folder_id, flex_video_folder_id, flex_production_folder_id, flex_personnel_folder_id").eq("id",r).maybeSingle();if(o)return{uuid:null,error:"Failed to fetch tour data"};if(t){const a={sound:"flex_sound_folder_id",lights:"flex_lights_folder_id",video:"flex_video_folder_id",production:"flex_production_folder_id",personnel:"flex_personnel_folder_id"}[e];if(a&&t[a])return{uuid:t[a],error:null}}return await this.getTourFlexUuidFromJobs(r,e)}static async getTourFlexUuidFromJobs(r,e){const{data:t,error:o}=await u.from("jobs").select("id, start_time").eq("tour_id",r).order("start_time",{ascending:!0});if(o)return{uuid:null,error:"Failed to fetch tour jobs"};if(!t||t.length===0)return{uuid:null,error:"No jobs found in this tour"};for(const s of t){let{data:a,error:l}=await u.from("flex_folders").select("element_id").eq("job_id",s.id).eq("department",e).eq("folder_type","tourdate").maybeSingle();if(!l){if(a)return{uuid:a.element_id,error:null};if({data:a,error:l}=await u.from("flex_folders").select("element_id").eq("job_id",s.id).eq("department",e).eq("folder_type","department").maybeSingle(),!l){if(a)return{uuid:a.element_id,error:null};if({data:a,error:l}=await u.from("flex_folders").select("element_id").eq("job_id",s.id).eq("folder_type","job").maybeSingle(),!l&&a)return{uuid:a.element_id,error:null}}}}return{uuid:null,error:"No flex folders found for this tour"}}static async getJobFlexUuid(r,e){const t=await this.getJobData(r);if(!t)return{uuid:null,error:"Job not found"};switch(t.job_type){case"dryhire":return await this.getDryhireFlexUuid(t.id,e);case"tourdate":return t.tour_date_id?await this.getTourDateFlexUuidDirect(t.tour_date_id,e):await this.getTourDateFlexUuidByJob(t.id,e);default:return await this.getSingleJobFlexUuid(t.id,e)}}static async getJobData(r){const{data:e,error:t}=await u.from("jobs").select("id, job_type, tour_id, tour_date_id").eq("id",r).maybeSingle();return t?null:e}static async getTourDateFlexUuidDirect(r,e){let{data:t,error:o}=await u.from("flex_folders").select("element_id").eq("tour_date_id",r).eq("department",e).eq("folder_type","tourdate").maybeSingle();return o?{uuid:null,error:"Failed to fetch tourdate folder"}:t?{uuid:t.element_id,error:null}:({data:t,error:o}=await u.from("flex_folders").select("element_id").eq("tour_date_id",r).eq("department",e).eq("folder_type","tourdate_subfolder").maybeSingle(),o?{uuid:null,error:"Failed to fetch tourdate subfolder"}:t?{uuid:t.element_id,error:null}:{uuid:null,error:"Tourdate folder not found for this department"})}static async getDryhireFlexUuid(r,e){const{data:t,error:o}=await u.from("flex_folders").select("element_id").eq("job_id",r).eq("department",e).eq("folder_type","dryhire").maybeSingle();return o?{uuid:null,error:"Failed to fetch dryhire folder"}:t?{uuid:t.element_id,error:null}:{uuid:null,error:"Dryhire folder not found for this department"}}static async getTourDateFlexUuidByJob(r,e){let{data:t,error:o}=await u.from("flex_folders").select("element_id").eq("job_id",r).eq("department",e).eq("folder_type","tourdate").maybeSingle();return o?{uuid:null,error:"Failed to fetch tourdate folder"}:t?{uuid:t.element_id,error:null}:({data:t,error:o}=await u.from("flex_folders").select("element_id").eq("job_id",r).eq("department",e).eq("folder_type","tourdate_subfolder").maybeSingle(),o?{uuid:null,error:"Failed to fetch tourdate subfolder"}:t?{uuid:t.element_id,error:null}:{uuid:null,error:"Tourdate folder not found for this department"})}static async getSingleJobFlexUuid(r,e){let{data:t,error:o}=await u.from("flex_folders").select("element_id").eq("job_id",r).eq("department",e).eq("folder_type","department").maybeSingle();return t?{uuid:t.element_id,error:null}:({data:t,error:o}=await u.from("flex_folders").select("element_id").eq("job_id",r).eq("folder_type","job").maybeSingle(),t?{uuid:t.element_id,error:null}:{uuid:null,error:"Job folder not found for this department"})}}export{V as F,m as b,x as o};
