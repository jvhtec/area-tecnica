import{r as c,e as _,j as g,a as $,B as A,X as W,s as y,ag as S,ah as C,ai as B,aj as T,ak as q}from"./index-NZ6jJLfQ.js";import{A as K,b as M,a as R}from"./avatar-QSp4LpEt.js";import{C as G}from"./camera-DACJL5j2.js";const L={maxWidth:400,maxHeight:400,quality:.85,outputFormat:"image/webp"};async function Q(i,t={}){const n={...L,...t};return new Promise((u,f)=>{const p=new FileReader;p.onload=w=>{var h;const m=new Image;m.onload=()=>{try{let{width:r,height:s}=m;if(r>n.maxWidth||s>n.maxHeight){const l=r/s;r>s?(r=n.maxWidth,s=r/l):(s=n.maxHeight,r=s*l)}const a=document.createElement("canvas");a.width=r,a.height=s;const o=a.getContext("2d");if(!o){f(new Error("Failed to get canvas context"));return}o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.drawImage(m,0,0,r,s),a.toBlob(l=>{if(!l){f(new Error("Failed to create blob from canvas"));return}const E=n.outputFormat.split("/")[1],v=i.name.replace(/\.[^.]+$/,`.${E}`),P=new File([l],v,{type:n.outputFormat,lastModified:Date.now()});u(P)},n.outputFormat,n.quality)}catch(r){f(r)}},m.onerror=()=>{f(new Error("Failed to load image"))},m.src=(h=w.target)==null?void 0:h.result},p.onerror=()=>{f(new Error("Failed to read file"))},p.readAsDataURL(i)})}function V(i,t=5){if(!["image/jpeg","image/jpg","image/png","image/webp","image/gif"].includes(i.type))return{valid:!1,error:"Please select a valid image file (JPEG, PNG, WebP, or GIF)"};const u=t*1024*1024;return i.size>u?{valid:!1,error:`File size must be less than ${t}MB`}:{valid:!0}}function X(i){if(!i||typeof i!="string")throw new Error("Invalid userId: must be a non-empty string");const t=i.replace(/[^a-zA-Z0-9_-]/g,"");if(t.length===0)throw new Error("Invalid userId: contains only unsafe characters");if(t.startsWith(".")||t.startsWith("/")||t.startsWith("\\"))throw new Error("Invalid userId: cannot start with dots or path separators");return t}function Z(i,t){const n=X(i),u=Date.now(),f=t.split(".").pop()||"webp";return`${n}/profile-${u}.${f}`}function O(i,t){return`${i}/storage/v1/object/public/profile-pictures/${t}`}const J={sm:"h-16 w-16",md:"h-24 w-24",lg:"h-32 w-32",xl:"h-40 w-40"},D={sm:14,md:16,lg:20,xl:24};function re({userId:i,currentPictureUrl:t,userInitials:n,onUploadComplete:u,onRemove:f,size:p="lg",showCameraIcon:w=!0,className:m=""}){const[h,r]=c.useState(!1),[s,a]=c.useState(t||null),o=c.useRef(null),{toast:l}=_();c.useEffect(()=>{a(t||null)},[t]);const E=async e=>{var j;const d=(j=e.target.files)==null?void 0:j[0];if(!d)return;const b=V(d,5);if(!b.valid){l({title:"Invalid file",description:b.error,variant:"destructive"});return}r(!0);try{const x=await Q(d,{maxWidth:400,maxHeight:400,quality:.85,outputFormat:"image/webp"}),z=Z(i,x.name);if(s&&s.includes("/profile-pictures/")){const k=s.split("/profile-pictures/")[1];k&&await y.storage.from("profile-pictures").remove([k])}const{error:N}=await y.storage.from("profile-pictures").upload(z,x,{cacheControl:"3600",upsert:!0});if(N)throw N;const F=O("https://syldobdcdsgfgjtbuwxm.supabase.co",z),{error:U}=await y.from("profiles").update({profile_picture_url:F}).eq("id",i);if(U)throw U;a(F),l({title:"Success",description:"Profile picture updated successfully"}),u==null||u(F)}catch(x){l({title:"Upload failed",description:x instanceof Error?x.message:"Failed to upload profile picture",variant:"destructive"})}finally{r(!1),o.current&&(o.current.value="")}},v=async()=>{if(!(!s||!s.includes("/profile-pictures/"))){r(!0);try{const e=s.split("/profile-pictures/")[1];if(e){const{error:b}=await y.storage.from("profile-pictures").remove([e]);if(b)throw b}const{error:d}=await y.from("profiles").update({profile_picture_url:null}).eq("id",i);if(d)throw d;a(null),l({title:"Success",description:"Profile picture removed"}),f==null||f()}catch{l({title:"Error",description:"Failed to remove profile picture",variant:"destructive"})}finally{r(!1)}}},P=()=>{var e;(e=o.current)==null||e.click()};return g.jsxs("div",{className:`relative inline-block ${m}`,children:[g.jsxs(K,{className:J[p],children:[s?g.jsx(M,{src:s,alt:"Profile picture"}):null,g.jsx(R,{className:"text-lg font-semibold",children:n})]}),h&&g.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/50 rounded-full",children:g.jsx($,{className:"animate-spin text-white",size:D[p]})}),w&&!h&&g.jsx(A,{size:"icon",className:"absolute bottom-0 right-0 rounded-full shadow-lg h-8 w-8",onClick:P,disabled:h,children:g.jsx(G,{size:D[p]})}),s&&!h&&g.jsx(A,{size:"icon",variant:"destructive",className:"absolute top-0 right-0 rounded-full shadow-lg h-6 w-6",onClick:v,disabled:h,children:g.jsx(W,{size:12})}),g.jsx("input",{ref:o,type:"file",accept:"image/jpeg,image/jpg,image/png,image/webp,image/gif",onChange:E,className:"hidden"})]})}const H="BFD4f-C2H57bRgIv0FximD-TfH5n532QghezqfPMZHDvKoPZ2SngkdQSEQI8HEhloMfH5ntjXtdX40zKsgoGRIU",I=()=>"Push notifications are not supported in this browser.",Y=()=>"VITE_VAPID_PUBLIC_KEY is not configured. Ask an administrator to set it before enabling push notifications.",ae=()=>{const[i,t]=c.useState(null),[n,u]=c.useState(S()),[f,p]=c.useState(C()),[w,m]=c.useState(!1),[h,r]=c.useState(!1),[s,a]=c.useState(null),o=c.useMemo(()=>C(),[]),l=!!H;c.useEffect(()=>{let e=!1;return o?(l||a(Y()),(async()=>{p(!0);try{const b=await q();e||(t(b),u(S()))}catch(b){e||a(b instanceof Error?b.message:"Unable to load the existing push subscription.")}finally{e||p(!1)}})(),()=>{e=!0}):(a(I()),p(!1),()=>{e=!0})},[o,l]);const E=c.useCallback(async()=>{if(!o){const e=I();throw a(e),new Error(e)}m(!0),a(null);try{const e=await B(H);return u(S()),e&&t(e),e}catch(e){const d=e instanceof Error?e.message:"Unable to enable push notifications at this time.";throw a(d),e instanceof Error?e:new Error(d)}finally{m(!1)}},[o]),v=c.useCallback(async()=>{if(!o){const e=I();throw a(e),new Error(e)}r(!0),a(null);try{await T(),t(null),u(S())}catch(e){const d=e instanceof Error?e.message:"Unable to disable push notifications at this time.";throw a(d),e instanceof Error?e:new Error(d)}finally{r(!1)}},[o]);return{isSupported:o,permission:n,subscription:i,isInitializing:f,isEnabling:w,isDisabling:h,error:s,enable:E,disable:v,canEnable:o&&l&&!i&&n!=="denied"}};export{re as P,ae as u};
