import{b as L,a9 as W,u as X,f as G,c as H,r as c,m as g,j as o,X as U,n as Y}from"./index-NZ6jJLfQ.js";import{u as q}from"./useRealtimeQuery-DRd58t-I.js";import{u as Z}from"./useMobileRealtimeSubscriptions-CkyUxSWV.js";import{u as P}from"./useTourRateSubscriptions-Dd0aSU9f.js";import{g as ee}from"./roleCategory-BtQgWHfO.js";import{D as te,J as oe,A as re,P as ie,T as se,a as ae,S as le,O as de,b as ne,M as me,c as ce}from"./TechnicianTourRates-B53gy6bo.js";import{E as pe}from"./euro-DgRTeGAz.js";import{a as C}from"./addMonths-j-Bb577B.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./useQuery-kdg2pmgf.js";import"./useTableSubscription-Cu79jct8.js";import"./useSubscription-C3wu6ko-.js";import"./badge-vNTKF5RD.js";import"./logoUtils-D2o1jUVg.js";import"./logo-url-cache-eY6nfvu7.js";import"./ellipsis-vertical-zRAfIP3L.js";import"./calendar-_Cj_Sgy-.js";import"./file-text-igU140SQ.js";import"./chevron-right-Bn7Eu0F7.js";import"./user-E3OATBQk.js";import"./camera-DACJL5j2.js";import"./es-CSiFCUGj.js";import"./receipt-CWKVL4Rh.js";import"./map-BKqH24gv.js";import"./message-square-a2K2ewo9.js";import"./briefcase-BrpPecAy.js";import"./TechnicianIncidentReportDialog-Bb0qWmts.js";import"./index-vfKqQWY5.js";import"./pdf-libs-BqoGqu1a.js";import"./logo-service-SlbhM6-i.js";import"./jobDocumentsUpload-BaycvzFe.js";import"./clipboard-list-wtFE30Ps.js";import"./triangle-alert-D6qN0F8g.js";import"./save-z_re-Mcq.js";import"./lightbulb-BU2ctenD.js";import"./clock-BXPvTWvY.js";import"./endOfWeek-BYLwoWuZ.js";import"./startOfMonth-B5dVCv8B.js";import"./useMutation-DluhVBs1.js";import"./sheet-DFFfLazF.js";import"./scroll-area-BHjMXddA.js";import"./plus-C3JQqq7t.js";import"./chevron-left-rq2ui83a.js";import"./tree-palm-s3dDhxOJ.js";import"./endOfMonth-Byhxb84j.js";import"./eachDayOfInterval-CPmiA2bk.js";import"./isSameDay-m1OvdnsV.js";import"./avatar-QSp4LpEt.js";import"./usePushNotifications-DXTVLUyg.js";import"./phone-BlFwiuho.js";import"./bell-eCP3MIu-.js";import"./lock-Cr7oPkPT.js";import"./shield-DTqNciIb.js";import"./external-link-QJoXZ6ES.js";import"./user-x-CkJG0NMy.js";import"./log-out-ByMqfvmj.js";import"./alert-BqA-5jRM.js";import"./useTimesheets-C6aFxEBN.js";import"./ratesQueryKeys-DgMsgg6U.js";import"./useJobPayoutTotals-CXAavZS-.js";import"./useJobRatesApproval-DsfA8V9C.js";import"./circle-alert-LZYNzZ7F.js";import"./moon-Bp9lP4EQ.js";import"./circle-check-C0N48OpO.js";import"./useWeatherData-d0TEdKFc.js";import"./weatherApi-BatwQpQy.js";import"./places-restaurant-service-CakuSyx6.js";import"./eye-BE_DouVP.js";import"./download-C1rVE0-J.js";import"./utensils-Dv9wAVOh.js";import"./sparkles-BZkmCd_8.js";import"./DirectMessagesList-C-bJnXYG.js";import"./circle-check-big-CilmNGCn.js";import"./user-check-CYYJtyVp.js";import"./useTabVisibility-TU5j192j.js";import"./subscription-indicator-DAcdH7Ud.js";import"./formatDistanceToNow-Bbdi_GlK.js";import"./constructNow-u0VlpghF.js";import"./differenceInCalendarMonths-6exvViir.js";import"./wifi-C3_7SFyW.js";import"./send-Uvkx0r_O.js";import"./arrow-left-VpQwT4cv.js";import"./users-DMnpVLUq.js";import"./SoundVisionInteractiveMap-BcnXjj1l.js";import"./star-icpn3ybK.js";import"./filter-D0HnK7Nz.js";import"./search-D-OiWg8h.js";import"./useTourRatesApproval-CR_t91JW.js";import"./tourRateMath-BOmIkfWO.js";import"./info-CpCfiYD2.js";const be=s=>({bg:s?"bg-[#05070a]":"bg-slate-50",nav:s?"bg-[#0f1219] border-t border-[#1f232e]":"bg-white border-t border-slate-200",card:s?"bg-[#0f1219] border-[#1f232e]":"bg-white border-slate-200 shadow-sm",textMain:s?"text-white":"text-slate-900",textMuted:s?"text-[#94a3b8]":"text-slate-500",accent:"bg-blue-600 hover:bg-blue-500 text-white",input:s?"bg-[#0a0c10] border-[#2a2e3b] text-white focus:border-blue-500":"bg-white border-slate-300 text-slate-900 focus:border-blue-500",modalOverlay:s?"bg-black/90 backdrop-blur-md":"bg-slate-900/40 backdrop-blur-md",divider:s?"border-[#1f232e]":"border-slate-100",danger:s?"text-red-400 bg-red-500/10 border-red-500/20":"text-red-700 bg-red-50 border-red-200",success:s?"text-emerald-400 bg-emerald-500/10 border-emerald-500/20":"text-emerald-700 bg-emerald-50 border-emerald-200",warning:s?"text-amber-400 bg-amber-500/10 border-amber-500/20":"text-amber-700 bg-amber-50 border-amber-200",cluster:s?"bg-white text-black":"bg-slate-900 text-white"}),Zt=()=>{const[s]=L(),b=s.get("tab")||"dashboard",{theme:w,setTheme:I}=W(),{user:t,hasSoundVisionAccess:v}=X();G(),H();const a=w==="dark"||w==="system"&&typeof window<"u"&&window.matchMedia("(prefers-color-scheme: dark)").matches,R=()=>{I(a?"light":"dark")},[_,p]=c.useState(null),[u,S]=c.useState(null),[V,x]=c.useState(!1),[y,M]=c.useState(null),[J,O]=c.useState(!1),[z,T]=c.useState(!1),E=c.useMemo(()=>["assignments-technician-dashboard"],[]);Z(),P();const{data:l}=q(["user-profile",t==null?void 0:t.id],async()=>{if(!(t!=null&&t.id))return null;const{data:n,error:d}=await g.from("profiles").select("first_name, last_name, nickname, phone, residencia, dni, bg_color, profile_picture_url, role, department").eq("id",t.id).single();if(d)throw d;return n},"profiles",{enabled:!!(t!=null&&t.id)}),{data:j=[],isLoading:A}=q(E,async()=>{if(!(t!=null&&t.id))return[];const n=C(new Date,-3),d=C(new Date,3),{data:m,error:h}=await g.from("job_assignments").select("job_id, sound_role, lights_role, video_role, status, assigned_at").eq("technician_id",t.id).eq("status","confirmed");if(h)return Y.error("Error loading assignment roles"),[];if(!m||m.length===0)return[];const D=new Map(m.map(i=>[i.job_id,i])),F=Array.from(new Set(m.map(i=>i.job_id))),{data:k,error:B}=await g.from("timesheets").select(`
          job_id,
          technician_id,
          date,
          jobs!inner (
            id,
            title,
            description,
            start_time,
            end_time,
            timezone,
            location_id,
            job_type,
            color,
            status,
            location:locations(name),
            job_documents(
              id,
              file_name,
              file_path,
              visible_to_tech,
              visible_to_tech,
              uploaded_at,
              read_only,
              template_type
            )
          )
        `).eq("technician_id",t.id).eq("is_active",!0).in("job_id",F).gte("jobs.start_time",n.toISOString()).lte("jobs.start_time",d.toISOString()).order("start_time",{referencedTable:"jobs"});if(B)return[];const $=new Set;return(k||[]).filter(i=>$.has(i.job_id)?!1:($.add(i.job_id),!0)).filter(i=>i.jobs).map(i=>{let f="unknown";const e=D.get(i.job_id);e!=null&&e.sound_role?f="sound":e!=null&&e.lights_role?f="lights":e!=null&&e.video_role&&(f="video");const K=ee({sound_role:e==null?void 0:e.sound_role,lights_role:e==null?void 0:e.lights_role,video_role:e==null?void 0:e.video_role});return{id:`job-${i.job_id}`,job_id:i.job_id,technician_id:i.technician_id,department:f,role:(e==null?void 0:e.sound_role)||(e==null?void 0:e.lights_role)||(e==null?void 0:e.video_role)||"Assigned",category:K,sound_role:e==null?void 0:e.sound_role,lights_role:e==null?void 0:e.lights_role,video_role:e==null?void 0:e.video_role,jobs:i.jobs}})},"timesheets",{refetchOnWindowFocus:!0,refetchOnMount:!0,staleTime:1e3*60*2,gcTime:1e3*60*5}),r=be(a),N=(n,d)=>{S(d||null),p(n)},Q=l!=null&&l.first_name&&(l!=null&&l.last_name)?`${l.first_name} ${l.last_name}`:(t==null?void 0:t.email)||"TÃ©cnico";return o.jsxs("div",{className:`min-h-screen flex flex-col ${r.bg} transition-colors duration-300 font-sans`,children:[o.jsxs("div",{className:"flex-1 overflow-y-auto p-1 pb-24",children:[b==="dashboard"&&o.jsx(te,{theme:r,isDark:a,user:t,userProfile:l,assignments:j,isLoading:A,onOpenAction:N,onOpenSV:()=>p("soundvision"),onOpenObliqueStrategy:()=>x(!0),onOpenTour:n=>M(n),onOpenRates:()=>O(!0),onOpenMessages:()=>T(!0),hasSoundVisionAccess:v}),b==="jobs"&&o.jsx(oe,{theme:r,isDark:a,assignments:j,isLoading:A,onOpenAction:N,techName:Q,onOpenObliqueStrategy:()=>x(!0)}),b==="availability"&&o.jsx(re,{theme:r,isDark:a}),b==="profile"&&o.jsx(ie,{theme:r,isDark:a,user:t,userProfile:l,toggleTheme:R})]}),_==="timesheet"&&u&&o.jsx(se,{theme:r,isDark:a,job:u,onClose:()=>p(null),userRole:(l==null?void 0:l.role)||null,userId:(t==null?void 0:t.id)||null}),_==="details"&&u&&o.jsx(ae,{theme:r,isDark:a,job:u,onClose:()=>p(null)}),_==="soundvision"&&v&&o.jsx(le,{theme:r,isDark:a,onClose:()=>p(null)}),V&&o.jsx(de,{theme:r,isDark:a,onClose:()=>x(!1)}),J&&o.jsx("div",{className:`fixed inset-0 z-[70] flex items-center justify-center ${r.modalOverlay} p-4 animate-in fade-in duration-200`,children:o.jsxs("div",{className:`w-full max-w-2xl max-h-[90vh] ${a?"bg-[#0f1219]":"bg-white"} rounded-2xl border ${r.divider} shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200 flex flex-col`,children:[o.jsxs("div",{className:`p-4 border-b ${r.divider} flex justify-between items-center shrink-0`,children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("div",{className:"p-2 rounded-lg bg-emerald-500 text-white",children:o.jsx(pe,{size:18})}),o.jsx("h2",{className:`text-lg font-bold ${r.textMain}`,children:"Mis tarifas"})]}),o.jsx("button",{onClick:()=>O(!1),className:`p-2 ${r.textMuted} hover:${r.textMain} rounded-full transition-colors`,children:o.jsx(U,{size:20})})]}),o.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:o.jsx(ne,{theme:r,isDark:a})})]})}),z&&o.jsx(me,{theme:r,isDark:a,userProfile:l,onClose:()=>T(!1)}),y&&o.jsx(ce,{tourId:y,theme:r,isDark:a,onClose:()=>M(null),onOpenJob:n=>{const d=j.find(m=>{var h;return m.job_id===n||((h=m.jobs)==null?void 0:h.id)===n});d!=null&&d.jobs&&(S(d.jobs),p("details"))}})]})};export{Zt as default};
