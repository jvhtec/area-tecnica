import{l as X,e as Q,r as p,j as e,C as ee,W as se,Y as te,A as ae,L as u,S as oe,t as ie,v as ne,w as le,x as re,ac as ce,B as $,U as A,X as de,I as U,i as H}from"./index-NZ6jJLfQ.js";import{C as me}from"./checkbox-BsRNEGV1.js";import{u as xe}from"./useJobSelection-B9iLNF5-.js";import{S as ge}from"./scroll-area-BHjMXddA.js";import{fetchJobLogo as he}from"./logoUtils-D2o1jUVg.js";import{R as ue,a as z}from"./radio-group-DzKNHD24.js";import{l as pe}from"./lazyPdf-xVUlxKNu.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./useQuery-kdg2pmgf.js";import"./logo-url-cache-eY6nfvu7.js";import"./index-hC3MxXep.js";import"./circle-CWxDyDxx.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=X("FolderOpen",[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]]),F=[{pageNumber:1,title:"EQUIPAMIENTO",type:"text"},{pageNumber:2,title:"SPL(A) Broadband",hasIsoView:!0},{pageNumber:3,title:"SPL(Z) 250-16k",hasIsoView:!0},{pageNumber:4,title:"SUBS SPL(Z) 32-80Hz",hasIsoView:!1}],we={ISO_A:{section:"SPL(A) Broadband",view:"ISO View"},TOP_A:{section:"SPL(A) Broadband",view:"Top View"},ISO_C:{section:"SPL(Z) 250-16k",view:"ISO View"},TOP_C:{section:"SPL(Z) 250-16k",view:"Top View"},SUB:{section:"SUBS SPL(Z) 32-80Hz",view:"Top View"}},Oe=()=>{const{toast:S}=Q(),{data:j}=xe(),[N,D]=p.useState(""),[v,W]=p.useState("LA"),[O,B]=p.useState(""),[w,P]=p.useState({}),[I,C]=p.useState({}),[T,L]=p.useState(void 0),[y,E]=p.useState(null),[G,R]=p.useState(!1);p.useEffect(()=>{(async()=>{if(N)try{const a=await he(N);L(a)}catch{L(void 0)}else L(void 0)})()},[N]);const k=(s,a,d)=>{const l=`${s}-${a}`;P(t=>({...t,[l]:d}))},J=s=>{C(a=>({...a,[s]:!a[s]}))},q=async s=>{const a=s.target.files;if(!a||a.length===0)return;const d=[],l=[],t={...w},o={...I};Object.entries(we).forEach(([r,c])=>{const g=Array.from(a).find(m=>m.name.toLowerCase().split(".")[0]===r.toLowerCase());if(g){d.push({filename:g.name,section:c.section,view:c.view});const m=`${c.section}-${c.view}`;t[m]=g,c.view==="ISO View"&&(o[c.section]=!0)}else l.push({filename:`${r}.png`,section:c.section,view:c.view})}),P(t),C(o),E({found:d,missing:l}),R(!0),S({title:"Auto-mapping Complete",description:`Found ${d.length} files, ${l.length} missing`}),s.target.value=""},K=()=>{P({}),C({}),E(null),R(!1),S({title:"Mapping Cleared",description:"All auto-mapped files have been cleared"})},M=async(s,a,d,l)=>new Promise(t=>{const o=s.internal.pageSize.getWidth(),r=v==="LA"?"/lovable-uploads/a2246e0e-373b-4091-9471-1a7c00fe82ed.png":"/lovable-uploads/e78ab52e-aa81-4770-a6bb-f802a5ff651e.png";s.setFillColor(125,1,1),s.rect(0,0,o,40,"F"),s.setTextColor(255,255,255),s.setFontSize(24);const c=v==="LA"?"SOUNDVISION REPORT":"EASE FOCUS REPORT";s.text(c,o/2,15,{align:"center"}),s.setFontSize(14),s.text(d,o/2,25,{align:"center"}),s.text(l,o/2,33,{align:"center"}),s.setFontSize(12),s.text(a.toString(),o-10,15,{align:"right"});const g=[];T&&g.push(new Promise(m=>{const i=new Image;i.crossOrigin="anonymous",i.src=T,i.onload=()=>{const n=7.5*(i.width/i.height),x=10,f=5;try{s.addImage(i,"PNG",x,f,n,7.5)}catch{}m()},i.onerror=()=>{m()}})),g.push(new Promise(m=>{const i=new Image;i.crossOrigin="anonymous",i.src=r,i.onload=()=>{const n=30*(i.height/i.width),x=o-30-10,f=5;try{s.addImage(i,"PNG",x,f,30,n)}catch{}m()},i.onerror=()=>{m()}})),Promise.all(g).then(()=>t())}),Y=async()=>{if(!N){S({title:"Error",description:"Please select a job before generating the report.",variant:"destructive"});return}const s=j==null?void 0:j.find(n=>n.id===N),a=(s==null?void 0:s.title)||"Unnamed_Job",d=s!=null&&s.start_time?H(new Date(s.start_time),"MMMM dd, yyyy"):H(new Date,"MMMM dd, yyyy"),l=await pe(),t=new l({orientation:"portrait",unit:"mm",format:"a4"}),o=20,r=t.internal.pageSize.getWidth(),c=t.internal.pageSize.getHeight(),g=r-2*o;await M(t,1,a,d),t.setFontSize(14),t.setTextColor(51,51,51),t.setFont(void 0,"bold"),t.text("EQUIPAMIENTO:",o,o+45),t.setFont(void 0,"normal");const m=O.split(`
`).filter(n=>n.trim());let i=o+55;m.forEach(n=>{t.setFontSize(11),t.text(n.trim(),o,i),i+=7}),t.setFontSize(9),t.text("ALL PLOTS CALCULATED FOR 15¬∫ C / 70% REL HUMIDITY @ 0dbU INPUT LEVEL",o,i+10);for(let n=1;n<F.length;n++){const x=F[n];t.addPage(),await M(t,x.pageNumber,a,d),t.setFontSize(14),t.setFont(void 0,"bold"),t.setTextColor(51,51,51),t.text(x.title,o,50),t.setFont(void 0,"normal");const f=`${x.title}-Top View`;if(w[f]&&await _(t,w[f],"Top View",o,60,g),x.hasIsoView&&I[x.title]){const b=`${x.title}-ISO View`;w[b]&&await _(t,w[b],"ISO View",o,160,g)}}const h=new Image;h.crossOrigin="anonymous",h.src="/lovable-uploads/ce3ff31a-4cc5-43c8-b5bb-a4056d3735e4.png",h.onload=()=>{t.setPage(t.getNumberOfPages());const n=50,x=n*(h.height/h.width),f=(r-n)/2,b=c-20;try{t.addImage(h,"PNG",f,b-x,n,x);const Z=t.output("blob"),V=`${v==="LA"?"SoundVision":"EaseFocus"}_Report_${a.replace(/\s+/g,"_")}.pdf`;t.save(V),S({title:"Success",description:"Report generated successfully"})}catch{t.output("blob");const V=`${v==="LA"?"SoundVision":"EaseFocus"}_Report_${a.replace(/\s+/g,"_")}.pdf`;t.save(V),S({title:"Success",description:"Report generated successfully (without logo)"})}},h.onerror=()=>{const n=`${v==="LA"?"SoundVision":"EaseFocus"}_Report_${a.replace(/\s+/g,"_")}.pdf`;t.save(n),S({title:"Success",description:"Report generated successfully (without logo)"})}},_=async(s,a,d,l,t,o)=>new Promise(r=>{const c=new FileReader;c.onload=g=>{var h;const m=(h=g.target)==null?void 0:h.result,i=o*.6;s.addImage(m,"JPEG",l,t,o,i),r()},c.readAsDataURL(a)});return e.jsxs(ee,{className:"w-full max-w-4xl mx-auto my-6",children:[e.jsx(se,{className:"space-y-1",children:e.jsx(te,{className:"text-2xl font-bold text-center",children:"SoundVision Report Generator"})}),e.jsx(ae,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"jobSelect",children:"Job"}),e.jsxs(oe,{value:N,onValueChange:D,children:[e.jsx(ie,{className:"w-full",children:e.jsx(ne,{placeholder:"Select a job"})}),e.jsx(le,{children:j==null?void 0:j.map(s=>e.jsx(re,{value:s.id,children:s.title},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{className:"mb-2",children:"Report System"}),e.jsxs(ue,{value:v,onValueChange:s=>W(s),className:"flex flex-col sm:flex-row sm:items-center gap-4 sm:gap-6",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(z,{value:"LA",id:"r-la"}),e.jsx(u,{htmlFor:"r-la",className:"cursor-pointer",children:"L'Acoustics"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(z,{value:"Turbo",id:"r-turbo"}),e.jsx(u,{htmlFor:"r-turbo",className:"cursor-pointer",children:"Turbosound"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"equipamiento",children:"Equipment List"}),e.jsx(ce,{id:"equipamiento",value:O,onChange:s=>B(s.target.value),placeholder:`24 L'ACOUSTICS K1 (MAIN ARRAYS)
06 L'ACOUSTICS KARA (DOWNFILLS)`,className:"min-h-[96px] bg-background text-foreground"})]}),e.jsxs("div",{className:"space-y-3 p-4 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[e.jsx(u,{className:"text-sm font-medium",children:"Auto-map Images from Folder"}),y&&e.jsx($,{variant:"outline",size:"sm",onClick:K,className:"text-xs w-full sm:w-auto",children:"Clear Mapping"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{htmlFor:"folderSelect",className:"cursor-pointer flex-1 sm:flex-initial",children:e.jsxs("div",{className:"flex items-center justify-center sm:justify-start gap-2 px-3 py-2 border rounded-md hover:bg-background transition-colors",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:"Select Folder"})]})}),e.jsx("input",{id:"folderSelect",type:"file",webkitdirectory:"",multiple:!0,onChange:q,className:"hidden"})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Expected files: ISO_A.png, TOP_A.png, ISO_C.png, TOP_C.png, SUB.png"}),G&&y&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{className:"text-xs font-medium",children:"Mapping Results:"}),e.jsx(ge,{className:"max-h-48",children:e.jsxs("div",{className:"space-y-1 pr-4",children:[y.found.map((s,a)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(A,{className:"h-3 w-3 text-green-600 flex-shrink-0"}),e.jsx("span",{className:"font-mono text-xs break-all",children:s.filename}),e.jsx("span",{className:"text-muted-foreground flex-shrink-0",children:"‚Üí"}),e.jsxs("span",{className:"text-xs",children:[s.section," (",s.view,")"]})]},a)),y.missing.map((s,a)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(de,{className:"h-3 w-3 text-red-600 flex-shrink-0"}),e.jsx("span",{className:"font-mono text-muted-foreground text-xs break-all",children:s.filename}),e.jsx("span",{className:"text-muted-foreground flex-shrink-0",children:"‚Üí"}),e.jsxs("span",{className:"text-muted-foreground text-xs",children:[s.section," (",s.view,")"]})]},a))]})})]})]}),e.jsx("div",{className:"space-y-4",children:F.slice(1).map(s=>{const a=`${s.title}-Top View`,d=`${s.title}-ISO View`,l=w[a],t=w[d];return e.jsxs("div",{className:"border rounded-lg p-4 bg-muted/30",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3",children:[e.jsx(u,{className:"text-sm font-medium",children:s.title}),s.hasIsoView&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(me,{id:`iso-${s.title}`,checked:I[s.title],onCheckedChange:()=>J(s.title)}),e.jsx(u,{htmlFor:`iso-${s.title}`,className:"text-xs cursor-pointer",children:"Include ISO View"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{className:"text-xs font-medium",children:"Top View"}),l&&e.jsx(A,{className:"h-3 w-3 text-green-600"})]}),e.jsx(U,{type:"file",accept:"image/*",onChange:o=>{var r;return k(s.title,"Top View",((r=o.target.files)==null?void 0:r[0])||null)},className:"text-sm"}),l&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["üìÅ ",l.name]})]}),s.hasIsoView&&I[s.title]&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{className:"text-xs font-medium",children:"ISO View"}),t&&e.jsx(A,{className:"h-3 w-3 text-green-600"})]}),e.jsx(U,{type:"file",accept:"image/*",onChange:o=>{var r;return k(s.title,"ISO View",((r=o.target.files)==null?void 0:r[0])||null)},className:"text-sm"}),t&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["üìÅ ",t.name]})]})]})]},s.title)})}),e.jsx("div",{className:"flex flex-col sm:flex-row gap-2",children:e.jsx($,{onClick:Y,className:"w-full",children:"Generate Report"})})]})})]})};export{Oe as ReportGenerator};
