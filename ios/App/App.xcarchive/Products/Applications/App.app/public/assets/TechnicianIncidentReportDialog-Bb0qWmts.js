import{r as j,j as t,X as y,I as D,ac as M,B as v,a as z,U as k,n as T}from"./index-NZ6jJLfQ.js";import{P as F,S as O}from"./index-vfKqQWY5.js";import{P as A,L as q}from"./logo-service-SlbhM6-i.js";import{uploadJobPdfWithCleanup as G}from"./jobDocumentsUpload-BaycvzFe.js";import{C as L}from"./clipboard-list-wtFE30Ps.js";import{T as B}from"./triangle-alert-D6qN0F8g.js";import{S as W}from"./save-z_re-Mcq.js";const _=async(r,h={saveToDatabase:!1,downloadLocal:!0})=>{const e=new A,{width:o,height:N}=e.dimensions;let i=null;try{i=await q.loadJobLogo(r.jobId)}catch{}if(e.setFillColor(125,1,1),e.addRect(0,0,o,50,"F"),i)try{const n=new Image;n.src=i;const f=30,S=f*(n.width/n.height)||60;e.addImage(i,"PNG",15,10,S,f)}catch{}e.setText(18,[255,255,255]),e.addText("REPORTE DE INCIDENCIA",o/2,20,{align:"center"}),e.setText(12,[255,255,255]),e.addText("DEPARTAMENTO DE SONIDO",o/2,35,{align:"center"});let a=70;e.setText(10,[0,0,0]);const b=new Date,m=b.toLocaleDateString("es-ES"),d=b.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"});e.addText(`Fecha de creación: ${m} - ${d}`,20,a),a+=20,e.setText(14,[125,1,1]),e.addText("INFORMACIÓN DEL TRABAJO",20,a),a+=15,e.addTable({startY:a,head:[["Campo","Valor"]],body:[["Trabajo",r.jobTitle],["Fecha de inicio",new Date(r.jobStartDate).toLocaleDateString("es-ES")],["Fecha de fin",new Date(r.jobEndDate).toLocaleDateString("es-ES")]],margin:{left:20,right:20},styles:{fontSize:10,cellPadding:5},headStyles:{fillColor:[125,1,1],textColor:[255,255,255],fontSize:11,fontStyle:"bold"},alternateRowStyles:{fillColor:[248,249,250]}}),a=e.getLastAutoTableY()+20,e.setText(14,[125,1,1]),e.addText("INFORMACIÓN DEL EQUIPO",20,a),a+=15,e.addTable({startY:a,head:[["Campo","Valor"]],body:[["Marca",r.brand],["Modelo",r.equipmentModel]],margin:{left:20,right:20},styles:{fontSize:10,cellPadding:5},headStyles:{fillColor:[125,1,1],textColor:[255,255,255],fontSize:11,fontStyle:"bold"},alternateRowStyles:{fillColor:[248,249,250]}}),a=e.getLastAutoTableY()+20,e.setText(14,[125,1,1]),e.addText("DESCRIPCIÓN DE LA INCIDENCIA",20,a),a+=15,e.setFillColor(248,249,250);const x=Math.max(40,Math.ceil(r.issue.length/80)*6);e.addRect(20,a-5,o-40,x,"F"),e.document.setDrawColor(200,200,200),e.document.setLineWidth(.5),e.document.rect(20,a-5,o-40,x),e.setText(10,[0,0,0]);const C=e.document.splitTextToSize(r.issue,o-50);e.document.text(C,25,a+5),a+=x+15,a=e.checkPageBreak(a,60),e.setText(14,[125,1,1]),e.addText("ACCIONES REALIZADAS",20,a),a+=15,e.setFillColor(248,249,250);const c=Math.max(40,Math.ceil(r.actionsTaken.length/80)*6);e.addRect(20,a-5,o-40,c,"F"),e.document.setDrawColor(200,200,200),e.document.setLineWidth(.5),e.document.rect(20,a-5,o-40,c),e.setText(10,[0,0,0]);const p=e.document.splitTextToSize(r.actionsTaken,o-50);if(e.document.text(p,25,a+5),a+=c+20,a=e.checkPageBreak(a,80),e.setText(14,[125,1,1]),e.addText("FIRMA DEL TÉCNICO",20,a),a+=15,e.setText(12,[0,0,0]),e.addText(`Técnico: ${r.techName}`,20,a),a+=15,r.signature)try{e.document.setDrawColor(200,200,200),e.document.setLineWidth(.5),e.document.rect(20,a-5,150,50),e.addImage(r.signature,"PNG",25,a,140,40),a+=55}catch{e.setText(10,[0,0,0]),e.addText("Firmado digitalmente",25,a+20),a+=30}e.setText(10,[100,100,100]),e.addText(`Fecha y hora de firma: ${m} ${d}`,20,a+10);const g=N-30;e.document.setDrawColor(125,1,1),e.document.setLineWidth(1),e.document.line(20,g,o-20,g),e.setText(8,[100,100,100]),e.addText("Reporte generado automáticamente por Sector Pro",o/2,g+10,{align:"center"});const u=r.jobTitle.replace(/[^\w\s-]/g,"").replace(/\s+/g,"_");b.toISOString().split("T")[0];const I=b.toISOString().replace(/[:.]/g,"-"),s=`reporte_incidencia_${u}_${I}.pdf`;if(h.saveToDatabase){const n=e.document.output("blob");try{return await G(r.jobId,n,s,"incident-reports"),h.downloadLocal&&e.save(s),{filename:s}}catch(f){throw f}}else return e.save(s),{filename:s}},X=({job:r,techName:h,className:e="",labeled:o=!1,theme:N,isDark:i=!1})=>{const a=(h==null?void 0:h.trim())||"Técnico desconocido",[b,m]=j.useState(!1),[d,x]=j.useState({equipmentModel:"",brand:"",issue:"",actionsTaken:"",signature:""}),[C,c]=j.useState(!1),[p,g]=j.useState(!1),u=j.useRef(null),s=N||{textMain:i?"text-white":"text-slate-900",textMuted:i?"text-[#94a3b8]":"text-slate-500",accent:"bg-blue-600 hover:bg-blue-500 text-white",input:i?"bg-[#0a0c10] border-[#2a2e3b] text-white focus:border-blue-500":"bg-white border-slate-300 text-slate-900 focus:border-blue-500",modalOverlay:i?"bg-black/90 backdrop-blur-md":"bg-slate-900/40 backdrop-blur-md",divider:i?"border-[#1f232e]":"border-slate-100"},n=(l,w)=>{x($=>({...$,[l]:w}))},f=()=>{if(!u.current)return;const l=u.current.toDataURL();x(w=>({...w,signature:l})),c(!1),T.success("Firma guardada correctamente")},S=()=>{u.current&&u.current.clear()},R=()=>{x({equipmentModel:"",brand:"",issue:"",actionsTaken:"",signature:""})},E=()=>["equipmentModel","brand","issue","actionsTaken"].filter($=>!d[$].trim()).length>0?(T.error("Por favor, complete todos los campos requeridos"),!1):d.signature?!0:(T.error("Por favor, proporcione su firma digital"),!1),P=async()=>{if(E()){g(!0);try{await _({jobId:r.id,jobTitle:r.title,jobStartDate:r.start_time,jobEndDate:r.end_time,...d,techName:a},{saveToDatabase:!0,downloadLocal:!0}),T.success("Reporte generado y guardado correctamente"),R(),m(!1)}catch{T.error("Hubo un problema al generar el reporte")}finally{g(!1)}}};return t.jsxs(t.Fragment,{children:[t.jsx("div",{onClick:()=>m(!0),children:o?t.jsxs("button",{className:`py-2.5 rounded-lg border border-dashed ${s.divider} ${s.textMuted} text-xs font-bold hover:bg-white/5 transition-colors flex items-center justify-center gap-2 w-full ${e}`,children:[t.jsx(L,{size:14})," Reportar incidencia"]}):t.jsx("button",{className:`p-2 rounded-lg border ${s.divider} ${s.textMuted} hover:bg-white/5 transition-colors ${e}`,title:"Crear reporte de incidencia",children:t.jsx(L,{size:16})})}),b&&t.jsx("div",{className:`fixed inset-0 z-[70] flex items-center justify-center ${s.modalOverlay} p-4 animate-in fade-in duration-200`,children:t.jsxs("div",{className:`w-full max-w-2xl max-h-[90vh] ${i?"bg-[#0f1219]":"bg-white"} rounded-2xl border ${s.divider} shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200 flex flex-col`,children:[t.jsxs("div",{className:`p-4 border-b ${s.divider} flex justify-between items-center shrink-0`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"p-2 rounded-lg bg-red-500/10 text-red-500",children:t.jsx(B,{size:18})}),t.jsxs("div",{children:[t.jsx("h2",{className:`text-lg font-bold ${s.textMain}`,children:"Reporte de Incidencia"}),t.jsx("p",{className:`text-xs ${s.textMuted}`,children:r.title})]})]}),t.jsx("button",{onClick:()=>m(!1),className:`p-2 ${s.textMuted} hover:${s.textMain} rounded-full transition-colors`,children:t.jsx(y,{size:20})})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-5 space-y-5",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:`text-xs font-bold mb-1.5 block ml-1 ${s.textMuted}`,children:"Modelo de Equipo *"}),t.jsx(D,{value:d.equipmentModel,onChange:l=>n("equipmentModel",l.target.value),placeholder:"ej. QSC K12.2",className:s.input})]}),t.jsxs("div",{children:[t.jsx("label",{className:`text-xs font-bold mb-1.5 block ml-1 ${s.textMuted}`,children:"Marca *"}),t.jsx(D,{value:d.brand,onChange:l=>n("brand",l.target.value),placeholder:"ej. QSC",className:s.input})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:`text-xs font-bold mb-1.5 block ml-1 ${s.textMuted}`,children:"Descripción de la Incidencia *"}),t.jsx(M,{value:d.issue,onChange:l=>n("issue",l.target.value),placeholder:"Describa detalladamente la incidencia ocurrida...",rows:4,className:`${s.input} resize-none`})]}),t.jsxs("div",{children:[t.jsx("label",{className:`text-xs font-bold mb-1.5 block ml-1 ${s.textMuted}`,children:"Acciones Realizadas *"}),t.jsx(M,{value:d.actionsTaken,onChange:l=>n("actionsTaken",l.target.value),placeholder:"Describa las acciones realizadas para solucionar la incidencia...",rows:4,className:`${s.input} resize-none`})]}),t.jsxs("div",{children:[t.jsx("label",{className:`text-xs font-bold mb-1.5 block ml-1 ${s.textMuted}`,children:"Firma del Técnico *"}),d.signature?t.jsxs("div",{className:`border rounded-xl p-4 ${i?"bg-white/5":"bg-slate-50"} border-dashed ${s.divider} flex flex-col items-center`,children:[t.jsx("img",{src:d.signature,alt:"Firma",width:320,height:80,loading:"lazy",decoding:"async",className:`w-80 max-w-xs h-20 object-contain mb-3 ${i?"filter invert":""}`}),t.jsxs(v,{variant:"outline",size:"sm",onClick:()=>c(!0),className:"text-xs",children:[t.jsx(F,{className:"h-3 w-3 mr-2"}),"Cambiar Firma"]})]}):t.jsxs("button",{onClick:()=>c(!0),className:`w-full h-24 rounded-xl border-2 border-dashed ${s.divider} flex flex-col items-center justify-center ${s.textMuted} hover:bg-white/5 transition-colors`,children:[t.jsx(F,{className:"h-5 w-5 mb-2 opacity-50"}),t.jsx("span",{className:"text-xs font-bold uppercase",children:"Tocar para firmar"})]})]})]}),t.jsxs("div",{className:`p-4 border-t ${s.divider} flex gap-3 bg-opacity-50 ${i?"bg-[#0f1219]":"bg-white"}`,children:[t.jsx(v,{variant:"outline",onClick:()=>m(!1),className:"flex-1",children:"Cancelar"}),t.jsxs(v,{onClick:P,disabled:p,className:`flex-1 ${s.accent}`,children:[p?t.jsx(z,{className:"h-4 w-4 animate-spin mr-2"}):t.jsx(W,{className:"h-4 w-4 mr-2"}),p?"Generando...":"Generar Reporte"]})]})]})}),C&&t.jsx("div",{className:`fixed inset-0 z-[80] flex items-center justify-center ${s.modalOverlay} p-4 animate-in fade-in duration-200`,children:t.jsxs("div",{className:`w-full max-w-md ${i?"bg-[#0f1219]":"bg-white"} rounded-2xl border ${s.divider} shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200`,children:[t.jsxs("div",{className:`p-4 border-b ${s.divider} flex justify-between items-center`,children:[t.jsx("h3",{className:`font-bold ${s.textMain}`,children:"Firma Digital"}),t.jsx("button",{onClick:()=>c(!1),className:`p-1 ${s.textMuted} hover:${s.textMain}`,children:t.jsx(y,{size:18})})]}),t.jsxs("div",{className:"p-4",children:[t.jsx("div",{className:`border-2 border-dashed ${i?"border-gray-700 bg-white/5":"border-slate-300 bg-slate-50"} rounded-xl overflow-hidden mb-4`,children:t.jsx(O,{ref:u,canvasProps:{className:"signature-canvas w-full h-40",style:{width:"100%",height:"160px"}},backgroundColor:"transparent",penColor:i?"white":"black"})}),t.jsxs("div",{className:"flex gap-3",children:[t.jsxs(v,{variant:"outline",onClick:S,className:"flex-1",children:[t.jsx(y,{className:"h-4 w-4 mr-2"}),"Limpiar"]}),t.jsxs(v,{onClick:f,className:`flex-1 ${s.accent}`,children:[t.jsx(k,{className:"h-4 w-4 mr-2"}),"Guardar"]})]})]})]})})]})};export{X as T,_ as g};
