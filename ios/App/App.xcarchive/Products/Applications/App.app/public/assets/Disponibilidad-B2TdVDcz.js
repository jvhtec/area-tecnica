import{l as ot,u as te,e as ne,f as Se,s as O,i as g,r as N,j as e,Q as K,T as xe,J as pe,K as fe,O as ye,D as Ce,aF as ct,B as _,q as qe,F as _e,G as ke,aK as dt,z as mt,y as ut,C as ae,W as ht,Y as xt,A as pt,V as we,d as He,af as Te,L as X,Z as kt,aE as Mt,a as Je,S as Ve,t as Ye,v as Xe,w as Ze,x as Fe,I as Et,ac as Pt,X as Dt,c as Tt}from"./index-NZ6jJLfQ.js";import{C as Oe,u as Ft}from"./calendar--BDVgnXu.js";import{u as H}from"./useQuery-kdg2pmgf.js";import{u as re}from"./useMutation-DluhVBs1.js";import{a as Ge,P as zt,m as ft,c as ze,b as he}from"./equipment-B5qd5N3O.js";import{S as Rt}from"./StockCreationManager-CpCpy-Lb.js";import{A as Ot,b as At,a as It}from"./alert-BqA-5jRM.js";import{B as $t}from"./box-C0bB0Qui.js";import{C as Lt}from"./circle-alert-LZYNzZ7F.js";import{P as Kt}from"./PresetEditor-zAPhu2I0.js";import{S as Bt}from"./scroll-area-BHjMXddA.js";import{A as Ut,a as Wt,b as Qt,c as Ht,d as Gt,e as Jt,f as Vt,g as Yt}from"./alert-dialog-CtyYUxwH.js";import{u as Me,D as et}from"./DepartmentContext-CUMyywOO.js";import{AmplifierTool as Xt}from"./AmplifierTool-B8XV4xmK.js";import{C as Zt}from"./calculator-jIsLl-gd.js";import{C as es}from"./copy-Dez5r9kU.js";import{P as ts}from"./pencil-BxZTvEYh.js";import{T as tt,a as ss,b as st,c as oe,d as as,e as ce}from"./table-DnQAmABX.js";import{C as yt,a as Ae,b as gt}from"./collapsible-DWBtmsfD.js";import{a as rs}from"./lazyPdf-xVUlxKNu.js";import{e as Y}from"./es-CSiFCUGj.js";import{R as ns}from"./reload-button-B1d3KJMk.js";import{a as jt}from"./useOptimizedSubscriptions-BXgl5mid.js";import{S as ge,a as Ie,b as je,c as be,d as ve}from"./sheet-DFFfLazF.js";import{B as de}from"./badge-vNTKF5RD.js";import{C as $e}from"./checkbox-BsRNEGV1.js";import{F as is}from"./filter-D0HnK7Nz.js";import{C as Le}from"./chevron-left-rq2ui83a.js";import{C as bt}from"./chevron-right-Bn7Eu0F7.js";import{D as ls}from"./download-C1rVE0-J.js";import{e as os}from"./eachDayOfInterval-CPmiA2bk.js";import{e as Re,a as cs}from"./endOfWeek-BYLwoWuZ.js";import{s as ds}from"./subWeeks-DXhfE23M.js";import{P as Ke,a as Be,b as Ue}from"./popover-Dl-b1R8L.js";import{C as Ne}from"./calendar-_Cj_Sgy-.js";import{P as We}from"./plus-C3JQqq7t.js";import{fetchJobLogo as ms}from"./logoUtils-D2o1jUVg.js";import{u as us}from"./useOptimizedJobs-BQ4L7-2d.js";import{M as hs}from"./menu-BAW81oPe.js";import{S as vt}from"./settings-egXcSQW9.js";import{s as at}from"./subDays-D4REtaCB.js";import{a as rt}from"./startOfMonth-B5dVCv8B.js";import{i as nt}from"./isSameDay-m1OvdnsV.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./isSameMonth-BQ4F6s8O.js";import"./addMonths-j-Bb577B.js";import"./differenceInCalendarMonths-6exvViir.js";import"./endOfMonth-Byhxb84j.js";import"./search-D-OiWg8h.js";import"./link-z6ku9ZYO.js";import"./clipboard-paste-CkPncGV3.js";import"./flexPullsheets-DscweXrW.js";import"./tabs-BdaywI_b.js";import"./index-hC3MxXep.js";import"./triangle-alert-D6qN0F8g.js";import"./circle-check-C0N48OpO.js";import"./circle-x-DDzV-xk_.js";import"./upload-DF4rjO7T.js";import"./save-z_re-Mcq.js";import"./file-text-igU140SQ.js";import"./index-Bf_BVWwW.js";import"./logo-url-cache-eY6nfvu7.js";import"./useSubscription-C3wu6ko-.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=ot("ChevronsUpDown",[["path",{d:"m7 15 5 5 5-5",key:"1hf1tw"}],["path",{d:"m7 9 5-5 5 5",key:"sgt6xg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xs=ot("PackagePlus",[["path",{d:"M16 16h6",key:"100bgy"}],["path",{d:"M19 13v6",key:"85cyf1"}],["path",{d:"M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14",key:"e7tb2h"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["line",{x1:"12",x2:"12",y1:"22",y2:"12",key:"a4e8g8"}]]);function ps({selectedDate:l,onDateSelect:y,className:d}){const{session:m,userDepartment:f}=te(),{toast:p}=ne(),j=Se(),z=f||"sound",T=Ge(z),{data:r}=H({queryKey:["equipment-base-stock",z],queryFn:async()=>{const{data:h,error:o}=await O.from("equipment_availability_with_rentals").select("equipment_id, equipment_name, category, base_quantity").in("category",T).order("category").order("equipment_name");if(o)throw o;return h}}),{data:u,isLoading:E}=H({queryKey:["preset-assignments",f],queryFn:async()=>{const{data:h,error:o}=await O.from("day_preset_assignments").select(`
          *,
          preset:presets!inner (
            *,
            items:preset_items (
              *,
              equipment:equipment (*)
            )
          )
        `).eq("preset.department",(f||"").toString()).order("date");if(o)throw p({variant:"destructive",title:"Error",description:"Could not load preset assignments"}),o;return h}});re({mutationFn:async({date:h,presetId:o})=>{var s;if(!((s=m==null?void 0:m.user)!=null&&s.id))throw new Error("Must be logged in");const{error:M}=await O.from("day_preset_assignments").insert({date:g(h,"yyyy-MM-dd"),preset_id:o,user_id:m.user.id,assigned_by:m.user.id});if(M)throw M},onSuccess:()=>{j.invalidateQueries({queryKey:["preset-assignments"]}),p({title:"Success",description:"Preset assigned successfully"})},onError:h=>{p({variant:"destructive",title:"Error",description:"Failed to assign preset"})}});const[S,A]=N.useState({});N.useEffect(()=>{if(!u||u.length===0){A({});return}const h=u.map(c=>new Date(c.date)),o=new Date(Math.min(...h.map(c=>c.getTime()))),M=new Date(Math.max(...h.map(c=>c.getTime()))),s=g(o,"yyyy-MM-dd"),n=g(M,"yyyy-MM-dd");A({start:s,end:n})},[u]);const{data:b=[]}=H({queryKey:["sub-rentals-range",f,S.start,S.end],queryFn:async()=>{if(!S.start||!S.end)return[];const{data:h,error:o}=await O.from("sub_rentals").select("equipment_id, quantity, start_date, end_date, department").eq("department",(f||"").toString()).lte("start_date",S.end).gte("end_date",S.start);if(o)throw o;return h||[]},enabled:!!(S.start&&S.end&&f)}),k=N.useMemo(()=>{const h={};if(!(b!=null&&b.length)||!S.start||!S.end)return h;const o=new Date(S.start),M=new Date(S.end);for(let s=new Date(o);s<=M;s.setDate(s.getDate()+1))h[g(s,"yyyy-MM-dd")]={};return b.forEach(s=>{const n=new Date(s.start_date),c=new Date(s.end_date);for(let w=new Date(n);w<=c;w.setDate(w.getDate()+1)){const t=g(w,"yyyy-MM-dd");t in h&&(h[t][s.equipment_id]=(h[t][s.equipment_id]||0)+(s.quantity||0))}}),h},[b,S.start,S.end]),C=h=>{var c;const o=g(h,"yyyy-MM-dd"),M=u==null?void 0:u.filter(w=>w.date===o);if(!(M!=null&&M.length)||!r)return"none";const s={};M.forEach(w=>{w.preset.items.forEach(t=>{s[t.equipment_id]=(s[t.equipment_id]||0)+(t.quantity||0)})});let n=!1;for(const[w,t]of Object.entries(s)){const i=r.find(Q=>Q.equipment_id===w),q=(i==null?void 0:i.base_quantity)??0,R=((c=k[o])==null?void 0:c[w])??0;if(t>q+R)return"conflict";t>q&&(n=!0)}return n?"rentals_ok":"stock_ok"},I={hasPreset:h=>(u==null?void 0:u.some(o=>o.date===g(h,"yyyy-MM-dd")))??!1,conflict:h=>C(h)==="conflict",rentals_ok:h=>C(h)==="rentals_ok",stock_ok:h=>C(h)==="stock_ok"},v={hasPreset:{boxShadow:"inset 0 0 0 2px hsl(var(--primary))"},conflict:{backgroundColor:"hsl(var(--destructive) / 0.22)",border:"2px solid hsl(var(--destructive))"},rentals_ok:{backgroundColor:"hsl(var(--warning, 45 93% 47%) / 0.18)",border:"2px solid hsl(var(--warning, 45 93% 47%))"},stock_ok:{backgroundColor:"hsl(var(--success, 142 71% 45%) / 0.18)",border:"2px solid hsl(var(--success, 142 71% 45%))"}},x=N.useMemo(()=>{const h={};return(u||[]).forEach(o=>{var s;const M=o.date;h[M]||(h[M]={names:[],count:0,status:"none"}),h[M].count+=1,(s=o==null?void 0:o.preset)!=null&&s.name&&h[M].names.push(o.preset.name)}),Object.keys(h).forEach(o=>{h[o].status=C(new Date(o))}),h},[u,r,k]);function F(h){const{date:o,displayMonth:M}=h,s=N.useRef(null),n=Ft(o,M,s);if(n.isHidden)return e.jsx("div",{role:"gridcell"});const c=g(o,"yyyy-MM-dd"),w=x[c],t=!!w;return n.isButton?e.jsx(xe,{children:e.jsxs(pe,{delayDuration:150,children:[e.jsx(fe,{asChild:!0,children:e.jsx("button",{ref:s,...n.buttonProps,className:K(n.buttonProps.className),title:void 0})}),t&&e.jsx(ye,{side:"top",align:"center",className:"w-64",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:g(o,"PPP")}),e.jsxs("div",{className:"text-sm",children:["Presets: ",w.count]}),w.names.length>0&&e.jsx("div",{className:"text-xs text-muted-foreground",children:w.names.map((i,q)=>e.jsxs("div",{children:["• ",i]},q))}),w.status==="conflict"&&e.jsx("div",{className:"text-xs text-red-600 font-medium",children:"Conflicts detected"}),w.status==="rentals_ok"&&e.jsx("div",{className:"text-xs text-amber-600 font-medium",children:"Covered via sub‑rentals"}),w.status==="stock_ok"&&e.jsx("div",{className:"text-xs text-green-600 font-medium",children:"Covered by stock"})]})})]})}):e.jsx("div",{...n.divProps})}return e.jsx("div",{className:K("w-full",d),children:e.jsx(Oe,{mode:"single",selected:l,onSelect:y,className:"w-full rounded-md border",classNames:{caption:"flex justify-center pt-1 relative items-center",table:"w-full border-collapse space-y-1",head_row:"flex w-full justify-between",head_cell:"text-muted-foreground rounded-md w-full font-normal text-[0.8rem]",row:"flex w-full mt-2",cell:"h-9 w-full text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:K("h-9 w-full p-0 font-normal aria-selected:opacity-100 hover:bg-accent hover:text-accent-foreground rounded-md transition-colors"),day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent text-accent-foreground",day_outside:"text-muted-foreground opacity-50",day_disabled:"text-muted-foreground opacity-50",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible"},components:{Day:F},modifiers:I,modifiersStyles:v})})}function wt(){var z;const[l,y]=N.useState(!1),d=te(),{session:m}=d,f=d.userDepartment,{data:p=[],error:j}=H({queryKey:["stock-entries",f],queryFn:async()=>{var E;if(!((E=m==null?void 0:m.user)!=null&&E.id)||!f)return[];const T=Ge(f),{data:r,error:u}=await O.from("global_stock_entries").select("*, equipment!inner(category)").in("equipment.category",T);if(u)throw u;return r},enabled:!!((z=m==null?void 0:m.user)!=null&&z.id)&&!!f&&l});return f?e.jsxs(Ce,{open:l,onOpenChange:y,children:[e.jsx(ct,{asChild:!0,children:e.jsxs(_,{variant:"outline",size:"sm",children:[e.jsx($t,{className:"mr-2 h-4 w-4"}),"Gestionar Inventario"]})}),e.jsxs(qe,{className:"max-w-2xl h-[80vh] flex flex-col",children:[e.jsxs(_e,{className:"flex-shrink-0",children:[e.jsx(ke,{children:"Gestionar Inventario"}),e.jsx(dt,{children:"Administra el equipamiento y cantidades del departamento."})]}),j?e.jsxs(Ot,{variant:"destructive",children:[e.jsx(Lt,{className:"h-4 w-4"}),e.jsx(At,{children:"Error"}),e.jsx(It,{children:"Error al cargar el inventario. Por favor, inténtelo de nuevo más tarde."})]}):e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx(Rt,{stock:p,onStockUpdate:()=>{},department:f})})]})]}):null}function fs({onClose:l,selectedDate:y}){var o,M;const{session:d}=te(),{department:m}=Me(),{toast:f}=ne(),p=Se(),[j,z]=N.useState(null),[T,r]=N.useState(null),[u,E]=N.useState(null),[S,A]=N.useState(!1),[b,k]=N.useState(!1),C=N.useMemo(()=>y?{start:ut(y).toISOString(),end:mt(y).toISOString()}:null,[y]),{data:I=[]}=H({queryKey:["jobs-for-preset-push",m,C==null?void 0:C.start,C==null?void 0:C.end],queryFn:async()=>{if(!m||!C)return[];const{data:s,error:n}=await O.from("jobs").select(`
            id,
            title,
            start_time,
            end_time,
            job_departments!inner(department)
          `).in("job_type",["single","festival","tourdate","evento"]).eq("job_departments.department",m).or(`and(end_time.is.null,start_time.gte.${C.start},start_time.lte.${C.end}),and(end_time.gte.${C.start},start_time.lte.${C.end})`).order("start_time",{ascending:!0});if(n)throw n;return s||[]},enabled:!!(m&&C)}),v=N.useMemo(()=>I.filter(s=>!!(s!=null&&s.id)).map(s=>({id:s.id,title:s.title||"Untitled job",startTime:s.start_time})),[I]),{data:x}=H({queryKey:["presets",m],queryFn:async()=>{var c;if(!((c=d==null?void 0:d.user)!=null&&c.id))return[];const{data:s,error:n}=await O.from("presets").select(`
          *,
          items:preset_items (
            *,
            equipment:equipment (*)
          )
        `).eq("department",m).order("is_template",{ascending:!1}).order("name");if(n)throw n;return(s||[]).map(ft)},enabled:!!((o=d==null?void 0:d.user)!=null&&o.id)}),F=re({mutationFn:async s=>{const{error:n}=await O.from("preset_items").delete().eq("preset_id",s);if(n)throw n;const{error:c}=await O.from("presets").delete().eq("id",s);if(c)throw c},onSuccess:()=>{p.invalidateQueries({queryKey:["presets",m]}),f({title:"Success",description:"Preset deleted successfully"})},onError:s=>{f({variant:"destructive",title:"Error",description:"Failed to delete preset"})}}),h=async(s,n,c)=>{var w;try{if(!((w=d==null?void 0:d.user)!=null&&w.id))throw new Error("Must be logged in");if(j){const{error:t}=await O.from("presets").update({name:s,tour_id:c??null}).eq("id",j.id);if(t)throw t;const{error:i}=await O.from("preset_items").delete().eq("preset_id",j.id);if(i)throw i;if(n.length>0){const{error:q}=await O.from("preset_items").insert(n.map(R=>({...R,preset_id:j.id})));if(q)throw q}}else{const{data:t,error:i}=await O.from("presets").insert({name:s,created_by:d.user.id,user_id:d.user.id,is_template:!1,department:m,tour_id:c??null}).select().single();if(i)throw i;if(n.length>0){const{error:q}=await O.from("preset_items").insert(n.map(R=>({...R,preset_id:t.id})));if(q)throw q}}p.invalidateQueries({queryKey:["presets",m]}),z(null),r(null),A(!1),f({title:"Success",description:"Preset saved successfully"})}catch(t){f({variant:"destructive",title:"Error",description:t instanceof Error?t.message:"Failed to save preset"})}};return S||j||T?e.jsx(Kt,{preset:j||T,isCopy:!!T,onSave:h,onCancel:()=>{z(null),r(null),A(!1)},jobId:((M=j||T)==null?void 0:M.job_id)??void 0,jobCandidates:v,allowedCategories:m==="sound"?zt:void 0}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Presets"}),e.jsxs("div",{className:"flex gap-2",children:[m==="sound"&&e.jsxs(_,{variant:"outline",onClick:()=>k(!0),children:[e.jsx(Zt,{className:"h-4 w-4 mr-2"}),"Create from Calculator"]}),e.jsx(_,{onClick:()=>A(!0),children:"Create New Preset"})]})]}),e.jsxs(ae,{children:[e.jsx(ht,{children:e.jsx(xt,{children:"Your Presets"})}),e.jsx(pt,{children:e.jsx(Bt,{className:"h-[400px]",children:e.jsxs("div",{className:"space-y-4",children:[x==null?void 0:x.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:s.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.items.length," items"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(_,{variant:"ghost",size:"icon",onClick:()=>{const n={...s,name:`Copy of ${s.name}`};r(n)},children:e.jsx(es,{className:"h-4 w-4"})}),e.jsx(_,{variant:"ghost",size:"icon",onClick:()=>z(s),children:e.jsx(ts,{className:"h-4 w-4"})}),e.jsx(_,{variant:"ghost",size:"icon",onClick:()=>E(s),children:e.jsx(we,{className:"h-4 w-4"})})]})]},s.id)),(!x||x.length===0)&&e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"No presets created yet"})]})})})]}),e.jsx(Ut,{open:!!u,onOpenChange:s=>!s&&E(null),children:e.jsxs(Wt,{children:[e.jsxs(Qt,{children:[e.jsx(Ht,{children:"Are you sure?"}),e.jsx(Gt,{children:"This action cannot be undone. This will permanently delete the preset and remove it from your inventory."})]}),e.jsxs(Jt,{children:[e.jsx(Vt,{children:"Cancel"}),e.jsx(Yt,{onClick:()=>{u&&(F.mutate(u.id),E(null))},children:"Delete"})]})]})}),e.jsx(Ce,{open:b,onOpenChange:k,children:e.jsxs(qe,{className:"max-w-6xl max-h-[90vh]",children:[e.jsx(_e,{children:e.jsx(ke,{children:"Amplifier Calculator - Create Preset"})}),e.jsx("div",{className:"text-sm text-muted-foreground mb-4",children:"Configure speakers and calculate amplifiers. Results will be saved as a new preset."}),e.jsx(Xt,{})]})})]})}function Nt({open:l,onOpenChange:y,selectedDate:d}){return e.jsx(Ce,{open:l,onOpenChange:y,children:e.jsxs(qe,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(_e,{children:e.jsx(ke,{children:"Gestión de Presets"})}),e.jsx(fs,{onClose:()=>y(!1),selectedDate:d})]})})}const ys=async(l,y,d,m=!1)=>{const{jsPDF:f,autoTable:p}=await rs();return new Promise((j,z)=>{var T;try{const r=new f({orientation:"landscape"}),u=r.internal.pageSize.getWidth(),E=r.internal.pageSize.getHeight(),S=new Date().toLocaleDateString("es-ES");r.setFillColor(125,1,1),r.rect(0,0,u,40,"F"),r.setFontSize(24),r.setTextColor(255,255,255);const A=m?"Faltas de Equipamiento - Resumen Semanal":"Resumen Semanal de Equipamiento";r.text(A,u/2,20,{align:"center"});const b=`${g(l,"d 'de' MMMM",{locale:Y})} - ${g(new Date(l.getTime()+8640*60*1e3),"d 'de' MMMM",{locale:Y})}`;r.setFontSize(16),r.text(b,u/2,30,{align:"center"}),r.setFontSize(12),r.setTextColor(51,51,51);const k=d.length>0?`Categorías: ${d.map(n=>ze[n]).join(", ")}`:"Categorías: Todas";r.text(k,14,50);const C=[["Equipo","Categoría","Stock Total",...y[0].dailyUsage.map(n=>g(n.date,"EEE d",{locale:Y})),"Disponible"]],I=y.map(n=>[n.name,ze[n.category],n.stock.toString(),...n.dailyUsage.map(c=>c.used===0&&(!c.boost||c.boost===0)?"-":{content:`${c.used}${c.boost&&c.boost>0?` (+${c.boost})`:""}`,styles:{fillColor:[51,51,51],textColor:[255,255,255],fontStyle:c.remaining<0?"bold":"normal",halign:"center"}}),{content:n.available.toString(),styles:{textColor:n.available<0?[255,0,0]:[0,0,0],fontStyle:n.available<0?"bold":"normal"}}]);p(r,{head:C,body:I,startY:60,theme:"grid",styles:{fontSize:10,cellPadding:5,lineColor:[220,220,230],lineWidth:.1,halign:"left"},margin:{top:60,left:14,right:14,bottom:42},headStyles:{fillColor:[125,1,1],textColor:[255,255,255],fontStyle:"bold",halign:"center"},bodyStyles:{textColor:[51,51,51]},alternateRowStyles:{fillColor:[250,250,255]}});const v=14,x=60,F=42,h=r.internal.pageSize.getHeight()-F;let o=(T=r.lastAutoTable)!=null&&T.finalY?Math.min(r.lastAutoTable.finalY+12,h):x;const M=n=>{o+n>h&&(r.addPage("landscape"),o=x)};r.setFontSize(14),r.setTextColor(0,0,0),r.text("Detalles por equipo y día",v,o),o+=6,y.forEach(n=>{var t;const c=n.dailyUsage.filter(i=>(i.used||0)>0||(i.boost||0)>0);if(c.length===0)return;M(16),r.setFont(void 0,"bold"),r.text(`${n.name} · ${ze[n.category]}`,v,o),r.setFont(void 0,"normal"),o+=4;const w=c.map(i=>{const q=g(i.date,"EEE d 'de' MMM",{locale:Y}),R=`${i.used}${i.boost&&i.boost>0?` (+${i.boost})`:""}`,Q=(i.rentals||[]).map(U=>`+${U.qty}${U.notes?` · ${U.notes}`:""}`).join(`
`)||"-",J=(i.presets||[]).map(U=>`${U.name}: ${U.qty}`).join(`
`)||"-";return[q,R,Q,J]});p(r,{head:[["Fecha","Usado (+sub‑rentas)","Sub‑rentas","Presets"]],body:w,startY:o,theme:"grid",styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[245,245,245],textColor:[0,0,0]},columnStyles:{0:{cellWidth:40},1:{cellWidth:35,halign:"center"},2:{cellWidth:80},3:{cellWidth:90}},margin:{left:v,right:14,bottom:F}}),o=(((t=r.lastAutoTable)==null?void 0:t.finalY)||o)+8});const s=new Image;s.crossOrigin="anonymous",s.src="/lovable-uploads/ce3ff31a-4cc5-43c8-b5bb-a4056d3735e4.png",s.onload=()=>{const c=50*(s.height/s.width),w=r.internal.pages.length-1;for(let i=1;i<=w;i++){r.setPage(i);const q=(u-50)/2,R=E-20;try{r.addImage(s,"PNG",q,R-c,50,c),r.setFontSize(10),r.setTextColor(51,51,51),r.text(`Página ${i} de ${w}`,u/2,E-10,{align:"center"})}catch{}}r.setPage(w),r.setFontSize(10),r.setTextColor(51,51,51),r.text(`Creado: ${S}`,u-10,E-10,{align:"right"});const t=r.output("blob");j(t)},s.onerror=()=>{const n=r.output("blob");j(n)}}catch(r){z(r)}})};function gs(l,y){try{const d=localStorage.getItem(l);return d===null?y:JSON.parse(d)}catch{try{localStorage.removeItem(l)}catch{}return y}}function js(l,y){try{localStorage.setItem(l,JSON.stringify(y))}catch{}}function bs({imageId:l,alt:y,className:d,width:m=200,height:f=200}){const[p,j]=N.useState(null),[z,T]=N.useState(!1);return N.useEffect(()=>{let r=!0;return(async()=>{try{const{data:{session:E}}=await O.auth.getSession();if(!(E!=null&&E.access_token)){T(!0);return}const S=await fetch(`${kt}/functions/v1/fetch-flex-image?imageId=${encodeURIComponent(l)}&size=thumb`,{headers:{Authorization:`Bearer ${E.access_token}`}});if(!S.ok){T(!0);return}const A=await S.blob();if(r){const b=URL.createObjectURL(A);j(b)}}catch{r&&T(!0)}})(),()=>{r=!1,p&&URL.revokeObjectURL(p)}},[l]),z||!p?e.jsx("span",{className:"text-xs text-muted-foreground",children:"Image not available"}):e.jsx("img",{src:p,alt:y,width:m,height:f,loading:"lazy",decoding:"async",className:d})}function St({selectedDate:l,onDateChange:y}){const{department:d}=Me(),{session:m}=te(),{toast:f}=ne(),p=He(),[j,z]=N.useState(()=>Te(l));N.useEffect(()=>{const a=Te(l);a.getTime()!==j.getTime()&&z(a)},[l]);const[T,r]=N.useState(()=>gs("weeklySummaryOpen",!0)),u=Ge(d),[E,S]=N.useState(!1),[A,b]=N.useState([]),[k,C]=N.useState(!1),[I,v]=N.useState(!1);N.useEffect(()=>{js("weeklySummaryOpen",T)},[T]);const x=os({start:j,end:Re(j)});jt([{table:"current_stock_levels",queryKey:["equipment-with-stock",d],priority:"high"},{table:"equipment",queryKey:["equipment-with-stock",d],priority:"medium"},{table:"sub_rentals",queryKey:["equipment-with-stock",d],priority:"high"},{table:"day_preset_assignments",queryKey:["week-preset-assignments",d,g(j,"yyyy-MM-dd")],priority:"high"},{table:"preset_items",queryKey:["week-preset-assignments",d,g(j,"yyyy-MM-dd")],priority:"medium"},{table:"presets",queryKey:["week-preset-assignments",d,g(j,"yyyy-MM-dd")],priority:"low"}]);const{data:F=[],refetch:h}=H({queryKey:["equipment-with-stock",d],queryFn:async()=>{const{data:a,error:D}=await O.from("equipment_availability_with_rentals").select(`
          *
        `).in("category",u).order("category").order("equipment_name");if(D)throw D;return a.map(P=>({id:P.equipment_id,name:P.equipment_name,category:P.category,current_quantity:P.base_quantity||0,base_quantity:P.base_quantity||0,rental_boost:0,image_id:P.image_id||null,manufacturer:P.manufacturer||null}))}}),o=Te(j),M=Re(j),{data:s=[],refetch:n}=H({queryKey:["sub-rentals-week",d,o.toISOString()],queryFn:async()=>{const{data:a,error:D}=await O.from("sub_rentals").select("equipment_id, quantity, start_date, end_date, department, notes").eq("department",d).lte("start_date",g(M,"yyyy-MM-dd")).gte("end_date",g(o,"yyyy-MM-dd"));if(D)throw D;return a||[]}}),c={};x.forEach(a=>{const D=g(a,"yyyy-MM-dd");c[D]={}}),s.forEach(a=>{const D=new Date(a.start_date),P=new Date(a.end_date);x.forEach(L=>{if(L>=D&&L<=P){const B=g(L,"yyyy-MM-dd");c[B][a.equipment_id]=(c[B][a.equipment_id]||0)+(a.quantity||0)}})});const w=(a,D)=>{var L;const P=g(D,"yyyy-MM-dd");return((L=c[P])==null?void 0:L[a])||0},{data:t,refetch:i}=H({queryKey:["week-preset-assignments",d,j],queryFn:async()=>{const a=[];for(const D of x){const{data:P,error:L}=await O.from("day_preset_assignments").select(`
            *,
            preset:presets!inner (
              *,
              items:preset_items (
                *,
                equipment:equipment (*)
              )
            )
          `).eq("preset.department",d).eq("date",g(D,"yyyy-MM-dd")).order("order",{ascending:!0});L||P&&a.push(...P)}return a}}),q=async()=>{await Promise.all([h(),i()])},R=(a,D)=>{const P=g(D,"yyyy-MM-dd"),L=t==null?void 0:t.filter(B=>B.date===P);return L!=null&&L.length?L.reduce((B,W)=>{const $=W.preset.items.find(G=>G.equipment_id===a);return B+(($==null?void 0:$.quantity)||0)},0):0},Q=(a,D)=>{const P=g(D,"yyyy-MM-dd"),L=(t==null?void 0:t.filter(W=>W.date===P))||[],B=[];return L.forEach(W=>{var G,Z,V;const $=(Z=(G=W.preset)==null?void 0:G.items)==null?void 0:Z.find(se=>se.equipment_id===a);$&&$.quantity>0&&B.push({name:((V=W.preset)==null?void 0:V.name)??"Preset",qty:$.quantity})}),B},J=(a,D)=>(s||[]).filter(P=>P.equipment_id===a&&D>=new Date(P.start_date)&&D<=new Date(P.end_date)).map(P=>({qty:P.quantity,notes:P.notes})),U=()=>{const a=ds(j);z(a),y(a)},Ee=()=>{const a=cs(j,1);z(a),y(a)},me=a=>{b(D=>{if(!E)return S(!0),[a];const P=D.includes(a)?D.filter(L=>L!==a):[...D,a];return P.length===0&&S(!1),P})},ie=E?F==null?void 0:F.filter(a=>A.includes(a.category)):F,_t=async()=>{if(ie)try{const a=ie.map($=>{const G=x.map(V=>{const se=R($.id,V),le=w($.id,V),ue=$.base_quantity+le-se,Pe=Q($.id,V),ee=J($.id,V);return{used:se,remaining:ue,date:V,boost:le,presets:Pe,rentals:ee}}),Z=Math.min(...G.map(V=>V.remaining));return{name:$.name,category:$.category,stock:$.current_quantity,dailyUsage:G,available:Z}}),D=I?a.filter($=>$.dailyUsage.some(G=>G.remaining<0)||$.available<0):a;if(D.length===0){f({title:I?"Sin faltas":"Sin datos",description:I?"No hay equipos con faltas en esta semana":"No hay equipos para esta semana en las categorías seleccionadas"});return}const P=await ys(j,D,A,I),L=window.URL.createObjectURL(P),B=document.createElement("a"),W=I?`faltas-semanal-${g(j,"yyyy-MM-dd")}.pdf`:`resumen-semanal-${g(j,"yyyy-MM-dd")}.pdf`;B.href=L,B.setAttribute("download",W),document.body.appendChild(B),B.click(),B.remove(),window.URL.revokeObjectURL(L),f({title:"PDF Exportado",description:I?`Se han exportado ${D.length} equipos con faltas`:"El resumen semanal se ha exportado correctamente"})}catch{f({variant:"destructive",title:"Error",description:"No se pudo exportar el PDF"})}};return e.jsxs(yt,{open:T,onOpenChange:r,className:"w-full space-y-2",children:[e.jsxs("div",{className:K("flex",p?"flex-col gap-3":"items-center justify-between"),children:[e.jsxs("div",{className:K("flex items-center",p?"justify-between":"gap-2"),children:[e.jsx("h2",{className:K("font-semibold",p?"text-base":"text-lg md:text-lg"),children:"Resumen Semanal"}),p&&e.jsx(Ae,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"sm",children:e.jsx(Qe,{className:"h-4 w-4"})})})]}),e.jsx("div",{className:K("flex items-center gap-2",p&&"w-full"),children:p?e.jsxs(ge,{open:k,onOpenChange:C,children:[e.jsx(Ie,{asChild:!0,children:e.jsxs(_,{variant:"outline",size:"sm",className:"gap-2 flex-1",children:[e.jsx(is,{className:"h-4 w-4"}),"Categorías",E&&A.length>0&&e.jsx(de,{variant:"default",className:"ml-1 px-2 py-0",children:A.length})]})}),e.jsxs(je,{side:"bottom",className:"h-auto max-h-[85vh] overflow-y-auto",children:[e.jsx(be,{className:"mb-4",children:e.jsx(ve,{children:"Categorías"})}),e.jsxs("div",{className:"space-y-2",children:[u.map(a=>e.jsx(_,{variant:A.includes(a)?"default":"outline",size:"sm",onClick:()=>me(a),className:"w-full justify-start",children:he[a]},a)),E&&e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>{S(!1),b([]),C(!1)},className:"w-full",children:"Limpiar Filtros"})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex gap-2",children:u.map(a=>e.jsx(_,{variant:A.includes(a)?"default":"outline",size:"sm",onClick:()=>me(a),children:he[a]},a))}),E&&e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>{S(!1),b([])},title:"Disable filters",children:"Clear"})]})}),e.jsxs("div",{className:K("flex items-center gap-2 flex-wrap",p&&"w-full"),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{variant:"outline",size:"sm",onClick:U,children:e.jsx(Le,{className:"h-4 w-4"})}),e.jsxs("span",{className:"text-sm whitespace-nowrap",children:[g(j,"d 'de' MMMM",{locale:Y})," - "," ",g(Re(j),"d 'de' MMMM",{locale:Y})]}),e.jsx(_,{variant:"outline",size:"sm",onClick:Ee,children:e.jsx(bt,{className:"h-4 w-4"})})]}),e.jsx(ns,{onReload:q}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($e,{id:"shortages-only",checked:I,onCheckedChange:a=>v(a===!0)}),e.jsx(X,{htmlFor:"shortages-only",className:"text-sm cursor-pointer whitespace-nowrap",children:"Solo faltas"})]}),e.jsxs(_,{variant:"outline",size:"sm",onClick:_t,className:K(p&&"flex-1"),children:[e.jsx(ls,{className:"h-4 w-4 mr-2"}),"Exportar PDF"]})]}),!p&&e.jsx(Ae,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"sm",children:e.jsx(Qe,{className:"h-4 w-4"})})})]})]}),e.jsx(gt,{className:"space-y-2",children:e.jsx(ae,{className:K(p?"p-3":"p-3 sm:p-4"),children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("div",{className:"min-w-[768px] md:min-w-[960px] lg:min-w-[1120px]",children:[e.jsx(tt,{className:"table-fixed w-full",children:e.jsx(ss,{className:"bg-background",children:e.jsxs(st,{children:[e.jsx(oe,{className:K("w-[200px]",p&&"text-xs w-[120px]"),children:"Equipo"}),e.jsx(oe,{className:K("w-[120px]",p&&"text-xs w-[80px]"),children:"Categoría"}),e.jsx(oe,{className:K("w-[80px]",p&&"text-xs w-[60px]"),children:"Stock Total"}),x.map(a=>e.jsx(oe,{className:K("text-center w-[100px]",p&&"text-xs w-[60px]"),children:g(a,"EEE d",{locale:Y})},a.toISOString())),e.jsxs(oe,{className:K("text-right w-[100px]",p&&"text-xs w-[60px]"),children:["Disponible",e.jsxs("span",{className:"ml-2 text-xs text-muted-foreground block sm:inline",children:["(",g(l||j,"EEE d",{locale:Y}),")"]})]})]})})}),e.jsx("div",{className:"overflow-y-auto h-[calc(100vh-280px)]",children:e.jsx(tt,{className:"table-fixed w-full",children:e.jsx(as,{children:ie==null?void 0:ie.map(a=>{x.map(W=>{const $=R(a.id,W),G=w(a.id,W);return a.base_quantity+G-$});const D=l||j,P=R(a.id,D),L=w(a.id,D),B=a.base_quantity+L-P;return e.jsxs(st,{children:[e.jsx(ce,{className:K("w-[200px] font-medium",p&&"w-[120px]"),children:a.image_id?e.jsx(xe,{children:e.jsxs(pe,{delayDuration:200,children:[e.jsx(fe,{asChild:!0,children:e.jsx("div",{className:"truncate cursor-pointer",title:a.name,children:a.name})}),e.jsx(ye,{side:"right",className:"p-2",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(bs,{imageId:a.image_id,alt:a.name,className:"max-w-[200px] max-h-[200px] rounded"}),e.jsx("div",{className:"text-sm font-medium",children:a.name}),a.manufacturer&&e.jsx("div",{className:"text-xs text-muted-foreground",children:a.manufacturer})]})})]})}):e.jsx("div",{className:"truncate",title:a.name,children:a.name})}),e.jsx(ce,{className:K("w-[120px]",p&&"w-[80px]"),children:e.jsx("div",{className:"truncate",title:he[a.category],children:he[a.category]})}),e.jsx(ce,{className:K("w-[80px]",p&&"w-[60px]"),children:a.current_quantity}),x.map(W=>{const $=R(a.id,W),G=w(a.id,W),Z=a.base_quantity+G-$,V=Z>=0?"text-green-600":"text-red-600 font-bold",se=Z<0?"bg-destructive/20":"",le=Q(a.id,W),ue=J(a.id,W),Pe=e.jsx("div",{className:"flex justify-center items-center",children:e.jsx("span",{className:V,children:$>0?$:"-"})});return e.jsx(ce,{className:`text-center w-[100px] ${se} ${p?"w-[60px]":""}`,children:e.jsx(xe,{children:e.jsxs(pe,{delayDuration:200,children:[e.jsx(fe,{asChild:!0,children:e.jsx("div",{children:Pe})}),e.jsx(ye,{side:"top",align:"center",className:"w-72",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm font-medium",children:[a.name," · ",g(W,"PPP")]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Breakdown"}),le.length>0?e.jsx("div",{className:"text-sm",children:le.map((ee,De)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:ee.name}),e.jsxs("span",{children:["−",ee.qty]})]},De))}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No presets"}),ue.length>0&&e.jsxs("div",{className:"text-sm pt-1 border-t",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Sub‑rentals"}),ue.map((ee,De)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["+",ee.qty]}),e.jsx("span",{className:"text-xs italic",children:ee.notes||""})]},De))]})]})})]})})},W.toISOString())}),e.jsx(ce,{className:K("text-right w-[100px]",p&&"w-[60px]",B<0?"text-red-500 font-bold":""),children:e.jsx(xe,{children:e.jsxs(pe,{delayDuration:200,children:[e.jsx(fe,{asChild:!0,children:e.jsx("span",{className:"cursor-default",children:B})}),e.jsx(ye,{side:"left",align:"center",className:"w-72",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm font-medium",children:[a.name," · ",g(D,"PPP")]}),e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Base"}),e.jsx("span",{children:a.base_quantity})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Sub‑rentals"}),e.jsxs("span",{children:["+",L]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Usado"}),e.jsxs("span",{children:["−",P]})]}),e.jsxs("div",{className:"flex justify-between font-medium border-t pt-1",children:[e.jsx("span",{children:"Disponible"}),e.jsx("span",{children:B})]})]})]})})]})})})]},a.id)})})})})]})})})})]})}function Ct({selectedDate:l,onAssign:y,className:d}){var S,A;const{department:m}=Me(),{session:f}=te(),{toast:p}=ne(),j=Se(),z=l&&Mt(l),{data:T=[]}=H({queryKey:["presets",m],queryFn:async()=>{var C;if(!((C=f==null?void 0:f.user)!=null&&C.id))return[];const{data:b,error:k}=await O.from("presets").select(`
          *,
          items:preset_items (
            *,
            equipment:equipment (*)
          )
        `).eq("department",m).order("name");if(k)throw k;return(b||[]).map(ft)},enabled:!!((S=f==null?void 0:f.user)!=null&&S.id)}),{data:r=[]}=H({queryKey:["preset-assignments",m,l],queryFn:async()=>{if(!z)return[];const{data:b,error:k}=await O.from("day_preset_assignments").select("*, preset:presets!inner(name, department)").eq("preset.department",m).eq("date",g(l,"yyyy-MM-dd")).order("order",{ascending:!0});if(k)throw k;return b||[]},enabled:!!((A=f==null?void 0:f.user)!=null&&A.id)&&z}),u=re({mutationFn:async b=>{var I;if(!((I=f==null?void 0:f.user)!=null&&I.id))throw new Error("Must be logged in");if(!z)throw new Error("Invalid date selected");const k=(r==null?void 0:r.reduce((v,x)=>Math.max(v,x.order||0),-1))||-1,{error:C}=await O.from("day_preset_assignments").insert({date:g(l,"yyyy-MM-dd"),preset_id:b,user_id:f.user.id,order:k+1});if(C)throw C},onSuccess:()=>{j.invalidateQueries({queryKey:["preset-assignments"]}),p({title:"Success",description:"Preset assigned successfully"}),y==null||y()},onError:b=>{p({variant:"destructive",title:"Error",description:"Failed to assign preset"})}}),E=re({mutationFn:async b=>{var C;if(!((C=f==null?void 0:f.user)!=null&&C.id))throw new Error("Must be logged in");if(!z)throw new Error("Invalid date selected");const{error:k}=await O.from("day_preset_assignments").delete().eq("id",b);if(k)throw k},onSuccess:()=>{j.invalidateQueries({queryKey:["preset-assignments"]}),p({title:"Success",description:"Preset assignment removed"}),y==null||y()},onError:b=>{p({variant:"destructive",title:"Error",description:"Failed to remove preset assignment"})}});return z?e.jsxs(Ke,{children:[e.jsx(Be,{asChild:!0,children:e.jsxs(_,{variant:"outline",size:"sm",className:d,children:[e.jsx(Ne,{className:"mr-2 h-4 w-4"}),"Assign Preset"]})}),e.jsx(Ue,{className:"w-80",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-medium",children:"Assign Preset"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:g(l,"PP")})]}),r&&r.length>0&&e.jsx(ae,{className:"p-3",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium",children:"Current Assignments"}),r.map(b=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:b.preset.name}),e.jsx(_,{variant:"ghost",size:"icon",onClick:()=>E.mutate(b.id),disabled:E.isPending,children:E.isPending?e.jsx(Je,{className:"h-4 w-4 animate-spin"}):e.jsx(we,{className:"h-4 w-4"})})]},b.id))]})}),e.jsx("div",{className:"space-y-2",children:T.map(b=>e.jsxs(_,{variant:"outline",className:"w-full justify-start",onClick:()=>u.mutate(b.id),disabled:u.isPending,children:[u.isPending&&u.variables===b.id?e.jsx(Je,{className:"mr-2 h-4 w-4 animate-spin"}):null,b.name]},b.id))})]})})]}):null}function vs(){const{session:l}=te(),{toast:y}=ne(),d=Se(),{department:m}=Me();He();const[f,p]=N.useState(!1),[j,z]=N.useState(!1),[T,r]=N.useState([{equipment_id:"",quantity:1}]),[u,E]=N.useState(),[S,A]=N.useState(),[b,k]=N.useState(""),[C,I]=N.useState(""),[v,x]=N.useState(!1),[F,h]=N.useState(!1);jt([{table:"sub_rentals",queryKey:["sub-rentals",m],priority:"high"},{table:"sub_rentals",queryKey:["equipment-with-stock",m],priority:"medium"}]);const{data:o}=H({queryKey:["equipment",m],queryFn:async()=>{const{data:t,error:i}=await O.from("equipment").select("*").eq("department",m).order("name");if(i)throw i;return t}}),{data:M}=H({queryKey:["jobs-for-subrental",m],queryFn:async()=>{const{data:t,error:i}=await O.from("jobs").select("id, title, event_date, locations(name)").gte("event_date",g(new Date,"yyyy-MM-dd")).order("event_date",{ascending:!0}).limit(50);if(i)throw i;return t}}),{data:s=[]}=H({queryKey:["sub-rentals",m],queryFn:async()=>{const{data:t,error:i}=await O.from("sub_rentals").select(`
          *,
          equipment:equipment!inner (
            name,
            category,
            department
          )
        `).eq("equipment.department",m).order("start_date",{ascending:!1});if(i)throw i;return t||[]}}),n=Object.values(s.reduce((t,i)=>{const q=i.batch_id||i.id;return t[q]||(t[q]={batchId:q,start:i.start_date,end:i.end_date,notes:i.notes||null,items:[],total:0}),t[q].items.push(i),t[q].total+=i.quantity,t},{})).sort((t,i)=>new Date(i.start).getTime()-new Date(t.start).getTime()),c=re({mutationFn:async()=>{var J;if(!((J=l==null?void 0:l.user)!=null&&J.id)||!u||!S)throw new Error("Missing required fields");const t=T.filter(U=>U.equipment_id&&(U.quantity??0)>0);if(t.length===0)throw new Error("Add at least one item");const i=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,q=t.map(U=>({equipment_id:U.equipment_id,quantity:U.quantity,start_date:g(u,"yyyy-MM-dd"),end_date:g(S,"yyyy-MM-dd"),notes:b||null,created_by:l.user.id,department:m,batch_id:i,job_id:C||null,is_stock_extension:F})),{data:R,error:Q}=await O.from("sub_rentals").insert(q).select("id");if(Q)throw Q;if(v&&C&&R&&R.length>0)try{const Ee=`Subrental pickup: ${b||"Vendor"}`,{error:me}=await O.functions.invoke("create-transport-request",{body:{job_id:C,subrental_id:R[0].id,description:Ee,department:m,note:`Auto-created from sub-rental batch ${i}`,auto_created:!0}});y(me?{title:"Warning",description:"Sub-rental created but transport request failed. You can create it manually.",variant:"default"}:{title:"Success",description:"Sub-rental and transport request created successfully"})}catch{}},onSuccess:()=>{d.invalidateQueries({queryKey:["sub-rentals"]}),d.invalidateQueries({queryKey:["sub-rentals-week"]}),d.invalidateQueries({queryKey:["equipment-with-stock"]}),d.invalidateQueries({queryKey:["transport-requests-all"]}),(!v||!C)&&y({title:"Success",description:"Sub-rental items added successfully"}),r([{equipment_id:"",quantity:1}]),E(void 0),A(void 0),k(""),I(""),x(!1),h(!1),p(!1)},onError:t=>{y({variant:"destructive",title:"Error",description:"Failed to add sub-rental"})}}),w=re({mutationFn:async t=>{const{error:i}=await O.from("sub_rentals").delete().eq("id",t);if(i)throw i},onSuccess:()=>{d.invalidateQueries({queryKey:["sub-rentals"]}),d.invalidateQueries({queryKey:["sub-rentals-week"]}),d.invalidateQueries({queryKey:["equipment-with-stock"]}),y({title:"Success",description:"Sub-rental removed"})},onError:()=>{y({variant:"destructive",title:"Error",description:"Failed to remove sub-rental"})}});return e.jsx(yt,{open:j,onOpenChange:z,children:e.jsxs(ae,{className:"p-4 md:p-6",children:[e.jsx(ht,{className:"p-0 mb-4",children:e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:justify-between sm:items-center",children:[e.jsx(xt,{children:"Sub-Rentals (Temporary Stock Boosts)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[!f&&e.jsxs(_,{onClick:()=>{p(!0),z(!0)},size:"sm",className:"w-full sm:w-auto",children:[e.jsx(We,{className:"h-4 w-4 mr-2"}),"Add Sub-Rental"]}),e.jsx(Ae,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"sm","aria-label":"Toggle",className:"w-auto",children:e.jsx(Qe,{className:"h-4 w-4"})})})]})]})}),e.jsx(gt,{children:e.jsxs(pt,{className:"space-y-4 p-0",children:[f&&e.jsx(ae,{className:"p-4 border-2 border-primary",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(X,{children:"Items"}),T.map((t,i)=>e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-12 gap-3 items-end",children:[e.jsx("div",{className:"sm:col-span-8",children:e.jsxs(Ve,{value:t.equipment_id,onValueChange:q=>{r(R=>R.map((Q,J)=>J===i?{...Q,equipment_id:q}:Q))},children:[e.jsx(Ye,{children:e.jsx(Xe,{placeholder:"Select equipment"})}),e.jsx(Ze,{children:o==null?void 0:o.map(q=>e.jsxs(Fe,{value:q.id,children:[q.name," (",q.category,")"]},q.id))})]})}),e.jsx("div",{className:"sm:col-span-3",children:e.jsx(Et,{type:"number",min:"1",value:t.quantity,onChange:q=>{const R=parseInt(q.target.value)||1;r(Q=>Q.map((J,U)=>U===i?{...J,quantity:R}:J))},placeholder:"Quantity"})}),e.jsx("div",{className:"sm:col-span-1 flex justify-end",children:e.jsx(_,{type:"button",variant:"ghost",size:"icon",onClick:()=>r(q=>q.filter((R,Q)=>Q!==i)),disabled:T.length===1,title:T.length===1?"At least one item required":"Remove item",className:"w-full sm:w-auto",children:e.jsx(we,{className:"h-4 w-4"})})})]},i)),e.jsx("div",{children:e.jsxs(_,{type:"button",variant:"outline",size:"sm",onClick:()=>r(t=>[...t,{equipment_id:"",quantity:1}]),className:"w-full sm:w-auto",children:[e.jsx(We,{className:"h-4 w-4 mr-2"})," Add another item"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{children:"Start Date"}),e.jsxs(Ke,{children:[e.jsx(Be,{asChild:!0,children:e.jsxs(_,{variant:"outline",className:"w-full justify-start",children:[e.jsx(Ne,{className:"mr-2 h-4 w-4"}),u?g(u,"PPP"):"Select date"]})}),e.jsx(Ue,{className:"w-auto p-0",align:"start",children:e.jsx(Oe,{mode:"single",selected:u,onSelect:E,initialFocus:!0,className:"pointer-events-auto"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{children:"End Date"}),e.jsxs(Ke,{children:[e.jsx(Be,{asChild:!0,children:e.jsxs(_,{variant:"outline",className:"w-full justify-start",children:[e.jsx(Ne,{className:"mr-2 h-4 w-4"}),S?g(S,"PPP"):"Select date"]})}),e.jsx(Ue,{className:"w-auto p-0",align:"start",children:e.jsx(Oe,{mode:"single",selected:S,onSelect:A,initialFocus:!0,className:"pointer-events-auto"})})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{children:"Notes (Vendor/Provider)"}),e.jsx(Pt,{value:b,onChange:t=>k(t.target.value),placeholder:"e.g., Rented from Company XYZ"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{children:"Link to Job (Optional)"}),e.jsxs(Ve,{value:C||"none",onValueChange:t=>{const i=t==="none"?"":t;I(i),i&&h(!1)},children:[e.jsx(Ye,{children:e.jsx(Xe,{placeholder:"Select a job (optional)"})}),e.jsxs(Ze,{children:[e.jsx(Fe,{value:"none",children:"No job (stock extension)"}),M==null?void 0:M.map(t=>{var i;return e.jsxs(Fe,{value:t.id,children:[t.title," - ",t.event_date?g(new Date(t.event_date),"PPP"):"No date",(i=t.locations)!=null&&i.name?` (${t.locations.name})`:""]},t.id)})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($e,{id:"is-stock-extension",checked:F,onCheckedChange:t=>{h(t),t&&(I(""),x(!1))}}),e.jsx(X,{htmlFor:"is-stock-extension",className:"text-sm font-normal cursor-pointer",children:"Long-term stock extension (not tied to a specific job)"})]}),C&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($e,{id:"auto-transport",checked:v,onCheckedChange:t=>x(t)}),e.jsx(X,{htmlFor:"auto-transport",className:"text-sm font-normal cursor-pointer",children:"Automatically create transport request for this subrental"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-end gap-2",children:[e.jsx(_,{variant:"outline",onClick:()=>p(!1),className:"w-full sm:w-auto",children:"Cancel"}),e.jsx(_,{onClick:()=>c.mutate(),disabled:!u||!S||T.filter(t=>t.equipment_id&&(t.quantity??0)>0).length===0,className:"w-full sm:w-auto",children:"Add Sub-Rental"})]})]})}),e.jsxs("div",{className:"space-y-3",children:[n.map(t=>e.jsxs(ae,{className:"p-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"font-medium text-sm sm:text-base",children:[g(new Date(t.start),"PPP")," → ",g(new Date(t.end),"PPP")]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Total: +",t.total," units"]}),t.notes&&e.jsx("div",{className:"text-sm text-muted-foreground italic",children:t.notes})]}),e.jsx("div",{className:"mt-3 space-y-2",children:t.items.map(i=>{var q,R;return e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between border rounded-md p-3",children:[e.jsx("div",{className:"text-sm",children:e.jsxs("div",{children:["+",i.quantity," · ",(q=i.equipment)==null?void 0:q.name," (",(R=i.equipment)==null?void 0:R.category,")"]})}),e.jsx(_,{variant:"ghost",size:"icon",onClick:()=>w.mutate(i.id),title:"Remove sub-rental item",className:"self-end md:self-auto",children:e.jsx(we,{className:"h-4 w-4"})})]},i.id)})})]},t.batchId)),s.length===0&&!f&&e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"No sub-rentals active"})]})]})})]})})}function qt(){const[l,y]=N.useState(!1);return e.jsxs(Ce,{open:l,onOpenChange:y,children:[e.jsx(ct,{asChild:!0,children:e.jsxs(_,{variant:"outline",className:"w-full justify-start border-dashed border-purple-500/50 hover:border-purple-500 hover:bg-purple-500/10 text-purple-400",children:[e.jsx(xs,{className:"mr-2 h-4 w-4"}),"Manage Sub-Rentals"]})}),e.jsxs(qe,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(_e,{children:[e.jsx(ke,{children:"Sub-Rental Management"}),e.jsx(dt,{children:"Manage temporary stock boosts and sub-rentals."})]}),e.jsx("div",{className:"mt-4",children:e.jsx(vs,{})})]})]})}const it={sound:"Sonido",lights:"Luces"};function ws({selectedDate:l,onDateSelect:y,jobs:d,assignedPresets:m,logoMap:f,isAdmin:p,department:j,onDepartmentChange:z}){const T=N.useRef(null),[r,u]=N.useState(!1),[E,S]=N.useState(!1),[A,b]=N.useState(!1),k=Array.from({length:6},(v,x)=>{const F=at(l,2);return rt(F,x)}),C=()=>{y(at(l,1))},I=()=>{y(rt(l,1))};return e.jsxs("div",{className:"flex flex-col min-h-screen bg-[#05070a] -mx-3 -mt-4 -mb-[calc(4.5rem+env(safe-area-inset-bottom))]",children:[e.jsx("div",{className:"bg-[#0f1219] border-b border-[#1f232e] p-4 sticky top-0 z-20",children:e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h1",{className:"text-lg font-bold text-white",children:["Disponibilidad · ",it[j]]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{variant:"outline",size:"sm",onClick:()=>b(!0),className:"text-xs",children:"Tabla Semanal"}),e.jsxs(ge,{open:r,onOpenChange:u,children:[e.jsx(Ie,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"icon",className:"h-9 w-9",children:e.jsx(hs,{className:"h-5 w-5"})})}),e.jsxs(je,{side:"right",className:"w-[300px] bg-[#0f1219] border-l border-[#1f232e]",children:[e.jsx(be,{className:"mb-6",children:e.jsx(ve,{className:"text-white",children:"Acciones"})}),e.jsxs("div",{className:"space-y-3",children:[p&&e.jsxs("div",{className:"space-y-2 pb-4 border-b border-[#1f232e]",children:[e.jsx("p",{className:"text-xs text-slate-400 font-medium uppercase",children:"Departamento"}),e.jsx("div",{className:"flex gap-2",children:Object.entries(it).map(([v,x])=>e.jsx(_,{variant:j===v?"default":"outline",size:"sm",onClick:()=>{z(v),u(!1)},className:"flex-1",children:x},v))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-slate-400 font-medium uppercase mb-3",children:"Gestión"}),e.jsx("div",{onClick:()=>u(!1),children:e.jsx(wt,{})}),e.jsxs(_,{variant:"outline",size:"sm",className:"w-full justify-start gap-2",onClick:()=>{S(!0),u(!1)},children:[e.jsx(vt,{className:"h-4 w-4"}),"Gestionar Presets"]}),e.jsx("div",{onClick:()=>u(!1),children:e.jsx(qt,{})})]})]})]})]})]})]})}),e.jsxs("div",{className:"bg-[#0f1219] border-b border-[#1f232e] px-2 py-3 sticky top-[64px] z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3 px-2",children:[e.jsx(_,{variant:"ghost",size:"icon",onClick:C,className:"h-8 w-8",children:e.jsx(Le,{className:"h-4 w-4"})}),e.jsx("span",{className:"font-medium text-sm capitalize",children:g(l,"MMMM yyyy",{locale:Y})}),e.jsx(_,{variant:"ghost",size:"icon",onClick:I,className:"h-8 w-8",children:e.jsx(bt,{className:"h-4 w-4"})})]}),e.jsx("div",{ref:T,className:"flex overflow-x-auto gap-2 pb-2 hide-scrollbar snap-x px-1",children:k.map(v=>{const x=nt(v,l),F=nt(v,new Date);return e.jsxs("button",{onClick:()=>y(v),className:K("flex flex-col items-center justify-center min-w-[50px] h-[70px] rounded-xl transition-all snap-center border",x?"bg-blue-600 border-blue-500 text-white shadow-lg shadow-blue-900/20":"bg-[#1a1d24] border-[#2a2e3b] text-slate-400 hover:bg-[#252932]",F&&!x&&"border-blue-500/50 text-blue-400"),children:[e.jsx("span",{className:"text-[10px] uppercase font-medium mb-1",children:g(v,"EEE",{locale:Y})}),e.jsx("span",{className:K("text-xl font-bold",x?"text-white":"text-slate-200"),children:g(v,"d")})]},v.toISOString())})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 pb-32 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold text-white",children:g(l,"EEEE, d MMMM",{locale:Y})}),e.jsxs(de,{variant:"outline",className:"bg-[#1a1d24] border-[#2a2e3b]",children:[d.length+((m==null?void 0:m.length)||0)," Eventos"]})]}),d.length>0?e.jsx("div",{className:"space-y-2",children:d.map(v=>{var F;const x=f[v.id];return e.jsxs("div",{className:"bg-[#0f1219] border border-[#1f232e] rounded-lg p-3 flex items-start gap-3 shadow-sm",children:[x?e.jsx("img",{src:x,alt:"logo",width:40,height:40,loading:"lazy",decoding:"async",className:"h-10 w-10 rounded-md object-cover border border-[#2a2e3b]"}):e.jsx("div",{className:"h-10 w-10 rounded-md bg-[#1a1d24] flex items-center justify-center border border-[#2a2e3b] text-base font-bold text-slate-500",children:String(v.title||"?").slice(0,1).toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-[15px] font-semibold text-white truncate",children:v.title}),((F=v.location)==null?void 0:F.name)&&e.jsx("p",{className:"text-xs text-slate-400 truncate",children:v.location.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1.5",children:[e.jsx(de,{variant:"secondary",className:"text-[10px] bg-blue-500/10 text-blue-400 border-blue-500/20 hover:bg-blue-500/20",children:g(new Date(v.start_time),"HH:mm")}),v.status&&e.jsx(de,{variant:"outline",className:"text-[10px] border-[#2a2e3b] text-slate-400",children:v.status})]})]})]},v.id)})}):m&&m.length>0?e.jsx("div",{className:"space-y-2",children:m.map(v=>{var M,s,n;const x=(M=v==null?void 0:v.preset)==null?void 0:M.job,F=(x==null?void 0:x.title)||((s=v==null?void 0:v.preset)==null?void 0:s.name),h=(n=x==null?void 0:x.location)==null?void 0:n.name,o=x!=null&&x.id?f[x.id]:void 0;return e.jsxs("div",{className:"bg-[#0f1219] border border-[#1f232e] rounded-lg p-3 flex items-start gap-3 shadow-sm",children:[o?e.jsx("img",{src:o,alt:"logo",width:40,height:40,loading:"lazy",decoding:"async",className:"h-10 w-10 rounded-md object-cover border border-[#2a2e3b]"}):e.jsx("div",{className:"h-10 w-10 rounded-md bg-[#1a1d24] flex items-center justify-center border border-[#2a2e3b] text-base font-bold text-slate-500",children:String(F||"?").slice(0,1).toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-[15px] font-semibold text-white truncate",children:F}),h&&e.jsx("p",{className:"text-xs text-slate-400 truncate",children:h}),e.jsx("div",{className:"mt-1.5",children:e.jsx(de,{variant:"secondary",className:"text-[10px] bg-purple-500/10 text-purple-400 border-purple-500/20",children:"Preset"})})]})]},v.id)})}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-10 text-center space-y-2",children:[e.jsx("div",{className:"h-14 w-14 rounded-full bg-[#1a1d24] flex items-center justify-center",children:e.jsx(Ne,{className:"h-7 w-7 text-slate-600"})}),e.jsx("h3",{className:"text-base font-medium text-slate-300",children:"Sin eventos"}),e.jsx("p",{className:"text-sm text-slate-500 max-w-[200px]",children:"No hay trabajos ni presets asignados para este día."})]})]}),e.jsx("div",{className:"fixed bottom-6 right-6 z-50",children:e.jsxs(ge,{children:[e.jsx(Ie,{asChild:!0,children:e.jsx(_,{size:"icon",className:"h-14 w-14 rounded-full shadow-xl bg-blue-600 hover:bg-blue-500 text-white border-0",children:e.jsx(We,{className:"h-6 w-6"})})}),e.jsxs(je,{side:"bottom",className:"h-[80vh] bg-[#0f1219] border-t border-[#1f232e] rounded-t-2xl",children:[e.jsx(be,{className:"mb-4",children:e.jsx(ve,{className:"text-white",children:"Asignar Preset Rápido"})}),e.jsx(Ct,{selectedDate:l,className:"w-full border-0 shadow-none bg-transparent p-0"})]})]})}),e.jsx(Nt,{open:E,onOpenChange:S,selectedDate:l}),e.jsx(ge,{open:A,onOpenChange:b,children:e.jsxs(je,{side:"bottom",className:"h-[90vh] bg-[#0f1219] border-t border-[#1f232e] rounded-t-2xl overflow-y-auto",children:[e.jsxs(be,{className:"mb-4 flex flex-row items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{variant:"ghost",size:"icon",onClick:()=>b(!1),className:"h-8 w-8",children:e.jsx(Le,{className:"h-5 w-5"})}),e.jsx(ve,{className:"text-white",children:"Resumen Semanal"})]}),e.jsx(_,{variant:"ghost",size:"icon",onClick:()=>b(!1),className:"h-8 w-8",children:e.jsx(Dt,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"pb-6",children:e.jsx(St,{selectedDate:l,onDateChange:y})})]})})]})}const lt={sound:"Sonido",lights:"Luces"};function Ta(){const[l,y]=N.useState(new Date),[d,m]=N.useState(!1);Tt();const{session:f,userDepartment:p,userRole:j}=te(),{toast:z}=ne(),T=He(),r=p==null?void 0:p.toLowerCase(),u=j==="admin",E=j==="management",S=j==="management"&&(r==="sound"||r==="lights"),[A,b]=N.useState("sound");N.useEffect(()=>{u&&r&&(r==="sound"||r==="lights")&&b(r)},[u,r]);const k=u?A:S?r:null;if(E&&!S)return e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 text-center",children:[e.jsx("h1",{className:"text-2xl font-semibold mb-4",children:"Acceso restringido"}),e.jsx("p",{className:"text-muted-foreground max-w-xl",children:"Esta sección solo está disponible para los departamentos de Sonido y Luces. Solicita acceso a uno de estos departamentos para continuar."})]});if(!k)return null;const C=lt[k],I=ut(l),v=mt(l),{data:x=[]}=us(k,I,v),{data:F}=H({queryKey:["preset-assignments",k,l],queryFn:async()=>{if(!l)return null;const{data:s,error:n}=await O.from("day_preset_assignments").select(`
          *,
          preset:presets!inner (
            id,
            name,
            created_by,
            department,
            job_id,
            job:jobs (
              id,
              title,
              location:locations (name)
            )
          )
        `).eq("preset.department",k).eq("date",g(l,"yyyy-MM-dd")).order("order",{ascending:!0});if(n)throw z({variant:"destructive",title:"Error",description:"Could not load preset assignments"}),n;return s},enabled:!!l}),h=N.useMemo(()=>{const s=(F||[]).map(c=>{var w,t;return(t=(w=c==null?void 0:c.preset)==null?void 0:w.job)==null?void 0:t.id}).filter(Boolean),n=(x||[]).map(c=>c.id);return Array.from(new Set([...s,...n]))},[F,x]),[o,M]=N.useState({});return N.useEffect(()=>{let s=!1;const n=Array.from(new Set(h));return(async()=>{for(const c of n){if(o[c])continue;const w=await ms(c);s||M(t=>({...t,[c]:w}))}})(),()=>{s=!0}},[h]),T?e.jsx(et,{department:k,children:e.jsx(ws,{selectedDate:l,onDateSelect:y,jobs:x,assignedPresets:F||[],logoMap:o,isAdmin:u,department:k,onDepartmentChange:b})}):e.jsx(et,{department:k,children:e.jsxs("div",{className:"w-full px-4 py-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h1",{className:"text-2xl font-bold",children:["Disponibilidad · ",C]}),u&&e.jsx("div",{className:"flex gap-2",children:Object.entries(lt).map(([s,n])=>e.jsx(_,{variant:k===s?"default":"outline",size:"sm",onClick:()=>b(s),children:n},s))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(wt,{}),e.jsxs(_,{variant:"outline",size:"sm",onClick:()=>m(!0),children:[e.jsx(vt,{className:"mr-2 h-4 w-4"}),"Gestionar Presets"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-6 items-start",children:[e.jsx("div",{className:"lg:col-span-8 xl:col-span-9 space-y-6",children:e.jsx("div",{className:"rounded-xl border shadow-sm bg-card p-1",children:e.jsx(St,{selectedDate:l,onDateChange:y})})}),e.jsxs("div",{className:"lg:col-span-4 xl:col-span-3 space-y-6",children:[e.jsx("div",{className:"rounded-xl border shadow-sm bg-card",children:e.jsx(ps,{onDateSelect:y,selectedDate:l})}),l&&e.jsxs("div",{className:"rounded-xl border shadow-sm p-4 bg-card",children:[e.jsx("h2",{className:"text-base font-semibold mb-3",children:g(l,"PPP")}),x&&x.length>0?e.jsx("div",{className:"space-y-2",children:x.map(s=>{var t;const n=s.title,c=(t=s.location)==null?void 0:t.name,w=o[s.id];return e.jsxs("div",{className:"flex items-center gap-3 p-2 rounded-lg border bg-accent/10 hover:bg-accent/20 transition-colors",children:[w?e.jsx("img",{src:w,alt:"logo",width:32,height:32,loading:"lazy",decoding:"async",className:"h-8 w-8 rounded-md object-cover border"}):e.jsx("div",{className:"h-8 w-8 rounded-md bg-accent flex items-center justify-center border text-xs font-semibold",children:String(n||"?").slice(0,1).toUpperCase()}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-medium truncate text-sm",children:n}),c&&e.jsx("div",{className:"text-xs text-muted-foreground truncate",children:c})]})]},s.id)})}):F&&F.length>0?e.jsx("div",{className:"space-y-2",children:F.map(s=>{var i,q,R;const n=(i=s==null?void 0:s.preset)==null?void 0:i.job,c=(n==null?void 0:n.title)||((q=s==null?void 0:s.preset)==null?void 0:q.name),w=(R=n==null?void 0:n.location)==null?void 0:R.name,t=n!=null&&n.id?o[n.id]:void 0;return e.jsxs("div",{className:"flex items-center gap-3 p-2 rounded-lg border bg-accent/10 hover:bg-accent/20 transition-colors",children:[t?e.jsx("img",{src:t,alt:"logo",width:32,height:32,loading:"lazy",decoding:"async",className:"h-8 w-8 rounded-md object-cover border"}):e.jsx("div",{className:"h-8 w-8 rounded-md bg-accent flex items-center justify-center border text-xs font-semibold",children:String(c||"?").slice(0,1).toUpperCase()}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-medium truncate text-sm",children:c}),w&&e.jsx("div",{className:"text-xs text-muted-foreground truncate",children:w})]})]},s.id)})}):e.jsx("div",{className:"flex flex-col items-center justify-center py-6 text-center text-muted-foreground bg-accent/5 rounded-lg border border-dashed",children:e.jsx("p",{className:"text-sm",children:"No jobs or presets"})})]}),e.jsxs("div",{className:"rounded-xl border shadow-sm bg-card p-4",children:[e.jsx("h3",{className:"font-semibold mb-3 text-sm",children:"Asignación Rápida"}),e.jsx(Ct,{selectedDate:l})]}),e.jsx(qt,{})]})]}),e.jsx(Nt,{open:d,onOpenChange:m,selectedDate:l})]})})}export{Ta as default};
