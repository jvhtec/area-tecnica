import{u as ye,c as ve,f as Ne,a4 as i,n as c,m as R,j as e,a as Q,B as h,C as K,W as M,Y as G,A as V,L as j,S as H,t as J,v as U,w as W,x as C,I as $,h as B,i as _e,D as Ce,q as we,F as ke,G as Se,ac as Ae,aL as Te}from"./index-NZ6jJLfQ.js";import{u as te}from"./useQuery-kdg2pmgf.js";import{B as I}from"./badge-vNTKF5RD.js";import{C as re}from"./circle-check-C0N48OpO.js";import{C as ie}from"./circle-x-DDzV-xk_.js";import{F as Ee}from"./filter-D0HnK7Nz.js";import{C as qe}from"./circle-alert-LZYNzZ7F.js";import{R as ze}from"./receipt-CWKVL4Rh.js";import{e as Fe}from"./es-CSiFCUGj.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";const De=["admin","management","logistics"],le=[{value:"all",label:"Todos"},{value:"submitted",label:"Pendientes"},{value:"approved",label:"Aprobados"},{value:"draft",label:"Borradores"},{value:"rejected",label:"Rechazados"}],He=()=>{const{userRole:g,isLoading:O}=ye(),X=ve(),x=Ne(),[w,ne]=i.useState("submitted"),[b,ce]=i.useState("all"),[f,oe]=i.useState("all"),[k,de]=i.useState(""),[S,me]=i.useState(""),[A,ue]=i.useState(""),[o,Y]=i.useState(new Set),[d,p]=i.useState(null),[l,Z]=i.useState(null),T=g?De.includes(g):!1;i.useEffect(()=>{!O&&g&&!T&&X("/",{replace:!0})},[T,O,X,g]);const{data:E=[],isLoading:ee}=te({queryKey:["expenses-filter-options"],queryFn:async()=>{const{data:a,error:s}=await R.from("job_expenses").select(`
          job_id,
          technician_id,
          job:jobs(title),
          technician:profiles!job_expenses_technician_id_fkey(first_name,last_name)
        `);if(s)throw s;return a||[]},staleTime:600*1e3}),he=i.useMemo(()=>{const a=new Map;return E.forEach(s=>{var r;if(!s.job_id||a.has(s.job_id))return;const t=(r=s.job)!=null&&r.title?s.job.title:`Job ${s.job_id.substring(0,8)}…`;a.set(s.job_id,t)}),Array.from(a.entries()).map(([s,t])=>({id:s,label:t}))},[E]),xe=i.useMemo(()=>{const a=new Map;return E.forEach(s=>{var r,n;if(!s.technician_id||a.has(s.technician_id))return;const t=[(r=s.technician)==null?void 0:r.first_name,(n=s.technician)==null?void 0:n.last_name].filter(Boolean).join(" ").trim();a.set(s.technician_id,t||s.technician_id)}),Array.from(a.entries()).map(([s,t])=>({id:s,label:t}))},[E]),{data:m=[],isLoading:pe,refetch:q}=te({queryKey:["expenses-page",w,b,f,k,S,A],enabled:T,queryFn:async()=>{let a=R.from("job_expenses").select(`
          id,
          job_id,
          technician_id,
          category_slug,
          expense_date,
          status,
          amount_eur,
          amount_original,
          currency_code,
          description,
          receipt_path,
          job:jobs(title),
          technician:profiles!job_expenses_technician_id_fkey(first_name,last_name),
          category:expense_categories(label_es)
        `).order("expense_date",{ascending:!1}).order("created_at",{ascending:!1});w!=="all"&&(a=a.eq("status",w)),b&&b!=="all"&&(a=a.eq("technician_id",b)),f&&f!=="all"&&(a=a.eq("job_id",f)),k&&(a=a.gte("expense_date",k)),S&&(a=a.lte("expense_date",S));const{data:s,error:t}=await a;if(t)throw t;let r=s||[];if(A.trim()){const n=A.trim().toLowerCase();r=r.filter(u=>{var v,N,_,se;const D=[(v=u.technician)==null?void 0:v.first_name,(N=u.technician)==null?void 0:N.last_name].filter(Boolean).join(" ").toLowerCase(),L=((se=(_=u.job)==null?void 0:_.title)==null?void 0:se.toLowerCase())??"";return D.includes(n)||L.includes(n)||u.category_slug.toLowerCase().includes(n)})}return r}}),je=i.useMemo(()=>m.filter(a=>a.status==="submitted"),[m]),y=i.useMemo(()=>m.reduce((a,s)=>(a.totalCount+=1,a.totalAmount+=s.amount_eur,s.status==="submitted"&&(a.pendingCount+=1,a.pendingAmount+=s.amount_eur),s.status==="approved"&&(a.approvedAmount+=s.amount_eur),a),{totalCount:0,totalAmount:0,pendingCount:0,pendingAmount:0,approvedAmount:0}),[m]),ge=i.useCallback((a,s)=>{s&&Y(t=>{const r=new Set(t);return r.has(a)?r.delete(a):r.add(a),r})},[]),P=i.useCallback(()=>Y(new Set),[]),z=i.useCallback(async()=>{await Promise.all([x.invalidateQueries({queryKey:["job-expenses"]}),x.invalidateQueries({queryKey:["job-tech-payout"]}),x.invalidateQueries({queryKey:["job-totals"]}),x.invalidateQueries({queryKey:["dashboard-expenses-summary"]}),x.invalidateQueries({queryKey:["expenses-page"]})])},[x]),be=i.useCallback(async a=>{if(!a.receipt_path){c.warning("Este gasto no tiene recibo adjunto");return}Z({expenseId:a.id,loading:!0});try{const{data:s,error:t}=await R.storage.from("expense-receipts").createSignedUrl(a.receipt_path,3600);if(t||!(s!=null&&s.signedUrl))throw t||new Error("No se pudo generar el enlace del recibo");window.open(s.signedUrl,"_blank","noopener")}catch{c.error("No se pudo abrir el recibo")}finally{Z(null)}},[]),F=i.useCallback(async(a,s,t)=>{const{error:r}=await R.rpc("approve_job_expense",{p_expense_id:a,p_approved:s,p_rejection_reason:s?null:t??null});if(r)throw r},[]),fe=i.useCallback(async(a,s)=>{if(o.size!==0)try{const t=Array.from(o);await Promise.all(t.map(r=>F(r,a,s))),c.success(a?"Gastos aprobados":"Gastos rechazados"),P(),await z(),q()}catch{c.error("No se pudo completar la operación")}},[F,P,z,q,o]);if(O||!g)return e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsx(Q,{className:"h-6 w-6 animate-spin text-muted-foreground"})});if(!T)return null;const ae=je.length===0;return e.jsxs("div",{className:"p-4 md:p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Gastos de técnicos"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Revisa permisos, recibos y aprueba los gastos presentados por los técnicos."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{variant:"outline",size:"sm",disabled:ae,onClick:()=>fe(!0),children:[e.jsx(re,{className:"h-4 w-4 mr-1"})," Aprobar seleccionados"]}),e.jsxs(h,{variant:"destructive",size:"sm",disabled:ae,onClick:()=>{var s,t;if(o.size===0)return;const a=m.find(r=>o.has(r.id));p({expenseId:Array.from(o)[0],technicianName:a?[(s=a.technician)==null?void 0:s.first_name,(t=a.technician)==null?void 0:t.last_name].filter(Boolean).join(" ")||a.technician_id:"",reason:""})},children:[e.jsx(ie,{className:"h-4 w-4 mr-1"})," Rechazar seleccionados"]})]})]}),e.jsxs(K,{children:[e.jsx(M,{children:e.jsxs(G,{className:"flex items-center gap-2",children:[e.jsx(Ee,{className:"h-5 w-5"})," Filtros"]})}),e.jsxs(V,{className:"grid gap-4 md:grid-cols-5 text-sm",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Estado"}),e.jsxs(H,{value:w,onValueChange:a=>ne(a),children:[e.jsx(J,{children:e.jsx(U,{placeholder:"Estado"})}),e.jsx(W,{children:le.map(a=>e.jsx(C,{value:a.value,children:a.label},a.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Técnico"}),e.jsxs(H,{value:b,onValueChange:ce,disabled:ee,children:[e.jsx(J,{children:e.jsx(U,{placeholder:"Todos"})}),e.jsxs(W,{children:[e.jsx(C,{value:"all",children:"Todos"}),xe.map(a=>e.jsx(C,{value:a.id,children:a.label},a.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Trabajo"}),e.jsxs(H,{value:f,onValueChange:oe,disabled:ee,children:[e.jsx(J,{children:e.jsx(U,{placeholder:"Todos"})}),e.jsxs(W,{children:[e.jsx(C,{value:"all",children:"Todos"}),he.map(a=>e.jsx(C,{value:a.id,children:a.label},a.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Desde"}),e.jsx($,{type:"date",value:k,onChange:a=>de(a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Hasta"}),e.jsx($,{type:"date",value:S,onChange:a=>me(a.target.value)})]}),e.jsxs("div",{className:"md:col-span-2 lg:col-span-3 space-y-2",children:[e.jsx(j,{children:"Búsqueda"}),e.jsx($,{value:A,onChange:a=>ue(a.target.value),placeholder:"Busca por técnico, trabajo o categoría"})]})]})]}),e.jsxs(K,{children:[e.jsx(M,{children:e.jsx(G,{className:"flex items-center gap-2",children:"Resumen"})}),e.jsxs(V,{className:"flex flex-wrap gap-4 text-sm",children:[e.jsxs(I,{variant:"outline",children:["Total: ",y.totalCount," · ",B(y.totalAmount)]}),e.jsxs(I,{variant:"outline",className:"border-amber-500/40 text-amber-600 dark:text-amber-200",children:["Pendientes: ",y.pendingCount," · ",B(y.pendingAmount)]}),e.jsxs(I,{variant:"outline",className:"border-emerald-500/40 text-emerald-600 dark:text-emerald-200",children:["Aprobados: ",B(y.approvedAmount)]})]})]}),e.jsxs(K,{children:[e.jsx(M,{children:e.jsx(G,{children:"Listado de gastos"})}),e.jsx(V,{className:"space-y-3",children:pe?e.jsxs("div",{className:"flex items-center gap-2 text-slate-400",children:[e.jsx(Q,{className:"h-5 w-5 animate-spin"})," Cargando gastos…"]}):m.length===0?e.jsxs("div",{className:"flex items-center gap-2 text-slate-400 text-sm",children:[e.jsx(qe,{className:"h-4 w-4"})," No hay gastos que coincidan con los filtros."]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"text-xs uppercase text-muted-foreground",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 pr-2 text-left w-10",children:"Sel."}),e.jsx("th",{className:"py-2 pr-2 text-left",children:"Técnico"}),e.jsx("th",{className:"py-2 pr-2 text-left",children:"Trabajo"}),e.jsx("th",{className:"py-2 pr-2 text-left",children:"Categoría"}),e.jsx("th",{className:"py-2 pr-2 text-left",children:"Fecha"}),e.jsx("th",{className:"py-2 pr-2 text-right",children:"Importe"}),e.jsx("th",{className:"py-2 pr-2 text-left",children:"Estado"}),e.jsx("th",{className:"py-2 text-left",children:"Acciones"})]})}),e.jsx("tbody",{className:"divide-y divide-border",children:m.map(a=>{var u,D,L,v,N;const s=[(u=a.technician)==null?void 0:u.first_name,(D=a.technician)==null?void 0:D.last_name].filter(Boolean).join(" ").trim()||a.technician_id,t=((L=a.job)==null?void 0:L.title)||`Job ${a.job_id.substring(0,8)}…`,r=a.status==="submitted",n=o.has(a.id);return e.jsxs("tr",{className:"text-xs",children:[e.jsx("td",{className:"py-2 pr-2 align-top",children:e.jsx("input",{type:"checkbox",className:"accent-blue-500",disabled:!r,checked:n,onChange:()=>ge(a.id,r)})}),e.jsxs("td",{className:"py-2 pr-2 align-top",children:[e.jsx("div",{className:"font-medium",children:s}),e.jsx("div",{className:"text-muted-foreground",children:a.technician_id})]}),e.jsxs("td",{className:"py-2 pr-2 align-top",children:[e.jsx("div",{className:"font-medium break-words",children:t}),e.jsx("div",{className:"text-muted-foreground",children:a.job_id})]}),e.jsx("td",{className:"py-2 pr-2 align-top",children:((v=a.category)==null?void 0:v.label_es)||a.category_slug}),e.jsx("td",{className:"py-2 pr-2 align-top",children:_e(new Date(a.expense_date),"PPP",{locale:Fe})}),e.jsxs("td",{className:"py-2 pr-2 align-top text-right font-semibold",children:[B(a.amount_eur),e.jsxs("div",{className:"text-muted-foreground text-[11px]",children:[a.amount_original.toFixed(2)," ",a.currency_code]})]}),e.jsx("td",{className:"py-2 pr-2 align-top",children:e.jsx(I,{variant:"outline",className:a.status==="submitted"?"border-amber-500/40 text-amber-600 dark:text-amber-200":a.status==="approved"?"border-emerald-500/40 text-emerald-600 dark:text-emerald-200":a.status==="rejected"?"border-rose-500/40 text-rose-600 dark:text-rose-300":"border-border",children:((N=le.find(_=>_.value===a.status))==null?void 0:N.label)||a.status})}),e.jsx("td",{className:"py-2 align-top",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"text-blue-600 dark:text-blue-200 hover:text-blue-700 dark:hover:text-blue-100",onClick:()=>be(a),disabled:(l==null?void 0:l.expenseId)===a.id&&l.loading,children:[(l==null?void 0:l.expenseId)===a.id&&l.loading?e.jsx(Q,{className:"h-4 w-4 animate-spin"}):e.jsx(ze,{className:"h-4 w-4 mr-1"}),"Recibo"]}),a.status==="submitted"&&e.jsxs(e.Fragment,{children:[e.jsxs(h,{size:"sm",className:"bg-emerald-600 hover:bg-emerald-500",onClick:async()=>{try{await F(a.id,!0),c.success("Gasto aprobado"),await z(),q()}catch{c.error("No se pudo aprobar el gasto")}},children:[e.jsx(re,{className:"h-4 w-4 mr-1"})," Aprobar"]}),e.jsxs(h,{size:"sm",variant:"destructive",onClick:()=>p({expenseId:a.id,technicianName:s,reason:""}),children:[e.jsx(ie,{className:"h-4 w-4 mr-1"})," Rechazar"]})]})]})})]},a.id)})})]})})})]}),e.jsx(Ce,{open:!!d,onOpenChange:a=>!a&&p(null),children:e.jsxs(we,{className:"max-w-md",children:[e.jsx(ke,{children:e.jsx(Se,{children:"Rechazar gasto"})}),d&&e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("p",{children:["¿Quieres rechazar el gasto presentado por ",e.jsx("strong",{children:d.technicianName}),"? Añade el motivo que verán en el historial."]}),e.jsx(Ae,{value:d.reason,onChange:a=>p(s=>s&&{...s,reason:a.target.value}),placeholder:"Motivo del rechazo",rows:3})]}),e.jsxs(Te,{className:"flex gap-2",children:[e.jsx(h,{variant:"ghost",onClick:()=>p(null),children:"Cancelar"}),e.jsx(h,{variant:"destructive",onClick:async()=>{if(d)try{await F(d.expenseId,!1,d.reason),c.success("Gasto rechazado"),p(null),P(),await z(),q()}catch{c.error("No se pudo rechazar el gasto")}},children:"Rechazar gasto"})]})]})})]})};export{He as default};
