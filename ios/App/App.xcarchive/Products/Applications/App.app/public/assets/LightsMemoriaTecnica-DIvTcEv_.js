import{e as H,r as c,j as e,L as x,I as b,B as p,S as J,t as K,v as Q,w as X,x as y,a as M,s as w}from"./index-NZ6jJLfQ.js";import{P as Y}from"./progress-C8XsV-Me.js";import{R as Z,a as R}from"./radio-group-DzKNHD24.js";import{u as ee,F as T,a as ae}from"./useLogoOptions-BfwIlBcK.js";import{I as D}from"./image--Pql38nK.js";import{F as re}from"./file-B1WzkXfC.js";import{D as se}from"./download-C1rVE0-J.js";import{U as te}from"./upload-DF4rjO7T.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./index-hC3MxXep.js";import"./circle-CWxDyDxx.js";import"./logo-url-cache-eY6nfvu7.js";const le=()=>{var U;const{toast:i}=H(),[m,$]=c.useState(""),[N,_]=c.useState(!1),[G,n]=c.useState(0),[u,S]=c.useState(null),[L,E]=c.useState(null),[j,C]=c.useState("upload"),[g,O]=c.useState(null),{logoOptions:h,isLoading:F}=ee(),[v,z]=c.useState([{id:"material",title:"Listado de Material",file:null,landscape:!1},{id:"weight",title:"Informe de Pesos",file:null,landscape:!1},{id:"power",title:"Informe de Consumos",file:null,landscape:!1},{id:"rigging",title:"Plano de Rigging",file:null,landscape:!0},{id:"memoria_completa",title:"Memoria Técnica Completa",file:null,landscape:!1}]),V=async a=>{if(!a.type.includes("image/")){i({title:"Error",description:"Solo se permiten archivos de imagen",variant:"destructive"});return}try{const s=URL.createObjectURL(a);S({file:a,url:s}),C("upload")}catch{i({title:"Error",description:"Error al procesar la imagen",variant:"destructive"})}},B=a=>{O(a),h.find(r=>r.value===a)&&S(null)},A=async(a,s)=>{if(!a.type.includes("pdf")){i({title:"Error",description:"Solo se permiten archivos PDF",variant:"destructive"});return}try{const r=URL.createObjectURL(a);z(t=>t.map(o=>o.id===s?{...o,file:{file:a,url:r}}:o))}catch{i({title:"Error",description:"Error al procesar el archivo",variant:"destructive"})}},P=async(a,s)=>{const{error:r,data:t}=await w.storage.from("lights-memoria-tecnica").upload(s,a);if(r)throw r;const{data:{publicUrl:o}}=w.storage.from("lights-memoria-tecnica").getPublicUrl(s);return o},W=async()=>{if(!m.trim()){i({title:"Error",description:"Por favor, ingrese el nombre del proyecto",variant:"destructive"});return}const a=v.find(r=>r.id==="memoria_completa"&&r.file!==null),s=v.filter(r=>r.id!=="memoria_completa"&&r.file!==null).length>0;if(!a&&!s){i({title:"Error",description:"Por favor, suba al menos un documento o la memoria técnica completa",variant:"destructive"});return}_(!0),n(0),E(null);try{let r=null;if(j==="upload"&&u)try{const l=`${m}/logo_${Date.now()}.${u.file.name.split(".").pop()}`;r=await P(u.file,l),n(10)}catch{i({title:"Warning",description:"No se pudo subir el logo, continuando sin él"})}else if(j==="existing"&&g){const l=h.find(d=>d.value===g);r=(l==null?void 0:l.url)||null,n(10)}const t={},o=v.filter(l=>l.file!==null);for(let l=0;l<o.length;l++){const d=o[l];if(d.file)try{const k=`${m}/${d.id}_${Date.now()}.pdf`,q=await P(d.file.file,k);t[d.id]=q,n((l+1)/o.length*50)}catch{i({title:"Error",description:`Error al subir el documento ${d.title}`,variant:"destructive"});return}}n(60);const f=await w.functions.invoke("generate-lights-memoria-tecnica",{body:{documentUrls:t,projectName:m,logoUrl:r}});if(f.error)throw new Error(f.error.message||"Error al generar la memoria técnica");n(80);const{error:I}=await w.from("lights_memoria_tecnica_documents").insert({project_name:m,logo_url:r,material_list_url:t.material,weight_report_url:t.weight,power_report_url:t.power,rigging_plot_url:t.rigging,memoria_completa_url:t.memoria_completa,final_document_url:f.data.url});if(I)throw I;n(100),E(f.data.url),i({title:"Éxito",description:"Memoria técnica generada correctamente"}),window.open(f.data.url,"_blank")}catch(r){i({title:"Error",description:r.message||"Error al generar la memoria técnica",variant:"destructive"})}finally{_(!1),n(0)}};return e.jsx("div",{className:"h-[calc(100vh-6rem)] overflow-y-auto",children:e.jsx("div",{className:"max-w-3xl mx-auto p-6 space-y-6",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Memoria Técnica de Iluminación"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"projectName",children:"Nombre del Proyecto"}),e.jsx(b,{id:"projectName",value:m,onChange:a=>$(a.target.value),placeholder:"Ingrese el nombre del proyecto"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Logo"}),e.jsxs(Z,{value:j,onValueChange:a=>C(a),className:"flex items-center space-x-6 mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{value:"upload",id:"r-upload"}),e.jsx(x,{htmlFor:"r-upload",children:"Subir nuevo logo"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{value:"existing",id:"r-existing"}),e.jsx(x,{htmlFor:"r-existing",children:"Usar logo existente"})]})]}),j==="upload"?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{type:"file",accept:"image/*",className:"hidden",id:"logo-upload",onChange:a=>{var r;const s=(r=a.target.files)==null?void 0:r[0];s&&V(s)}}),e.jsx(p,{variant:"outline",asChild:!0,className:"w-full",children:e.jsx("label",{htmlFor:"logo-upload",className:"cursor-pointer flex items-center justify-center gap-2",children:u?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-4 w-4"}),"Logo cargado"]}):e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"h-4 w-4"}),"Subir logo"]})})}),u&&e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>window.open(u.url,"_blank"),children:e.jsx(D,{className:"h-4 w-4"})})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs(J,{value:g||"",onValueChange:B,disabled:F,children:[e.jsx(K,{className:"w-full",children:e.jsx(Q,{placeholder:"Selecciona un logo existente"})}),e.jsx(X,{children:F?e.jsxs(y,{value:"loading",disabled:!0,children:[e.jsx(M,{className:"h-4 w-4 animate-spin mr-2 inline"}),"Cargando logos..."]}):h.length>0?h.map(a=>e.jsx(y,{value:a.value,children:a.label},a.value)):e.jsx(y,{value:"none",disabled:!0,children:"No hay logos disponibles"})})]}),g&&e.jsx("div",{className:"flex justify-center p-2 bg-muted rounded-md",children:e.jsx("img",{src:((U=h.find(a=>a.value===g))==null?void 0:U.url)||"",alt:"Selected logo preview",width:192,height:64,loading:"lazy",decoding:"async",className:"h-16 w-48 object-contain",onError:a=>{a.target.src="/lovable-uploads/ce3ff31a-4cc5-43c8-b5bb-a4056d3735e4.png"}})})]})]}),e.jsx("div",{className:"space-y-4",children:v.map(a=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:a.title}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{type:"file",accept:".pdf",className:"hidden",id:`file-${a.id}`,onChange:s=>{var t;const r=(t=s.target.files)==null?void 0:t[0];r&&A(r,a.id)}}),e.jsx(p,{variant:"outline",asChild:!0,className:"w-full",children:e.jsx("label",{htmlFor:`file-${a.id}`,className:"cursor-pointer flex items-center justify-center gap-2",children:a.file?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-4 w-4"}),"Archivo cargado"]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"h-4 w-4"}),"Subir archivo"]})})}),a.file&&e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>{var s;return window.open((s=a.file)==null?void 0:s.url,"_blank")},children:e.jsx(re,{className:"h-4 w-4"})})]})]},a.id))}),N&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{value:G}),e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"Generando memoria técnica..."})]}),L&&e.jsxs(p,{variant:"outline",className:"w-full",onClick:()=>window.open(L,"_blank"),children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Descargar Memoria Técnica"]}),e.jsx(p,{onClick:W,disabled:N,className:"w-full",children:N?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"h-4 w-4 animate-spin mr-2"}),"Generando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Generar Memoria Técnica"]})})]})]})})})},ve=()=>e.jsx(le,{});export{ve as default};
