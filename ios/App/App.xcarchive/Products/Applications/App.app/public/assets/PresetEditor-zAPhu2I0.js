import{r as a,j as s,D as de,q as he,F as me,G as xe,aK as fe,L as I,S as G,t as Y,v as Z,w as ee,x as z,a as te,aL as je,B as A,a0 as $,I as H,u as ge,C as pe,W as ve,Y as Ne,A as Se,X as ye,s as le}from"./index-NZ6jJLfQ.js";import{S as Pe}from"./scroll-area-BHjMXddA.js";import{r as X}from"./equipment-B5qd5N3O.js";import{u as ae}from"./useQuery-kdg2pmgf.js";import{A as L,a as _}from"./alert-BqA-5jRM.js";import{e as be,g as Fe,p as we}from"./flexPullsheets-DscweXrW.js";import{T as Ee,a as Ce,b as ne,c as re}from"./tabs-BdaywI_b.js";import{T as ie}from"./triangle-alert-D6qN0F8g.js";import{C as se}from"./circle-check-C0N48OpO.js";import{C as ce}from"./circle-x-DDzV-xk_.js";import{U as oe}from"./upload-DF4rjO7T.js";import{u as De}from"./DepartmentContext-CUMyywOO.js";import{S as ke}from"./search-D-OiWg8h.js";import{S as Te}from"./save-z_re-Mcq.js";const Le="2000-01-01T00:00:00.000Z";function _e(t){return t.display_name?t.display_name:t.department?`${t.department.charAt(0).toUpperCase()+t.department.slice(1)} Pullsheet`:"Pullsheet"}function Ae(t){if(t.source==="flex_api"&&t.created_at===Le)return"Unknown";const h=new Date(t.created_at);return Number.isNaN(h.getTime())?"Unknown":h.toLocaleDateString()}function ue({pullsheetUrl:t,onPullsheetUrlChange:h,isPushing:S,isValidUrl:g,elementId:c}){return s.jsxs("div",{className:"space-y-2",children:[s.jsx(I,{htmlFor:"pullsheet-url",children:"Pullsheet URL"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(H,{id:"pullsheet-url",placeholder:"Paste Flex pullsheet URL here...",value:t,onChange:u=>h(u.target.value),disabled:S,className:g?"border-green-500":""}),g&&s.jsx(se,{className:"h-5 w-5 text-green-500 flex-shrink-0 mt-2"})]}),t&&!g&&s.jsx("p",{className:"text-sm text-destructive",children:"Invalid Flex URL format"}),g&&c&&s.jsxs("p",{className:"text-sm text-muted-foreground",children:["Element ID: ",c]})]})}function Ie({open:t,onOpenChange:h,presetItems:S,equipment:g,jobId:c,jobCandidates:u}){const D=a.useRef(!1),[i,B]=a.useState(""),[k,p]=a.useState(!1),[F,m]=a.useState(null),[y,J]=a.useState(!1),[v,T]=a.useState(null),[x,U]=a.useState([]),[q,f]=a.useState([]),[N,w]=a.useState("select"),[E,o]=a.useState([]),[j,P]=a.useState(null),[M,b]=a.useState(!1),[Q,R]=a.useState(null),C=c??Q;a.useEffect(()=>{t||(D.current=!1,B(""),p(!1),m(null),T(null),o([]),P(null),b(!1),R(null),w(c?"select":"url"))},[t,c]),a.useEffect(()=>{t&&(c||!u||u.length!==1||R(u[0].id))},[t,c,u]),a.useEffect(()=>{if(!t)return;if(D.current=!1,!C){w("url"),o([]),P(null),b(!1);return}let e=!0;return(async()=>{b(!0);try{const r=await Fe(C);if(!e)return;o(r);const n=!D.current;r.length===1&&n&&(P(r[0].element_id),m(r[0].element_id)),n&&w(r.length>0?"select":"url")}catch{if(!e)return;$({title:"Error",description:"Failed to load pullsheets for this job",variant:"destructive"})}finally{e&&b(!1)}})(),()=>{e=!1}},[t,C]),a.useEffect(()=>{N==="select"&&j&&m(j)},[N,j]),a.useEffect(()=>{if(N!=="url"||!i){N==="url"&&(p(!1),m(null));return}const e=be(i);e?(m(e),p(!0)):(m(null),p(!1))},[i,N]),a.useEffect(()=>{if(!t||S.length===0){U([]),f([]);return}const e=[],l=[],r=new Map(g.map(n=>[n.id,n]));S.forEach(n=>{const d=r.get(n.equipment_id);if(!d)return;const W=n.subsystem??X(d);d.resource_id?e.push({resourceId:d.resource_id,quantity:n.quantity,name:d.name,category:d.category,subsystem:W}):l.push(d.name)}),U(e),f(l)},[t,S,g]);const K=async()=>{if(!(!F||x.length===0)){J(!0),T(null);try{const e=await we(F,x);T(e),e.failed.length===0?($({title:"Success",description:`Successfully pushed ${e.succeeded} items to Flex pullsheet`}),setTimeout(()=>h(!1),2e3)):e.succeeded>0?$({title:"Partial Success",description:`Pushed ${e.succeeded} items, ${e.failed.length} failed`,variant:"destructive"}):$({title:"Failed",description:"Failed to push any items to Flex",variant:"destructive"})}catch(e){$({title:"Error",description:e instanceof Error?e.message:"Failed to push equipment to Flex",variant:"destructive"})}finally{J(!1)}}},V=e=>{if(e){h(!0);return}y||h(!1)},O=!!(F&&x.length>0&&!y&&(N==="url"?k:C&&j));return s.jsx(de,{open:t,onOpenChange:V,children:s.jsxs(he,{className:"sm:max-w-[550px]",children:[s.jsxs(me,{children:[s.jsx(xe,{children:"Push Equipment Preset to Flex Pullsheet"}),s.jsx(fe,{children:c?"Select an existing pullsheet or enter a Flex pullsheet URL to add equipment items":"Enter the Flex pullsheet URL to add equipment items as line items"})]}),s.jsxs("div",{className:"space-y-4 py-4",children:[!c&&u&&u.length>0&&s.jsxs("div",{className:"space-y-2",children:[s.jsx(I,{htmlFor:"job-select",children:"Job"}),s.jsxs(G,{value:Q||"",onValueChange:e=>{R(e),o([]),P(null),m(null)},children:[s.jsx(Y,{id:"job-select",children:s.jsx(Z,{placeholder:"Select a job..."})}),s.jsx(ee,{children:u.map(e=>s.jsx(z,{value:e.id,children:e.title},e.id))})]})]}),C?s.jsxs(Ee,{value:N,onValueChange:e=>{D.current=!0,w(e)},children:[s.jsxs(Ce,{className:"grid w-full grid-cols-2",children:[s.jsxs(ne,{value:"select",disabled:E.length===0&&!M,children:["Select Pullsheet ",E.length>0&&`(${E.length})`]}),s.jsx(ne,{value:"url",children:"Enter URL"})]}),s.jsx(re,{value:"select",className:"space-y-2",children:M?s.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground py-4",children:[s.jsx(te,{className:"h-4 w-4 animate-spin"}),"Loading pullsheets..."]}):E.length===0?s.jsxs(L,{children:[s.jsx(ie,{className:"h-4 w-4"}),s.jsx(_,{children:"No pullsheets found for this job. Create pullsheets first or use the URL input option."})]}):s.jsxs(s.Fragment,{children:[s.jsx(I,{htmlFor:"pullsheet-select",children:"Available Pullsheets"}),s.jsxs(G,{value:j||"",onValueChange:P,children:[s.jsx(Y,{id:"pullsheet-select",children:s.jsx(Z,{placeholder:"Select a pullsheet..."})}),s.jsx(ee,{children:E.map(e=>s.jsxs(z,{value:e.element_id,children:[_e(e)," ",s.jsxs("span",{className:"text-xs text-muted-foreground",children:[e.source==="flex_api"&&"(from Flex) ","(",Ae(e),")"]})]},e.id))})]}),j&&s.jsxs("p",{className:"text-sm text-muted-foreground",children:["Element ID: ",j]})]})}),s.jsx(re,{value:"url",children:s.jsx(ue,{pullsheetUrl:i,onPullsheetUrlChange:e=>B(e),isPushing:y,isValidUrl:k,elementId:F})})]}):s.jsx(ue,{pullsheetUrl:i,onPullsheetUrlChange:e=>B(e),isPushing:y,isValidUrl:k,elementId:F}),x.length>0&&s.jsxs(L,{children:[s.jsx(se,{className:"h-4 w-4"}),s.jsxs(_,{children:["Ready to push ",x.length," equipment items (",x.reduce((e,l)=>e+l.quantity,0)," total units)"]})]}),q.length>0&&s.jsxs(L,{variant:"destructive",children:[s.jsx(ie,{className:"h-4 w-4"}),s.jsxs(_,{children:[q.length," items will be skipped (no Flex resource ID):",s.jsx("div",{className:"mt-1 text-xs max-h-20 overflow-y-auto",children:q.join(", ")})]})]}),x.length===0&&S.length>0&&s.jsxs(L,{variant:"destructive",children:[s.jsx(ce,{className:"h-4 w-4"}),s.jsx(_,{children:"No equipment items are linked to Flex resources. Please map equipment models to Flex resources first."})]}),v&&s.jsxs("div",{className:"space-y-2",children:[v.succeeded>0&&s.jsxs(L,{children:[s.jsx(se,{className:"h-4 w-4"}),s.jsxs(_,{children:["Successfully pushed ",v.succeeded," items to Flex pullsheet"]})]}),v.failed.length>0&&s.jsxs(L,{variant:"destructive",children:[s.jsx(ce,{className:"h-4 w-4"}),s.jsxs(_,{children:[v.failed.length," items failed:",s.jsx("div",{className:"mt-1 text-xs max-h-20 overflow-y-auto",children:v.failed.map((e,l)=>s.jsxs("div",{children:[e.name,": ",e.error]},l))})]})]})]})]}),s.jsxs(je,{children:[s.jsx(A,{variant:"outline",onClick:()=>V(!1),disabled:y,children:"Cancel"}),s.jsx(A,{onClick:K,disabled:!O,children:y?s.jsxs(s.Fragment,{children:[s.jsx(te,{className:"h-4 w-4 mr-2 animate-spin"}),"Pushing ",x.length," items..."]}):s.jsxs(s.Fragment,{children:[s.jsx(oe,{className:"h-4 w-4 mr-2"}),"Push Items"]})})]})]})})}const ze=({preset:t,isCopy:h=!1,onSave:S,onCancel:g,fixedTourId:c,jobId:u,jobCandidates:D,allowedCategories:i})=>{const{session:B}=ge(),{department:k}=De(),[p,F]=a.useState((t==null?void 0:t.name)||""),[m,y]=a.useState(c??(t==null?void 0:t.tour_id)??void 0),[J,v]=a.useState(!1),[T,x]=a.useState(()=>!(i!=null&&i.length)),[U,q]=a.useState(""),[f,N]=a.useState(()=>t!=null&&t.items?t.items.reduce((e,l)=>(e[l.equipment_id]=l.quantity,e),{}):{}),[w,E]=a.useState(()=>t!=null&&t.items?t.items.reduce((e,l)=>(e[l.equipment_id]=l.subsystem??X(l.equipment)??null,e),{}):{}),{data:o}=ae({queryKey:["equipment",k],queryFn:async()=>{const{data:e,error:l}=await le.from("equipment").select("*").eq("department",k).order("name");if(l)throw l;return e}}),j=a.useMemo(()=>{var e;return new Map(((e=t==null?void 0:t.items)==null?void 0:e.map(l=>[l.equipment_id,l.source??null]))??[])},[t==null?void 0:t.items]),P=a.useMemo(()=>new Map((o||[]).map(e=>[e.id,e])),[o]),M=e=>w[e]??X(P.get(e))??null,{data:b}=ae({queryKey:["tours"],queryFn:async()=>{const{data:e,error:l}=await le.from("tours").select("id, name, status").order("name");if(l)throw l;return e},enabled:!c}),Q=(e,l)=>{const r=parseInt(l)||0;if(r>=0){if(w[e]===void 0){const n=X(P.get(e));n&&E(d=>({...d,[e]:n}))}N(n=>({...n,[e]:r}))}},R=()=>{if(!p.trim())return;const e=new Date().toISOString(),l=Object.entries(f).filter(([r,n])=>n>0).map(([r,n])=>({equipment_id:r,quantity:n,subsystem:M(r),source:j.get(r)??"manual",notes:"",created_at:e,updated_at:e}));S(p,l,(c??m)||null)},C=()=>{v(!0)},K=Object.entries(f).filter(([e,l])=>l>0).map(([e,l])=>({id:`temp-${e}`,preset_id:(t==null?void 0:t.id)||"temp",equipment_id:e,quantity:l,subsystem:M(e),source:j.get(e)??"manual",notes:"",created_at:new Date().toISOString(),updated_at:new Date().toISOString()})),V=!!(i!=null&&i.length&&!T),O=o==null?void 0:o.filter(e=>{var W;const l=U.toLowerCase();if(!(e.name.toLowerCase().includes(l)||((W=e.category)==null?void 0:W.toLowerCase().includes(l))))return!1;if(!V)return!0;const n=e.category?i.includes(e.category):!1,d=(f[e.id]||0)>0;return n||d}).sort((e,l)=>{const r=(f[e.id]||0)>0,n=(f[l.id]||0)>0;return r&&!n?-1:!r&&n?1:e.name.localeCompare(l.name)});return s.jsxs(pe,{className:"w-full h-[600px] bg-card/80 backdrop-blur-sm flex flex-col overflow-hidden",children:[s.jsx(ve,{className:"flex-shrink-0",children:s.jsx(Ne,{children:h?"Copy Preset":t?"Edit Preset":"Create New Preset"})}),s.jsx(Se,{className:"flex-1 flex flex-col min-h-0 overflow-hidden",children:s.jsxs("div",{className:"flex flex-col h-full gap-4",children:[s.jsxs("div",{className:"flex-shrink-0",children:[s.jsx(I,{htmlFor:"preset-name",children:"Preset Name"}),s.jsx(H,{id:"preset-name",value:p,onChange:e=>F(e.target.value),placeholder:"Enter preset name...",className:"mt-1"})]}),!c&&s.jsxs("div",{className:"flex-shrink-0",children:[s.jsx(I,{children:"Tour (optional)"}),s.jsxs(G,{value:m??"no-tour",onValueChange:e=>y(e==="no-tour"?null:e),children:[s.jsx(Y,{className:"mt-1",children:s.jsx(Z,{placeholder:"No tour (standalone preset)"})}),s.jsxs(ee,{children:[s.jsx(z,{value:"no-tour",children:"No tour"}),b==null?void 0:b.map(e=>s.jsx(z,{value:e.id,children:e.name},e.id))]})]})]}),s.jsx("div",{className:"relative flex-shrink-0",children:s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("div",{className:"relative flex-1",children:[s.jsx(ke,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(H,{placeholder:"Search equipment...",value:U,onChange:e=>q(e.target.value),className:"pl-9"})]}),i!=null&&i.length?s.jsx(A,{type:"button",variant:"outline",onClick:()=>x(e=>!e),className:"flex-shrink-0",children:T?"PA only":"All"}):null]})}),s.jsx(Pe,{className:"flex-1 min-h-0 pr-4",children:s.jsx("div",{className:"space-y-2",children:O==null?void 0:O.map(e=>{const l=(f[e.id]||0)>0;return s.jsxs("div",{className:`flex items-center space-x-4 p-2 rounded-md ${l?"bg-primary/10":""}`,children:[s.jsxs("div",{className:"flex-1",children:[s.jsx(I,{children:e.name}),e.category&&s.jsx("p",{className:"text-sm text-muted-foreground",children:e.category})]}),s.jsx(H,{type:"number",min:"0",value:f[e.id]||0,onChange:r=>Q(e.id,r.target.value),className:"w-24"})]},e.id)})})}),s.jsxs("div",{className:"flex gap-2 pt-2 flex-shrink-0",children:[s.jsxs(A,{variant:"outline",onClick:g,className:"flex-shrink-0",children:[s.jsx(ye,{className:"mr-2 h-4 w-4"}),"Cancel"]}),s.jsxs(A,{variant:"outline",onClick:C,disabled:K.length===0,className:"flex-1",children:[s.jsx(oe,{className:"mr-2 h-4 w-4"}),"Push to Flex Pullsheet"]}),s.jsxs(A,{onClick:R,disabled:!p.trim(),className:"flex-shrink-0",children:[s.jsx(Te,{className:"mr-2 h-4 w-4"}),"Save Preset"]})]})]})}),s.jsx(Ie,{open:J,onOpenChange:v,presetItems:K,equipment:o||[],jobId:u,jobCandidates:D})]})};export{ze as P};
