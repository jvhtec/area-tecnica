import{f as M,n as N,m,r as H,j as e,C as L,W as P,Y as F,A as J,L as X,h as b,B as q,I as $}from"./index-NZ6jJLfQ.js";import{B as j}from"./badge-vNTKF5RD.js";import{S as W}from"./separator-E-JdTFOv.js";import{u as B}from"./useQuery-kdg2pmgf.js";import{u as D}from"./useMutation-DluhVBs1.js";import{R as S}from"./ratesQueryKeys-DgMsgg6U.js";import{E as G}from"./euro-DgRTeGAz.js";import{M as V}from"./minus-InO4I9Ks.js";import{P as Z}from"./plus-C3JQqq7t.js";import{C as T}from"./circle-alert-LZYNzZ7F.js";function I(r,a){return B({queryKey:["job-extras",r,a],queryFn:async()=>{let i=m.from("job_rate_extras").select("*").eq("job_id",r);a&&(i=i.eq("technician_id",a));const{data:u,error:o}=await i;if(o)throw o;return u||[]},enabled:!!r,staleTime:30*1e3})}const ee=(r,a)=>{r.invalidateQueries({queryKey:["job-extras",a]}),r.invalidateQueries({queryKey:["tour-job-rate-quotes"]}),r.invalidateQueries({queryKey:["technician-tour-rate-quotes"]}),r.invalidateQueries({queryKey:["job-tech-payout",a]}),r.invalidateQueries({queryKey:["job-approval-status",a]}),r.invalidateQueries({queryKey:S.approvals})};function te(){const r=M();return D({mutationFn:async({jobId:a,technicianId:i,extraType:u,quantity:o,amountOverrideEur:y})=>{var d;const{data:g}=await m.auth.getUser();if(!((d=g.user)!=null&&d.id))throw new Error("Not authenticated");const v=new Date().toISOString();if(o===0){const{error:f}=await m.from("job_rate_extras").delete().eq("job_id",a).eq("technician_id",i).eq("extra_type",u);if(f)throw f;return{job_id:a,technician_id:i,extra_type:u,quantity:0,status:"approved",updated_at:v}}const{data:x,error:p}=await m.from("job_rate_extras").upsert({job_id:a,technician_id:i,extra_type:u,quantity:o,amount_override_eur:y,status:"approved",updated_by:g.user.id,updated_at:v}).select().single();if(p)throw p;return x},onSuccess:a=>{ee(r,a.job_id),N.success("Extra saved successfully")},onError:a=>{N.error("Failed to save extra")}})}const C={travel_half:"Half Travel Day",travel_full:"Full Travel Day",day_off:"Day Off"},R={travel_half:2,travel_full:1,day_off:1};function ae(){return B({queryKey:S.extrasCatalog,queryFn:async()=>{const{data:r,error:a}=await m.from("rate_extras_2025").select("*").order("extra_type",{ascending:!0});if(a)throw a;return r||[]},staleTime:60*1e3})}function xe(){const r=M();return D({mutationFn:async({extra_type:a,amount_eur:i})=>{const{data:u,error:o}=await m.from("rate_extras_2025").upsert({extra_type:a,amount_eur:i}).select().single();if(o)throw o;return u},onSuccess:()=>{r.invalidateQueries({queryKey:S.extrasCatalog}),N.success("Extras catalog updated")},onError:a=>{N.error("Failed to update extras amount")}})}function fe({jobId:r,technicianId:a,technicianName:i,isManager:u=!1,showVehicleDisclaimer:o=!1,vehicleDisclaimerText:y}){const{data:g=[],isLoading:v}=I(r,a),{data:x=[],isLoading:p}=ae(),d=te(),[f,A]=H.useState({}),U=t=>g.find(s=>s.extra_type===t),w=t=>{var s;return((s=U(t))==null?void 0:s.quantity)??0},Y=t=>f[t]??w(t),Q=(t,s)=>{const n=R[t],c=Math.max(0,Math.min(s,n));A(h=>({...h,[t]:c}))},_=async(t,s)=>{try{await d.mutateAsync({jobId:r,technicianId:a,extraType:t,quantity:s}),A(n=>{const c={...n};return delete c[t],c})}catch{}};function K(t){const s=x==null?void 0:x.find(n=>n.extra_type===t);return(s==null?void 0:s.amount_eur)??0}const k=Object.keys(C).reduce((t,s)=>{const n=w(s),c=K(s);return t+n*c},0);return v||p?e.jsxs(L,{className:"bg-card border-border text-card-foreground",children:[e.jsx(P,{children:e.jsx(F,{className:"text-sm",children:"Job Extras"})}),e.jsx(J,{children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading..."})})]}):e.jsxs(L,{className:"bg-card border-border text-card-foreground",children:[e.jsx(P,{children:e.jsxs(F,{className:"text-sm flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),"Job Extras - ",i]})}),e.jsxs(J,{className:"space-y-4",children:[Object.keys(C).map(t=>{const s=w(t),n=Y(t),c=f[t]!==void 0,h=R[t],E=K(t),O=s*E,z=n*E;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx(X,{className:"text-sm font-medium",children:C[t]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(j,{variant:"outline",className:"text-xs",children:[b(E)," each"]}),s>0&&e.jsxs(j,{variant:"secondary",className:"text-xs",children:["Current: ",s]})]})]}),u?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(q,{variant:"outline",size:"sm",onClick:()=>Q(t,n-1),disabled:n<=0||d.isPending,className:"bg-muted border-border",children:e.jsx(V,{className:"h-3 w-3"})}),e.jsx($,{type:"number",min:"0",max:h,value:n,onChange:l=>Q(t,parseInt(l.target.value)||0),onBlur:()=>{c&&_(t,n)},onKeyDown:l=>{l.key==="Enter"&&c&&_(t,n)},disabled:d.isPending,className:"w-20 text-center bg-background border-input"}),e.jsx(q,{variant:"outline",size:"sm",onClick:()=>{const l=n+1;Q(t,l),_(t,l)},disabled:n>=h||d.isPending,className:"bg-muted border-border",children:e.jsx(Z,{className:"h-3 w-3"})}),e.jsx(j,{variant:"secondary",className:"ml-auto",children:b(z)})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["Max ",h]}),c&&e.jsx(q,{size:"sm",variant:"default",onClick:()=>_(t,n),disabled:d.isPending,className:"bg-blue-600 hover:bg-blue-500 text-white",children:d.isPending?"Saving...":"Save"})]})]}):e.jsx("div",{className:"space-y-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:s>0?`${s} Ã— ${b(E)}`:"None"}),s>0&&e.jsx(j,{variant:"secondary",className:"",children:b(O)})]})})]},t)}),k>0&&e.jsxs(e.Fragment,{children:[e.jsx(W,{}),e.jsxs("div",{className:"flex items-center justify-between font-medium",children:[e.jsx("span",{children:"Total Extras:"}),e.jsx(j,{variant:"default",className:"text-sm",children:b(k)})]})]}),o&&y&&e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg text-amber-700 dark:text-amber-200",children:[e.jsx(T,{className:"h-4 w-4 text-amber-600 dark:text-amber-300 mt-0.5 shrink-0"}),e.jsx("p",{className:"text-sm",children:y})]})]})]})}export{fe as J,ae as a,xe as b,I as u};
