import{r as k,f as ve,s as g,n as xe,e as Se,u as Pe,i as re,j as l,D as Ee,q as Ce,F as Fe,G as Ne,B as ae,R as ke,aK as je,a as Re,L as ce,S as ue,t as fe,v as me,w as pe,p as he,x as ee,aL as Le}from"./index-NZ6jJLfQ.js";import{A as Ae,h as Te,a as qe,b as Me,c as Oe,d as ze,e as Ge,f as He,g as Ve}from"./alert-dialog-CtyYUxwH.js";import{u as Be,a as Je}from"./useJobAssignmentsRealtime-7FZn5naq.js";import{u as $e}from"./useQuery-kdg2pmgf.js";import{g as Ke}from"./technicianAvailability-gbYgVBKV.js";import{u as Ue}from"./useJobRequiredRoles-Bz0ibKHS.js";import{g as Qe}from"./roleCategory-BtQgWHfO.js";import{E as We}from"./external-link-QJoXZ6ES.js";import{c as q}from"./api-C9EDenHJ.js";import{F as m,D as K,R as z,a as G}from"./constants-DoXhG9KB.js";import{a as Xe}from"./dryhireFolderService-Bb-tDpoa.js";function Ye({department:e,jobId:n,jobStartTime:s,jobEndTime:r,assignmentDate:c,enabled:u=!0}){const[b,E]=k.useState(!1),F=ve(),f=$e({queryKey:["available-technicians",e,n,s,r,c??null],queryFn:async()=>{if(!e||!n||!s||!r)return[];try{return await Ke(e,n,s,r,c)}catch(_){throw _}},enabled:u&&!!e&&!!n&&!!s&&!!r,staleTime:1e3*60*2,refetchOnWindowFocus:!0,refetchOnReconnect:!0,retry:3,retryDelay:_=>Math.min(1e3*2**_,3e4)});k.useEffect(()=>{if(!u||!e||!n)return;const _=g.channel("technician-availability-updates").on("postgres_changes",{event:"*",schema:"public",table:"job_assignments"},V=>{F.invalidateQueries({queryKey:["available-technicians",e,n,s,r]})}).on("postgres_changes",{event:"*",schema:"public",table:"jobs"},V=>{F.invalidateQueries({queryKey:["available-technicians"]})}).subscribe();return()=>{g.removeChannel(_)}},[u,e,n,s,r,c,F]);const C=async()=>{E(!0);try{await f.refetch(),xe.success("Available technicians refreshed")}catch{xe.error("Failed to refresh available technicians")}finally{E(!1)}};return{technicians:f.data||[],isLoading:f.isLoading,isError:f.isError,error:f.error,isRefreshing:b||f.isFetching,refetch:C}}const _e=async(e,n)=>{try{const{data:s,error:r}=await g.from("job_assignments").select("sound_role, lights_role, video_role").eq("job_id",e).eq("technician_id",n).single();if(r||!s)return;const c=Qe(s);if(!c)return;const{error:u}=await g.from("timesheets").update({category:c}).eq("job_id",e).eq("technician_id",n).eq("is_active",!0);if(u)throw u}catch(s){throw s}},Ze=e=>{if(e.profiles){const n=e.profiles.first_name||"",s=e.profiles.last_name||"";return`${n} ${s}`.trim()||"Unnamed Technician"}return"Unknown Technician"},et=e=>{if(!e)return"";try{return new Intl.DateTimeFormat("es-ES",{dateStyle:"full"}).format(new Date(e))}catch{return e}},te=e=>({sound:"Sonido",lights:"Luces",video:"Video"})[e.toLowerCase()]||e,_t=({isOpen:e,onClose:n,onAssignmentChange:s,jobId:r,department:c})=>{const{toast:u}=Se(),{user:b,userRole:E}=Pe(),[F,f]=k.useState(null),[C,_]=k.useState("none"),[V,ne]=k.useState("none"),[Y,U]=k.useState(!1),[Z,X]=k.useState(!1),[oe,ie]=k.useState(!1),[le,de]=k.useState(!1),[o,y]=k.useState(!1),[L,w]=k.useState(null),{assignments:H,removeAssignment:A,isRemoving:v}=Be(r),{useCrewCallData:t}=Je(),p=c||(b==null?void 0:b.department)||"sound",S=k.useMemo(()=>(H||[]).filter(a=>p==="sound"?a.sound_role&&a.sound_role!=="none":p==="lights"?a.lights_role&&a.lights_role!=="none":p==="video"?a.video_role&&a.video_role!=="none":!1),[H,p]),{data:h,isLoading:x}=$e({queryKey:["job",r],queryFn:async()=>{const{data:a,error:i}=await g.from("jobs").select("id, start_time, end_time, title, job_date_types(date, type)").eq("id",r).single();if(i)throw i;return a},enabled:e&&!!r}),{technicians:N}=Ye({department:p,jobId:r,jobStartTime:(h==null?void 0:h.start_time)||"",jobEndTime:(h==null?void 0:h.end_time)||"",assignmentDate:Y&&L?re(L,"yyyy-MM-dd"):null,enabled:e&&!!h&&!!r});N.filter(a=>a.role==="technician"||a.role==="house_tech"||a.role==="management");const D=k.useMemo(()=>{if(!h)return[];const a=Array.isArray(h.job_date_types)?h.job_date_types.filter(i=>i==null?void 0:i.date).filter(i=>{const d=((i==null?void 0:i.type)||"").toLowerCase();return d!=="off"&&d!=="travel"}).map(i=>{const d=new Date(`${i.date}T00:00:00`);return d.setHours(0,0,0,0),d}):[];if(a.length>0)return a.sort((i,d)=>i.getTime()-d.getTime());if(h.start_time){const i=new Date(h.start_time);if(i.setHours(0,0,0,0),h.end_time){const d=new Date(h.end_time);d.setHours(0,0,0,0);const $=[],T=new Date(i);for(;T<=d;)$.push(new Date(T)),T.setDate(T.getDate()+1);return $}return[i]}return[]},[h]),M=k.useMemo(()=>new Set(D.map(a=>re(a,"yyyy-MM-dd"))),[D]);k.useEffect(()=>{if(!Y)return;if(D.length===0){w(null);return}const a=L?re(L,"yyyy-MM-dd"):null;(!a||!M.has(a))&&w(D[0])},[D,Y,M,L]),k.useEffect(()=>{e||(U(!1),w(null))},[e]);const{data:j,isLoading:Q}=t(r,p),{data:W=[]}=Ue(r),B=k.useMemo(()=>(W||[]).find(a=>a.department===p)||null,[W,p]),R=k.useMemo(()=>{const a=new Map;return(H||[]).forEach(i=>{const d=p==="sound"?i.sound_role:p==="lights"?i.lights_role:i.video_role;d&&a.set(d,(a.get(d)||0)+1)}),a},[H,p]);k.useMemo(()=>{const a=new Map,i=(B==null?void 0:B.roles)||[];for(const d of i){const $=R.get(d.role_code)||0,T=(d.quantity||0)-$;a.set(d.role_code,T)}return a},[B,R]);const I=()=>{if(j!=null&&j.flex_element_id){const i=`https://sectorpro.flexrentalsolutions.com/f5/ui/?desktop#contact-list/${j.flex_element_id}/view/139e2f60-8d20-11e2-b07f-00e08175e43e/detail`;window.open(i,"_blank")}},P=async()=>{var i,d;const a=p.toLowerCase();if(!["sound","lights","video"].includes(a)){u({title:"Not supported",description:"Sync is available for Sound, Lights, or Video"});return}try{y(!0),u({title:"Syncing",description:"Syncing crew to Flex…"});const{data:$,error:T}=await g.functions.invoke("sync-flex-crew-for-job",{body:{job_id:r,departments:[a]}});if(T){u({title:"Flex sync failed",description:T.message,variant:"destructive"});return}if($!=null&&$.ok){const J=((i=$.summary)==null?void 0:i[a])||{};(d=J.errors)!=null&&d.length?u({title:"Flex sync errors",description:J.errors.join("; "),variant:"destructive"}):J.note?u({title:"Flex sync",description:String(J.note)}):u({title:"Flex synced",description:`+${J.added??0}  −${J.removed??0}  =${J.kept??0}`})}else $!=null&&$.error?u({title:"Flex sync failed",description:$.error,variant:"destructive"}):u({title:"Flex sync completed"})}catch($){u({title:"Flex sync failed",description:($==null?void 0:$.message)||"Unknown error",variant:"destructive"})}finally{y(!1)}};return l.jsx(Ee,{open:e,onOpenChange:n,children:l.jsxs(Ce,{className:"w-[95vw] max-w-[625px] max-h-[90vh] flex flex-col overflow-hidden",children:[l.jsxs(Fe,{className:"flex-shrink-0",children:[l.jsxs(Ne,{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[l.jsxs("span",{className:"text-base md:text-lg",children:["Gestión de Personal - ",te(p)]}),l.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[(j==null?void 0:j.flex_element_id)&&l.jsxs(ae,{variant:"outline",size:"sm",onClick:I,className:"gap-2",children:[l.jsx(We,{className:"h-4 w-4"}),"View Crew Call in Flex"]}),["sound","lights","video"].includes(p.toLowerCase())&&l.jsxs(ae,{variant:"secondary",size:"sm",onClick:P,disabled:o,className:"gap-2",children:[l.jsx(ke,{className:`h-4 w-4 ${o?"animate-spin":""}`}),o?"Syncing…":"Sync Flex"]})]})]}),l.jsxs(je,{className:"text-xs md:text-sm",children:["Gestiona las asignaciones existentes para ",te(p),". Puedes modificar roles/categorías o eliminar personal. Para nuevas asignaciones, usa la Matriz de Asignaciones.",(j==null?void 0:j.flex_element_id)&&l.jsxs("span",{className:"block text-xs md:text-sm text-muted-foreground mt-1",children:["Crew call disponible para el departamento de ",te(p),"."]}),B&&l.jsxs("span",{className:"block text-xs md:text-sm text-muted-foreground mt-1",children:["Cobertura: ",Array.from(R.values()).reduce((a,i)=>a+i,0),"/",B.total_required," requeridos"]})]})]}),l.jsx("div",{className:"flex-1 overflow-y-auto px-1",children:l.jsxs("div",{className:"py-3 md:py-4",children:[l.jsxs("h3",{className:"text-base md:text-lg font-semibold mb-2",children:["Asignaciones Actuales de ",te(p)]}),S.length===0?l.jsxs("p",{className:"text-xs md:text-sm text-muted-foreground",children:["No hay técnicos asignados a ",te(p)," aún."]}):l.jsx("div",{className:"space-y-3",children:S.map(a=>l.jsxs("div",{className:"border rounded-md p-3 md:p-4 space-y-3",children:[l.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[l.jsxs("div",{className:"min-w-0 flex-1",children:[l.jsx("div",{className:"text-sm md:text-base font-medium truncate",children:Ze(a)}),a.single_day&&a.assignment_date&&l.jsxs("div",{className:"text-xs md:text-sm text-muted-foreground mt-1",children:["Día único: ",et(a.assignment_date)]})]}),l.jsxs(Ae,{children:[l.jsx(Te,{asChild:!0,children:l.jsx(ae,{variant:"destructive",size:"sm",disabled:v[a.technician_id],className:"w-full sm:w-auto",children:v[a.technician_id]?l.jsxs(l.Fragment,{children:[l.jsx(Re,{className:"mr-2 h-4 w-4 animate-spin"}),"Eliminando..."]}):"Eliminar"})}),l.jsxs(qe,{children:[l.jsxs(Me,{children:[l.jsx(Oe,{children:"¿Estás completamente seguro?"}),l.jsx(ze,{children:"Esta acción no se puede deshacer. Esto eliminará permanentemente al técnico de este trabajo."})]}),l.jsxs(Ge,{children:[l.jsx(He,{children:"Cancelar"}),l.jsx(Ve,{onClick:()=>A(a.technician_id),children:"Continuar"})]})]})]})]}),l.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[p==="sound"&&l.jsxs("div",{children:[l.jsx(ce,{htmlFor:`sound-role-${a.technician_id}`,className:"text-xs md:text-sm mb-1",children:"Rol de Sonido"}),l.jsxs(ue,{value:a.sound_role||"none",onValueChange:async i=>{try{const{error:d}=await g.from("job_assignments").update({sound_role:i==="none"?null:i}).eq("job_id",r).eq("technician_id",a.technician_id);if(d)throw d;await _e(r,a.technician_id),u({title:"Rol actualizado",description:"El rol de sonido se ha actualizado exitosamente"}),s()}catch(d){u({title:"Error",description:d.message||"No se pudo actualizar el rol",variant:"destructive"})}},children:[l.jsx(fe,{id:`sound-role-${a.technician_id}`,children:l.jsx(me,{})}),l.jsxs(pe,{children:[l.jsx(ee,{value:"none",children:"Ninguno"}),he("sound").map(i=>l.jsx(ee,{value:i.code,children:i.label},i.code))]})]})]}),p==="lights"&&l.jsxs("div",{children:[l.jsx(ce,{htmlFor:`lights-role-${a.technician_id}`,className:"text-xs md:text-sm mb-1",children:"Rol de Luces"}),l.jsxs(ue,{value:a.lights_role||"none",onValueChange:async i=>{try{const{error:d}=await g.from("job_assignments").update({lights_role:i==="none"?null:i}).eq("job_id",r).eq("technician_id",a.technician_id);if(d)throw d;await _e(r,a.technician_id),u({title:"Rol actualizado",description:"El rol de luces se ha actualizado exitosamente"}),s()}catch(d){u({title:"Error",description:d.message||"No se pudo actualizar el rol",variant:"destructive"})}},children:[l.jsx(fe,{id:`lights-role-${a.technician_id}`,children:l.jsx(me,{})}),l.jsxs(pe,{children:[l.jsx(ee,{value:"none",children:"Ninguno"}),he("lights").map(i=>l.jsx(ee,{value:i.code,children:i.label},i.code))]})]})]}),p==="video"&&l.jsxs("div",{children:[l.jsx(ce,{htmlFor:`video-role-${a.technician_id}`,className:"text-xs md:text-sm mb-1",children:"Rol de Video"}),l.jsxs(ue,{value:a.video_role||"none",onValueChange:async i=>{try{const{error:d}=await g.from("job_assignments").update({video_role:i==="none"?null:i}).eq("job_id",r).eq("technician_id",a.technician_id);if(d)throw d;await _e(r,a.technician_id),u({title:"Rol actualizado",description:"El rol de video se ha actualizado exitosamente"}),s()}catch(d){u({title:"Error",description:d.message||"No se pudo actualizar el rol",variant:"destructive"})}},children:[l.jsx(fe,{id:`video-role-${a.technician_id}`,children:l.jsx(me,{})}),l.jsxs(pe,{children:[l.jsx(ee,{value:"none",children:"Ninguno"}),he("video").map(i=>l.jsx(ee,{value:i.code,children:i.label},i.code))]})]})]})]})]},a.technician_id))})]})}),l.jsx(Le,{className:"flex-shrink-0",children:l.jsx(ae,{type:"button",onClick:n,size:"sm",className:"w-full sm:w-auto",children:"Cerrar"})})]})})},ge=e=>e==null?void 0:e.map(n=>({name:n.name,plannedStartDate:n.plannedStartDate,plannedEndDate:n.plannedEndDate})),be=e=>e?e.map(n=>{var s,r;return{name:((r=(s=n.name)==null?void 0:s.trim)==null?void 0:r.call(s))??n.name??"",plannedStartDate:n.plannedStartDate||void 0,plannedEndDate:n.plannedEndDate||void 0}}).filter(n=>!!n.name||!!n.plannedStartDate||!!n.plannedEndDate):[],xt=e=>{if(!e)return;const n={};return e.subfolders&&(n.subfolders=[...e.subfolders]),e.customPullsheet&&(n.customPullsheet={...e.customPullsheet,entries:ge(e.customPullsheet.entries)}),e.extrasPresupuesto&&(n.extrasPresupuesto={...e.extrasPresupuesto,entries:ge(e.extrasPresupuesto.entries)}),n},tt=e=>({keys:e!=null&&e.subfolders?[...e.subfolders]:[],hasExplicitSelection:Array.isArray(e==null?void 0:e.subfolders)}),we=e=>{var E,F,f;const n=(E=e==null?void 0:e.customPullsheet)==null?void 0:E.entries;if(n&&n.length>0)return n.map(C=>({...C}));const s=e==null?void 0:e.customPullsheet;if(!s)return[];const r=((f=(F=s.name)==null?void 0:F.trim)==null?void 0:f.call(F))??s.name??"",c=s.startDate||void 0,u=s.endDate||void 0;if(!s.enabled&&!r&&!c&&!u)return[];const b={name:r,plannedStartDate:c,plannedEndDate:u};return!b.name&&!b.plannedStartDate&&!b.plannedEndDate?[]:[b]},nt=e=>{var u;const n=(u=e==null?void 0:e.extrasPresupuesto)==null?void 0:u.entries;if(n&&n.length>0)return n.map(b=>({...b}));const s=e==null?void 0:e.extrasPresupuesto;if(!s)return[];const r=s.startDate||void 0,c=s.endDate||void 0;return!r&&!c?[]:[{name:"",plannedStartDate:r,plannedEndDate:c}]},gt=e=>{var E,F;if(!e)return;const n=!!e.enabled,s=((F=(E=e.name)==null?void 0:E.trim)==null?void 0:F.call(E))??e.name??"",r=e.startDate||void 0,c=e.endDate||void 0,u=be(e.entries);if(!n&&!s&&!r&&!c&&u.length===0)return;const b={enabled:n,name:s};return r&&(b.startDate=r),c&&(b.endDate=c),u.length>0&&(b.entries=u),b},wt=e=>{if(!e)return;const n=e.startDate||void 0,s=e.endDate||void 0,r=be(e.entries);if(!n&&!s&&r.length===0)return;const c={};return n&&(c.startDate=n),s&&(c.endDate=s),r.length>0&&(c.entries=r),c};function se(e){if(e)try{const n=new Date(e);return isNaN(n.getTime())?void 0:n.toISOString().split(".")[0]+".000Z"}catch{return}}async function at(e){const{data:n,error:s}=await g.from("job_departments").select("department").eq("job_id",e);return s?[]:n.map(r=>r.department)}async function st(e){var r;const{data:n,error:s}=await g.from("jobs").select(`
      job_departments (department)
    `).eq("tour_id",e).limit(1);return s||!n||n.length===0?[]:((r=n[0].job_departments)==null?void 0:r.map(c=>c.department))||[]}async function ye(e,n,s){try{const{data:r}=await g.from("flex_crew_calls").select("id").eq("job_id",e).eq("department",n).maybeSingle();r!=null&&r.id?await g.from("flex_crew_calls").update({flex_element_id:s}).eq("id",r.id):await g.from("flex_crew_calls").insert({job_id:e,department:n,flex_element_id:s})}catch{}}function Ie(e,n){return["production","personnel","comercial"].includes(e)?!0:["sound","lights","video"].includes(e)?n.includes(e):!1}function O(e,n,s){if(!s)return!0;const r=s[e];if(r===void 0)return!1;const{keys:c,hasExplicitSelection:u}=tt(r);return u?c.includes(n):!0}const De=(e,n,s,r,c)=>{const u=[],b=new Set,E=f=>{const C=f==null?void 0:f.trim();if(C&&!b.has(C))return b.add(C),C;let _=1;for(;;){const V=`PS${String(_).padStart(2,"0")}`;if(!b.has(V))return b.add(V),V;_+=1}},F=n.filter(f=>!!(f!=null&&f.name)||!!(f!=null&&f.plannedStartDate)||!!(f!=null&&f.plannedEndDate));if(F.length>0){if(F.forEach((f,C)=>{var Z,X;const _=e[C],V=((X=(Z=f.name)==null?void 0:Z.trim)==null?void 0:X.call(Z))||(_==null?void 0:_.name)||c(C,_),ne=se(f.plannedStartDate)||se(_==null?void 0:_.plannedStartDate)||s,Y=se(f.plannedEndDate)||se(_==null?void 0:_.plannedEndDate)||r,U=E(_==null?void 0:_.suffix);u.push({name:V,plannedStartDate:ne,plannedEndDate:Y,suffix:U})}),F.length<e.length)for(let f=F.length;f<e.length;f+=1){const C=e[f];u.push({name:C.name,plannedStartDate:C.plannedStartDate||s,plannedEndDate:C.plannedEndDate||r,suffix:E(C.suffix)})}}else e.forEach(f=>{u.push({name:f.name,plannedStartDate:f.plannedStartDate||s,plannedEndDate:f.plannedEndDate||r,suffix:E(f.suffix)})});return u};async function yt(e,n,s,r,c){var X,oe,ie,le,de;const{data:u,error:b}=await g.from("flex_folders").select("id, element_id, parent_id, folder_type, department").eq("job_id",e.id);if(b)throw b;const E=(u==null?void 0:u.find(o=>o.folder_type==="main_event"))??(u==null?void 0:u.find(o=>o.folder_type==="main")),F=(E==null?void 0:E.folder_type)==="main",f=new Map,C=new Map;for(const o of u??[])o.folder_type==="department"&&o.department&&f.set(o.department,o),o.folder_type==="work_orders"&&o.department&&C.set(o.department,o);F&&(f.clear(),C.clear());const _=((oe=(X=e==null?void 0:e.title)==null?void 0:X.trim)==null?void 0:oe.call(X))||(e==null?void 0:e.title)||"Sin título",V=async(o,y,L,w)=>{var p,S,h,x,N;const H=L??"",A=nt(c==null?void 0:c.comercial),v=[{label:"Sonido",dept:"sound",suffix:"SQT",extrasKey:"extrasSound",presupuestoKey:"presupuestoSound"},{label:"Luces",dept:"lights",suffix:"LQT",extrasKey:"extrasLights",presupuestoKey:"presupuestoLights"}],t=((p=w==null?void 0:w.trim)==null?void 0:p.call(w))||((h=(S=e==null?void 0:e.title)==null?void 0:S.trim)==null?void 0:h.call(S))||y;for(const D of v){const M=O("comercial",D.extrasKey,c),j=O("comercial",D.presupuestoKey,c);if(!M&&!j)continue;const Q=`Extras ${t} - ${D.label}`,W={parentElementId:o,open:!0,locked:!1,plannedStartDate:n,plannedEndDate:s,locationId:m.location,departmentId:G[D.dept],documentNumber:`${H}${D.suffix}`,personResponsibleId:z[D.dept]};let B=o,R=null;if(M){const I={definitionId:m.subFolder,name:Q,...W},a=(await q(I)).elementId;if(!a)continue;try{const{data:i,error:d}=await g.from("flex_folders").insert({job_id:e.id,parent_id:o,element_id:a,department:D.dept,folder_type:"comercial_extras"}).select("id").single();if(d)throw d;if(!(i!=null&&i.id))throw new Error("Failed to retrieve inserted row ID");B=a,R=i.id}catch(i){throw new Error(`Failed to persist comercial extras folder for ${D.dept} (element_id: ${a}). Flex folder was created but could not be recorded in database. Original error: ${i}`)}}if(j){const I=A.length>0?A:[{name:"",plannedStartDate:n,plannedEndDate:s}];for(let P=0;P<I.length;P+=1){const a=I[P],i=(N=(x=a==null?void 0:a.name)==null?void 0:x.trim)==null?void 0:N.call(x),d=M?i?`Extras ${t} - ${i}`:`${Q} - Presupuesto${I.length>1?` ${P+1}`:""}`:i?`${t} - ${D.label} - ${i}`:`${t} - ${D.label} - Presupuesto${I.length>1?` ${P+1}`:""}`,$={definitionId:m.presupuesto,parentElementId:B,open:!0,locked:!1,name:d,plannedStartDate:(a==null?void 0:a.plannedStartDate)||n,plannedEndDate:(a==null?void 0:a.plannedEndDate)||s,locationId:m.location,departmentId:G[D.dept],documentNumber:I.length>1?`${W.documentNumber}PR${String(P+1).padStart(2,"0")}`:W.documentNumber,personResponsibleId:z[D.dept]},T=await q($);try{await g.from("flex_folders").insert({job_id:e.id,parent_id:R||o,element_id:T.elementId,department:D.dept,folder_type:"comercial_presupuesto"})}catch(J){throw new Error(`Failed to persist comercial presupuesto for ${D.dept} (element_id: ${T.elementId}). Flex folder was created but could not be recorded in database. Original error: ${J}`)}}}}};if(e.job_type==="dryhire"){if((u??[]).some(x=>x.folder_type==="dryhire"))return;const y=(ie=e.job_departments[0])==null?void 0:ie.department;if(!y||!["sound","lights"].includes(y))throw new Error("Invalid department for dryhire job");const L=new Date(e.start_time),w=L.getFullYear(),H=L.toISOString().slice(5,7),A=await Xe(w,y,H);if(!A)throw new Error(`No parent folder found for ${w}/${H}. Please create dryhire folders for ${w} in Settings.`);const v=`${r}${K[y]}`,t={definitionId:m.subFolder,parentElementId:A,open:!0,locked:!1,name:`Dry Hire - ${e.title}`,plannedStartDate:n,plannedEndDate:s,locationId:m.location,departmentId:G[y],documentNumber:v,personResponsibleId:z[y]},p=await q(t),S=y==="sound"?"SDH":"LDH",h=await q({definitionId:m.presupuestoDryHire,parentElementId:p.elementId,open:!0,locked:!1,name:t.name,plannedStartDate:t.plannedStartDate,plannedEndDate:t.plannedEndDate,locationId:t.locationId,departmentId:t.departmentId,documentNumber:`${v}${S}`,personResponsibleId:t.personResponsibleId});await g.from("flex_folders").insert([{job_id:e.id,parent_id:A,element_id:p.elementId,department:y,folder_type:"dryhire"},{job_id:e.id,parent_id:p.elementId,element_id:h.elementId,department:y,folder_type:"dryhire_presupuesto"}]);return}if(e.job_type==="tourdate"){if(!e.tour_id)throw new Error("Tour ID is missing for tourdate job");const o=await st(e.tour_id),{data:y,error:L}=await g.from("tours").select(`
        id,
        name,
        flex_main_folder_id,
        flex_sound_folder_id,
        flex_lights_folder_id,
        flex_video_folder_id,
        flex_production_folder_id,
        flex_personnel_folder_id
      `).eq("id",e.tour_id).single();if(L||!y)throw new Error(`Tour not found for tour_id: ${e.tour_id}`);if(!y.flex_main_folder_id)throw new Error("Tour folders have not been created yet. Please create tour folders first.");let w=null;if(e.tour_date_id){const{data:t,error:p}=await g.from("tour_dates").select("is_tour_pack_only").eq("id",e.tour_date_id).single();!p&&t&&(w=t)}const H=["sound","lights","video","production","personnel","comercial"],A=((le=e.location)==null?void 0:le.name)||"No Location",v=re(new Date(e.start_time),"MMM d, yyyy");for(const t of H){if(!Ie(t,o))continue;const p=y[`flex_${t}_folder_id`];if(!p)continue;const{data:[S],error:h}=await g.from("flex_folders").select("*").eq("element_id",p).limit(1);if(h||!S)continue;const x=t.charAt(0).toUpperCase()+t.slice(1),N={definitionId:m.subFolder,parentElementId:p,open:!0,locked:!1,name:`${A} - ${v} - ${x}`,plannedStartDate:n,plannedEndDate:s,locationId:m.location,departmentId:G[t],documentNumber:`${r}${K[t]}`,personResponsibleId:z[t]},D=await q(N),{data:[M],error:j}=await g.from("flex_folders").insert({job_id:e.id,parent_id:S.id,element_id:D.elementId,department:t,folder_type:"tourdate"}).select("*");if(j)continue;const Q=M.element_id,W=N.name,B=N.documentNumber;if(["sound","lights","video"].includes(t)&&O(t,"hojaInfo",c)){const R=t==="sound"?m.hojaInfoSx:t==="lights"?m.hojaInfoLx:m.hojaInfoVx,I=t==="sound"?"SIP":t==="lights"?"LIP":"VIP",P={definitionId:R,parentElementId:Q,open:!0,locked:!1,name:`Hoja de Información - ${A} - ${v}`,plannedStartDate:n,plannedEndDate:s,locationId:m.location,departmentId:G[t],documentNumber:`${r}${K[t]}${I}`,personResponsibleId:z[t]},a=await q(P),i=t==="sound"?"hoja_info_sx":t==="lights"?"hoja_info_lx":"hoja_info_vx";try{await g.from("flex_folders").insert({job_id:e.id,parent_id:M.id,element_id:a.elementId,department:t,folder_type:i})}catch(d){throw new Error(`Failed to persist hojaInfo for ${t} (element_id: ${a.elementId}). Flex folder was created but could not be recorded in database. Original error: ${d}`)}}if(t!=="personnel"&&t!=="comercial"){const R=[{definitionId:m.documentacionTecnica,name:`${y.name} - ${A} - ${v} - Documentación Técnica - ${x}`,suffix:"DT",key:"documentacionTecnica"},{definitionId:m.presupuestosRecibidos,name:`${y.name} - ${A} - ${v} - Presupuestos Recibidos - ${x}`,suffix:"PR",key:"presupuestosRecibidos"},{definitionId:m.hojaGastos,name:`${y.name} - ${A} - ${v} - Hoja de Gastos - ${x}`,suffix:"HG",key:"hojaGastos"}];for(const I of R){if(!O(t,I.key,c))continue;const P={definitionId:I.definitionId,parentElementId:Q,open:!0,locked:!1,name:I.name,plannedStartDate:n,plannedEndDate:s,locationId:m.location,departmentId:G[t],documentNumber:`${r}${K[t]}${I.suffix}`,personResponsibleId:z[t]},a=await q(P),i={documentacionTecnica:"doc_tecnica",presupuestosRecibidos:"presupuestos_recibidos",hojaGastos:"hoja_gastos"};try{await g.from("flex_folders").insert({job_id:e.id,parent_id:M.id,element_id:a.elementId,department:t,folder_type:i[I.key]})}catch(d){throw new Error(`Failed to persist ${I.key} for ${t} (element_id: ${a.elementId}). Flex folder was created but could not be recorded in database. Original error: ${d}`)}}}else t==="comercial"&&await V(Q,W,B,_);if(["sound","lights","video"].includes(t)){const R=we(c==null?void 0:c[t]),I=[];if(t==="sound"){const P=(w==null?void 0:w.is_tour_pack_only)||!1;O("sound","pullSheetTP",c)&&I.push({name:`${_} - Tour Pack`,suffix:"TP",plannedStartDate:n,plannedEndDate:s}),!P&&O("sound","pullSheetPA",c)&&I.push({name:`${_} - PA`,suffix:"PA",plannedStartDate:n,plannedEndDate:s})}if(I.length>0||R.length>0){const a=De(I,R,n,s,(d,$)=>$!=null&&$.name?$.name:`${`${W} - Pullsheet`}${d>0?` ${d+1}`:""}`),i=`${r}${K[t]}`;for(const d of a){const $={definitionId:m.pullSheet,parentElementId:Q,open:!0,locked:!1,name:d.name,plannedStartDate:d.plannedStartDate,plannedEndDate:d.plannedEndDate,locationId:m.location,departmentId:G[t],documentNumber:`${i}${d.suffix}`,personResponsibleId:z[t]},T=await q($);try{await g.from("flex_folders").insert({job_id:e.id,parent_id:M.id,element_id:T.elementId,department:t,folder_type:"pull_sheet"})}catch(J){throw new Error(`Failed to persist pullsheet ${d.name} (element_id: ${T.elementId}). Flex folder was created but could not be recorded in database. Original error: ${J}`)}}}}if(t==="personnel"){const R=[];O("personnel","workOrder",c)&&R.push({name:`Orden de Trabajo - ${e.title}`,suffix:"OT",definitionId:m.ordenTrabajo}),O("personnel","gastosDePersonal",c)&&R.push({name:`Gastos de Personal - ${e.title}`,suffix:"GP",definitionId:m.hojaGastos});for(const P of R){const a={definitionId:P.definitionId,parentElementId:Q,open:!0,locked:!1,name:P.name,plannedStartDate:n,plannedEndDate:s,locationId:m.location,documentNumber:`${r}${K[t]}${P.suffix}`,departmentId:G[t],personResponsibleId:z[t]};await q(a)}const I=[];O("personnel","crewCallSound",c)&&I.push({name:`Crew Call Sonido - ${e.title}`,suffix:"CCS"}),O("personnel","crewCallLights",c)&&I.push({name:`Crew Call Luces - ${e.title}`,suffix:"CCL"});for(const P of I){const a={definitionId:m.crewCall,parentElementId:Q,open:!0,locked:!1,name:P.name,plannedStartDate:n,plannedEndDate:s,locationId:m.location,documentNumber:`${r}${K[t]}${P.suffix}`,departmentId:G[t],personResponsibleId:z[t]},i=await q(a),d=P.suffix==="CCS"?"sound":"lights";await ye(e.id,d,i.elementId)}}}return}const ne=await at(e.id),Y={definitionId:m.mainFolder,open:!0,locked:!1,name:e.title,plannedStartDate:n,plannedEndDate:s,locationId:m.location,personResponsibleId:m.mainResponsible,documentNumber:r};let U=F?void 0:(E==null?void 0:E.element_id)??void 0;if(U||(U=(await q(Y)).elementId,await g.from("flex_folders").insert({job_id:e.id,element_id:U,folder_type:"main_event"})),!U)throw new Error("Unable to resolve main Flex folder for job");const Z=["sound","lights","video","production","personnel","comercial"];for(const o of Z){if(!Ie(o,ne))continue;const y=o.charAt(0).toUpperCase()+o.slice(1),L={definitionId:m.subFolder,parentElementId:U,open:!0,locked:!1,name:`${e.title} - ${y}`,plannedStartDate:n,plannedEndDate:s,locationId:m.location,departmentId:G[o],documentNumber:`${r}${K[o]}`,personResponsibleId:z[o]};let w=((de=f.get(o))==null?void 0:de.element_id)??null;if(!w){const v=await q(L),{data:[t],error:p}=await g.from("flex_folders").insert({job_id:e.id,parent_id:U,element_id:v.elementId,department:o,folder_type:"department"}).select("*");w=(t==null?void 0:t.element_id)??v.elementId,t!=null&&t.department&&f.set(t.department,t)}if(!w)continue;const H=L.name,A=L.documentNumber;if(["sound","lights","video"].includes(o)&&O(o,"hojaInfo",c)){const v=o==="sound"?m.hojaInfoSx:o==="lights"?m.hojaInfoLx:m.hojaInfoVx,t=o==="sound"?"SIP":o==="lights"?"LIP":"VIP",p={definitionId:v,parentElementId:w,open:!0,locked:!1,name:`Hoja de Información - ${e.title}`,plannedStartDate:n,plannedEndDate:s,locationId:m.location,departmentId:G[o],documentNumber:`${r}${t}`,personResponsibleId:z[o]},S=await q(p),h=o==="sound"?"hoja_info_sx":o==="lights"?"hoja_info_lx":"hoja_info_vx",x=f.get(o);try{await g.from("flex_folders").insert({job_id:e.id,parent_id:(x==null?void 0:x.id)??null,element_id:S.elementId,department:o,folder_type:h})}catch(N){throw new Error(`Failed to persist hojaInfo for ${o} (job_id: ${e.id}, element_id: ${S.elementId}). Flex folder was created but could not be recorded in database. Original error: ${N}`)}}if(["sound","lights","video"].includes(o)){const v=we(c==null?void 0:c[o]),t=[];if(o==="sound"&&(O("sound","pullSheetTP",c)&&t.push({name:`${_} - Tour Pack`,suffix:"TP",plannedStartDate:n,plannedEndDate:s}),O("sound","pullSheetPA",c)&&t.push({name:`${_} - PA`,suffix:"PA",plannedStartDate:n,plannedEndDate:s})),t.length>0||v.length>0){const S=De(t,v,n,s,(x,N)=>N!=null&&N.name?N.name:`${`${_} - ${y} Pullsheet`}${x>0?` ${x+1}`:""}`),h=`${r}${K[o]}`;for(const x of S){const N={definitionId:m.pullSheet,parentElementId:w,open:!0,locked:!1,name:x.name,plannedStartDate:x.plannedStartDate,plannedEndDate:x.plannedEndDate,locationId:m.location,departmentId:G[o],documentNumber:`${h}${x.suffix}`,personResponsibleId:z[o]},D=await q(N),M=f.get(o);try{await g.from("flex_folders").insert({job_id:e.id,parent_id:(M==null?void 0:M.id)??null,element_id:D.elementId,department:o,folder_type:"pull_sheet"})}catch(j){throw new Error(`Failed to persist pullsheet ${x.name} (element_id: ${D.elementId}). Flex folder was created but could not be recorded in database. Original error: ${j}`)}}}}if(o!=="personnel"&&o!=="comercial"){const v=[{definitionId:m.documentacionTecnica,name:`${e.title} - Documentación Técnica - ${y}`,suffix:"DT",key:"documentacionTecnica"},{definitionId:m.presupuestosRecibidos,name:`${e.title} - Presupuestos Recibidos - ${y}`,suffix:"PR",key:"presupuestosRecibidos"},{definitionId:m.hojaGastos,name:`${e.title} - Hoja de Gastos - ${y}`,suffix:"HG",key:"hojaGastos"}];for(const t of v){if(!O(o,t.key,c))continue;const p={definitionId:t.definitionId,parentElementId:w,open:!0,locked:!1,name:t.name,plannedStartDate:n,plannedEndDate:s,locationId:m.location,departmentId:G[o],documentNumber:`${r}${K[o]}${t.suffix}`,personResponsibleId:z[o]},S=await q(p),h={documentacionTecnica:"doc_tecnica",presupuestosRecibidos:"presupuestos_recibidos",hojaGastos:"hoja_gastos"},x=f.get(o);try{await g.from("flex_folders").insert({job_id:e.id,parent_id:(x==null?void 0:x.id)??null,element_id:S.elementId,department:o,folder_type:h[t.key]})}catch(N){throw new Error(`Failed to persist ${t.key} for ${o} (element_id: ${S.elementId}). Flex folder was created but could not be recorded in database. Original error: ${N}`)}}}else if(o==="comercial")await V(w,H,A,_);else if(o==="personnel"){const v=[{name:`Crew Call Sonido - ${e.title}`,suffix:"CCS",key:"crewCallSound",definitionId:m.crewCall,crewCallDepartment:"sound"},{name:`Crew Call Luces - ${e.title}`,suffix:"CCL",key:"crewCallLights",definitionId:m.crewCall,crewCallDepartment:"lights"},{name:`Orden de Trabajo - ${e.title}`,suffix:"OT",key:"workOrder",definitionId:m.ordenTrabajo},{name:`Gastos de Personal - ${e.title}`,suffix:"GP",key:"gastosDePersonal",definitionId:m.hojaGastos}];for(const t of v){if(!O("personnel",t.key,c))continue;if(t.key==="workOrder"){const h=C.get(o);if(h!=null&&h.element_id)continue}const p={definitionId:t.definitionId,parentElementId:w,open:!0,locked:!1,name:t.name,plannedStartDate:n,plannedEndDate:s,locationId:m.location,documentNumber:`${r}${K[o]}${t.suffix}`,departmentId:G[o],personResponsibleId:z[o]},S=await q(p);if(t.crewCallDepartment&&await ye(e.id,t.crewCallDepartment,S.elementId),t.key==="workOrder")try{const{data:h,error:x}=await g.from("flex_folders").insert({job_id:e.id,parent_id:w,element_id:S.elementId,department:o,folder_type:"work_orders"}).select("*").single();x||h&&C.set(o,h)}catch{}if(t.key==="gastosDePersonal"){const h=f.get(o);try{await g.from("flex_folders").insert({job_id:e.id,parent_id:(h==null?void 0:h.id)??null,element_id:S.elementId,department:o,folder_type:"hoja_gastos"})}catch(x){throw new Error(`Failed to persist gastos de personal (element_id: ${S.elementId}). Flex folder was created but could not be recorded in database. Original error: ${x}`)}}}}}}export{_t as J,xt as a,wt as b,yt as c,tt as g,gt as s,Ye as u};
