import{a4 as q,j as e,D as me,q as he,F as pe,G as xe,B as D,L as h,S as W,t as K,v as H,w as Y,p as re,x as u,I as F,r as c,e as ye,f as _e,ac as Se,bh as be,aD as Ne,bi as ce,s as C,bj as ue,bk as Ce}from"./index-NZ6jJLfQ.js";import{C as Te}from"./checkbox-BsRNEGV1.js";import{a as Ee,b as qe}from"./useJobRequiredRoles-Bz0ibKHS.js";const se=m=>({localId:m.id,id:m.id,job_id:m.job_id,department:m.department,role_code:m.role_code,quantity:m.quantity,notes:m.notes,status:"clean"}),De=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`tmp-${Math.random().toString(36).slice(2,11)}`,Ie=({open:m,onOpenChange:z,jobId:t,departments:x})=>{const{data:_=[],isLoading:V}=Ee(t),{mutateAsync:I,isPending:T,reset:J}=qe(),[j,S]=q.useState([]),[E,b]=q.useState([]),[A,p]=q.useState(null),M=q.useCallback(()=>{const i=(_||[]).map(se);S(i),b([])},[_]),v=q.useMemo(()=>E.length>0||j.some(i=>i.status==="new"||i.status==="updated"),[j,E]);q.useEffect(()=>{m&&(v||M())},[m,_,v,M]);const O=q.useMemo(()=>{const i=new Map;return x.forEach(l=>i.set(l,[])),j.forEach(l=>{const s=i.get(l.department)??[];s.push(l),i.set(l.department,s)}),i},[j,x]),B=i=>{var f;if(!t)return;const s=((f=re(i)[0])==null?void 0:f.code)??"";if(!s)return;const n={localId:De(),id:void 0,job_id:t,department:i,role_code:s,quantity:1,notes:null,status:"new"};S(g=>[...g,n])},L=(i,l)=>{S(s=>s.map(n=>{if(n.localId!==i)return n;const f=l(n),g=n.status==="new"?"new":"updated";return{...f,status:g}}))},P=(i,l)=>{L(i,s=>({...s,role_code:l}))},U=(i,l)=>{const s=Number.isFinite(l)&&l>=0?Math.floor(l):0;L(i,n=>({...n,quantity:s}))},R=i=>{S(l=>l.filter(s=>s.localId!==i.localId)),i.id&&b(l=>[...l,i.id])},Q=()=>{M(),p(null),J()},G=async()=>{if(!t)return;const i=j.filter(s=>s.status==="new").map(s=>({job_id:s.job_id,department:s.department,role_code:s.role_code,quantity:s.quantity,notes:s.notes})),l=j.filter(s=>s.status==="updated"&&s.id).map(s=>({id:s.id,job_id:s.job_id,department:s.department,role_code:s.role_code,quantity:s.quantity,notes:s.notes}));if(!(i.length===0&&l.length===0&&E.length===0))try{const s=await I({jobId:t,inserts:i,updates:l,deletes:E});S(n=>{const f=new Map(s.updated.map(o=>[o.id,o])),g=n.filter(o=>o.status!=="new").map(o=>o.id&&s.deleted.includes(o.id)?null:o.id&&f.has(o.id)?se(f.get(o.id)):{...o,status:"clean",localId:o.id??o.localId}).filter(o=>o!==null),k=s.inserted.map(se);return[...g,...k]}),b([]),p(null)}catch(s){const n=s instanceof Error?s.message:"Failed to save job requirements.";p(n)}};return e.jsx(me,{open:m,onOpenChange:z,children:e.jsxs(he,{className:"max-w-2xl space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs(pe,{children:[e.jsx(xe,{children:"Required Crew"}),V&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading requirementsâ€¦"})]}),e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsx(D,{variant:"outline",size:"sm",onClick:Q,disabled:T,children:"Cancel"}),e.jsx(D,{size:"sm",onClick:G,disabled:!v||T,children:"Save"})]})]}),A&&e.jsx("div",{className:"text-sm text-destructive",children:A}),e.jsx("div",{className:"space-y-6",children:x.map(i=>{const l=O.get(i)??[];return e.jsxs("div",{className:"border rounded-md p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-medium capitalize",children:i}),e.jsx(D,{size:"sm",variant:"outline",onClick:()=>B(i),disabled:T,children:"Add Role"})]}),e.jsxs("div",{className:"space-y-2",children:[l.map(s=>e.jsxs("div",{className:"grid grid-cols-12 gap-2 items-center",children:[e.jsxs("div",{className:"col-span-7",children:[e.jsx(h,{className:"sr-only",children:"Role"}),e.jsxs(W,{value:s.role_code,onValueChange:n=>P(s.localId,n),children:[e.jsx(K,{children:e.jsx(H,{placeholder:"Select a role"})}),e.jsx(Y,{children:re(i).map(n=>e.jsx(u,{value:n.code,children:n.label},n.code))})]})]}),e.jsxs("div",{className:"col-span-3",children:[e.jsx(h,{className:"sr-only",children:"Qty"}),e.jsx(F,{type:"number",min:0,step:1,value:s.quantity,onChange:n=>U(s.localId,Number(n.target.value))})]}),e.jsx("div",{className:"col-span-2 flex justify-end",children:e.jsx(D,{variant:"destructive",size:"sm",onClick:()=>R(s),disabled:T,children:"Delete"})})]},s.localId)),l.length===0&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"No roles configured"})]})]},i)})})]})})},Me=({open:m,onOpenChange:z,job:t})=>{const x="bg-background border-input text-foreground placeholder:text-muted-foreground",[_,V]=c.useState(t.title),[I,T]=c.useState(t.description||""),[J,j]=c.useState(""),[S,E]=c.useState(""),[b,A]=c.useState(t.color||"#7E69AB"),[p,M]=c.useState(t.job_type||"single"),[v,O]=c.useState(t.timezone||"Europe/Madrid"),[B,L]=c.useState(t.invoicing_company||null),[P,U]=c.useState(!1),[R,Q]=c.useState([]),[G,i]=c.useState(!1),[l,s]=c.useState(!1),[n,f]=c.useState(""),[g,k]=c.useState(""),[o,Z]=c.useState(null),{toast:ae}=ye(),X=_e(),{getOrCreateLocationWithDetails:ie}=Ce();c.useEffect(()=>{(async()=>{if(t){if(V(t.title),T(t.description||""),A(t.color||"#7E69AB"),M(t.job_type||"single"),O(t.timezone||"Europe/Madrid"),L(t.invoicing_company||null),t.start_time&&t.end_time){const d=t.timezone||"Europe/Madrid";j(ce(t.start_time,d)),E(ce(t.end_time,d))}if(t.location_id)try{const{data:d,error:y}=await C.from("locations").select("*").eq("id",t.location_id).single();!y&&d&&(f(d.name||""),k(d.formatted_address||""),Z({place_id:d.google_place_id||void 0,coordinates:d.latitude&&d.longitude?{lat:d.latitude,lng:d.longitude}:void 0}))}catch{}else f(""),k(""),Z(null)}})()},[t]),c.useEffect(()=>{const a=async()=>{const{data:d,error:y}=await C.from("job_departments").select("department").eq("job_id",t.id);if(y)return;const N=d.map($=>$.department);Q(N)};m&&t.id&&a()},[m,t.id]);const fe=a=>{Q(d=>d.includes(a)?d.filter(y=>y!==a):[...d,a])},ge=a=>{f(a.name),k(a.address),Z({place_id:a.place_id,coordinates:a.coordinates})},ve=async a=>{a.preventDefault(),U(!0);try{const d=ue(J,v),y=ue(S,v);let N=t.location_id;if(n&&g){const r={name:n,address:g,coordinates:o==null?void 0:o.coordinates,place_id:o==null?void 0:o.place_id};N=await ie(r)}else n&&!g?N=await ie({name:n,address:n}):!n&&!g&&(N=null);const{error:$}=await C.from("jobs").update({title:_,description:I,start_time:d.toISOString(),end_time:y.toISOString(),color:b,job_type:p,timezone:v,location_id:N,invoicing_company:B}).eq("id",t.id);if($)throw $;const{data:ee}=await C.from("job_departments").select("department").eq("job_id",t.id),ne=(ee==null?void 0:ee.map(r=>r.department))||[],le=ne.filter(r=>!R.includes(r));le.length>0&&await C.from("job_departments").delete().eq("job_id",t.id).in("department",le);const de=R.filter(r=>!ne.includes(r));de.length>0&&await C.from("job_departments").insert(de.map(r=>({job_id:t.id,department:r})));try{const r={},w=te=>te instanceof Date?te.toISOString():te;t.title!==_&&(r.title={from:t.title,to:_}),(t.description||"")!==(I||"")&&(r.description={from:t.description,to:I}),(t.start_time||"")!==w(d)&&(r.start_time={from:t.start_time,to:w(d)}),(t.end_time||"")!==w(y)&&(r.end_time={from:t.end_time,to:w(y)}),(t.timezone||"")!==(v||"")&&(r.timezone={from:t.timezone,to:v});const oe=(t.job_type||"")!==(p||"");oe&&(r.job_type={from:t.job_type,to:p}),(t.location_id||null)!==(N||null)&&(r.location_id={from:t.location_id,to:N}),(t.color||"")!==(b||"")&&(r.color={from:t.color,to:b}),C.functions.invoke("push",{body:{action:"broadcast",type:"job.updated",job_id:t.id,changes:r}}),oe&&t.job_type&&p&&C.functions.invoke("push",{body:{action:"broadcast",type:`job.type.changed.${p}`,job_id:t.id,old_type:t.job_type,new_type:p,url:`/jobs/${t.id}`}})}catch{}ae({title:"Job updated successfully",description:"The job has been updated."}),X.invalidateQueries({queryKey:["optimized-jobs"]}),X.invalidateQueries({queryKey:["jobs"]}),X.invalidateQueries({queryKey:["hoja-de-ruta",t.id]}),z(!1)}catch(d){ae({title:"Error updating job",description:d.message,variant:"destructive"})}finally{U(!1)}},je=["sound","lights","video","production"];return e.jsxs(e.Fragment,{children:[e.jsx(me,{open:m,onOpenChange:z,children:e.jsxs(he,{className:"max-h-[90vh] md:max-h-none md:h-auto overflow-y-auto md:overflow-visible",children:[e.jsx(pe,{children:e.jsx(xe,{children:"Edit Job"})}),e.jsxs("form",{onSubmit:ve,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"title",children:"Title"}),e.jsx(F,{id:"title",value:_,onChange:a=>V(a.target.value),required:!0,className:x})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"description",children:"Description"}),e.jsx(Se,{id:"description",value:I,onChange:a=>T(a.target.value),rows:4,className:x})]}),e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-muted/30",children:[e.jsx(h,{className:"text-base font-semibold",children:"Venue Information"}),e.jsxs("div",{className:"grid gap-4",children:[e.jsx(be,{value:n,onSelect:ge,onBusyChange:i,placeholder:"Search for venue (WiZink Center Madrid, etc.)",label:"Venue Name",className:"w-full"}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"venueAddress",children:"Address"}),e.jsx(F,{id:"venueAddress",value:g,onChange:a=>k(a.target.value),placeholder:"Venue address (auto-filled from venue selection)",className:x})]})]})]}),e.jsxs("div",{children:[e.jsx(h,{children:"Timezone"}),e.jsxs(W,{value:v,onValueChange:O,children:[e.jsx(K,{className:x,children:e.jsx(H,{placeholder:"Select timezone"})}),e.jsxs(Y,{children:[e.jsx(u,{value:"Europe/Madrid",children:"Europe/Madrid"}),e.jsx(u,{value:"Europe/London",children:"Europe/London"}),e.jsx(u,{value:"Europe/Paris",children:"Europe/Paris"}),e.jsx(u,{value:"America/New_York",children:"America/New_York"}),e.jsx(u,{value:"America/Los_Angeles",children:"America/Los_Angeles"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"startTime",children:"Start Time"}),e.jsx(F,{id:"startTime",type:"datetime-local",value:J,onChange:a=>j(a.target.value),required:!0,className:x})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"endTime",children:"End Time"}),e.jsx(F,{id:"endTime",type:"datetime-local",value:S,onChange:a=>E(a.target.value),required:!0,className:x})]})]}),e.jsxs("div",{children:[e.jsx(h,{children:"Color"}),e.jsx(Ne,{color:b,onChange:A})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Job Type"}),e.jsxs(W,{value:p,onValueChange:a=>M(a),children:[e.jsx(K,{children:e.jsx(H,{placeholder:"Select job type"})}),e.jsxs(Y,{children:[e.jsx(u,{value:"single",children:"Single"}),e.jsx(u,{value:"tour",children:"Tour"}),e.jsx(u,{value:"tourdate",children:"Tour Date"}),e.jsx(u,{value:"festival",children:"Festival"}),e.jsx(u,{value:"dryhire",children:"Dry Hire"}),e.jsx(u,{value:"evento",children:"Evento"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Invoicing Company"}),e.jsxs(W,{value:B||"none",onValueChange:a=>L(a==="none"?null:a),children:[e.jsx(K,{className:x,children:e.jsx(H,{placeholder:"Select invoicing company (optional)"})}),e.jsxs(Y,{children:[e.jsx(u,{value:"none",children:"None"}),e.jsx(u,{value:"Production Sector",children:"Production Sector"}),e.jsx(u,{value:"Sharecable",children:"Sharecable"}),e.jsx(u,{value:"MFO",children:"MFO"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"If set, technicians will be instructed to invoice this company"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Departments"}),e.jsx("div",{className:"flex flex-col gap-2",children:je.map(a=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Te,{id:`department-${a}`,checked:R.includes(a),onCheckedChange:()=>fe(a)}),e.jsx(h,{htmlFor:`department-${a}`,className:"capitalize",children:a})]},a))}),p!=="dryhire"&&e.jsx("div",{className:"pt-2",children:e.jsx(D,{type:"button",variant:"outline",onClick:()=>s(!0),className:"border-border",children:"Manage Requirements"})})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(D,{type:"button",variant:"outline",onClick:()=>z(!1),className:"border-border",children:"Cancel"}),e.jsx(D,{type:"submit",disabled:P||G,className:"bg-blue-600 hover:bg-blue-500 text-white",children:P?"Saving...":"Save Changes"})]})]})]})}),l&&e.jsx(Ie,{open:l,onOpenChange:s,jobId:t.id,departments:R})]})},Ae=Object.freeze(Object.defineProperty({__proto__:null,EditJobDialog:Me},Symbol.toStringTag,{value:"Module"}));export{Me as E,Ie as J,Ae as a};
