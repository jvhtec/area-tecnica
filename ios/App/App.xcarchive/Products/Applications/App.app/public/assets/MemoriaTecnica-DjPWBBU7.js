import{e as H,r as d,j as e,C as K,W as Y,Y as q,A as J,L as f,I as N,B as p,S as Q,t as X,v as Z,w as ee,x as b,a as P,s as v}from"./index-NZ6jJLfQ.js";import{P as re}from"./progress-C8XsV-Me.js";import{R as se,a as I}from"./radio-group-DzKNHD24.js";import{u as ae,F as T,a as te}from"./useLogoOptions-BfwIlBcK.js";import{I as D}from"./image--Pql38nK.js";import{F as le}from"./file-B1WzkXfC.js";import{D as oe}from"./download-C1rVE0-J.js";import{U as ie}from"./upload-DF4rjO7T.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./index-hC3MxXep.js";import"./circle-CWxDyDxx.js";import"./logo-url-cache-eY6nfvu7.js";const Ne=()=>{var k;const{toast:o}=H(),[m,R]=d.useState(""),[w,y]=d.useState(!1),[$,c]=d.useState(0),[u,S]=d.useState(null),[C,E]=d.useState(null),[j,_]=d.useState("upload"),[g,G]=d.useState(null),{logoOptions:h,isLoading:L}=ae(),[F,M]=d.useState([{id:"material",title:"Listado de Material",file:null,landscape:!1},{id:"soundvision",title:"Informe SoundVision",file:null,landscape:!1},{id:"weight",title:"Informe de Pesos",file:null,landscape:!1},{id:"power",title:"Informe de Consumos",file:null,landscape:!1},{id:"rigging",title:"Plano de Rigging",file:null,landscape:!0}]),O=["Memoria Tecnica","memoria-tecnica","sound-memoria-tecnica"],A=async r=>{if(!r.type.includes("image/")){o({title:"Error",description:"Solo se permiten archivos de imagen",variant:"destructive"});return}try{const s=URL.createObjectURL(r);S({file:r,url:s}),_("upload")}catch{o({title:"Error",description:"Error al procesar la imagen",variant:"destructive"})}},V=r=>{G(r),h.find(t=>t.value===r)&&S(null)},z=async(r,s)=>{if(!r.type.includes("pdf")){o({title:"Error",description:"Solo se permiten archivos PDF",variant:"destructive"});return}try{const t=URL.createObjectURL(r);M(l=>l.map(n=>n.id===s?{...n,file:{file:r,url:t}}:n))}catch{o({title:"Error",description:"Error al procesar el archivo",variant:"destructive"})}},U=async(r,s)=>{const t=s.replace(/\s+/g,"_");let l=null;for(const n of O)try{const{error:a}=await v.storage.from(n).upload(t,r,{upsert:!0});if(a)throw a;const{data:i,error:x}=await v.storage.from(n).createSignedUrl(t,3600);if(x)throw x;return i.signedUrl}catch(a){if(l=a,!((a&&(a.message||a.error||""))+"").toLowerCase().includes("bucket not found")&&(a==null?void 0:a.statusCode)!=="404")throw a}throw l||new Error("Failed to upload: no matching bucket found")},B=async()=>{if(!m.trim()){o({title:"Error",description:"Por favor, ingrese el nombre del proyecto",variant:"destructive"});return}const r=F.filter(s=>s.file!==null);if(r.length===0){o({title:"Error",description:"Por favor, suba al menos un documento",variant:"destructive"});return}y(!0),c(0),E(null);try{let s=null;if(j==="upload"&&u)try{const a=`${m}/logo_${Date.now()}.${u.file.name.split(".").pop()}`;s=await U(u.file,a),c(10)}catch{o({title:"Warning",description:"No se pudo subir el logo, continuando sin él"})}else if(j==="existing"&&g){const a=h.find(i=>i.value===g);s=(a==null?void 0:a.url)||null,c(10)}const t={};for(let a=0;a<r.length;a++){const i=r[a];if(i.file)try{const x=`${m}/${i.id}_${Date.now()}.pdf`,W=await U(i.file.file,x);t[i.id]=W,c((a+1)/r.length*50)}catch{o({title:"Error",description:`Error al subir el documento ${i.title}`,variant:"destructive"});return}}c(60);const l=await v.functions.invoke("generate-memoria-tecnica",{body:{documentUrls:t,projectName:m,logoUrl:s,expiresIn:3600}});if(l.error)throw new Error(l.error.message||"Error al generar la memoria técnica");c(80);const{error:n}=await v.from("memoria_tecnica_documents").insert({project_name:m,logo_url:s,material_list_url:t.material,soundvision_report_url:t.soundvision,weight_report_url:t.weight,power_report_url:t.power,rigging_plot_url:t.rigging,final_document_url:l.data.url});if(n)throw n;c(100),E(l.data.url),o({title:"Éxito",description:`Memoria técnica generada correctamente. Expira en ${Math.round(l.data.expiresIn/60)} minutos.`}),window.open(l.data.url,"_blank")}catch(s){o({title:"Error",description:s.message||"Error al generar la memoria técnica",variant:"destructive"})}finally{y(!1),c(0)}};return e.jsx("div",{className:"h-[calc(100vh-6rem)] overflow-y-auto p-4 sm:p-6",children:e.jsxs(K,{className:"w-full max-w-4xl mx-auto",children:[e.jsx(Y,{className:"space-y-1",children:e.jsx(q,{className:"text-2xl font-bold text-center",children:"Memoria Técnica de Sonido"})}),e.jsxs(J,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"projectName",children:"Nombre del Proyecto"}),e.jsx(N,{id:"projectName",value:m,onChange:r=>R(r.target.value),placeholder:"Ingrese el nombre del proyecto"})]}),e.jsx("div",{className:"space-y-4 border rounded-lg p-4 bg-muted/30",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"Logo"}),e.jsxs(se,{value:j,onValueChange:r=>_(r),className:"flex flex-col sm:flex-row sm:items-center gap-4 sm:gap-6",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(I,{value:"upload",id:"r-upload"}),e.jsx(f,{htmlFor:"r-upload",className:"cursor-pointer",children:"Subir nuevo logo"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(I,{value:"existing",id:"r-existing"}),e.jsx(f,{htmlFor:"r-existing",className:"cursor-pointer",children:"Usar logo existente"})]})]}),j==="upload"?e.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-2",children:[e.jsx(N,{type:"file",accept:"image/*",className:"hidden",id:"logo-upload",onChange:r=>{var t;const s=(t=r.target.files)==null?void 0:t[0];s&&A(s)}}),e.jsx(p,{variant:"outline",asChild:!0,className:"w-full",children:e.jsx("label",{htmlFor:"logo-upload",className:"cursor-pointer flex items-center justify-center gap-2",children:u?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-4 w-4"}),"Logo cargado"]}):e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"h-4 w-4"}),"Subir logo"]})})}),u&&e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>window.open(u.url,"_blank"),className:"shrink-0",children:e.jsx(D,{className:"h-4 w-4"})})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Q,{value:g||"",onValueChange:V,disabled:L,children:[e.jsx(X,{className:"w-full",children:e.jsx(Z,{placeholder:"Selecciona un logo existente"})}),e.jsx(ee,{children:L?e.jsxs(b,{value:"loading",disabled:!0,children:[e.jsx(P,{className:"h-4 w-4 animate-spin mr-2 inline"}),"Cargando logos..."]}):h.length>0?h.map(r=>e.jsx(b,{value:r.value,children:r.label},r.value)):e.jsx(b,{value:"none",disabled:!0,children:"No hay logos disponibles"})})]}),g&&e.jsx("div",{className:"flex justify-center p-4 bg-muted rounded-md border",children:e.jsx("img",{src:((k=h.find(r=>r.value===g))==null?void 0:k.url)||"",alt:"Selected logo preview",width:192,height:64,loading:"lazy",decoding:"async",className:"h-16 w-48 object-contain",onError:r=>{r.target.src="/lovable-uploads/ce3ff31a-4cc5-43c8-b5bb-a4056d3735e4.png"}})})]})]})}),e.jsxs("div",{className:"space-y-4 border rounded-lg p-4 bg-muted/30",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Documentos"}),F.map(r=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:r.title}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-2",children:[e.jsx(N,{type:"file",accept:".pdf",className:"hidden",id:`file-${r.id}`,onChange:s=>{var l;const t=(l=s.target.files)==null?void 0:l[0];t&&z(t,r.id)}}),e.jsx(p,{variant:"outline",asChild:!0,className:"w-full",children:e.jsx("label",{htmlFor:`file-${r.id}`,className:"cursor-pointer flex items-center justify-center gap-2",children:r.file?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-4 w-4"}),"Archivo cargado"]}):e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"h-4 w-4"}),"Subir archivo"]})})}),r.file&&e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>{var s;return window.open((s=r.file)==null?void 0:s.url,"_blank")},className:"shrink-0",children:e.jsx(le,{className:"h-4 w-4"})})]})]},r.id))]}),w&&e.jsxs("div",{className:"space-y-2 border rounded-lg p-4 bg-muted/30",children:[e.jsx(re,{value:$}),e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"Generando memoria técnica..."})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[C&&e.jsxs(p,{variant:"outline",className:"w-full sm:flex-1",onClick:()=>window.open(C,"_blank"),children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Descargar Memoria Técnica"]}),e.jsx(p,{onClick:B,disabled:w,className:"w-full sm:flex-1",children:w?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"h-4 w-4 animate-spin mr-2"}),"Generando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Generar Memoria Técnica"]})})]})]})]})})};export{Ne as MemoriaTecnica};
