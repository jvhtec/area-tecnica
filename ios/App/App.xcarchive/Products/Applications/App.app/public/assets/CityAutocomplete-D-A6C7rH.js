import{r as n,j as s,L as M,I as X,M as K,a as $,C as O,B as V,m as z}from"./index-NZ6jJLfQ.js";const H=({value:x,onChange:f,placeholder:_="Enter city name",label:P="City",className:k,id:S="city-autocomplete",required:I=!1})=>{const[R,u]=n.useState(x||""),[y,p]=n.useState([]),[A,o]=n.useState(!1),[F,N]=n.useState(!1),[w,L]=n.useState(null),v=n.useRef(null),j=n.useRef(void 0),C=n.useRef({});n.useEffect(()=>{u(x||"")},[x]);const g=async()=>{try{const{data:e,error:t}=await z.functions.invoke("get-google-maps-key");if(t)return null;if(e!=null&&e.apiKey)return L(e.apiKey),e.apiKey}catch{}return null};n.useEffect(()=>{g()},[]),n.useEffect(()=>{const e=t=>{v.current&&!v.current.contains(t.target)&&o(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);const b=async e=>{const t=w||await g();if(!t||!e||e.length<2){p([]),o(!1);return}if(C.current[e]){p(C.current[e]),o(!0);return}N(!0);try{const i=await fetch("https://places.googleapis.com/v1/places:autocomplete",{method:"POST",headers:{"Content-Type":"application/json","X-Goog-Api-Key":t,"X-Goog-FieldMask":"suggestions.placePrediction.placeId,suggestions.placePrediction.text,suggestions.placePrediction.structuredFormat"},body:JSON.stringify({input:e})});if(!i.ok){const l=await i.text()}if(i.ok){const r=((await i.json()).suggestions||[]).filter(a=>a.placePrediction).map(a=>{var m,d,c,E,T;return{place_id:a.placePrediction.placeId,name:((d=(m=a.placePrediction.structuredFormat)==null?void 0:m.mainText)==null?void 0:d.text)||((c=a.placePrediction.text)==null?void 0:c.text),formatted_address:((T=(E=a.placePrediction.structuredFormat)==null?void 0:E.secondaryText)==null?void 0:T.text)||""}});C.current[e]=r,p(r),o(r.length>0)}else p([]),o(!1)}catch{p([]),o(!1)}finally{N(!1)}},B=async(e,t)=>{var i;const h=w||await g();if(!h){f(t),u(t),o(!1);return}try{const l=await fetch(`https://places.googleapis.com/v1/places/${e}`,{headers:{"X-Goog-Api-Key":h,"X-Goog-FieldMask":"id,displayName,formattedAddress,addressComponents"}});if(!l.ok)throw new Error(`Place Details API error: ${l.status}`);const r=await l.json();let a=((i=r.displayName)==null?void 0:i.text)||t;if(r.addressComponents){const m=r.addressComponents.find(c=>c.types.includes("locality")||c.types.includes("administrative_area_level_3")),d=r.addressComponents.find(c=>c.types.includes("country"));m&&(a=m.longText,d&&d.shortText!=="ES"&&(a=`${a}, ${d.longText}`))}f(a),u(a),o(!1)}catch{f(t),u(t),o(!1)}},D=e=>{const t=e.target.value;u(t),f(t),j.current&&window.clearTimeout(j.current),j.current=window.setTimeout(()=>b(t),400)},G=e=>{B(e.place_id,e.name)};return s.jsxs("div",{className:k,ref:v,children:[P&&s.jsx(M,{htmlFor:S,children:P}),s.jsxs("div",{className:"relative",children:[s.jsx(X,{id:S,value:R,onChange:D,placeholder:_,className:"pl-9",required:I,onKeyDown:e=>{e.key==="Enter"&&(e.preventDefault(),e.stopPropagation())},onFocus:()=>{w||g(),y.length>0&&o(!0)}}),s.jsx(K,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),s.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2",children:F?s.jsx($,{className:"w-4 h-4 animate-spin text-muted-foreground"}):null}),A&&y.length>0&&s.jsx(O,{className:"absolute z-50 mt-1 w-full border-2 shadow-sm",children:s.jsx("div",{className:"max-h-64 overflow-auto py-1",children:y.map(e=>s.jsx(V,{variant:"ghost",type:"button",className:"w-full h-auto justify-start px-3 py-2 text-left",onClick:()=>G(e),children:s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx(K,{className:"w-4 h-4 mt-0.5 text-primary"}),s.jsxs("div",{children:[s.jsx("div",{className:"text-sm font-medium",children:e.name}),e.formatted_address&&s.jsx("div",{className:"text-xs text-muted-foreground",children:e.formatted_address})]})]})},e.place_id))})})]})]})};export{H as C};
