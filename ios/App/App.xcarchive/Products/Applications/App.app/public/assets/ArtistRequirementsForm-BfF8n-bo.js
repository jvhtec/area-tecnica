import{j as e,aM as q,c as N,e as k,r as u,s as i,a as F,C as I,W as D,Y as L,A as T,B as W}from"./index-NZ6jJLfQ.js";import{B as A,C as M}from"./ConsoleSetupSection-DPK89kfN.js";import{W as j,M as R,E as B,I as P,N as z}from"./NotesSection-Cu_RhFOj.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./checkbox-BsRNEGV1.js";import"./useEquipmentModels--fmk95xL.js";import"./useQuery-kdg2pmgf.js";import"./useMutation-DluhVBs1.js";import"./radio-group-DzKNHD24.js";import"./index-hC3MxXep.js";import"./circle-CWxDyDxx.js";import"./plus-C3JQqq7t.js";import"./minus-InO4I9Ks.js";import"./switch-DUBpZhIC.js";import"./badge-vNTKF5RD.js";import"./circle-alert-LZYNzZ7F.js";const Q=({formData:r,onChange:d})=>{const a=l=>{d({wireless_systems:l})},f=l=>{d({iem_systems:l})};return e.jsxs("div",{className:"space-y-4 border rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Configuración RF & Wireless"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsx(j,{systems:r.wireless_systems||[],onChange:a,label:"Sistemas Wireless",includeQuantityTypes:!0})}),e.jsx("div",{className:"space-y-4",children:e.jsx(j,{systems:r.iem_systems||[],onChange:f,label:"Sistemas IEM",includeQuantityTypes:!0,isIEM:!0})})]})]})},oe=()=>{const{token:r}=q(),d=N(),{toast:a}=k(),[f,l]=u.useState(!0),[_,w]=u.useState(null),[v,S]=u.useState(null),[o,x]=u.useState({foh_console_provided_by:"festival",mon_console_provided_by:"festival",wireless_provided_by:"festival",iem_provided_by:"festival",infrastructure_provided_by:"festival",monitors_enabled:!1,monitors_quantity:0,wireless_quantity_hh:0,wireless_quantity_bp:0,iem_quantity:0,extras_sf:!1,extras_df:!1,extras_djbooth:!1,infra_cat6:!1,infra_cat6_quantity:0,infra_hma:!1,infra_hma_quantity:0,infra_coax:!1,infra_coax_quantity:0,infra_opticalcon_duo:!1,infra_opticalcon_duo_quantity:0,infra_analog:0});u.useEffect(()=>{(async()=>{if(!r){a({title:"Error",description:"Token de formulario inválido",variant:"destructive"});return}try{const{data:t,error:n}=await i.from("festival_artist_forms").select("artist_id, status").eq("token",r).maybeSingle();if(n)throw n;if(!t){a({title:"Error",description:"Token de formulario inválido",variant:"destructive"});return}if(t.status==="completed"){a({title:"Formulario Ya Enviado",description:"Este formulario ya ha sido completado.",variant:"destructive"});return}const{data:s,error:h}=await i.from("festival_artists").select(`
            *,
            jobs:job_id (*)
          `).eq("id",t.artist_id).maybeSingle();if(h)throw h;if(!s){a({title:"Error",description:"Artista no encontrado",variant:"destructive"});return}const{data:p,error:C}=await i.from("festival_logos").select("file_path").eq("job_id",s.job_id).maybeSingle();if(!C){if(p!=null&&p.file_path){const{data:{publicUrl:g}}=i.storage.from("festival-logos").getPublicUrl(p.file_path);S(g)}}x(g=>({...g,name:s.name,stage:s.stage,date:s.date,show_start:s.show_start,show_end:s.show_end,soundcheck:s.soundcheck,soundcheck_start:s.soundcheck_start,soundcheck_end:s.soundcheck_end}));const{data:y,error:b}=await i.from("festival_gear_setups").select("*").eq("job_id",s.job_id).eq("date",s.date).maybeSingle();if(b)throw b;y&&w(y)}catch{a({title:"Error",description:"No se pudieron cargar los datos del formulario. Por favor intente más tarde.",variant:"destructive"})}finally{l(!1)}})()},[r,a]),u.useEffect(()=>{if(!r)return;const m=i.channel("form-status-changes").on("postgres_changes",{event:"*",schema:"public",table:"festival_artist_forms",filter:`token=eq.${r}`},t=>{const n=t.new;n&&n.status==="completed"&&(a({title:"Estado del Formulario Actualizado",description:"Su formulario ha sido enviado correctamente"}),d("/festival/form-submitted"))}).subscribe();return()=>{i.removeChannel(m)}},[r,d,a]);const E=async m=>{if(m.preventDefault(),!(!r||!o)){l(!0);try{const{data:t,error:n}=await i.from("festival_artist_forms").select("id, artist_id, status").eq("token",r).maybeSingle();if(n)throw n;if(!t)throw new Error("Formulario no encontrado");if(t.status==="completed")throw new Error("Este formulario ya ha sido enviado");const{error:s}=await i.from("festival_artist_form_submissions").insert({form_id:t.id,artist_id:t.artist_id,form_data:o,status:"submitted",submitted_at:new Date().toISOString()});if(s)throw s;const{error:h}=await i.from("festival_artist_forms").update({status:"submitted"}).eq("id",t.id);if(h)throw h;a({title:"Éxito",description:"Sus requerimientos técnicos han sido enviados correctamente."}),d("/festival/form-submitted")}catch(t){a({title:"Error",description:t.message||"No se pudo enviar el formulario. Por favor intente más tarde.",variant:"destructive"})}finally{l(!1)}}},c=m=>{x(t=>({...t,...m}))};return f?e.jsx("div",{className:"min-h-screen bg-background p-6",children:e.jsx("div",{className:"max-w-4xl mx-auto space-y-8",children:e.jsx("div",{className:"flex justify-center",children:e.jsx(F,{className:"h-8 w-8 animate-spin"})})})}):e.jsx("div",{className:"min-h-screen bg-background p-6",children:e.jsx("div",{className:"max-w-4xl mx-auto space-y-8",children:e.jsxs("div",{className:"flex flex-col items-center space-y-8",children:[v&&e.jsx("img",{src:v,alt:"Festival Logo",width:192,height:64,loading:"eager",decoding:"async",className:"h-16 w-48 object-contain"}),e.jsxs(I,{children:[e.jsx(D,{children:e.jsx(L,{children:"Formulario de Requerimientos Técnicos del Artista"})}),e.jsx(T,{children:e.jsxs("form",{onSubmit:E,className:"space-y-8",children:[e.jsx(A,{formData:o,onChange:c}),e.jsx(M,{formData:o,onChange:c,gearSetup:_}),e.jsx(Q,{formData:o,onChange:c}),e.jsx(R,{formData:o,onChange:c,gearSetup:_}),e.jsx(B,{formData:o,onChange:c,gearSetup:_}),e.jsx(P,{formData:o,onChange:c,gearSetup:_}),e.jsx(z,{formData:o,onChange:c}),e.jsx(W,{type:"submit",disabled:f,className:"w-full",children:f?"Enviando...":"Enviar Requerimientos"})]})})]}),e.jsx("img",{src:"/sector%20pro%20logo.png",alt:"Company Logo",width:794,height:100,loading:"lazy",decoding:"async",className:"h-16 w-48 object-contain mt-8"})]})})})};export{oe as ArtistRequirementsForm,oe as default};
