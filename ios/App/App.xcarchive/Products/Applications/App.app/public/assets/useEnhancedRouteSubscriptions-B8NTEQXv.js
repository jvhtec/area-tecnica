import{aN as z,f as K,a8 as U,u as k,bX as B,r,bY as P,n as w}from"./index-NZ6jJLfQ.js";import{f as Q}from"./formatDistanceToNow-Bbdi_GlK.js";const v={"/dashboard":[{table:"jobs",priority:"high"},{table:"job_assignments",priority:"high"},{table:"job_date_types",priority:"medium"},{table:"messages",priority:"medium"},{table:"direct_messages",priority:"medium"}],"/sound":[{table:"jobs",priority:"high"},{table:"job_assignments",priority:"high"},{table:"job_departments",priority:"medium"}],"/lights":[{table:"jobs",priority:"high"},{table:"job_assignments",priority:"high"},{table:"job_departments",priority:"medium"}],"/video":[{table:"jobs",priority:"high"},{table:"job_assignments",priority:"high"},{table:"job_departments",priority:"medium"}],"/calendar":[{table:"jobs",priority:"high"},{table:"job_departments",priority:"medium"}],"/technician-dashboard":[{table:"jobs",priority:"high"},{table:"job_assignments",priority:"high"}],"/logistics":[{table:"jobs",priority:"high"},{table:"logistics_events",priority:"high"}],"/inventory":[{table:"equipment",priority:"high"},{table:"stock_movements",priority:"high"},{table:"global_stock_entries",priority:"medium"}],"/tours":[{table:"tours",priority:"high"},{table:"tour_dates",priority:"medium"}],"/project-management":[{table:"jobs",priority:"high"},{table:"job_assignments",priority:"medium"},{table:"job_departments",priority:"medium"}],"/management/rates":[{table:"rate_cards_tour_2025",priority:"high"},{table:"rate_extras_2025",priority:"high"},{table:"custom_tech_rates",priority:"high"},{table:"timesheets",priority:"high"},{table:"tours",priority:"medium"},{table:"jobs",priority:"medium"},{table:"job_assignments",priority:"medium"}],"/gastos":[{table:"job_expenses",priority:"high"},{table:"expense_permissions",priority:"medium"},{table:"expense_categories",priority:"low"}],"/festivals":[{table:"jobs",priority:"high"},{table:"festival_artists",priority:"medium"},{table:"festival_forms",priority:"low"}],"/festival-management":[{table:"festivals",priority:"high"},{table:"festival_artists",priority:"high"},{table:"festival_forms",priority:"medium"},{table:"festival_shifts",priority:"medium"},{table:"festival_shift_assignments",priority:"medium"},{table:"festival_gear_setups",priority:"medium"}],"/festival-management/artists":[{table:"festivals",priority:"high"},{table:"festival_artists",priority:"high"},{table:"festival_forms",priority:"high"}],"/festival-management/gear":[{table:"festivals",priority:"high"},{table:"festival_gear",priority:"high"},{table:"festival_gear_setups",priority:"high"}],"/festival-management/scheduling":[{table:"festivals",priority:"high"},{table:"festival_shifts",priority:"high"},{table:"festival_shift_assignments",priority:"high"},{table:"profiles",priority:"medium"}],"/festival-artist-management":[{table:"festivals",priority:"high"},{table:"festival_artists",priority:"high"},{table:"festival_forms",priority:"high"}],"/festival-gear-management":[{table:"festivals",priority:"high"},{table:"festival_gear",priority:"high"}],"/pesos-tool":[{table:"jobs",priority:"high"},{table:"video_memoria_tecnica_documents",priority:"high"}],"/consumos-tool":[{table:"jobs",priority:"high"},{table:"power_requirement_tables",priority:"high"}],"/memoria-tecnica-tool":[{table:"jobs",priority:"high"},{table:"memoria_tecnica_documents",priority:"high"}],"/jobs":[{table:"jobs",priority:"high"}],"/job":[{table:"jobs",priority:"high"},{table:"job_assignments",priority:"high"},{table:"job_departments",priority:"medium"}],"/settings":[{table:"profiles",priority:"medium"}],"/profile":[{table:"profiles",priority:"high"}],"/users":[{table:"profiles",priority:"high"}],"/users-management":[{table:"profiles",priority:"high"}],"/hoja-de-ruta":[{table:"jobs",priority:"high"},{table:"job_departments",priority:"medium"}],"/labor-po-form":[{table:"jobs",priority:"high"},{table:"job_departments",priority:"medium"}]},V={jobs:["optimized-jobs"],job_assignments:["optimized-jobs"],job_departments:["optimized-jobs"],job_documents:["optimized-jobs"],flex_folders:["optimized-jobs"],locations:["optimized-jobs"],job_date_types:["date-types"],messages:["messages"],direct_messages:["direct_messages"]},Y=u=>V[u]??[u],F=[{table:"profiles",priority:"medium"}],M=300*1e3,H=180*1e3;function X(){const u=z(),p=K(),{lastRefreshTime:d,connectionStatus:L}=U(),{userRole:q}=k(),x=q==="admin",o=B.getInstance(p),f=r.useRef(Date.now()),g=r.useRef(!1),j=r.useRef(null),n=P.getInstance(p),[m,I]=r.useState(!0),[l,A]=r.useState({requiredTables:[],subscribedTables:[],unsubscribedTables:[],isFullySubscribed:!1,isStale:!1,routeKey:"",formattedLastActivity:""});r.useEffect(()=>{const e=i=>{I(i.detail.isLeader)};return window.addEventListener("tab-leader-elected",e),()=>{window.removeEventListener("tab-leader-elected",e)}},[]);const T=r.useCallback(e=>v[e]?e:e.includes("/festival-management/")?e.includes("/artists")?"/festival-management/artists":e.includes("/gear")?"/festival-management/gear":e.includes("/scheduling")?"/festival-management/scheduling":"/festival-management":e.includes("/pesos-tool")?"/pesos-tool":e.includes("/consumos-tool")?"/consumos-tool":e.includes("/memoria-tecnica-tool")?"/memoria-tecnica-tool":Object.keys(v).filter(i=>e.startsWith(i)).sort((i,b)=>b.length-i.length)[0]||e,[]);r.useEffect(()=>{const e=()=>{const i=Date.now();if(document.visibilityState==="visible"&&m){if(i-f.current>H){g.current=!0;const c=[...l.requiredTables];c.length>0&&(o.forceRefreshSubscriptions(c),n.invalidateQueries(),w.info("Refreshing data after inactivity",{description:"Reconnecting to real-time updates..."}))}f.current=i}};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}},[o,p,l.requiredTables,m,n]),r.useEffect(()=>{g.current=!1,f.current=Date.now();const e=u.pathname,i=T(e),b=j.current;b&&b!==i&&o.cleanupRouteDependentSubscriptions(b),j.current=i;const c=v[i]||[];c.length;const a=[...F];if(c.forEach(t=>{if(!a.some(s=>s.table===t.table))a.push(t);else{const s=a.findIndex(h=>h.table===t.table);if(s>=0){const h=a[s].priority;S(t.priority)>S(h)&&(a[s].priority=t.priority)}}}),m)a.forEach(({table:t,priority:s})=>{const h=Y(t),N=o.subscribeToTable(t,h,void 0,s);o.registerRouteSubscription(i,N.key)});else{const t=a.map(s=>s.table);n.requestSubscriptions(t)}const y=a.map(t=>t.table),_=o.getSubscriptionsByTable(),C=y.filter(t=>{var s;return((s=_[t])==null?void 0:s.length)>0}),R=y.filter(t=>!_[t]||_[t].length===0),O=R.length===0&&y.length>0;let E="Unknown";try{E=Q(d,{addSuffix:!0})}catch{}const D=Date.now()-d>M;A({requiredTables:y,subscribedTables:C,unsubscribedTables:R,isFullySubscribed:O,isStale:D,routeKey:i,formattedLastActivity:E})},[u.pathname,o,T,d,p,m,n]);function S(e){switch(e){case"high":return 3;case"medium":return 2;case"low":return 1;default:return 2}}return{...l,connectionStatus:L,lastRefreshTime:d,wasInactive:g.current,forceRefresh:()=>{l.requiredTables.length>0&&(m?(o.forceRefreshSubscriptions(l.requiredTables),n.invalidateQueries(),x&&w.success("Subscriptions refreshed")):n.requestSubscriptions(l.requiredTables),g.current=!1)}}}export{v as R,X as u};
