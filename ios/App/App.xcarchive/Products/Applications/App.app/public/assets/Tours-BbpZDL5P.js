import{s as b,r as l,c as ze,e as ge,f as je,d as Pe,j as e,C as we,W as ye,Y as Ne,B as P,A as ve,i as I,M as Qe,L as Q,I as de,ac as Ke,S as Ge,t as We,v as Xe,w as Ye,x as ne,aD as Ze,D as Je,q as et,F as tt,G as st,a as pe,P as He,a2 as Re,R as at,a0 as ce,u as rt}from"./index-NZ6jJLfQ.js";import{u as nt}from"./useQuery-kdg2pmgf.js";import{T as ot,a as it,e as lt}from"./tourPdfExport-DYrs6JHM.js";import{D as dt,a as ct,b as mt,c as B}from"./dropdown-menu-Dn1SMjj1.js";import{S as Oe,a as Le,b as Ue,c as qe,d as Ae}from"./sheet-DFFfLazF.js";import{B as Y}from"./badge-vNTKF5RD.js";import{c as ut,s as ee}from"./folderNameSanitizer-DNdk00QU.js";import{F as M,R as me,D as ue,a as fe}from"./constants-DoXhG9KB.js";import{E as xe}from"./ellipsis-vertical-zRAfIP3L.js";import{S as Fe}from"./settings-egXcSQW9.js";import{C as oe}from"./calendar-_Cj_Sgy-.js";import{C as he}from"./circle-x-DDzV-xk_.js";import{C as Ie}from"./circle-check-big-CilmNGCn.js";import{F as K}from"./folder-plus-DTUhlRcm.js";import{H as Me}from"./hard-drive-DZn0Cm3i.js";import{P as ke}from"./printer-De77t3j8.js";import{F as ft}from"./file-text-igU140SQ.js";import{I as ht}from"./image--Pql38nK.js";import{C as pt}from"./checkbox-BsRNEGV1.js";import{P as xt}from"./plus-C3JQqq7t.js";import{E as Ee}from"./eye-off-ljd0ixjZ.js";import{E as $e}from"./eye-BE_DouVP.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./scroll-area-BHjMXddA.js";import"./clock-BXPvTWvY.js";import"./api-C9EDenHJ.js";import"./config-DVV3VxR4.js";import"./useRealtimeSubscription-Bj7PWAKC.js";import"./optimisticJobDeletionService-Bq-53fU4.js";import"./package-Oxfj-CNq.js";import"./square-pen-BMpSgZGa.js";import"./building-2-nIk8XRuA.js";import"./alert-dialog-CtyYUxwH.js";import"./tabs-BdaywI_b.js";import"./index-hC3MxXep.js";import"./pdfExport-DjZPdCcG.js";import"./lazyPdf-xVUlxKNu.js";import"./logoUtils-D2o1jUVg.js";import"./logo-url-cache-eY6nfvu7.js";import"./useTourPowerDefaults-COrAOuj-.js";import"./useMutation-DluhVBs1.js";import"./useTourDefaultSets-CKjECdAO.js";import"./calculator-jIsLl-gd.js";import"./download-C1rVE0-J.js";import"./upload-DF4rjO7T.js";import"./index-D9TsP8oP.js";import"./chevron-right-Bn7Eu0F7.js";import"./circle-CWxDyDxx.js";async function gt(h){try{const{data:t,error:n}=await b.functions.invoke("create-flex-folders",{body:{tourId:h,createRootFolders:!0,createDateFolders:!1}});return n?{success:!1,error:n.message||"Failed to create tour root folders"}:{success:!0,data:t}}catch(t){return{success:!1,error:t.message||"Unknown error occurred"}}}async function jt(h){try{const{data:t,error:n}=await b.functions.invoke("create-flex-folders",{body:{tourId:h,createRootFolders:!1,createDateFolders:!0}});return n?{success:!1,error:n.message||"Failed to create tour date folders"}:{success:!0,data:t}}catch(t){return{success:!1,error:t.message||"Unknown error occurred"}}}async function wt(h){var t;try{const{data:n,error:T}=await b.from("tours").select(`
        *,
        tour_dates (
          id,
          date,
          location_id
        )
      `).eq("id",h).single();if(T||!n)throw new Error("Tour not found");let o=n.start_date,N=n.end_date;if(!o||!N){const s=((t=n.tour_dates)==null?void 0:t.map(r=>r.date).sort())||[];if(s.length===0)throw new Error("No tour dates found");o=s[0],N=s[s.length-1]}const i=async s=>{const{data:r,error:D}=await b.functions.invoke("secure-flex-api",{body:{endpoint:"/element",method:"POST",payload:s}});if(D)throw new Error(D.message||"Failed to create folder in Flex");if(!r.success)throw new Error(r.error||"Failed to create folder in Flex");return r.data},c=new Date(o).toISOString().split(".")[0]+".000Z",m=new Date(N).toISOString().split(".")[0]+".000Z",g=new Date(o).toISOString().slice(2,10).replace(/-/g,""),j={definitionId:M.mainFolder,parentElementId:null,open:!0,locked:!1,name:n.name,plannedStartDate:c,plannedEndDate:m,locationId:M.location,notes:"Manual folder creation from Web App",documentNumber:g,personResponsibleId:M.mainResponsible},v=await i(j),p={flex_main_folder_id:v.elementId,flex_main_folder_number:v.elementNumber,flex_folders_created:!0},w=["sound","lights","video","production","personnel","comercial"];for(const s of w){const r={definitionId:M.subFolder,parentElementId:v.elementId,open:!0,locked:!1,name:`${n.name} - ${s.charAt(0).toUpperCase()+s.slice(1)}`,plannedStartDate:c,plannedEndDate:m,locationId:M.location,departmentId:fe[s],notes:`Manual subfolder creation for ${s}`,documentNumber:`${g}${ue[s]}`,personResponsibleId:me[s]};try{const D=await i(r);if(p[`flex_${s}_folder_id`]=D.elementId,p[`flex_${s}_folder_number`]=D.elementNumber,await b.from("flex_folders").insert({job_id:null,parent_id:v.elementId,element_id:D.elementId,department:s,folder_type:"tour_department"}),["sound","lights","video"].includes(s)){const y=s==="sound"?M.hojaInfoSx:s==="lights"?M.hojaInfoLx:M.hojaInfoVx,_=s==="sound"?"SIP":s==="lights"?"LIP":"VIP",H={definitionId:y,parentElementId:D.elementId,open:!0,locked:!1,name:`Hoja de InformaciÃ³n - ${n.name}`,plannedStartDate:c,plannedEndDate:m,locationId:M.location,departmentId:fe[s],documentNumber:`${g}${ue[s]}${_}`,personResponsibleId:me[s]};try{await i(H)}catch{}}if(["sound","lights","video","production"].includes(s)){const y=[{definitionId:M.documentacionTecnica,name:`DocumentaciÃ³n TÃ©cnica - ${s.charAt(0).toUpperCase()+s.slice(1)}`,suffix:"DT"},{definitionId:M.presupuestosRecibidos,name:`Presupuestos Recibidos - ${s.charAt(0).toUpperCase()+s.slice(1)}`,suffix:"PR"},{definitionId:M.hojaGastos,name:`Hoja de Gastos - ${s.charAt(0).toUpperCase()+s.slice(1)}`,suffix:"HG"}];for(const _ of y){const H={definitionId:_.definitionId,parentElementId:D.elementId,open:!0,locked:!1,name:_.name,plannedStartDate:c,plannedEndDate:m,locationId:M.location,departmentId:fe[s],documentNumber:`${g}${ue[s]}${_.suffix}`,personResponsibleId:me[s]};try{await i(H)}catch{continue}}}}catch{continue}}const{error:u}=await b.from("tours").update(p).eq("id",n.id);if(u)throw u;return{success:!0,data:p}}catch(n){return{success:!1,error:n.message||"Unknown error occurred"}}}const yt=l.memo(function({tour:t,onTourClick:n,onManageDates:T,onPrint:o}){var te,se;const N=ze(),{toast:i}=ge(),c=je(),[m,g]=l.useState(!1),[j,v]=l.useState(null),[p,w]=l.useState(!1),[u,s]=l.useState(!1),r=Pe();l.useEffect(()=>{(async()=>{if(!t.id)return;const{data:f,error:R}=await b.from("tour_logos").select("file_path").eq("tour_id",t.id).maybeSingle();if(!R&&(f!=null&&f.file_path))try{const{data:q}=await b.storage.from("tour-logos").createSignedUrl(f.file_path,3600);if(q!=null&&q.signedUrl)v(q.signedUrl);else{const{data:E}=b.storage.from("tour-logos").getPublicUrl(f.file_path);E!=null&&E.publicUrl&&v(E.publicUrl)}}catch{const{data:E}=b.storage.from("tour-logos").getPublicUrl(f.file_path);E!=null&&E.publicUrl&&v(E.publicUrl)}})()},[t.id]);const y=t.tour_dates?t.tour_dates.filter(x=>new Date(x.start_date||x.date)>=new Date).slice(0,3):[],_=()=>{n?n(t.id):N(`/tour-management/${t.id}`)},H=async x=>{if(x.stopPropagation(),w(!1),t.flex_folders_created){i({title:"Root folders already exist",description:"Tour root folders have already been created for this tour.",variant:"destructive"});return}try{const f=await wt(t.id);if(!f.success)throw new Error(f.error||"Failed to create tour root folders");i({title:"Success",description:"Tour root folders have been created successfully using secure-flex-api."})}catch(f){i({title:"Error creating tour root folders",description:f.message,variant:"destructive"})}},U=async x=>{if(x.stopPropagation(),w(!1),!t.flex_folders_created){i({title:"Root folders required",description:"Please create tour root folders first before creating date folders.",variant:"destructive"});return}try{const f=await jt(t.id);if(!f.success)throw new Error(f.error||"Failed to create tour date folders");i({title:"Success",description:"Tour date folders have been created successfully."})}catch(f){i({title:"Error creating tour date folders",description:f.message,variant:"destructive"})}},k=async x=>{var f,R,q,E,De,Ce,be,_e;if(x.stopPropagation(),w(!1),!u){if(!("showDirectoryPicker"in window)){i({title:"Not supported",description:"Your browser doesn't support local folder creation. Please use Chrome, Edge, or another Chromium-based browser.",variant:"destructive"});return}try{s(!0);const V=await window.showDirectoryPicker(),O=t.start_date?new Date(t.start_date):null,Se=t.end_date?new Date(t.end_date):null;let ae="";O&&Se?ae=`${I(O,"yyMMdd")} to ${I(Se,"yyMMdd")}`:O?ae=I(O,"yyMMdd"):ae="TBD";const{name:Te,wasSanitized:Be}=ut(t.name,ae),ie=await V.getDirectoryHandle(Te,{create:!0}),{data:{user:le}}=await b.auth.getUser();let X=null;if(le){const{data:C}=await b.from("profiles").select("custom_tour_folder_structure, role").eq("id",le.id).single();C&&(C.role==="admin"||C.role==="management")&&C.custom_tour_folder_structure&&(X=C.custom_tour_folder_structure)}if(X||(X=[{name:"00 - Tour Documents",subfolders:["Contracts","Insurance","Permits","Logistics"]},{name:"01 - Technical",subfolders:["Sound","Lights","Video","Stage"]},{name:"02 - Marketing",subfolders:["Logos","Press","Social Media"]},{name:"03 - Dates",subfolders:[]},{name:"04 - Archive",subfolders:["OLD"]}]),Array.isArray(X)){for(const C of X)if(typeof C=="string")await(await ie.getDirectoryHandle(C,{create:!0})).getDirectoryHandle("OLD",{create:!0});else if(C&&typeof C=="object"&&C.name)if(C.name==="tourdates"&&t.tour_dates&&t.tour_dates.length>0){const re=[...t.tour_dates].sort((F,$)=>new Date(F.start_date||F.date).getTime()-new Date($.start_date||$.date).getTime());for(const F of re){let $="";const S=new Date(F.start_date||F.date);if(F.date_type==="rehearsal"&&F.end_date){const J=new Date(F.end_date);$=`${I(S,"yyMMdd")}-${I(J,"yyMMdd")} - ${((f=F.location)==null?void 0:f.name)||"TBD"}, Rehearsal`}else F.date_type==="travel"?$=`${I(S,"yyMMdd")} - ${((R=F.location)==null?void 0:R.name)||"TBD"}, Travel`:$=`${I(S,"yyMMdd")} - ${((q=F.location)==null?void 0:q.name)||"TBD"}, Show`;const L=ee($),A=await ie.getDirectoryHandle(L,{create:!0});if(C.subfolders&&Array.isArray(C.subfolders)&&C.subfolders.length>0)for(const J of C.subfolders){const z=ee(J);await A.getDirectoryHandle(z,{create:!0})}else await A.getDirectoryHandle("Technical",{create:!0}),await A.getDirectoryHandle("Logistics",{create:!0}),await A.getDirectoryHandle("Documentation",{create:!0})}}else{const re=ee(C.name),F=await ie.getDirectoryHandle(re,{create:!0});if(C.subfolders&&Array.isArray(C.subfolders)&&C.subfolders.length>0)for(const $ of C.subfolders){const S=ee($);await F.getDirectoryHandle(S,{create:!0})}else await F.getDirectoryHandle("OLD",{create:!0});if(C.name==="03 - Dates"&&t.tour_dates&&t.tour_dates.length>0){const $=[...t.tour_dates].sort((S,L)=>new Date(S.start_date||S.date).getTime()-new Date(L.start_date||L.date).getTime());for(const S of $){let L="";const A=new Date(S.start_date||S.date);if(S.date_type==="rehearsal"&&S.end_date){const Ve=new Date(S.end_date);L=`${I(A,"yyMMdd")}-${I(Ve,"yyMMdd")} - ${((E=S.location)==null?void 0:E.name)||"TBD"} - Rehearsal`}else S.date_type==="travel"?L=`${I(A,"yyMMdd")} - ${((De=S.location)==null?void 0:De.name)||"TBD"} - Travel`:L=`${I(A,"yyMMdd")} - ${((Ce=S.location)==null?void 0:Ce.name)||"TBD"} - Show`;const J=ee(L),z=await F.getDirectoryHandle(J,{create:!0});await z.getDirectoryHandle("Technical",{create:!0}),await z.getDirectoryHandle("Logistics",{create:!0}),await z.getDirectoryHandle("Documentation",{create:!0}),S.date_type==="rehearsal"&&(await z.getDirectoryHandle("Schedule",{create:!0}),await z.getDirectoryHandle("Notes",{create:!0}))}}}}i({title:"Success!",description:`${le&&X!==null?"Custom":"Default"} tour folder structure created at "${Te}"`})}catch(V){if(V.name==="AbortError")return;let O="Failed to create folders";(be=V.message)!=null&&be.includes("Name is not allowed")?O="Invalid folder name detected. Please try again or contact support.":(_e=V.message)!=null&&_e.includes("getDirectoryHandle")?O="Unable to create folder structure. Check for special characters in folder names.":V.message&&(O=V.message),i({title:"Error",description:O,variant:"destructive"})}finally{s(!1)}}},G=()=>{g(!0),w(!1)},W=()=>{T(),w(!1)},a=()=>{o(),w(!1)},d=async()=>{const x=t.status==="active"?"cancelled":"active",f=x==="cancelled"?"cancel":"reactivate";try{const{error:R}=await b.from("tours").update({status:x}).eq("id",t.id);if(R)throw R;await c.invalidateQueries({queryKey:["tours"]}),await c.invalidateQueries({queryKey:["tour",t.id]}),i({title:"Success",description:`Tour ${f}ed successfully`})}catch(R){i({title:"Error",description:`Failed to ${f} tour: ${R.message}`,variant:"destructive"})}w(!1)},Z=()=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center p-3 hover:bg-accent cursor-pointer rounded-md transition-colors",onClick:G,children:[e.jsx(Fe,{className:"h-4 w-4 mr-3"}),e.jsx("span",{children:"Manage Tour"})]}),e.jsxs("div",{className:"flex items-center p-3 hover:bg-accent cursor-pointer rounded-md transition-colors",onClick:W,children:[e.jsx(oe,{className:"h-4 w-4 mr-3"}),e.jsx("span",{children:"Manage Dates"})]}),t.status==="active"?e.jsxs("div",{className:"flex items-center p-3 hover:bg-accent cursor-pointer rounded-md transition-colors text-red-600",onClick:d,children:[e.jsx(he,{className:"h-4 w-4 mr-3"}),e.jsx("span",{children:"Mark as Not Happening"})]}):e.jsxs("div",{className:"flex items-center p-3 hover:bg-accent cursor-pointer rounded-md transition-colors text-green-600",onClick:d,children:[e.jsx(Ie,{className:"h-4 w-4 mr-3"}),e.jsx("span",{children:"Reactivate Tour"})]}),!t.flex_folders_created&&e.jsxs("div",{className:"flex items-center p-3 hover:bg-accent cursor-pointer rounded-md transition-colors",onClick:H,children:[e.jsx(K,{className:"h-4 w-4 mr-3"}),e.jsx("span",{children:"Create Tour Root Folders"})]}),e.jsxs("div",{className:`flex items-center p-3 hover:bg-accent cursor-pointer rounded-md transition-colors ${t.flex_folders_created?"":"opacity-50 cursor-not-allowed"}`,onClick:t.flex_folders_created?U:void 0,children:[e.jsx(K,{className:"h-4 w-4 mr-3"}),e.jsx("span",{children:t.flex_folders_created?"Create Date Folders":"Create Root Folders First"})]}),e.jsxs("div",{className:`flex items-center p-3 hover:bg-accent cursor-pointer rounded-md transition-colors ${u?"opacity-50 cursor-not-allowed":""}`,onClick:u?void 0:k,children:[e.jsx(Me,{className:"h-4 w-4 mr-3"}),e.jsx("span",{children:u?"Creating Local Folders...":"Create Local Folders"})]}),e.jsxs("div",{className:"flex items-center p-3 hover:bg-accent cursor-pointer rounded-md transition-colors",onClick:a,children:[e.jsx(ke,{className:"h-4 w-4 mr-3"}),e.jsx("span",{children:"Print Schedule"})]})]});return e.jsxs(e.Fragment,{children:[e.jsxs(we,{className:"cursor-pointer hover:shadow-md transition-shadow h-full flex flex-col",onClick:_,children:[e.jsx(ye,{className:"pb-3 relative px-3 py-3 md:px-6 md:py-4",style:{backgroundColor:`${t.color}20`},children:e.jsxs("div",{className:"flex justify-between items-start gap-2",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start gap-2 md:gap-3 mb-2",children:[j&&e.jsx("div",{className:"w-10 h-10 md:w-12 md:h-12 flex-shrink-0",children:e.jsx("img",{src:j,alt:"Tour logo",width:48,height:48,loading:"lazy",decoding:"async",className:"w-full h-full object-contain rounded",onError:x=>{const f=x.target;f.style.display="none"}})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(Ne,{className:"text-base md:text-lg truncate md:whitespace-normal",children:t.name}),t.description&&e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground line-clamp-2 mt-1",children:t.description})]})]})}),r?e.jsxs(Oe,{open:p,onOpenChange:w,children:[e.jsx(Le,{asChild:!0,children:e.jsx(P,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 touch-manipulation",onClick:x=>x.stopPropagation(),children:e.jsx(xe,{className:"h-5 w-5"})})}),e.jsxs(Ue,{side:"bottom",className:"h-auto max-h-[50vh]",children:[e.jsx(qe,{children:e.jsxs(Ae,{children:[t.name," - Options"]})}),e.jsx("div",{className:"grid gap-2 pt-4",children:e.jsx(Z,{})})]})]}):e.jsxs(dt,{children:[e.jsx(ct,{asChild:!0,children:e.jsx(P,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:x=>x.stopPropagation(),children:e.jsx(xe,{className:"h-4 w-4"})})}),e.jsxs(mt,{align:"end",className:"w-56 z-[9999]",sideOffset:5,children:[e.jsxs(B,{onClick:G,children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Manage Tour"]}),e.jsxs(B,{onClick:W,children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Manage Dates"]}),t.status==="active"?e.jsxs(B,{onClick:d,className:"text-red-600 hover:text-red-700",children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),"Mark as Not Happening"]}):e.jsxs(B,{onClick:d,className:"text-green-600 hover:text-green-700",children:[e.jsx(Ie,{className:"h-4 w-4 mr-2"}),"Reactivate Tour"]}),!t.flex_folders_created&&e.jsxs(B,{onClick:H,children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"Create Tour Root Folders"]}),e.jsxs(B,{onClick:U,disabled:!t.flex_folders_created,children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),t.flex_folders_created?"Create Date Folders":"Create Root Folders First"]}),e.jsxs(B,{onClick:k,disabled:u,children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),u?"Creating Local Folders...":"Create Local Folders"]}),e.jsxs(B,{onClick:a,children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Print Schedule"]})]})]})]})}),e.jsx(ve,{className:"pt-3 px-3 pb-4 md:px-6 md:pb-6 flex-1",children:e.jsxs("div",{className:"space-y-3 md:space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsxs("span",{className:"text-muted-foreground",children:[((te=t.tour_dates)==null?void 0:te.length)||0," dates"]})]}),t.start_date&&t.end_date&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[I(new Date(t.start_date),"MMM d")," - ",I(new Date(t.end_date),"MMM d, yyyy")]})]}),y.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-xs md:text-sm font-medium",children:"Upcoming:"}),y.map(x=>{var f;return e.jsxs("div",{className:"flex flex-wrap items-center gap-1 md:gap-2 text-xs",children:[e.jsx(oe,{className:"h-3 w-3 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"whitespace-nowrap",children:I(new Date(x.start_date||x.date),"MMM d, yyyy")}),((f=x.location)==null?void 0:f.name)&&e.jsxs(e.Fragment,{children:[e.jsx(Qe,{className:"h-3 w-3 text-muted-foreground flex-shrink-0 ml-1"}),e.jsx("span",{className:"text-muted-foreground truncate",children:x.location.name})]})]},x.id)})]}),e.jsxs("div",{className:"flex gap-1.5 md:gap-2 flex-wrap",children:[t.status==="cancelled"&&e.jsxs(Y,{variant:"destructive",className:"text-xs",children:[e.jsx(he,{className:"h-3 w-3 mr-1"}),"Cancelled"]}),t.flex_folders_created?e.jsxs(Y,{variant:"secondary",className:"text-xs",children:[e.jsx(ft,{className:"h-3 w-3 mr-1"}),"Flex Ready"]}):e.jsxs(Y,{variant:"outline",className:"text-xs border-orange-300 text-orange-700",children:[e.jsx(K,{className:"h-3 w-3 mr-1"}),"Needs Root Folders"]}),j&&e.jsxs(Y,{variant:"secondary",className:"text-xs",children:[e.jsx(ht,{className:"h-3 w-3 mr-1"}),"Logo"]}),e.jsxs(Y,{variant:"outline",className:"text-xs",style:{borderColor:t.color,color:t.color},children:[((se=t.tour_dates)==null?void 0:se.length)||0," dates"]})]})]})})]}),e.jsx(ot,{open:m,onOpenChange:g,tour:t})]})}),Nt=(h,t)=>{const[n,T]=l.useState(""),[o,N]=l.useState(""),[i,c]=l.useState("#7E69AB"),[m,g]=l.useState([h]),[j,v]=l.useState(""),[p,w]=l.useState(""),[u,s]=l.useState(null),[r,D]=l.useState(!1),{toast:y}=ge(),_=je(),H=(a,d)=>{g(d?[...m,a]:m.filter(Z=>Z!==a))},U=a=>{v(a)},k=a=>{w(a)},G=async()=>{const{data:a,error:d}=await b.from("tours").insert({name:n,description:o,color:i,start_date:j||null,end_date:p||null,invoicing_company:u}).select().single();if(d)throw d;return a};return{title:n,setTitle:T,description:o,setDescription:N,color:i,setColor:c,departments:m,handleDepartmentChange:H,handleSubmit:async a=>{if(a.preventDefault(),!r){if(!n.trim()){y({title:"Error",description:"Please enter a title for the tour",variant:"destructive"});return}if(j&&p&&new Date(j)>new Date(p)){y({title:"Invalid Dates",description:"End date cannot be earlier than start date",variant:"destructive"});return}D(!0);try{await G(),await _.invalidateQueries({queryKey:["optimized-jobs"]}),await _.invalidateQueries({queryKey:["jobs"]}),await _.invalidateQueries({queryKey:["tours"]}),y({title:"Success",description:"Tour created successfully. Add tour dates from the tour management dialog."}),t(),T(""),N(""),c("#7E69AB"),g([h]),v(""),w(""),s(null)}catch(d){y({title:"Error",description:d.message||"Failed to create tour",variant:"destructive"})}finally{D(!1)}}},startDate:j,endDate:p,handleStartDateChange:U,handleEndDateChange:k,invoicingCompany:u,setInvoicingCompany:s,isCreating:r}},vt=({departments:h,availableDepartments:t,currentDepartment:n,onDepartmentChange:T})=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Departments"}),e.jsx("div",{className:"flex flex-col gap-2",children:t.map(o=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(pt,{id:`dept-${o}`,checked:h.includes(o),onCheckedChange:N=>T(o,N),disabled:o===n}),e.jsx(Q,{htmlFor:`dept-${o}`,children:o.charAt(0).toUpperCase()+o.slice(1)})]},o))})]}),Dt=({title:h,setTitle:t,description:n,setDescription:T,color:o,setColor:N,departments:i,availableDepartments:c,currentDepartment:m,onDepartmentChange:g,startDate:j,endDate:v,onStartDateChange:p,onEndDateChange:w,invoicingCompany:u,setInvoicingCompany:s})=>e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"title",children:"Title"}),e.jsx(de,{id:"title",value:h,onChange:r=>t(r.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"description",children:"Description"}),e.jsx(Ke,{id:"description",value:n,onChange:r=>T(r.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"startDate",children:"Start Date"}),e.jsx(de,{id:"startDate",type:"date",value:j,onChange:r=>p(r.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{htmlFor:"endDate",children:"End Date"}),e.jsx(de,{id:"endDate",type:"date",value:v,min:j,onChange:r=>w(r.target.value)})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"ğŸ’¡ Tour dates (shows, rehearsals, travel days) can be added after creation from the tour management dialog."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Invoicing Company"}),e.jsxs(Ge,{value:u||"none",onValueChange:r=>s(r==="none"?null:r),children:[e.jsx(We,{children:e.jsx(Xe,{placeholder:"Select invoicing company (optional)"})}),e.jsxs(Ye,{children:[e.jsx(ne,{value:"none",children:"None"}),e.jsx(ne,{value:"Production Sector",children:"Production Sector"}),e.jsx(ne,{value:"Sharecable",children:"Sharecable"}),e.jsx(ne,{value:"MFO",children:"MFO"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"If set, all tour date jobs will inherit this invoicing company"})]}),e.jsx(vt,{departments:i,availableDepartments:c,currentDepartment:m,onDepartmentChange:g}),e.jsx(Ze,{color:o,onChange:N})]}),Ct=({open:h,onOpenChange:t,currentDepartment:n})=>{const{title:T,setTitle:o,description:N,setDescription:i,color:c,setColor:m,departments:g,handleDepartmentChange:j,handleSubmit:v,startDate:p,endDate:w,handleStartDateChange:u,handleEndDateChange:s,invoicingCompany:r,setInvoicingCompany:D,isCreating:y}=Nt(n,()=>t(!1)),_=["sound","lights","video","production","logistics","administrative","personnel","comercial"];return e.jsx(Je,{open:h,onOpenChange:t,children:e.jsxs(et,{className:"max-w-2xl max-h-[90vh] md:max-h-[85vh] overflow-y-auto flex flex-col gap-0 p-0",children:[e.jsx(tt,{className:"px-4 pt-4 md:px-6 md:pt-6",children:e.jsx(st,{className:"text-base md:text-lg",children:"Create New Tour"})}),e.jsx("form",{onSubmit:v,className:"flex-1 overflow-y-auto px-4 md:px-6 pb-4 md:pb-6",children:e.jsxs("div",{className:"space-y-4 md:space-y-6 pt-4",children:[e.jsx(Dt,{title:T,setTitle:o,description:N,setDescription:i,color:c,setColor:m,departments:g,availableDepartments:_,currentDepartment:n,onDepartmentChange:j,startDate:p,endDate:w,onStartDateChange:u,onEndDateChange:s,invoicingCompany:r,setInvoicingCompany:D}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row justify-end gap-2 md:gap-3 pt-4 border-t",children:[e.jsx(P,{type:"button",variant:"outline",onClick:()=>t(!1),className:"w-full sm:w-auto",children:"Cancel"}),e.jsx(P,{type:"submit",className:"w-full sm:w-auto min-w-[120px]",disabled:y,children:y?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-4 w-4 mr-2 animate-spin"}),"Creating..."]}):"Create Tour"})]})]})})]})})},bt=({tours:h,onRefresh:t,isCollapsible:n=!1,defaultCollapsed:T=!1})=>{const{toast:o}=ge(),[N,i]=l.useState(!1),[c,m]=l.useState(!1),[g,j]=l.useState(T),v=new Date;v.setHours(0,0,0,0);const p=h.filter(s=>{if(s.flex_folders_created||s.status==="cancelled")return!1;if(s.end_date){const r=new Date(s.end_date);if(r.setHours(0,0,0,0),r<v)return!1}return!0}),w=async()=>{m(!0);try{let s=0;for(const r of p)if(r.flex_main_folder_id){const{error:D}=await b.from("tours").update({flex_folders_created:!0}).eq("id",r.id);D||s++}s>0?(o({title:"Verification Complete",description:`Updated ${s} tour(s) with correct folder status.`}),t()):o({title:"Verification Complete",description:"No tours needed status updates."})}catch(s){o({title:"Verification Failed",description:s.message||"Failed to verify folder status",variant:"destructive"})}finally{m(!1)}},u=async()=>{i(!0);try{let s=0,r=0;const D=[];for(const y of p)try{const _=await gt(y.id);_.success?s++:(r++,D.push(`${y.name}: ${_.error}`))}catch(_){r++,D.push(`${y.name}: ${_.message}`)}s>0&&(o({title:"Bulk Creation Complete",description:`Successfully created root folders for ${s} tour(s).${r>0?` ${r} failed.`:""}`}),t()),r>0&&o({title:"Some Tours Failed",description:`${r} tour(s) failed to create root folders. Check console for details.`,variant:"destructive"})}catch(s){o({title:"Bulk Creation Failed",description:s.message||"Failed to create root folders",variant:"destructive"})}finally{i(!1)}};return p.length===0?null:e.jsxs(we,{className:"mb-4 border-orange-200 bg-orange-50 dark:bg-orange-950/20",children:[e.jsx(ye,{className:"pb-3 px-4 py-3 md:px-6 md:py-4",children:e.jsxs(Ne,{className:"text-base md:text-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-4 w-4 md:h-5 md:w-5 text-orange-600 flex-shrink-0"}),e.jsx("span",{className:"text-sm md:text-base",children:"Legacy Tours Detected"})]}),n&&e.jsx(P,{variant:"ghost",size:"sm",onClick:()=>j(!g),className:"h-8 w-8 p-0 touch-manipulation",children:g?e.jsx(He,{className:"h-4 w-4"}):e.jsx(Re,{className:"h-4 w-4"})})]})}),!g&&e.jsx(ve,{className:"px-4 pb-4 md:px-6 md:pb-6",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-xs md:text-sm text-muted-foreground",children:[p.length," tour(s) appear to need root folders. This might be a display issue if folders already exist."]}),e.jsx("div",{className:"flex flex-wrap gap-1.5 md:gap-2",children:p.map(s=>e.jsxs(Y,{variant:"outline",className:"border-orange-300 text-orange-700 text-xs",children:[s.name,s.flex_main_folder_id&&e.jsx("span",{className:"ml-1 text-xs text-green-600",children:"(Has Folder ID)"})]},s.id))}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx(P,{onClick:w,disabled:c||N,variant:"outline",className:"flex-1 touch-manipulation",children:c?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-4 w-4 mr-2 animate-spin"}),e.jsx("span",{className:"hidden sm:inline",children:"Verifying..."}),e.jsx("span",{className:"sm:hidden",children:"Verifying..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(at,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Verify Status"}),e.jsx("span",{className:"sm:hidden",children:"Verify"})]})}),e.jsx(P,{onClick:u,disabled:N||c,className:"flex-1 touch-manipulation",children:N?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-4 w-4 mr-2 animate-spin"}),e.jsx("span",{className:"hidden sm:inline",children:"Creating Root Folders..."}),e.jsx("span",{className:"sm:hidden",children:"Creating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Create Root Folders"}),e.jsx("span",{className:"sm:hidden",children:"Create"})]})})]})]})})]})},_t=()=>{const h=je();l.useEffect(()=>{const t=b.channel("tours-changes").on("postgres_changes",{event:"*",schema:"public",table:"tours"},n=>{h.invalidateQueries({queryKey:["tours"]})}).subscribe();return()=>{b.removeChannel(t)}},[h])},St=({onTourClick:h})=>{const[t,n]=l.useState(null),[T,o]=l.useState(!1),[N,i]=l.useState(!1),[c,m]=l.useState(!1),[g,j]=l.useState(!0),[v,p]=l.useState(!1),w=Pe();_t();const{data:u=[],refetch:s}=nt({queryKey:["tours"],queryFn:async()=>{const{data:a,error:d}=await b.from("tours").select(`
          id,
          name,
          description,
          start_date,
          end_date,
          color,
          status,
          flex_folders_created,
          flex_main_folder_id,
          tour_dates (
            id,
            date,
            location:locations (name)
          )
        `).order("created_at",{ascending:!1}).eq("deleted",!1).eq("status","active");if(d)throw d;return a}}),r=a=>{n(a),o(!0)},D=async a=>{try{if(!a.tour_dates||a.tour_dates.length===0){ce({title:"Error",description:"No tour dates available to print",variant:"destructive"});return}await lt(a),ce({title:"Success",description:"Tour schedule exported successfully"})}catch(d){ce({title:"Error",description:"Failed to export PDF: "+(d.message||"Unknown error"),variant:"destructive"})}},y=l.useMemo(()=>{const a=new Date;return a.setHours(0,0,0,0),a},[]),_=l.useMemo(()=>{const a=new Map;return u.forEach(d=>{if(!(d!=null&&d.tour_dates))return;const Z=[...d.tour_dates].sort((te,se)=>new Date(te.date).getTime()-new Date(se.date).getTime());a.set(d.id,Z)}),a},[u]),H=a=>_.get(a)||[],U=l.useMemo(()=>u.filter(a=>{if(!a.end_date)return!0;const d=new Date(a.end_date);return d.setHours(0,0,0,0),d>=y}),[y,u]),k=l.useMemo(()=>u.filter(a=>{if(!a.end_date)return!1;const d=new Date(a.end_date);return d.setHours(0,0,0,0),d<y}),[y,u]),G=c?u:U,W=u.filter(a=>!a.flex_folders_created);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-3 md:justify-between md:items-center",children:[e.jsxs(P,{onClick:()=>i(!0),className:"flex items-center gap-2 w-full md:w-auto touch-manipulation",size:"default",children:[e.jsx(xt,{className:"h-4 w-4"}),"Create Tour"]}),!w&&k.length>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm text-muted-foreground hidden sm:inline",children:[k.length," completed"]}),e.jsx(P,{variant:"outline",size:"sm",onClick:()=>m(!c),className:"flex items-center gap-2",children:c?e.jsxs(e.Fragment,{children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Hide Completed"})]}):e.jsxs(e.Fragment,{children:[e.jsx($e,{className:"h-4 w-4"}),e.jsxs("span",{className:"hidden sm:inline",children:["Show Completed (",k.length,")"]})]})})]}),w&&k.length>0&&e.jsxs(Oe,{open:v,onOpenChange:p,children:[e.jsx(Le,{asChild:!0,children:e.jsxs(P,{variant:"outline",className:"flex items-center gap-2 w-full touch-manipulation",children:[e.jsx(xe,{className:"h-4 w-4"}),"View Options (",k.length," completed)"]})}),e.jsxs(Ue,{side:"bottom",className:"h-auto max-h-[40vh]",children:[e.jsx(qe,{children:e.jsx(Ae,{children:"Tour Options"})}),e.jsx("div",{className:"grid gap-3 pt-4",children:e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-accent rounded-md cursor-pointer transition-colors",onClick:()=>{m(!c),p(!1)},children:[e.jsx("div",{className:"flex items-center gap-3",children:c?e.jsxs(e.Fragment,{children:[e.jsx(Ee,{className:"h-5 w-5"}),e.jsx("span",{children:"Hide Completed Tours"})]}):e.jsxs(e.Fragment,{children:[e.jsx($e,{className:"h-5 w-5"}),e.jsx("span",{children:"Show Completed Tours"})]})}),e.jsx("span",{className:"text-sm text-muted-foreground",children:k.length})]})})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 md:gap-4",children:G.map(a=>e.jsx("div",{className:k.some(d=>d.id===a.id)?"opacity-75":"",children:e.jsx(yt,{tour:a,onManageDates:()=>r(a.id),onPrint:()=>D(a)})},a.id))}),t&&e.jsx(it,{open:T,onOpenChange:o,tourId:t,tourDates:H(t)}),e.jsx(Ct,{open:N,onOpenChange:i,currentDepartment:"sound"}),W.length>0&&e.jsx(bt,{tours:W,onRefresh:()=>s()})]})},Cs=()=>{const[h,t]=l.useState(!0),[n,T]=l.useState(null),{userRole:o}=rt(),N=o==="house_tech";l.useEffect(()=>{(async()=>{var g;const{data:{session:m}}=await b.auth.getSession();if((g=m==null?void 0:m.user)!=null&&g.id){T(m.user.id);const{data:j,error:v}=await b.from("profiles").select("tours_expanded").eq("id",m.user.id).single();if(v)return;j&&t(j.tours_expanded!==null&&j.tours_expanded!==void 0?j.tours_expanded:!0)}})()},[]);const i=async()=>{const c=!h;if(t(c),n){const{error:m}=await b.from("profiles").update({tours_expanded:c}).eq("id",n)}};return e.jsx("div",{className:"w-full space-y-4 px-1 sm:px-6",children:e.jsxs(we,{className:"w-full bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-950/30 dark:to-purple-950/30",children:[e.jsxs(ye,{className:"flex flex-row items-center justify-between px-4 py-3 md:px-6 md:py-4",children:[e.jsxs(Ne,{className:"flex items-center gap-2 text-base sm:text-lg md:text-xl",children:["Tours ",new Date().getFullYear()]}),e.jsx(P,{variant:"ghost",size:"sm",onClick:i,className:"h-8 w-8 p-0 shrink-0 touch-manipulation","aria-label":h?"Collapse tours":"Expand tours",children:h?e.jsx(Re,{className:"h-4 w-4"}):e.jsx(He,{className:"h-4 w-4"})})]}),h&&e.jsx(ve,{className:"px-3 pb-3 sm:px-4 sm:pb-4 md:px-6 md:pb-6",children:e.jsx(St,{onTourClick:N?void 0:c=>{}})})]})})};export{Cs as default};
