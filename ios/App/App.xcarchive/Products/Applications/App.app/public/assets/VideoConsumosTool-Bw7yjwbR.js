const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/logoUtils-D2o1jUVg.js","assets/index-NZ6jJLfQ.js","assets/vite-preload-helper-ckwbz45p.js","assets/commonjs-helpers-Cpj98o6Y.js","assets/index-DFO7exW2.css","assets/logo-url-cache-eY6nfvu7.js","assets/jobDocumentsUpload-BaycvzFe.js","assets/taskAutoCompletion-DInRlPJM.js","assets/taskCompletion-NTcmWFA_.js"])))=>i.map(i=>d[i]);
import{_ as J}from"./vite-preload-helper-ckwbz45p.js";import{c as We,e as Ae,b as Re,r as c,j as e,C as oe,A as ne,W as ke,B as P,Y as Le,L as j,S as R,t as k,v as L,w as V,x as w,I as C,V as Ve,s as z}from"./index-NZ6jJLfQ.js";import{e as qe}from"./pdfExport-DjZPdCcG.js";import{u as Ue}from"./useJobSelection-B9iLNF5-.js";import{C as ie}from"./checkbox-BsRNEGV1.js";import{u as Me,T as Oe}from"./TourOverrideModeHeader-C5X_h6fg.js";import{B as Q}from"./badge-vNTKF5RD.js";import{u as Je}from"./useTourDefaultSets-CKjECdAO.js";import{A as Ge}from"./arrow-left-VpQwT4cv.js";import{F as He}from"./file-text-igU140SQ.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./lazyPdf-xVUlxKNu.js";import"./useQuery-kdg2pmgf.js";import"./settings-egXcSQW9.js";import"./calendar-_Cj_Sgy-.js";import"./useMutation-DluhVBs1.js";const Y=[{id:1,name:"Pantalla Central",watts:700},{id:2,name:"IMAGE Left",watts:700},{id:3,name:"IMAGE Right",watts:700},{id:4,name:"LED Screen",watts:700}],$e=Math.sqrt(3),T=["CEE16A 3P+N+G","CEE32A 3P+N+G","CEE63A 3P+N+G","CEE125A 3P+N+G","Powerlock 400A 3P+N+G"],_=["Schuko 16A","CEE32A 1P+N+G","CEE63A 1P+N+G"],lt=()=>{const de=We(),{toast:m}=Ae(),{data:y}=Ue(),[q]=Re(),S=q.get("jobId"),h=q.get("tourId"),ce=q.get("tourDateId"),x=q.get("mode")==="tour-defaults",{isOverrideMode:l,overrideData:u,isLoading:le,saveOverride:ue}=Me(h||void 0,ce||void 0,"video"),{defaultSets:me,createSet:pe,createTable:he}=Je(h||""),[g,K]=c.useState(""),[xe,G]=c.useState(null),[H,X]=c.useState(""),[E,D]=c.useState([]),[Z,fe]=c.useState(!0),[v,je]=c.useState(20),[p,ye]=c.useState("three"),[F,ge]=c.useState(.9),[I,ee]=c.useState(400),[te,ve]=c.useState(""),[$,U]=c.useState({name:"",rows:[{quantity:"",componentId:"",watts:""}]});c.useEffect(()=>{ee(p==="single"?230:400)},[p]),c.useEffect(()=>{(async()=>{if(S)try{K(S);const s=(y||[]).find(n=>n.id===S)||null;if(s){G(s);return}const{data:a}=await z.from("jobs").select("id, title, start_time").eq("id",S).single();a&&G(a)}catch{}})()},[S,y]);const Ne=async()=>{const t=me.find(a=>a.department==="video");return t?t.id:(await pe({tour_id:h,name:`${te} Video Defaults`,department:"video",description:"Video department power defaults"})).id},we=async t=>{if(h)try{const s=await Ne();await he({set_id:s,table_name:t.name,table_data:{rows:t.rows,safetyMargin:v,pf:F,phaseMode:p,voltage:I},table_type:"power",total_value:t.totalWatts||0,metadata:{current_per_phase:t.currentPerPhase,pdu_type:t.customPduType||t.pduType,custom_pdu_type:t.customPduType,safetyMargin:v,pf:F,phaseMode:p,voltage:I}}),m({title:"Success",description:"Tour default saved successfully"})}catch{m({title:"Error",description:"Failed to save tour default",variant:"destructive"})}},Te=()=>{U(t=>({...t,rows:[...t.rows,{quantity:"",componentId:"",watts:""}]}))},Pe=t=>{U(s=>{const a=s.rows.filter((n,o)=>o!==t);return{...s,rows:a.length>0?a:[{quantity:"",componentId:"",watts:""}]}})},se=(t,s,a)=>{const n=[...$.rows];if(s==="componentId"&&a){const o=Y.find(i=>i.id.toString()===a);n[t]={...n[t],[s]:a,watts:o?o.watts.toString():""}}else n[t]={...n[t],[s]:a};U(o=>({...o,rows:n}))},Se=t=>{if(!t)return;K(t);const s=(y==null?void 0:y.find(a=>a.id===t))||null;G(s)},be=t=>{const s=t*(1+v/100),a=p==="single"?s/(I*F):s/($e*I*F);return{adjustedWatts:s,currentLine:a}},b=t=>t*.8,Ce=t=>p==="single"?t<=b(16)?_[0]:t<=b(32)?_[1]:_[2]:t<=b(16)?T[0]:t<=b(32)?T[1]:t<=b(63)?T[2]:t<=b(125)?T[3]:T[4],_e=async t=>{if(l&&u){await ue("power",{table_name:t.name,total_watts:t.totalWatts||0,current_per_phase:t.currentPerPhase||0,pdu_type:t.customPduType||t.pduType||"",custom_pdu_type:t.customPduType,includes_hoist:t.includesHoist||!1,override_data:{rows:t.rows,safetyMargin:v}})&&m({title:"Success",description:"Override saved for tour date"});return}try{const{error:s}=await z.from("power_requirement_tables").insert({job_id:g,department:"video",table_name:t.name,total_watts:t.totalWatts||0,current_per_phase:t.currentPerPhase||0,pdu_type:t.customPduType||t.pduType||"",custom_pdu_type:t.customPduType,includes_hoist:t.includesHoist||!1});if(s)throw s;m({title:"Success",description:"Power requirement table saved successfully"})}catch{m({title:"Error",description:"Failed to save power requirement table",variant:"destructive"})}},Ee=async()=>{if(!H){m({title:"Missing table name",description:"Please enter a name for the table",variant:"destructive"});return}const t=$.rows.map(r=>{const N=Y.find(O=>O.id.toString()===r.componentId),W=parseFloat(r.quantity||"0")&&parseFloat(r.watts||"0")?parseFloat(r.quantity)*parseFloat(r.watts):0;return{...r,componentName:(N==null?void 0:N.name)||"",totalWatts:W}}),s=t.reduce((r,N)=>r+(N.totalWatts||0),0),{adjustedWatts:a,currentLine:n}=be(s),o=Ce(n),i={name:H,rows:t,totalWatts:s,adjustedWatts:a,currentPerPhase:n,pduType:o,customPduType:void 0,includesHoist:!1,id:Date.now()};D(r=>[...r,i]),x?await we(i):g&&await _e(i),ae()},ae=()=>{U({name:"",rows:[{quantity:"",componentId:"",watts:""}]}),X("")},De=t=>{typeof t=="number"&&D(s=>s.filter(a=>a.id!==t))},Fe=async()=>{const t=l&&u?{id:"override",title:`${u.tourName} - ${u.locationName}`}:xe;if(!t){m({title:l?"No tour data":"No job selected",description:l?"Tour data not loaded":"Please select a job before exporting.",variant:"destructive"});return}try{const s=l?[...M,...E]:E,a=s.reduce((d,f)=>d+(f.totalWatts||0),0),n=s.reduce((d,f)=>d+(f.currentPerPhase||0),0),o={totalSystemWatts:a,totalSystemAmps:n};let i;try{if(l&&h){const{fetchTourLogo:d}=await J(async()=>{const{fetchTourLogo:f}=await import("./logoUtils-D2o1jUVg.js");return{fetchTourLogo:f}},__vite__mapDeps([0,1,2,3,4,5]));i=await d(h)}else if(g){const{fetchJobLogo:d}=await J(async()=>{const{fetchJobLogo:f}=await import("./logoUtils-D2o1jUVg.js");return{fetchJobLogo:f}},__vite__mapDeps([0,1,2,3,4,5]));i=await d(g)}}catch{}const r=await qe(t.title,s.map(d=>({...d,toolType:"consumos"})),"power",t.title,(t==null?void 0:t.start_time)||new Date().toISOString(),void 0,o,v,i,Z),N=`Video Power Report - ${t.title}.pdf`;let W=0;if(!x&&g){try{const{uploadJobPdfWithCleanup:d}=await J(async()=>{const{uploadJobPdfWithCleanup:B}=await import("./jobDocumentsUpload-BaycvzFe.js");return{uploadJobPdfWithCleanup:B}},__vite__mapDeps([6,1,2,3,4]));await d(g,r,N,"calculators/consumos");const{autoCompleteConsumosTasks:f}=await J(async()=>{const{autoCompleteConsumosTasks:B}=await import("./taskAutoCompletion-DInRlPJM.js");return{autoCompleteConsumosTasks:B}},__vite__mapDeps([7,8,1,2,3,4])),re=await f(g,"video");W=re.completedCount,re.completedCount>0}catch(d){if(d instanceof Error&&d.message.includes("uploadJobPdfWithCleanup"))throw d}m({title:"Success",description:W>0?`PDF uploaded successfully. ${W} Consumos task(s) auto-completed.`:"PDF has been generated and uploaded successfully."})}else m({title:"Success",description:"PDF has been generated successfully."});const O=window.URL.createObjectURL(r),A=document.createElement("a");A.href=O,A.download=N,document.body.appendChild(A),A.click(),window.URL.revokeObjectURL(O),document.body.removeChild(A)}catch{m({title:"Error",description:"Failed to generate or upload the PDF.",variant:"destructive"})}},[M,Ie]=c.useState([]);return c.useEffect(()=>{if(l&&u){const t=u.defaults.filter(s=>s.table_type==="power").map(s=>{var a,n;return{name:`${s.table_name} (Default)`,rows:s.table_data.rows||[],totalWatts:s.total_value,currentPerPhase:(a=s.metadata)==null?void 0:a.currentPerPhase,pduType:(n=s.metadata)==null?void 0:n.pduType,id:`default-${s.id}`,isDefault:!0}});Ie(t)}},[l,u]),c.useEffect(()=>{(async()=>{if(h){const{data:s}=await z.from("tours").select("name").eq("id",h).single();s&&ve(s.name)}})()},[h]),le?e.jsx(oe,{className:"w-full max-w-4xl mx-auto my-6",children:e.jsx(ne,{className:"pt-6",children:e.jsx("p",{children:"Loading tour override data..."})})}):e.jsxs(oe,{className:"w-full max-w-4xl mx-auto my-6",children:[e.jsxs(ke,{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(P,{variant:"ghost",size:"icon",onClick:()=>de("/video"),children:e.jsx(Ge,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Le,{className:"text-2xl font-bold",children:[l?"Override Mode - ":"","Power Calculator"]}),x&&e.jsx(Q,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200",children:"Tour Defaults"})]})]}),x&&e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Creating power defaults for tour: ",e.jsx("span",{className:"font-medium",children:te})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"These defaults will apply to all tour dates unless specifically overridden"})]})]}),e.jsx(ne,{children:e.jsxs("div",{className:"space-y-6",children:[x&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-2 w-2 bg-green-500 rounded-full"}),e.jsx("p",{className:"text-sm font-medium text-green-900",children:"Tour Defaults Mode Active"})]}),e.jsx("p",{className:"text-sm text-green-700 mt-1",children:"Any tables you create will be saved as global defaults for this tour. These defaults will apply to all tour dates unless specifically overridden."})]}),l&&u&&e.jsx(Oe,{tourName:u.tourName,tourDate:u.tourDate,locationName:u.locationName,defaultsCount:M.length,overridesCount:E.length,department:"video"}),l&&M.length>0&&e.jsxs("div",{className:"border rounded-lg p-4 bg-green-50",children:[e.jsx("h3",{className:"font-semibold mb-3 text-green-800",children:"Tour Defaults (Read-Only)"}),M.map(t=>{var s,a;return e.jsxs("div",{className:"border rounded-lg overflow-x-auto mt-4 bg-white",children:[e.jsx("div",{className:"bg-green-100 px-4 py-3 flex justify-between items-center",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold",children:t.name}),e.jsx(Q,{variant:"outline",className:"bg-green-50 text-green-700",children:"Default"})]})}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Watts:"})," ",(s=t.totalWatts)==null?void 0:s.toFixed(2)," W"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Current per Phase:"})," ",(a=t.currentPerPhase)==null?void 0:a.toFixed(2)," A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"PDU Type:"})," ",t.pduType]})]})})]},t.id)})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Supply"}),e.jsxs(R,{value:p,onValueChange:t=>ye(t),children:[e.jsx(k,{children:e.jsx(L,{placeholder:"Select supply"})}),e.jsxs(V,{children:[e.jsx(w,{value:"single",children:"Monofásico (230 V)"}),e.jsx(w,{value:"three",children:"Trifásico (400 V LL)"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Voltage"}),e.jsx(C,{type:"number",value:I,onChange:t=>ee(Number(t.target.value)||0)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"230 V (1φ) o 400 V LL (3φ) por defecto"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Power Factor (PF)"}),e.jsx(C,{type:"number",step:"0.01",min:"0.1",max:"1",value:F,onChange:t=>ge(Math.max(.1,Math.min(1,Number(t.target.value)||.85)))}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Usa 0.9 como referencia"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"safetyMargin",children:"Safety Margin"}),e.jsxs(R,{value:v.toString(),onValueChange:t=>je(Number(t)),children:[e.jsx(k,{children:e.jsx(L,{placeholder:"Select Safety Margin"})}),e.jsx(V,{children:[0,10,20,30,40,50].map(t=>e.jsxs(w,{value:t.toString(),children:[t,"%"]},t))})]})]}),!S&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"jobSelect",children:"Select Job"}),e.jsxs(R,{value:g,onValueChange:Se,children:[e.jsx(k,{children:e.jsx(L,{placeholder:"Select a job"})}),e.jsx(V,{children:y==null?void 0:y.map(t=>e.jsx(w,{value:t.id,children:t.title},t.id))})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ie,{id:"foh-schuko",checked:Z,onCheckedChange:t=>fe(!!t)}),e.jsx(j,{htmlFor:"foh-schuko",children:"Se requiere potencia de 16A en formato schuko hembra en posicion FoH"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"tableName",children:x?"Default Name":"Table Name"}),e.jsx(C,{id:"tableName",value:H,onChange:t=>X(t.target.value),placeholder:x?"Enter default name":"Enter table name"})]}),e.jsx("div",{className:"border rounded-lg overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Quantity"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Component"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Watts (per unit)"}),e.jsx("th",{className:"w-12 px-4 py-3 text-left font-medium",children:" "})]})}),e.jsx("tbody",{children:$.rows.map((t,s)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-4",children:e.jsx(C,{type:"number",value:t.quantity,onChange:a=>se(s,"quantity",a.target.value),min:"0",className:"w-full"})}),e.jsx("td",{className:"p-4",children:e.jsxs(R,{value:t.componentId,onValueChange:a=>a&&se(s,"componentId",a),children:[e.jsx(k,{className:"w-full",children:e.jsx(L,{placeholder:"Select component"})}),e.jsx(V,{children:Y.map(a=>e.jsx(w,{value:a.id.toString(),children:a.name},a.id))})]})}),e.jsx("td",{className:"p-4",children:e.jsx(C,{type:"number",value:t.watts,readOnly:!0,className:"w-full bg-muted"})}),e.jsx("td",{className:"p-4",children:e.jsx(P,{type:"button",variant:"ghost",size:"icon",onClick:()=>Pe(s),className:"text-destructive hover:text-destructive","aria-label":"Delete row",children:e.jsx(Ve,{className:"h-4 w-4"})})})]},s))})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(P,{onClick:Te,children:"Add Row"}),e.jsx(P,{onClick:Ee,variant:"secondary",children:x?"Save Tour Default":"Generate Table"}),e.jsx(P,{onClick:ae,variant:"destructive",children:"Reset"}),E.length>0&&!x&&e.jsxs(P,{onClick:Fe,variant:"outline",className:"ml-auto gap-2",children:[e.jsx(He,{className:"h-4 w-4"}),"Export & Upload PDF"]})]}),E.map(t=>{var s,a,n;return e.jsxs("div",{className:"border rounded-lg overflow-x-auto mt-6",children:[e.jsxs("div",{className:"bg-muted px-4 py-3 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold",children:t.name}),l&&e.jsx(Q,{variant:"outline",className:"bg-orange-50 text-orange-700",children:"Override"})]}),typeof t.id=="number"&&e.jsx(P,{variant:"destructive",size:"sm",onClick:()=>De(t.id),children:"Remove Table"})]}),e.jsx("div",{className:"p-4 bg-muted/50 space-y-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{id:`hoist-${t.id}`,checked:t.includesHoist,onCheckedChange:o=>{D(i=>i.map(r=>r.id===t.id?{...r,includesHoist:!!o}:r))}}),e.jsx(j,{htmlFor:`hoist-${t.id}`,children:"Requires additional hoist power (CEE32A 3P+N+G)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{children:"PDU Type Override:"}),e.jsxs(R,{value:t.customPduType?(p==="single"?_:T).includes(t.customPduType)?t.customPduType:"custom":"default",onValueChange:o=>{D(i=>i.map(r=>r.id!==t.id?r:o==="default"?{...r,customPduType:void 0}:o==="custom"?{...r,customPduType:""}:{...r,customPduType:o}))},children:[e.jsx(k,{className:"w-[220px]",children:e.jsx(L,{placeholder:"Use recommended PDU type"})}),e.jsxs(V,{children:[e.jsxs(w,{value:"default",children:["Use recommended (",t.pduType,")"]}),(p==="single"?_:T).map(o=>e.jsx(w,{value:o,children:o},o)),e.jsx(w,{value:"custom",children:"Custom PDU Type"})]})]}),t.customPduType!==void 0&&!(p==="single"?_:T).includes(t.customPduType||"")&&e.jsx(C,{placeholder:"Enter custom PDU type",value:t.customPduType||"",onChange:o=>D(i=>i.map(r=>r.id===t.id?{...r,customPduType:o.target.value}:r)),className:"w-[220px]"})]})]})}),e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-muted/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Quantity"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Component"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Watts (per unit)"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Total Watts"})]})}),e.jsxs("tbody",{children:[t.rows.map((o,i)=>{var r;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:o.quantity}),e.jsx("td",{className:"px-4 py-3",children:o.componentName}),e.jsx("td",{className:"px-4 py-3",children:o.watts}),e.jsx("td",{className:"px-4 py-3",children:(r=o.totalWatts)==null?void 0:r.toFixed(2)})]},i)}),e.jsxs("tr",{className:"border-t bg-muted/50 font-medium",children:[e.jsx("td",{colSpan:3,className:"px-4 py-3 text-right",children:"Total Watts:"}),e.jsxs("td",{className:"px-4 py-3",children:[(s=t.totalWatts)==null?void 0:s.toFixed(2)," W"]})]}),v>0&&e.jsxs("tr",{className:"border-t bg-muted/50 font-medium",children:[e.jsxs("td",{colSpan:3,className:"px-4 py-3 text-right",children:["Adjusted Watts (",v,"% safety margin):"]}),e.jsxs("td",{className:"px-4 py-3",children:[(a=t.adjustedWatts)==null?void 0:a.toFixed(2)," W"]})]}),e.jsxs("tr",{className:"border-t bg-muted/50 font-medium",children:[e.jsx("td",{colSpan:3,className:"px-4 py-3 text-right",children:"Current per Phase:"}),e.jsxs("td",{className:"px-4 py-3",children:[(n=t.currentPerPhase)==null?void 0:n.toFixed(2)," A"]})]}),e.jsxs("tr",{className:"border-t bg-muted/50 font-medium",children:[e.jsx("td",{colSpan:3,className:"px-4 py-3 text-right",children:"PDU Type:"}),e.jsx("td",{className:"px-4 py-3",children:t.customPduType||t.pduType})]}),t.includesHoist&&e.jsx("tr",{className:"border-t bg-muted/50 font-medium",children:e.jsx("td",{colSpan:4,className:"px-4 py-3",children:"Additional Hoist Power Required: CEE32A 3P+N+G"})})]})]})]},t.id)})]})})]})};export{lt as default};
