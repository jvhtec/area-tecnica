import{l as X,r as I,s as d,a4 as S,e as ee,j as e,S as D,t as U,v as O,w as q,x as T,B as N,I as se,V as R,D as te,q as ae,F as ne,G as ie}from"./index-NZ6jJLfQ.js";import{T as re,a as oe,b as z,c as F}from"./tabs-BdaywI_b.js";import{u as Y}from"./useQuery-kdg2pmgf.js";import{c as ce,r as le}from"./taskCompletion-NTcmWFA_.js";import{T as de,a as ue,b as L,c as k,d as he,e as v}from"./table-DnQAmABX.js";import{P as me}from"./progress-C8XsV-Me.js";import{P as ge}from"./plus-C3JQqq7t.js";import{D as fe}from"./download-C1rVE0-J.js";import{U as pe}from"./upload-DF4rjO7T.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=X("ListChecks",[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]]),Q={sound:"sound_job_tasks",lights:"lights_job_tasks",video:"video_job_tasks"};function xe(c,o,u){const g=o?Q[o]:Q.sound,j=u||c,p=Y({queryKey:["job-tasks",c,u,o],enabled:!!j,queryFn:async()=>{let x=d.from(g).select("*, assigned_to(id, first_name, last_name), task_documents(*)");u?x=x.eq("tour_id",u):c&&(x=x.eq("job_id",c));const{data:l,error:y}=await x.order("created_at",{ascending:!0});if(y)throw y;return l||[]}});return I.useEffect(()=>{if(!j)return;const x=u?"tour_id":"job_id",l=d.channel(`rtm-${g}-${j}`).on("postgres_changes",{event:"*",schema:"public",table:g,filter:`${x}=eq.${j}`},()=>{p.refetch()}).on("postgres_changes",{event:"*",schema:"public",table:"task_documents"},()=>{p.refetch()}).subscribe();return()=>{d.removeChannel(l)}},[j,o]),{tasks:p.data||[],loading:p.isLoading,error:p.error,refetch:p.refetch}}const H={sound:"sound_job_tasks",lights:"lights_job_tasks",video:"video_job_tasks"},G={sound:"sound_task_id",lights:"lights_task_id",video:"video_task_id"};function je(c,o,u){const g=o?H[o]:H.sound,j=o?G[o]:G.sound,p=["due_at","priority","requirements","notes","details"],x=(a,t)=>{if(t!==void 0){if(t===null)return null;if(a==="due_at"){const n=new Date(String(t));if(!Number.isNaN(n.getTime()))return n.toISOString()}return t}},l=(a,t)=>{if(t!==void 0){if(t===null)return null;if(a==="due_at"){const n=new Date(String(t));if(!Number.isNaN(n.getTime()))return n.toISOString()}if(Array.isArray(t))return t.map(n=>l("",n));if(typeof t=="object")try{return JSON.parse(JSON.stringify(t))}catch{return t}return t}},y=a=>{const t={};for(const[n,r]of Object.entries(a))p.includes(n)&&(t[n]=x(n,r));return t},b=async(a,t)=>{var _;if(!(a!=null&&a.assigned_to))return;const n={};for(const[s,f]of Object.entries(t)){const i=l(s,f),w=l(s,a[s]);JSON.stringify(i)!==JSON.stringify(w)&&(n[s]={from:w,to:i})}if(Object.keys(n).length===0)return;const{data:r}=await d.auth.getUser(),h=((_=r==null?void 0:r.user)==null?void 0:_.id)??null,m=new Set;h&&m.add(h),m.add(a.assigned_to);try{await d.functions.invoke("push",{body:{action:"broadcast",type:"task.updated",job_id:a.job_id||void 0,tour_id:a.tour_id||void 0,recipient_id:a.assigned_to,user_ids:Array.from(m),task_id:a.id,task_type:a.task_type,changes:n}})}catch{}},A=async(a,t)=>{const n={};for(const[_,s]of Object.entries(t)){const f=x(_,s);f!==void 0&&(n[_]=f)}if(Object.keys(n).length===0)return;const r=y(n);let h=null;if(Object.keys(r).length>0){const{data:_,error:s}=await d.from(g).select("*").eq("id",a).maybeSingle();s||(h=_)}const{error:m}=await d.from(g).update(n).eq("id",a);if(m)throw m;h&&await b(h,r)};return{createTask:async(a,t,n)=>{const r={task_type:a,status:"not_started",progress:0};u?r.tour_id=u:c&&(r.job_id=c),t&&(r.assigned_to=t),n&&(r.due_at=n);const{data:h,error:m}=await d.from(g).insert(r).select().single();if(m)throw m;return h},updateTask:async(a,t)=>{await A(a,t)},deleteTask:async a=>{const{error:t}=await d.from(g).delete().eq("id",a);if(t)throw t},assignUser:async(a,t)=>{var _;const{data:n}=await d.auth.getUser(),r=((_=n==null?void 0:n.user)==null?void 0:_.id)??null,{data:h,error:m}=await d.from(g).update({assigned_to:t}).eq("id",a).select("id, task_type").maybeSingle();if(m)throw m;if(r&&t)try{await d.functions.invoke("push",{body:{action:"broadcast",type:"task.assigned",job_id:c||void 0,tour_id:u||void 0,recipient_id:t,user_ids:[r,t],task_id:a,task_type:h==null?void 0:h.task_type}})}catch{}},setStatus:async(a,t)=>{if(!o)throw new Error("Department is required for setStatus");if(t==="completed"){const n=await ce({taskId:a,department:o,source:"manual",jobId:c,tourId:u});if(!n.success)throw new Error(n.error||"Failed to complete task")}else{const n=await le({taskId:a,department:o,newStatus:t});if(!n.success)throw new Error(n.error||"Failed to revert task")}},setDueDate:async(a,t)=>{await A(a,{due_at:t})},uploadAttachment:async(a,t)=>{const n=t.name.replace(/[^a-zA-Z0-9.-]/g,"_"),r=`${a}/${Date.now()}_${n}`,{error:h}=await d.storage.from("task_documents").upload(r,t,{upsert:!1});if(h)throw h;const{error:m}=await d.from("task_documents").insert({[j]:a,file_name:t.name,file_path:r});if(m)throw m},deleteAttachment:async(a,t)=>{const{error:n}=await d.storage.from("task_documents").remove([t]);if(n)throw n;const{error:r}=await d.from("task_documents").delete().eq("id",a);if(r)throw r}}}const W={sound:["QT","Rigging Plot","Prediccion","Pesos","Consumos","PS"],lights:["QT","Rigging Plot","Pesos","Consumos","PS"],video:["QT","Prediccion","Pesos","Consumos","PS"]},V=({jobId:c,tourId:o,department:u,canEdit:g,canAssign:j})=>{const{tasks:p,loading:x,refetch:l}=xe(c,u,o),{createTask:y,assignUser:b,setStatus:A,setDueDate:$,deleteTask:K,uploadAttachment:M,deleteAttachment:B}=je(c,u,o),[C,J]=S.useState(W[u][0]),[E,P]=S.useState(void 0),{toast:a}=ee(),[t,n]=S.useState(null);S.useEffect(()=>{(async()=>{var f;const{data:s}=await d.auth.getUser();n(((f=s.user)==null?void 0:f.id)||null)})()},[]);const{data:r}=_e(),h=async()=>{if(C)try{await y(C,E||null,null),P(void 0),await l()}catch(s){a({title:"Create failed",description:(s==null?void 0:s.message)||String(s),variant:"destructive"})}},m=async(s,f)=>{if(f)try{await M(s,f),a({title:"Uploaded",description:"Attachment uploaded"}),await l()}catch(i){a({title:"Upload failed",description:(i==null?void 0:i.message)||String(i),variant:"destructive"})}},_=async(s,f)=>{try{await B(s,f),a({title:"Attachment deleted"}),await l()}catch(i){a({title:"Delete failed",description:(i==null?void 0:i.message)||String(i),variant:"destructive"})}};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(D,{value:C,onValueChange:J,children:[e.jsx(U,{className:"w-[160px]",children:e.jsx(O,{placeholder:"Task type"})}),e.jsx(q,{children:W[u].map(s=>e.jsx(T,{value:s,children:s},s))})]}),j&&e.jsxs(D,{value:E,onValueChange:P,children:[e.jsx(U,{className:"w-[180px]",children:e.jsx(O,{placeholder:"Assign to"})}),e.jsx(q,{children:r==null?void 0:r.map(s=>e.jsxs(T,{value:s.id,children:[s.first_name," ",s.last_name]},s.id))})]}),e.jsxs(N,{size:"sm",variant:"outline",onClick:h,disabled:!g&&!j,children:[e.jsx(ge,{className:"h-4 w-4 mr-1"})," Add Task"]})]}),e.jsx("div",{className:"border rounded",children:e.jsxs(de,{children:[e.jsx(ue,{children:e.jsxs(L,{children:[e.jsx(k,{children:"Type"}),e.jsx(k,{children:"Assignee"}),e.jsx(k,{children:"Status"}),e.jsx(k,{children:"Progress"}),e.jsx(k,{children:"Due"}),e.jsx(k,{children:"Attachments"}),e.jsx(k,{})]})}),e.jsxs(he,{children:[(p||[]).map(s=>{var f;return e.jsxs(L,{children:[e.jsx(v,{className:"font-medium",children:s.task_type}),e.jsx(v,{children:j?e.jsxs(D,{value:((f=s.assigned_to)==null?void 0:f.id)||s.assigned_to||"unassigned",onValueChange:i=>b(s.id,i==="unassigned"?null:i).then(()=>l()),children:[e.jsx(U,{className:"w-[180px]",children:e.jsx(O,{placeholder:"Assign"})}),e.jsxs(q,{children:[e.jsx(T,{value:"unassigned",children:"Unassigned"}),r==null?void 0:r.map(i=>e.jsxs(T,{value:i.id,children:[i.first_name," ",i.last_name]},i.id))]})]}):e.jsx("span",{children:s.assigned_to?`${s.assigned_to.first_name} ${s.assigned_to.last_name}`:"-"})}),e.jsx(v,{children:(()=>{var w;const i=g||!!t&&(((w=s.assigned_to)==null?void 0:w.id)===t||s.assigned_to===t);return e.jsxs(D,{value:s.status,onValueChange:Z=>A(s.id,Z).then(()=>l()),children:[e.jsx(U,{className:"w-[140px]",disabled:!i,children:e.jsx(O,{})}),e.jsxs(q,{children:[e.jsx(T,{value:"not_started",children:"Not Started"}),e.jsx(T,{value:"in_progress",children:"In Progress"}),e.jsx(T,{value:"completed",children:"Completed"})]})]})})()}),e.jsx(v,{className:"w-[160px]",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{value:s.progress||0,className:"h-2"}),e.jsxs("span",{className:"text-xs w-8",children:[s.progress||0,"%"]})]})}),e.jsx(v,{children:(()=>{const i=g;return e.jsx(se,{type:"date",value:s.due_at?new Date(s.due_at).toISOString().slice(0,10):"",onChange:w=>$(s.id,w.target.value?new Date(w.target.value).toISOString():null).then(()=>l()),className:"w-[160px]",disabled:!i})})()}),e.jsx(v,{className:"min-w-[220px]",children:e.jsx("div",{className:"max-h-24 overflow-auto space-y-1",children:(s.task_documents||[]).map(i=>e.jsxs("div",{className:"flex items-center justify-between text-xs p-1 rounded hover:bg-accent/40",children:[e.jsx("span",{className:"truncate max-w-[140px]",title:i.file_name,children:i.file_name}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(N,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>we(i),children:e.jsx(fe,{className:"h-3 w-3"})}),e.jsx(N,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>_(i.id,i.file_path),children:e.jsx(R,{className:"h-3 w-3"})})]})]},i.id))})}),e.jsxs(v,{className:"space-x-2",children:[e.jsxs("div",{className:"relative inline-block",children:[e.jsx("input",{type:"file",className:"absolute inset-0 opacity-0 cursor-pointer",onChange:i=>{var w;return m(s.id,(w=i.target.files)==null?void 0:w[0])}}),e.jsxs(N,{size:"sm",variant:"outline",children:[e.jsx(pe,{className:"h-3 w-3 mr-1"}),"Upload"]})]}),g&&e.jsx(N,{size:"sm",variant:"ghost",onClick:()=>K(s.id).then(()=>l()),children:e.jsx(R,{className:"h-4 w-4"})})]})]},s.id)}),!x&&(!p||p.length===0)&&e.jsx(L,{children:e.jsx(v,{colSpan:7,className:"text-center text-sm text-muted-foreground",children:"No tasks yet"})})]})]})})]})};function _e(){return Y({queryKey:["management-users"],queryFn:async()=>{const{data:c,error:o}=await d.from("profiles").select("id, first_name, last_name").in("role",["management","admin","logistics"]);if(o)throw o;return c||[]}})}async function we(c){const{data:o}=await d.storage.from("task_documents").createSignedUrl(c.file_path,3600);o!=null&&o.signedUrl&&window.open(o.signedUrl,"_blank","noopener")}const ye=c=>["admin","management","logistics"].includes((c||"").toString()),ve=c=>["admin","management","logistics"].includes((c||"").toString()),qe=({jobId:c,tourId:o,userRole:u,open:g,onOpenChange:j})=>{const[p,x]=S.useState("sound"),l=ye(u),y=ve(u);return e.jsx(te,{open:g,onOpenChange:j,children:e.jsxs(ae,{className:"max-w-6xl w-[96vw] max-h-[90vh] overflow-hidden",children:[e.jsx(ne,{children:e.jsx(ie,{children:"Task Manager"})}),e.jsx("div",{className:"mt-2 overflow-y-auto",children:e.jsxs(re,{value:p,onValueChange:b=>x(b),className:"w-full",children:[e.jsxs(oe,{className:"grid w-full grid-cols-3",children:[e.jsx(z,{value:"sound",children:"Sound"}),e.jsx(z,{value:"lights",children:"Lights"}),e.jsx(z,{value:"video",children:"Video"})]}),e.jsx(F,{value:"sound",className:"pt-4",children:e.jsx(V,{jobId:c,tourId:o,department:"sound",canEdit:l,canAssign:y,canUpdateOwn:!0})}),e.jsx(F,{value:"lights",className:"pt-4",children:e.jsx(V,{jobId:c,tourId:o,department:"lights",canEdit:l,canAssign:y,canUpdateOwn:!0})}),e.jsx(F,{value:"video",className:"pt-4",children:e.jsx(V,{jobId:c,tourId:o,department:"video",canEdit:l,canAssign:y,canUpdateOwn:!0})})]})})]})})};export{Oe as L,qe as T};
