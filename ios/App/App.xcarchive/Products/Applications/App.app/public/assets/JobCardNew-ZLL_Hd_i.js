import{l as Yt,m as As,i as ce,j as e,C as es,Q as W,B as F,r as U,e as et,D as Le,q as $e,F as dt,G as mt,L as Et,I as Tt,S as qs,t as Ms,v as Os,w as Us,x as Ls,s as N,a4 as E,aK as yt,a as we,aL as vt,c as ts,d as ss,R as Vt,V as as,ac as $s,o as ns,J as zs,K as Ps,O as Hs,f as rs,P as gt,a2 as Js,M as Ks,a9 as Bs,bA as Vs,u as Qs}from"./index-NZ6jJLfQ.js";import{S as Ws,L as Gs,V as Rs,u as is,a as Zs,b as Xs}from"./VideoTaskDialog-jFo9WRqF.js";import{d as Ys}from"./optimisticJobDeletionService-Bq-53fU4.js";import{J as ea,c as ta}from"./folders-Scoqgw4s.js";import{c as sa,s as At}from"./folderNameSanitizer-DNdk00QU.js";import{J as ls}from"./JobDetailsDialog-Cah6wZTf.js";import{B as oe}from"./badge-vNTKF5RD.js";import{M as aa}from"./ModernHojaDeRuta-DrMmS05m.js";import{A as na,R as ra,S as ia,F as la,a as oa}from"./FlexFolderPicker-DHVHrWa7.js";import{E as ca,J as da}from"./EditJobDialog-DRKRzgWP.js";import{L as ma}from"./LogisticsEventDialog-WK7mGk6y.js";import{R as ua}from"./transportOptions-CtHnG2xX.js";import{L as pa,T as fa}from"./TaskManagerDialog-WHCTXr5s.js";import{c as Qt}from"./icon-D8sTZPYx.js";import{T as ha}from"./TechnicianIncidentReportDialog-Bb0qWmts.js";import{u as _e}from"./useQuery-kdg2pmgf.js";import{u as xa}from"./useFlexUuid-C0fmwl_8.js";import{C as ga,e as ya,a as va,b as _a,c as wa,d as Na}from"./command-D3uMBT-Z.js";import{F as ja}from"./file-text-igU140SQ.js";import{F as Wt}from"./constants-DoXhG9KB.js";import{o as qt}from"./flexUuidService-C9yZjzP-.js";import{M as Gt}from"./message-circle-Bh9rUoQO.js";import{I as ba}from"./info-CpCfiYD2.js";import{U as Ut}from"./users-DMnpVLUq.js";import{S as Ca}from"./settings-egXcSQW9.js";import{C as os}from"./clock-BXPvTWvY.js";import{Z as ka}from"./zap-QKspq41J.js";import{S as Sa}from"./square-pen-BMpSgZGa.js";import{E as Fa}from"./external-link-QJoXZ6ES.js";import{F as Ia}from"./folder-plus-DTUhlRcm.js";import{U as Da}from"./upload-DF4rjO7T.js";import{f as Ea}from"./userName-BCcvOtN-.js";import{S as Ta}from"./switch-DUBpZhIC.js";import{r as Rt}from"./useWeatherData-d0TEdKFc.js";import{E as cs}from"./eye-BE_DouVP.js";import{D as ds}from"./download-C1rVE0-J.js";import{D as Aa,a as qa,b as Ma,c as Oa}from"./dropdown-menu-Dn1SMjj1.js";import{M as Ua}from"./mic-l4q2dREA.js";import{M as La}from"./moon-Bp9lP4EQ.js";import{S as $a}from"./star-icpn3ybK.js";import{W as za}from"./wrench-DzMvZxmF.js";import{P as Pa}from"./plane-NSG-_bNT.js";import{P as Ha}from"./progress-C8XsV-Me.js";import{C as Zt}from"./chevron-right-Bn7Eu0F7.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ja=Yt("FolderTree",[["path",{d:"M20 10a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1h-2.5a1 1 0 0 1-.8-.4l-.9-1.2A1 1 0 0 0 15 3h-2a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1Z",key:"hod4my"}],["path",{d:"M20 21a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1h-2.9a1 1 0 0 1-.88-.55l-.42-.85a1 1 0 0 0-.92-.6H13a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1Z",key:"w4yl2u"}],["path",{d:"M3 5a2 2 0 0 0 2 2h3",key:"f2jnh7"}],["path",{d:"M3 3v13a2 2 0 0 0 2 2h3",key:"k8epm1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ka=Yt("ScrollText",[["path",{d:"M15 12h-5",key:"r7krc0"}],["path",{d:"M15 8h-5",key:"1khuty"}],["path",{d:"M19 17V5a2 2 0 0 0-2-2H4",key:"zz82l3"}],["path",{d:"M8 21h12a2 2 0 0 0 2-2v-1a1 1 0 0 0-1-1H11a1 1 0 0 0-1 1v1a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v2a1 1 0 0 0 1 1h3",key:"1ph1d7"}]]);let Mt=null;async function Ba(){if(Mt)return Mt;const{data:t,error:s}=await As.functions.invoke("get-secret",{body:{secretName:"X_AUTH_TOKEN"}});if(s)throw new Error(s.message||"Failed to resolve Flex auth token");const r=t==null?void 0:t.X_AUTH_TOKEN;if(!r)throw new Error("Flex auth token response missing X_AUTH_TOKEN");return Mt=r,r}async function ms(t){try{const s=await Ba(),r=await fetch(`https://sectorpro.flexrentalsolutions.com/f5/api/element/${t}/tree`,{method:"GET",headers:{"Content-Type":"application/json","X-Auth-Token":s,apikey:s}});if(!r.ok){const u=await r.json().catch(()=>({}));throw new Error(u.exceptionMessage||"Failed to fetch element tree from Flex")}const a=await r.json();return Va(a)}catch(s){throw s}}function Va(t){if(!t)return[];if(typeof t=="object"&&t!==null&&"elementId"in t)return[xt(t)];if(Array.isArray(t))return t.map(xt);if(typeof t=="object"&&t!==null&&("children"in t||"items"in t)){const s="children"in t?t.children:"items"in t?t.items:null;return Array.isArray(s)?s.map(xt):[]}return[]}function Lt(t,s=new Set){if(typeof t=="string"){const r=t.trim();return r.length>0?r:void 0}if(typeof t=="object"&&t!==null){if(s.has(t))return;s.add(t);const r=t;if(typeof r.data=="string"){const a=r.data.trim();if(a.length>0)return a}for(const a of["data","attributes","value"])if(a in r){const u=Lt(r[a],s);if(u)return u}for(const a of Object.values(r)){const u=Lt(a,s);if(u)return u}}}function $t(t,s,r=new Set){if(!r.has(t)){r.add(t);for(const a of s)if(a in t){const u=Lt(t[a]);if(u)return u}if(typeof t.data=="object"&&t.data!==null){const a=$t(t.data,s,r);if(a)return a}}}function xt(t){if(typeof t!="object"||t===null)return{elementId:"",displayName:"Unnamed"};const s=t,r=(typeof s.elementId=="string"?s.elementId:null)||(typeof s.nodeId=="string"?s.nodeId:null)||(typeof s.id=="string"?s.id:null)||"";!r||r.trim().length;const a={elementId:r,displayName:(typeof s.displayName=="string"?s.displayName:null)||(typeof s.name=="string"?s.name:null)||"Unnamed",documentNumber:(typeof s.documentNumber=="string"?s.documentNumber:null)||(typeof s.docNumber=="string"?s.docNumber:null)||void 0,parentElementId:(typeof s.parentElementId=="string"?s.parentElementId:null)||(typeof s.parentId=="string"?s.parentId:null)||void 0,domainId:(typeof s.domainId=="string"?s.domainId:null)||void 0,definitionId:(typeof s.definitionId=="string"?s.definitionId:null)||(typeof s.elementDefinitionId=="string"?s.elementDefinitionId:null)||void 0,schemaId:(typeof s.schemaId=="string"?s.schemaId:null)||(typeof s.schema_id=="string"?s.schema_id:null)||$t(s,["schemaId","schema_id"])||void 0,viewHint:(typeof s.viewHint=="string"?s.viewHint:null)||(typeof s.view_hint=="string"?s.view_hint:null)||$t(s,["viewHint","view_hint"])||void 0};return a.schemaId&&(a.schemaId=a.schemaId.trim()),a.viewHint&&(a.viewHint=a.viewHint.trim().toLowerCase()),Array.isArray(s.children)&&(a.children=s.children.map(xt)),a}function zt(t,s=0){const r=[];for(const a of t)r.push({elementId:a.elementId,displayName:a.displayName,documentNumber:a.documentNumber,parentElementId:a.parentElementId,domainId:a.domainId,definitionId:a.definitionId,schemaId:a.schemaId,viewHint:a.viewHint,depth:s}),a.children&&a.children.length>0&&r.push(...zt(a.children,s+1));return r}function Qa(t,s){if(!s.trim())return zt(t);const r=s.toLowerCase(),a=[];function u(l,o){var n;for(const d of l){const i=d.displayName.toLowerCase().includes(r),p=(n=d.documentNumber)==null?void 0:n.toLowerCase().includes(r);(i||p)&&a.push({elementId:d.elementId,displayName:d.displayName,documentNumber:d.documentNumber,parentElementId:d.parentElementId,domainId:d.domainId,definitionId:d.definitionId,schemaId:d.schemaId,viewHint:d.viewHint,depth:o}),d.children&&d.children.length>0&&u(d.children,o+1)}}return u(t,0),a}function us(t,s){const r=[];for(const a of t){const u=s(a),l=a.children?us(a.children,s):[];(u||l.length>0)&&r.push({...a,children:l.length>0?l:void 0})}return r}function Wa(t){const r=(typeof t=="string"?new Date(t):t).toISOString().slice(2,10).replace(/-/g,"");return a=>a.documentNumber?a.documentNumber.startsWith(r):!1}function Ga({job:t,department:s,appliedBorderColor:r,isJobBeingDeleted:a,cardOpacity:u,pointerEvents:l,jobDetailsDialogOpen:o,setJobDetailsDialogOpen:n}){const d=t.title||t.name||t.job_name||"Unnamed Job",i=t.start_time?ce(new Date(t.start_time),"dd/MM/yyyy HH:mm"):"",p=t.end_time?ce(new Date(t.end_time),"dd/MM/yyyy HH:mm"):"";let y="No location";return typeof t.location=="string"?y=t.location:t.location&&typeof t.location=="object"?y=t.location.name||t.location.formatted_address||"No location":t.location_data?y=t.location_data.name||t.location_data.formatted_address||"No location":t.venue_name&&(y=t.venue_name),e.jsxs("div",{className:"p-2 bg-gray-50 dark:bg-gray-900",children:[e.jsxs(es,{className:W("hover:shadow-md transition-all duration-200",u,l),style:{borderLeftColor:r,borderLeftWidth:"4px"},children:[a&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center z-10 rounded",children:e.jsx("div",{className:"bg-white dark:bg-gray-800 px-4 py-2 rounded-md shadow-lg",children:e.jsx("span",{className:"text-sm font-medium",children:"Deleting job..."})})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("h3",{className:"font-semibold text-lg truncate",title:d,children:d}),e.jsx("div",{className:"text-sm text-muted-foreground",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[i&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Start:"})," ",i]}),p&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"End:"})," ",p]})]})}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Location:"})," ",e.jsx("span",{className:"text-muted-foreground",children:y})]}),e.jsx(F,{variant:"outline",size:"sm",className:"w-full",onClick:b=>{b.stopPropagation(),n(!0)},children:"View Details"})]})]}),e.jsx(ls,{job:t,open:o,onOpenChange:n,department:s})]})}function Ra({open:t,onOpenChange:s,jobId:r,department:a,requestId:u,onSubmitted:l}){const[o,n]=U.useState([{transport_type:"trailer",leftover_space_meters:""}]),[d,i]=U.useState(""),[p,y]=U.useState(""),{toast:b}=et();U.useEffect(()=>{(async()=>{if(!u)return;const{data:c,error:h}=await N.from("transport_requests").select("id, note, description, items:transport_request_items(id, transport_type, leftover_space_meters)").eq("id",u).single();if(!h&&c)if(i(c.note||""),y(c.description||""),Array.isArray(c.items)&&c.items.length>0){const m=c.items.map(T=>({transport_type:T.transport_type,leftover_space_meters:T.leftover_space_meters??""}));n(m)}else n([{transport_type:"trailer",leftover_space_meters:""}])})()},[u]);const g=async k=>{k.preventDefault();try{const{data:{user:c}}=await N.auth.getUser();if(!c)throw new Error("Not authenticated");const h={job_id:r,department:a,note:d||null,description:p||null,status:"requested",created_by:c.id};if(u){const{error:m}=await N.from("transport_requests").update(h).eq("id",u);if(m)throw m;await N.from("transport_request_items").delete().eq("request_id",u);const T=o.filter(w=>!!w.transport_type).map(w=>({request_id:u,transport_type:w.transport_type,leftover_space_meters:w.leftover_space_meters===""?null:w.leftover_space_meters}));if(T.length>0){const{error:w}=await N.from("transport_request_items").insert(T);if(w)throw w}}else{const{data:m,error:T}=await N.from("transport_requests").insert(h).select("id").single();if(T)throw T;const w=m.id,I=o.filter(L=>!!L.transport_type).map(L=>({request_id:w,transport_type:L.transport_type,leftover_space_meters:L.leftover_space_meters===""?null:L.leftover_space_meters}));if(I.length>0){const{error:L}=await N.from("transport_request_items").insert(I);if(L)throw L}try{const{error:L}=await N.functions.invoke("push",{body:{action:"broadcast",type:"logistics.transport.requested",job_id:r,department:a,request_id:w,description:p||void 0}})}catch{}}b({title:"Transport request saved"}),l==null||l(),s(!1)}catch(c){b({title:"Error",description:c.message||"Failed to save request",variant:"destructive"})}};return e.jsx(Le,{open:t,onOpenChange:s,children:e.jsxs($e,{children:[e.jsx(dt,{children:e.jsx(mt,{children:u?"Edit Transport Request":"Request Transport"})}),e.jsxs("form",{onSubmit:g,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Et,{children:"Description"}),e.jsx(Tt,{value:p,onChange:k=>y(k.target.value),placeholder:"E.g., Subrental pickup from ABC Rental, Return equipment to vendor"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Et,{children:"Vehicles"}),e.jsxs("div",{className:"space-y-2",children:[o.map((k,c)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(qs,{value:k.transport_type,onValueChange:h=>{const m=o.slice();m[c]={...m[c],transport_type:h},n(m)},children:[e.jsx(Ms,{className:"w-40",children:e.jsx(Os,{})}),e.jsx(Us,{children:ua.map(h=>e.jsx(Ls,{value:h,children:h.replace("_"," ")},h))})]}),e.jsx(Tt,{type:"number",min:0,step:.1,className:"w-52",placeholder:"Leftover space (m) - optional",value:k.leftover_space_meters===""?"":k.leftover_space_meters,onChange:h=>{const m=h.target.value,T=m===""?"":Math.max(0,Number(m)),w=o.slice();w[c]={...w[c],leftover_space_meters:T},n(w)}}),e.jsx(F,{type:"button",variant:"outline",onClick:()=>{const h=o.slice();h.splice(c,1),n(h.length?h:[{transport_type:"trailer",leftover_space_meters:""}])},children:"Remove"})]},c)),e.jsx("div",{children:e.jsx(F,{type:"button",variant:"secondary",onClick:()=>n([...o,{transport_type:"trailer",leftover_space_meters:""}]),children:"Add Vehicle"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Et,{children:"Note"}),e.jsx(Tt,{value:d,onChange:k=>i(k.target.value),placeholder:"Optional details"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(F,{type:"submit",children:[u?"Update":"Submit"," Request"]})})]})]})})}const Za=({open:t,onOpenChange:s,mainElementId:r,defaultElementId:a,onSelect:u,filterPredicate:l})=>{const[o,n]=U.useState(""),[d,i]=U.useState(!1);E.useEffect(()=>{if(!t)i(!1),n("");else{const w=setTimeout(()=>i(!0),50);return()=>clearTimeout(w)}},[t]);const{data:p,isLoading:y,isError:b,error:g,refetch:k}=_e({queryKey:["flexElementTree",r],queryFn:()=>ms(r),enabled:t&&!!r,retry:1,staleTime:300*1e3}),c=U.useMemo(()=>{if(!p)return[];let w=p;l&&(w=us(p,l));let I;return o.trim()?I=Qa(w,o):I=zt(w),I.filter(L=>L.elementId&&typeof L.elementId=="string"&&L.elementId.trim().length>0)},[p,o,l]),h=w=>{u(w.elementId,w),s(!1)},m=()=>{s(!1)},T=w=>{const I=w.elementId===a,L=w.depth*16;return e.jsx(Na,{value:`${w.elementId}-${w.displayName}-${w.documentNumber||""}`,onSelect:()=>h(w),className:W("cursor-pointer",I&&"bg-accent/50 font-medium"),style:{paddingLeft:`${L+8}px`},children:e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[w.depth===0?e.jsx(Ja,{className:"h-4 w-4 flex-shrink-0 text-muted-foreground"}):e.jsx(ja,{className:"h-4 w-4 flex-shrink-0 text-muted-foreground"}),e.jsxs("div",{className:"flex flex-col flex-1 min-w-0",children:[e.jsx("span",{className:"truncate",children:w.displayName}),w.documentNumber&&e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:w.documentNumber})]}),I&&e.jsx("span",{className:"text-xs text-muted-foreground flex-shrink-0",children:"(default)"})]})},w.elementId)};return e.jsx(Le,{open:t,onOpenChange:s,children:e.jsxs($e,{className:"sm:max-w-2xl",children:[e.jsxs(dt,{children:[e.jsx(mt,{children:"Select Flex Element"}),e.jsx(yt,{children:l?"Choose an element for this tour date to open in Flex.":"Choose an element from the tree to open in Flex."})]}),e.jsx("div",{className:"flex flex-col gap-4",children:y?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(we,{className:"h-8 w-8 animate-spin text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading element tree..."})]})}):b?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("p",{className:"text-sm font-medium text-destructive",children:"Failed to load element tree"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:(g==null?void 0:g.message)||"An unexpected error occurred"})]}),e.jsx(F,{onClick:()=>k(),variant:"outline",size:"sm",children:"Retry"})]}):t&&d?e.jsxs(ga,{className:"rounded-lg border",children:[e.jsx(ya,{placeholder:"Search elements...",value:o,onValueChange:n}),e.jsxs(va,{className:"max-h-[400px]",children:[e.jsx(_a,{children:o?"No elements found matching your search.":"No elements available."}),e.jsx(wa,{children:c.map(w=>T(w))})]})]}):t?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(we,{className:"h-4 w-4 animate-spin text-muted-foreground"})}):null}),e.jsx(vt,{children:e.jsx(F,{variant:"outline",onClick:m,children:"Cancel"})})]})})};function Xa(t){if(!t.flex_folders||!Array.isArray(t.flex_folders))return null;const s=t.flex_folders.find(a=>a.folder_type==="main_event");if(s)return{elementId:s.element_id,department:s.department};const r=t.flex_folders.find(a=>a.folder_type==="main");return r?{elementId:r.element_id,department:r.department}:null}async function Ya(t,s){var a;if(t.job_type!=="tourdate")return null;const r=t.tour_id||((a=t.tour)==null?void 0:a.id);if(!r)return null;if(t.tour){if(s){const u=`flex_${s}_folder_id`,l=t.tour[u];if(l&&typeof l=="string")return l}if(t.tour.flex_main_folder_id)return t.tour.flex_main_folder_id}try{const{data:u,error:l}=await N.from("tours").select(`
        flex_main_folder_id,
        flex_sound_folder_id,
        flex_lights_folder_id,
        flex_video_folder_id,
        flex_production_folder_id,
        flex_personnel_folder_id
      `).eq("id",r).single();if(l||!u)return null;if(s){const o=`flex_${s}_folder_id`,n=u[o];if(n)return n}return u.flex_main_folder_id||null}catch{return null}}const en=({job:t})=>{const{toast:s}=et(),[r,a]=E.useState(!1),[u,l]=E.useState(!1),[o,n]=E.useState(null),[d,i]=E.useState(null),[p,y]=E.useState("by-prefix"),[b,g]=E.useState(!1),[k,c]=E.useState(!1);if((t==null?void 0:t.job_type)==="dryhire")return null;const h=async()=>{l(!0),i(null),n(null);try{const{data:m,error:T}=await N.functions.invoke("archive-to-flex",{body:{job_id:t.id,mode:p,include_templates:b,dry_run:k}});if(T)throw T;n(m),s({title:k?"Dry run complete":"Archive complete",description:`${(m==null?void 0:m.uploaded)??0} uploaded, ${(m==null?void 0:m.failed)??0} failed`})}catch(m){i((m==null?void 0:m.message)||"Failed to archive"),s({title:"Archive failed",description:(m==null?void 0:m.message)||"Failed to archive",variant:"destructive"})}finally{l(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:m=>{m.stopPropagation(),a(!0)},className:"gap-2",title:"Archivar documentos en Flex",children:[e.jsx(na,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Archivar"})]}),e.jsx(Le,{open:r,onOpenChange:a,children:e.jsxs($e,{className:"sm:max-w-lg",children:[e.jsxs(dt,{children:[e.jsx(mt,{children:"Archive documents to Flex"}),e.jsx(yt,{children:"Uploads all job documents to each department's DocumentaciÃ³n TÃ©cnica in Flex and removes them from Supabase."})]}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Mode"}),e.jsxs("select",{className:"w-full h-9 rounded-md border bg-background px-3 text-sm",value:p,onChange:m=>y(m.target.value),children:[e.jsx("option",{value:"by-prefix",children:"By prefix (default)"}),e.jsx("option",{value:"all-tech",children:"All technical depts"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-6 sm:mt-[30px]",children:[e.jsx("input",{id:"includeTemplatesA",type:"checkbox",checked:b,onChange:m=>g(m.target.checked)}),e.jsx("label",{htmlFor:"includeTemplatesA",className:"text-sm",children:"Include templates"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"dryRunA",type:"checkbox",checked:k,onChange:m=>c(m.target.checked)}),e.jsx("label",{htmlFor:"dryRunA",className:"text-sm",children:"Dry run (no delete)"})]})]}),u&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(we,{className:"h-4 w-4 animate-spin"})," Archiving..."]}),d&&e.jsx("div",{className:"text-sm text-red-600",children:d}),o&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:"Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:["Attempted: ",e.jsx("span",{className:"font-medium",children:o.attempted??0})]}),e.jsxs("div",{children:["Uploaded: ",e.jsx("span",{className:"font-medium",children:o.uploaded??0})]}),e.jsxs("div",{children:["Skipped: ",e.jsx("span",{className:"font-medium",children:o.skipped??0})]}),e.jsxs("div",{children:["Failed: ",e.jsx("span",{className:"font-medium",children:o.failed??0})]})]}),o.details&&Array.isArray(o.details)&&e.jsx("div",{className:"max-h-48 overflow-auto border rounded p-2 text-xs",children:o.details.map((m,T)=>e.jsxs("div",{className:"flex items-center justify-between py-0.5",children:[e.jsx("div",{className:"truncate mr-2",title:m.file,children:m.file}),e.jsx("div",{className:"text-muted-foreground",children:m.status})]},T))})]})]}),e.jsxs(vt,{children:[e.jsx(F,{variant:"outline",onClick:()=>a(!1),disabled:u,children:"Cerrar"}),e.jsxs(F,{onClick:h,disabled:u,children:[u?e.jsx(we,{className:"h-4 w-4 animate-spin mr-2"}):null,k?"Prueba":"Iniciar"]})]})]})})]})},tn=({job:t})=>{const{toast:s}=et(),[r,a]=E.useState(!1),[u,l]=E.useState(!1),[o,n]=E.useState(null),[d,i]=E.useState(null),[p,y]=E.useState(!0),[b,g]=E.useState(!0),[k,c]=E.useState(!0),[h,m]=E.useState(!0),[T,w]=E.useState(""),[I,L]=E.useState(""),[M,te]=E.useState(""),[de,ne]=E.useState(""),ke=async()=>{l(!0),n(null),i(null);try{const C=[];p&&C.push("sound"),b&&C.push("lights"),k&&C.push("video"),h&&C.push("production");const re={job_id:t.id};C.length&&(re.departments=C);const Y=[];T.trim()&&Y.push({dept:"sound",element_id:T.trim()}),I.trim()&&Y.push({dept:"lights",element_id:I.trim()}),M.trim()&&Y.push({dept:"video",element_id:M.trim()}),de.trim()&&Y.push({dept:"production",element_id:de.trim()}),Y.length&&(re.manual=Y);const{data:B,error:he}=await N.functions.invoke("backfill-flex-doc-tecnica",{body:re});if(he)throw he;i(B),n(`Inserted ${(B==null?void 0:B.inserted)??0}, already ${(B==null?void 0:B.already)??0}`),s({title:"Backfill complete",description:`Inserted ${(B==null?void 0:B.inserted)??0}, already ${(B==null?void 0:B.already)??0}`})}catch(C){n((C==null?void 0:C.message)||"Backfill failed"),s({title:"Backfill failed",description:(C==null?void 0:C.message)||"Backfill failed",variant:"destructive"})}finally{l(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx(F,{variant:"ghost",size:"icon",onClick:C=>{C.stopPropagation(),a(!0)},disabled:u,title:u?"Rellenandoâ€¦":"Rellenar Doc TÃ©cnica",className:u?"opacity-50 cursor-not-allowed":"hover:bg-accent/50",children:u?e.jsx(we,{className:"h-4 w-4 animate-spin"}):e.jsx(ra,{className:"h-4 w-4"})}),e.jsx(Le,{open:r,onOpenChange:a,children:e.jsxs($e,{className:"sm:max-w-lg",children:[e.jsxs(dt,{children:[e.jsx(mt,{children:"Backfill DocumentaciÃ³n TÃ©cnica"}),e.jsx(yt,{children:"Finds and persists missing DocumentaciÃ³n TÃ©cnica elements for this job so archiving can target them reliably."})]}),e.jsxs("div",{className:"space-y-4 py-2 text-sm",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:p,onChange:C=>y(C.target.checked)})," Sound"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:b,onChange:C=>g(C.target.checked)})," Lights"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:k,onChange:C=>c(C.target.checked)})," Video"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:h,onChange:C=>m(C.target.checked)})," ","Production"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Manual UUIDs (optional)"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"Sound UUID"}),e.jsx("input",{className:"w-full h-8 rounded border px-2 text-xs",value:T,onChange:C=>w(C.target.value),placeholder:"paste elementId"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"Lights UUID"}),e.jsx("input",{className:"w-full h-8 rounded border px-2 text-xs",value:I,onChange:C=>L(C.target.value),placeholder:"paste elementId"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"Video UUID"}),e.jsx("input",{className:"w-full h-8 rounded border px-2 text-xs",value:M,onChange:C=>te(C.target.value),placeholder:"paste elementId"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",children:"Production UUID"}),e.jsx("input",{className:"w-full h-8 rounded border px-2 text-xs",value:de,onChange:C=>ne(C.target.value),placeholder:"paste elementId"})]})]})]}),u&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"h-4 w-4 animate-spin"})," Backfillingâ€¦"]}),o&&e.jsx("div",{className:"text-muted-foreground",children:o}),(d==null?void 0:d.details)&&e.jsx("div",{className:"max-h-48 overflow-auto border rounded p-2 text-xs",children:d.details.map((C,re)=>e.jsxs("div",{className:"flex items-center justify-between py-0.5",children:[e.jsx("div",{className:"truncate mr-2",children:C.dept}),e.jsx("div",{className:"truncate mr-2",title:C.elementId,children:C.elementId}),e.jsx("div",{className:"text-muted-foreground",children:C.status})]},re))})]}),e.jsxs(vt,{children:[e.jsx(F,{variant:"outline",onClick:()=>a(!1),disabled:u,children:"Cerrar"}),e.jsxs(F,{onClick:ke,disabled:u,children:[u?e.jsx(we,{className:"h-4 w-4 animate-spin mr-2"}):null,"Iniciar"]})]})]})})]})};function sn(t){if(!t||typeof t!="string")return;const s=t.trim().toLowerCase();if(!s)return;if(s==="auto")return"auto";switch(s.replace(/[\s_]+/g,"-")){case"contact-list":case"contactlist":case"crew-call":case"crewcall":case"crew-list":case"crewlist":return"contact-list";case"equipment-list":case"equipmentlist":case"pull-sheet":case"pullsheet":case"pull-list":case"pulllist":return"equipment-list";case"remote-file-list":case"remotefilelist":case"remote-files":case"remotefiles":case"remote-files-list":return"remote-file-list";case"expense-sheet":case"expensesheet":case"expense":return"expense-sheet";case"fin-doc":case"financial-document":case"financial-doc":case"financialdoc":case"presupuesto":return"fin-doc";case"simple-element":case"folder":case"element":return"simple-element";default:return}}const an=({job:t,userRole:s,foldersAreCreated:r,isProjectManagementPage:a,isHouseTech:u,showUpload:l,canEditJobs:o,canCreateFlexFolders:n,canUploadDocuments:d,canManageArtists:i,department:p,isCreatingFolders:y=!1,isCreatingLocalFolders:b=!1,folderStateLoading:g=!1,techName:k,onRefreshData:c,onEditButtonClick:h,onDeleteClick:m,onCreateFlexFolders:T,onAddFlexFolders:w,onCreateLocalFolders:I,onFestivalArtistsClick:L,onAssignmentDialogOpen:M,handleFileUpload:te,onJobDetailsClick:de,onOpenTasks:ne,canSyncFlex:ke,onSyncFlex:C,onOpenFlexLogs:re,transportButtonLabel:Y,transportButtonTone:B,onTransportClick:he,onCreateWhatsappGroup:ze,whatsappDisabled:me})=>{var Z;const Ee=ts(),{toast:P}=et(),[Pe,xe]=E.useState(!1),[He,Je]=E.useState(""),[Te,Ke]=E.useState(!1),[Se,ge]=E.useState(!1),[ue,Be]=E.useState(null),pe=E.useRef(null);E.useEffect(()=>{var j;if((t==null?void 0:t.job_type)!=="dryhire"){pe.current=null;return}const v=[t==null?void 0:t.dryhire_presupuesto_element_id,t==null?void 0:t.dryhirePresupuestoElementId,t==null?void 0:t.presupuesto_element_id,t==null?void 0:t.presupuestoElementId,t==null?void 0:t.flex_presupuesto_element_id,t==null?void 0:t.flexPresupuestoElementId,t==null?void 0:t.flex_budget_element_id,t==null?void 0:t.flexBudgetElementId];for(const D of v)if(typeof D=="string"&&D.trim().length>0){pe.current=D;return}const _=(j=t.flex_folders)==null?void 0:j.find(D=>{const R=typeof(D==null?void 0:D.folder_type)=="string"?D.folder_type.toLowerCase():"",J=typeof(D==null?void 0:D.key)=="string"?D.key.toLowerCase():"",se=typeof(D==null?void 0:D.name)=="string"?D.name.toLowerCase():"";return R==="dryhire_presupuesto"||R==="presupuesto"||R==="presupuesto_dryhire"||J==="dryhire_presupuesto"||J==="presupuesto"||J==="presupuestodryhire"||se.includes("presupuesto")}),O=typeof(_==null?void 0:_.element_id)=="string"&&_.element_id.trim().length>0?_.element_id:typeof(_==null?void 0:_.elementId)=="string"&&_.elementId.trim().length>0?_.elementId:null;pe.current=O},[t]);const tt=v=>{v.stopPropagation(),Ee(`/timesheets?jobId=${t.id}`)},Ve=a&&(s==="management"||s==="admin"),Qe=["single","festival","tourdate"].includes(t==null?void 0:t.job_type),We=(v,_)=>{v.stopPropagation();const O=new URLSearchParams({jobId:t.id});let j="";switch(p){case"sound":j=_==="pesos"?"/sound/pesos":"/sound/consumos";break;case"lights":j=_==="pesos"?"/lights-pesos-tool":"/lights-consumos-tool";break;case"video":j=_==="pesos"?"/video-pesos-tool":"/video-consumos-tool";break;default:j=_==="pesos"?"/sound/pesos":"/sound/consumos"}Ee(`${j}?${O.toString()}`)},Ae=(t==null?void 0:t.tour_id)||((Z=t==null?void 0:t.tour)==null?void 0:Z.id)||void 0,{data:ye}=_e({queryKey:["tour-default-exists",Ae,p],enabled:!!(Ae&&p&&Ve&&Qe),queryFn:async()=>{const{data:v,error:_}=await N.from("tour_default_sets").select("id").eq("tour_id",Ae).eq("department",p);if(_)throw _;if(!v||v.length===0)return{weight:!1,power:!1};const O=v.map(se=>se.id),{data:j,error:D}=await N.from("tour_default_tables").select("id, table_type").in("set_id",O);if(D)throw D;const R=(j||[]).some(se=>se.table_type==="weight"),J=(j||[]).some(se=>se.table_type==="power");return{weight:R,power:J}}}),st=()=>y?"Creando carpetas...":r?"Las carpetas ya existen":"Crear carpetas Flex",G=E.useMemo(()=>Xa(t),[t]),{flexUuid:Fe,isLoading:Ne,error:Ge}=xa(r?t.id:""),Ie=E.useMemo(()=>{var v;if(g||y||Ne)return!1;if(a){if(G!=null&&G.elementId||t.job_type==="tourdate")return!0;if(t.job_type==="dryhire"){const _=(v=t.flex_folders)==null?void 0:v.find(O=>O.folder_type==="dryhire");return!!(_!=null&&_.element_id)}}return!!Fe},[g,y,Ne,a,G,t,Fe]),Re=async v=>{var _,O;if(v.stopPropagation(),g||y||Ne){P({title:"Loading",description:y?"Creating Flex folders, please wait...":"Please wait while we load the Flex folder..."});return}if(a&&(G!=null&&G.elementId)){ge(!0);return}if(a&&t.job_type==="tourdate")try{const j=await Ya(t,p);if(!j){P({title:"Tour folders not found",description:"Please ensure the parent tour has Flex folders created first.",variant:"destructive"});return}const D=t.start_time;if(!D){P({title:"Date not found",description:"Unable to determine tour date for filtering.",variant:"destructive"});return}Be({mainElementId:j,filterDate:D}),ge(!0);return}catch{P({title:"Error",description:"Failed to load tour folder information.",variant:"destructive"});return}if(a&&t.job_type==="dryhire"){const j=(_=t.flex_folders)==null?void 0:_.find(J=>J.folder_type==="dryhire"),D=(O=t.flex_folders)==null?void 0:O.find(J=>J.folder_type==="dryhire_presupuesto");let R=typeof pe.current=="string"?pe.current:null;if(!R&&(D!=null&&D.element_id)&&(R=D.element_id,pe.current=R),!R&&(j!=null&&j.element_id))try{const J=await ms(j.element_id),se=Array.isArray(J)?[...J]:[];for(;se.length>0;){const X=se.shift();if(!X||typeof X!="object")continue;const je=typeof X.elementId=="string"&&X.elementId.trim().length>0?X.elementId:null,Me=typeof X.definitionId=="string"?X.definitionId:void 0,Xe=typeof X.displayName=="string"?X.displayName:typeof X.name=="string"?X.name:"";if(je&&(Me===Wt.presupuestoDryHire||(Xe||"").toLowerCase().includes("presupuesto"))){R=je;break}Array.isArray(X.children)&&se.push(...X.children)}R&&(pe.current=R)}catch{P({title:"Error",description:"Failed to load the dry-hire presupuesto from Flex.",variant:"destructive"});return}if(!R){P({title:"Presupuesto not found",description:"No presupuesto element was found for this dry-hire job.",variant:"destructive"});return}await qt({elementId:R,context:{jobType:t.job_type,folderType:"dryhire",definitionId:Wt.presupuestoDryHire},onError:J=>{P({title:"Error",description:J.message||"Failed to open Flex",variant:"destructive"})},onWarning:J=>{P({title:"Warning",description:J})}});return}if(Fe){await qt({elementId:Fe,context:{jobType:t.job_type},onError:j=>{P({title:"Error",description:j.message||"Failed to open Flex",variant:"destructive"})},onWarning:j=>{P({title:"Warning",description:j})}});return}P(Ge?{title:"Error",description:Ge,variant:"destructive"}:{title:"Flex folder not available",description:"No valid Flex element found for this job. Please ensure folders are created.",variant:"destructive"})},Ze=E.useCallback((v,_)=>{if(!v||typeof v!="string"||v.trim().length===0){t.id,t.job_type,new Date().toISOString(),P({title:"Invalid element",description:_!=null&&_.displayName?`Cannot open "${_.displayName}" - invalid element ID.`:"Invalid element ID received. Cannot navigate to Flex.",variant:"destructive"});return}qt({elementId:v,context:{definitionId:_==null?void 0:_.definitionId,domainId:_==null?void 0:_.domainId,schemaId:_==null?void 0:_.schemaId,viewHint:sn(_==null?void 0:_.viewHint),jobType:t.job_type},onError:O=>{O instanceof Error?O.message:String(O),O instanceof Error&&O.stack,t.id,t.job_type,new Date().toISOString(),P({title:"Navigation error",description:O instanceof Error?O.message:"Failed to open Flex",variant:"destructive"})},onWarning:O=>{P({title:"Warning",description:O})}})},[t.job_type,t.id,P]),at=v=>{v.stopPropagation();const _=new URLSearchParams({singleJob:"true"});Ee(`/festival-management/${t.id}?${_.toString()}`)},qe=!0,ve=ss();return e.jsxs("div",{className:W("flex flex-wrap",ve?"gap-1":"gap-1.5"),onClick:v=>v.stopPropagation(),children:[a&&t.job_type!=="dryhire"&&ne&&e.jsxs(F,{variant:"outline",size:"sm",onClick:ne,className:"gap-2",title:"Tareas",children:[e.jsx(pa,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Tareas"})]}),Y&&he&&e.jsx(F,{variant:B||"outline",size:"sm",onClick:he,className:"gap-2",title:Y,children:Y}),a&&(s==="management"||s==="admin")&&ze&&t.job_type!=="dryhire"&&e.jsxs(F,{variant:"outline",size:"sm",onClick:ze,disabled:!!me,className:"gap-2",title:me?"Grupo ya creado":"Crear grupo WhatsApp",children:[e.jsx(Gt,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"WhatsApp"})]}),a&&(s==="management"||s==="admin")&&e.jsxs(F,{variant:"outline",size:"sm",onClick:()=>{const v=(t==null?void 0:t.title)||"trabajo";Je(`He hecho cambios en el PS del ${v} por favor echad un vistazo`),xe(!0)},className:"gap-2",title:"Enviar mensaje a AlmacÃ©n sonido",children:[e.jsx(Gt,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"AlmacÃ©n"})]}),de&&e.jsxs(F,{variant:"outline",size:"sm",onClick:de,className:"gap-2",children:[e.jsx(ba,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Ver Detalles"})]}),t.job_type==="festival"&&a&&i&&e.jsxs(F,{variant:"outline",size:"sm",onClick:L,className:"hover:bg-accent/50",title:s==="technician"||s==="house_tech"?"Ver Festival":"Gestionar Festival",children:[e.jsx(Ut,{className:"h-4 w-4 mr-1"}),e.jsx("span",{className:"hidden sm:inline",children:s==="technician"||s==="house_tech"?"Ver Festival":"Gestionar Festival"})]}),t.job_type!=="festival"&&t.job_type!=="dryhire"&&a&&i&&e.jsxs(F,{variant:"outline",size:"sm",onClick:at,className:"hover:bg-accent/50",title:s==="technician"||s==="house_tech"?"Ver Trabajo":"Gestionar Trabajo",children:[e.jsx(Ca,{className:"h-4 w-4 mr-1"}),e.jsx("span",{className:"hidden sm:inline",children:s==="technician"||s==="house_tech"?"Ver Trabajo":"Gestionar Trabajo"})]}),!u&&t.job_type!=="dryhire"&&a&&e.jsxs(F,{variant:"outline",size:"sm",onClick:M,className:"hover:bg-accent/50",title:"Asignar",children:[e.jsx(Ut,{className:"h-4 w-4 mr-1"}),e.jsx("span",{className:"hidden sm:inline",children:"Asignar"})]}),e.jsx(F,{variant:"ghost",size:"icon",onClick:c,title:"Actualizar",className:"hover:bg-accent/50",children:e.jsx(Vt,{className:"h-4 w-4"})}),a&&ke&&qe&&e.jsx(F,{variant:"ghost",size:"icon",onClick:C,title:"Sincronizar estado con Flex",className:"hover:bg-accent/50",children:e.jsx(Vt,{className:"h-4 w-4"})}),t.job_type!=="dryhire"&&t.job_type!=="tourdate"&&e.jsx(F,{variant:"ghost",size:"icon",onClick:tt,title:"Gestionar Hojas de Tiempo",className:"hover:bg-accent/50",children:e.jsx(os,{className:"h-4 w-4"})}),Ve&&Qe&&e.jsxs(e.Fragment,{children:[e.jsxs(F,{variant:"outline",size:"sm",className:"gap-2",title:"Calculadora de Pesos",onClick:v=>We(v,"pesos"),children:[e.jsx(ia,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Pesos"}),(ye==null?void 0:ye.weight)&&e.jsx("span",{className:"ml-1 inline-block h-2 w-2 rounded-full bg-green-500",title:"Existen valores predeterminados de gira"})]}),e.jsxs(F,{variant:"outline",size:"sm",className:"gap-2",title:"Calculadora de Consumos",onClick:v=>We(v,"consumos"),children:[e.jsx(ka,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Consumos"}),(ye==null?void 0:ye.power)&&e.jsx("span",{className:"ml-1 inline-block h-2 w-2 rounded-full bg-green-500",title:"Existen valores predeterminados de gira"})]})]}),s==="technician"&&t.job_type!=="dryhire"&&e.jsx(ha,{job:t,techName:k}),o&&e.jsxs(e.Fragment,{children:[e.jsx(F,{variant:"ghost",size:"icon",onClick:h,title:"Editar detalles del trabajo",className:"hover:bg-accent/50",children:e.jsx(Sa,{className:"h-4 w-4"})}),e.jsx(F,{variant:"ghost",size:"icon",onClick:m,title:"Eliminar trabajo",className:"hover:bg-accent/50",children:e.jsx(as,{className:"h-4 w-4"})})]}),n&&(r?e.jsxs(e.Fragment,{children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:v=>{if(!Ie){v.stopPropagation(),P({title:"No se puede abrir Flex",description:"No hay un elemento Flex vÃ¡lido disponible para este trabajo.",variant:"destructive"});return}Re(v)},disabled:!Ie,className:"gap-2",title:Ie?Ne||y||g?"Cargandoâ€¦":"Abrir en Flex":"No hay un elemento Flex vÃ¡lido disponible",children:[Ne||y||g?e.jsx(we,{className:"h-4 w-4 animate-spin"}):e.jsx(Fa,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Abrir Flex"})]}),t.job_type!=="dryhire"&&w?e.jsx(F,{variant:"ghost",size:"icon",onClick:w,disabled:g||y,title:"AÃ±adir carpetas Flex",className:g||y?"opacity-50 cursor-not-allowed":"hover:bg-accent/50",children:e.jsx("img",{src:Qt,alt:"AÃ±adir carpetas Flex",width:16,height:16,loading:"lazy",decoding:"async",className:"h-4 w-4"})}):null]}):e.jsx(F,{variant:"ghost",size:"icon",onClick:T,disabled:g||y,title:st(),className:g||y?"opacity-50 cursor-not-allowed":"hover:bg-accent/50",children:y?e.jsx(we,{className:"h-4 w-4 animate-spin"}):e.jsx("img",{src:Qt,alt:"Crear carpetas Flex",width:16,height:16,loading:"lazy",decoding:"async",className:"h-4 w-4"})})),e.jsx(F,{variant:"ghost",size:"icon",onClick:I,disabled:b,title:b?"Creando carpetas locales...":"Crear estructura de carpetas locales",className:b?"opacity-50 cursor-not-allowed":"hover:bg-accent/50",children:b?e.jsx(we,{className:"h-4 w-4 animate-spin"}):e.jsx(Ia,{className:"h-4 w-4"})}),e.jsx(en,{job:t}),e.jsx(tn,{job:t}),t.job_type!=="dryhire"&&l&&d&&e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",onChange:te,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",onClick:v=>v.stopPropagation()}),e.jsx(F,{variant:"ghost",size:"icon",className:"hover:bg-accent/50",children:e.jsx(Da,{className:"h-4 w-4"})})]}),a&&ke&&qe&&e.jsxs(F,{variant:"outline",size:"sm",onClick:re,className:"gap-2",title:"Registros de SincronizaciÃ³n",children:[e.jsx(Ka,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Registros"})]}),Pe&&e.jsx(Le,{open:Pe,onOpenChange:xe,children:e.jsxs($e,{children:[e.jsxs(dt,{children:[e.jsx(mt,{children:"Enviar a AlmacÃ©n sonido"}),e.jsx(yt,{children:'Este mensaje se enviarÃ¡ al grupo de WhatsApp "AlmacÃ©n sonido" desde tu endpoint WAHA.'})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Mensaje"}),e.jsx($s,{value:He,onChange:v=>Je(v.target.value),placeholder:"Escribe tu mensajeâ€¦",className:"min-h-[100px]"})]}),e.jsxs(vt,{children:[e.jsx(F,{variant:"outline",onClick:()=>xe(!1),disabled:Te,children:"Cancelar"}),e.jsx(F,{onClick:async()=>{try{Ke(!0);const v=`He hecho cambios en el PS del ${(t==null?void 0:t.title)||"trabajo"} por favor echad un vistazo`,O=(He||"").trim()||v,j=O.trim().toLowerCase()===v.trim().toLowerCase(),{error:D}=await N.functions.invoke("send-warehouse-message",{body:{message:O,job_id:t==null?void 0:t.id,highlight:j}});D?P({title:"Error al enviar",description:D.message,variant:"destructive"}):(P({title:"Enviado",description:"Mensaje enviado a AlmacÃ©n sonido."}),xe(!1))}catch(v){P({title:"Error",description:(v==null?void 0:v.message)||String(v),variant:"destructive"})}finally{Ke(!1)}},disabled:Te,children:Te?"Enviandoâ€¦":"Enviar"})]})]})}),(()=>{var _,O;let v;return ue?v=ue.mainElementId:G!=null&&G.elementId&&(v=G.elementId),!v||t.job_type==="dryhire"?null:e.jsx(Za,{open:Se,onOpenChange:j=>{ge(j),j||Be(null)},mainElementId:v,onSelect:Ze,defaultElementId:((O=(_=t.flex_folders)==null?void 0:_.find(j=>{var D;return((D=j.department)==null?void 0:D.toLowerCase())===(p==null?void 0:p.toLowerCase())}))==null?void 0:O.element_id)||(G==null?void 0:G.elementId),filterPredicate:ue?Wa(ue.filterDate):void 0})})()]})},nn=({assignments:t,department:s,jobTimesheets:r=[]})=>{const a=n=>{const d=r.filter(g=>g.technician_id===n);if(d.length===0)return"none";const i=d.some(g=>g.status==="rejected"),p=d.some(g=>g.status==="approved"),y=d.some(g=>g.status==="submitted"),b=d.every(g=>g.status==="submitted"||g.status==="approved");return i?"rejected":p&&b?"approved":b?"submitted":y||p?"partial":"draft"},u=n=>{switch(a(n)){case"approved":case"submitted":return"bg-green-500/15 text-green-700 border-green-500/30";case"partial":return"bg-yellow-500/15 text-yellow-700 border-yellow-500/30";case"rejected":return"bg-red-500/15 text-red-700 border-red-500/30";default:return""}},l=new Map;for(const n of t){let d=null;switch(s){case"sound":d=n.sound_role;break;case"lights":d=n.lights_role;break;case"video":d=n.video_role;break;default:d=n.sound_role||n.lights_role||n.video_role}if(!d)continue;const i=!n.profiles&&!!n.external_technician_name,p=n.profiles?Ea(n.profiles.first_name,n.profiles.nickname,n.profiles.last_name):n.external_technician_name||"Unknown",y=n.technician_id?`tech:${n.technician_id}`:`ext:${p}`,b=d?ns(d):null,g=n.assignment_source==="tour",k=n._timesheet_dates,c=n.single_day&&n.assignment_date?n.assignment_date:null,h=new Set;if(Array.isArray(k)&&k.length>0?k.forEach(m=>h.add(m)):c&&h.add(c),!l.has(y))l.set(y,{id:n.technician_id||n.id,name:p,role:b,isFromTour:g,isExternal:i,dates:h});else{const m=l.get(y);!m.role&&b&&(m.role=b),g&&(m.isFromTour=!0),h.forEach(T=>m.dates.add(T))}}const o=Array.from(l.values());return o.length===0?null:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:o.map((n,d)=>{const i=Array.from(n.dates);let p=null;if(i.length===1)try{p=` â€¢ ${ce(new Date(`${i[0]}T00:00:00`),"MMM d")}`}catch{p=` â€¢ ${i[0]}`}else if(i.length>1){const g=i.map(c=>new Date(`${c}T00:00:00`)).sort((c,h)=>c.getTime()-h.getTime());let k=!0;for(let c=1;c<g.length;c++)if((g[c].getTime()-g[c-1].getTime())/864e5!==1){k=!1;break}if(k){const c=g[0],h=g[g.length-1],m=c.getMonth()===h.getMonth()&&c.getFullYear()===h.getFullYear();p=` â€¢ ${ce(c,"MMM d")}${m?"â€“"+ce(h,"d"):"â€“"+ce(h,"MMM d")}`}else p=` â€¢ ${i.length}d`}const y=(()=>{if(i.length===0)return null;try{return i.map(k=>ce(new Date(`${k}T00:00:00`),"PPP")).join(`
`)}catch{return i.join(", ")}})(),b=u(n.id);return e.jsxs(zs,{children:[e.jsx(Ps,{asChild:!0,children:e.jsxs(oe,{variant:n.isFromTour?"outline":"secondary",className:W("text-xs max-w-full border",n.isFromTour?"border-blue-300 text-blue-700":"",b),children:[n.name," ",n.role&&`(${n.role})`,n.isFromTour&&" ðŸŽª",n.isExternal&&" ðŸ‘¤",p]})}),y&&e.jsx(Hs,{side:"top",align:"start",children:e.jsx("div",{className:"whitespace-pre leading-tight text-xs",children:y})})]},n.id||d)})})]})},rn=({documents:t,userRole:s,onDeleteDocument:r,showTitle:a=!0})=>{if(t.length===0)return null;const u=async n=>{try{const{bucket:d,path:i}=Rt(n.file_path),{data:p,error:y}=await N.storage.from(d).createSignedUrl(i,60);if(y||!(p!=null&&p.signedUrl))throw y||new Error("Failed to generate signed URL");window.open(p.signedUrl,"_blank")}catch(d){alert(`Error viewing document: ${d.message}`)}},l=async n=>{try{const{bucket:d,path:i}=Rt(n.file_path),{data:p,error:y}=await N.storage.from(d).createSignedUrl(i,60);if(y||!(p!=null&&p.signedUrl))throw y||new Error("Failed to generate download URL");const b=document.createElement("a");b.href=p.signedUrl,b.download=n.file_name,document.body.appendChild(b),b.click(),document.body.removeChild(b)}catch(d){alert(`Error downloading document: ${d.message}`)}},o=async n=>{if(!n.read_only)try{const d=!n.visible_to_tech,{error:i}=await N.from("job_documents").update({visible_to_tech:d}).eq("id",n.id);if(i)throw i;try{N.functions.invoke("push",{body:{action:"broadcast",type:d?"document.tech_visible.enabled":"document.tech_visible.disabled",doc_id:n.id,file_name:n.file_name}})}catch{}}catch(d){alert(`Error updating visibility: ${d.message}`)}};return e.jsxs("div",{className:"mt-2 space-y-2",children:[a&&e.jsx("div",{className:"text-sm font-medium",children:"Documents"}),e.jsx("div",{className:"space-y-2",children:t.map(n=>{const d=n.template_type==="soundvision",i=!!n.read_only;return e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-md bg-accent/20 hover:bg-accent/30 transition-colors",onClick:p=>p.stopPropagation(),children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"text-sm font-medium flex items-center gap-2",children:[n.file_name,d&&e.jsx(oe,{variant:"outline",className:"text-[10px] font-semibold uppercase tracking-wide",children:"Template SoundVision File"}),["admin","management"].includes(s||"")&&e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded ${n.visible_to_tech?"bg-green-500/20 text-green-800 dark:text-green-200":"bg-muted text-muted-foreground"}`,children:n.visible_to_tech?"Tech-visible":"Hidden from tech"})]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Uploaded ",ce(new Date(n.uploaded_at),"MMM d, yyyy"),i&&e.jsx("span",{className:"ml-2 italic",children:"Read-only"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[["admin","management"].includes(s||"")&&e.jsxs("div",{className:"flex items-center gap-2 pr-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground select-none",children:"Tech can view"}),e.jsx(Ta,{checked:!!n.visible_to_tech,onCheckedChange:()=>o(n),disabled:i})]}),e.jsx(F,{variant:"ghost",size:"icon",onClick:()=>u(n),title:"View",children:e.jsx(cs,{className:"h-4 w-4"})}),e.jsx(F,{variant:"ghost",size:"icon",onClick:()=>l(n),title:"Download",children:e.jsx(ds,{className:"h-4 w-4"})}),["admin","management"].includes(s||"")&&!i&&e.jsx(F,{variant:"ghost",size:"icon",onClick:()=>r(n),title:"Delete",children:e.jsx(as,{className:"h-4 w-4"})})]})]},n.id)})})]})},Ot=({status:t,className:s})=>{if(!t)return null;const a=(u=>{switch(u){case"Tentativa":return{label:"Tentative",variant:"secondary",className:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200"};case"Confirmado":return{label:"Confirmed",variant:"default",className:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"};case"Completado":return{label:"Completed",variant:"default",className:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200"};case"Cancelado":return{label:"Cancelled",variant:"destructive",className:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"};default:return{label:u,variant:"outline",className:""}}})(t);return e.jsx(oe,{variant:a.variant,className:W(a.className,s),children:a.label})},Xt=[{value:"Tentativa",label:"Tentative"},{value:"Confirmado",label:"Confirmed"},{value:"Completado",label:"Completed"},{value:"Cancelado",label:"Cancelled"}],ln=({jobId:t,currentStatus:s,onStatusChange:r,disabled:a=!1})=>{const[u,l]=U.useState(!1),{toast:o}=et(),n=rs(),d=async i=>{var p,y,b,g;if(!(u||a)){l(!0),r==null||r(i);try{const{error:k}=await N.from("jobs").update({status:i}).eq("id",t);if(k)throw k;n.invalidateQueries({queryKey:["jobs"]}),n.invalidateQueries({queryKey:["optimized-jobs"]}),o({title:"Status updated",description:`Job status changed to ${(p=Xt.find(m=>m.value===i))==null?void 0:p.label}`});try{const m=i==="Confirmado"?"job.status.confirmed":i==="Cancelado"?"job.status.cancelled":"";m&&N.functions.invoke("push",{body:{action:"broadcast",type:m,job_id:t}})}catch{}const h=(m=>{switch(m){case"Tentativa":return"tentativa";case"Confirmado":return"confirmado";case"Cancelado":return"cancelado";default:return null}})(i);if(h)try{const{data:m,error:T}=await N.from("flex_folders").select("id, parent_id, department, folder_type").eq("job_id",t);if(!T&&m&&m.length>0){const w=m.find(M=>!M.parent_id&&String(M.folder_type||"").toLowerCase()==="main_event")||m.find(M=>!M.parent_id)||null;if(!w){o({title:"Flex sync warning",description:"Updated locally, but no Flex master folder was found to sync."});return}const{data:I,error:L}=await N.functions.invoke("apply-flex-status",{body:{folder_id:w.id,status:h,cascade:!0}});if(L||!(I!=null&&I.success)){const M=(I==null?void 0:I.error)||((y=I==null?void 0:I.response)==null?void 0:y.exceptionMessage)||((b=I==null?void 0:I.response)==null?void 0:b.primaryMessage)||((g=I==null?void 0:I.response)==null?void 0:g.message)||void 0;o({title:"Flex sync warning",description:M?`Updated locally, but Flex sync did not complete: ${M}`:"Updated locally, but Flex sync did not complete."})}else{const M=I==null?void 0:I.cascade,te=typeof(M==null?void 0:M.attempted)=="number"?M.attempted:null,de=typeof(M==null?void 0:M.succeeded)=="number"?M.succeeded:null,ne=typeof(M==null?void 0:M.failed)=="number"?M.failed:null;te!==null&&te>0?ne===0?o({title:"Flex synced",description:`Status synchronized with Flex (root + ${te} subfolder${te===1?"":"s"}).`}):typeof ne=="number"&&ne>0?o({title:"Flex sync warning",description:`Root synced, but only ${de??0}/${te} subfolders updated. Check Flex logs.`}):o({title:"Flex synced",description:"Status synchronized with Flex."}):o(te===0?{title:"Flex synced",description:"Status synchronized with Flex (root only; no subfolders found)."}:{title:"Flex synced",description:"Status synchronized with Flex."})}}}catch{}}catch{r==null||r(s),o({title:"Error",description:"Failed to update job status",variant:"destructive"})}finally{l(!1)}}};return a?e.jsx(Ot,{status:s}):e.jsxs(Aa,{children:[e.jsx(qa,{asChild:!0,children:e.jsxs(F,{variant:"ghost",size:"sm",disabled:u,className:"h-auto p-1 gap-1",onClick:i=>i.stopPropagation(),children:[e.jsx(Ot,{status:s}),e.jsx(gt,{className:"h-3 w-3"})]})}),e.jsx(Ma,{align:"end",className:"w-40",onClick:i=>i.stopPropagation(),children:Xt.map(i=>e.jsx(Oa,{onClick:p=>{p.stopPropagation(),d(i.value)},className:"gap-2",children:e.jsx(Ot,{status:i.value})},i.value))})]})},on=({job:t,collapsed:s,onToggleCollapse:r,appliedBorderColor:a,appliedBgColor:u,dateTypes:l,department:o,isProjectManagementPage:n=!1,userRole:d})=>{var b;const i=ss(),p=(g,k,c)=>{var T;const h=`${g}-${ce(k,"yyyy-MM-dd")}`;switch((T=c[h])==null?void 0:T.type){case"travel":return e.jsx(Pa,{className:"h-3 w-3 text-blue-500"});case"setup":return e.jsx(za,{className:"h-3 w-3 text-yellow-500"});case"show":return e.jsx($a,{className:"h-3 w-3 text-green-500"});case"off":return e.jsx(La,{className:"h-3 w-3 text-gray-500"});case"rehearsal":return e.jsx(Ua,{className:"h-3 w-3 text-violet-500"});default:return null}},y=g=>{switch(g){case"tour":return e.jsx(oe,{variant:"secondary",className:W("ml-2",i&&"text-xs"),children:"Tour"});case"single":return e.jsx(oe,{variant:"secondary",className:W("ml-2",i&&"text-xs"),children:"Single"});case"festival":return e.jsx(oe,{variant:"secondary",className:W("ml-2",i&&"text-xs"),children:"Festival"});case"tourdate":return e.jsx(oe,{variant:"secondary",className:W("ml-2",i&&"text-xs"),children:"Tour Date"});case"dryhire":return e.jsx(oe,{variant:"secondary",className:W("ml-2",i&&"text-xs"),children:"Dry Hire"});case"evento":return e.jsx(oe,{variant:"secondary",className:W("ml-2",i&&"text-xs"),children:"Evento"});default:return null}};return e.jsxs("div",{className:W("pb-3",i?"p-4":"p-6"),children:[e.jsxs("div",{className:W("flex items-start justify-between",i?"gap-2":"gap-4"),children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[p(t.id,new Date(t.start_time),l),e.jsx("h3",{className:W("font-medium break-words leading-tight",i?"text-base":"text-lg"),children:t.title}),y(t.job_type),t.invoicing_company&&e.jsx(oe,{variant:"outline",className:W("ml-2",i&&"text-xs"),children:t.invoicing_company}),n&&e.jsx(ln,{jobId:t.id,currentStatus:t.status,disabled:!["admin","management","logistics"].includes(d||"")})]})}),e.jsx(F,{variant:"ghost",size:"icon",onClick:r,title:"Toggle Details",className:W("hover:bg-accent/50 shrink-0",i&&"h-8 w-8"),children:s?e.jsx(gt,{className:"h-4 w-4"}):e.jsx(Js,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:W("space-y-2 text-sm",i?"mt-1.5":"mt-2"),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(os,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:W(i&&"text-xs"),children:[ce(new Date(t.start_time),i?"MMM d, yy":"MMM d, yyyy")," -"," ",ce(new Date(t.end_time),i?"MMM d, yy":"MMM d, yyyy")]}),e.jsx("span",{className:W("text-muted-foreground",i&&"text-xs"),children:ce(new Date(t.start_time),"HH:mm")})]})]}),((b=t.location)==null?void 0:b.name)&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ks,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsx("span",{className:W("font-medium line-clamp-2",i&&"text-xs"),children:t.location.name})]})]})]})},cn=({soundTasks:t,roleSummary:s=[]})=>{const r=()=>{if(!(t!=null&&t.length))return 0;const l=t.reduce((o,n)=>o+(n.progress||0),0);return Math.round(l/t.length)},a=()=>t!=null&&t.length?t.filter(l=>l.status==="completed").length:0,u=s.length>0;return!(t!=null&&t.length)&&!u?null:e.jsxs("div",{className:"space-y-4 mt-4",children:[u&&e.jsxs("div",{className:"mt-2 p-2 bg-accent/20 rounded-md",children:[e.jsx("div",{className:"text-xs font-medium mb-1",children:"Required Personnel"}),e.jsx("div",{className:"space-y-2 text-xs",children:s.map(l=>e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"font-medium",children:[l.department," â€” ",l.total_required||0]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:l.roles.map((o,n)=>e.jsxs(oe,{variant:"outline",className:"text-[11px]",children:[ns(o.role_code)," Ã— ",o.quantity]},`${o.role_code}-${n}`))})]},l.department))})]}),(t==null?void 0:t.length)>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[e.jsxs("span",{children:["Task Progress (",a(),"/",t.length," completed)"]}),e.jsxs("span",{children:[r(),"%"]})]}),e.jsx(Ha,{value:r(),className:"h-1"}),e.jsx("div",{className:"space-y-1",children:t.map(l=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{children:l.task_type}),e.jsxs("div",{className:"flex items-center gap-2",children:[l.assigned_to&&e.jsxs("span",{className:"text-muted-foreground",children:[l.assigned_to.first_name," ",l.assigned_to.last_name]}),e.jsx(oe,{variant:l.status==="completed"?"default":"secondary",children:l.status==="not_started"?"Not Started":l.status==="in_progress"?"In Progress":"Completed"})]})]},l.id))})]})]})};function dn({job:t,department:s,userRole:r,isProjectManagementPage:a,hideTasks:u,isHouseTech:l,isJobBeingDeleted:o,cardOpacity:n,pointerEvents:d,appliedBorderColor:i,appliedBgColor:p,collapsed:y,isSelected:b,toggleCollapse:g,handleJobCardClick:k,routeSheetOpen:c,setRouteSheetOpen:h,foldersAreCreated:m,isFoldersLoading:T,showUpload:w,canEditJobs:I,canCreateFlexFolders:L,canUploadDocuments:M,canManageArtists:te,isCreatingFolders:de,isCreatingLocalFolders:ne,techName:ke,assignments:C,jobTimesheets:re,documents:Y,docsCollapsed:B,setDocsCollapsed:he,handleDeleteDocument:ze,riderFiles:me,cardArtistNameMap:Ee,ridersCollapsed:P,setRidersCollapsed:Pe,viewRider:xe,downloadRider:He,soundTasks:Je,reqSummary:Te,requiredVsAssigned:Ke,setRequirementsDialogOpen:Se,refreshData:ge,handleEditButtonClick:ue,handleDeleteClick:Be,createFlexFoldersHandler:pe,addFlexFoldersHandler:tt,createLocalFoldersHandler:Ve,handleFestivalArtistsClick:Qe,handleFileUpload:We,syncStatusToFlex:Ae,transportButtonLabel:ye,transportButtonTone:st,handleTransportClick:G,handleCreateWhatsappGroup:Fe,waGroup:Ne,waRequest:Ge,setTaskManagerOpen:Ie,taskManagerOpen:Re,soundTaskDialogOpen:Ze,setSoundTaskDialogOpen:at,lightsTaskDialogOpen:qe,setLightsTaskDialogOpen:ve,videoTaskDialogOpen:Z,setVideoTaskDialogOpen:v,editJobDialogOpen:_,setEditJobDialogOpen:O,assignmentDialogOpen:j,setAssignmentDialogOpen:D,jobDetailsDialogOpen:R,setJobDetailsDialogOpen:J,flexLogDialogOpen:se,setFlexLogDialogOpen:X,transportDialogOpen:je,setTransportDialogOpen:Me,logisticsDialogOpen:Xe,setLogisticsDialogOpen:ut,selectedTransportRequest:ae,setSelectedTransportRequest:_t,logisticsInitialEventType:wt,setLogisticsInitialEventType:pt,isTechDept:nt,userDepartment:Ye,myTransportRequest:rt,allRequests:ft,queryClient:Oe,checkAndFulfillRequest:Nt,requirementsDialogOpen:ht,flexPickerOpen:jt,setFlexPickerOpen:bt,flexPickerOptions:Ct,handleFlexPickerConfirm:kt}){var be;return e.jsxs("div",{children:[e.jsxs(es,{className:W("mb-4 hover:shadow-md transition-all duration-200",!l&&!o&&"cursor-pointer",n,d,b&&"ring-2 ring-primary ring-offset-2 shadow-lg"),onClick:k,style:{borderLeftColor:i,borderLeftWidth:"4px",backgroundColor:p},children:[o&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center z-10 rounded",children:e.jsx("div",{className:"bg-white dark:bg-gray-800 px-4 py-2 rounded-md shadow-lg",children:e.jsx("span",{className:"text-sm font-medium",children:"Deleting job..."})})}),e.jsx(on,{job:t,collapsed:y,onToggleCollapse:g,appliedBorderColor:i,appliedBgColor:p,dateTypes:t.job_date_types||{},department:s,isProjectManagementPage:a,userRole:r}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[a&&t.job_type!=="dryhire"&&e.jsx("button",{type:"button",onClick:S=>{S.stopPropagation(),h(!0)},className:"text-xs px-3 py-1 border rounded-md hover:bg-secondary",title:"Abrir Hoja de Ruta",children:"Hoja de Ruta"}),t.job_type==="dryhire"&&e.jsx(oe,{variant:"destructive",children:"RECOGIDA CLIENTE"}),e.jsx("div",{className:"flex-1"})]}),e.jsx(an,{job:t,userRole:r||null,foldersAreCreated:m,folderStateLoading:T,isProjectManagementPage:a,isHouseTech:l,showUpload:w,canEditJobs:I,canCreateFlexFolders:L,canUploadDocuments:M,canManageArtists:te,department:s,isCreatingFolders:de,isCreatingLocalFolders:ne,techName:ke||"",onRefreshData:ge,onEditButtonClick:ue,onDeleteClick:Be,onCreateFlexFolders:pe,onAddFlexFolders:tt,onCreateLocalFolders:Ve,onFestivalArtistsClick:Qe,onAssignmentDialogOpen:S=>{S.stopPropagation(),o||D(!0)},handleFileUpload:We,onJobDetailsClick:()=>J(!0),onOpenTasks:S=>{S.stopPropagation(),Ie(!0)},canSyncFlex:["admin","management","logistics"].includes(r||""),onSyncFlex:Ae,onOpenFlexLogs:S=>{S.stopPropagation(),X(!0)},transportButtonLabel:t.job_type==="dryhire"?void 0:ye,transportButtonTone:st,onTransportClick:G,onCreateWhatsappGroup:Fe,whatsappDisabled:!!Ne||!!Ge})]}),t.job_type!=="dryhire"&&Array.isArray(t.job_departments)&&t.job_departments.length>0&&e.jsxs("div",{className:"px-6 mt-2 flex items-center justify-between",children:[e.jsx("div",{className:"flex gap-3 flex-wrap text-sm",children:t.job_departments.map(S=>{const V=S.department,De=Ke[V]||{required:0,assigned:0},it=De.required||0,lt=De.assigned||0,St=it===0?"bg-muted text-muted-foreground":lt>=it?"bg-green-500/20 text-green-700 dark:text-green-300":lt>0?"bg-yellow-500/20 text-yellow-700 dark:text-yellow-300":"bg-red-500/20 text-red-700 dark:text-red-300";return e.jsxs("div",{className:`px-2 py-1 rounded ${St}`,children:[e.jsx("span",{className:"capitalize",children:V}),": ",e.jsxs("span",{className:"tabular-nums",children:[lt,"/",it]})]},V)})}),["admin","management","logistics"].includes(r||"")&&e.jsx("button",{type:"button",className:"text-xs px-2 py-1 border rounded-md hover:bg-secondary",onClick:S=>{S.stopPropagation(),Se(!0)},children:"Edit requirements"})]}),e.jsxs("div",{className:"px-6 pb-6",children:[e.jsx("div",{className:"space-y-2 text-sm",children:t.job_type!=="dryhire"&&e.jsxs(e.Fragment,{children:[C.length>0&&e.jsx(nn,{assignments:C,department:s,jobTimesheets:re||[]}),Y.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("button",{type:"button",className:"w-full flex items-center justify-between text-left px-2 py-1 rounded hover:bg-accent/40",onClick:S=>{S.stopPropagation(),he(V=>!V)},children:[e.jsxs("span",{className:"text-sm font-medium",children:["Documents (",Y.length,")"]}),B?e.jsx(Zt,{className:"h-4 w-4"}):e.jsx(gt,{className:"h-4 w-4"})]}),!B&&e.jsx("div",{className:"mt-1",children:e.jsx(rn,{documents:Y,userRole:r,onDeleteDocument:(S,V)=>ze(S,V),showTitle:!1})})]}),me.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("button",{type:"button",className:"w-full flex items-center justify-between text-left px-2 py-1 rounded hover:bg-accent/40",onClick:S=>{S.stopPropagation(),Pe(V=>!V)},children:[e.jsxs("span",{className:"text-sm font-medium",children:["Artist Riders (",me.length,")"]}),P?e.jsx(Zt,{className:"h-4 w-4"}):e.jsx(gt,{className:"h-4 w-4"})]}),!P&&e.jsx("div",{className:"mt-1 space-y-2",children:me.map(S=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-md bg-accent/20 hover:bg-accent/30 transition-colors",onClick:V=>V.stopPropagation(),children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium",children:S.file_name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Artist: ",Ee.get(S.artist_id)||"Unknown"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"p-1 hover:bg-accent rounded",title:"View",onClick:()=>xe(S),children:e.jsx(cs,{className:"h-4 w-4"})}),e.jsx("button",{className:"p-1 hover:bg-accent rounded",title:"Download",onClick:()=>He(S),children:e.jsx(ds,{className:"h-4 w-4"})})]})]},S.id))})]})]})}),!y&&t.job_type!=="dryhire"&&!u&&e.jsx(cn,{soundTasks:Je,roleSummary:Te})]})]}),!l&&!o&&e.jsxs(e.Fragment,{children:[Re&&e.jsx(fa,{open:Re,onOpenChange:Ie,userRole:r,jobId:t.id}),Ze&&e.jsx(Ws,{open:Ze,onOpenChange:at,jobId:t.id}),qe&&e.jsx(Gs,{open:qe,onOpenChange:ve,jobId:t.id}),Z&&e.jsx(Rs,{open:Z,onOpenChange:v,jobId:t.id}),_&&e.jsx(ca,{open:_,onOpenChange:O,job:t}),j&&t.job_type!=="dryhire"&&e.jsx(ea,{isOpen:j,onClose:()=>D(!1),onAssignmentChange:()=>{},jobId:t.id,department:s}),e.jsx(ls,{open:R,onOpenChange:J,job:t,department:s}),e.jsx(la,{jobId:t.id,open:se,onOpenChange:X}),a&&e.jsx(Le,{open:c,onOpenChange:h,children:e.jsx($e,{className:"max-w-[96vw] w-[96vw] h-[96vh] p-0 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-auto",children:e.jsx(aa,{jobId:t.id})})})}),je&&nt&&Ye&&e.jsx(Ra,{open:je,onOpenChange:Me,jobId:t.id,department:Ye,requestId:(rt==null?void 0:rt.id)||null,onSubmitted:()=>{Oe.invalidateQueries({queryKey:["transport-request",t.id,Ye]}),Oe.invalidateQueries({queryKey:["transport-requests-all",t.id]})}}),je&&(Ye==="logistics"||(r==="management"||r==="admin")&&!nt)&&e.jsx(Le,{open:je,onOpenChange:Me,children:e.jsx($e,{className:"max-w-xl",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-lg font-semibold",children:"Transport Requests"}),ft.length===0?e.jsx("div",{className:"text-muted-foreground",children:"No pending requests for this job."}):e.jsx("div",{className:"space-y-2",children:ft.map(S=>e.jsxs("div",{className:"border rounded p-2 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium capitalize",children:S.department}),S.description&&e.jsx("div",{className:"text-sm",children:S.description}),S.note&&e.jsx("div",{className:"text-xs text-muted-foreground italic",children:S.note})]}),e.jsx("button",{className:"px-3 py-1 text-sm rounded border hover:bg-accent",onClick:async V=>{V.stopPropagation(),await N.from("transport_requests").update({status:"cancelled"}).eq("id",S.id),Oe.invalidateQueries({queryKey:["transport-requests-all",t.id]})},children:"Cancel Request"})]}),e.jsx("div",{className:"space-y-1",children:(S.items||[]).map(V=>e.jsxs("div",{className:"flex items-center justify-between pl-2",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:[V.transport_type.replace("_"," "),typeof V.leftover_space_meters=="number"&&e.jsxs("span",{className:"ml-2",children:["Â· Leftover: ",V.leftover_space_meters," m"]})]}),e.jsx("button",{className:"px-3 py-1 text-sm rounded border hover:bg-accent",onClick:De=>{De.stopPropagation(),_t({...S,selectedItem:V}),pt("load"),Me(!1),ut(!0)},children:"Create Event"})]},V.id))})]},S.id))})]})})}),Xe&&ae&&e.jsx(ma,{open:Xe,onOpenChange:S=>{ut(S),S||(Oe.invalidateQueries({queryKey:["logistics-events-for-job",t.id]}),Oe.invalidateQueries({queryKey:["today-logistics"]}))},selectedDate:new Date(t.start_time),initialJobId:t.id,initialDepartments:[ae.department],initialTransportType:(be=ae.selectedItem)==null?void 0:be.transport_type,initialEventType:wt,onCreated:S=>{ae!=null&&ae.id&&(ae!=null&&ae.department)&&Nt(ae.id,ae.department),pt(void 0)}}),ht&&e.jsx(da,{open:ht,onOpenChange:Se,jobId:t.id,departments:(t.job_departments||[]).map(S=>S.department)}),e.jsx(oa,{open:jt,onOpenChange:bt,onConfirm:kt,initialOptions:Ct})]})]})}function mn({job:t,department:s="sound"}){const{theme:r}=Bs(),a=is(i=>i.deletingJobs.has(t.id)),[u,l]=U.useState(!1),o=E.useMemo(()=>{const i=r==="dark",p=t.color||"#7E69AB";return i&&t.darkColor||p},[t.color,t.darkColor,r]),n=a?"opacity-50":"",d=a?"pointer-events-none":"";return e.jsx(Ga,{job:t,department:s,appliedBorderColor:o,isJobBeingDeleted:a,cardOpacity:n,pointerEvents:d,jobDetailsDialogOpen:u,setJobDetailsDialogOpen:l})}function un({job:t,onEditClick:s,onDeleteClick:r,onJobClick:a,showAssignments:u=!1,department:l="sound",userRole:o,onDeleteDocument:n,showUpload:d=!1,showManageArtists:i=!1,isProjectManagementPage:p=!1,hideTasks:y=!1,openHojaDeRuta:b=!1,onHojaDeRutaOpened:g}){const k=ts(),{toast:c}=et(),h=rs(),{addDeletingJob:m,removeDeletingJob:T,isDeletingJob:w}=is(),{selectJob:I,clearSelection:L,isJobSelected:M}=Vs(),te=M(t.id),[de,ne]=U.useState(!1),[ke,C]=U.useState(!1),[re,Y]=U.useState(!1),[B,he]=U.useState(!1),[ze,me]=U.useState(!1),[Ee,P]=U.useState(void 0),[Pe,xe]=U.useState("create"),[He,Je]=U.useState(!0),[Te,Ke]=U.useState(!0),Se=U.useRef(!1);U.useEffect(()=>{if(!b){Se.current=!1;return}p&&(Se.current||(Se.current=!0,ne(!0),g==null||g()))},[b,p,g]);const{data:ge=[]}=_e({queryKey:["jobcard-artists",t.id],enabled:!!(t!=null&&t.id)&&t.job_type==="festival",queryFn:async()=>{const{data:f,error:x}=await N.from("festival_artists").select("id, name").eq("job_id",t.id);if(x)throw x;return f||[]},staleTime:5*6e4}),ue=E.useMemo(()=>ge.map(f=>f.id),[ge]),Be=E.useMemo(()=>new Map(ge.map(f=>[f.id,f.name])),[ge]),{data:pe=[]}=_e({queryKey:["jobcard-rider-files",t.id,ue],enabled:!!(t!=null&&t.id)&&ue.length>0,queryFn:async()=>{let f=N.from("festival_artist_files").select("id, file_name, file_path, uploaded_at, artist_id").order("uploaded_at",{ascending:!1});if(ue.length===1)f=f.eq("artist_id",ue[0]);else{const q=ue.map(ee=>`artist_id.eq.${ee}`).join(",");f=f.or(q)}const{data:x,error:A}=await f;if(A)throw A;return x||[]}}),tt=async f=>{const{data:x}=await N.storage.from("festival_artist_files").createSignedUrl(f.file_path,3600);x!=null&&x.signedUrl&&window.open(x.signedUrl,"_blank","noopener")},Ve=async f=>{const{data:x}=await N.storage.from("festival_artist_files").download(f.file_path);if(!x)return;const A=window.URL.createObjectURL(x),q=document.createElement("a");q.href=A,q.download=f.file_name,document.body.appendChild(q),q.click(),document.body.removeChild(q),window.URL.revokeObjectURL(A)},[Qe,We]=U.useState(!1),[Ae,ye]=U.useState(!1),[st,G]=U.useState(!1),[Fe,Ne]=U.useState(!1),[Ge,Ie]=U.useState(!1),[Re,Ze]=U.useState(null),[at,qe]=U.useState(void 0),{user:ve,userDepartment:Z}=Qs(),{appliedBorderColor:v,appliedBgColor:_,collapsed:O,assignments:j,documents:D,reqSummary:R,requiredVsAssigned:J,soundTaskDialogOpen:se,lightsTaskDialogOpen:X,videoTaskDialogOpen:je,editJobDialogOpen:Me,assignmentDialogOpen:Xe,soundTasks:ut,isHouseTech:ae,canEditJobs:_t,canManageArtists:wt,canUploadDocuments:pt,canCreateFlexFolders:nt,toggleCollapse:Ye,handleEditButtonClick:rt,handleFileUpload:ft,handleDeleteDocument:Oe,refreshData:Nt,setSoundTaskDialogOpen:ht,setLightsTaskDialogOpen:jt,setVideoTaskDialogOpen:bt,setEditJobDialogOpen:Ct,setAssignmentDialogOpen:kt}=Zs(t,l,o,s,r,a,{enableRoleSummary:!0,enableSoundTasks:!y}),be=w(t.id),S=E.useMemo(()=>{const f=ve==null?void 0:ve.id;if(!f)return"";const x=(Array.isArray(j)?j:[]).find(q=>(q==null?void 0:q.technician_id)===f&&(q==null?void 0:q.profiles))||(Array.isArray(j)?j:[]).find(q=>q==null?void 0:q.profiles),A=x!=null&&x.profiles?Array.isArray(x.profiles)?x.profiles[0]:x.profiles:null;return A?[A.first_name,A.nickname,A.last_name].filter(Boolean).join(" ").trim():""},[j,ve==null?void 0:ve.id]),V=!!(t.flex_folders_created||t.flex_folders_exist),De=nt,it=De?t.id:"",lt=De?t.tour_date_id:null,{data:St,isLoading:ps}=Xs(it,lt),Pt=St===!0,fs=De?Pt:V,{data:Ft}=_e({queryKey:["transport-request",t.id,Z],queryFn:async()=>{if(!Z||!["sound","lights","video"].includes(Z))return null;const{data:f,error:x}=await N.from("transport_requests").select("id, department, status, note, description, created_at, items:transport_request_items(id, transport_type, leftover_space_meters)").eq("job_id",t.id).eq("department",Z).order("created_at",{ascending:!1}).limit(1).maybeSingle();return x?null:f},enabled:!!(t!=null&&t.id)&&!!Z}),{data:ot=[]}=_e({queryKey:["transport-requests-all",t.id],queryFn:async()=>{const{data:f,error:x}=await N.from("transport_requests").select("id, department, status, note, description, created_at, items:transport_request_items(id, transport_type, leftover_space_meters)").eq("job_id",t.id).eq("status","requested").order("created_at",{ascending:!1});return x?[]:f||[]},enabled:!!(t!=null&&t.id)&&(Z==="logistics"||["admin","management"].includes(o||""))}),{data:It=[]}=_e({queryKey:["logistics-events-for-job",t.id],queryFn:async()=>{const{data:f,error:x}=await N.from("logistics_events").select("id").eq("job_id",t.id);return x?[]:f||[]},enabled:!!(t!=null&&t.id)&&t.job_type!=="dryhire"}),Ht=((It==null?void 0:It.length)||0)>0,hs=!!Ft||Array.isArray(ot)&&ot.length>0,ct=!!Z&&["sound","lights","video"].includes(Z);E.useCallback(async f=>{if(!f)return;const{error:x}=await N.from("transport_requests").update({status:"cancelled"}).eq("id",f);if(x){c({title:"No se pudo cancelar",description:x.message||"Error cancelando la solicitud de transporte",variant:"destructive"});return}c({title:"Solicitud cancelada",description:"La solicitud de transporte se ha cancelado correctamente"}),h.invalidateQueries({queryKey:["transport-requests-all",t.id]})},[t.id,h,c]);const xs=(()=>{if(Ht)return"Transport Scheduled";if(Z==="logistics"||(o==="management"||o==="admin")&&!ct)return ot.length>0?`Requests (${ot.length})`:"Logistics";if(ct)return Ft?"Transport Requested":"Request Transport"})(),gs=Ht?"default":hs?"secondary":"outline",ys=f=>{f.stopPropagation(),(Z==="logistics"||(o==="management"||o==="admin")&&!ct||ct&&Z)&&G(!0)},{data:vs,refetch:Jt}=_e({queryKey:["job-whatsapp-group",t.id,l],enabled:!!(t!=null&&t.id)&&!!l&&(o==="management"||o==="admin"),queryFn:async()=>{const{data:f,error:x}=await N.from("job_whatsapp_groups").select("id, wa_group_id").eq("job_id",t.id).eq("department",l).maybeSingle();return x?null:f}}),{data:_s,refetch:Kt}=_e({queryKey:["job-whatsapp-group-request",t.id,l],enabled:!!(t!=null&&t.id)&&!!l&&(o==="management"||o==="admin"),queryFn:async()=>{const{data:f,error:x}=await N.from("job_whatsapp_group_requests").select("id, created_at").eq("job_id",t.id).eq("department",l).maybeSingle();return x?null:f}}),Dt=E.useMemo(()=>Array.isArray(j)&&j.some(f=>!!(f!=null&&f.technician_id)),[j]),{data:ws}=_e({queryKey:["job-timesheets-status",t.id],queryFn:async()=>{const{data:f,error:x}=await N.from("timesheets").select("technician_id, status").eq("job_id",t.id).eq("is_active",!0);if(x)throw x;return f},enabled:Dt&&t.job_type!=="dryhire"&&t.job_type!=="tourdate",staleTime:6e4});U.useEffect(()=>{if(!Dt||t.job_type==="dryhire"||t.job_type==="tourdate")return;const f=N.channel(`job-timesheets-${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"timesheets",filter:`job_id=eq.${t.id}`},()=>{h.invalidateQueries({queryKey:["job-timesheets-status",t.id]})}).subscribe();return()=>{N.removeChannel(f)}},[Dt,t.id,t.job_type,h]);const Ns=async f=>{var x,A,q,ee;if(f.stopPropagation(),o==="management"||o==="admin")try{const{data:ie}=await N.from("job_assignments").select("sound_role, lights_role, video_role, profiles!job_assignments_technician_id_fkey(first_name,last_name,phone)").eq("job_id",t.id),fe=l==="sound"?"sound_role":l==="lights"?"lights_role":"video_role",Ce=(ie||[]).filter(H=>!!H[fe]),Q=[];let K=0;for(const H of Ce){const le=Array.isArray(H.profiles)?H.profiles[0]:H.profiles,Ue=`${(le==null?void 0:le.first_name)??""} ${(le==null?void 0:le.last_name)??""}`.trim()||"TÃ©cnico";((le==null?void 0:le.phone)||"").trim()?K+=1:Q.push(Ue)}if(K===0){c({title:"Sin telÃ©fonos",description:"No hay telÃ©fonos vÃ¡lidos para el equipo asignado.",variant:"destructive"});return}if(Q.length>0&&!window.confirm(`Faltan telÃ©fonos para ${Q.length} tÃ©cnico(s):
- ${Q.slice(0,5).join(`
- `)}${Q.length>5?`
...`:""}

Â¿Crear el grupo igualmente?`))return;const{data:$,error:z}=await N.functions.invoke("create-whatsapp-group",{body:{job_id:t.id,department:l}});if(z)c({title:"Grupo solicitado",description:"Se ha solicitado la creaciÃ³n del grupo. El botÃ³n quedarÃ¡ bloqueado."});else{const H=$==null?void 0:$.warnings;c({title:$!=null&&$.wa_group_id?"Grupo creado":"Grupo solicitado",description:H&&((x=H.missing)!=null&&x.length||(A=H.invalid)!=null&&A.length)?`Avisos: sin telÃ©fono ${((q=H.missing)==null?void 0:q.length)||0}, invÃ¡lidos ${((ee=H.invalid)==null?void 0:ee.length)||0}`:($==null?void 0:$.note)||"OperaciÃ³n realizada."})}await Promise.all([Jt(),Kt()])}catch{await Promise.all([Jt(),Kt()]),c({title:"Grupo solicitado",description:"Se ha solicitado la creaciÃ³n del grupo. El botÃ³n quedarÃ¡ bloqueado."})}},js=async(f,x)=>{try{const{data:A}=await N.from("logistics_events").select("id, event_type, logistics_event_departments(department)").eq("job_id",t.id).eq("logistics_event_departments.department",x),q=!!(A!=null&&A.some(ie=>ie.event_type==="load")),ee=!!(A!=null&&A.some(ie=>ie.event_type==="unload"));q&&ee&&(await N.from("transport_requests").update({status:"fulfilled"}).eq("id",f),h.invalidateQueries({queryKey:["transport-request",t.id,x]}),h.invalidateQueries({queryKey:["transport-requests-all",t.id]}))}catch{}},bs=async f=>{var x,A,q;f.stopPropagation();try{const ie=(z=>{switch(z){case"Tentativa":return"tentativa";case"Confirmado":return"confirmado";case"Cancelado":return"cancelado";default:return null}})(t.status);if(!ie){c({title:"Not applicable",description:"Only Tentativa/Confirmado/Cancelado are synced to Flex."});return}const{data:fe,error:Ce}=await N.from("flex_folders").select("id, parent_id, department, folder_type").eq("job_id",t.id);if(Ce||!fe||fe.length===0){c({title:"No Flex folders",description:"Create Flex folders before syncing status.",variant:"destructive"});return}const Q=fe.find(z=>!z.parent_id&&String(z.folder_type||"").toLowerCase()==="main_event")||fe.find(z=>!z.parent_id)||null;if(!(Q!=null&&Q.id)){c({title:"Flex sync failed",description:"No Flex master folder found for this job.",variant:"destructive"});return}const{data:K,error:$}=await N.functions.invoke("apply-flex-status",{body:{folder_id:Q.id,status:ie,cascade:!0}});if($||!(K!=null&&K.success)){const z=(K==null?void 0:K.error)||((x=K==null?void 0:K.response)==null?void 0:x.exceptionMessage)||((A=K==null?void 0:K.response)==null?void 0:A.primaryMessage)||((q=K==null?void 0:K.response)==null?void 0:q.message)||void 0;c({title:"Flex sync failed",description:z||"See logs for details.",variant:"destructive"})}else{const z=K==null?void 0:K.cascade,H=typeof(z==null?void 0:z.attempted)=="number"?z.attempted:null,le=typeof(z==null?void 0:z.succeeded)=="number"?z.succeeded:null,Ue=typeof(z==null?void 0:z.failed)=="number"?z.failed:null;H!==null&&H>0?Ue===0?c({title:"Flex synced",description:`Status synchronized with Flex (root + ${H} subfolder${H===1?"":"s"}).`}):typeof Ue=="number"&&Ue>0?c({title:"Flex sync warning",description:`Root synced, but only ${le??0}/${H} subfolders updated. Check Flex logs.`}):c({title:"Flex synced",description:"Status synchronized with Flex."}):c(H===0?{title:"Flex synced",description:"Status synchronized with Flex (root only; no subfolders found)."}:{title:"Flex synced",description:"Status synchronized with Flex."})}}catch(ee){c({title:"Error",description:(ee==null?void 0:ee.message)||String(ee),variant:"destructive"})}},Cs=async f=>{if(f.stopPropagation(),!be){if(!["admin","management"].includes(o||"")){c({title:"Permission denied",description:"Only admin and management users can delete jobs",variant:"destructive"});return}if(window.confirm("Are you sure you want to delete this job? This action cannot be undone and will remove all related data."))try{m(t.id);const x=await Ys(t.id);if(x.success)c({title:"Job deleted",description:x.details||"The job has been removed and cleanup is running in background."}),r(t.id),await h.invalidateQueries({queryKey:["jobs"]}),await h.invalidateQueries({queryKey:["optimized-jobs"]});else throw new Error(x.error||"Unknown deletion error")}catch(x){c({title:"Error deleting job",description:x.message,variant:"destructive"})}finally{T(t.id)}}},ks=f=>{if(f.stopPropagation(),!re){if(t.job_type==="dryhire"){Bt(void 0,"create");return}if(Pt){xe("add"),me(!0);return}xe("create"),me(!0)}},Ss=f=>{f.stopPropagation(),!re&&t.job_type!=="dryhire"&&(xe("add"),me(!0))},Bt=async(f,x)=>{const A=x??Pe;P(f),me(!1);try{if(Y(!0),A==="create"){const{data:Q}=await N.from("flex_folders").select("id").eq("job_id",t.id).limit(1);if(Q&&Q.length>0){c({title:"Folders already exist",description:"Flex folders have already been created for this job.",variant:"destructive"});return}}const ee=new Date(t.start_time).toISOString().slice(2,10).replace(/-/g,""),ie=new Date(t.start_time).toISOString().split(".")[0]+".000Z",fe=new Date(t.end_time).toISOString().split(".")[0]+".000Z";c({title:A==="create"?"Creating folders...":"Adding folders...",description:A==="create"?"Setting up Flex folder structure for this job.":"Creating the selected Flex folders."}),await ta(t,ie,fe,ee,f);const{error:Ce}=await N.from("jobs").update({flex_folders_created:!0}).eq("id",t.id);try{N.functions.invoke("push",{body:{action:"broadcast",type:"flex.folders.created",job_id:t.id}})}catch{}c({title:A==="create"?"Success!":"Updated!",description:A==="create"?"Flex folders have been created successfully.":"Selected Flex folders have been added successfully."}),await Promise.all([h.invalidateQueries({queryKey:["jobs"]}),h.invalidateQueries({queryKey:["optimized-jobs"]}),h.invalidateQueries({queryKey:["folder-existence",t.id]}),h.invalidateQueries({queryKey:["folder-existence"]})])}catch(q){c({title:"Error",description:q.message||"Failed to create Flex folders",variant:"destructive"})}finally{Y(!1)}},Fs=async f=>{if(f.stopPropagation(),!B){if(!("showDirectoryPicker"in window)){c({title:"Not supported",description:"Your browser doesn't support local folder creation. Please use Chrome, Edge, or another Chromium-based browser.",variant:"destructive"});return}try{he(!0);const x=await window.showDirectoryPicker(),A=new Date(t.start_time),q=ce(A,"yyMMdd"),{name:ee,wasSanitized:ie}=sa(t.title,q),fe=await x.getDirectoryHandle(ee,{create:!0}),{data:{user:Ce}}=await N.auth.getUser();let Q=null;if(Ce){const{data:$}=await N.from("profiles").select("custom_folder_structure, role").eq("id",Ce.id).single();$&&($.role==="admin"||$.role==="management")&&$.custom_folder_structure&&(Q=$.custom_folder_structure)}if(Q||(Q=["CAD","QT","Material","DocumentaciÃ³n","Rentals","Compras","Rider","Predicciones"]),Array.isArray(Q)){for(const $ of Q)if(typeof $=="string"){const z=At($);await(await fe.getDirectoryHandle(z,{create:!0})).getDirectoryHandle("OLD",{create:!0})}else if($&&typeof $=="object"&&$.name){const z=At($.name),H=await fe.getDirectoryHandle(z,{create:!0});if($.subfolders&&Array.isArray($.subfolders))for(const le of $.subfolders){const Ue=At(le);await H.getDirectoryHandle(Ue,{create:!0})}else await H.getDirectoryHandle("OLD",{create:!0})}}c({title:"Success!",description:`${Ce&&Q!==null?"Custom":"Default"} folder structure created at "${ee}"`})}catch(x){if(x.name==="AbortError")return;c({title:"Error",description:x.message||"Failed to create local folder structure",variant:"destructive"})}finally{he(!1)}}},Is=f=>{if(!(ae||be)){if(f&&(f.ctrlKey||f.altKey||f.metaKey)){te?L():I({id:t.id,title:t.title,department:l,job_type:t.job_type,start_time:t.start_time,end_time:t.end_time,color:t.color});return}p||o!=="logistics"&&a&&a(t.id)}},Ds=f=>{f.stopPropagation(),!be&&k(`/festival-management/${t.id}`)},Es=be?"opacity-50":"",Ts=be?"pointer-events-none":"";return e.jsx(dn,{job:t,department:l,userRole:o,isProjectManagementPage:p,hideTasks:y,isHouseTech:ae,isJobBeingDeleted:be,cardOpacity:Es,pointerEvents:Ts,appliedBorderColor:v,appliedBgColor:_,collapsed:O,toggleCollapse:Ye,handleJobCardClick:Is,routeSheetOpen:de,setRouteSheetOpen:ne,foldersAreCreated:fs,isFoldersLoading:ps,showUpload:d,canEditJobs:_t,canCreateFlexFolders:nt,canUploadDocuments:pt,canManageArtists:wt,isCreatingFolders:re,isCreatingLocalFolders:B,techName:S,assignments:j,jobTimesheets:ws||[],documents:D,docsCollapsed:He,setDocsCollapsed:Je,handleDeleteDocument:Oe,riderFiles:pe,cardArtistNameMap:Be,ridersCollapsed:Te,setRidersCollapsed:Ke,viewRider:tt,downloadRider:Ve,soundTasks:ut,reqSummary:R,requiredVsAssigned:J,setRequirementsDialogOpen:Ie,refreshData:Nt,handleEditButtonClick:rt,handleDeleteClick:Cs,createFlexFoldersHandler:ks,addFlexFoldersHandler:Ss,createLocalFoldersHandler:Fs,handleFestivalArtistsClick:Ds,handleFileUpload:ft,syncStatusToFlex:bs,transportButtonLabel:xs,transportButtonTone:gs,handleTransportClick:ys,handleCreateWhatsappGroup:Ns,waGroup:vs,waRequest:_s,setTaskManagerOpen:C,taskManagerOpen:ke,soundTaskDialogOpen:se,setSoundTaskDialogOpen:ht,lightsTaskDialogOpen:X,setLightsTaskDialogOpen:jt,videoTaskDialogOpen:je,setVideoTaskDialogOpen:bt,editJobDialogOpen:Me,setEditJobDialogOpen:Ct,assignmentDialogOpen:Xe,setAssignmentDialogOpen:kt,jobDetailsDialogOpen:Qe,setJobDetailsDialogOpen:We,flexLogDialogOpen:Ae,setFlexLogDialogOpen:ye,transportDialogOpen:st,setTransportDialogOpen:G,logisticsDialogOpen:Fe,setLogisticsDialogOpen:Ne,selectedTransportRequest:Re,setSelectedTransportRequest:Ze,logisticsInitialEventType:at,setLogisticsInitialEventType:qe,isTechDept:ct,userDepartment:Z,myTransportRequest:Ft,allRequests:ot,queryClient:h,checkAndFulfillRequest:js,requirementsDialogOpen:Ge,flexPickerOpen:ze,setFlexPickerOpen:me,flexPickerOptions:Ee,handleFlexPickerConfirm:Bt,isSelected:te})}function nr(t){return t.detailsOnlyMode?e.jsx(mn,{...t}):e.jsx(un,{...t})}export{nr as J,Ot as a};
