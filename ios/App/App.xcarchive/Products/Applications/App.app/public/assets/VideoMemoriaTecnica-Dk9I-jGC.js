import{e as W,r as c,j as e,L as x,I as w,B as p,S as q,t as H,v as J,w as K,x as N,a as k,s as j}from"./index-NZ6jJLfQ.js";import{P as Q}from"./progress-C8XsV-Me.js";import{R as X,a as I}from"./radio-group-DzKNHD24.js";import{u as Y,F as M,a as Z}from"./useLogoOptions-BfwIlBcK.js";import{I as T}from"./image--Pql38nK.js";import{F as ee}from"./file-B1WzkXfC.js";import{D as ae}from"./download-C1rVE0-J.js";import{U as re}from"./upload-DF4rjO7T.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./index-hC3MxXep.js";import"./circle-CWxDyDxx.js";import"./logo-url-cache-eY6nfvu7.js";const se=()=>{var P;const{toast:i}=W(),[m,$]=c.useState(""),[v,b]=c.useState(!1),[D,o]=c.useState(0),[u,y]=c.useState(null),[S,L]=c.useState(null),[f,_]=c.useState("upload"),[h,G]=c.useState(null),{logoOptions:g,isLoading:E}=Y(),[F,R]=c.useState([{id:"material",title:"Listado de Material",file:null,landscape:!1},{id:"weight",title:"Informe de Pesos",file:null,landscape:!1},{id:"power",title:"Informe de Consumos",file:null,landscape:!1},{id:"pixel",title:"Pixel Map",file:null,landscape:!0}]),O=async a=>{if(!a.type.includes("image/")){i({title:"Error",description:"Solo se permiten archivos de imagen",variant:"destructive"});return}try{const r=URL.createObjectURL(a);y({file:a,url:r}),_("upload")}catch{i({title:"Error",description:"Error al procesar la imagen",variant:"destructive"})}},V=a=>{G(a),g.find(s=>s.value===a)&&y(null)},z=async(a,r)=>{if(!a.type.includes("pdf")){i({title:"Error",description:"Solo se permiten archivos PDF",variant:"destructive"});return}try{const s=URL.createObjectURL(a);R(t=>t.map(n=>n.id===r?{...n,file:{file:a,url:s}}:n))}catch{i({title:"Error",description:"Error al procesar el archivo",variant:"destructive"})}},C=async(a,r)=>{const{error:s,data:t}=await j.storage.from("video-memoria-tecnica").upload(r,a);if(s)throw s;const{data:{publicUrl:n}}=j.storage.from("video-memoria-tecnica").getPublicUrl(r);return n},B=async()=>{if(!m.trim()){i({title:"Error",description:"Por favor, ingrese el nombre del proyecto",variant:"destructive"});return}const a=F.filter(r=>r.file!==null);if(a.length===0){i({title:"Error",description:"Por favor, suba al menos un documento",variant:"destructive"});return}b(!0),o(0),L(null);try{let r=null;if(f==="upload"&&u)try{const l=`${m}/logo_${Date.now()}.${u.file.name.split(".").pop()}`;r=await C(u.file,l),o(10)}catch{i({title:"Warning",description:"No se pudo subir el logo, continuando sin él"})}else if(f==="existing"&&h){const l=g.find(d=>d.value===h);r=(l==null?void 0:l.url)||null,o(10)}const s={};for(let l=0;l<a.length;l++){const d=a[l];if(d.file)try{const U=`${m}/${d.id}_${Date.now()}.pdf`,A=await C(d.file.file,U);s[d.id]=A,o((l+1)/a.length*50)}catch{i({title:"Error",description:`Error al subir el documento ${d.title}`,variant:"destructive"});return}}o(60);const t=await j.functions.invoke("generate-video-memoria-tecnica",{body:{documentUrls:s,projectName:m,logoUrl:r}});if(t.error)throw new Error(t.error.message||"Error al generar la memoria técnica");o(80);const{error:n}=await j.from("video_memoria_tecnica_documents").insert({project_name:m,logo_url:r,material_list_url:s.material,weight_report_url:s.weight,power_report_url:s.power,pixel_map_url:s.pixel,final_document_url:t.data.url});if(n)throw n;o(100),L(t.data.url),i({title:"Éxito",description:"Memoria técnica generada correctamente"}),window.open(t.data.url,"_blank")}catch(r){i({title:"Error",description:r.message||"Error al generar la memoria técnica",variant:"destructive"})}finally{b(!1),o(0)}};return e.jsx("div",{className:"h-[calc(100vh-6rem)] overflow-y-auto",children:e.jsx("div",{className:"max-w-3xl mx-auto p-6 space-y-6",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Memoria Técnica de Video"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"projectName",children:"Nombre del Proyecto"}),e.jsx(w,{id:"projectName",value:m,onChange:a=>$(a.target.value),placeholder:"Ingrese el nombre del proyecto"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Logo"}),e.jsxs(X,{value:f,onValueChange:a=>_(a),className:"flex items-center space-x-6 mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(I,{value:"upload",id:"r-upload"}),e.jsx(x,{htmlFor:"r-upload",children:"Subir nuevo logo"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(I,{value:"existing",id:"r-existing"}),e.jsx(x,{htmlFor:"r-existing",children:"Usar logo existente"})]})]}),f==="upload"?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{type:"file",accept:"image/*",className:"hidden",id:"logo-upload",onChange:a=>{var s;const r=(s=a.target.files)==null?void 0:s[0];r&&O(r)}}),e.jsx(p,{variant:"outline",asChild:!0,className:"w-full",children:e.jsx("label",{htmlFor:"logo-upload",className:"cursor-pointer flex items-center justify-center gap-2",children:u?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"h-4 w-4"}),"Logo cargado"]}):e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-4 w-4"}),"Subir logo"]})})}),u&&e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>window.open(u.url,"_blank"),children:e.jsx(T,{className:"h-4 w-4"})})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs(q,{value:h||"",onValueChange:V,disabled:E,children:[e.jsx(H,{className:"w-full",children:e.jsx(J,{placeholder:"Selecciona un logo existente"})}),e.jsx(K,{children:E?e.jsxs(N,{value:"loading",disabled:!0,children:[e.jsx(k,{className:"h-4 w-4 animate-spin mr-2 inline"}),"Cargando logos..."]}):g.length>0?g.map(a=>e.jsx(N,{value:a.value,children:a.label},a.value)):e.jsx(N,{value:"none",disabled:!0,children:"No hay logos disponibles"})})]}),h&&e.jsx("div",{className:"flex justify-center p-2 bg-muted rounded-md",children:e.jsx("img",{src:((P=g.find(a=>a.value===h))==null?void 0:P.url)||"",alt:"Selected logo preview",width:192,height:64,loading:"lazy",decoding:"async",className:"h-16 w-48 object-contain",onError:a=>{a.target.src="/lovable-uploads/ce3ff31a-4cc5-43c8-b5bb-a4056d3735e4.png"}})})]})]}),e.jsx("div",{className:"space-y-4",children:F.map(a=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:a.title}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{type:"file",accept:".pdf",className:"hidden",id:`file-${a.id}`,onChange:r=>{var t;const s=(t=r.target.files)==null?void 0:t[0];s&&z(s,a.id)}}),e.jsx(p,{variant:"outline",asChild:!0,className:"w-full",children:e.jsx("label",{htmlFor:`file-${a.id}`,className:"cursor-pointer flex items-center justify-center gap-2",children:a.file?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"h-4 w-4"}),"Archivo cargado"]}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4"}),"Subir archivo"]})})}),a.file&&e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>{var r;return window.open((r=a.file)==null?void 0:r.url,"_blank")},children:e.jsx(ee,{className:"h-4 w-4"})})]})]},a.id))}),v&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{value:D}),e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"Generando memoria técnica..."})]}),S&&e.jsxs(p,{variant:"outline",className:"w-full",onClick:()=>window.open(S,"_blank"),children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Descargar Memoria Técnica"]}),e.jsx(p,{onClick:B,disabled:v,className:"w-full",children:v?e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"h-4 w-4 animate-spin mr-2"}),"Generando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Generar Memoria Técnica"]})})]})]})})})},fe=()=>e.jsx(se,{});export{fe as default};
