import{r as w,s as h,f as L,j as t,y as N,i as E,a0 as f,a as M}from"./index-NZ6jJLfQ.js";import{C as b,a as U,b as D,f as m}from"./context-menu-DYP7Nyzl.js";import{u as q}from"./useTableSubscription-Cu79jct8.js";import{F as S,o as T}from"./flexUuidService-C9yZjzP-.js";import{P as A}from"./plane-NSG-_bNT.js";import{W as K}from"./wrench-DzMvZxmF.js";import{S as O}from"./star-icpn3ybK.js";import{M as Q}from"./mic-l4q2dREA.js";import{M as $}from"./moon-Bp9lP4EQ.js";import{E as P}from"./external-link-QJoXZ6ES.js";const p=new Map,W=300*1e3,R=()=>{const[x,e]=w.useState({uuid:null,isLoading:!1,error:null,hasChecked:!1}),y=w.useCallback(async r=>{if(!r){e({uuid:null,isLoading:!1,error:null,hasChecked:!0});return}const u=p.get(r),s=Date.now();if(u&&s-u.timestamp<W){e({uuid:u.uuid,isLoading:!1,error:u.error,hasChecked:!0});return}e(c=>({...c,isLoading:!0,hasChecked:!0}));try{const{data:{user:c}}=await h.auth.getUser();if(!c){const d="User not authenticated";e({uuid:null,isLoading:!1,error:d,hasChecked:!0}),p.set(r,{uuid:null,error:d,timestamp:s});return}const{data:a,error:C}=await h.from("profiles").select("department").eq("id",c.id).single();if(C||!(a!=null&&a.department)){const d="Could not determine user department";e({uuid:null,isLoading:!1,error:d,hasChecked:!0}),p.set(r,{uuid:null,error:d,timestamp:s});return}const i=await S.getFlexUuid(r,a.department);e({uuid:i.uuid,isLoading:!1,error:i.error,hasChecked:!0}),p.set(r,{uuid:i.uuid,error:i.error,timestamp:s})}catch{const a="Failed to fetch flex UUID";e({uuid:null,isLoading:!1,error:a,hasChecked:!0}),p.set(r,{uuid:null,error:a,timestamp:s})}},[]),g=w.useCallback(()=>{e({uuid:null,isLoading:!1,error:null,hasChecked:!1})},[]);return{...x,fetchFlexUuid:y,reset:g}},ee=({children:x,jobId:e,date:y,onTypeChange:g})=>{const r=L(),{uuid:u,isLoading:s,error:c,hasChecked:a,fetchFlexUuid:C}=R();q("job_date_types");const i=async o=>{try{const k=N(y),n=E(k,"yyyy-MM-dd");r.setQueryData(["job-date-types",e],l=>{const _=`${e}-${n}`;return{...l,[_]:{type:o,job_id:e,date:n}}});const{error:j}=await h.from("job_date_types").upsert({job_id:e,date:n,type:o},{onConflict:"job_id,date"});if(j)throw j;if(o==="off"||o==="travel"){const{error:l}=await h.from("timesheets").update({is_active:!1}).eq("job_id",e).eq("date",n)}else{const{error:l}=await h.from("timesheets").update({is_active:!0}).eq("job_id",e).eq("date",n).eq("is_active",!1)}try{h.functions.invoke("push",{body:{action:"broadcast",type:`jobdate.type.changed.${o}`,job_id:e,target_date:n,single_day:!0,url:`/jobs/${e}`}})}catch{}r.invalidateQueries({predicate:l=>Array.isArray(l.queryKey)&&l.queryKey[0]==="date-types"}),f({title:"Success",description:`Date type set to ${o}`}),g()}catch{f({title:"Error",description:"Failed to set date type",variant:"destructive"}),r.invalidateQueries({queryKey:["job-date-types",e]}),r.invalidateQueries({predicate:n=>Array.isArray(n.queryKey)&&n.queryKey[0]==="date-types"})}},d=async()=>{if(!a){await C(e);return}if(s){f({title:"Loading",description:"Please wait while we load the Flex folder..."});return}u?await T({elementId:u,onError:o=>{f({title:"Error",description:o.message||"Failed to open Flex",variant:"destructive"})},onWarning:o=>{f({title:"Warning",description:o})}}):c?f({title:"Error",description:c,variant:"destructive"}):f({title:"Info",description:"Flex folder not available for this job"})},v=()=>a?s?"Loading Flex...":u?"Open Flex":"Flex":"Check Flex",F=()=>s?t.jsx(M,{className:"h-4 w-4 animate-spin"}):t.jsx(P,{className:"h-4 w-4"});return t.jsxs(b,{children:[t.jsx(U,{children:x}),t.jsxs(D,{collisionPadding:8,className:"w-48",alignOffset:-10,avoidCollisions:!0,children:[t.jsxs(m,{onClick:()=>i("travel"),className:"flex items-center gap-2",children:[t.jsx(A,{className:"h-4 w-4"})," Travel"]}),t.jsxs(m,{onClick:()=>i("setup"),className:"flex items-center gap-2",children:[t.jsx(K,{className:"h-4 w-4"})," Setup"]}),t.jsxs(m,{onClick:()=>i("show"),className:"flex items-center gap-2",children:[t.jsx(O,{className:"h-4 w-4"})," Show"]}),t.jsxs(m,{onClick:()=>i("rehearsal"),className:"flex items-center gap-2",children:[t.jsx(Q,{className:"h-4 w-4"})," Rehearsal"]}),t.jsxs(m,{onClick:()=>i("off"),className:"flex items-center gap-2",children:[t.jsx($,{className:"h-4 w-4"})," Off"]}),e&&t.jsxs(m,{onClick:d,className:"flex items-center gap-2",disabled:s,children:[F(),v()]})]})]})};export{ee as D,R as u};
