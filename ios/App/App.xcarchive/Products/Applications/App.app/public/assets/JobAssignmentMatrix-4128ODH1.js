import{l as Rt,f as pt,r as c,i as F,s as I,m as et,a4 as W,u as ws,e as Bs,aC as Es,j as e,B as Z,L as Ye,I as ht,S as jt,t as bt,v as vt,w as _t,x as mt,X as It,M as Ca,a2 as Ma,P as Sa,T as hs,J as ps,K as xs,O as gs,n as Ke,Q as Et,o as Bt,U as Ks,D as rt,q as nt,F as it,G as ot,aK as dt,aL as lt,p as As,aO as ka,aP as Ea,a as Kt,ac as Js,aQ as Da,y as ts,aR as Ta,R as ss}from"./index-NZ6jJLfQ.js";import{B as X}from"./badge-vNTKF5RD.js";import{S as kt}from"./switch-DUBpZhIC.js";import{u as He}from"./useQuery-kdg2pmgf.js";import{i as qa}from"./isWithinInterval-CV3kanO0.js";import{i as At}from"./isSameDay-m1OvdnsV.js";import{u as Ns}from"./useMutation-DluhVBs1.js";import{c as Dt}from"./technicianAvailability-gbYgVBKV.js";import{P as Nt,a as Ct,b as Mt}from"./popover-Dl-b1R8L.js";import{a as $a,C as wt}from"./calendar--BDVgnXu.js";import{M as Ra,U as Ds,C as Fa}from"./ManageSkillsDialog-wCDwgGaG.js";import{A as as,b as rs,a as ns}from"./avatar-QSp4LpEt.js";import{f as Qs}from"./userName-BCcvOtN-.js";import{C as Pa}from"./CityAutocomplete-D-A6C7rH.js";import{S as za}from"./square-pen-BMpSgZGa.js";import{S as Oa}from"./save-z_re-Mcq.js";import{B as La}from"./building-BdT03Y2e.js";import{M as Jt}from"./mail-1T3Omkp6.js";import{P as Ia}from"./phone-BlFwiuho.js";import{I as Ba}from"./id-card-oCs3SPbN.js";import{U as Ka}from"./user-E3OATBQk.js";import{P as Aa}from"./plus-C3JQqq7t.js";import{s as Ja,a as Qa}from"./startOfMonth-B5dVCv8B.js";import{e as Wa}from"./endOfMonth-Byhxb84j.js";import{e as Ts}from"./endOfYear-D08D-xBX.js";import{M as qs}from"./message-circle-Bh9rUoQO.js";import{C as Ws}from"./circle-check-big-CilmNGCn.js";import{U as Ua}from"./user-x-CkJG0NMy.js";import{C as ut}from"./calendar-_Cj_Sgy-.js";import{i as Us}from"./isToday-BbpdYtC3.js";import{i as Hs}from"./isWeekend-Du4Xt_tj.js";import{U as ys}from"./users-DMnpVLUq.js";import{C as $t}from"./clock-BXPvTWvY.js";import{e as Tt}from"./es-CSiFCUGj.js";import{R as Ha,a as $s}from"./radio-group-DzKNHD24.js";import{T as js,a as bs,b as qt,c as is}from"./tabs-BdaywI_b.js";import{C as Vs}from"./checkbox-BsRNEGV1.js";import{A as Va,a as Ya,b as Za,c as Ga,d as Xa,e as er,f as tr,g as sr}from"./alert-dialog-CtyYUxwH.js";import{C as ar}from"./calendar-days-DcwEz6pd.js";import{C as rr}from"./chevron-left-rq2ui83a.js";import{C as nr}from"./chevron-right-Bn7Eu0F7.js";import{R as ir}from"./rotate-ccw-DZI_fTg_.js";import{a as Ot}from"./endOfWeek-BYLwoWuZ.js";import{C as or,a as lr,b as cr,c as dr,d as ur}from"./command-D3uMBT-Z.js";import{F as vs}from"./filter-D0HnK7Nz.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./isSameMonth-BQ4F6s8O.js";import"./addMonths-j-Bb577B.js";import"./differenceInCalendarMonths-6exvViir.js";import"./subDays-D4REtaCB.js";import"./SignUpForm-BqJSq2KU.js";import"./alert-BqA-5jRM.js";import"./arrow-left-VpQwT4cv.js";import"./constructNow-u0VlpghF.js";import"./index-hC3MxXep.js";import"./circle-CWxDyDxx.js";import"./search-D-OiWg8h.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mr=Rt("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fr=Rt("Ban",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m4.9 4.9 14.2 14.2",key:"1m5liu"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rs=Rt("CalendarRange",[["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M16 2v4",key:"4m81vk"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M17 14h-6",key:"bkmgh3"}],["path",{d:"M13 18H7",key:"bb0bb7"}],["path",{d:"M7 14h.01",key:"1qa3f1"}],["path",{d:"M17 18h.01",key:"1bdyru"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fs=Rt("Medal",[["path",{d:"M7.21 15 2.66 7.14a2 2 0 0 1 .13-2.2L4.4 2.8A2 2 0 0 1 6 2h12a2 2 0 0 1 1.6.8l1.6 2.14a2 2 0 0 1 .14 2.2L16.79 15",key:"143lza"}],["path",{d:"M11 12 5.12 2.2",key:"qhuxz6"}],["path",{d:"m13 12 5.88-9.8",key:"hbye0f"}],["path",{d:"M8 7h8",key:"i86dvs"}],["circle",{cx:"12",cy:"17",r:"5",key:"qbz8iq"}],["path",{d:"M12 18v-2h-.5",key:"fawc4q"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yt=Rt("Refrigerator",[["path",{d:"M5 6a4 4 0 0 1 4-4h6a4 4 0 0 1 4 4v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6Z",key:"fpq118"}],["path",{d:"M5 10h14",key:"elsbfy"}],["path",{d:"M15 7v6",key:"1nx30x"}]]);function Ps(t,o){return $a(t,-1)}const hr=(t,o)=>{const s=new Map;return t.forEach(r=>{if(!r.job||!r.date)return;const m=`${r.technician_id}-${r.date}`;s.set(m,r)}),s},pr=async({jobIds:t,technicianIds:o,jobsById:s,startDate:r,endDate:m})=>{if(!t.length||!o.length)return[];const a=r?F(r,"yyyy-MM-dd"):null,d=m?F(m,"yyyy-MM-dd"):null,i=50,n=[];for(let x=0;x<t.length;x+=i){const q=t.slice(x,x+i);let k=I.from("timesheets").select("job_id, technician_id, date, is_schedule_only, source").eq("is_active",!0).in("job_id",q).in("technician_id",o).order("date",{ascending:!0}).limit(2e3);a&&(k=k.gte("date",a)),d&&(k=k.lte("date",d)),n.push(k)}const b=I.rpc("get_job_staffing_summary",{p_job_ids:t}),D=100,p=[];for(let x=0;x<t.length;x+=D){const q=t.slice(x,x+D);p.push(I.from("job_assignments").select("job_id, technician_id, sound_role, lights_role, video_role, single_day, assignment_date, status, assigned_at").in("job_id",q).in("technician_id",o))}const[l,u,...v]=await Promise.all([Promise.all(n),b,...p]),S=new Map;for(const x of v)x.error||(x.data||[]).forEach(q=>{S.set(`${q.job_id}:${q.technician_id}`,q)});const B=new Map;u.error||(u.data||[]).forEach(x=>{B.set(x.job_id,{assigned_count:x.assigned_count??0,worked_count:x.worked_count??0,total_cost_eur:x.total_cost_eur??0,approved_cost_eur:x.approved_cost_eur??0})});const K=[];return l.forEach(x=>{x.error||(x.data||[]).forEach(q=>{const k=s.get(q.job_id);if(!k)return;const g=S.get(`${q.job_id}:${q.technician_id}`),_=B.get(q.job_id);K.push({job_id:q.job_id,technician_id:q.technician_id,date:q.date,job:{...k,assigned_count:_==null?void 0:_.assigned_count,worked_count:_==null?void 0:_.worked_count,total_cost_eur:_==null?void 0:_.total_cost_eur,approved_cost_eur:_==null?void 0:_.approved_cost_eur},status:(g==null?void 0:g.status)??null,assigned_at:(g==null?void 0:g.assigned_at)??null,single_day:(g==null?void 0:g.single_day)??!!(g!=null&&g.assignment_date),assignment_date:(g==null?void 0:g.assignment_date)??null,sound_role:(g==null?void 0:g.sound_role)??null,lights_role:(g==null?void 0:g.lights_role)??null,video_role:(g==null?void 0:g.video_role)??null,is_schedule_only:q.is_schedule_only??null,source:q.source??null})})}),K},xr=({technicians:t,dates:o,jobs:s})=>{const r=pt(),m=c.useMemo(()=>s.map(_=>_.id),[s]),a=c.useMemo(()=>{const _=new Map;for(const N of s)_.set(N.id,N);return _},[s]),d=c.useMemo(()=>t.map(_=>_.id),[t]),i=c.useMemo(()=>({start:o[0],end:o[o.length-1]}),[o]),{data:n=[],isLoading:b,isFetching:D}=He({queryKey:["optimized-matrix-assignments",m,d,F(i.start,"yyyy-MM-dd"),F(i.end,"yyyy-MM-dd")],queryFn:async()=>{if(m.length===0||d.length===0)return[];try{return await pr({jobIds:m,technicianIds:d,jobsById:a,startDate:i.start,endDate:i.end})}catch{return[]}},enabled:m.length>0&&d.length>0&&!!i.start&&!!i.end,staleTime:30*1e3,gcTime:120*1e3,refetchOnWindowFocus:!1,placeholderData:_=>_}),{data:p=[],isLoading:l,isFetching:u}=He({queryKey:["optimized-matrix-availability",d,F(i.start,"yyyy-MM-dd"),F(i.end,"yyyy-MM-dd")],queryFn:async()=>{if(d.length===0||!i.start||!i.end)return[];const _=100,N=[];for(let G=0;G<d.length;G+=_)N.push(d.slice(G,G+_));const O=F(i.start,"yyyy-MM-dd"),$=F(i.end,"yyyy-MM-dd"),J=new Map,Y=new Date(i.start);Y.setHours(0,0,0,0);const Pe=new Date(i.end);Pe.setHours(0,0,0,0);const ge=async(G,he,A=3)=>{if(G.length===0)return[];const te=[];let me=0;const ie=Array.from({length:Math.min(A,G.length)},async()=>{for(;me<G.length;){const qe=me++,ze=G[qe],Re=await he(ze);te.push(...Re)}});return await Promise.all(ie),te};(await ge(N,async G=>{const{data:he,error:A}=await I.from("availability_schedules").select("user_id, date, status, notes, source").in("user_id",G).gte("date",O).lte("date",$).or("status.eq.unavailable,source.eq.vacation");if(A)throw A;return he||[]},3)).forEach(G=>{const he=`${G.user_id}-${G.date}`;if(!J.has(he))J.set(he,{user_id:G.user_id,date:G.date,status:"unavailable",notes:G.notes||void 0});else{const A=J.get(he);!A.notes&&G.notes&&J.set(he,{...A,notes:G.notes})}});try{(await ge(N,async he=>{const{data:A,error:te}=await I.from("technician_availability").select("technician_id, date, status").in("technician_id",he).gte("date",O).lte("date",$).in("status",["vacation","travel","sick","day_off"]);if(te)throw te;return A||[]},3)).forEach(he=>{const A=`${he.technician_id}-${he.date}`;J.has(A)||J.set(A,{user_id:he.technician_id,date:he.date,status:"unavailable"})})}catch(G){if((G==null?void 0:G.code)!=="42P01")throw G}try{const he=[];for(let te=0;te<d.length;te+=100)he.push(d.slice(te,te+100));(await ge(he,async te=>{const{data:me,error:ie}=await I.from("vacation_requests").select("technician_id, start_date, end_date, status").eq("status","approved").in("technician_id",te).lte("start_date",$).gte("end_date",O);if(ie)throw ie;return me||[]},3)).forEach(te=>{const me=new Date(te.start_date),ie=new Date(te.end_date),qe=new Date(Math.max(Y.getTime(),new Date(me.getFullYear(),me.getMonth(),me.getDate()).getTime())),ze=new Date(Math.min(Pe.getTime(),new Date(ie.getFullYear(),ie.getMonth(),ie.getDate()).getTime()));for(let Re=new Date(qe);Re.getTime()<=ze.getTime();Re.setDate(Re.getDate()+1)){const Fe=`${te.technician_id}-${F(Re,"yyyy-MM-dd")}`;J.has(Fe)||J.set(Fe,{user_id:te.technician_id,date:F(Re,"yyyy-MM-dd"),status:"unavailable"})}})}catch(G){if(G!=null&&G.code&&G.code!=="42P01")throw G}return Array.from(J.values())},enabled:d.length>0&&!!i.start&&!!i.end,staleTime:60*1e3,gcTime:600*1e3,placeholderData:_=>_});c.useEffect(()=>{if(!d.length)return;const _=I.channel("rt-availability-schedules").on("postgres_changes",{event:"*",schema:"public",table:"availability_schedules"},()=>{r.invalidateQueries({queryKey:["optimized-matrix-availability"]})}).subscribe(),N=I.channel("rt-technician-availability").on("postgres_changes",{event:"*",schema:"public",table:"technician_availability"},()=>{r.invalidateQueries({queryKey:["optimized-matrix-availability"]})}).subscribe(),O=I.channel("rt-vacation-requests").on("postgres_changes",{event:"*",schema:"public",table:"vacation_requests"},()=>{r.invalidateQueries({queryKey:["optimized-matrix-availability"]})}).subscribe();return()=>{try{I.removeChannel(_)}catch{}try{I.removeChannel(N)}catch{}try{I.removeChannel(O)}catch{}}},[r,d.length]);const v=async _=>{await r.prefetchQuery({queryKey:["technician",_],queryFn:async()=>{const{data:N,error:O}=await I.from("profiles").select("first_name, nickname, last_name, department, profile_picture_url").eq("id",_).single();if(O)throw O;return N},staleTime:120*1e3})},S=c.useMemo(()=>{const _=hr(n);return(N,O)=>{const $=`${N}-${F(O,"yyyy-MM-dd")}`;return _.get($)}},[n,o]),B=c.useMemo(()=>{const _=new Map;return p.forEach(N=>{const O=`${N.user_id}-${N.date}`;_.set(O,N)}),(N,O)=>{const $=`${N}-${F(O,"yyyy-MM-dd")}`;return _.get($)}},[p]),K=c.useMemo(()=>{const _=new Map;return o.forEach(N=>{const O=s.filter($=>{const J=new Date($.start_time),Y=new Date($.end_time);return qa(N,{start:J,end:Y})||At(N,J)||At(N,Y)});_.set(F(N,"yyyy-MM-dd"),O)}),N=>_.get(F(N,"yyyy-MM-dd"))||[]},[s,o]),x=(_,N,O)=>{r.setQueriesData({queryKey:["optimized-matrix-assignments"]},$=>{if(!$)return $;try{return $.map(J=>J.technician_id===_&&J.job_id===N?{...J,status:O,response_time:new Date().toISOString()}:J)}catch{return $}})},q=c.useCallback(async()=>{await Promise.all([r.invalidateQueries({queryKey:["optimized-matrix-assignments"]}),r.invalidateQueries({queryKey:["matrix-assignments"]}),r.invalidateQueries({queryKey:["job-assignments"]}),r.invalidateQueries({queryKey:["optimized-jobs"]}),r.invalidateQueries({queryKey:["jobs"]})])},[r]);return c.useEffect(()=>{const _=I.channel("matrix-job-assignments").on("postgres_changes",{event:"*",schema:"public",table:"job_assignments"},N=>{q()}).subscribe(N=>{});return()=>{I.removeChannel(_)}},[q]),c.useEffect(()=>{const _=I.channel("matrix-timesheets").on("postgres_changes",{event:"*",schema:"public",table:"timesheets"},()=>{r.invalidateQueries({queryKey:["optimized-matrix-assignments"]})}).subscribe(N=>{});return()=>{I.removeChannel(_)}},[r]),{allAssignments:n,availabilityData:p,isInitialLoading:b||l,isFetching:D||u,getAssignmentForCell:S,getAvailabilityForCell:B,getJobsForDate:K,prefetchTechnicianData:v,updateAssignmentOptimistically:x,invalidateAssignmentQueries:q}},gr=t=>{const[o,s]=c.useState({renderTime:0,queryTime:0,cellRenderCount:0}),r=c.useRef(0),m=c.useRef(0),a=c.useRef(0),d=c.useCallback(()=>{r.current=performance.now()},[]),i=c.useCallback(()=>{if(r.current){const l=performance.now()-r.current;s(u=>({...u,renderTime:l}))}},[t]),n=c.useCallback(()=>{m.current=performance.now()},[]),b=c.useCallback(()=>{if(m.current){const l=performance.now()-m.current;s(u=>({...u,queryTime:l}))}},[t]),D=c.useCallback(()=>{a.current+=1,a.current%5e3===0&&s(l=>({...l,cellRenderCount:a.current}))},[t]),p=c.useCallback(()=>{if("memory"in performance){const u=performance.memory.usedJSHeapSize/1024/1024;s(v=>({...v,memoryUsage:u}))}},[t]);return c.useEffect(()=>{const l=setInterval(p,5e3);return()=>clearInterval(l)},[p]),{metrics:o,startRenderTimer:d,endRenderTimer:i,startQueryTimer:n,endQueryTimer:b,incrementCellRender:D,measureMemoryUsage:p}};function yr(){const t=pt();c.useEffect(()=>{const o=et.channel("staffing-requests").on("postgres_changes",{event:"*",schema:"public",table:"staffing_requests"},a=>{m(a)}).subscribe(),s=et.channel("staffing-events").on("postgres_changes",{event:"*",schema:"public",table:"staffing_events"},a=>{m(a)}).subscribe(),r=et.channel("activity-log-staffing").on("postgres_changes",{event:"*",schema:"public",table:"activity_log"},a=>{try{const d=a.new||a.old,i=(d==null?void 0:d.code)||"";typeof i=="string"&&i.startsWith("staffing.")&&(t.invalidateQueries({queryKey:["staffing"]}),t.invalidateQueries({queryKey:["staffing-by-date"]}),t.invalidateQueries({queryKey:["staffing-matrix"]}),t.invalidateQueries({queryKey:["optimized-matrix-assignments"]}))}catch{}}).subscribe();async function m(a){const d=a.new||a.old;let i=null,n=null;if(d&&typeof d=="object"){if("job_id"in d&&"profile_id"in d)i=d.job_id,n=d.profile_id;else if("staffing_request_id"in d)try{const{data:b}=await et.from("staffing_requests").select("job_id, profile_id").eq("id",d.staffing_request_id).single();b&&(i=b.job_id,n=b.profile_id)}catch{}i&&n&&(t.invalidateQueries({queryKey:["staffing",i,n]}),t.invalidateQueries({queryKey:["staffing-by-date",n]}))}t.invalidateQueries({queryKey:["assignment-matrix"]}),t.invalidateQueries({queryKey:["optimized-matrix-assignments"]}),t.invalidateQueries({queryKey:["staffing-matrix"]})}return()=>{et.removeChannel(o),et.removeChannel(s),et.removeChannel(r)}},[t])}class Ys extends Error{constructor(o,s){super(o),this.details=s,this.name="ConflictError"}}function Zs(){const t=pt();return Ns({mutationFn:async o=>{var b,D,p,l;const r=(b=(await et.auth.getSession()).data.session)==null?void 0:b.access_token,m="https://syldobdcdsgfgjtbuwxm.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5bGRvYmRjZHNnZmdqdGJ1d3htIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU5NDE1ODcsImV4cCI6MjA1MTUxNzU4N30.iLtE6_xC0FE21JKzy77UPAvferh4l1WeLvvVCn15YJc",d=`${m}/functions/v1/send-staffing-email`,i=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`,apikey:a},body:JSON.stringify(o)}),n=await i.json();if(i.status===409&&((D=n.details)!=null&&D.conflict_type||(p=n.details)!=null&&p.conflicts||(l=n.details)!=null&&l.unavailability))throw new Ys(n.error||"Conflict detected",n.details);if(!i.ok)throw new Error(n.error||`HTTP ${i.status}: ${i.statusText}`);if(n!=null&&n.error)throw new Error(n.error);return n},onSuccess:(o,s)=>{t.invalidateQueries({queryKey:["staffing",s.job_id,s.profile_id]}),t.invalidateQueries({queryKey:["staffing-by-date",s.profile_id]}),t.invalidateQueries({queryKey:["staffing-matrix"]}),t.invalidateQueries({queryKey:["assignment-matrix"]}),t.invalidateQueries({queryKey:["optimized-matrix-assignments"]});try{window.dispatchEvent(new CustomEvent("staffing-updated"))}catch{}try{const r=s.phase==="availability"?"staffing.availability.sent":"staffing.offer.sent";et.functions.invoke("push",{body:{action:"broadcast",type:r,job_id:s.job_id,recipient_id:s.profile_id,channel:s.channel||"email"}})}catch{}}})}function Gs(){const t=pt();return Ns({mutationFn:async o=>{const{error:s}=await et.from("staffing_requests").update({status:"expired"}).eq("job_id",o.job_id).eq("profile_id",o.profile_id).eq("phase",o.phase).eq("status","pending");if(s)throw s;try{et.functions.invoke("notify-staffing-cancellation",{body:o}).catch(()=>{})}catch{}return!0},onSuccess:(o,s)=>{t.invalidateQueries({queryKey:["staffing",s.job_id,s.profile_id]}),t.invalidateQueries({queryKey:["staffing-by-date",s.profile_id]}),t.invalidateQueries({queryKey:["staffing-matrix"]}),t.invalidateQueries({queryKey:["optimized-matrix-assignments"]});try{window.dispatchEvent(new CustomEvent("staffing-updated"))}catch{}try{const r=s.phase==="availability"?"staffing.availability.cancelled":"staffing.offer.cancelled";et.functions.invoke("push",{body:{action:"broadcast",type:r,job_id:s.job_id,recipient_id:s.profile_id}})}catch{}}})}function jr(t,o,s){var r,m;return He({queryKey:["staffing-matrix",t,o.map(a=>a.id),(r=s[0])==null?void 0:r.toISOString(),(m=s[s.length-1])==null?void 0:m.toISOString()],queryFn:async()=>{if(!t.length||!o.length||!s.length)return{byJob:new Map,byDate:new Map};const a=o.map(l=>l.id),d=(l,u)=>{const v=[];for(let S=0;S<l.length;S+=u)v.push(l.slice(S,S+u));return v},i=new Map;try{const l=d(t,20),u=d(a,20),v=[];for(const B of l)for(const K of u)v.push(Promise.resolve(et.rpc("get_assignment_matrix_staffing").in("job_id",K).in("profile_id",B)));(await Promise.all(v)).forEach(B=>{B.error||(B.data||[]).forEach(K=>{const x=`${K.job_id}-${K.profile_id}`,q=g=>g?g==="pending"?"requested":g==="expired"?null:g:null,k=g=>g?g==="pending"?"sent":g==="expired"?null:g:null;i.set(x,{availability_status:q(K.availability_status),offer_status:k(K.offer_status)})})})}catch{}const n=[];try{const l=d(t,20),u=d(a,20),v=[];for(const B of l)for(const K of u)v.push(Promise.resolve(et.from("staffing_requests").select("job_id, profile_id, phase, status, updated_at, single_day, target_date").in("profile_id",B).in("job_id",K)));(await Promise.all(v)).forEach(B=>{var K;B.error||(K=B.data)!=null&&K.length&&n.push(...B.data)})}catch{}const b=new Map;o.forEach(l=>{const u=l.start_time?new Date(l.start_time):new Date,v=l.end_time?new Date(l.end_time):new Date;b.set(l.id,{id:l.id,start:u,end:v})});const D=new Map;(n||[]).forEach(l=>{const u=D.get(l.profile_id)||[];u.push(l),D.set(l.profile_id,u)});const p=new Map;return t.forEach(l=>{const u=D.get(l)||[];s.forEach(v=>{const S=F(v,"yyyy-MM-dd"),B=u.filter(x=>{if(x.single_day&&x.target_date)return(typeof x.target_date=="string"?x.target_date:F(x.target_date,"yyyy-MM-dd"))===S;if(!x.single_day){const q=b.get(x.job_id);if(!q)return!1;const k=new Date(v);k.setHours(0,0,0,0);const g=new Date(q.start);g.setHours(0,0,0,0);const _=new Date(q.end);return _.setHours(0,0,0,0),k>=g&&k<=_}return!1});if(!B.length)return;const K=B.reduce((x,q)=>{const k=q.updated_at?new Date(q.updated_at).getTime():0;if(q.phase==="availability"){const g=x.availability_updated_at||0;if(k>g){const _=q.status==="pending"?"requested":q.status==="expired"?null:q.status;x.availability_status=_,x.availability_updated_at=k,x.availability_job_id=q.job_id}}else if(q.phase==="offer"){const g=x.offer_updated_at||0;if(k>g){const _=q.status==="pending"?"sent":q.status==="expired"?null:q.status;x.offer_status=_,x.offer_updated_at=k,x.offer_job_id=q.job_id}}return x},{availability_status:null,offer_status:null,availability_updated_at:0,offer_updated_at:0,availability_job_id:null,offer_job_id:null});(K.availability_status||K.offer_status)&&p.set(`${l}-${S}`,{availability_status:K.availability_status,offer_status:K.offer_status,availability_job_id:K.availability_job_id,offer_job_id:K.offer_job_id})})}),{byJob:i,byDate:p}},staleTime:1500,gcTime:300*1e3,refetchOnWindowFocus:!1,placeholderData:a=>a})}function br(t,o){let s=null,r=null,m=0;const a=i=>{m=Date.now(),t(...i)},d=((...i)=>{const n=Date.now(),b=o-(n-m);b<=0?(s&&(clearTimeout(s),s=null),a(i)):(r=i,s||(s=setTimeout(()=>{s=null,r&&(a(r),r=null)},b)))});return d.cancel=()=>{s&&(clearTimeout(s),s=null),r=null},d}const vr=({technician:t,height:o,isFridge:s=!1,compact:r=!1,medalRank:m,lastYearMedalRank:a})=>{var We,oe,Le;const{userRole:d}=ws(),i=d==="admin",n=["admin","management"].includes(d||""),[b,D]=W.useState(!1),[p,l]=W.useState(!1),u=pt(),[v,S]=W.useState(!1),[B,K]=W.useState(!1),[x,q]=W.useState(!1),[k,g]=W.useState({monthTotal:0,yearTotal:0,lastYearTotal:0,monthUpcoming:0,yearUpcoming:0,lastYearUpcoming:0}),[_,N]=W.useState(null),[O,$]=W.useState(!1),[J,Y]=W.useState(!1),{toast:Pe}=Bs(),[ge,Ie]=W.useState(!1),[G,he]=W.useState(!1),[A,te]=W.useState({first_name:t.first_name,nickname:t.nickname||"",last_name:t.last_name,email:t.email,phone:t.phone||"",dni:t.dni||"",department:t.department,role:t.role,residencia:_||"",bg_color:t.bg_color||""}),me=W.useCallback(async()=>{try{K(!0);const T=new Date,U=Ps(T,1),pe=Ja(T).toISOString().split("T")[0],re=Wa(T).toISOString().split("T")[0],ye=Es(T).toISOString().split("T")[0],Se=Ts(T).toISOString().split("T")[0],V=Es(U).toISOString().split("T")[0],ke=Ts(U).toISOString().split("T")[0],Te=async(ue,fe)=>{const{count:ee,error:Ee}=await I.from("timesheets").select("*",{count:"exact",head:!0}).eq("technician_id",t.id).eq("is_active",!0).gte("date",ue).lte("date",fe);return Ee?0:ee||0},P=async(ue,fe)=>{const{count:ee,error:Ee}=await I.from("timesheets").select("*",{count:"exact",head:!0}).eq("technician_id",t.id).eq("is_active",!0).eq("status","draft").gte("date",ue).lte("date",fe);return Ee?0:ee||0},[ne,Ze,Ce,Xe,h,de]=await Promise.all([Te(pe,re),Te(ye,Se),Te(V,ke),P(pe,re),P(ye,Se),P(V,ke)]);g({monthTotal:ne,yearTotal:Ze,lastYearTotal:Ce,monthUpcoming:Xe,yearUpcoming:h,lastYearUpcoming:de})}finally{K(!1)}},[t.id]),ie=W.useCallback(async()=>{try{$(!0);const{data:T,error:U}=await I.from("profiles").select("residencia").eq("id",t.id).single();if(!U){const pe=(T==null?void 0:T.residencia)??null;N(pe),te(re=>({...re,residencia:pe||""}))}}finally{$(!1)}},[t.id]),qe=async()=>{try{he(!0);const{error:T}=await I.from("profiles").update({first_name:A.first_name,nickname:A.nickname||null,last_name:A.last_name,email:A.email,phone:A.phone||null,dni:A.dni||null,department:A.department,role:A.role,residencia:A.residencia||null,bg_color:A.bg_color||null}).eq("id",t.id);if(T)throw T;N(A.residencia||null),await u.invalidateQueries({queryKey:["optimized-matrix-technicians"]}),Pe({title:"Usuario actualizado",description:"Cambios guardados correctamente."}),Ie(!1)}catch(T){Pe({title:"Error al actualizar usuario",description:(T==null?void 0:T.message)||"Error desconocido",variant:"destructive"})}finally{he(!1)}},ze=()=>{te({first_name:t.first_name,nickname:t.nickname||"",last_name:t.last_name,email:t.email,phone:t.phone||"",dni:t.dni||"",department:t.department,role:t.role,residencia:_||"",bg_color:t.bg_color||""}),Ie(!0)},Re=()=>{te({first_name:t.first_name,nickname:t.nickname||"",last_name:t.last_name,email:t.email,phone:t.phone||"",dni:t.dni||"",department:t.department,role:t.role,residencia:_||"",bg_color:t.bg_color||""}),Ie(!1)},Fe=T=>{T||u.invalidateQueries({queryKey:["optimized-matrix-technicians"]}),D(T)},Je=T=>{l(T),T&&(me(),_===null&&ie())},w=async()=>{try{S(!0);const T=!s,{error:U}=await I.from("technician_fridge").upsert({technician_id:t.id,in_fridge:T},{onConflict:"technician_id"});if(U)throw U;await u.invalidateQueries({queryKey:["technician-fridge-status"]})}catch{}finally{S(!1)}},M=()=>{var ye;const T=((ye=t.first_name)==null?void 0:ye[0])??"",U=t.nickname||t.last_name||"",pe=(U==null?void 0:U[0])??"",re=`${T}${pe}`.trim();return re?re.toUpperCase():"T"},z=Qs(t.first_name,t.nickname,t.last_name)||"Technician",ve=T=>{switch(T==null?void 0:T.toLowerCase()){case"sound":return"bg-blue-100 text-blue-800";case"lights":return"bg-yellow-100 text-yellow-800";case"video":return"bg-purple-100 text-purple-800";default:return"bg-gray-100 text-gray-800"}},Be=T=>{switch(T==null?void 0:T.toLowerCase()){case"house_tech":return"bg-green-100 text-green-800";case"technician":return"bg-orange-100 text-orange-800";default:return"bg-gray-100 text-gray-800"}},we=T=>{const pe={gold:["¡El campeón indiscutible! ¿Será que no tiene vida fuera del trabajo?","Oro puro. Probablemente duerme con el móvil debajo de la almohada.","El número uno. Los demás técnicos lloran en la esquina.","¡Medalla de oro! ¿Seguro que no eres un robot?","Primer puesto. Tu cuenta bancaria debe estar feliz.","¡Oro! Los demás están tomando notas furiosamente.","Rey o reina de los bolos. ¿Cuándo descansas?","Medalla dorada. Hasta tu sombra trabaja más que los demás.","¡Campeón! Probablemente rechazas vacaciones por diversión.","Número uno con bala. Los otros técnicos necesitan un plan."],silver:["Plata. Cerca pero no lo suficiente. ¿Quizás el próximo mes?","Segundo lugar. El primer perdedor, como dicen por ahí.","Medalla de plata. Al menos no eres bronce.","¡Subcampeón! Tan cerca y tan lejos a la vez.","Plata reluciente. El oro te mira desde arriba.","Número dos. Como Pepsi, siempre detrás de Coca-Cola.","Medalla plateada. Tu esfuerzo es... respetable.","¡Plata! Casi oro, pero casi no cuenta.","Segundo puesto. El primero de los perdedores.","Plata brillante. El oro te envía saludos desde el podio."],bronze:["Bronce. Al menos estás en el podio... apenas.","Tercer lugar. Mejor que nada, ¿no?","Medalla de bronce. Los demás te miran con lástima.","¡Bronce! Felicidades por ser el último en el podio.",'Tercero. Es como decir "casi competente".',"Medalla de bronce. Al menos no eres cuarto.","¡Bronce! Tu mamá está orgullosa, probablemente.","Tercer puesto. Los otros dos te saludan desde arriba.","Bronce resplandeciente. Bueno, más o menos resplandeciente.","Número tres. Podría ser peor... o mejor."]}[T];return pe[Math.floor(Math.random()*pe.length)]},Ve=T=>{const U=new Date().getFullYear()-1,re={gold:["Fuiste oro el año pasado. ¿Qué pasó? ¿Te jubilaste?","Campeón del año pasado. Ahora... no tanto. ¿Nostalgia?",`Oro en ${U}. ¿Dónde quedó esa energía?`,"Eras el número uno. Pasado perfecto, presente... dudoso.",'¡Medalla de oro histórica! Énfasis en "histórica".',"Top del año pasado. Las glorias pasadas no pagan facturas.","Fuiste el rey. Ahora más bien... plebeyo.","Eras imparable. ¿Te pararon?",`Oro ${U}. ¿Ya te cansaste o simplemente te dio pereza?`,'Campeón que fue. La clave está en "fue".'],silver:["Plata el año pasado. Ni oro entonces, ni ahora.",`Segundo en ${U}. Al menos eres consistente... en no ganar.`,"Medalla plateada histórica. ¿Sigues casi ganando?","Subcampeón del pasado. ¿Cuándo será tu año de verdad?",`Plata en ${U}. Eternamente segundo, ¿no?`,"Casi ganaste el año pasado. Casi. Como siempre.","Segundo puesto histórico. ¿Te suena familiar?","Plata vintage. Tu zona de confort es el segundo lugar.","Fuiste plata. Sorpresa: sigues sin ser oro.","Subcampeón perenne. El oro te envía saludos del pasado."],bronze:["Bronce el año pasado. ¿Bajaste o ya estabas abajo?",`Tercero en ${U}. ¿Vas pa bajo o qué?`,"Medalla de bronce histórica. Última del podio... qué logro.","Tercer puesto del pasado. ¿Al menos mantienes el ritmo?",`Bronce ${U}. Podio por los pelos, como siempre.`,"Último en el podio el año pasado. ¿Sigues ahí?","Bronce vintage. Sigues siendo el tercero más motivado.","Tercer lugar histórico. Los otros dos no te extrañan.","Fuiste bronce. ¿Fuiste, eres o vas para allá?",'Podio del año pasado. Énfasis en "último del podio".']}[T];return re[Math.floor(Math.random()*re.length)]},Qe=(T,U="sm")=>{if(!T)return null;const pe=U==="sm"?"h-4 w-4":"h-5 w-5",re={gold:"#FFD700",silver:"#C0C0C0",bronze:"#CD7F32"},ye=we(T);return e.jsx(hs,{children:e.jsxs(ps,{children:[e.jsx(xs,{asChild:!0,children:e.jsx(Fs,{className:pe,style:{color:re[T],cursor:"help"}})}),e.jsx(gs,{children:e.jsx("p",{className:"max-w-xs",children:ye})})]})})},De=(t.department||"").slice(0,3).toUpperCase();return e.jsxs(e.Fragment,{children:[e.jsxs(Nt,{open:p,onOpenChange:Je,children:[e.jsx(Ct,{asChild:!0,children:e.jsx("div",{className:"border-b hover:bg-accent/50 cursor-pointer transition-colors",style:{height:o,padding:r?"0.25rem":"0.75rem",backgroundColor:t.bg_color||void 0},title:r?z:void 0,children:r?e.jsxs("div",{className:"h-full flex flex-col items-center justify-center",children:[e.jsxs("div",{className:"relative",children:[e.jsxs(as,{className:"h-8 w-8",children:[e.jsx(rs,{src:t.profile_picture_url||void 0,alt:z}),e.jsx(ns,{className:"text-xs",children:M()})]}),s&&e.jsx(yt,{className:"absolute -top-1 -right-1 h-3.5 w-3.5 text-sky-600"}),m&&!s&&e.jsx("div",{className:"absolute -top-1 -right-1",children:Qe(m,"sm")})]}),e.jsx("div",{className:"mt-1 text-[10px] leading-none text-muted-foreground",children:De})]}):e.jsxs("div",{className:"flex items-center gap-3 h-full",children:[e.jsxs(as,{className:"h-8 w-8",children:[e.jsx(rs,{src:t.profile_picture_url||void 0,alt:z}),e.jsx(ns,{className:"text-xs",children:M()})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-medium text-sm truncate flex items-center gap-1",children:[e.jsx("span",{children:z}),m&&!s&&Qe(m,"sm"),s&&e.jsx(yt,{className:"inline-block h-3.5 w-3.5 text-sky-600"})]}),e.jsxs("div",{className:"flex gap-1 mt-1 flex-wrap",children:[e.jsx(X,{variant:"secondary",className:`text-xs ${ve(t.department)}`,children:t.department}),e.jsx(X,{variant:"outline",className:`text-xs ${Be(t.role)}`,children:t.role==="house_tech"?"Técnico de Casa":"Técnico"})]})]})]})})}),e.jsx(Mt,{className:"w-80",side:"right",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(as,{className:"h-12 w-12",children:[e.jsx(rs,{src:t.profile_picture_url||void 0,alt:z}),e.jsx(ns,{children:M()})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-semibold flex items-center gap-2",children:[e.jsx("span",{children:z}),m&&Qe(m,"md")]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:t.role==="house_tech"?"Técnico de Casa":"Técnico"})]}),i&&!ge&&e.jsx(Z,{size:"sm",variant:"ghost",onClick:ze,className:"h-8",children:e.jsx(za,{className:"h-4 w-4"})})]}),ge?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(Ye,{htmlFor:"first_name",className:"text-xs",children:"Nombre"}),e.jsx(ht,{id:"first_name",value:A.first_name,onChange:T=>te({...A,first_name:T.target.value}),className:"h-8"})]}),e.jsxs("div",{children:[e.jsx(Ye,{htmlFor:"nickname",className:"text-xs",children:"Apodo"}),e.jsx(ht,{id:"nickname",value:A.nickname,onChange:T=>te({...A,nickname:T.target.value}),className:"h-8",placeholder:"Opcional"})]}),e.jsxs("div",{children:[e.jsx(Ye,{htmlFor:"last_name",className:"text-xs",children:"Apellidos"}),e.jsx(ht,{id:"last_name",value:A.last_name,onChange:T=>te({...A,last_name:T.target.value}),className:"h-8"})]}),e.jsxs("div",{children:[e.jsx(Ye,{htmlFor:"email",className:"text-xs",children:"Correo"}),e.jsx(ht,{id:"email",type:"email",value:A.email,onChange:T=>te({...A,email:T.target.value}),className:"h-8"})]}),e.jsxs("div",{children:[e.jsx(Ye,{htmlFor:"phone",className:"text-xs",children:"Teléfono"}),e.jsx(ht,{id:"phone",value:A.phone,onChange:T=>te({...A,phone:T.target.value}),className:"h-8",placeholder:"Optional"})]}),e.jsxs("div",{children:[e.jsx(Ye,{htmlFor:"dni",className:"text-xs",children:"DNI"}),e.jsx(ht,{id:"dni",value:A.dni,onChange:T=>te({...A,dni:T.target.value}),className:"h-8",placeholder:"Opcional"})]}),e.jsx("div",{children:e.jsx(Pa,{id:"residencia",value:A.residencia,onChange:T=>te(U=>({...U,residencia:T})),placeholder:"Ingresa ciudad",label:"Residencia",className:"space-y-2"})}),e.jsxs("div",{children:[e.jsx(Ye,{htmlFor:"department",className:"text-xs",children:"Departamento"}),e.jsxs(jt,{value:A.department,onValueChange:T=>te({...A,department:T}),children:[e.jsx(bt,{className:"h-8",children:e.jsx(vt,{})}),e.jsxs(_t,{children:[e.jsx(mt,{value:"sound",children:"Sonido"}),e.jsx(mt,{value:"lights",children:"Iluminación"}),e.jsx(mt,{value:"video",children:"Video"})]})]})]}),e.jsxs("div",{children:[e.jsx(Ye,{htmlFor:"role",className:"text-xs",children:"Rol"}),e.jsxs(jt,{value:A.role,onValueChange:T=>te({...A,role:T}),children:[e.jsx(bt,{className:"h-8",children:e.jsx(vt,{})}),e.jsxs(_t,{children:[e.jsx(mt,{value:"technician",children:"Técnico"}),e.jsx(mt,{value:"house_tech",children:"Técnico de Casa"})]})]})]}),e.jsxs("div",{children:[e.jsx(Ye,{htmlFor:"bg_color",className:"text-xs",children:"Color de fondo de fila"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[[{color:"#DC2626",name:"Rojo"},{color:"#2563EB",name:"Azul"},{color:"#16A34A",name:"Verde"},{color:"#CA8A04",name:"Amarillo"},{color:"#9333EA",name:"Morado"},{color:"#EA580C",name:"Naranja"},{color:"#DB2777",name:"Rosa"},{color:"#0891B2",name:"Cian"},{color:"#65A30D",name:"Lima"},{color:"#7C3AED",name:"Violeta"},{color:"#0D9488",name:"Verde azulado"},{color:"#64748B",name:"Pizarra"}].map(({color:T,name:U})=>e.jsx("button",{type:"button",onClick:()=>te(pe=>({...pe,bg_color:T})),className:`w-8 h-8 rounded border-2 transition-all hover:scale-110 ${A.bg_color===T?"border-white ring-2 ring-white":"border-gray-300"}`,style:{backgroundColor:T},title:U},T)),A.bg_color&&e.jsx(Z,{type:"button",size:"sm",variant:"outline",onClick:()=>te(T=>({...T,bg_color:""})),className:"h-8",children:"Limpiar"})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsxs(Z,{onClick:qe,disabled:G,size:"sm",className:"flex-1",children:[e.jsx(Oa,{className:"h-4 w-4 mr-1"})," ",G?"Guardando...":"Guardar"]}),e.jsxs(Z,{onClick:Re,disabled:G,size:"sm",variant:"outline",className:"flex-1",children:[e.jsx(It,{className:"h-4 w-4 mr-1"})," Cancelar"]})]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(La,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"Departamento:"}),e.jsx(X,{className:ve(t.department),children:((We=t.department)==null?void 0:We.charAt(0).toUpperCase())+((oe=t.department)==null?void 0:oe.slice(1))})]}),t.email&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Jt,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm truncate",children:t.email})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ca,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"Residencia:"}),O?e.jsx("span",{className:"text-sm text-muted-foreground",children:"Cargando..."}):e.jsx("span",{className:"text-sm truncate",children:_||"—"})]}),t.phone&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ia,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm truncate",children:t.phone})]}),t.dni&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ba,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm truncate",children:t.dni})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ka,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"Rol:"}),e.jsx(X,{variant:"outline",className:Be(t.role),children:t.role==="house_tech"?"Técnico de Casa":"Técnico"})]}),n&&e.jsxs("div",{className:"pt-2",children:[e.jsxs(Z,{variant:"default",size:"sm",className:"gap-2 h-8 w-full mb-2",disabled:J||!t.email,onClick:async()=>{if(t.email)try{Y(!0);const{data:T,error:U}=await I.functions.invoke("send-onboarding-email",{body:{email:t.email,firstName:t.first_name,lastName:t.last_name,department:t.department}});if(U)throw U;if(!(T!=null&&T.success))throw new Error("Failed to send onboarding email");Pe({title:"Onboarding enviado",description:`Se envió a ${t.email}.`})}catch(T){Pe({title:"No se pudo enviar el onboarding",description:(T==null?void 0:T.message)||"Error desconocido",variant:"destructive"})}finally{Y(!1)}},children:[e.jsx(Jt,{className:"h-4 w-4"})," ",J?"Enviando…":"Enviar Onboarding"]}),e.jsxs(Z,{variant:s?"secondary":"destructive",size:"sm",onClick:w,className:"gap-2 h-8",disabled:v,children:[e.jsx(yt,{className:"h-4 w-4"}),s?"Descongelar":"A la nevera"]})]}),!!(t.skills&&t.skills.length)&&e.jsxs("div",{className:"pt-2",children:[e.jsx("div",{className:"text-sm font-medium mb-1",children:"Habilidades"}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[(Le=t.skills)==null?void 0:Le.slice(0,8).map((T,U)=>e.jsx(X,{variant:T.is_primary?"default":"secondary",className:"text-xs",title:`${T.name}${T.proficiency!=null?` (lvl ${T.proficiency})`:""}`,children:T.name},(T.name||"")+U)),t.skills.length>8&&e.jsxs(X,{variant:"outline",className:"text-xs",children:["+",t.skills.length-8," más"]})]})]}),e.jsxs("div",{className:"pt-2 border-t",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("div",{className:"text-sm font-medium",children:"Actividad"}),e.jsx(Z,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>q(!x),children:x?e.jsxs(e.Fragment,{children:[e.jsx(Ma,{className:"h-3 w-3 mr-1"}),"Menos"]}):e.jsxs(e.Fragment,{children:[e.jsx(Sa,{className:"h-3 w-3 mr-1"}),"Más"]})})]}),B?e.jsx("div",{className:"text-xs text-muted-foreground",children:"Cargando..."}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Este mes"}),e.jsxs("div",{className:"flex items-center gap-1 flex-wrap",children:[e.jsxs(X,{variant:"default",className:"text-xs",children:[k.monthTotal," total"]}),e.jsxs(X,{variant:"outline",className:"text-xs",children:[k.monthUpcoming," programados"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Este año"}),e.jsxs("div",{className:"flex items-center gap-1 flex-wrap",children:[e.jsxs(X,{variant:"default",className:"text-xs",children:[k.yearTotal," total"]}),e.jsxs(X,{variant:"outline",className:"text-xs",children:[k.yearUpcoming," programados"]})]})]}),x&&e.jsxs("div",{className:"pt-2 border-t",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Año pasado (",Ps(new Date).getFullYear(),")"]}),a&&e.jsx(hs,{children:e.jsxs(ps,{children:[e.jsx(xs,{asChild:!0,children:e.jsx(Fs,{className:"h-4 w-4",style:{color:a==="gold"?"#FFD700":a==="silver"?"#C0C0C0":"#CD7F32",cursor:"help",opacity:.7}})}),e.jsx(gs,{children:e.jsx("p",{className:"max-w-xs",children:Ve(a)})})]})})]}),e.jsxs("div",{className:"flex items-center gap-1 flex-wrap",children:[e.jsxs(X,{variant:"default",className:"text-xs",children:[k.lastYearTotal," total"]}),e.jsxs(X,{variant:"outline",className:"text-xs opacity-50",children:[k.lastYearUpcoming," programados*"]})]}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1 italic",children:"*Datos históricos de programación"})]})]})]}),n&&e.jsx("div",{className:"pt-2",children:e.jsxs(Z,{variant:"secondary",size:"sm",onClick:()=>D(!0),className:"gap-2 h-8",children:[e.jsx(Aa,{className:"h-4 w-4"})," Añadir habilidad"]})})]})]})})]}),n&&e.jsx(Ra,{profileId:t.id,fullName:z,open:b,onOpenChange:Fe})]})},_r=W.memo(vr);function Xs(t){if(!t)return null;const s=t.trim().match(/^#([\da-f]{3}|[\da-f]{6})$/i);if(!s)return null;let r=s[1];r.length===3&&(r=r.split("").map(a=>a+a).join(""));const m=parseInt(r,16);return{r:m>>16&255,g:m>>8&255,b:m&255}}function os(t){const o=t/255;return o<=.03928?o/12.92:Math.pow((o+.055)/1.055,2.4)}function ls(t){const o=os(t.r),s=os(t.g),r=os(t.b);return .2126*o+.7152*s+.0722*r}function zs(t,o){const s=Math.max(t,o),r=Math.min(t,o);return(s+.05)/(r+.05)}function wr(t,o="#FFFFFF",s="#111827"){const r=Xs(t);if(!r)return s;const m=ls(r),a=ls({r:255,g:255,b:255}),d=ls({r:0,g:0,b:0}),i=zs(m,a),n=zs(m,d);return i>=n?o:s}function Nr(t,o){const s=Xs(t);return s?`rgba(${s.r}, ${s.g}, ${s.b}, ${o})`:null}const cs=t=>t==="sound"||t==="lights",_s=(t,o)=>{var m,a;const s=new Set;t!=null&&t.sound_role&&t.sound_role!=="none"&&s.add("sound"),t!=null&&t.lights_role&&t.lights_role!=="none"&&s.add("lights"),t!=null&&t.department&&cs(t.department)&&s.add(t.department);const r=((m=t==null?void 0:t.job)==null?void 0:m.department)??((a=t==null?void 0:t.jobs)==null?void 0:a.department);return cs(r)&&s.add(r),s.size===0&&cs(o)&&s.add(o),Array.from(s)},ea=c.memo(({technician:t,date:o,assignment:s,availability:r,width:m,height:a,isSelected:d,onSelect:i,onClick:n,onPrefetch:b,onOptimisticUpdate:D,onRender:p,jobId:l,allowDirectAssign:u=!1,declinedJobIdsSet:v=new Set,staffingStatusProvided:S=null,staffingStatusByDateProvided:B=null,isFridge:K=!1,mobile:x=!1})=>{var re,ye,Se,V,ke,Te;W.useEffect(()=>{p==null||p()},[p]);const q=Us(o),k=Hs(o),g=!!s,_=g&&s.status==="declined",N=(r==null?void 0:r.status)==="unavailable",O=g&&s.status==="confirmed"&&((re=s==null?void 0:s.job)==null?void 0:re.color)||null,$=O?wr(O):void 0,J=$?Nr($,.9)||$:void 0,Y=Qs(t.first_name,t.nickname,t.last_name)||"Técnico",Pe=S,ge=B,{mutate:Ie,isPending:G}=Zs(),{mutate:he,isPending:A}=Gs(),[te,me]=W.useState(!1),[ie,qe]=W.useState(null),[ze,Re]=W.useState(null),[Fe,Je]=W.useState(!1),[w,M]=W.useState("email"),z=g?Pe:ge,ve=c.useCallback((P,ne)=>{if(P.stopPropagation(),ne==="availability"&&!g&&!l){n("availability-email");return}if(ne==="offer"){const Ce=l||(s==null?void 0:s.job_id);if(!Ce){n("offer-details-email");return}if(v.has(Ce)){Ke.error("Este trabajo ya fue rechazado; elige otro para este técnico.");return}n("offer-details-email",Ce);return}const Ze=l||(s==null?void 0:s.job_id)||void 0;n("availability-email",Ze)},[l,s==null?void 0:s.job_id,t.id,t.first_name,t.nickname,t.last_name,g,s,o,n,ge]),Be=c.useCallback(()=>{b==null||b()},[b]),we=c.useCallback(P=>{if(P.stopPropagation(),P.ctrlKey||P.altKey||P.metaKey){i(!d);return}g?u&&n("assign"):N?n("unavailable"):u&&n("select-job")},[g,N,n,i,d,t,o,s,u]),Ve=c.useCallback((P,ne)=>{P.stopPropagation(),D==null||D(ne==="confirm"?"confirmed":"declined"),n(ne)},[n,D]),Qe=()=>{if(d)return"bg-blue-200 dark:bg-blue-800/50";if(g){const P=s.status;return P==="confirmed"?"":P==="declined"?"bg-rose-50 dark:bg-rose-900/20":"bg-yellow-50 dark:bg-yellow-900/20"}if(N)return"bg-gray-100 dark:bg-gray-800/50";if(!g&&z){const P=z.availability_status,ne=z.offer_status;if(ne==="sent"||ne==="pending")return"bg-blue-50 dark:bg-blue-900/20";if(ne==="confirmed")return"bg-indigo-50 dark:bg-indigo-900/20";if(ne==="declined")return"bg-rose-50 dark:bg-rose-900/20";if(P==="requested"||P==="pending")return"bg-yellow-50 dark:bg-yellow-900/20";if(P==="confirmed")return"bg-green-50 dark:bg-green-900/20";if(P==="declined")return"bg-red-50 dark:bg-red-900/20";if(P==="expired"||ne==="expired")return"bg-gray-100 dark:bg-gray-800/50"}return q?"bg-orange-50 dark:bg-orange-900/20":k?"bg-muted/30":"bg-card hover:bg-accent/50"},De=()=>{var P;return d?"border-blue-600 border-2 ring-2 ring-blue-400 ring-offset-1":g?(P=s.job)!=null&&P.color?"border-l-4":"border-yellow-300":N?"border-gray-300":q?"border-orange-200":"border-border"},We=!g&&!N&&(!(z!=null&&z.availability_status)||z.availability_status==="declined"||z.availability_status==="expired"),oe=(z==null?void 0:z.availability_status)==="confirmed"&&(!(z!=null&&z.offer_status)||z.offer_status==="declined"||z.offer_status==="expired"),Le=!g&&!N&&!oe,T=x?"absolute top-1 right-1":"absolute bottom-1 left-1",U=x?"absolute bottom-1 left-1":"absolute top-1 right-1",pe=x?"h-8 w-8":"h-5 w-5";return e.jsxs(ps,{children:[e.jsx(xs,{asChild:!0,children:e.jsxs("div",{className:Et("border-r border-b cursor-pointer transition-colors duration-150","flex flex-col justify-between p-1 text-xs relative",Qe(),De()),style:{width:`${m}px`,height:`${a}px`,borderLeftColor:(ye=s==null?void 0:s.job)==null?void 0:ye.color,borderLeftWidth:g&&((Se=s==null?void 0:s.job)!=null&&Se.color)?"3px":"1px",background:g&&s.status==="confirmed"&&((V=s==null?void 0:s.job)!=null&&V.color)?s.job.color:void 0},onClick:we,onMouseEnter:Be,children:[d&&e.jsx("div",{className:"absolute top-0 right-0 z-20",title:"Celda seleccionada para shortcuts",children:e.jsx("div",{className:"bg-blue-600 text-white px-1.5 py-0.5 text-[10px] font-bold rounded-bl",children:"✓ SELECTED"})}),K&&e.jsx("div",{className:"absolute top-1 left-1 z-10",title:"En la nevera: no asignable",children:e.jsx(yt,{className:"h-3.5 w-3.5 text-sky-600"})}),((z==null?void 0:z.availability_status)||(z==null?void 0:z.offer_status))&&e.jsxs("div",{className:`${T} flex gap-1 z-10`,children:[z.availability_status&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:P=>{P.stopPropagation();const ne=l||(s==null?void 0:s.job_id)||(ge==null?void 0:ge.availability_job_id);ne?qe({jobId:ne}):n("select-job-for-staffing")},title:"Reintentar solicitud de disponibilidad",className:"focus:outline-none",children:e.jsx(X,{variant:z.availability_status==="confirmed"?"default":z.availability_status==="declined"?"destructive":"secondary",className:`text-xs px-1 py-0 h-3 ${te?"ring-1 ring-blue-400":""}`,children:te?"A:↻":"A:"+(z.availability_status==="confirmed"?"✓":z.availability_status==="declined"?"✗":"?")})}),e.jsx("button",{type:"button",onClick:P=>{P.stopPropagation();const ne=l||(s==null?void 0:s.job_id)||(ge==null?void 0:ge.availability_job_id)||null;Re({phase:"availability",jobId:ne})},title:"Cancelar solicitud de disponibilidad",className:"focus:outline-none",children:e.jsx(X,{variant:"outline",className:"text-[10px] px-1 py-0 h-3",children:"×"})})]}),z.offer_status&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:P=>{P.stopPropagation();const ne=l||(s==null?void 0:s.job_id)||(ge==null?void 0:ge.offer_job_id);ne?n("offer-details",ne):n("select-job-for-staffing")},title:"Reintentar oferta",className:"focus:outline-none",children:e.jsxs(X,{variant:z.offer_status==="confirmed"?"default":z.offer_status==="declined"?"destructive":"secondary",className:"text-xs px-1 py-0 h-3",children:["O:",z.offer_status==="confirmed"?"✓":z.offer_status==="declined"?"✗":"?"]})}),e.jsx("button",{type:"button",onClick:P=>{P.stopPropagation();const ne=l||(s==null?void 0:s.job_id)||(ge==null?void 0:ge.offer_job_id)||null;Re({phase:"offer",jobId:ne})},title:"Cancelar oferta",className:"focus:outline-none",children:e.jsx(X,{variant:"outline",className:"text-[10px] px-1 py-0 h-3",children:"×"})})]})]}),_&&e.jsx("div",{className:"absolute top-1 left-1 z-10",title:"Rechazado: no se puede reasignar a este trabajo",children:e.jsx(fr,{className:"h-3.5 w-3.5 text-rose-600"})}),(We||oe||Le)&&e.jsxs("div",{className:`${U} flex gap-1 z-10`,children:[We&&e.jsxs(e.Fragment,{children:[e.jsx(Z,{variant:"ghost",size:x?"default":"sm",className:`${pe} p-0 hover:bg-blue-100`,onClick:P=>ve(P,"availability"),disabled:G,title:"Solicitar disponibilidad",children:e.jsx(Jt,{className:`${x?"h-4 w-4":"h-3 w-3"} text-blue-600`})}),e.jsx(Z,{variant:"ghost",size:x?"default":"sm",className:`${pe} p-0 hover:bg-emerald-100`,onClick:P=>{P.stopPropagation(),n("availability-wa")},disabled:G,title:"Solicitar disponibilidad por WhatsApp",children:e.jsx(qs,{className:`${x?"h-4 w-4":"h-3 w-3"} text-emerald-600`})})]}),(oe||Le)&&e.jsxs(e.Fragment,{children:[e.jsx(Z,{variant:"ghost",size:x?"default":"sm",className:`${pe} p-0 ${oe?"hover:bg-green-100":"opacity-80 hover:bg-muted"}`,onClick:P=>ve(P,"offer"),disabled:G,title:oe?"Enviar oferta":"Enviar oferta (progreso manual)",children:e.jsx(Ws,{className:`${x?"h-4 w-4":"h-3 w-3"} ${oe?"text-green-600":"text-muted-foreground"}`})}),e.jsx(Z,{variant:"ghost",size:x?"default":"sm",className:`${pe} p-0 ${oe?"hover:bg-emerald-100":"opacity-80 hover:bg-muted"}`,onClick:P=>{P.stopPropagation(),n("offer-details-wa",l||(s==null?void 0:s.job_id)||void 0)},disabled:G,title:oe?"Enviar oferta por WhatsApp":"Enviar oferta por WhatsApp (progreso manual)",children:e.jsx(qs,{className:`${x?"h-4 w-4":"h-3 w-3"} ${oe?"text-emerald-600":"text-muted-foreground"}`})})]})]}),g&&e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsx("div",{className:Et("font-medium truncate text-xs",(s.status!=="confirmed","")),style:{color:s.status==="confirmed"?$:void 0},children:((ke=s.job)==null?void 0:ke.title)||"Asignación"}),e.jsx("div",{className:Et("text-xs truncate",s.status==="confirmed"?"":"text-muted-foreground"),style:{color:s.status==="confirmed"?J:void 0},children:Bt(s.sound_role||s.lights_role||s.video_role)}),s.single_day&&s.assignment_date&&e.jsxs("div",{className:"text-[10px] text-muted-foreground truncate",children:["Día único: ",F(new Date(`${s.assignment_date}T00:00:00`),"MMM d")]}),s.status==="invited"&&e.jsxs("div",{className:"flex gap-1 mt-1",children:[e.jsx(Z,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 hover:bg-green-100",onClick:P=>Ve(P,"confirm"),title:"Confirmar",children:e.jsx(Ks,{className:"h-3 w-3 text-green-600"})}),e.jsx(Z,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 hover:bg-red-100",onClick:P=>Ve(P,"decline"),title:"Rechazar",children:e.jsx(It,{className:"h-3 w-3 text-red-600"})})]}),g&&e.jsx("div",{className:"absolute bottom-1 right-1",children:e.jsx(X,{variant:s.status==="confirmed"?"default":"secondary",className:"text-xs px-1 py-0 h-4",children:s.status==="confirmed"?"C":s.status==="declined"?"R":"P"})}),e.jsx("div",{className:"absolute top-1 right-1",children:e.jsx(Z,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 hover:bg-red-100",title:"Eliminar asignación",onClick:P=>{P.stopPropagation(),Je(!0)},children:e.jsx(It,{className:"h-3 w-3 text-red-600"})})})]}),N&&!g&&e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ua,{className:"h-4 w-4 mx-auto text-muted-foreground mb-1"}),e.jsx("div",{className:"text-xs text-muted-foreground truncate",children:r.reason||"No disponible"})]})}),!g&&!N&&u&&e.jsx("div",{className:"flex-1 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity",children:e.jsx(ut,{className:"h-4 w-4 text-muted-foreground"})}),q&&e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1 bg-orange-400 dark:bg-orange-600"}),ie&&e.jsx(rt,{open:!0,onOpenChange:P=>!P&&qe(null),children:e.jsxs(nt,{children:[e.jsxs(it,{children:[e.jsx(ot,{children:"Reenviar solicitud de disponibilidad"}),e.jsx(dt,{children:"Elige el canal y reenvía la solicitud de disponibilidad."})]}),e.jsx("div",{className:"py-2",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"font-medium text-sm text-foreground",children:"Canal"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"availability-retry-channel",checked:w==="email",onChange:()=>M("email")}),e.jsx("span",{children:"Email"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"availability-retry-channel",checked:w==="whatsapp",onChange:()=>M("whatsapp")}),e.jsx("span",{children:"WhatsApp"})]})]})]})}),e.jsxs(lt,{children:[e.jsx(Z,{variant:"outline",onClick:()=>qe(null),children:"Cancelar"}),e.jsx(Z,{onClick:()=>{ie&&(me(!0),Ie({job_id:ie.jobId,profile_id:t.id,phase:"availability",channel:w,target_date:F(o,"yyyy-MM-dd"),single_day:!0},{onSuccess:()=>{me(!1),qe(null),Ke.success("Solicitud de disponibilidad reenviada")},onError:P=>{me(!1),qe(null),Ke.error(`No se pudo reenviar la solicitud de disponibilidad: ${P.message}`)}}))},disabled:te,children:te?"Reenviando…":"Reenviar"})]})]})}),ze&&e.jsx(rt,{open:!0,onOpenChange:P=>!P&&Re(null),children:e.jsxs(nt,{children:[e.jsxs(it,{children:[e.jsx(ot,{children:ze.phase==="availability"?"¿Cancelar solicitud de disponibilidad?":"¿Cancelar oferta?"}),e.jsxs(dt,{children:["Esto marcará la fase de ",ze.phase==="availability"?"disponibilidad":"oferta"," como cancelada para ",Y,"."]})]}),e.jsxs(lt,{children:[e.jsx(Z,{variant:"outline",onClick:()=>Re(null),children:"Mantener"}),e.jsx(Z,{onClick:()=>{if(!ze.jobId){Re(null);return}he({job_id:ze.jobId,profile_id:t.id,phase:ze.phase},{onSuccess:()=>{Re(null),Ke.success(`${ze.phase==="availability"?"Disponibilidad":"Oferta"} cancelada`)},onError:P=>{Ke.error((P==null?void 0:P.message)||"No se pudo cancelar")}})},disabled:A,children:A?"Cancelando…":"Cancelar"})]})]})}),Fe&&e.jsx(rt,{open:!0,onOpenChange:P=>!P&&Je(!1),children:e.jsxs(nt,{children:[e.jsxs(it,{children:[e.jsx(ot,{children:"¿Eliminar asignación?"}),e.jsxs(dt,{children:["Se eliminará la asignación de ",Y," en este trabajo."]})]}),e.jsxs(lt,{children:[e.jsx(Z,{variant:"outline",onClick:()=>Je(!1),children:"Mantener"}),e.jsx(Z,{variant:"destructive",onClick:async()=>{try{if(!(s!=null&&s.job_id)){Je(!1);return}const{data:P,error:ne}=await I.rpc("manage_assignment_lifecycle",{p_job_id:s.job_id,p_technician_id:t.id,p_action:"cancel",p_delete_mode:"hard"});if(ne)throw ne;if(P!=null&&P.error)throw new Error(P.error);const Ze=_s(s,t.department);Ze.length>0&&await Promise.allSettled(Ze.map(async Ce=>{try{const{error:Xe}=await I.functions.invoke("manage-flex-crew-assignments",{body:{job_id:s.job_id,technician_id:t.id,department:Ce,action:"remove"}})}catch{}}));try{I.functions.invoke("push",{body:{action:"broadcast",type:"assignment.removed",job_id:s.job_id,recipient_id:t.id,technician_id:t.id}})}catch{}Je(!1),Ke.success("Asignación eliminada"),window.dispatchEvent(new CustomEvent("assignment-updated"))}catch(P){Ke.error((P==null?void 0:P.message)||"No se pudo eliminar la asignación")}},children:"Eliminar"})]})]})})]})}),e.jsx(gs,{side:"top",className:"max-w-xs p-2",children:e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsx("div",{className:"font-semibold",children:Y}),e.jsx("div",{className:"text-muted-foreground",children:t.department}),g&&e.jsxs("div",{className:"text-xs",children:[e.jsx("div",{children:(Te=s.job)==null?void 0:Te.title}),e.jsx("div",{className:"text-muted-foreground",children:Bt(s.sound_role||s.lights_role||s.video_role)}),s.single_day&&s.assignment_date&&e.jsxs("div",{className:"text-muted-foreground",children:["Día único: ",F(new Date(`${s.assignment_date}T00:00:00`),"MMM d")]}),e.jsx("div",{className:`capitalize ${s.status==="confirmed"?"text-green-600":s.status==="declined"?"text-red-600":"text-yellow-600"}`,children:s.status})]}),N&&!g&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["No disponible",r.notes?`: ${r.notes}`:""]})]})})]})});ea.displayName="OptimizedMatrixCell";function Cr(t,o){return He({queryKey:["matrix-job-engagement-counts",t,(o||[]).join(",")],queryFn:async()=>{if(!t||!(o!=null&&o.length))return{invitations:0,offers:0,confirmations:0};const s=l=>l?l==="pending"?"requested":l==="expired"?null:l:null,r=l=>l?l==="pending"?"sent":l==="expired"?null:l:null;let m=0,a=0;const{data:d,error:i}=await I.rpc("get_assignment_matrix_staffing").eq("job_id",t).in("profile_id",o);if(i||(d||[]).forEach(l=>{const u=s(l.availability_status),v=r(l.offer_status);u==="requested"&&m++,v==="sent"&&a++}),i||!(d||[]).length){const{data:l,error:u}=await I.from("staffing_requests").select("job_id, profile_id, phase, status, updated_at").eq("job_id",t).in("profile_id",o),v=new Map;(l||[]).forEach(S=>{const B=`${S.profile_id}-${S.phase}`,K=S.updated_at?new Date(S.updated_at).getTime():0,x=v.get(B);(!x||K>x.t)&&v.set(B,{phase:S.phase,status:S.status,t:K})}),m=0,a=0,v.forEach(S=>{S.phase==="availability"&&(S.status==="pending"||S.status==="requested")&&m++,S.phase==="offer"&&(S.status==="pending"||S.status==="sent")&&a++})}const{data:n,error:b}=await I.from("timesheets").select("technician_id").eq("job_id",t).eq("is_active",!0).in("technician_id",o),D=new Set;(n||[]).forEach(l=>{l.technician_id&&D.add(l.technician_id)});const p=D.size;return{invitations:m,offers:a,confirmations:p}},staleTime:2e3,gcTime:6e4,enabled:!!t})}const Mr=({date:t,width:o,jobs:s=[],technicianIds:r,onJobClick:m})=>{const a=Us(t),d=Hs(t),i=s.length>0,b=(()=>{if(s.length===0)return[];const u=s.map(v=>v.color||"#7E69AB");return[...new Set(u)]})(),{data:D}=kr(t,s,r),p=W.useMemo(()=>(s||[]).map(u=>u.id),[s]),{data:l}=He({queryKey:["matrix-open-slots",p.join(",")],queryFn:async()=>{if(!p.length)return{required:0,assigned:0,open:0};const{data:u}=await I.from("timesheets").select("technician_id, job_id").eq("is_active",!0).in("job_id",p),v=new Map;(u||[]).forEach(g=>{v.has(g.job_id)||v.set(g.job_id,new Set),v.get(g.job_id).add(g.technician_id)});const S=new Set;if((u||[]).forEach(g=>S.add(g.technician_id)),S.size===0){const{data:g}=await I.from("job_required_roles_summary").select("total_required, job_id").in("job_id",p),_=(g||[]).reduce((N,O)=>N+Number(O.total_required||0),0);return{required:_,assigned:0,open:_}}const[{data:B},{data:K}]=await Promise.all([I.from("job_required_roles_summary").select("total_required, job_id").in("job_id",p),I.from("job_assignments").select("job_id, technician_id, sound_role, lights_role, video_role").in("job_id",p).in("technician_id",Array.from(S))]),x=(B||[]).reduce((g,_)=>g+Number(_.total_required||0),0);let q=0;(K||[]).forEach(g=>{const _=v.get(g.job_id);_&&_.has(g.technician_id)&&(g.sound_role!=null&&q++,g.lights_role!=null&&q++,g.video_role!=null&&q++)});const k=Math.max(x-q,0);return{required:x,assigned:q,open:k}},staleTime:1e4,enabled:i});return e.jsxs(Nt,{children:[e.jsx(Ct,{asChild:!0,children:e.jsxs("div",{className:Et("border-r text-center text-xs font-medium bg-card cursor-pointer","flex flex-col justify-center items-center relative transition-colors","hover:bg-accent/50 flex-shrink-0",{"bg-orange-50 dark:bg-orange-950/30 border-orange-200 dark:border-orange-800 text-orange-700 dark:text-orange-300":a,"bg-muted/50 text-muted-foreground":d&&!a,"ring-2 ring-blue-500/30 ring-inset":i}),style:{width:`${o}px`,minWidth:`${o}px`,maxWidth:`${o}px`,height:"100%"},children:[e.jsx("div",{className:"font-semibold text-xs",children:F(t,"EEE",{locale:Tt})}),e.jsx("div",{className:Et("text-base font-bold leading-tight",{"text-orange-700 dark:text-orange-300":a}),children:F(t,"d")}),e.jsx("div",{className:"text-xs text-muted-foreground leading-tight",children:F(t,"MMM",{locale:Tt})}),F(t,"d")==="1"&&e.jsx("div",{className:"text-xs text-muted-foreground mt-0.5 leading-tight",children:F(t,"yyyy")}),i&&e.jsxs("div",{className:"absolute bottom-1 left-1/2 transform -translate-x-1/2 flex gap-1",children:[b.slice(0,3).map((u,v)=>e.jsx("div",{className:"w-1.5 h-1.5 rounded-full border border-white dark:border-gray-800",style:{backgroundColor:u}},v)),b.length>3&&e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-gray-400 dark:bg-gray-600 border border-white dark:border-gray-800"})]}),i&&e.jsxs("div",{className:"absolute top-0.5 right-0.5 flex flex-col items-end gap-0.5",children:[e.jsx(X,{variant:"secondary",className:"text-[10px] px-1 py-0 h-4 leading-none",title:"Trabajos en esta fecha",children:s.length}),e.jsx(X,{variant:"default",className:"text-[10px] px-1 py-0 h-4 leading-none",title:"Técnicos confirmados en esta fecha",children:D??0}),l&&l.required>0&&e.jsxs(X,{variant:"outline",className:"text-[10px] px-1 py-0 h-4 leading-none",title:"Vacantes en todos los trabajos",children:[l.open," libres"]})]})]})}),i&&e.jsx(Mt,{className:"w-80",side:"bottom",align:"center",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ut,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:F(t,"EEEE, d MMMM, yyyy",{locale:Tt})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(ys,{className:"h-3 w-3"}),e.jsxs("span",{children:[s.length," trabajo",s.length!==1?"s":""," programado",s.length!==1?"s":""]})]}),s.map(u=>e.jsx(Sr,{job:u,technicianIds:r,onJobClick:m},u.id))]})]})})]})};function Sr({job:t,technicianIds:o,onJobClick:s}){const{data:r}=Cr(t.id,o);return e.jsxs("div",{className:"p-2 border rounded-lg bg-card hover:bg-accent/30 cursor-pointer",style:{borderLeftColor:t.color||"#7E69AB",borderLeftWidth:"3px"},onClick:m=>{m.stopPropagation(),s==null||s(t.id)},title:"Haz clic para ordenar técnicos por compromiso para este trabajo",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-sm",children:t.title}),e.jsxs("div",{className:"text-xs text-muted-foreground flex items-center gap-1 mt-1",children:[e.jsx($t,{className:"h-3 w-3"}),F(new Date(t.start_time),"HH:mm")," - ",F(new Date(t.end_time),"HH:mm")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="Cancelado"&&e.jsx(X,{variant:"destructive",className:"text-[10px]",children:"Llamar para cancelar"}),e.jsx(X,{variant:"outline",className:"text-xs",children:t.status})]})]}),e.jsxs("div",{className:"mt-2 flex gap-1 flex-wrap",children:[e.jsxs(X,{variant:"secondary",className:"text-[10px] h-5 px-1.5",title:"Invitaciones de disponibilidad pendientes",children:["Inv: ",(r==null?void 0:r.invitations)??0]}),e.jsxs(X,{variant:"secondary",className:"text-[10px] h-5 px-1.5",title:"Ofertas pendientes",children:["Ofertas: ",(r==null?void 0:r.offers)??0]}),e.jsxs(X,{variant:"default",className:"text-[10px] h-5 px-1.5",title:"Asignaciones confirmadas",children:["Conf: ",(r==null?void 0:r.confirmations)??0]})]})]})}function kr(t,o,s){const r=F(t,"yyyy-MM-dd"),m=(o||[]).map(a=>a.id);return He({queryKey:["matrix-date-confirmed-count",r,m.join(","),(s||[]).join(",")],queryFn:async()=>{if(!m.length)return 0;let a=I.from("timesheets").select("technician_id").eq("is_active",!0).in("job_id",m).eq("date",r);s&&s.length>0&&(a=a.in("technician_id",s));const{data:d,error:i}=await a;if(i)return 0;const n=new Set;return(d||[]).forEach(b=>{b.technician_id&&n.add(b.technician_id)}),n.size},staleTime:2e3,gcTime:6e4,enabled:m.length>0})}const Er=W.memo(Mr),Dr=({open:t,onClose:o,onJobSelected:s,technicianName:r,date:m,availableJobs:a})=>{const[d,i]=c.useState(""),n=p=>{i(p)},b=()=>{d&&s(d)},D=()=>{i(""),o()};return e.jsx(rt,{open:t,onOpenChange:D,children:e.jsxs(nt,{className:"sm:max-w-md",children:[e.jsxs(it,{children:[e.jsx(ot,{children:"Seleccionar Trabajo"}),e.jsxs(dt,{children:["Selecciona un trabajo para asignar a ",r," el"," ",F(m,"EEEE, d MMMM, yyyy",{locale:Tt})]})]}),e.jsx("div",{className:"space-y-3",children:a.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"No hay trabajos disponibles para esta fecha"})}):a.map(p=>e.jsx("div",{className:`p-3 border rounded-lg cursor-pointer transition-colors ${d===p.id?"border-primary bg-primary/5":"border-border hover:bg-accent/50"}`,onClick:()=>n(p.id),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:p.title}),e.jsxs("div",{className:"text-sm text-muted-foreground flex items-center gap-1 mt-1",children:[e.jsx($t,{className:"h-3 w-3"}),F(new Date(p.start_time),"HH:mm")," - ",F(new Date(p.end_time),"HH:mm")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[p.status==="Cancelado"&&e.jsx(X,{variant:"destructive",className:"text-[10px]",children:"Llamar para cancelar"}),e.jsx(X,{variant:"secondary",children:p.status})]})]})},p.id))}),e.jsxs(lt,{children:[e.jsx(Z,{variant:"outline",onClick:D,children:"Cancelar"}),e.jsx(Z,{onClick:b,disabled:!d,children:"Continuar"})]})]})})},Tr=({open:t,onClose:o,onStaffingActionSelected:s,technicianId:r,technicianName:m,date:a,availableJobs:d,declinedJobIds:i=[],preselectedJobId:n=null,forcedAction:b,forcedChannel:D})=>{const[p,l]=c.useState(""),[u,v]=c.useState("availability"),[S,B]=c.useState(!1),{mutate:K,isPending:x}=Gs(),q=b||u,k=D==="whatsapp"?"WhatsApp":D==="email"?"Email":null,g=J=>{l(J)},_=()=>{p&&s(p,q,{singleDay:S})},N=()=>{l(""),v("availability"),B(!1),o()};W.useEffect(()=>{t&&n&&l(n)},[t,n]),W.useEffect(()=>{b&&v(b)},[b]);const O=q==="availability"?"Pedir Disponibilidad":"Enviar Oferta",$=k?`${O} vía ${k}`:O;return e.jsx(rt,{open:t,onOpenChange:N,children:e.jsxs(nt,{className:"sm:max-w-md",children:[e.jsxs(it,{children:[e.jsx(ot,{children:"Solicitud de Personal"}),e.jsxs(dt,{children:["Selecciona un trabajo y acción para ",m," el"," ",F(a,"EEEE, d MMMM, yyyy",{locale:Tt})]})]}),e.jsxs("div",{className:"space-y-4",children:[b&&e.jsx("div",{className:"rounded-md border border-muted-foreground/30 bg-muted/40 p-3 text-sm text-muted-foreground",children:b==="availability"?`Este atajo pedirá disponibilidad${k?` vía ${k}`:""}.`:`Este atajo enviará una oferta de trabajo${k?` vía ${k}`:""}.`}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-sm font-medium",children:"Seleccionar Trabajo"}),d.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"No hay trabajos disponibles para esta fecha"})}):d.map(J=>{const Y=i.includes(J.id),Pe=p===J.id;return e.jsx("div",{className:`p-3 border rounded-lg transition-colors ${Pe?"border-primary bg-primary/5":"border-border hover:bg-accent/50"} ${Y?"opacity-60 cursor-not-allowed":"cursor-pointer"}`,onClick:()=>{Y||g(J.id)},title:Y?"El técnico rechazó este trabajo":void 0,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:J.title}),e.jsxs("div",{className:"text-sm text-muted-foreground flex items-center gap-1 mt-1",children:[e.jsx($t,{className:"h-3 w-3"}),F(new Date(J.start_time),"HH:mm")," - ",F(new Date(J.end_time),"HH:mm")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Y&&e.jsx(X,{variant:"destructive",children:"Rechazado"}),J.status==="Cancelado"&&e.jsx(X,{variant:"destructive",className:"text-[10px]",children:"Llamar para cancelar"}),e.jsx(X,{variant:"secondary",children:J.status})]})]})},J.id)})]}),p&&e.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"scope-single-day",type:"checkbox",checked:S,onChange:J=>B(J.target.checked)}),e.jsx(Ye,{htmlFor:"scope-single-day",className:"text-sm cursor-pointer",children:"Solicitar solo para este día"})]}),e.jsx("p",{className:"text-xs text-muted-foreground ml-6",children:"Para trabajos de varios días, marca esto para solicitar disponibilidad/oferta solo para esta fecha específica"})]}),p&&!b&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-sm font-medium",children:"Elegir Acción"}),e.jsxs(Ha,{value:u,onValueChange:J=>v(J),children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($s,{value:"availability",id:"availability"}),e.jsxs(Ye,{htmlFor:"availability",className:"flex items-center gap-2 cursor-pointer",children:[e.jsx(Jt,{className:"h-4 w-4 text-blue-600"}),"Pedir Disponibilidad",e.jsx("span",{className:"text-sm text-muted-foreground",children:"Enviar email para comprobar si el técnico está disponible"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($s,{value:"offer",id:"offer"}),e.jsxs(Ye,{htmlFor:"offer",className:"flex items-center gap-2 cursor-pointer",children:[e.jsx(Ws,{className:"h-4 w-4 text-green-600"}),"Enviar Oferta de Trabajo",e.jsx("span",{className:"text-sm text-muted-foreground",children:"Enviar email ofreciendo el trabajo al técnico"})]})]})]}),e.jsx("div",{className:"flex items-center justify-between pt-2",children:e.jsx(Z,{variant:"outline",disabled:!p,onClick:()=>{p&&K({job_id:p,profile_id:r,phase:q})},children:x?"Cancelando…":`Cancelar ${q==="availability"?"Disponibilidad":"Oferta"}`})})]})]}),e.jsxs(lt,{children:[e.jsx(Z,{variant:"outline",onClick:N,children:"Cancelar"}),e.jsx(Z,{onClick:_,disabled:!p,children:$})]})]})})};async function qr({jobId:t,technicianId:o,dateIso:s,present:r,source:m="matrix"}){const{error:a}=await I.rpc("toggle_timesheet_day",{p_job_id:t,p_technician_id:o,p_date:s,p_present:r,p_source:m});if(a)throw a}async function Os({jobId:t,technicianId:o}){const{data:s,error:r}=await I.rpc("remove_assignment_with_timesheets",{p_job_id:t,p_technician_id:o});if(r)throw r;const m=Array.isArray(s)?s[0]:s;return{deleted_timesheets:(m==null?void 0:m.deleted_timesheets)??0,deleted_assignment:(m==null?void 0:m.deleted_assignment)??!1}}const $r=({open:t,onClose:o,technicianId:s,date:r,availableJobs:m,existingAssignment:a,preSelectedJobId:d})=>{const[i,n]=c.useState(d||(a==null?void 0:a.job_id)||""),[b,D]=c.useState(""),[p,l]=c.useState(a!=null&&a.single_day?"single":"full"),[u,v]=c.useState(r),[S,B]=c.useState(r?[r]:[]),[K,x]=c.useState(!1),[q,k]=c.useState(!1),[g,_]=c.useState(!1),[N,O]=c.useState(null),{data:$}=He({queryKey:["technician",s],queryFn:async()=>{const{data:w,error:M}=await I.from("profiles").select("first_name, last_name, department").eq("id",s).single();if(M)throw M;return w},enabled:t&&!!s}),J=W.useMemo(()=>(a==null?void 0:a.status)==="declined"?m.filter(w=>w.id!==a.job_id):m,[m,a==null?void 0:a.status,a==null?void 0:a.job_id]),Y=J.find(w=>w.id===i),Pe=$?As($.department):[],ge=!!a,Ie=W.useMemo(()=>F(u??r,"yyyy-MM-dd"),[r,u]);W.useEffect(()=>{if(a&&$){const w=a.sound_role||a.lights_role||a.video_role;if(w)if(ka(w))D(w);else{const M=Ea(w,$.department)||"";D(M)}}},[a,$]),W.useEffect(()=>{if(a!=null&&a.single_day&&(a!=null&&a.assignment_date))try{v(new Date(`${a.assignment_date}T00:00:00`))}catch{}},[a==null?void 0:a.single_day,a==null?void 0:a.assignment_date]),W.useEffect(()=>{d&&n(d)},[d]);const G=async()=>{if(!i)return null;if(p==="multi"){const M=Array.from(new Set((S||[]).map(z=>F(z,"yyyy-MM-dd"))));for(const z of M){const ve=await Dt(s,i,{targetDateIso:z,singleDayOnly:!0,includePending:!0});if(ve.hasHardConflict||ve.hasSoftConflict)return{result:ve,targetDate:z,mode:"multi"}}return null}if(p==="single"){const M=await Dt(s,i,{targetDateIso:Ie,singleDayOnly:!0,includePending:!0});return M.hasHardConflict||M.hasSoftConflict?{result:M,targetDate:Ie,mode:"single"}:null}const w=await Dt(s,i,{includePending:!0});return w.hasHardConflict||w.hasSoftConflict?{result:w,mode:"full"}:null},he=async(w=!1)=>{var z,ve,Be;if(!i||!b||!$){Ke.error("Por favor selecciona un trabajo y un rol");return}if((a==null?void 0:a.status)==="declined"&&i===a.job_id){Ke.error("Este técnico ya rechazó este trabajo");return}if(q)return;if(!w){const we=await G();if(we){O(we);return}}k(!0);const M=window.setTimeout(()=>{k(!1),Ke.error("La asignación expiró - por favor intenta de nuevo")},1e4);try{const we=$.department==="sound"?b:"none",Ve=$.department==="lights"?b:"none",Qe=$.department==="video"?b:"none";if(ge){const{deleted_assignment:V}=await Os({jobId:a.job_id,technicianId:s});if(!V){const{error:Te}=await I.from("job_assignments").delete().eq("job_id",a.job_id).eq("technician_id",s);if(Te)throw Te}const ke=_s(a,$==null?void 0:$.department);a!=null&&a.job_id&&ke.length>0&&await Promise.allSettled(ke.map(async Te=>{try{const{error:P}=await I.functions.invoke("manage-flex-crew-assignments",{body:{job_id:a.job_id,technician_id:s,department:Te,action:"remove"}})}catch{}}))}const De={job_id:i,technician_id:s,sound_role:we!=="none"?we:null,lights_role:Ve!=="none"?Ve:null,video_role:Qe!=="none"?Qe:null,assigned_by:(z=(await I.auth.getUser()).data.user)==null?void 0:z.id,assigned_at:new Date().toISOString(),status:K?"confirmed":"invited",response_time:K?new Date().toISOString():null,assignment_source:"direct"},{data:We}=await I.from("job_assignments").select("job_id, technician_id, single_day, assignment_date, status").eq("job_id",i).eq("technician_id",s).maybeSingle(),oe=p!=="full",Le=p==="single"?Ie:p==="multi"&&S&&S.length>0?F(S[0],"yyyy-MM-dd"):null;if(We){const V={sound_role:De.sound_role,lights_role:De.lights_role,video_role:De.video_role,assigned_by:De.assigned_by,assigned_at:De.assigned_at,status:We.status==="confirmed"&&De.status!=="confirmed"?"confirmed":De.status,response_time:De.status==="confirmed"?De.response_time:We.status==="confirmed"?We.response_time??null:null,single_day:oe,assignment_date:Le,assignment_source:De.assignment_source},{error:ke}=await I.from("job_assignments").update(V).eq("job_id",i).eq("technician_id",s);if(ke)throw ke}else{const V={...De,single_day:oe,assignment_date:Le},{error:ke}=await I.from("job_assignments").insert(V);if(ke)if(ke.code==="23505"){const{error:Te}=await I.from("job_assignments").update({sound_role:V.sound_role,lights_role:V.lights_role,video_role:V.video_role,assigned_by:V.assigned_by,assigned_at:V.assigned_at,status:V.status,response_time:V.response_time,single_day:V.single_day,assignment_date:V.assignment_date,assignment_source:V.assignment_source}).eq("job_id",i).eq("technician_id",s);if(Te)throw Te}else throw ke}await I.from("timesheets").delete().eq("job_id",i).eq("technician_id",s);const T=await(async()=>{if(p==="multi"){const V=Array.from(new Set((S||[]).map(ke=>F(ke,"yyyy-MM-dd"))));if(V.length===0)throw new Error("Selecciona al menos una fecha");return V}if(p==="single"&&Ie)return[Ie];if(p==="full"){const{data:V}=await I.from("jobs").select("start_time, end_time").eq("id",i).single();if(V){const ke=new Date(V.start_time),Te=new Date(V.end_time),P=[];for(let ne=new Date(ke);ne<=Te;ne.setDate(ne.getDate()+1))P.push(F(ne,"yyyy-MM-dd"));return P}}return[]})();for(const V of T)await qr({jobId:i,technicianId:s,dateIso:V,present:!0,source:"assignment-dialog"});const U=I.from("job_assignments").select("job_id").eq("job_id",i).eq("technician_id",s).limit(1),{data:pe,error:re}=await U;if(re)throw re;if(!pe||pe.length===0)throw new Error("La asignación no se guardó");try{if(we&&we!=="none"){const{error:V}=await I.functions.invoke("manage-flex-crew-assignments",{body:{job_id:i,technician_id:s,department:"sound",action:"add"}})}if(Ve&&Ve!=="none"){const{error:V}=await I.functions.invoke("manage-flex-crew-assignments",{body:{job_id:i,technician_id:s,department:"lights",action:"add"}})}}catch{}const ye=K?"confirmed":"invited";window.clearTimeout(M),Ke.success(`${ge?"Reasignado":"Asignado"} ${$.first_name} ${$.last_name} a ${Y==null?void 0:Y.title} (${ye})`);const Se=`${$.first_name??""} ${$.last_name??""}`.trim();try{I.functions.invoke("push",{body:{action:"broadcast",type:"job.assignment.direct",job_id:i,recipient_id:s,recipient_name:Se||void 0,assignment_status:K?"confirmed":"invited",target_date:p==="single"?`${Ie}T00:00:00Z`:void 0,single_day:p!=="full"}})}catch{}window.dispatchEvent(new CustomEvent("assignment-updated",{detail:{technicianId:s,jobId:i}})),setTimeout(()=>{o()},100)}catch(we){window.clearTimeout(M),we.code==="23505"?Ke.error("Este técnico ya está asignado a este trabajo"):(ve=we.message)!=null&&ve.includes("timeout")||(Be=we.message)!=null&&Be.includes("network")?Ke.error("Error de red - por favor verifica tu conexión e intenta de nuevo"):Ke.error(`Error al asignar el trabajo: ${we.message||"Error desconocido"}`)}finally{window.clearTimeout(M),k(!1)}},A=()=>{he()},te=async()=>{if(a&&!g){_(!0);try{const{deleted_assignment:w}=await Os({jobId:a.job_id,technicianId:s});if(!w){const{error:z}=await I.from("job_assignments").delete().eq("job_id",a.job_id).eq("technician_id",s);if(z)throw z}const M=_s(a,$==null?void 0:$.department);a!=null&&a.job_id&&M.length>0&&await Promise.allSettled(M.map(async z=>{try{const{error:ve}=await I.functions.invoke("manage-flex-crew-assignments",{body:{job_id:a.job_id,technician_id:s,department:z,action:"remove"}})}catch{}})),Ke.success("Asignación eliminada"),window.dispatchEvent(new CustomEvent("assignment-updated",{detail:{technicianId:s,jobId:a.job_id}})),o()}catch(w){Ke.error((w==null?void 0:w.message)||"Error al eliminar la asignación")}finally{_(!1)}}},me=w=>{x(w===!0)},ie=c.useMemo(()=>{const w=Y;if(!w)return null;const M=w.start_time?new Date(w.start_time):void 0,z=w.end_time?new Date(w.end_time):M;return M&&M.setHours(0,0,0,0),z&&z.setHours(0,0,0,0),{start:M,end:z}},[Y]),qe=w=>{if(!(ie!=null&&ie.start)||!(ie!=null&&ie.end))return!0;const M=new Date(w);return M.setHours(0,0,0,0),M>=ie.start&&M<=ie.end},ze=(w,M)=>{if(!w||!M)return null;try{return`${F(new Date(w),"PPP")} – ${F(new Date(M),"PPP")}`}catch{return null}},Re=w=>{if(!w)return null;try{return F(new Date(`${w}T00:00:00`),"PPP")}catch{return null}},Fe=Y?ze(Y.start_time,Y.end_time):null,Je=Re(N==null?void 0:N.targetDate);return e.jsxs(e.Fragment,{children:[e.jsx(rt,{open:t,onOpenChange:o,children:e.jsxs(nt,{className:"sm:max-w-md",children:[e.jsxs(it,{children:[e.jsx(ot,{children:ge?"Reasignar Trabajo":"Asignar Trabajo"}),e.jsxs(dt,{children:[ge?"Reasignar a":"Asignar a"," ",$==null?void 0:$.first_name," ",$==null?void 0:$.last_name," a un trabajo el"," ",F(r,"EEEE, d MMMM, yyyy")]})]}),e.jsxs("div",{className:"space-y-4",children:[$&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium",children:"Técnico:"}),e.jsxs("span",{children:[$.first_name," ",$.last_name]}),e.jsx(X,{variant:"outline",children:$.department})]}),ge&&(a==null?void 0:a.jobs)&&e.jsxs("div",{className:"bg-yellow-50 p-3 rounded-lg border border-yellow-200",children:[e.jsx("div",{className:"text-sm font-medium text-yellow-800",children:"Asignación Actual:"}),e.jsx("div",{className:"text-sm text-yellow-700",children:a.jobs.title}),e.jsxs("div",{className:"text-xs text-yellow-600",children:["Estado: ",e.jsx(X,{variant:"secondary",children:a.status})]})]}),!d&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Seleccionar Trabajo"}),e.jsxs(jt,{value:i,onValueChange:n,children:[e.jsx(bt,{children:e.jsx(vt,{placeholder:"Elige un trabajo..."})}),e.jsx(_t,{children:J.length===0?e.jsx("div",{className:"p-2 text-sm text-muted-foreground",children:"No hay trabajos disponibles para esta fecha"}):J.map(w=>e.jsx(mt,{value:w.id,children:e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:w.title}),e.jsxs("div",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx($t,{className:"h-3 w-3"}),F(new Date(w.start_time),"HH:mm")," - ",F(new Date(w.end_time),"HH:mm")]})]})})},w.id))})]})]}),i&&$&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium",children:["Seleccionar Rol (",$.department,")"]}),e.jsxs(jt,{value:b,onValueChange:D,children:[e.jsx(bt,{children:e.jsx(vt,{placeholder:"Elige un rol..."})}),e.jsx(_t,{children:Pe.map(w=>e.jsx(mt,{value:w.code,children:w.label},w.code))})]})]}),i&&b&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs(js,{value:p,onValueChange:w=>l(w),className:"w-full",children:[e.jsxs(bs,{className:"grid w-full grid-cols-3",children:[e.jsxs(qt,{value:"full",children:[e.jsx(Rs,{className:"h-4 w-4 mr-2"}),"Completo"]}),e.jsxs(qt,{value:"single",children:[e.jsx(ut,{className:"h-4 w-4 mr-2"}),"Día Suelto"]}),e.jsxs(qt,{value:"multi",children:[e.jsx(ar,{className:"h-4 w-4 mr-2"}),"Varios Días"]})]}),e.jsx(is,{value:"full",className:"mt-4",children:e.jsxs("div",{className:"p-4 bg-muted/50 rounded-lg border border-border text-sm text-muted-foreground flex items-center gap-3",children:[e.jsx(Rs,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:"Asignación Completa"}),e.jsx("p",{children:"El técnico será asignado a todos los días de este trabajo."})]})]})}),e.jsx(is,{value:"single",className:"mt-4 space-y-4",children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Seleccionar Fecha"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(Nt,{children:[e.jsx(Ct,{asChild:!0,children:e.jsxs(Z,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(ut,{className:"mr-2 h-4 w-4"}),u?F(u,"PPP"):e.jsx("span",{children:"Elige una fecha"})]})}),e.jsx(Mt,{className:"w-auto p-0",align:"start",children:e.jsx(wt,{mode:"single",selected:u??void 0,onSelect:w=>{w&&qe(w)&&v(w)},disabled:w=>!qe(w),initialFocus:!0})})]})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Crea una asignación de un solo día para la fecha seleccionada."})]})}),e.jsx(is,{value:"multi",className:"mt-4 space-y-4",children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Seleccionar Días"}),e.jsx("div",{className:"border rounded-md p-2 flex justify-center",children:e.jsx(wt,{mode:"multiple",selected:S,onSelect:w=>B((w||[]).filter(M=>qe(M))),disabled:w=>!qe(w),className:"rounded-md border-none shadow-none",numberOfMonths:1})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Selecciona varios días para esta asignación."})]})})]}),e.jsxs("div",{className:"flex items-center space-x-2 pt-2 border-t",children:[e.jsx(Vs,{id:"confirm-assignment",checked:K,onCheckedChange:me}),e.jsx("label",{htmlFor:"confirm-assignment",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Asignar como confirmado (omitir invitación)"})]})]}),Y&&e.jsxs("div",{className:"bg-muted p-3 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ut,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:Y.title}),e.jsx(X,{variant:"secondary",children:Y.status})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($t,{className:"h-3 w-3"}),F(new Date(Y.start_time),"HH:mm")," - ",F(new Date(Y.end_time),"HH:mm")]})}),b&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["Role: ",Bt(b)]}),K&&e.jsx("div",{className:"text-xs text-green-600 mt-1 font-medium",children:"Se asignará como confirmado"}),p==="single"&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["Cobertura de un solo día para ",u?F(u,"PPP"):F(r,"PPP")]}),p==="multi"&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:[S.length," día(s) seleccionado(s) para cobertura de un solo día"]})]})]}),e.jsxs(lt,{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"mr-auto",children:ge&&e.jsx(Z,{variant:"destructive",onClick:te,disabled:g,children:g?e.jsxs(e.Fragment,{children:[e.jsx(Kt,{className:"mr-2 h-4 w-4 animate-spin"}),"Eliminando..."]}):"Eliminar Asignación"})}),e.jsx(Z,{variant:"outline",onClick:o,children:"Cancelar"}),e.jsx(Z,{onClick:A,disabled:!i||!b||q,children:q?e.jsxs(e.Fragment,{children:[e.jsx(Kt,{className:"mr-2 h-4 w-4 animate-spin"}),"Asignando..."]}):`${ge?"Reasignar":"Asignar"} Trabajo`})]})]})}),e.jsx(Va,{open:!!N,onOpenChange:w=>{w||O(null)},children:e.jsxs(Ya,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(Za,{children:[e.jsx(Ga,{children:N!=null&&N.result.hasHardConflict?"⛔ Conflicto de Horario":"⚠️ Conflicto Potencial"}),e.jsx(Xa,{asChild:!0,children:e.jsx("div",{className:"space-y-3",children:N&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-sm",children:[$?`${$.first_name} ${$.last_name}`:"Este técnico"," tiene conflictos con ",e.jsx("strong",{children:Y==null?void 0:Y.title}),N.mode==="full"&&Fe?` (${Fe})`:"",N.mode!=="full"&&Je?` el ${Je}`:"",":"]}),N.result.hardConflicts.length>0&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded p-3",children:[e.jsx("div",{className:"font-semibold text-red-900 mb-2",children:"Asignaciones Confirmadas:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1",children:N.result.hardConflicts.map((w,M)=>e.jsxs("li",{className:"text-red-800 text-sm",children:[e.jsx("strong",{children:w.title})," ","(",ze(w.start_time,w.end_time),")"]},M))})]}),N.result.softConflicts.length>0&&e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded p-3",children:[e.jsx("div",{className:"font-semibold text-yellow-900 mb-2",children:"Invitaciones Pendientes:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1",children:N.result.softConflicts.map((w,M)=>e.jsxs("li",{className:"text-yellow-800 text-sm",children:[e.jsx("strong",{children:w.title})," ","(",ze(w.start_time,w.end_time),")"]},M))}),e.jsx("p",{className:"text-xs text-yellow-700 mt-2",children:"El técnico aún no ha respondido a estas invitaciones."})]}),N.result.unavailabilityConflicts.length>0&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded p-3",children:[e.jsx("div",{className:"font-semibold text-red-900 mb-2",children:"Fechas No Disponibles:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1",children:N.result.unavailabilityConflicts.map((w,M)=>e.jsxs("li",{className:"text-red-800 text-sm",children:[Re(w.date)," - ",w.reason,w.notes&&e.jsxs("span",{className:"text-xs",children:[" (",w.notes,")"]})]},M))})]}),e.jsx("div",{className:"text-sm text-gray-600 mt-3",children:N.result.hasHardConflict?"Continuar creará una doble reserva. ¿Estás seguro?":"El técnico podría no estar disponible. ¿Quieres continuar de todos modos?"})]})})})]}),e.jsxs(er,{children:[e.jsx(tr,{onClick:()=>O(null),children:"Volver"}),e.jsx(sr,{onClick:()=>{O(null),he(!0)},className:N!=null&&N.result.hasHardConflict?"bg-red-600 hover:bg-red-700":"",children:N!=null&&N.result.hasHardConflict?"Forzar asignación de todos modos":"Continuar de todos modos"})]})]})})]})},Ls=[["optimized-matrix-assignments"],["matrix-assignments"]],Rr=({open:t,onClose:o,technicianId:s,date:r,assignment:m,action:a})=>{const[d,i]=c.useState(""),n=pt(),{data:b}=He({queryKey:["technician",s],queryFn:async()=>{const{data:v,error:S}=await I.from("profiles").select("first_name, last_name, department").eq("id",s).single();if(S)throw S;return v},enabled:t&&!!s}),D=Ns({mutationFn:async({jobId:v,techId:S,actionType:B,isTourAssignment:K})=>{const{data:x,error:q}=await I.rpc("manage_assignment_lifecycle",{p_job_id:v,p_technician_id:S,p_action:B,p_delete_mode:K?"hard":"soft",p_metadata:{notes:d,source:"matrix_dialog"}});if(q)throw new Error(q.message||"Database operation failed");if(!(x!=null&&x.success)){const k=(x==null?void 0:x.message)||(x==null?void 0:x.error)||"Operation failed";throw new Error(k)}return x},onMutate:async v=>{await n.cancelQueries({queryKey:["optimized-matrix-assignments"]}),await n.cancelQueries({queryKey:["matrix-assignments"]}),await n.cancelQueries({queryKey:["job-assignments",v.jobId]});const S={};Ls.forEach(K=>{S[JSON.stringify(K)]=n.getQueryData(K)}),S[JSON.stringify(["job-assignments",v.jobId])]=n.getQueryData(["job-assignments",v.jobId]);const B=v.actionType==="confirm"?"confirmed":"declined";return[...Ls,["job-assignments",v.jobId]].forEach(K=>{try{n.setQueryData(K,x=>x&&(Array.isArray(x)?x.map(q=>q.job_id===v.jobId&&q.technician_id===v.techId?{...q,status:B,response_time:new Date().toISOString()}:q):x))}catch(x){typeof window<"u"&&(x==null||x.name)}}),{previousData:S,jobId:v.jobId}},onError:(v,S,B)=>{B!=null&&B.previousData&&Object.entries(B.previousData).forEach(([x,q])=>{try{const k=JSON.parse(x);n.setQueryData(k,q)}catch{}});const K=v instanceof Error?v.message:"Error desconocido";Ke.error(`Error al actualizar la asignación: ${K}`)},onSuccess:(v,S)=>{if(n.invalidateQueries({queryKey:["optimized-matrix-assignments"]}),n.invalidateQueries({queryKey:["matrix-assignments"]}),n.invalidateQueries({queryKey:["job-assignments",S.jobId]}),n.invalidateQueries({queryKey:["job-details",S.jobId]}),n.invalidateQueries({queryKey:["jobs"]}),n.invalidateQueries({queryKey:["optimized-jobs"]}),S.actionType==="confirm"){const K=`${(b==null?void 0:b.first_name)??""} ${(b==null?void 0:b.last_name)??""}`.trim();I.functions.invoke("push",{body:{action:"broadcast",type:"job.assignment.confirmed",job_id:S.jobId,recipient_id:S.techId,recipient_name:K||void 0}}).catch(()=>{})}const B=S.actionType==="confirm"?"confirmada":"rechazada";Ke.success(`Asignación ${B} para ${(b==null?void 0:b.first_name)??""} ${(b==null?void 0:b.last_name)??""}`),o()}}),p=c.useCallback(async()=>{if(!(m!=null&&m.job_id)){Ke.error("No se encontró asignación");return}const{data:v}=await I.from("job_assignments").select("assignment_source").eq("job_id",m.job_id).eq("technician_id",s).maybeSingle(),S=(v==null?void 0:v.assignment_source)==="tour";D.mutate({jobId:m.job_id,techId:s,actionType:a,isTourAssignment:S})},[m==null?void 0:m.job_id,s,a,D]),u={confirm:{title:"Confirmar Asignación",description:"Confirmar esta asignación como definitiva",buttonText:"Confirmar Asignación",buttonClass:"bg-green-600 hover:bg-green-700",icon:e.jsx(Ks,{className:"mr-2 h-4 w-4"})},decline:{title:"Rechazar Asignación",description:"Rechazar esta asignación",buttonText:"Rechazar Asignación",buttonClass:"bg-red-600 hover:bg-red-700",icon:e.jsx(It,{className:"mr-2 h-4 w-4"})}}[a];return e.jsx(rt,{open:t,onOpenChange:o,children:e.jsxs(nt,{className:"sm:max-w-md",children:[e.jsxs(it,{children:[e.jsx(ot,{children:u.title}),e.jsxs(dt,{children:[u.description," para ",b==null?void 0:b.first_name," ",b==null?void 0:b.last_name," el"," ",F(r,"EEEE, d MMMM, yyyy")]})]}),e.jsxs("div",{className:"space-y-4",children:[b&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium",children:"Técnico:"}),e.jsxs("span",{children:[b.first_name," ",b.last_name]}),e.jsx(X,{variant:"outline",children:b.department})]}),(m==null?void 0:m.jobs)&&e.jsxs("div",{className:"bg-muted p-3 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ut,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:m.jobs.title}),e.jsx(X,{variant:"secondary",children:Bt(m.sound_role||m.lights_role||m.video_role)})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Estado actual: ",e.jsx(X,{variant:"secondary",children:m.status})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Notas (Opcional)"}),e.jsx(Js,{placeholder:`Añadir notas sobre esta ${a==="confirm"?"confirmación":"cancelación"}...`,value:d,onChange:v=>i(v.target.value),rows:3})]})]}),e.jsxs(lt,{children:[e.jsx(Z,{variant:"outline",onClick:o,children:"Cancelar"}),e.jsx(Z,{onClick:p,disabled:D.isPending,className:u.buttonClass,children:D.isPending?e.jsxs(e.Fragment,{children:[e.jsx(Kt,{className:"mr-2 h-4 w-4 animate-spin"}),"Procesando..."]}):e.jsxs(e.Fragment,{children:[u.icon,u.buttonText]})})]})]})})},Fr=({open:t,onClose:o,technicianId:s,selectedDate:r,selectedCells:m})=>{const[a,d]=c.useState(!1),{data:i}=He({queryKey:["technician",s],queryFn:async()=>{const{data:b,error:D}=await I.from("profiles").select("first_name, last_name, department").eq("id",s).single();if(D)throw D;return b},enabled:t&&!!s}),n=async()=>{d(!0);try{const b="day_off",D=new Set;D.add(F(r,"yyyy-MM-dd"));for(const v of m){const S=`${s}-`;if(!v.startsWith(S))continue;const B=v.slice(S.length);/^\d{4}-\d{2}-\d{2}$/.test(B)&&D.add(B)}const p=Array.from(D).map(v=>({technician_id:s,date:v,status:b})),{error:l}=await I.from("technician_availability").upsert(p,{onConflict:"technician_id,date"});if(l)throw l;const u=D.size;Ke.success(`Marcado ${i==null?void 0:i.first_name} ${i==null?void 0:i.last_name} como no disponible por ${u} día${u>1?"s":""}`),window.dispatchEvent(new CustomEvent("assignment-updated")),o()}catch{Ke.error("Error al marcar como no disponible")}finally{d(!1)}};return e.jsx(rt,{open:t,onOpenChange:o,children:e.jsxs(nt,{className:"sm:max-w-md",children:[e.jsxs(it,{children:[e.jsx(ot,{children:"Marcar como No Disponible"}),e.jsxs(dt,{children:["Marcar a ",i==null?void 0:i.first_name," ",i==null?void 0:i.last_name," como no disponible el"," ",F(r,"EEEE, d MMMM, yyyy")]})]}),e.jsxs("div",{className:"space-y-4",children:[i&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium",children:"Técnico:"}),e.jsxs("span",{children:[i.first_name," ",i.last_name]}),e.jsx(X,{variant:"outline",children:i.department})]}),e.jsxs("div",{className:"bg-muted p-3 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ut,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"Fecha"})]}),e.jsx("div",{className:"text-sm",children:F(r,"EEEE, d MMMM, yyyy")}),m.length>1&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:[m.length," fechas seleccionadas para actualización masiva"]})]})]}),e.jsxs(lt,{children:[e.jsx(Z,{variant:"outline",onClick:o,children:"Cancelar"}),e.jsx(Z,{onClick:n,disabled:a,children:a?e.jsxs(e.Fragment,{children:[e.jsx(Kt,{className:"mr-2 h-4 w-4 animate-spin"}),"Marcando..."]}):"Marcar No Disponible"})]})]})})},Pr=({open:t,onClose:o,technicianName:s,jobTitle:r,technicianDepartment:m,onSubmit:a,defaultSingleDay:d,jobStartTimeIso:i,jobEndTimeIso:n,defaultDateIso:b})=>{const[D,p]=c.useState(""),[l,u]=c.useState(""),[v,S]=c.useState(d?"single":"full"),[B,K]=c.useState(()=>{if(b)try{return new Date(`${b}T00:00:00`)}catch{return null}return null}),[x,q]=c.useState(()=>{if(b)try{return[new Date(`${b}T00:00:00`)]}catch{return[]}return[]}),k=()=>{const O=D.trim(),$=l.trim();if(v==="multi"){const J=Array.from(new Set((x||[]).map(Y=>F(Y,"yyyy-MM-dd"))));a({role:O,message:$,singleDay:!0,dates:J});return}if(v==="single"){const J=B?F(B,"yyyy-MM-dd"):b||null;a({role:O,message:$,singleDay:!0,dates:J?[J]:void 0});return}a({role:O,message:$,singleDay:!1})},g=As(String(m));W.useEffect(()=>{t&&g.length&&!D&&p(g[0].code)},[t,m]),W.useEffect(()=>{t&&S(d?"single":"full")},[t,d]);const _=c.useMemo(()=>{const O=i?new Date(i):null,$=n?new Date(n):O;return O&&O.setHours(0,0,0,0),$&&$.setHours(0,0,0,0),{start:O,end:$}},[i,n]),N=O=>{if(!_.start||!_.end)return!0;const $=new Date(O);return $.setHours(0,0,0,0),$>=_.start&&$<=_.end};return e.jsx(rt,{open:t,onOpenChange:O=>!O&&o(),children:e.jsxs(nt,{children:[e.jsx(it,{children:e.jsxs(ot,{children:["Enviar Oferta ",r?`- ${r}`:""]})}),e.jsxs("div",{className:"space-y-4 mt-2",children:[e.jsxs("div",{children:[e.jsx(Ye,{children:"Técnico"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s})]}),e.jsxs("div",{children:[e.jsx(Ye,{htmlFor:"role",children:"Rol"}),e.jsxs(jt,{value:D,onValueChange:p,children:[e.jsx(bt,{id:"role",children:e.jsx(vt,{placeholder:"Seleccionar rol"})}),e.jsx(_t,{children:g.map(O=>e.jsx(mt,{value:O.code,children:O.label},O.code))})]})]}),e.jsxs("div",{children:[e.jsx(Ye,{htmlFor:"message",children:"Mensaje (opcional)"}),e.jsx(Js,{id:"message",placeholder:"Detalles adicionales para incluir en el correo",value:l,onChange:O=>u(O.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ye,{children:"Cobertura"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"offer-coverage",checked:v==="full",onChange:()=>S("full")}),e.jsx("span",{children:"Duración completa del trabajo"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"offer-coverage",checked:v==="single",onChange:()=>S("single")}),e.jsx("span",{children:"Día suelto"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"offer-coverage",checked:v==="multi",onChange:()=>S("multi")}),e.jsx("span",{children:"Varios días"})]})]})]}),v==="single"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Nt,{children:[e.jsx(Ct,{asChild:!0,children:e.jsxs(Z,{variant:"outline",className:"gap-2",children:[e.jsx(ut,{className:"h-4 w-4"}),B?F(B,"PPP"):b||"Seleccionar fecha"]})}),e.jsx(Mt,{className:"w-auto p-0",align:"start",children:e.jsx(wt,{mode:"single",selected:B??void 0,onSelect:O=>{O&&N(O)&&K(O)},disabled:O=>!N(O),initialFocus:!0})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Crea una oferta de un solo día para la fecha elegida."})]}),v==="multi"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(wt,{mode:"multiple",selected:x,onSelect:O=>q((O||[]).filter($=>N($))),disabled:O=>!N(O),numberOfMonths:2}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Crea una oferta de un solo día por cada fecha seleccionada."})]})]}),e.jsxs(lt,{children:[e.jsx(Z,{variant:"ghost",onClick:o,children:"Cancelar"}),e.jsx(Z,{onClick:k,disabled:!D.trim(),children:"Enviar Oferta"})]})]})})},zr=({isFetching:t,isInitialLoading:o,TECHNICIAN_WIDTH:s,HEADER_HEIGHT:r,CELL_WIDTH:m,CELL_HEIGHT:a,matrixWidth:d,matrixHeight:i,dateHeadersRef:n,technicianScrollRef:b,mainScrollRef:D,visibleCols:p,visibleRows:l,dates:u,technicians:v,orderedTechnicians:S,fridgeSet:B,allowDirectAssign:K,mobile:x,canNavLeft:q,canNavRight:k,handleMobileNav:g,handleDateHeadersScroll:_,handleTechnicianScroll:N,handleMainScroll:O,cycleTechSort:$,getSortLabel:J,isManagementUser:Y,setCreateUserOpen:Pe,createUserOpen:ge,qc:Ie,setSortJobId:G,getJobsForDate:he,getAssignmentForCell:A,getAvailabilityForCell:te,selectedCells:me,staffingMaps:ie,handleCellSelect:qe,handleCellClick:ze,handleCellPrefetch:Re,handleOptimisticUpdate:Fe,incrementCellRender:Je,declinedJobsByTech:w,cellAction:M,currentTechnician:z,closeDialogs:ve,handleJobSelected:Be,handleStaffingActionSelected:we,forcedStaffingAction:Ve,forcedStaffingChannel:Qe,jobs:De,offerChannel:We,toast:oe,sendStaffingEmail:Le,checkTimeConflictEnhanced:T,availabilityDialog:U,setAvailabilityDialog:pe,availabilityCoverage:re,setAvailabilityCoverage:ye,availabilitySingleDate:Se,setAvailabilitySingleDate:V,availabilityMultiDates:ke,setAvailabilityMultiDates:Te,availabilitySending:P,setAvailabilitySending:ne,handleEmailError:Ze,conflictDialog:Ce,setConflictDialog:Xe,isGlobalCellSelected:h,techMedalRankings:de,techLastYearMedalRankings:ue})=>{var fe,ee,Ee,Ne,_e;return e.jsxs("div",{className:"matrix-layout relative",children:[t&&!o&&e.jsxs("div",{className:"pointer-events-none absolute top-2 right-4 flex items-center gap-2 text-xs text-muted-foreground bg-background/80 backdrop-blur rounded-full px-3 py-1 shadow-sm border border-border/60",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-primary animate-pulse","aria-hidden":"true"}),e.jsx("span",{children:"Actualizando..."})]}),e.jsx("div",{className:"matrix-corner",style:{width:s,height:r},children:e.jsxs("div",{className:"flex flex-col h-full bg-card border-r border-b",children:[e.jsxs("div",{className:"flex items-center justify-between px-2 py-1 border-b",children:[e.jsxs("button",{className:"flex items-center gap-1 font-semibold hover:text-primary transition-colors cursor-pointer group",onClick:$,title:"Cambia el orden de técnicos",children:[x?e.jsx("span",{className:"text-sm",children:"Técnicos"}):e.jsx("span",{children:"Técnicos"}),e.jsx(mr,{className:"h-3.5 w-3.5 opacity-50 group-hover:opacity-100"})]}),Y&&(x?e.jsx(Z,{size:"sm",variant:"outline",className:"h-7 w-7 p-0",onClick:()=>Pe(!0),"aria-label":"Añadir usuario",children:e.jsx(Ds,{className:"h-3.5 w-3.5"})}):e.jsxs(Z,{size:"sm",variant:"outline",className:"h-7 px-2",onClick:()=>Pe(!0),children:[e.jsx(Ds,{className:"h-3.5 w-3.5 mr-1"})," Añadir"]}))]}),J()&&e.jsx("div",{className:"flex items-center justify-center px-2 py-1 flex-1",children:e.jsx("span",{className:"text-xs font-medium text-muted-foreground bg-accent/50 px-2 py-0.5 rounded",children:J()})})]})}),e.jsxs("div",{ref:n,className:"matrix-date-headers",style:{left:s,height:r,width:`calc(100% - ${s}px)`},onScroll:_,children:[x&&e.jsxs("div",{className:"pointer-events-none absolute inset-0 flex items-center justify-between px-1",children:[e.jsxs("button",{"aria-label":"Fechas anteriores",className:`pointer-events-auto rounded-full bg-background/80 border shadow h-8 w-8 flex items-center justify-center ${q?"opacity-100":"opacity-40"}`,onClick:E=>{E.stopPropagation(),g("left")},disabled:!q,children:[e.jsx("span",{className:"sr-only",children:"Anterior"}),"<"]}),e.jsxs("button",{"aria-label":"Fechas siguientes",className:`pointer-events-auto rounded-full bg-background/80 border shadow h-8 w-8 flex items-center justify-center ${k?"opacity-100":"opacity-40"}`,onClick:E=>{E.stopPropagation(),g("right")},disabled:!k,children:[e.jsx("span",{className:"sr-only",children:"Siguiente"}),">"]})]}),e.jsxs("div",{style:{width:d,height:"100%",display:"flex",position:"relative"},children:[e.jsx("div",{style:{width:p.start*m}}),u.slice(p.start,p.end+1).map((E,Q)=>e.jsx(Er,{date:E,width:m,jobs:he(E),technicianIds:v.map(se=>se.id),onJobClick:se=>{G(ce=>ce===se?null:se)}},p.start+Q)),e.jsx("div",{style:{width:Math.max(0,(u.length-(p.end+1))*m)}})]})]}),e.jsx("div",{className:"matrix-technician-column",style:{width:s,top:r,height:`calc(100% - ${r}px)`},children:e.jsx("div",{ref:b,className:"matrix-technician-scroll",onScroll:N,children:e.jsxs("div",{style:{height:i,position:"relative"},children:[e.jsx("div",{style:{height:l.start*a}}),S.slice(l.start,l.end+1).map(E=>e.jsx(_r,{technician:E,height:a,isFridge:(B==null?void 0:B.has(E.id))||!1,compact:x,medalRank:de.get(E.id),lastYearMedalRank:ue.get(E.id)},E.id))]})})}),e.jsx("div",{className:"matrix-main-area",style:{left:s,top:r,width:`calc(100% - ${s}px)`,height:`calc(100% - ${r}px)`},children:e.jsx(hs,{children:e.jsx("div",{ref:D,className:"matrix-main-scroll",onScroll:O,children:e.jsx("div",{className:"matrix-grid",style:{width:d,height:i},children:S.slice(l.start,l.end+1).map((E,Q)=>{const se=l.start+Q;return e.jsx("div",{className:"matrix-row",style:{transform:`translate3d(0, ${se*a}px, 0)`,height:a},children:u.slice(p.start,p.end+1).map((ce,ae)=>{const le=p.start+ae,$e=A(E.id,ce),tt=te(E.id,ce),je=`${E.id}-${F(ce,"yyyy-MM-dd")}`,Ae=me.has(je),Oe=$e==null?void 0:$e.job_id,Ue=Oe?`${Oe}-${E.id}`:"",ft=`${E.id}-${F(ce,"yyyy-MM-dd")}`,Qt=Oe&&(ie!=null&&ie.byJob.get(Ue))?ie==null?void 0:ie.byJob.get(Ue):null,St=ie!=null&&ie.byDate.get(ft)?ie==null?void 0:ie.byDate.get(ft):null;return e.jsx("div",{className:"matrix-cell-wrapper",style:{transform:`translate3d(${le*m}px, 0, 0)`,width:m,height:a},children:e.jsx(ea,{technician:E,date:ce,assignment:$e,availability:tt,width:m,height:a,isSelected:Ae,onSelect:st=>qe(E.id,ce,st),onClick:(st,xt)=>ze(E.id,ce,st,xt),onPrefetch:()=>Re(E.id),onOptimisticUpdate:st=>$e&&Fe(E.id,$e.job_id,st),onRender:()=>Je(),jobId:Oe,declinedJobIdsSet:w.get(E.id)||new Set,allowDirectAssign:K,staffingStatusProvided:Qt,staffingStatusByDateProvided:St,isFridge:(B==null?void 0:B.has(E.id))||!1,mobile:x})},le)})},E.id)})})})})}),(M==null?void 0:M.type)==="select-job"&&z&&e.jsx(Dr,{open:!0,onClose:ve,onJobSelected:Be,technicianName:`${z.first_name} ${z.last_name}`,date:M.date,availableJobs:he(M.date)}),(M==null?void 0:M.type)==="select-job-for-staffing"&&z&&e.jsx(Tr,{open:!0,onClose:ve,onStaffingActionSelected:we,technicianId:M.technicianId,technicianName:`${z.first_name} ${z.last_name}`,date:M.date,availableJobs:he(M.date),declinedJobIds:Array.from(w.get(M.technicianId)||[]),preselectedJobId:M.selectedJobId||null,forcedAction:Ve,forcedChannel:Qe}),(M==null?void 0:M.type)==="assign"&&e.jsx($r,{open:!0,onClose:ve,technicianId:M.technicianId,date:M.date,availableJobs:he(M.date),existingAssignment:M.assignment,preSelectedJobId:M.selectedJobId}),((M==null?void 0:M.type)==="confirm"||(M==null?void 0:M.type)==="decline")&&e.jsx(Rr,{open:!0,onClose:ve,technicianId:M.technicianId,date:M.date,assignment:M.assignment,action:M.type}),(M==null?void 0:M.type)==="offer-details"&&z&&e.jsx(Pr,{open:!0,onClose:ve,technicianName:`${z.first_name} ${z.last_name}`,jobTitle:(fe=De.find(E=>E.id===M.selectedJobId))==null?void 0:fe.title,technicianDepartment:z.department,defaultSingleDay:M.singleDay,jobStartTimeIso:(ee=De.find(E=>E.id===M.selectedJobId))==null?void 0:ee.start_time,jobEndTimeIso:(Ee=De.find(E=>E.id===M.selectedJobId))==null?void 0:Ee.end_time,defaultDateIso:F(M.date,"yyyy-MM-dd"),onSubmit:({role:E,message:Q,singleDay:se,dates:ce})=>{M.selectedJobId&&(async()=>{const ae=M.selectedJobId,le=z.id,$e=We;if(se){const je=Array.isArray(ce)&&ce.length?ce:[F(M.date,"yyyy-MM-dd")];for(const Oe of je){const Ue=await T(le,ae,{targetDateIso:Oe,singleDayOnly:!0,includePending:!0});if(Ue.hasHardConflict){const ft=Ue.hardConflicts[0];oe({title:"Conflicto de horarios",description:`(${Oe}) Ya tiene confirmado: ${ft.title}`,variant:"destructive"});return}}const Ae={job_id:ae,profile_id:le,phase:"offer",role:E,message:Q,channel:$e,single_day:!0,dates:je};je.length===1&&(Ae.target_date=je[0]),Le(Ae,{onSuccess:Oe=>{const Ue=(Oe==null?void 0:Oe.channel)||$e;oe({title:"Oferta enviada",description:`Oferta de ${E} enviada por ${Ue} (${je.length} día${je.length>1?"s":""}).`}),ve()},onError:Oe=>{oe({title:"No se pudo enviar la oferta",description:Oe.message,variant:"destructive"})}});return}const tt=await T(le,ae,{includePending:!0});if(tt.hasHardConflict){const je=tt.hardConflicts[0];oe({title:"Conflicto de horarios",description:`Ya tiene confirmado: ${je.title}`,variant:"destructive"});return}Le({job_id:ae,profile_id:le,phase:"offer",role:E,message:Q,channel:$e,single_day:!1},{onSuccess:je=>{const Ae=(je==null?void 0:je.channel)||$e;oe({title:"Oferta enviada",description:`Oferta de ${E} enviada por ${Ae}.`}),ve()},onError:je=>{oe({title:"No se pudo enviar la oferta",description:je.message,variant:"destructive"})}})})()}}),(U==null?void 0:U.open)&&e.jsx(rt,{open:!0,onOpenChange:E=>{E||pe(null)},children:e.jsxs(nt,{children:[e.jsxs(it,{children:[e.jsx(ot,{children:"Enviar solicitud de disponibilidad"}),e.jsxs(dt,{children:["Pide disponibilidad a ",z==null?void 0:z.first_name," ",z==null?void 0:z.last_name," vía"," ",U.channel==="whatsapp"?"WhatsApp":"Email","."]})]}),e.jsx("div",{className:"py-2",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"font-medium text-sm text-foreground",children:"Cobertura"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"availability-coverage",checked:re==="full",onChange:()=>ye("full")}),e.jsx("span",{children:"Todo el trabajo"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"availability-coverage",checked:re==="single",onChange:()=>ye("single")}),e.jsx("span",{children:"Un día"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"availability-coverage",checked:re==="multi",onChange:()=>ye("multi")}),e.jsx("span",{children:"Varios días"})]})]}),(()=>{const E=De.find(ae=>ae.id===U.jobId),Q=E!=null&&E.start_time?new Date(E.start_time):void 0,se=E!=null&&E.end_time?new Date(E.end_time):Q;Q&&Q.setHours(0,0,0,0),se&&se.setHours(0,0,0,0);const ce=ae=>{if(!Q||!se)return!0;const le=new Date(ae);return le.setHours(0,0,0,0),le>=Q&&le<=se};return e.jsxs(e.Fragment,{children:[re==="single"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Nt,{children:[e.jsx(Ct,{asChild:!0,children:e.jsxs(Z,{variant:"outline",className:"gap-2",children:[e.jsx(ut,{className:"h-4 w-4"}),Se?F(Se,"PPP"):U.dateIso]})}),e.jsx(Mt,{className:"w-auto p-0",align:"start",children:e.jsx(wt,{mode:"single",selected:Se??void 0,onSelect:ae=>{ae&&ce(ae)&&V(ae)},disabled:ae=>!ce(ae),initialFocus:!0})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Enviar solo para la fecha seleccionada."})]}),re==="multi"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(wt,{mode:"multiple",selected:ke,onSelect:ae=>Te((ae||[]).filter(le=>ce(le))),disabled:ae=>!ce(ae),numberOfMonths:2}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Crea una solicitud de un solo día por cada fecha seleccionada."})]})]})})()]})}),e.jsxs(lt,{children:[e.jsx(Z,{variant:"outline",onClick:()=>pe(null),children:"Cancelar"}),e.jsx(Z,{onClick:()=>{if(!U)return;ne(!0);const E=U.jobId,Q=U.profileId,se=U.channel;if(re==="full"){const le={job_id:E,profile_id:Q,phase:"availability",channel:se,single_day:!1};Le(le,{onSuccess:$e=>{ne(!1),pe(null),oe({title:"Solicitud enviada",description:`Solicitud de disponibilidad enviada por ${($e==null?void 0:$e.channel)||se}.`}),ve()},onError:$e=>Ze($e,le)});return}const ce=re==="single"?Se?[F(Se,"yyyy-MM-dd")]:[U.dateIso]:Array.from(new Set((ke||[]).map(le=>F(le,"yyyy-MM-dd"))));if(ce.length===0){ne(!1),oe({title:"Selecciona fecha(s)",description:"Elige al menos una fecha dentro del rango del trabajo.",variant:"destructive"});return}const ae={job_id:E,profile_id:Q,phase:"availability",channel:se,single_day:!0,dates:ce};(re==="single"||ce.length===1)&&(ae.target_date=ce[0]),Le(ae,{onSuccess:le=>{ne(!1),pe(null),oe({title:"Solicitud enviada",description:`Solicitud de disponibilidad enviada para ${ce.length} día${ce.length>1?"s":""} por ${(le==null?void 0:le.channel)||se}.`}),ve()},onError:le=>Ze(le,ae)})},disabled:P,children:P?"Enviando…":"Enviar"})]})]})}),(M==null?void 0:M.type)==="unavailable"&&e.jsx(Fr,{open:!0,onClose:ve,technicianId:M.technicianId,selectedDate:M.date,selectedCells:Array.from(me)}),Y&&e.jsx(Fa,{open:ge,onOpenChange:E=>{E||Ie.invalidateQueries({queryKey:["optimized-matrix-technicians"]}),Pe(E)}}),(Ce==null?void 0:Ce.open)&&e.jsx(rt,{open:!0,onOpenChange:E=>{E||Xe(null)},children:e.jsxs(nt,{className:"max-w-2xl",children:[e.jsxs(it,{children:[e.jsx(ot,{children:"Conflicto de agenda detectado"}),e.jsx(dt,{children:"El técnico tiene conflictos o no está disponible durante este periodo."})]}),e.jsxs("div",{className:"space-y-4 max-h-[400px] overflow-y-auto",children:[((Ne=Ce.details)==null?void 0:Ne.conflicts)&&Ce.details.conflicts.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-semibold text-red-600 dark:text-red-400",children:"Trabajos solapados:"}),e.jsx("div",{className:"space-y-1",children:Ce.details.conflicts.map((E,Q)=>e.jsxs("div",{className:"text-sm p-2 rounded bg-red-50 dark:bg-red-950/20 border border-red-200 dark:border-red-900",children:[e.jsx("div",{className:"font-medium text-red-900 dark:text-red-100",children:E.job_name||"Trabajo sin nombre"}),e.jsxs("div",{className:"text-red-700 dark:text-red-300",children:[E.job_type&&e.jsx("span",{className:"capitalize",children:E.job_type}),E.start_time&&E.end_time&&e.jsxs("span",{className:"ml-2",children:[new Date(E.start_time).toLocaleDateString()," -"," ",new Date(E.end_time).toLocaleDateString()]})]}),E.role&&e.jsxs("div",{className:"text-xs text-red-600 dark:text-red-400 mt-1",children:["Rol: ",E.role]})]},Q))})]}),((_e=Ce.details)==null?void 0:_e.unavailability)&&Ce.details.unavailability.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-semibold text-orange-600 dark:text-orange-400",children:"Fechas no disponibles:"}),e.jsx("div",{className:"space-y-1",children:Ce.details.unavailability.map((E,Q)=>e.jsxs("div",{className:"text-sm p-2 rounded bg-orange-50 dark:bg-orange-950/20 border border-orange-200 dark:border-orange-900",children:[e.jsx("div",{className:"text-orange-900 dark:text-orange-100",children:E.start_date&&E.end_date?e.jsxs(e.Fragment,{children:[new Date(E.start_date).toLocaleDateString()," -"," ",new Date(E.end_date).toLocaleDateString()]}):E.date?new Date(E.date).toLocaleDateString():"Fecha no especificada"}),E.reason&&e.jsx("div",{className:"text-xs text-orange-600 dark:text-orange-400 mt-1",children:E.reason})]},Q))})]})]}),e.jsxs(lt,{className:"gap-2",children:[e.jsx(Z,{variant:"outline",onClick:()=>Xe(null),children:"Cancelar"}),e.jsx(Z,{variant:"destructive",onClick:()=>{const E={...Ce.originalPayload,override_conflicts:!0};Xe(null),Le(E,{onSuccess:()=>{pe(null),ne(!1),oe({title:"Solicitud enviada",description:"Solicitud de staffing enviada (conflictos ignorados)"})},onError:Q=>{ne(!1),oe({title:"Error al enviar",description:Q.message||"No se pudo enviar la solicitud de staffing",variant:"destructive"})}})},children:"Enviar igualmente"})]})]})})]})},Or=({technicians:t,dates:o,jobs:s,onNearEdgeScroll:r,canExpandBefore:m=!1,canExpandAfter:a=!1,allowDirectAssign:d=!1,fridgeSet:i,cellWidth:n,cellHeight:b,technicianWidth:D,headerHeight:p,mobile:l=!1})=>{const[u,v]=c.useState(null),[S,B]=c.useState(new Set),{selectedCell:K,selectCell:x,clearSelection:q,isCellSelected:k}=Da();c.useRef(null);const g=c.useRef(null),_=c.useRef(null),N=c.useRef(null),[O,$]=c.useState(0),J=c.useRef(!1),Y=c.useRef({left:0,top:0}),[Pe,ge]=c.useState(!1),{userRole:Ie}=ws(),G=["admin","management"].includes(Ie||""),he=pt(),[A,te]=c.useState(null),[me,ie]=c.useState("default"),{startRenderTimer:qe,endRenderTimer:ze,incrementCellRender:Re}=gr("AssignmentMatrix");yr();const{toast:Fe}=Bs(),{mutate:Je}=Zs(),w=n??160,M=b??60,z=D??256,ve=p??80,{allAssignments:Be,getAssignmentForCell:we,getAvailabilityForCell:Ve,getJobsForDate:Qe,prefetchTechnicianData:De,updateAssignmentOptimistically:We,invalidateAssignmentQueries:oe,isInitialLoading:Le,isFetching:T}=xr({technicians:t,dates:o,jobs:s}),U=c.useMemo(()=>t.map(y=>y.id),[t]),{data:pe}=He({queryKey:["matrix-sort-job-statuses",A,U.join(",")],queryFn:async()=>{if(!A||!U.length)return new Map;const j=((L,C)=>{const H=[];for(let R=0;R<L.length;R+=C)H.push(L.slice(R,R+C));return H})(U,30),f=new Map;for(const L of j){const{data:C,error:H}=await I.rpc("get_assignment_matrix_staffing").eq("job_id",A).in("profile_id",L);H||(C||[]).forEach(R=>{const be=R.availability_status==="pending"?"requested":R.availability_status==="expired"?null:R.availability_status,xe=R.offer_status==="pending"?"sent":R.offer_status==="expired"?null:R.offer_status;f.set(R.profile_id,{availability_status:be,offer_status:xe})})}return f},enabled:!!A,staleTime:2e3,gcTime:6e4}),{data:re}=He({queryKey:["tech-residencias",U.join(",")],queryFn:async()=>{if(!U.length)return new Map;const{data:y,error:j}=await I.from("profiles").select("id, residencia").in("id",U);if(j)return new Map;const f=new Map;return(y||[]).forEach(L=>{f.set(L.id,L.residencia)}),f},enabled:U.length>0&&me==="location",staleTime:6e4,gcTime:3e5}),{data:ye}=He({queryKey:["tech-confirmed-counts-all-with-dept"],queryFn:async()=>{const y=new Date,j=new Date(y.getFullYear(),0,1).toISOString().split("T")[0],{data:f,error:L}=await I.from("timesheets").select("technician_id").eq("is_active",!0).gte("date",j);if(L)return{counts:new Map,departments:new Map};const C=new Map;(f||[]).forEach(be=>{const xe=C.get(be.technician_id)||0;C.set(be.technician_id,xe+1)});const H=Array.from(C.keys()),R=new Map;if(H.length>0){const{data:be,error:xe}=await I.from("profiles").select("id, department").in("id",H);!xe&&be&&be.forEach(Me=>{Me.department&&R.set(Me.id,Me.department)})}return{counts:C,departments:R}},enabled:!0,staleTime:6e4,gcTime:3e5}),{data:Se}=He({queryKey:["tech-last-year-counts-all-with-dept"],queryFn:async()=>{const j=new Date().getFullYear()-1,f=new Date(j,0,1).toISOString().split("T")[0],L=new Date(j,11,31).toISOString().split("T")[0],{data:C,error:H}=await I.from("timesheets").select("technician_id").eq("is_active",!0).gte("date",f).lte("date",L);if(H)return{counts:new Map,departments:new Map};const R=new Map;(C||[]).forEach(Me=>{const Ge=R.get(Me.technician_id)||0;R.set(Me.technician_id,Ge+1)});const be=Array.from(R.keys()),xe=new Map;if(be.length>0){const{data:Me,error:Ge}=await I.from("profiles").select("id, department").in("id",be);!Ge&&Me&&Me.forEach(at=>{at.department&&xe.set(at.id,at.department)})}return{counts:R,departments:xe}},enabled:!0,staleTime:6e4,gcTime:3e5});c.useEffect(()=>{const y=()=>{oe()};return window.addEventListener("assignment-updated",y),()=>window.removeEventListener("assignment-updated",y)},[oe]),c.useEffect(()=>{const y=()=>{he.invalidateQueries({queryKey:["staffing-matrix"]})};return window.addEventListener("staffing-updated",y),()=>window.removeEventListener("staffing-updated",y)},[he]),c.useEffect(()=>(qe(),()=>ze()),[qe,ze]);const V=o.length*w,ke=t.length*M,[Te,P]=c.useState({start:0,end:Math.min(t.length-1,20)}),[ne,Ze]=c.useState({start:0,end:Math.min(o.length-1,14)}),Ce=l?6:10,Xe=l?4:6,[h,de]=c.useState(!1),[ue,fe]=c.useState(!0),[ee,Ee]=c.useState(3),Ne=c.useCallback(()=>{if(!l)return;const y=_.current;if(!y)return;const j=y.scrollLeft,f=y.scrollWidth-y.clientWidth-1;de(j>2),fe(j<f)},[l]),_e=c.useCallback(()=>{const y=N.current;if(!y)return;const j=y.scrollTop,f=y.scrollLeft,L=y.clientHeight,C=y.clientWidth,H=Math.max(0,Math.floor(j/M)-Ce),R=Math.min(t.length-1,Math.floor((j+L)/M)+Ce),be=Math.max(0,Math.floor(f/w)-Xe),xe=Math.min(o.length-1,Math.floor((f+C)/w)+Xe);P(Me=>Me.start!==H||Me.end!==R?{start:H,end:R}:Me),Ze(Me=>Me.start!==be||Me.end!==xe?{start:be,end:xe}:Me)},[t.length,o.length]),E=c.useRef(!1),Q=c.useRef(!1),se=c.useCallback(()=>{if(!E.current){E.current=!0,_e();return}Q.current||(Q.current=!0,requestAnimationFrame(()=>{Q.current=!1,_e()}))},[_e]),ce=W.useMemo(()=>{const y=new Map;return Be==null||Be.forEach(j=>{(j==null?void 0:j.status)==="declined"&&j.technician_id&&j.job_id&&(y.has(j.technician_id)||y.set(j.technician_id,new Set),y.get(j.technician_id).add(j.job_id))}),y},[Be]),ae=c.useCallback((y,j,f)=>{J.current||(J.current=!0,requestAnimationFrame(()=>{try{f!=="dateHeaders"&&_.current&&(_.current.scrollLeft=y),f!=="main"&&N.current&&(N.current.scrollLeft=y),f!=="technician"&&g.current&&(g.current.scrollTop=j),f!=="main"&&N.current&&(N.current.scrollTop=j)}finally{J.current=!1}}))},[]),le=c.useCallback(y=>{if(J.current)return;const j=y.currentTarget.scrollLeft,f=y.currentTarget.scrollTop,L=le._previousScrollLeftRef||(le._previousScrollLeftRef={value:null}),C=L.value,H=C===null?0:j-C,R=C!==null&&H!==0;if(C!==null&&!R){ae(j,f,"main"),se();return}L.value=j;const be=R&&H<0,xe=R&&H>0,Me=y.currentTarget,Ge=Me.scrollWidth,at=Me.clientWidth,gt=Ge-at,Gt=j<200,Na=j>gt-200,Xt=performance.now(),es=le._lastEdgeRef||(le._lastEdgeRef={t:0});R&&Xt-es.t>300&&(be&&Gt&&m&&r?(r("before"),es.t=Xt):xe&&Na&&a&&r&&(r("after"),es.t=Xt)),ae(j,f,"main"),Y.current.left=j,Y.current.top=f,se()},[ae,m,a,r,se]),$e=c.useCallback(y=>{var f;if(J.current)return;const j=y.currentTarget.scrollLeft;ae(j,((f=N.current)==null?void 0:f.scrollTop)||0,"dateHeaders"),Y.current.left=j,Ne()},[ae,Ne]),tt=c.useCallback(y=>{var f;if(J.current)return;const j=y.currentTarget.scrollTop;ae(((f=N.current)==null?void 0:f.scrollLeft)||0,j,"technician"),Y.current.top=j,se()},[ae,se]),je=le,Ae=c.useMemo(()=>br($e,12),[$e]),Oe=tt;c.useEffect(()=>()=>{je!=null&&je.cancel&&je.cancel(),Ae!=null&&Ae.cancel&&Ae.cancel(),Oe!=null&&Oe.cancel&&Oe.cancel()},[Ae,je,Oe]);const[Ue,ft]=c.useState(null),[Qt,St]=c.useState("email"),[st,xt]=c.useState(null),[ct,Ft]=c.useState(null),[ta,Cs]=c.useState(null),Pt=c.useMemo(()=>{if((u==null?void 0:u.type)==="select-job-for-staffing"){if(u.intendedPhase)return u.intendedPhase;if(Ue)return"availability";if(st)return"offer"}},[u,Ue,st]),sa=c.useMemo(()=>{if((u==null?void 0:u.type)==="select-job-for-staffing"){if(u.intendedChannel)return u.intendedChannel;if(Pt==="availability")return Ue??void 0;if(Pt==="offer")return st??void 0}},[u,Pt,Ue,st]),Wt=c.useCallback(()=>{v(null),B(new Set),ft(null),xt(null),oe()},[oe]),aa=c.useCallback((y,j,f,L)=>{const C=we(y,j);if((i==null?void 0:i.has(y))&&(f==="select-job"||f==="assign"||f==="select-job-for-staffing"||f==="confirm"||f==="offer-details"||f==="offer-details-wa"||f==="availability-wa")){Fe({title:"En la nevera",description:"Este técnico está en la nevera y no puede ser asignado.",variant:"destructive"});return}if(!(!d&&(f==="select-job"||f==="assign"))){if(f==="availability-wa"){const R=L||(C==null?void 0:C.job_id)||void 0;R?(Ht("whatsapp"),Ft({open:!0,jobId:R,profileId:y,dateIso:F(j,"yyyy-MM-dd"),singleDay:!0,channel:"whatsapp"})):v({type:"select-job-for-staffing",technicianId:y,date:j,assignment:C,intendedPhase:"availability",intendedChannel:"whatsapp"});return}if(f==="availability-email"){const R=L||(C==null?void 0:C.job_id)||void 0;R?(Ht("email"),Ft({open:!0,jobId:R,profileId:y,dateIso:F(j,"yyyy-MM-dd"),singleDay:!0,channel:"email"})):(ft("email"),v({type:"select-job-for-staffing",technicianId:y,date:j,assignment:C}));return}if(f==="offer-details-wa"){const R=L||(C==null?void 0:C.job_id)||void 0;R?(St("whatsapp"),v({type:"offer-details",technicianId:y,date:j,assignment:C,selectedJobId:R})):(xt("whatsapp"),v({type:"select-job-for-staffing",technicianId:y,date:j,assignment:C}));return}if(f==="offer-details-email"){const R=L||(C==null?void 0:C.job_id)||void 0;R?(St("email"),v({type:"offer-details",technicianId:y,date:j,assignment:C,selectedJobId:R})):(xt("email"),v({type:"select-job-for-staffing",technicianId:y,date:j,assignment:C}));return}v({type:f,technicianId:y,date:j,assignment:C,selectedJobId:L})}},[we,d,i,Je,Wt,Fe]),ra=c.useCallback(y=>{(u==null?void 0:u.type)==="select-job"&&v({...u,type:"assign",selectedJobId:y})},[u]),na=c.useCallback((y,j,f)=>{const L=`${y}-${F(j,"yyyy-MM-dd")}`,C=new Set(S);f?(C.add(L),x(y,j)):(C.delete(L),k(y,j)&&q()),B(C)},[S,x,k,q]),ia=c.useCallback((y,j,f)=>{if((u==null?void 0:u.type)==="select-job-for-staffing"){const L=ce.get(u.technicianId);if(L!=null&&L.has(y)){Fe({title:"Trabajo ya rechazado",description:"Elige otro trabajo para este técnico en esta fecha.",variant:"destructive"});return}if(j==="offer"){St(st??"email"),xt(null),v({...u,type:"offer-details",selectedJobId:y,singleDay:f==null?void 0:f.singleDay});return}(async()=>{const C=u.technicianId,H=await Dt(C,y,{targetDateIso:F(u.date,"yyyy-MM-dd"),singleDayOnly:!!(f!=null&&f.singleDay),includePending:!0});if(H.hasHardConflict){const xe=H.hardConflicts[0];Fe({title:"Conflicto de horarios",description:`Ya tiene confirmado: ${xe.title} (${new Date(xe.start_time).toLocaleString()} - ${new Date(xe.end_time).toLocaleString()})`,variant:"destructive"});return}u.intendedPhase;const be=u.intendedChannel||Ue||"email";Ht(be),Ft({open:!0,jobId:y,profileId:C,dateIso:F(u.date,"yyyy-MM-dd"),singleDay:!!(f!=null&&f.singleDay),channel:be})})()}},[u,Je,Fe,Wt,Ue,st,ft]),oa=c.useCallback(y=>{De(y)},[De]),la=c.useCallback((y,j,f)=>{We(y,j,f)},[We]),Ms=c.useRef(!1),Ss=c.useCallback(()=>{if(!N.current||o.length===0)return!1;const y=new Date,j=o.findIndex(R=>At(R,y));if(j===-1)return!1;const f=N.current,L=f.clientWidth;if(L===0)return!1;let C=j*w-L/2+w/2;const H=V-L;return C=Math.max(0,Math.min(C,H)),f.scrollLeft=C,requestAnimationFrame(()=>{}),!0},[o,w,V]);c.useEffect(()=>{if(Ms.current||Le||o.length===0)return;const y=()=>{const f=Ss();!f&&O<5?($(L=>L+1),setTimeout(y,100*(O+1))):f&&($(0),Ms.current=!0)},j=setTimeout(y,50);return()=>clearTimeout(j)},[Ss,Le,o.length,O]),c.useEffect(()=>{_e(),E.current=!1},[t.length,o.length,se]);const Ut=c.useRef(null);c.useEffect(()=>{const y=Ut.current,j=N.current,f=_.current,L=g.current;if(!j||o.length===0){Ut.current=o.slice();return}const C=Y.current.left??j.scrollLeft,H=Y.current.top??j.scrollTop;let R=C;if(y&&y.length>0){const Me=y[0].toISOString(),Ge=o.findIndex(at=>at.toISOString()===Me);Ge>0?R=C+Ge*w:Ge===-1&&(R=C)}const be=(Me,Ge)=>{Me&&Math.abs(Me.scrollLeft-Ge)>1&&(Me.scrollLeft=Ge)};be(j,R),be(f,R),L&&Math.abs(L.scrollTop-H)>1&&(L.scrollTop=H),Math.abs(j.scrollTop-H)>1&&(j.scrollTop=H),Y.current.left=R,Y.current.top=H;const xe=le._previousScrollLeftRef||(le._previousScrollLeftRef={value:null});xe.value=R,Ut.current=o.slice()},[o,w]),c.useEffect(()=>{if(!l)return;const y=()=>{var L;const j=((L=_.current)==null?void 0:L.clientWidth)||0,f=Math.max(3,Math.min(4,Math.floor(j/w))||3);Ee(f)};return y(),window.addEventListener("resize",y),()=>window.removeEventListener("resize",y)},[l,w]),c.useEffect(()=>{l&&Ne()},[l,ne,o.length,Ne]);const ca=c.useCallback(y=>{const j=_.current,f=N.current;if(!j||!f)return;const L=ee*w*(y==="left"?-1:1),C=Math.max(0,Math.min(j.scrollLeft+L,j.scrollWidth-j.clientWidth));j.scrollTo({left:C,behavior:"smooth"}),f.scrollTo({left:C,top:f.scrollTop,behavior:"smooth"})},[ee,w]),zt=c.useMemo(()=>{let y=[...t];if(A){const j=new Map;t.forEach((L,C)=>j.set(L.id,C));const f=new Map;return Be==null||Be.forEach(L=>{if(L.job_id!==A)return;const C=f.get(L.technician_id)||0,H=(L.status||"").toLowerCase(),R=H==="confirmed"?3:H==="invited"?1:0;f.set(L.technician_id,Math.max(C,R))}),pe&&pe.size&&t.forEach(L=>{const C=pe.get(L.id);if(!C)return;const H=f.get(L.id)||0;let R=0;C.offer_status==="confirmed"?R=Math.max(R,2):C.offer_status==="sent"&&(R=Math.max(R,1.5)),C.availability_status==="confirmed"?R=Math.max(R,1.2):C.availability_status==="requested"&&(R=Math.max(R,1)),R>0&&f.set(L.id,Math.max(H,R))}),y.sort((L,C)=>{const H=f.get(L.id)||0,R=f.get(C.id)||0;return R!==H?R-H:j.get(L.id)-j.get(C.id)}),y}switch(me){case"location":y.sort((j,f)=>{const L=(re==null?void 0:re.get(j.id))||"",C=(re==null?void 0:re.get(f.id))||"";if(L&&!C)return-1;if(!L&&C)return 1;if(!L&&!C)return j.first_name.localeCompare(f.first_name);const H=at=>{const gt=at.split(",").map(Gt=>Gt.trim());return gt.length>1?{city:gt[0],country:gt[1]}:{city:gt[0],country:"España"}},R=H(L),be=H(C),xe=R.country==="España"||R.country==="Spain",Me=be.country==="España"||be.country==="Spain";if(xe&&!Me)return-1;if(!xe&&Me)return 1;if(!xe&&!Me){const at=R.country.localeCompare(be.country,"es");if(at!==0)return at}const Ge=R.city.localeCompare(be.city,"es");return Ge!==0?Ge:j.first_name.localeCompare(f.first_name)});break;case"name-asc":y.sort((j,f)=>j.first_name.localeCompare(f.first_name));break;case"name-desc":y.sort((j,f)=>f.first_name.localeCompare(j.first_name));break;case"surname-asc":y.sort((j,f)=>j.last_name.localeCompare(f.last_name));break;case"surname-desc":y.sort((j,f)=>f.last_name.localeCompare(j.last_name));break;case"default":default:y.sort((j,f)=>{const L=j.role==="house_tech",C=f.role==="house_tech";if(L&&!C)return-1;if(!L&&C)return 1;if(!L&&!C&&(ye!=null&&ye.counts)){const H=ye.counts.get(j.id)||0,R=ye.counts.get(f.id)||0;if(R!==H)return R-H}return 0});break}return y},[t,A,me,re,Be,pe,ye]),da=c.useMemo(()=>{const y=new Map;if(!(ye!=null&&ye.counts)||!(ye!=null&&ye.departments)||me!=="default"||A)return y;const j=new Map;return Array.from(ye.counts.entries()).forEach(([f,L])=>{const C=ye.departments.get(f);C&&(j.has(C)||j.set(C,[]),j.get(C).push({id:f,count:L}))}),j.forEach((f,L)=>{f.sort((R,be)=>be.count-R.count);let C=0,H=0;for(;H<f.length&&C<3;){const R=f[H].count;if(R===0)break;const be=C===0?"gold":C===1?"silver":"bronze";let xe=0;for(;H+xe<f.length&&f[H+xe].count===R;)y.set(f[H+xe].id,be),xe++;C+=xe,H+=xe}}),y},[ye,me,A]),ua=c.useMemo(()=>{const y=new Map;if(!(Se!=null&&Se.counts)||!(Se!=null&&Se.departments)||me!=="default"||A)return y;const j=new Map;return Array.from(Se.counts.entries()).forEach(([f,L])=>{const C=Se.departments.get(f);C&&(j.has(C)||j.set(C,[]),j.get(C).push({id:f,count:L}))}),j.forEach((f,L)=>{f.sort((R,be)=>be.count-R.count);let C=0,H=0;for(;H<f.length&&C<3;){const R=f[H].count;if(R===0)break;const be=C===0?"gold":C===1?"silver":"bronze";let xe=0;for(;H+xe<f.length&&f[H+xe].count===R;)y.set(f[H+xe].id,be),xe++;C+=xe,H+=xe}}),y},[Se,me,A]),ma=c.useMemo(()=>{const y=Math.max(0,Te.start-10),j=Math.min(zt.length-1,Te.end+10);return zt.slice(y,j+1).map(f=>f.id)},[zt,Te.start,Te.end]),fa=c.useMemo(()=>s.map(y=>({id:y.id,start_time:y.start_time,end_time:y.end_time})),[s]),{data:ha}=jr(ma,fa,o),pa=c.useCallback(()=>u!=null&&u.technicianId?t.find(y=>y.id===u.technicianId):null,[u==null?void 0:u.technicianId,t])(),[Hr,Ht]=c.useState("email"),[xa,ks]=c.useState(!1),[ga,Vt]=c.useState("single"),[ya,Yt]=c.useState(null),[ja,Zt]=c.useState([]),ba=(y,j)=>{ks(!1),y instanceof Ys?Cs({open:!0,details:y.details,originalPayload:j}):Fe({title:"Error al enviar",description:y.message||"No se pudo enviar la solicitud de staffing",variant:"destructive"})};c.useEffect(()=>{if(ct!=null&&ct.open){Vt(ct.singleDay?"single":"full");try{const y=ct.profileId,j=[];for(const f of S)if(f.startsWith(`${y}-`)){const L=f.substring(y.length+1);try{const C=new Date(`${L}T00:00:00`);isNaN(C.getTime())||j.push(C)}catch{}}if(j.length>1)Yt(null),Zt(j.sort((f,L)=>f.getTime()-L.getTime())),Vt("multi");else{const f=ct.dateIso?new Date(`${ct.dateIso}T00:00:00`):null;Yt(f),Zt(f?[f]:[])}}catch{}}},[ct==null?void 0:ct.open,S]);const va=c.useCallback(()=>{const y=["default","location","name-asc","name-desc","surname-asc","surname-desc"],f=(y.indexOf(me)+1)%y.length;ie(y[f]),A&&te(null)},[me,A]),_a=c.useCallback(()=>{switch(me){case"location":return l?"📍 Ubic.":"📍 Ubicación";case"name-asc":return l?"A→Z":"A→Z Nombre";case"name-desc":return l?"Z→A":"Z→A Nombre";case"surname-asc":return l?"A→Z Ape.":"A→Z Apellido";case"surname-desc":return l?"Z→A Ape.":"Z→A Apellido";case"default":return"";default:return""}},[me,l]);if(Le)return e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"Cargando matriz..."})]})});const wa={isFetching:T,isInitialLoading:Le,TECHNICIAN_WIDTH:z,HEADER_HEIGHT:ve,CELL_WIDTH:w,CELL_HEIGHT:M,matrixWidth:V,matrixHeight:ke,dateHeadersRef:_,technicianScrollRef:g,mainScrollRef:N,visibleCols:ne,visibleRows:Te,dates:o,technicians:t,orderedTechnicians:zt,fridgeSet:i,allowDirectAssign:d,mobile:l,canNavLeft:h,canNavRight:ue,handleMobileNav:ca,handleDateHeadersScroll:Ae,handleTechnicianScroll:Oe,handleMainScroll:je,cycleTechSort:va,getSortLabel:_a,isManagementUser:G,setCreateUserOpen:ge,createUserOpen:Pe,qc:he,setSortJobId:te,getJobsForDate:Qe,getAssignmentForCell:we,getAvailabilityForCell:Ve,selectedCells:S,staffingMaps:ha,handleCellSelect:na,handleCellClick:aa,handleCellPrefetch:oa,handleOptimisticUpdate:la,incrementCellRender:Re,declinedJobsByTech:ce,cellAction:u,currentTechnician:pa,closeDialogs:Wt,handleJobSelected:ra,handleStaffingActionSelected:ia,forcedStaffingAction:Pt,forcedStaffingChannel:sa,jobs:s,offerChannel:Qt,toast:Fe,sendStaffingEmail:Je,checkTimeConflictEnhanced:Dt,availabilityDialog:ct,setAvailabilityDialog:Ft,availabilityCoverage:ga,setAvailabilityCoverage:Vt,availabilitySingleDate:ya,setAvailabilitySingleDate:Yt,availabilityMultiDates:ja,setAvailabilityMultiDates:Zt,availabilitySending:xa,setAvailabilitySending:ks,handleEmailError:ba,conflictDialog:ta,setConflictDialog:Cs,isGlobalCellSelected:k,techMedalRankings:da,techLastYearMedalRankings:ua};return e.jsx(zr,{...wa})},Lr=({canExpandBefore:t,canExpandAfter:o,onExpandBefore:s,onExpandAfter:r,onReset:m,onJumpToMonth:a,rangeInfo:d})=>{const i=new Date().getFullYear(),n=[i-1,i,i+1],b=[{value:1,label:"Ene"},{value:2,label:"Feb"},{value:3,label:"Mar"},{value:4,label:"Abr"},{value:5,label:"May"},{value:6,label:"Jun"},{value:7,label:"Jul"},{value:8,label:"Ago"},{value:9,label:"Sep"},{value:10,label:"Oct"},{value:11,label:"Nov"},{value:12,label:"Dic"}],D=p=>{const[l,u]=p.split("-").map(Number);a(l,u)};return e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ut,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Rango de fechas:"})]}),e.jsxs(Z,{variant:"outline",size:"sm",onClick:s,disabled:!t,className:"gap-1",title:t?"Cargar 4 semanas antes":"No se puede ampliar más hacia atrás",children:[e.jsx(rr,{className:"h-3 w-3"}),t?"+4s":"Máx"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(X,{variant:"secondary",className:"text-xs",children:[d.totalWeeks," s (",d.totalDays," d)"]}),e.jsxs("span",{className:"text-sm font-medium text-muted-foreground",children:["Rango: ",d.startFormatted," - ",d.endFormatted]})]}),e.jsxs(Z,{variant:"outline",size:"sm",onClick:r,disabled:!o,className:"gap-1",title:o?"Cargar 4 semanas después":"No se puede ampliar más hacia adelante",children:[o?"+4s":"Máx",e.jsx(nr,{className:"h-3 w-3"})]}),e.jsxs(jt,{onValueChange:D,children:[e.jsx(bt,{className:"w-20 h-8",children:e.jsx(vt,{placeholder:"Ir a..."})}),e.jsx(_t,{children:n.flatMap(p=>b.map(l=>e.jsxs(mt,{value:`${p}-${l.value}`,children:[l.label," ",p]},`${p}-${l.value}`)))})]}),e.jsxs(Z,{variant:"ghost",size:"sm",onClick:m,className:"gap-1",title:"Volver a la fecha actual con el rango predeterminado",children:[e.jsx(ir,{className:"h-3 w-3"}),"Reiniciar"]})]})},Ir=(t={})=>{const{initialWeeksBefore:o=1,initialWeeksAfter:s=2,maxWeeksBefore:r=26,maxWeeksAfter:m=26,expandByWeeks:a=4}=t,[d,i]=c.useState({centerDate:ts(new Date),weeksBefore:o,weeksAfter:s,maxWeeksBefore:r,maxWeeksAfter:m}),n=c.useCallback(k=>{const g=Ot(k.centerDate,-k.weeksBefore),_=Ot(k.centerDate,k.weeksAfter),N=k.weeksBefore+k.weeksAfter,O=Math.max(Ta(_,g)+1,0);return{start:g,end:_,totalWeeks:N,totalDays:O,startFormatted:F(g,"MMM d, yyyy"),endFormatted:F(_,"MMM d, yyyy"),isAtMaxBefore:k.weeksBefore>=k.maxWeeksBefore,isAtMaxAfter:k.weeksAfter>=k.maxWeeksAfter}},[]),b=c.useMemo(()=>{const k=Ot(d.centerDate,-d.weeksBefore),g=Ot(d.centerDate,d.weeksAfter),_=[];let N=k;for(;N<=g;)_.push(new Date(N)),N=Qa(N,1);return _},[d]),D=c.useMemo(()=>{const k=new Date;return b.findIndex(g=>At(g,k))},[b]),p=d.weeksBefore<d.maxWeeksBefore,l=d.weeksAfter<d.maxWeeksAfter,u=c.useCallback(()=>p?(i(k=>({...k,weeksBefore:Math.min(k.weeksBefore+a,k.maxWeeksBefore)})),!0):!1,[p,a]),v=c.useCallback(()=>l?(i(k=>({...k,weeksAfter:Math.min(k.weeksAfter+a,k.maxWeeksAfter)})),!0):!1,[l,a]),S=c.useCallback(k=>{i(g=>({...g,centerDate:ts(k)}))},[]),B=c.useCallback(()=>{i({centerDate:ts(new Date),weeksBefore:o,weeksAfter:s,maxWeeksBefore:r,maxWeeksAfter:m})},[o,s,r,m]),K=c.useCallback((k,g)=>{const _=new Date(k,g-1,1);S(_)},[S]),x=c.useMemo(()=>n(d),[n,d]),q=c.useCallback((k,g=1)=>{if(g<=0)return null;const _=g*a;let N=d.weeksBefore,O=d.weeksAfter;if(k==="before"){if(!p||(N=Math.min(d.weeksBefore+_,d.maxWeeksBefore),N===d.weeksBefore))return null}else if(!l||(O=Math.min(d.weeksAfter+_,d.maxWeeksAfter),O===d.weeksAfter))return null;const $={...d,weeksBefore:N,weeksAfter:O};return{state:$,rangeInfo:n($)}},[n,l,p,d,a]);return{dateRange:b,todayIndex:D,canExpandBefore:p,canExpandAfter:l,expandBefore:u,expandAfter:v,setCenterDate:S,resetRange:B,jumpToMonth:K,rangeInfo:x,currentState:d,getProjectedRangeInfo:q}},Br=[{id:"lights-ma2",name:"Operador (MA2)",category:"lights"},{id:"lights-ma3",name:"Operador (MA3)",category:"lights"},{id:"lights-hog",name:"Operador (HOG)",category:"lights"},{id:"lights-avo",name:"Operador (AVO)",category:"lights"},{id:"lights-dim",name:"Dimmer",category:"lights"},{id:"lights-rig",name:"Rigging",category:"lights"},{id:"lights-mont",name:"Montador",category:"lights"}],Kr=[{id:"sound-height",name:"Trabajo en altura",category:"sound"}],Is=({selected:t,onChange:o,department:s})=>{const[r,m]=W.useState(!1),[a,d]=W.useState([]);W.useEffect(()=>{let D=!0;return(async()=>{const{data:p,error:l}=await I.from("skills").select("id,name,category").eq("active",!0).order("category",{ascending:!0}).order("name",{ascending:!0});if(!D)return;if(l){d([]);return}const u=(s||"").toLowerCase(),v=(p||[]).filter(S=>!!(S!=null&&S.name));if(u==="lights"){d(Br);return}if(u==="sound"){const B=[...v.filter(K=>(K.category||"").toLowerCase().startsWith("sound"))];Kr.forEach(K=>{B.some(x=>x.name.toLowerCase()===K.name.toLowerCase())||B.push(K)}),d(B);return}d(v)})(),()=>{D=!1}},[s]);const i=(D,p)=>{const l=new Set(t);p?l.add(D):l.delete(D),o(Array.from(l))},n=W.useMemo(()=>{const D=new Map;for(const p of a){const l=p.category||"other";D.has(l)||D.set(l,[]),D.get(l).push(p)}return Array.from(D.entries())},[a]),b=t.length;return e.jsxs(Nt,{open:r,onOpenChange:m,children:[e.jsx(Ct,{asChild:!0,children:e.jsxs(Z,{variant:"outline",size:"sm",className:"gap-2",children:[e.jsx(vs,{className:"h-4 w-4"}),"Habilidades",b>0&&e.jsx(X,{variant:"secondary",className:"ml-1",children:b})]})}),e.jsx(Mt,{className:"p-0 w-80",align:"start",children:r&&e.jsx(or,{children:e.jsxs(lr,{children:[e.jsx(cr,{children:"No se encontraron habilidades."}),n.map(([D,p])=>e.jsx(dr,{heading:D,children:p.map(l=>{const u=t.includes(l.name);return e.jsxs(ur,{onSelect:()=>i(l.name,!u),children:[e.jsx("div",{className:"mr-2",children:e.jsx(Vs,{checked:u,onCheckedChange:v=>i(l.name,!!v)})}),e.jsx("span",{children:l.name})]},l.id)})},D))]})})})]})};async function Ar(t,o,s){const r=`[${t.toISOString()},${o.toISOString()}]`;let m=I.from("jobs").select(`
      id, title, start_time, end_time, color, status, job_type,
      job_departments!inner(department),
      job_assignments!job_id(technician_id)
    `).filter("time_range","ov",r).in("job_type",["single","festival","tourdate","evento"]).limit(500);s&&(m=m.eq("job_departments.department",s));const{data:a,error:d}=await m.order("start_time",{ascending:!0});if(d)throw d;return(a||[]).map(i=>{const n=Array.isArray(i.job_assignments)?i.job_assignments:[];return{id:i.id,title:i.title,start_time:i.start_time,end_time:i.end_time,color:i.color,status:i.status,job_type:i.job_type,_assigned_count:n.length}}).filter(i=>i.status!=="Cancelado"||(i._assigned_count??0)>0)}async function Jr(t,o,s){if(!t.length||!o.length)return[];const r=new Map;s.forEach(n=>{n!=null&&n.id&&r.set(n.id,n)});const m=25,a=[];for(let n=0;n<t.length;n+=m){const b=t.slice(n,n+m);a.push(I.from("job_assignments").select(`
          job_id,
          technician_id,
          sound_role,
          lights_role,
          video_role,
          production_role,
          single_day,
          assignment_date,
          status,
          assigned_at,
          jobs!job_id (
            id,
            title,
            start_time,
            end_time,
            color
          )
        `).in("job_id",b).in("technician_id",o).limit(500))}return(await Promise.all(a)).flatMap(n=>n.error?[]:n.data||[]).map(n=>({job_id:n.job_id,technician_id:n.technician_id,sound_role:n.sound_role,lights_role:n.lights_role,video_role:n.video_role,production_role:n.production_role,single_day:n.single_day,assignment_date:n.assignment_date,status:n.status,assigned_at:n.assigned_at,job:r.get(n.job_id)||(Array.isArray(n.jobs)?n.jobs[0]:n.jobs)})).filter(n=>!!n.job)}async function Qr(t,o,s){if(!t.length)return[];const r=[],m=100;for(let n=0;n<t.length;n+=m)r.push(t.slice(n,n+m));const a=new Map,d=new Date(o);d.setHours(0,0,0,0);const i=new Date(s);i.setHours(0,0,0,0);for(const n of r){const{data:b,error:D}=await I.from("availability_schedules").select("user_id, date, status, notes, source").in("user_id",n).gte("date",F(o,"yyyy-MM-dd")).lte("date",F(s,"yyyy-MM-dd")).or("status.eq.unavailable,source.eq.vacation");if(D)throw D;(b||[]).forEach(p=>{const l=`${p.user_id}-${p.date}`;if(!a.has(l))a.set(l,{user_id:p.user_id,date:p.date,status:"unavailable",notes:p.notes||void 0});else if(p.notes){const u=a.get(l);u.notes||a.set(l,{...u,notes:p.notes})}})}try{const{data:n,error:b}=await I.from("technician_availability").select("technician_id, date, status").in("technician_id",t).gte("date",F(o,"yyyy-MM-dd")).lte("date",F(s,"yyyy-MM-dd")).in("status",["vacation","travel","sick","day_off"]);if(b&&b.code!=="42P01")throw b;(n||[]).forEach(D=>{const p=`${D.technician_id}-${D.date}`;a.has(p)||a.set(p,{user_id:D.technician_id,date:D.date,status:"unavailable"})})}catch(n){if(n!=null&&n.code&&n.code!=="42P01")throw n}try{const b=[];for(let D=0;D<t.length;D+=100)b.push(t.slice(D,D+100));for(const D of b){const{data:p,error:l}=await I.from("vacation_requests").select("technician_id, start_date, end_date, status").eq("status","approved").in("technician_id",D).lte("start_date",F(s,"yyyy-MM-dd")).gte("end_date",F(o,"yyyy-MM-dd"));if(l&&l.code!=="42P01")throw l;(p||[]).forEach(u=>{const v=new Date(u.start_date),S=new Date(u.end_date),B=new Date(Math.max(d.getTime(),new Date(v.getFullYear(),v.getMonth(),v.getDate()).getTime())),K=new Date(Math.min(i.getTime(),new Date(S.getFullYear(),S.getMonth(),S.getDate()).getTime()));for(let x=new Date(B);x.getTime()<=K.getTime();x.setDate(x.getDate()+1)){const q=`${u.technician_id}-${F(x,"yyyy-MM-dd")}`;a.has(q)||a.set(q,{user_id:u.technician_id,date:F(x,"yyyy-MM-dd"),status:"unavailable"})}})}}catch(n){if(n!=null&&n.code&&n.code!=="42P01")throw n}return Array.from(a.values())}const ds={sound:"Sonido",lights:"Luces",video:"Video",production:"Producción",rigging:"Rigging",staging:"Escenario",backline:"Backline",power:"Energía"},us=["sound","lights","video","production"],ms="sound",fs="job-assignment-matrix:last-outstanding-hash";function Lt(t){return t.split(/[_\\s]+/).filter(Boolean).map(o=>o.charAt(0).toUpperCase()+o.slice(1)).join(" ")}function Wr(t){if(!t||!t.job_id||!t.department)return null;const s=(Array.isArray(t.roles)?t.roles:[]).map(r=>({role_code:typeof(r==null?void 0:r.role_code)=="string"?r.role_code:String((r==null?void 0:r.role_code)??""),quantity:Number((r==null?void 0:r.quantity)??0),notes:(r==null?void 0:r.notes)??null})).filter(r=>r.role_code);return{job_id:t.job_id,department:t.department,roles:s}}function ei(){const t=pt(),o=W.useRef(new Map),{userDepartment:s}=ws(),[r,m]=c.useState(ms),[a,d]=c.useState(ms),i=W.useRef(!1),[n,b]=c.useState(!1),[D,p]=c.useState(!1),[l,u]=c.useState(""),[v,S]=c.useState("");W.useEffect(()=>{const h=setTimeout(()=>S(l.trim().toLowerCase()),150);return()=>clearTimeout(h)},[l]);const[B,K]=c.useState(!1),[x,q]=c.useState(!1),[k,g]=c.useState([]),[_,N]=c.useState(!0),[O,$]=c.useState(!1),[J,Y]=c.useState(null);W.useEffect(()=>{if(!(typeof window>"u"))try{const h=window.sessionStorage.getItem(fs);h&&Y(h)}catch{}},[]);const Pe=W.useMemo(()=>a==="lights"?["Operador (MA2)","Operador (MA3)","Operador (HOG)","Operador (AVO)","Dimmer","Rigging","Montador"]:a==="sound"?["foh","monitores","sistemas","rf","Trabajo en altura","Técnico de escenario","Montador"]:[],[a]),ge=h=>{g(de=>de.includes(h)?de.filter(ue=>ue!==h):[...de,h])},Ie=W.useMemo(()=>{const h=typeof s=="string"?s.toLowerCase():"";return us.includes(h)?h:ms},[s]);W.useEffect(()=>{m(h=>(h!==Ie&&(i.current=!1),Ie))},[Ie]),W.useEffect(()=>{i.current||d(h=>h===r?h:r)},[r]);const G=W.useCallback(h=>{i.current=!0,d(h)},[]),he=W.useCallback(()=>{i.current=!1,d(r)},[r]),{dateRange:A,canExpandBefore:te,canExpandAfter:me,expandBefore:ie,expandAfter:qe,resetRange:ze,jumpToMonth:Re,rangeInfo:Fe,getProjectedRangeInfo:Je}=Ir({initialWeeksBefore:1,initialWeeksAfter:2,maxWeeksBefore:52,maxWeeksAfter:52,expandByWeeks:4}),{data:w=[],isInitialLoading:M,isFetching:z}=He({queryKey:["optimized-matrix-technicians",a],queryFn:async()=>{const{data:h,error:de}=await I.rpc("get_profiles_with_skills");if(de)throw de;return(h||[]).filter(fe=>{const ee=typeof fe.department=="string"?fe.department.toLowerCase():"";if(a==="production"){if(ee!=="production"&&ee!=="logistics")return!1}else if(ee!==a)return!1;return fe.role==="technician"||fe.role==="house_tech"?!0:fe.role==="management"?!!fe.assignable_as_tech:!1}).sort((fe,ee)=>{const Ee=(fe.department||"").localeCompare(ee.department||"");return Ee!==0?Ee:(fe.last_name||"").localeCompare(ee.last_name||"")})},staleTime:300*1e3,gcTime:600*1e3}),ve=W.useMemo(()=>w.map(h=>h.id),[w]),{data:Be=[]}=He({queryKey:["technician-fridge-status",ve],queryFn:async()=>{if(!ve.length)return[];const{data:h,error:de}=await I.from("technician_fridge").select("technician_id, in_fridge").in("technician_id",ve);if(de)throw de;return h||[]},enabled:ve.length>0,staleTime:6e4,gcTime:5*6e4}),we=W.useMemo(()=>{const h=new Set;return Be.forEach(de=>{de.in_fridge&&h.add(de.technician_id)}),h},[Be]),Ve=W.useMemo(()=>{if(!(w!=null&&w.length)||!(we!=null&&we.size))return 0;let h=0;for(const de of w)we.has(de.id)&&h++;return h},[w,we]);W.useEffect(()=>{const h=I.channel("rt-technician-fridge").on("postgres_changes",{event:"*",schema:"public",table:"technician_fridge"},()=>{t.invalidateQueries({queryKey:["technician-fridge-status"]})}).subscribe();return()=>{try{I.removeChannel(h)}catch{}}},[t]);const Qe=c.useMemo(()=>{const h=w.filter(ue=>{var Ee,Ne;if(!(!v||`${ue.first_name} ${ue.last_name}`.toLowerCase().includes(v)||((Ee=ue.email)==null?void 0:Ee.toLowerCase().includes(v))||((Ne=ue.department)==null?void 0:Ne.toLowerCase().includes(v)))||_&&we.has(ue.id))return!1;if(!k.length)return!0;const ee=(ue.skills||[]).map(_e=>({name:(_e.name||"").toLowerCase()}));return k.every(_e=>ee.some(E=>E.name===_e.toLowerCase()))});if(!k.length)return h;const de=ue=>{const fe=ue.skills||[];let ee=0;for(const Ee of k){const Ne=fe.find(E=>(E.name||"").toLowerCase()===Ee.toLowerCase());if(!Ne)continue;const _e=Number(Ne.proficiency??0);Ne.is_primary&&(ee+=3),_e>=4?ee+=2:_e>=2&&(ee+=1),(Ne.category||"")==="sound-specialty"&&(ee+=1)}return ee};return h.sort((ue,fe)=>{const ee=de(ue),Ee=de(fe);if(Ee!==ee)return Ee-ee;const Ne=(ue.department||"").localeCompare(fe.department||"");return Ne!==0?Ne:(ue.last_name||"").localeCompare(fe.last_name||"")})},[w,v,k,_,we]),De=c.useMemo(()=>Qe.map(h=>h.id),[Qe]),We=c.useMemo(()=>De.join(","),[De]),{data:oe=[],isInitialLoading:Le,isFetching:T}=He({queryKey:["optimized-matrix-jobs",Fe.startFormatted,Fe.endFormatted,a],queryFn:async()=>{const h=Fe.start,de=Fe.end,ue=`[${h.toISOString()},${de.toISOString()}]`;let fe=I.from("jobs").select(`
          id, title, start_time, end_time, color, status, job_type,
          job_departments!inner(department),
          job_assignments!job_id(technician_id)
        `).filter("time_range","ov",ue).in("job_type",["single","festival","tourdate","evento"]).limit(500);fe=fe.eq("job_departments.department",a);const{data:ee,error:Ee}=await fe.order("start_time",{ascending:!0});if(Ee)throw Ee;return(ee||[]).map(_e=>{const E=Array.isArray(_e.job_assignments)?_e.job_assignments:[];return{id:_e.id,title:_e.title,start_time:_e.start_time,end_time:_e.end_time,color:_e.color,status:_e.status,job_type:_e.job_type,_assigned_count:E.length}}).filter(_e=>_e.status!=="Cancelado"||_e._assigned_count>0)},enabled:A.length>0,staleTime:300*1e3,gcTime:900*1e3,placeholderData:h=>h??[]}),U=M||Le,pe=z&&!M||T&&!Le;W.useEffect(()=>{if(U||!me)return;const h=Je("after");if(!h)return;const{rangeInfo:de}=h,{start:ue,end:fe,startFormatted:ee,endFormatted:Ee}=de;if(!ue||!fe)return;const Ne=De,E=[ee,Ee,a,We].join("|"),Q=o.current.get(E);if(Q==="pending"||Q==="done")return;let se=!1;return o.current.set(E,"pending"),(async()=>{const ae=["optimized-matrix-jobs",ee,Ee,a],le=await t.prefetchQuery({queryKey:ae,queryFn:()=>Ar(ue,fe,a),staleTime:300*1e3,gcTime:900*1e3});if(se)return;const $e=Array.isArray(le)?le:t.getQueryData(ae)??[],tt=$e.map(je=>je.id).filter(Boolean);!se&&tt.length&&Ne.length&&await t.prefetchQuery({queryKey:["optimized-matrix-assignments",tt,Ne,F(ue,"yyyy-MM-dd")],queryFn:()=>Jr(tt,Ne,$e),staleTime:30*1e3,gcTime:120*1e3}),!se&&Ne.length&&await t.prefetchQuery({queryKey:["optimized-matrix-availability",Ne,F(ue,"yyyy-MM-dd"),F(fe,"yyyy-MM-dd")],queryFn:()=>Qr(Ne,ue,fe),staleTime:60*1e3,gcTime:600*1e3}),!se&&me&&qe()})().then(()=>{se||o.current.set(E,"done")}).catch(ae=>{se||o.current.delete(E)}),()=>{se=!0,o.current.get(E)==="pending"&&o.current.delete(E)}},[t,me,qe,De,We,Je,U,a]);const re=W.useMemo(()=>oe.map(h=>h.id).filter(Boolean),[oe]),ye=W.useMemo(()=>re.length?re.slice().sort().join(","):"none",[re]),Se=He({queryKey:["matrix-staffing-summary",ye],queryFn:async()=>{if(!re.length)return{summaries:[],assignments:[]};const[h,de]=await Promise.all([I.from("job_required_roles_summary").select("job_id, department, roles").in("job_id",re),I.from("job_assignments").select("job_id, sound_role, lights_role, video_role, production_role, status").in("job_id",re)]);if(h.error)throw h.error;if(de.error)throw de.error;const ue=(h.data||[]).map(Wr).filter(ee=>!!ee),fe=(de.data||[]).filter(ee=>!!(ee&&ee.job_id)).map(ee=>({...ee,sound_role:ee.sound_role?String(ee.sound_role):null,lights_role:ee.lights_role?String(ee.lights_role):null,video_role:ee.video_role?String(ee.video_role):null,status:ee.status?String(ee.status):null}));return{summaries:ue,assignments:fe}},enabled:re.length>0,staleTime:60*1e3,gcTime:300*1e3}),V=c.useMemo(()=>{const h=Se.data;if(!h)return[];const{summaries:de,assignments:ue}=h;if(!de.length)return[];const fe=new Map(oe.map(Q=>[Q.id,Q.title||"Trabajo sin título"])),ee=oe.map(Q=>Q.id),Ee=new Map,Ne=(Q,se,ce)=>{if(!Q||!se||!ce)return;const ae=`${Q}:${se}:${ce}`;Ee.set(ae,(Ee.get(ae)||0)+1)};ue.forEach(Q=>{!(Q!=null&&Q.job_id)||(Q.status||"").toLowerCase()==="declined"||(Ne(Q.job_id,"sound",Q.sound_role?Q.sound_role.trim():null),Ne(Q.job_id,"lights",Q.lights_role?Q.lights_role.trim():null),Ne(Q.job_id,"video",Q.video_role?Q.video_role.trim():null),Ne(Q.job_id,"production",Q.production_role?Q.production_role.trim():null))});const _e=new Map;de.forEach(Q=>{const se=Q.job_id,ce=Q.department;if(!se||!ce)return;const ae=Q.roles.map(je=>{const Ae=je.role_code,Oe=Number(je.quantity||0),Ue=Ee.get(`${se}:${ce}:${Ae}`)||0;return{roleCode:Ae,required:Oe,assigned:Ue,outstanding:Math.max(Oe-Ue,0)}}).filter(je=>je.outstanding>0).sort((je,Ae)=>je.roleCode.localeCompare(Ae.roleCode));if(!ae.length)return;let le=_e.get(se);le||(le={jobId:se,jobTitle:fe.get(se)||"Trabajo sin título",outstandingTotal:0,departments:[]},_e.set(se,le));const $e=ae.reduce((je,Ae)=>je+Ae.outstanding,0),tt=ds[ce]||Lt(ce);le.departments.push({department:ce,displayName:tt,outstandingTotal:$e,roles:ae}),le.outstandingTotal+=$e});const E=[];return ee.forEach(Q=>{const se=_e.get(Q);se&&(se.departments.sort((ce,ae)=>ce.displayName.localeCompare(ae.displayName)),E.push(se))}),E},[Se.data,oe]),ke=c.useMemo(()=>V.length?JSON.stringify(V):null,[V]);W.useEffect(()=>{if(Se.isSuccess&&!V.length){if(O&&$(!1),J!==null&&Y(null),typeof window<"u")try{window.sessionStorage.removeItem(fs)}catch{}return}},[Se.isSuccess,V,J,O]);const Te=W.useCallback(()=>{if(ke&&(Y(ke),typeof window<"u"))try{window.sessionStorage.setItem(fs,ke)}catch{}$(!1)},[ke]),P=W.useCallback(h=>{h?$(!0):V.length?Te():$(!1)},[Te,V.length]),ne=async()=>{K(!0),window.dispatchEvent(new CustomEvent("assignment-updated")),setTimeout(()=>K(!1),1e3)};W.useEffect(()=>{const h=()=>b(window.innerWidth<=768);return h(),window.addEventListener("resize",h),()=>window.removeEventListener("resize",h)},[]);const Ze=W.useMemo(()=>{let h=0;return a!==r&&h++,v&&h++,k.length&&(h+=k.length),_&&h++,x&&h++,h},[a,r,v,k,_,x]),Ce=Se.isSuccess?V.length:null,Xe=Ce===null?"Cargando información de dotaciones pendientes":Ce===0?"Sin trabajos pendientes":`${Ce} trabajo${Ce===1?"":"s"} pendiente${Ce===1?"":"s"}`;return e.jsxs("div",{className:"h-screen flex flex-col bg-background",children:[e.jsxs("div",{className:"flex-shrink-0 border-b bg-card p-2 md:p-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ut,{className:"h-5 w-5 md:h-6 md:w-6"}),e.jsx("h1",{className:"text-lg md:text-2xl font-bold",children:"Matriz de asignación de trabajos"})]}),e.jsxs("div",{className:"flex items-center gap-2 self-stretch sm:self-auto",children:[e.jsxs(Z,{type:"button",variant:"secondary",size:"sm",onClick:()=>{$(!0),P(!0)},className:"shrink-0 flex items-center gap-2","aria-label":`Ver recordatorio de staffing. ${Xe}.`,children:["Ver recordatorio de staffing",Ce!==null&&e.jsx(X,{variant:"outline",className:"text-xs","aria-hidden":"true",children:Ce}),e.jsx("span",{className:"sr-only",children:Xe})]}),e.jsxs(Z,{variant:"outline",size:"sm",onClick:ne,disabled:B,className:"shrink-0",children:[e.jsx(ss,{className:`h-4 w-4 mr-2 ${B?"animate-spin":""}`}),e.jsx("span",{className:"hidden sm:inline",children:"Refrescar"})]})]})]}),e.jsx("div",{className:"hidden md:block",children:e.jsx(Lr,{canExpandBefore:te,canExpandAfter:me,onExpandBefore:ie,onExpandAfter:qe,onReset:ze,onJumpToMonth:Re,rangeInfo:Fe})}),e.jsxs("div",{className:"hidden md:flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(vs,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Filtros:"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 w-full sm:w-auto",children:[e.jsx(js,{value:a,onValueChange:h=>G(h),className:"w-full sm:w-auto",children:e.jsx(bs,{className:"flex w-full sm:w-auto overflow-x-auto rounded-md bg-muted p-1 gap-1",children:us.map(h=>e.jsx(qt,{value:h,className:"flex-1 whitespace-nowrap capitalize sm:flex-none",children:ds[h]||Lt(h)},h))})}),e.jsx(ht,{placeholder:"Buscar técnicos...",value:l,onChange:h=>u(h.target.value),className:"w-48 min-w-0 flex-1 sm:flex-none"}),e.jsx(Is,{selected:k,onChange:g,department:a}),Pe.length>0&&e.jsx("div",{className:"flex items-center gap-1",children:Pe.map(h=>e.jsx(X,{variant:k.includes(h)?"default":"outline",className:"cursor-pointer capitalize",onClick:()=>ge(h),children:h},h))})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 sm:ml-auto",children:[e.jsxs("div",{className:"flex items-center gap-2 pr-2 border-r",children:[e.jsx(yt,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:_?"Abrir la nevera":"Cerrar la nevera"}),e.jsx(kt,{checked:_,onCheckedChange:h=>N(!!h),"aria-label":_?"Abrir la nevera":"Cerrar la nevera"}),e.jsx(X,{variant:"secondary",className:"text-[10px] h-5 px-1.5",children:Ve})]}),e.jsxs("div",{className:"flex items-center gap-2 pr-2 border-r",children:[e.jsx("span",{className:"text-sm font-medium",children:"Asignación directa"}),e.jsx(kt,{checked:x,onCheckedChange:h=>q(!!h),"aria-label":"Alternar asignación directa"})]}),e.jsx(ys,{className:"h-4 w-4"}),e.jsxs(X,{variant:"secondary",className:"text-xs",children:[Qe.length," técnicos"]}),e.jsxs(X,{variant:"outline",className:"text-xs",children:[oe.length," trabajos"]}),pe&&e.jsxs(X,{variant:"outline",className:"text-xs flex items-center gap-1",children:[e.jsx(ss,{className:"h-3 w-3 animate-spin"}),"Actualizando..."]})]})]})]}),e.jsxs("div",{className:"md:hidden mt-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("button",{className:"text-sm font-medium px-3 py-2 border rounded-md bg-background",onClick:()=>p(h=>!h),"aria-expanded":D,"aria-controls":"mobile-filters",children:["Filtros ",Ze>0&&e.jsx("span",{className:"ml-2 inline-flex items-center justify-center text-[10px] h-5 min-w-[20px] px-1.5 rounded-full bg-primary/10 text-primary border border-primary/20",children:Ze})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs",children:"Directa"}),e.jsx(kt,{checked:x,onCheckedChange:h=>q(!!h),"aria-label":"Alternar asignación directa"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ys,{className:"h-4 w-4"}),e.jsxs(X,{variant:"secondary",className:"text-xs",children:[Qe.length," técnicos"]}),e.jsxs(X,{variant:"outline",className:"text-xs",children:[oe.length," trabajos"]}),pe&&e.jsxs(X,{variant:"outline",className:"text-[10px] flex items-center gap-1",children:[e.jsx(ss,{className:"h-3 w-3 animate-spin"}),"Actualizando..."]})]})]}),D&&e.jsxs("div",{id:"mobile-filters",className:"mt-2 max-h-[300px] overflow-y-auto p-2 border rounded-md bg-muted/30 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(vs,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Filtros"}),Ze>0&&e.jsx("button",{className:"ml-auto text-xs underline",onClick:()=>{he(),u(""),g([]),N(!1),q(!1)},children:"Limpiar"})]}),e.jsx(js,{value:a,onValueChange:h=>G(h),className:"w-full",children:e.jsx(bs,{className:"flex w-full overflow-x-auto rounded-md bg-muted p-1 gap-1",children:us.map(h=>e.jsx(qt,{value:h,className:"flex-1 whitespace-nowrap capitalize",children:ds[h]||Lt(h)},h))})}),e.jsx(ht,{placeholder:"Buscar técnicos...",value:l,onChange:h=>u(h.target.value)}),e.jsx(Is,{selected:k,onChange:g,department:a}),Pe.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:Pe.map(h=>e.jsx(X,{variant:k.includes(h)?"default":"outline",className:"cursor-pointer capitalize",onClick:()=>ge(h),children:h},h))}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yt,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:_?"Abrir la nevera":"Cerrar la nevera"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(kt,{checked:_,onCheckedChange:h=>N(!!h),"aria-label":_?"Abrir la nevera":"Cerrar la nevera"}),e.jsx(X,{variant:"secondary",className:"text-[10px] h-5 px-1.5",children:Ve})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Asignación directa"}),e.jsx(kt,{checked:x,onCheckedChange:h=>q(!!h),"aria-label":"Alternar asignación directa"})]})]})]}),e.jsx("div",{className:"flex-1 overflow-hidden",children:U?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"Cargando la matriz de asignaciones..."})]})}):e.jsx(Or,{technicians:Qe,dates:A,jobs:oe,fridgeSet:we,allowDirectAssign:x,mobile:n,cellWidth:n?140:void 0,cellHeight:n?80:void 0,technicianWidth:n?110:void 0,headerHeight:n?50:void 0,onNearEdgeScroll:h=>{h==="before"&&te?ie():h==="after"&&me&&qe()},canExpandBefore:te,canExpandAfter:me})}),e.jsx(rt,{open:O,onOpenChange:P,children:e.jsxs(nt,{className:"max-w-lg",children:[e.jsxs(it,{children:[e.jsxs(ot,{children:["Hay ",V.length," trabajos con personal por completar"]}),e.jsx(dt,{children:"Revisa los roles pendientes para completar la dotación de cada equipo."})]}),e.jsx("div",{className:"space-y-4",children:V.map(h=>e.jsxs("div",{className:"rounded-md border p-3",children:[e.jsx("div",{className:"text-sm font-semibold",children:h.jobTitle}),e.jsx("div",{className:"mt-2 space-y-2",children:h.departments.map(de=>e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium",children:de.displayName}),e.jsx("ul",{className:"ml-4 mt-1 list-disc space-y-1 text-sm text-muted-foreground",children:de.roles.map(ue=>e.jsxs("li",{children:[ue.outstanding," × ",Lt(ue.roleCode)]},`${h.jobId}-${de.department}-${ue.roleCode}`))})]},`${h.jobId}-${de.department}`))})]},h.jobId))}),e.jsx(lt,{children:e.jsx(Z,{onClick:Te,variant:"default",children:"Entendido"})})]})})]})}export{ei as default};
