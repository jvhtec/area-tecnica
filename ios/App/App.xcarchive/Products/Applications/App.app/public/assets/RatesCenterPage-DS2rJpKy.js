import{j as e,C as E,W as R,Y as I,A as F,i as A,h as Q,r as v,I as Y,a4 as m,u as te,S as K,t as V,v as U,w as G,x as P,B as S,m as re,n as q,H as ie,D as ne,q as le,F as oe,G as de,aK as ce,b as me}from"./index-NZ6jJLfQ.js";import{T as xe,a as pe,b as ue,c as z}from"./tabs-BdaywI_b.js";import{B as x}from"./badge-vNTKF5RD.js";import{S as _}from"./skeleton-DFbEI1RA.js";import{e as D}from"./es-CSiFCUGj.js";import{f as he,a as je,b as fe,c as ge,E as be,B as Ne,T as ve}from"./TourRatesManagerDialog-J5sncCSp.js";import{A as ye,a as Te,b as Ce,c as Pe}from"./accordion-CkNUgJdy.js";import{H as Se}from"./HouseTechRateEditor-BHnjxOLZ.js";import{u as M}from"./useQuery-kdg2pmgf.js";import{R as k}from"./ratesQueryKeys-DgMsgg6U.js";import{T as Ae,a as De,b as $,c as b,d as we,e as N}from"./table-DnQAmABX.js";import{d as Ee}from"./useManagerJobQuotes-BrI1iNRY.js";import{J as Re}from"./JobPayoutTotalsPanel-BSlgp62i.js";import{F as Ie}from"./file-down-Buu6FgvW.js";import Fe from"./Timesheets-C5C4W06d.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./index-hC3MxXep.js";import"./useMutation-DluhVBs1.js";import"./useHouseTechRates-BLqiuvHa.js";import"./JobExtrasEditor-gQe73Sd8.js";import"./separator-E-JdTFOv.js";import"./euro-DgRTeGAz.js";import"./minus-InO4I9Ks.js";import"./plus-C3JQqq7t.js";import"./circle-alert-LZYNzZ7F.js";import"./tourRateMath-BOmIkfWO.js";import"./useTourRatesApproval-CR_t91JW.js";import"./useJobRatesApproval-DsfA8V9C.js";import"./alert-BqA-5jRM.js";import"./wrench-DzMvZxmF.js";import"./calendar-_Cj_Sgy-.js";import"./users-DMnpVLUq.js";import"./triangle-alert-D6qN0F8g.js";import"./index-Bf_BVWwW.js";import"./info-CpCfiYD2.js";import"./save-z_re-Mcq.js";import"./logoUtils-D2o1jUVg.js";import"./logo-url-cache-eY6nfvu7.js";import"./lazyPdf-xVUlxKNu.js";import"./constants-DoXhG9KB.js";import"./useJobPayoutTotals-CXAavZS-.js";import"./switch-DUBpZhIC.js";import"./pen-D_H3YLSb.js";import"./send-Uvkx0r_O.js";import"./external-link-QJoXZ6ES.js";import"./clock-BXPvTWvY.js";import"./circle-check-big-CilmNGCn.js";import"./useTimesheets-C6aFxEBN.js";import"./useJobAssignmentsRealtime-7FZn5naq.js";import"./useRealtimeQuery-DRd58t-I.js";import"./useTableSubscription-Cu79jct8.js";import"./index-vfKqQWY5.js";import"./pdf-libs-BqoGqu1a.js";import"./user-E3OATBQk.js";import"./alert-dialog-CtyYUxwH.js";import"./progress-C8XsV-Me.js";import"./upload-DF4rjO7T.js";import"./file-text-igU140SQ.js";import"./eye-BE_DouVP.js";import"./circle-x-DDzV-xk_.js";import"./circle-check-C0N48OpO.js";import"./receipt-CWKVL4Rh.js";import"./calendar-days-DcwEz6pd.js";import"./mail-1T3Omkp6.js";import"./timesheet-pdf-82e1LStH.js";import"./useOptimizedJobs-BQ4L7-2d.js";import"./useSubscription-C3wu6ko-.js";import"./download-C1rVE0-J.js";function _e({overview:l,isLoading:n}){const r=l==null?void 0:l.totals,c=(l==null?void 0:l.pendingTours)??[],u=(l==null?void 0:l.recentOverrides)??[];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-4",children:[e.jsx(O,{title:"Aprobaciones pendientes",value:r==null?void 0:r.pendingTours,isLoading:n}),e.jsx(O,{title:"Categorías de tarifa base",value:r==null?void 0:r.baseRates,isLoading:n}),e.jsx(O,{title:"Extras configurados",value:r==null?void 0:r.extras,isLoading:n}),e.jsx(O,{title:"Tarifas internas",value:r==null?void 0:r.houseOverrides,isLoading:n})]}),e.jsxs("div",{className:"grid gap-4 lg:grid-cols-2",children:[e.jsxs(E,{children:[e.jsx(R,{children:e.jsx(I,{className:"text-base",children:"Próximas aprobaciones"})}),e.jsxs(F,{className:"space-y-3 text-sm",children:[n&&e.jsx(_,{className:"h-20 w-full"}),!n&&c.length===0&&e.jsx("p",{className:"text-muted-foreground",children:"Todas las giras están aprobadas. ¡Buen trabajo!"}),!n&&c.map(i=>e.jsxs("div",{className:"flex items-center justify-between rounded-lg border p-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium leading-tight",children:i.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:i.start_date?A(new Date(i.start_date),"PPP",{locale:D}):"Sin fecha de inicio"})]}),e.jsx(x,{variant:"secondary",children:"Se requiere aprobación"})]},i.id))]})]}),e.jsxs(E,{children:[e.jsx(R,{children:e.jsx(I,{className:"text-base",children:"Tarifas internas recientes"})}),e.jsxs(F,{className:"space-y-3 text-sm",children:[n&&e.jsx(_,{className:"h-20 w-full"}),!n&&u.length===0&&e.jsx("p",{className:"text-muted-foreground",children:"Sin tarifas internas registradas."}),!n&&u.map(i=>e.jsxs("div",{className:"flex items-center justify-between rounded-lg border p-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium leading-tight",children:i.profileName}),e.jsx("div",{className:"text-xs text-muted-foreground",children:i.updatedAt?A(new Date(i.updatedAt),"PPP p",{locale:D}):"Fecha desconocida"})]}),e.jsx(x,{variant:"outline",children:i.baseDayEur!=null?Q(i.baseDayEur):"—"})]},`${i.profileId}-${i.updatedAt}`))]})]})]})]})}function O({title:l,value:n,isLoading:r}){return e.jsxs(E,{children:[e.jsx(R,{children:e.jsx(I,{className:"text-sm text-muted-foreground",children:l})}),e.jsx(F,{children:r?e.jsx(_,{className:"h-8 w-20"}):e.jsx("div",{className:"text-3xl font-semibold",children:n??"—"})})]})}function Be(){return M({queryKey:k.houseTechList,queryFn:he,staleTime:60*1e3})}function qe(){const{data:l=[],isLoading:n}=Be(),[r,c]=v.useState(""),[u,i]=v.useState(void 0),p=r.trim().toLowerCase();return e.jsxs(E,{children:[e.jsx(R,{children:e.jsxs(I,{className:"flex flex-col gap-2 text-base sm:flex-row sm:items-end sm:justify-between",children:[e.jsx("span",{children:"Tarifas personalizadas"}),e.jsx(Y,{placeholder:"Buscar técnicos...",value:r,onChange:a=>c(a.target.value),className:"sm:w-64",onClick:a=>a.stopPropagation(),onKeyDown:a=>a.stopPropagation(),onKeyUp:a=>a.stopPropagation(),onKeyPress:a=>a.stopPropagation()})]})}),e.jsxs(F,{children:[n&&e.jsx(_,{className:"h-32 w-full"}),!n&&l.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"No hay técnicos disponibles."}),!n&&l.length>0&&e.jsxs(e.Fragment,{children:[p&&l.every(a=>!a.profileName.toLowerCase().includes(p))&&e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"No se encontraron técnicos con ese nombre."}),e.jsx(ye,{type:"single",collapsible:!0,className:"space-y-2",value:u,onValueChange:i,children:l.map(a=>{const y=!p||a.profileName.toLowerCase().includes(p);return e.jsxs(Te,{value:a.profileId,className:`border rounded-lg ${y?"":"hidden"}`,children:[e.jsx(Ce,{className:"px-4 py-3 hover:no-underline",children:e.jsxs("div",{className:"flex flex-col items-start gap-2 text-left sm:flex-row sm:items-center sm:justify-between sm:w-full",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium leading-tight",children:a.profileName}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Categoría por defecto: ",a.defaultCategory??"—"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[a.overrideBaseDay?e.jsxs(x,{variant:"secondary",children:["Tarifa personalizada: ",Q(a.overrideBaseDay)]}):e.jsx(x,{variant:"outline",children:"Usando valor por defecto"}),a.overrideUpdatedAt&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Actualizado ",A(new Date(a.overrideUpdatedAt),"PPP",{locale:D})]})]})]})}),e.jsx(Pe,{className:"px-4 pb-4",children:e.jsx(Se,{profileId:a.profileId,profileName:a.profileName,category:a.defaultCategory??void 0})})]},a.profileId)})})]})]})]})}function ze(){return M({queryKey:k.approvals,queryFn:je,staleTime:30*1e3})}function Oe({onManageTour:l}){const{data:n=[],isLoading:r}=ze(),[c,u]=m.useState(""),[i,p]=m.useState("all"),[a,y]=m.useState("all"),[j,o]=m.useState(1),[d,w]=m.useState(null),B=10,{userRole:H}=te(),W=m.useMemo(()=>["management","admin"].includes(H||""),[H]),Z=m.useCallback(s=>{w(s)},[]),X=m.useCallback(()=>w(null),[]),L=m.useCallback(s=>{const t=(s||"").toLowerCase();return t==="festival"?"Festival":t==="single"?"Trabajo":t==="tour"?"Gira":s||"Trabajo"},[]),T=m.useMemo(()=>{let s=n;if(s=s.filter(t=>(t.jobType||"").toLowerCase()!=="dryhire"),i!=="all"&&(s=s.filter(t=>t.entityType===i)),a!=="all"&&(s=s.filter(t=>a==="approved"==!!t.ratesApproved)),c.trim()){const t=c.toLowerCase();s=s.filter(h=>h.name.toLowerCase().includes(t))}return s},[n,i,a,c]),C=Math.max(1,Math.ceil(T.length/B)),ee=T.slice((j-1)*B,j*B);return m.useEffect(()=>{const s=new Date;let t=T.findIndex(f=>f.startDate&&new Date(f.startDate)>=s);t===-1&&(t=T.length-1);const h=Math.max(1,Math.min(C,Math.floor(t/B)+1));o(h)},[T,C]),e.jsxs(E,{children:[e.jsx(R,{children:e.jsxs("div",{className:"flex items-center justify-between gap-3 flex-wrap",children:[e.jsx(I,{className:"text-base",children:"Aprobaciones de tarifas"}),e.jsxs("div",{className:"flex items-center gap-2 w-full md:w-auto",children:[e.jsx("div",{className:"w-full md:w-64",children:e.jsx(Y,{value:c,onChange:s=>u(s.target.value),placeholder:"Buscar trabajos o giras"})}),e.jsxs(K,{value:i,onValueChange:s=>p(s),children:[e.jsx(V,{className:"w-32",children:e.jsx(U,{placeholder:"Tipo"})}),e.jsxs(G,{children:[e.jsx(P,{value:"all",children:"Todos"}),e.jsx(P,{value:"tour",children:"Giras"}),e.jsx(P,{value:"job",children:"Trabajos"})]})]}),e.jsxs(K,{value:a,onValueChange:s=>y(s),children:[e.jsx(V,{className:"w-36",children:e.jsx(U,{placeholder:"Aprobación"})}),e.jsxs(G,{children:[e.jsx(P,{value:"all",children:"Todas"}),e.jsx(P,{value:"pending",children:"Pendientes"}),e.jsx(P,{value:"approved",children:"Aprobadas"})]})]})]})]})}),e.jsx(F,{children:r?e.jsx(_,{className:"h-48 w-full"}):T.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No hay elementos que coincidan con tus filtros."}):e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs(Ae,{children:[e.jsx(De,{children:e.jsxs($,{children:[e.jsx(b,{children:"Nombre"}),e.jsx(b,{children:"Tipo"}),e.jsx(b,{children:"Inicio"}),e.jsx(b,{className:"text-right",children:"Trabajos"}),e.jsx(b,{className:"text-right",children:"Asignaciones"}),e.jsx(b,{children:"Estado"}),e.jsx(b,{className:"text-right",children:"Acciones"})]})}),e.jsx(we,{children:ee.map(s=>e.jsxs($,{children:[e.jsxs(N,{children:[e.jsx("div",{className:"font-medium leading-tight",children:s.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.endDate?`Termina ${A(new Date(s.endDate),"PPP",{locale:D})}`:"Fecha fin por definir"})]}),e.jsx(N,{children:s.entityType==="tour"?e.jsx(x,{variant:"outline",children:"Gira"}):e.jsx(x,{variant:"secondary",children:L(s.jobType)})}),e.jsx(N,{children:s.startDate?A(new Date(s.startDate),"PPP",{locale:D}):"—"}),e.jsx(N,{className:"text-right",children:s.jobCount}),e.jsx(N,{className:"text-right",children:s.assignmentCount}),e.jsx(N,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:s.pendingIssues.length===0?e.jsx(x,{variant:"outline",children:"Listo"}):s.pendingIssues.map(t=>{const h=t==="Approval required"||t==="Timesheets rejected"||t==="Extras rejected",f=t==="Approval required"?"Se requiere aprobación":t==="No tour jobs"?"Sin trabajos de gira":t==="No assignments"?"Sin asignaciones":t==="No timesheets"?"Sin partes":t==="Timesheets pending"?"Partes pendientes":t==="Timesheets rejected"?"Partes rechazados":t==="Extras pending"?"Extras pendientes":t==="Extras rejected"?"Extras rechazados":t;return e.jsx(x,{variant:h?"destructive":"secondary",children:f},t)})})}),e.jsx(N,{className:"text-right",children:s.entityType==="tour"?e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(S,{size:"sm",variant:"outline",onClick:async()=>{try{const{data:t,error:h}=await re.from("jobs").select("id, title, start_time, end_time, job_type").eq("tour_id",s.id).order("start_time",{ascending:!0});if(h)throw h;const f=(t||[]).filter(g=>(g.job_type??"").toLowerCase()!=="dryhire");if(f.length===0){q.error("No hay trabajos de gira para exportar");return}const se=f.map(g=>({id:g.id,title:g.title,start_time:g.start_time,end_time:g.end_time??null,job_type:g.job_type??null})),{jobsWithQuotes:J,profiles:ae}=await fe(s.id,se);if(!J.length){q.error("No hay asignaciones con tarifas para exportar.");return}await Ee(s.name,J,ae),q.success("PDF de gira generado")}catch{q.error("No se pudo generar el PDF de la gira")}},children:e.jsx(Ie,{className:"h-4 w-4"})}),e.jsx(S,{size:"sm",onClick:()=>l(s.id),children:"Gestionar"})]}):e.jsxs("div",{className:"flex justify-end gap-2",children:[W&&e.jsx(S,{size:"sm",onClick:()=>Z(s),children:"Ver totales"}),e.jsx(S,{size:"sm",variant:"outline",asChild:!0,children:e.jsx(ie,{to:`/management/rates?tab=timesheets&jobId=${s.id}`,children:"Revisar partes"})})]})})]},s.id))})]}),C>1&&e.jsxs("div",{className:"flex items-center justify-end gap-3 mt-3",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Página ",j," de ",C]}),e.jsxs("div",{className:"space-x-2",children:[e.jsx(S,{size:"sm",variant:"outline",disabled:j<=1,onClick:()=>o(s=>Math.max(1,s-1)),children:"Anterior"}),e.jsx(S,{size:"sm",variant:"outline",disabled:j>=C,onClick:()=>o(s=>Math.min(C,s+1)),children:"Siguiente"})]})]})]})}),e.jsx(ne,{open:!!d,onOpenChange:s=>{s||X()},children:e.jsxs(le,{className:"max-w-4xl",children:[e.jsxs(oe,{children:[e.jsx(de,{children:"Totales de pagos del trabajo"}),e.jsx(ce,{children:"Consulta los totales aprobados, LPO y exporta el PDF con el mismo formato que las giras."})]}),d&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"rounded-lg border bg-muted/40 p-4 text-sm",children:e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-base leading-tight",children:d.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:d.startDate?`Comienza ${A(new Date(d.startDate),"PPP",{locale:D})}`:"Fecha de inicio por definir"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(x,{variant:"secondary",children:L(d.jobType)}),e.jsx(x,{variant:d.ratesApproved?"outline":"destructive",children:d.ratesApproved?"Tarifas aprobadas":"Aprobación pendiente"})]})]})}),e.jsx(Re,{jobId:d.id})]})]})})]})}function Me(){return M({queryKey:k.overview,queryFn:ge,staleTime:60*1e3})}const ke=[{id:"catalogs",label:"Catálogo de tarifas"},{id:"overrides",label:"Tarifas internas"},{id:"approvals",label:"Aprobaciones"},{id:"timesheets",label:"Partes de horas"}];function aa(){const{data:l,isLoading:n}=Me(),[r,c]=me(),u=r.get("tab")||"catalogs",[i,p]=v.useState(u),[a,y]=v.useState(null),j=v.useMemo(()=>!!a,[a]);return v.useEffect(()=>{const o=r.get("tab"),d=r.get("jobId"),w=o||(d?"timesheets":i);w!==i&&p(w)},[r]),v.useEffect(()=>{if(r.get("tab")!==i){const d=new URLSearchParams(r);d.set("tab",i),c(d,{replace:!0})}},[i]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Centro de Tarifas y Extras"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Configura valores por defecto de gira, extras y overrides de house desde un único panel de gestión."})]}),e.jsx(_e,{overview:l,isLoading:n}),e.jsxs(xe,{value:i,onValueChange:o=>p(o),children:[e.jsx(pe,{className:"w-full sm:w-auto",children:ke.map(o=>e.jsx(ue,{value:o.id,className:"flex-1 sm:flex-none",children:o.label},o.id))}),e.jsx(z,{value:"catalogs",className:"mt-4",children:e.jsxs("div",{className:"grid gap-4 lg:grid-cols-2",children:[e.jsx(be,{}),e.jsx(Ne,{})]})}),e.jsx(z,{value:"overrides",className:"mt-4",children:e.jsx(qe,{})}),e.jsx(z,{value:"approvals",className:"mt-4",children:e.jsx(Oe,{onManageTour:y})}),e.jsx(z,{value:"timesheets",className:"mt-4",children:e.jsx(Fe,{})})]}),a&&e.jsx(ve,{open:j,onOpenChange:o=>{o||y(null)},tourId:a})]})}export{aa as default};
