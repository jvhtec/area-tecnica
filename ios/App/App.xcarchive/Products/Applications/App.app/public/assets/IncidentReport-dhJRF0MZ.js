import{r as d,e as S,j as e,C as T,W as y,Y as I,A as k,L as i,S as q,t as E,v as M,w as P,x as R,I as p,ac as f,B as t,X as v,D as L,aF as G,q as z,F as A,G as H,U as J}from"./index-NZ6jJLfQ.js";import{P as w,S as O}from"./index-vfKqQWY5.js";import{u as _}from"./useJobSelection-B9iLNF5-.js";import{g as B}from"./TechnicianIncidentReportDialog-Bb0qWmts.js";import{F as Q}from"./file-text-igU140SQ.js";import{D as U}from"./download-C1rVE0-J.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./pdf-libs-BqoGqu1a.js";import"./useQuery-kdg2pmgf.js";import"./logo-service-SlbhM6-i.js";import"./jobDocumentsUpload-BaycvzFe.js";import"./clipboard-list-wtFE30Ps.js";import"./triangle-alert-D6qN0F8g.js";import"./save-z_re-Mcq.js";const oe=()=>{const[s,m]=d.useState({jobId:"",equipmentModel:"",brand:"",issue:"",actionsTaken:"",techName:"",signature:""}),[b,u]=d.useState(!1),[h,g]=d.useState(!1),o=d.useRef(null),{data:l}=_(),{toast:c}=S(),r=(a,n)=>{m(x=>({...x,[a]:n}))},N=()=>{if(!o.current)return;const a=o.current.toDataURL();m(n=>({...n,signature:a})),u(!1),c({title:"Firma guardada",description:"La firma digital ha sido añadida al reporte."})},C=()=>{o.current&&o.current.clear()},j=()=>{m({jobId:"",equipmentModel:"",brand:"",issue:"",actionsTaken:"",techName:"",signature:""})},D=()=>{const a=["jobId","equipmentModel","brand","issue","actionsTaken","techName"];for(const n of a)if(!s[n].trim())return c({title:"Campos requeridos",description:"Por favor complete todos los campos obligatorios.",variant:"destructive"}),!1;return s.signature?!0:(c({title:"Firma requerida",description:"Por favor añada su firma digital al reporte.",variant:"destructive"}),!1)},F=async()=>{if(D()){g(!0);try{const a=l==null?void 0:l.find(x=>x.id===s.jobId);if(!a)throw new Error("Job no encontrado");const n=await B({...s,jobTitle:a.title,jobStartDate:a.start_time,jobEndDate:a.end_time},{saveToDatabase:!0,downloadLocal:!0});c({title:"✅ Reporte generado y guardado",description:"El reporte de incidencia ha sido generado, guardado en el sistema y descargado correctamente."}),j()}catch{c({title:"❌ Error",description:"Hubo un problema al generar el reporte de incidencia.",variant:"destructive"})}finally{g(!1)}}};return e.jsxs(T,{className:"w-full max-w-4xl mx-auto my-6",children:[e.jsx(y,{className:"space-y-1",children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"h-5 w-5"}),"Reporte de Incidencia - Sound"]})}),e.jsxs(k,{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx(i,{htmlFor:"jobSelect",children:"Trabajo Asociado *"}),e.jsxs(q,{value:s.jobId,onValueChange:a=>r("jobId",a),children:[e.jsx(E,{children:e.jsx(M,{placeholder:"Seleccionar trabajo..."})}),e.jsx(P,{children:l==null?void 0:l.map(a=>e.jsxs(R,{value:a.id,children:[a.title," - ",new Date(a.start_time).toLocaleDateString("es-ES")]},a.id))})]})]})}),e.jsx("div",{className:"space-y-4 pt-4 border-t",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(i,{htmlFor:"equipmentModel",children:"Modelo de Equipo *"}),e.jsx(p,{id:"equipmentModel",value:s.equipmentModel,onChange:a=>r("equipmentModel",a.target.value),placeholder:"ej. QSC K12.2"})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"brand",children:"Marca *"}),e.jsx(p,{id:"brand",value:s.brand,onChange:a=>r("brand",a.target.value),placeholder:"ej. QSC"})]})]})}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx(i,{htmlFor:"issue",children:"Descripción de la Incidencia *"}),e.jsx(f,{id:"issue",value:s.issue,onChange:a=>r("issue",a.target.value),placeholder:"Describa detalladamente la incidencia ocurrida...",rows:4})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx(i,{htmlFor:"actionsTaken",children:"Acciones Realizadas *"}),e.jsx(f,{id:"actionsTaken",value:s.actionsTaken,onChange:a=>r("actionsTaken",a.target.value),placeholder:"Describa las acciones tomadas para resolver la incidencia...",rows:4})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx(i,{htmlFor:"techName",children:"Nombre del Técnico *"}),e.jsx(p,{id:"techName",value:s.techName,onChange:a=>r("techName",a.target.value),placeholder:"Nombre completo del técnico"})]}),e.jsxs("div",{className:"space-y-3 pt-4 border-t",children:[e.jsx(i,{children:"Firma Digital *"}),s.signature?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"border rounded-lg p-4 bg-muted",children:e.jsx("img",{src:s.signature,alt:"Firma",width:400,height:150,loading:"lazy",decoding:"async",className:"max-w-full h-20 object-contain mx-auto"})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(t,{variant:"outline",size:"sm",onClick:()=>u(!0),className:"w-full sm:w-auto",children:[e.jsx(w,{className:"h-4 w-4 mr-2"}),"Cambiar Firma"]}),e.jsxs(t,{variant:"outline",size:"sm",onClick:()=>r("signature",""),className:"w-full sm:w-auto",children:[e.jsx(v,{className:"h-4 w-4 mr-2"}),"Eliminar Firma"]})]})]}):e.jsxs(L,{open:b,onOpenChange:u,children:[e.jsx(G,{asChild:!0,children:e.jsxs(t,{variant:"outline",className:"w-full",children:[e.jsx(w,{className:"h-4 w-4 mr-2"}),"Añadir Firma Digital"]})}),e.jsxs(z,{className:"max-w-[95vw] sm:max-w-md",children:[e.jsx(A,{children:e.jsx(H,{children:"Firma Digital"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border rounded-lg p-2 bg-muted overflow-hidden",children:e.jsx(O,{ref:o,canvasProps:{width:400,height:150,className:"signature-canvas w-full max-w-full"},backgroundColor:"white"})}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between gap-2",children:[e.jsxs(t,{variant:"outline",onClick:C,className:"flex items-center gap-2 w-full sm:w-auto",children:[e.jsx(v,{className:"h-4 w-4"}),"Limpiar"]}),e.jsxs(t,{onClick:N,className:"flex items-center gap-2 w-full sm:w-auto",children:[e.jsx(J,{className:"h-4 w-4"}),"Guardar Firma"]})]})]})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between gap-4 pt-6 border-t bg-muted/30 -mx-6 px-6 pb-6",children:[e.jsx(t,{variant:"outline",onClick:j,disabled:h,className:"w-full sm:w-auto",children:"Limpiar Formulario"}),e.jsxs(t,{onClick:F,disabled:h,className:"flex items-center gap-2 w-full sm:w-auto",children:[e.jsx(U,{className:"h-4 w-4"}),h?"Generando...":"Generar PDF"]})]})]})]})};export{oe as IncidentReport};
