import{l as $e,e as es,u as ss,f as as,r,s as d,j as e,I as c,B as l,L as u,S as re,t as ne,v as ie,w as le,x as oe,a as w,P as ts,Q as rs,U as Ae,X as ze,V as ns,D as is,q as ls,F as os,G as cs,aL as ds}from"./index-NZ6jJLfQ.js";import{a as us,b as _}from"./equipment-B5qd5N3O.js";import{S as ms}from"./scroll-area-BHjMXddA.js";import{u as Le}from"./useQuery-kdg2pmgf.js";import{u as y}from"./useMutation-DluhVBs1.js";import{C as D,a as U,b as A}from"./collapsible-DWBtmsfD.js";import{S as hs}from"./search-D-OiWg8h.js";import{P as Qe}from"./plus-C3JQqq7t.js";import{L as Pe}from"./link-z6ku9ZYO.js";import{C as Oe}from"./clipboard-paste-CkPncGV3.js";import{D as Re}from"./download-C1rVE0-J.js";import{C as xs}from"./chevron-right-Bn7Eu0F7.js";import{P as gs}from"./pencil-BxZTvEYh.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ps=$e("Settings2",[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]]),fs=/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}/,Ls=({stock:js,onStockUpdate:vs,department:g})=>{const{toast:o}=es(),{session:z}=ss(),f=as(),[j,Me]=r.useState(""),[ce,de]=r.useState(new Set),[ue,me]=r.useState(!1),[N,L]=r.useState(null),[Ke,Q]=r.useState(null),[Te,P]=r.useState(null),[b,O]=r.useState(""),[R,he]=r.useState(""),[M,xe]=r.useState(0),[ge,K]=r.useState(""),[C,F]=r.useState(""),[pe,T]=r.useState(""),[B,V]=r.useState(""),[fe,je]=r.useState(!1),[m,ve]=r.useState(!1),[G,H]=r.useState(""),[we,W]=r.useState(""),[X,ye]=r.useState(null),[J,E]=r.useState(""),[Ne,Y]=r.useState(""),[be,q]=r.useState(""),[S,v]=r.useState(""),[Ce,I]=r.useState(""),[Z,k]=r.useState(""),[Fe,$]=r.useState(!1),[x,Ee]=r.useState(!1),p=us(g);r.useEffect(()=>{p.length>0&&!R&&he(p[0])},[p]);const qe=s=>{const a=s.match(fs);return(a==null?void 0:a[0])||null},Se=async(s=!1)=>{try{const a=await navigator.clipboard.readText();s?k(a):V(a);const t=qe(a);t&&(s?v(t):F(t),o({title:"UUID extraído",description:"Se ha extraído el ID del recurso de Flex."}))}catch{o({title:"Error",description:"No se pudo acceder al portapapeles.",variant:"destructive"})}},Ie=async(s=!1)=>{const n=(s?S:C)||qe(s?Z:B);if(!n){o({title:"Error",description:"No hay un ID de recurso válido para buscar.",variant:"destructive"});return}try{s?Ee(!0):ve(!0);const{data:i,error:Ue}=await d.functions.invoke("fetch-flex-inventory-model",{body:{model_id:n}});if(Ue)throw Ue;if(i!=null&&i.error)throw new Error(i.error);const h=(i==null?void 0:i.mapped)||{};s?(h.name&&E(h.name),h.manufacturer&&q(h.manufacturer),i!=null&&i.model_id&&v(i.model_id),h.imageId&&I(h.imageId)):(h.name&&O(h.name),h.manufacturer&&K(h.manufacturer),i!=null&&i.model_id&&F(i.model_id),h.imageId&&T(h.imageId)),o({title:"Datos obtenidos",description:"Los datos del equipo se han rellenado desde Flex."})}catch(i){o({title:"Error al obtener datos",description:(i==null?void 0:i.message)||"Error desconocido",variant:"destructive"})}finally{s?Ee(!1):ve(!1)}},Be=s=>{ye(s),E(s.name),Y(s.category),q(s.manufacturer||""),v(s.resource_id||""),I(s.image_id||""),k(""),$(!!(s.resource_id||s.manufacturer||s.image_id))},ee=()=>{ye(null),E(""),Y(""),q(""),v(""),I(""),k(""),$(!1)},ke=()=>{O(""),xe(0),K(""),F(""),T(""),V(""),je(!1),me(!1)},{data:Ve=[],refetch:ws}=Le({queryKey:["equipment",g],queryFn:async()=>{const{data:s,error:a}=await d.from("equipment").select("*").in("category",p).order("category").order("name");if(a)throw a;return s}}),{data:Ge=[]}=Le({queryKey:["current-stock-levels",g],queryFn:async()=>{const{data:s,error:a}=await d.from("current_stock_levels").select("*").in("category",p);if(a)throw a;return s}}),se=Ve.map(s=>{const a=Ge.find(t=>t.equipment_id===s.id);return{...s,quantity:(a==null?void 0:a.current_quantity)||0}}).filter(s=>s.name.toLowerCase().includes(j.toLowerCase())).reduce((s,a)=>{const t=a.category||"uncategorized";return s[t]||(s[t]=[]),s[t].push(a),s},{});r.useEffect(()=>{j&&de(new Set(Object.keys(se)))},[j]);const He=s=>{de(a=>{const t=new Set(a);return t.has(s)?t.delete(s):t.add(s),t})},ae=y({mutationFn:async()=>{var t;if(!((t=z==null?void 0:z.user)!=null&&t.id))throw new Error("Must be logged in");if(!b.trim())throw new Error("Name is required");const{data:s,error:a}=await d.from("equipment").insert({name:b.trim(),category:R,manufacturer:ge.trim()||null,resource_id:C.trim()||null,image_id:pe.trim()||null}).select().single();if(a)throw a;if(M>0){const{error:n}=await d.from("global_stock_entries").insert({equipment_id:s.id,base_quantity:M});if(n)throw n}return s},onSuccess:()=>{f.invalidateQueries({queryKey:["equipment",g]}),f.invalidateQueries({queryKey:["current-stock-levels",g]}),ke(),o({title:"Equipo creado correctamente"})},onError:s=>{o({variant:"destructive",title:"Error",description:s.message})}}),_e=y({mutationFn:async({id:s,name:a,category:t})=>{const{error:n}=await d.from("equipment").update({name:a,category:t}).eq("id",s);if(n)throw n},onSuccess:()=>{f.invalidateQueries({queryKey:["equipment",g]}),L(null),o({title:"Equipo actualizado"})},onError:s=>{o({variant:"destructive",title:"Error",description:s.message})}}),te=y({mutationFn:async()=>{if(!X)throw new Error("No item selected");const{error:s}=await d.from("equipment").update({name:J.trim(),category:Ne,manufacturer:be.trim()||null,resource_id:S.trim()||null,image_id:Ce.trim()||null}).eq("id",X.id);if(s)throw s},onSuccess:()=>{f.invalidateQueries({queryKey:["equipment",g]}),ee(),o({title:"Equipo actualizado"})},onError:s=>{o({variant:"destructive",title:"Error",description:s.message})}}),De=y({mutationFn:async s=>{await d.from("global_stock_entries").delete().eq("equipment_id",s),await d.from("stock_movements").delete().eq("equipment_id",s);const{error:a}=await d.from("equipment").delete().eq("id",s);if(a)throw a},onSuccess:()=>{f.invalidateQueries({queryKey:["equipment",g]}),f.invalidateQueries({queryKey:["current-stock-levels",g]}),Q(null),o({title:"Equipo eliminado"})},onError:s=>{o({variant:"destructive",title:"Error",description:s.message})}}),We=y({mutationFn:async({equipmentId:s,quantity:a})=>{P(s);const{data:t}=await d.from("global_stock_entries").select("id").eq("equipment_id",s).maybeSingle();if(t){const{error:n}=await d.from("global_stock_entries").update({base_quantity:a}).eq("id",t.id);if(n)throw n}else{const{error:n}=await d.from("global_stock_entries").insert({equipment_id:s,base_quantity:a});if(n)throw n}},onSuccess:()=>{f.invalidateQueries({queryKey:["current-stock-levels",g]}),P(null)},onError:s=>{P(null),o({variant:"destructive",title:"Error",description:s.message})}}),Xe=(s,a)=>{const t=parseInt(a)||0;t>=0&&We.mutate({equipmentId:s,quantity:t})},Je=s=>{L(s.id),H(s.name),W(s.category)},Ye=()=>{L(null),H(""),W("")},Ze=()=>{N&&G.trim()&&_e.mutate({id:N,name:G.trim(),category:we})};return e.jsxs("div",{className:"flex flex-col h-full gap-4",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx(hs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(c,{placeholder:"Buscar equipo...",value:j,onChange:s=>Me(s.target.value),className:"pl-9"})]}),e.jsxs(D,{open:ue,onOpenChange:me,className:"flex-shrink-0",children:[e.jsx(U,{asChild:!0,children:e.jsxs(l,{variant:"outline",className:"w-full justify-start",children:[e.jsx(Qe,{className:"mr-2 h-4 w-4"}),ue?"Cancelar":"Añadir Equipo"]})}),e.jsxs(A,{className:"mt-3 p-4 border rounded-lg space-y-3 bg-muted/30",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"sm:col-span-1",children:[e.jsx(u,{htmlFor:"new-name",children:"Nombre"}),e.jsx(c,{id:"new-name",value:b,onChange:s=>O(s.target.value),placeholder:"Nombre del equipo",className:"mt-1",disabled:m})]}),e.jsxs("div",{children:[e.jsx(u,{children:"Categoría"}),e.jsxs(re,{value:R,onValueChange:he,disabled:m,children:[e.jsx(ne,{className:"mt-1",children:e.jsx(ie,{})}),e.jsx(le,{children:p.map(s=>e.jsx(oe,{value:s,children:_[s]||s},s))})]})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"new-qty",children:"Cantidad"}),e.jsx(c,{id:"new-qty",type:"number",min:"0",value:M,onChange:s=>xe(parseInt(s.target.value)||0),className:"mt-1",disabled:m})]})]}),e.jsxs(D,{open:fe,onOpenChange:je,children:[e.jsx(U,{asChild:!0,children:e.jsxs(l,{type:"button",variant:"ghost",size:"sm",className:"w-full justify-start text-muted-foreground",children:[e.jsx(Pe,{className:"mr-2 h-4 w-4"}),fe?"Ocultar integración Flex":"Integración con Flex (opcional)"]})}),e.jsxs(A,{className:"space-y-3 mt-2 p-3 border rounded-md bg-background",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"new-manufacturer",children:"Fabricante"}),e.jsx(c,{id:"new-manufacturer",value:ge,onChange:s=>K(s.target.value),placeholder:"Fabricante (opcional)",className:"mt-1",disabled:m})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"new-resourceId",children:"Flex Resource ID"}),e.jsx(c,{id:"new-resourceId",value:C,onChange:s=>F(s.target.value),placeholder:"UUID del recurso en Flex",className:"mt-1",disabled:m})]}),e.jsxs("div",{children:[e.jsx(u,{children:"URL de Flex"}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx(c,{value:B,onChange:s=>V(s.target.value),placeholder:"Pegar URL de Flex",disabled:m,className:"flex-1"}),e.jsx(l,{type:"button",variant:"outline",size:"icon",onClick:()=>Se(!1),disabled:m,title:"Pegar URL",children:e.jsx(Oe,{className:"h-4 w-4"})}),e.jsxs(l,{type:"button",variant:"secondary",size:"sm",onClick:()=>Ie(!1),disabled:m||!C&&!B,children:[m?e.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(Re,{className:"mr-2 h-4 w-4"}),m?"Obteniendo...":"Obtener"]})]})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"new-imageId",children:"Image ID"}),e.jsx(c,{id:"new-imageId",value:pe,onChange:s=>T(s.target.value),placeholder:"ID de imagen de Flex",className:"mt-1",disabled:m})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(l,{variant:"ghost",size:"sm",onClick:ke,children:"Cancelar"}),e.jsxs(l,{size:"sm",onClick:()=>ae.mutate(),disabled:!b.trim()||ae.isPending||m,children:[ae.isPending?e.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(Qe,{className:"mr-2 h-4 w-4"}),"Guardar"]})]})]})]}),e.jsx(ms,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:"space-y-2 pr-4",children:[Object.entries(se).map(([s,a])=>e.jsxs(D,{open:ce.has(s),onOpenChange:()=>He(s),children:[e.jsxs(U,{className:"flex items-center justify-between w-full p-3 rounded-lg bg-muted/50 hover:bg-muted transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[ce.has(s)?e.jsx(ts,{className:"h-4 w-4"}):e.jsx(xs,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:_[s]||s})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[a.length," ",a.length===1?"item":"items"]})]}),e.jsx(A,{className:"mt-1",children:e.jsx("div",{className:"space-y-1 pl-2",children:a.map(t=>e.jsx("div",{className:rs("flex items-center gap-2 p-2 rounded-md",N===t.id&&"bg-muted"),children:N===t.id?e.jsxs(e.Fragment,{children:[e.jsx(c,{value:G,onChange:n=>H(n.target.value),className:"flex-1 h-8"}),e.jsxs(re,{value:we,onValueChange:W,children:[e.jsx(ne,{className:"w-32 h-8",children:e.jsx(ie,{})}),e.jsx(le,{children:p.map(n=>e.jsx(oe,{value:n,children:_[n]||n},n))})]}),e.jsx(l,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:Ze,disabled:_e.isPending,children:e.jsx(Ae,{className:"h-4 w-4 text-green-600"})}),e.jsx(l,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:Ye,children:e.jsx(ze,{className:"h-4 w-4"})})]}):Ke===t.id?e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"flex-1 text-sm",children:["Eliminar ",t.name,"?"]}),e.jsx(l,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>De.mutate(t.id),disabled:De.isPending,children:e.jsx(Ae,{className:"h-4 w-4 text-red-600"})}),e.jsx(l,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>Q(null),children:e.jsx(ze,{className:"h-4 w-4"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"flex-1 text-sm",children:t.name}),e.jsx(l,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>Je(t),title:"Edición rápida",children:e.jsx(gs,{className:"h-3 w-3"})}),e.jsx(l,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>Be(t),title:"Edición avanzada (Flex)",children:e.jsx(ps,{className:"h-3 w-3"})}),e.jsx(l,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>Q(t.id),title:"Eliminar",children:e.jsx(ns,{className:"h-3 w-3"})}),e.jsxs("div",{className:"relative w-20",children:[e.jsx(c,{type:"number",min:"0",defaultValue:t.quantity,onBlur:n=>Xe(t.id,n.target.value),onKeyDown:n=>{n.key==="Enter"&&n.target.blur()},className:"h-8 text-center pr-6"}),Te===t.id&&e.jsx(w,{className:"absolute right-2 top-1/2 -translate-y-1/2 h-3 w-3 animate-spin text-muted-foreground"})]})]})},t.id))})})]},s)),Object.keys(se).length===0&&e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:j?"No se encontraron equipos":"No hay equipos. Añade uno para empezar."})]})}),e.jsx(is,{open:!!X,onOpenChange:s=>!s&&ee(),children:e.jsxs(ls,{className:"max-w-lg",children:[e.jsx(os,{children:e.jsx(cs,{children:"Editar Equipo"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"adv-name",children:"Nombre del Equipo"}),e.jsx(c,{id:"adv-name",value:J,onChange:s=>E(s.target.value),placeholder:"Nombre del equipo",className:"mt-1",disabled:x})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"adv-manufacturer",children:"Fabricante"}),e.jsx(c,{id:"adv-manufacturer",value:be,onChange:s=>q(s.target.value),placeholder:"Fabricante (opcional)",className:"mt-1",disabled:x})]}),e.jsxs("div",{children:[e.jsx(u,{children:"Categoría"}),e.jsxs(re,{value:Ne,onValueChange:Y,disabled:x,children:[e.jsx(ne,{className:"mt-1",children:e.jsx(ie,{})}),e.jsx(le,{children:p.map(s=>e.jsx(oe,{value:s,children:_[s]||s},s))})]})]}),e.jsxs(D,{open:Fe,onOpenChange:$,children:[e.jsx(U,{asChild:!0,children:e.jsxs(l,{type:"button",variant:"outline",size:"sm",className:"w-full",children:[e.jsx(Pe,{className:"mr-2 h-4 w-4"}),Fe?"Ocultar integración Flex":"Integración con Flex (opcional)"]})}),e.jsxs(A,{className:"space-y-3 mt-3 border rounded-md p-3",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"adv-resourceId",children:"Flex Resource ID"}),e.jsx(c,{id:"adv-resourceId",value:S,onChange:s=>v(s.target.value),placeholder:"UUID del recurso en Flex",className:"mt-1",disabled:x})]}),e.jsxs("div",{children:[e.jsx(u,{children:"URL de Flex"}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx(c,{value:Z,onChange:s=>k(s.target.value),placeholder:"Pegar URL de Flex",disabled:x,className:"flex-1"}),e.jsx(l,{type:"button",variant:"outline",size:"icon",onClick:()=>Se(!0),disabled:x,title:"Pegar URL",children:e.jsx(Oe,{className:"h-4 w-4"})}),e.jsxs(l,{type:"button",variant:"secondary",size:"sm",onClick:()=>Ie(!0),disabled:x||!S&&!Z,children:[x?e.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(Re,{className:"mr-2 h-4 w-4"}),x?"Obteniendo...":"Obtener"]})]})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"adv-imageId",children:"Image ID"}),e.jsx(c,{id:"adv-imageId",value:Ce,onChange:s=>I(s.target.value),placeholder:"ID de imagen de Flex",className:"mt-1",disabled:x})]})]})]})]}),e.jsxs(ds,{children:[e.jsx(l,{type:"button",variant:"outline",onClick:ee,children:"Cancelar"}),e.jsxs(l,{onClick:()=>te.mutate(),disabled:!J.trim()||te.isPending||x,children:[te.isPending?e.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}):null,"Guardar"]})]})]})})]})};export{Ls as S};
