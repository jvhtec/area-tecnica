const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/maps-lib-Ce1ARJmz.js","assets/commonjs-helpers-Cpj98o6Y.js","assets/maps-lib-CtPDR2nd.css"])))=>i.map(i=>d[i]);
import{l as Os,al as ws,aR as ut,e as me,r as T,j as e,D as xe,q as pe,F as fe,G as ge,L as R,S as ie,t as le,v as oe,w as ce,x as K,I as ee,B as F,i as L,s as $,p as is,a4 as Ee,aK as Ge,aL as Gs,u as Ve,f as Ze,n as Q,o as ht,V as We,ac as xt,C as W,W as te,cc as pt,X as os,A as B,a as Z,Y as ae,Q as _s,M as Ne,m as I,R as ft,bh as gt,c as jt,b as vt,aM as yt}from"./index-NZ6jJLfQ.js";import{u as Se}from"./useQuery-kdg2pmgf.js";import{B as U}from"./badge-vNTKF5RD.js";import{T as Nt}from"./TourRatesManagerDialog-J5sncCSp.js";import{a as bt}from"./useTourRatesApproval-CR_t91JW.js";import{b as wt,W as _t,a as Cs,T as Ct,c as St,e as Tt}from"./tourPdfExport-DYrs6JHM.js";import{R as Ss}from"./transportOptions-CtHnG2xX.js";import{u as Ce}from"./useMutation-DluhVBs1.js";import{S as kt}from"./separator-E-JdTFOv.js";import{U as ke}from"./users-DMnpVLUq.js";import{E as Je}from"./eye-BE_DouVP.js";import{I as Vs}from"./info-CpCfiYD2.js";import{T as Mt}from"./target-kNjpphh3.js";import{S as Pt}from"./send-Uvkx0r_O.js";import{P as Le}from"./plus-C3JQqq7t.js";import{F as he}from"./file-text-igU140SQ.js";import{C as se}from"./calendar-_Cj_Sgy-.js";import{D as Ie}from"./download-C1rVE0-J.js";import{P as Et}from"./progress-C8XsV-Me.js";import{U as Ws}from"./upload-DF4rjO7T.js";import{S as es}from"./scroll-area-BHjMXddA.js";import{P as Ft}from"./PresetEditor-zAPhu2I0.js";import{m as Dt}from"./equipment-B5qd5N3O.js";import{D as Ts}from"./DepartmentContext-CUMyywOO.js";import{AmplifierTool as At}from"./AmplifierTool-B8XV4xmK.js";import{C as Hs}from"./calculator-jIsLl-gd.js";import{C as zt}from"./copy-Dez5r9kU.js";import{P as qt}from"./pencil-BxZTvEYh.js";import{fetchTourLogo as He}from"./logoUtils-D2o1jUVg.js";import{u as Us}from"./useFlexUuid-C0fmwl_8.js";import{c as Bs}from"./icon-D8sTZPYx.js";import{o as Ys}from"./flexUuidService-C9yZjzP-.js";import{L as $t,T as Rt}from"./TaskManagerDialog-WHCTXr5s.js";import{T as Lt,a as It,b as be,c as we}from"./tabs-BdaywI_b.js";import{C as Ot}from"./chevron-left-rq2ui83a.js";import{C as Gt}from"./chevron-right-Bn7Eu0F7.js";import{C as Me}from"./clock-BXPvTWvY.js";import{C as Vt,M as Wt,T as Ht,a as Qe,B as ks,H as Ut,A as Bt,m as Yt}from"./MultiDayScheduleBuilder-DmGkt0fN.js";import{s as Ms,a as Ps}from"./startOfMonth-B5dVCv8B.js";import{e as Es}from"./endOfMonth-Byhxb84j.js";import{e as Kt}from"./eachDayOfInterval-CPmiA2bk.js";import{e as Y}from"./es-CSiFCUGj.js";import{i as Qt}from"./isSameMonth-BQ4F6s8O.js";import{S as Fe}from"./save-z_re-Mcq.js";import{C as Ks}from"./circle-alert-LZYNzZ7F.js";import{C as Jt}from"./car-vrO_NvCk.js";import{P as Xt}from"./plane-NSG-_bNT.js";import{H as cs}from"./house-CkarjnP3.js";import{S as rs}from"./star-icpn3ybK.js";import{P as Fs}from"./phone-BlFwiuho.js";import{M as Ds}from"./mail-1T3Omkp6.js";import{B as Zt}from"./briefcase-BrpPecAy.js";import{_ as As}from"./vite-preload-helper-ckwbz45p.js";import{M as Qs}from"./map-BKqH24gv.js";import{U as zs}from"./user-E3OATBQk.js";import{getWeatherForJob as Js}from"./weatherApi-BatwQpQy.js";import{a as ds}from"./lazyPdf-xVUlxKNu.js";import{S as ls}from"./settings-egXcSQW9.js";import{U as ea}from"./user-check-CYYJtyVp.js";import{E as sa}from"./euro-DgRTeGAz.js";import{B as ta}from"./box-C0bB0Qui.js";import{T as aa}from"./truck-Br5sduv3.js";import{A as qs}from"./arrow-left-VpQwT4cv.js";import{P as ra}from"./printer-De77t3j8.js";import{M as na}from"./message-circle-Bh9rUoQO.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./useManagerJobQuotes-BrI1iNRY.js";import"./tourRateMath-BOmIkfWO.js";import"./constants-DoXhG9KB.js";import"./useHouseTechRates-BLqiuvHa.js";import"./ratesQueryKeys-DgMsgg6U.js";import"./JobExtrasEditor-gQe73Sd8.js";import"./minus-InO4I9Ks.js";import"./useJobRatesApproval-DsfA8V9C.js";import"./alert-BqA-5jRM.js";import"./wrench-DzMvZxmF.js";import"./file-down-Buu6FgvW.js";import"./triangle-alert-D6qN0F8g.js";import"./api-C9EDenHJ.js";import"./config-DVV3VxR4.js";import"./useRealtimeSubscription-Bj7PWAKC.js";import"./checkbox-BsRNEGV1.js";import"./optimisticJobDeletionService-Bq-53fU4.js";import"./package-Oxfj-CNq.js";import"./folder-plus-DTUhlRcm.js";import"./square-pen-BMpSgZGa.js";import"./building-2-nIk8XRuA.js";import"./alert-dialog-CtyYUxwH.js";import"./pdfExport-DjZPdCcG.js";import"./useTourPowerDefaults-COrAOuj-.js";import"./useTourDefaultSets-CKjECdAO.js";import"./image--Pql38nK.js";import"./circle-x-DDzV-xk_.js";import"./circle-check-big-CilmNGCn.js";import"./flexPullsheets-DscweXrW.js";import"./circle-check-C0N48OpO.js";import"./search-D-OiWg8h.js";import"./index-hC3MxXep.js";import"./logo-url-cache-eY6nfvu7.js";import"./taskCompletion-NTcmWFA_.js";import"./table-DnQAmABX.js";import"./building-BdT03Y2e.js";import"./arrow-up-BTt-lBKB.js";import"./calendar-days-DcwEz6pd.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ia=Os("ChartColumn",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"M18 17V9",key:"2bz60n"}],["path",{d:"M13 17V5",key:"1frdt8"}],["path",{d:"M8 17v-3",key:"17ska0"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=Os("Route",[["circle",{cx:"6",cy:"19",r:"3",key:"1kj8tv"}],["path",{d:"M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15",key:"1d8sl"}],["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}]]);function la(s,l){const d=ws(s),r=ws(l),t=$s(d,r),a=Math.abs(ut(d,r));d.setDate(d.getDate()-t*a);const c=+($s(d,r)===-t),g=t*(a-c);return g===0?0:g}function $s(s,l){const d=s.getFullYear()-l.getFullYear()||s.getMonth()-l.getMonth()||s.getDate()-l.getDate()||s.getHours()-l.getHours()||s.getMinutes()-l.getMinutes()||s.getSeconds()-l.getSeconds()||s.getMilliseconds()-l.getMilliseconds();return d<0?-1:d>0?1:d}function oa({open:s,onOpenChange:l,tourId:d}){const{toast:r}=me(),[t,a]=T.useState("sound"),[c,g]=T.useState(""),[N,j]=T.useState([{transport_type:"trailer",leftover_space_meters:""}]),[b,P]=T.useState({}),{data:S=[]}=Se({queryKey:["tour-logistics-jobs",d],enabled:s&&!!d,queryFn:async()=>{const{data:m,error:i}=await $.from("jobs").select("id, title, start_time, job_type, status").eq("tour_id",d).eq("job_type","tourdate").order("start_time",{ascending:!0});if(i)throw i;return m||[]}}),n=T.useMemo(()=>S.map(m=>m.id),[S]),{data:k=[],refetch:v}=Se({queryKey:["tour-logistics-requests",d,t,n.join(",")],enabled:s&&n.length>0,queryFn:async()=>{const{data:m,error:i}=await $.from("transport_requests").select("id, job_id, department, note, items:transport_request_items(transport_type, leftover_space_meters)").in("job_id",n).eq("department",t);if(i)throw i;return m||[]}});T.useEffect(()=>{if(s)if(k.length>0){const m=k[0],i=Array.isArray(m.items)&&m.items.length>0?m.items.map(f=>({transport_type:f.transport_type,leftover_space_meters:f.leftover_space_meters??""})):[{transport_type:"trailer",leftover_space_meters:""}];j(i),g(m.note||"");const u={};k.forEach(f=>{const w=Array.isArray(f.items)?f.items.map(q=>({transport_type:q.transport_type,leftover_space_meters:q.leftover_space_meters??""})):[];(JSON.stringify(w)!==JSON.stringify(i)||(f.note||"")!==(m.note||""))&&(u[f.job_id]=w.length?w:[{transport_type:"trailer",leftover_space_meters:""}])}),P(u)}else j([{transport_type:"trailer",leftover_space_meters:""}]),g(""),P({})},[t,s,k]);const x=(m,i)=>{P(u=>({...u,[m]:i}))},y=m=>{P(i=>{const u={...i};return delete u[m],u})},p=async()=>{var m;try{const{data:i}=await $.auth.getUser(),u=(m=i.user)==null?void 0:m.id;if(!u)throw new Error("Not authenticated");for(const f of S){const w=f.id,A=b[w]||N,q=k.find(o=>o.job_id===w);let V=(q==null?void 0:q.id)||null;const H={job_id:w,department:t,note:c||null,status:(q==null?void 0:q.status)||"requested",created_by:(q==null?void 0:q.created_by)||u};if(V){const{error:o}=await $.from("transport_requests").update(H).eq("id",V);if(o)throw o;await $.from("transport_request_items").delete().eq("request_id",V);const _=A.filter(M=>!!M.transport_type).map(M=>({request_id:V,transport_type:M.transport_type,leftover_space_meters:M.leftover_space_meters===""?null:M.leftover_space_meters}));if(_.length){const{error:M}=await $.from("transport_request_items").insert(_);if(M)throw M}}else{const{data:o,error:_}=await $.from("transport_requests").insert(H).select("id").single();if(_)throw _;V=o.id;const M=A.filter(z=>!!z.transport_type).map(z=>({request_id:V,transport_type:z.transport_type,leftover_space_meters:z.leftover_space_meters===""?null:z.leftover_space_meters}));if(M.length){const{error:z}=await $.from("transport_request_items").insert(M);if(z)throw z}}}r({title:"Logística actualizada para las fechas de gira"}),await v(),l(!1)}catch(i){r({title:"Error",description:i.message||"Error al guardar la logística",variant:"destructive"})}};return e.jsx(xe,{open:s,onOpenChange:l,children:e.jsxs(pe,{className:"max-w-3xl w-[95vw] md:w-full max-h-[95vh] md:max-h-[90vh] overflow-y-auto",children:[e.jsx(fe,{children:e.jsx(ge,{className:"text-base md:text-lg",children:"Logística de Gira – Transporte"})}),e.jsxs("div",{className:"flex flex-wrap gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx(R,{children:"Departamento"}),e.jsxs(ie,{value:t,onValueChange:m=>a(m),children:[e.jsx(le,{className:"w-40",children:e.jsx(oe,{})}),e.jsxs(ce,{children:[e.jsx(K,{value:"sound",children:"Sonido"}),e.jsx(K,{value:"lights",children:"Luces"}),e.jsx(K,{value:"video",children:"Vídeo"})]})]})]}),e.jsxs("div",{className:"flex-1 min-w-[240px]",children:[e.jsx(R,{children:"Nota (se aplica a todas a menos que se anule en los elementos)"}),e.jsx(ee,{value:c,onChange:m=>g(m.target.value),placeholder:"Nota opcional"})]}),e.jsx("div",{className:"ml-auto",children:e.jsx(F,{onClick:p,children:"Guardar en todas las fechas"})})]}),e.jsxs("div",{className:"mt-4 space-y-2",children:[e.jsx(R,{children:"Vehículos por defecto para la gira"}),e.jsxs("div",{className:"space-y-2",children:[N.map((m,i)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(ie,{value:m.transport_type,onValueChange:u=>{const f=N.slice();f[i]={...f[i],transport_type:u},j(f)},children:[e.jsx(le,{className:"w-40",children:e.jsx(oe,{})}),e.jsx(ce,{children:Ss.map(u=>e.jsx(K,{value:u,children:u.replace("_"," ")},u))})]}),e.jsx(ee,{type:"number",min:0,step:.1,className:"w-52",placeholder:"Espacio sobrante (m) - opcional",value:m.leftover_space_meters===""?"":m.leftover_space_meters,onChange:u=>{const f=u.target.value,w=f===""?"":Math.max(0,Number(f)),A=N.slice();A[i]={...A[i],leftover_space_meters:w},j(A)}}),e.jsx(F,{type:"button",variant:"outline",onClick:()=>{const u=N.slice();u.splice(i,1),j(u.length?u:[{transport_type:"trailer",leftover_space_meters:""}])},children:"Eliminar"})]},i)),e.jsx("div",{children:e.jsx(F,{type:"button",variant:"secondary",onClick:()=>j([...N,{transport_type:"trailer",leftover_space_meters:""}]),children:"Añadir Vehículo"})})]})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx(R,{children:"Anulaciones por fecha (opcional)"}),e.jsx("div",{className:"mt-2 space-y-3 max-h-[40vh] overflow-y-auto pr-2",children:S.map(m=>{const i=b[m.id];return e.jsxs("div",{className:"p-3 border rounded-md",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{variant:"outline",children:L(new Date(m.start_time),"EEE, MMM d")}),e.jsx("span",{className:"text-sm text-muted-foreground",children:m.title})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[m.status==="Cancelado"&&e.jsx(U,{variant:"destructive",className:"text-[10px]",children:"Cancelado"}),i?e.jsx(F,{variant:"outline",size:"sm",onClick:()=>y(m.id),children:"Usar por defecto"}):e.jsx(F,{variant:"secondary",size:"sm",onClick:()=>x(m.id,N),children:"Anular"})]})]}),i&&e.jsxs("div",{className:"space-y-2",children:[i.map((u,f)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(ie,{value:u.transport_type,onValueChange:w=>{const A=(b[m.id]||[]).slice();A[f]={...A[f],transport_type:w},x(m.id,A)},children:[e.jsx(le,{className:"w-40",children:e.jsx(oe,{})}),e.jsx(ce,{children:Ss.map(w=>e.jsx(K,{value:w,children:w.replace("_"," ")},w))})]}),e.jsx(ee,{type:"number",min:0,step:.1,className:"w-52",placeholder:"Espacio sobrante (m) - opcional",value:u.leftover_space_meters===""?"":u.leftover_space_meters,onChange:w=>{const A=w.target.value,q=A===""?"":Math.max(0,Number(A)),V=(b[m.id]||[]).slice();V[f]={...V[f],leftover_space_meters:q},x(m.id,V)}}),e.jsx(F,{type:"button",variant:"outline",onClick:()=>{const w=(b[m.id]||[]).slice();w.splice(f,1),x(m.id,w.length?w:[{transport_type:"trailer",leftover_space_meters:""}])},children:"Eliminar"})]},f)),e.jsx("div",{children:e.jsx(F,{type:"button",variant:"secondary",onClick:()=>x(m.id,[...b[m.id]||[],{transport_type:"trailer",leftover_space_meters:""}]),children:"Añadir Vehículo"})})]})]},m.id)})})]})]})})}const ns=["sound","lights","video"],ca=({open:s,onOpenChange:l,tourId:d})=>{const{toast:r}=me(),[t,a]=T.useState(!1),[c,g]=T.useState({sound:[],lights:[],video:[]}),N=n=>{const k=is(n);k.length&&g(v=>({...v,[n]:[...v[n],{role_code:k[0].code,quantity:1}]}))},j=(n,k,v)=>{g(x=>{const y=[...x[n]];return y[k]={...y[k],...v},{...x,[n]:y}})},b=(n,k)=>{g(v=>{const x=v[n].filter((y,p)=>p!==k);return{...v,[n]:x}})},P=T.useMemo(()=>ns.reduce((n,k)=>n+c[k].length,0),[c]),S=async()=>{try{if(a(!0),!d)throw new Error("Missing tour id");const n=ns.filter(y=>c[y].length>0);if(n.length===0){r({title:"Nothing to apply",description:"Add at least one requirement",variant:"destructive"});return}const{data:k,error:v}=await $.from("jobs").select("id").eq("tour_id",d);if(v)throw v;const x=(k||[]).map(y=>y.id).filter(Boolean);if(x.length===0){r({title:"No jobs found",description:"This tour has no jobs to update",variant:"destructive"});return}for(const y of x){for(const m of n){const{error:i}=await $.from("job_required_roles").delete().eq("job_id",y).eq("department",m);if(i)throw i}const p=n.flatMap(m=>c[m].filter(i=>(i.quantity??0)>0).map(i=>({job_id:y,department:m,role_code:i.role_code,quantity:Math.max(0,Math.floor(i.quantity||0)),notes:null})));if(p.length){const{error:m}=await $.from("job_required_roles").insert(p);if(m)throw m}}r({title:"Applied",description:`Requirements applied to ${x.length} job(s)`}),l(!1)}catch(n){r({title:"Error",description:(n==null?void 0:n.message)||"Failed to apply requirements",variant:"destructive"})}finally{a(!1)}};return e.jsx(xe,{open:s,onOpenChange:l,children:e.jsxs(pe,{className:"max-w-3xl",children:[e.jsx(fe,{children:e.jsx(ge,{children:"Tour‑wide Personnel Requirements"})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Configure required crew for this tour. These requirements will be applied to every job in the tour and replace existing per‑job requirements for the selected departments."}),ns.map(n=>e.jsxs("div",{className:"border rounded-md p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-medium capitalize",children:n}),e.jsx(F,{size:"sm",variant:"outline",onClick:()=>N(n),children:"Add Role"})]}),e.jsxs("div",{className:"space-y-2",children:[c[n].map((k,v)=>e.jsxs("div",{className:"grid grid-cols-12 gap-2 items-center",children:[e.jsxs("div",{className:"col-span-7",children:[e.jsx(R,{className:"sr-only",children:"Role"}),e.jsxs(ie,{value:k.role_code,onValueChange:x=>j(n,v,{role_code:x}),children:[e.jsx(le,{children:e.jsx(oe,{placeholder:"Select a role"})}),e.jsx(ce,{children:is(n).map(x=>e.jsx(K,{value:x.code,children:x.label},x.code))})]})]}),e.jsxs("div",{className:"col-span-3",children:[e.jsx(R,{className:"sr-only",children:"Qty"}),e.jsx(ee,{type:"number",min:0,step:1,value:k.quantity,onChange:x=>j(n,v,{quantity:Number(x.target.value)})})]}),e.jsx("div",{className:"col-span-2 flex justify-end",children:e.jsx(F,{variant:"destructive",size:"sm",onClick:()=>b(n,v),children:"Delete"})})]},`${n}-${v}`)),c[n].length===0&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"No roles configured"})]})]},n)),e.jsx(kt,{}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(F,{variant:"outline",onClick:()=>l(!1),disabled:t,children:"Cancel"}),e.jsx(F,{onClick:S,disabled:t||P===0,children:t?"Applying…":"Apply to All Tour Jobs"})]})]})]})})};async function da(s,l,d){var v;const t=(x=>x.replace(/[^a-zA-Z0-9._-]/g,"_").replace(/_{2,}/g,"_").replace(/^_|_$/g,""))((d||"tour_schedule.pdf").replace(/\.pdf$/i,"")||"tour_schedule"),a=new Date,c=x=>String(x).padStart(2,"0"),g=`${a.getFullYear()}${c(a.getMonth()+1)}${c(a.getDate())}_${c(a.getHours())}${c(a.getMinutes())}`,N=`${t}_${g}.pdf`,j=`schedules/${s}/${N}`,{error:b}=await $.storage.from("tour-documents").upload(j,l,{cacheControl:"3600",upsert:!1,contentType:"application/pdf"});if(b)throw b;const{data:P}=await $.auth.getUser(),{error:S}=await $.from("tour_documents").insert({tour_id:s,file_name:N,file_path:j,file_type:"application/pdf",file_size:l.size,uploaded_by:((v=P==null?void 0:P.user)==null?void 0:v.id)||null});if(S)throw S;const{data:n,error:k}=await $.storage.from("tour-documents").createSignedUrl(j,3600);if(k||!(n!=null&&n.signedUrl))throw k||new Error("Failed to create URL for uploaded tour PDF");return{file_path:j,url:n.signedUrl}}const ma=({open:s,onOpenChange:l,tourId:d,tourDates:r})=>{const{toast:t}=me(),[a,c]=Ee.useState([]),[g,N]=Ee.useState(""),[j,b]=Ee.useState("email"),[P,S]=Ee.useState(!1),[n,k]=Ee.useState(r||[]);Ee.useEffect(()=>{s&&((async()=>{try{const{data:x,error:y}=await $.rpc("get_profiles_with_skills");if(y)throw y;const p=(x||[]).filter(m=>["technician","house_tech"].includes(m.role)||m.role==="management"&&m.assignable_as_tech).map(m=>({id:m.id,name:`${m.first_name||""} ${m.last_name||""}`.trim()||m.email||m.id})).sort((m,i)=>m.name.localeCompare(i.name));c(p)}catch{c([])}})(),(async()=>{try{if(r&&r.length){k(r);return}const{data:x,error:y}=await $.from("tour_dates").select("id, date, is_tour_pack_only, location:locations(name)").eq("tour_id",d).order("date",{ascending:!0});if(y)throw y;k(x||[])}catch{k([])}})())},[s]);const v=async()=>{if(!g){t({title:"Select technician",description:"Please choose a technician to contact.",variant:"destructive"});return}S(!0);try{const{data:x,error:y}=await $.from("tours").select("id,name").eq("id",d).maybeSingle();if(y||!x)throw y||new Error("Tour not found");const p={id:d,name:x.name,tour_dates:n},m=await wt(p),i=`${x.name}_schedule.pdf`,{file_path:u}=await da(d,m,i),{data:f,error:w}=await $.functions.invoke("send-tour-availability",{body:{tour_id:d,profile_id:g,channel:j,tour_pdf_path:u}});if(w||f&&f.error)throw new Error((w==null?void 0:w.message)||(f==null?void 0:f.error)||"Failed to send");t({title:"Availability request sent",description:j==="whatsapp"?"Sent via WhatsApp":"Sent via Email"}),l(!1)}catch(x){t({title:"Failed to send",description:x.message||String(x),variant:"destructive"})}finally{S(!1)}};return e.jsx(xe,{open:s,onOpenChange:l,children:e.jsxs(pe,{className:"max-w-md",children:[e.jsxs(fe,{children:[e.jsx(ge,{children:"Request Availability for Full Tour"}),e.jsx(Ge,{children:"We will generate the tour schedule PDF and include it in the request."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Technician"}),e.jsxs(ie,{value:g,onValueChange:N,children:[e.jsx(le,{children:e.jsx(oe,{placeholder:"Choose technician"})}),e.jsx(ce,{children:a.map(x=>e.jsx(K,{value:x.id,children:x.name},x.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Channel"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"tour-availability-channel",checked:j==="email",onChange:()=>b("email")}),e.jsx("span",{children:"Email"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"tour-availability-channel",checked:j==="whatsapp",onChange:()=>b("whatsapp")}),e.jsx("span",{children:"WhatsApp"})]})]})]})]}),e.jsxs(Gs,{children:[e.jsx(F,{variant:"outline",onClick:()=>l(!1),disabled:P,children:"Cancel"}),e.jsx(F,{onClick:v,disabled:P||!g,children:P?"Sending…":"Send"})]})]})})},Rs=[{value:"sound",label:"Sound"},{value:"lights",label:"Lights"},{value:"video",label:"Video"},{value:"logistics",label:"Logistics"},{value:"production",label:"Production"}],ua={logistics:["Logistics Coordinator","Transport Manager","Load Manager"],production:["Tour Manager","Production Manager","Stage Manager","Backline Technician"]},Ls=({open:s,onOpenChange:l,tourId:d,readOnly:r=!1})=>{const{user:t}=Ve(),a=Ze(),[c,g]=T.useState(""),[N,j]=T.useState(""),[b,P]=T.useState("internal"),[S,n]=T.useState(""),[k,v]=T.useState(""),[x,y]=T.useState(""),[p,m]=T.useState(!1),[i,u]=T.useState(!1),{data:f=[],refetch:w}=Se({queryKey:["tour-assignments",d],queryFn:async()=>{const{data:h,error:C}=await $.from("tour_assignments").select(`
          *,
          profiles:technician_id (
            first_name,
            last_name,
            email
          )
        `).eq("tour_id",d).order("department",{ascending:!0});if(C)throw C;return h},enabled:s&&!!d}),{data:A=[]}=Se({queryKey:["technicians",c],queryFn:async()=>{if(!c)return[];const{data:h,error:C}=await $.from("profiles").select("id, first_name, last_name, email, department, role, assignable_as_tech").eq("department",c).or("role.in.(technician,house_tech),and(role.eq.management,assignable_as_tech.eq.true)").order("first_name");if(C)throw C;return h},enabled:!!c&&b==="internal"}),q=Ce({mutationFn:async h=>{const{error:C}=await $.from("tour_assignments").insert({tour_id:d,technician_id:b==="internal"?S:null,external_technician_name:b==="external"?k:null,department:c,role:N,assigned_by:t==null?void 0:t.id,notes:x||null});if(C)throw C},onSuccess:()=>{Q.success("Assignment created successfully - automatically applied to all tour jobs"),w(),H(),a.invalidateQueries({queryKey:["job-assignments"]})},onError:h=>{Q.error(`Failed to create assignment: ${h.message}`)}}),V=Ce({mutationFn:async h=>{const{error:C}=await $.from("tour_assignments").delete().eq("id",h);if(C)throw C},onSuccess:()=>{Q.success("Assignment removed successfully - automatically removed from all tour jobs"),w(),a.invalidateQueries({queryKey:["job-assignments"]}),a.invalidateQueries({queryKey:["job-details"]}),a.invalidateQueries({queryKey:["jobs"]}),a.invalidateQueries({queryKey:["optimized-jobs"]})},onError:h=>{Q.error(`Failed to remove assignment: ${h.message}`)}}),H=()=>{g(""),j(""),P("internal"),n(""),v(""),y("")},o=()=>{if(!c||!N){Q.error("Please select department and role");return}if(b==="internal"&&!S){Q.error("Please select a technician");return}if(b==="external"&&!k.trim()){Q.error("Please enter external technician name");return}q.mutate({})},_=h=>{confirm("Are you sure you want to remove this assignment? This will also remove it from all jobs in this tour.")&&V.mutate(h)},M=()=>c?["sound","lights","video"].includes(c)?is(c).map(C=>({value:C.code,label:C.label})):(ua[c]||[]).map(C=>({value:C,label:C})):[],z=f.reduce((h,C)=>(h[C.department]||(h[C.department]=[]),h[C.department].push(C),h),{});return e.jsxs(e.Fragment,{children:[e.jsx(xe,{open:s,onOpenChange:l,children:e.jsxs(pe,{className:"max-w-4xl w-[95vw] md:w-full max-h-[95vh] md:max-h-[90vh] overflow-y-auto",children:[e.jsx(fe,{children:e.jsxs(ge,{className:"flex flex-wrap items-center gap-2 text-base md:text-lg",children:[e.jsx(ke,{className:"h-4 w-4 md:h-5 md:w-5"}),r?"Tour Team Members":"Tour Team Assignments",r&&e.jsxs(U,{variant:"secondary",className:"text-xs",children:[e.jsx(Je,{className:"h-3 w-3 mr-1"}),"View Only"]})]})}),e.jsxs("div",{className:"space-y-6",children:[!r&&e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-950 p-4 rounded-lg border border-blue-200 dark:border-blue-800",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Vs,{className:"h-4 w-4 text-blue-600 mt-0.5"}),e.jsxs("div",{className:"text-sm text-blue-800 dark:text-blue-200",children:[e.jsx("p",{className:"font-medium mb-1",children:"Automatic Job Sync"}),e.jsx("p",{children:"Tour assignments are automatically applied to all jobs in this tour. When you add or remove team members here, they will be instantly assigned to or removed from all tour jobs."})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[e.jsxs(F,{variant:"secondary",size:"sm",onClick:()=>m(!0),className:"gap-2",children:[e.jsx(Mt,{className:"h-4 w-4"}),"Set Tour‑wide Personnel Requirements"]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:()=>u(!0),className:"gap-2",children:[e.jsx(Pt,{className:"h-4 w-4"}),"Request Availability for Full Tour"]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:r?"Team Members":"Current Team"}),Object.keys(z).length===0?e.jsxs("p",{className:"text-muted-foreground text-center py-8",children:["No team members assigned yet.",!r&&" Add assignments below."]}):e.jsx("div",{className:"space-y-4",children:Rs.map(h=>{const C=z[h.value]||[];return C.length===0?null:e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium mb-2 text-sm uppercase tracking-wide text-muted-foreground",children:h.label}),e.jsx("div",{className:"space-y-2",children:C.map(E=>{var O;return e.jsxs("div",{className:"flex items-center justify-between p-2 bg-muted rounded",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:E.profiles?`${E.profiles.first_name} ${E.profiles.last_name}`:E.external_technician_name}),e.jsx(U,{variant:"outline",className:"text-xs",children:ht(E.role)||E.role}),E.external_technician_name&&e.jsx(U,{variant:"secondary",className:"text-xs",children:"External"})]}),((O=E.profiles)==null?void 0:O.email)&&e.jsx("p",{className:"text-sm text-muted-foreground",children:E.profiles.email}),E.notes&&e.jsx("p",{className:"text-sm text-muted-foreground italic",children:E.notes})]}),!r&&e.jsx(F,{variant:"ghost",size:"sm",onClick:()=>_(E.id),className:"text-destructive hover:text-destructive",children:e.jsx(We,{className:"h-4 w-4"})})]},E.id)})})]},h.value)})})]}),!r&&e.jsxs("div",{className:"border-t pt-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Add Team Member"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(R,{children:"Department"}),e.jsxs(ie,{value:c,onValueChange:g,children:[e.jsx(le,{children:e.jsx(oe,{placeholder:"Select department"})}),e.jsx(ce,{children:Rs.map(h=>e.jsx(K,{value:h.value,children:h.label},h.value))})]})]}),e.jsxs("div",{children:[e.jsx(R,{children:"Role"}),e.jsxs(ie,{value:N,onValueChange:j,disabled:!c,children:[e.jsx(le,{children:e.jsx(oe,{placeholder:"Select role"})}),e.jsx(ce,{children:M().map(h=>e.jsx(K,{value:h.value,children:h.label},h.value))})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(R,{children:"Assignment Type"}),e.jsxs(ie,{value:b,onValueChange:h=>P(h),children:[e.jsx(le,{children:e.jsx(oe,{})}),e.jsxs(ce,{children:[e.jsx(K,{value:"internal",children:"Internal Technician"}),e.jsx(K,{value:"external",children:"External Team/Contractor"})]})]})]}),b==="internal"?e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(R,{children:"Technician"}),e.jsxs(ie,{value:S,onValueChange:n,disabled:!c,children:[e.jsx(le,{children:e.jsx(oe,{placeholder:"Select technician"})}),e.jsx(ce,{children:A.map(h=>e.jsxs(K,{value:h.id,children:[h.first_name," ",h.last_name," (",h.email,")"]},h.id))})]})]}):e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(R,{children:"External Team/Contractor Name"}),e.jsx(ee,{value:k,onChange:h=>v(h.target.value),placeholder:"Enter name or company"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(R,{children:"Notes (Optional)"}),e.jsx(xt,{value:x,onChange:h=>y(h.target.value),placeholder:"Additional notes about this assignment",rows:2})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx(F,{variant:"outline",onClick:H,children:"Clear"}),e.jsxs(F,{onClick:o,disabled:q.isPending,children:[e.jsx(Le,{className:"h-4 w-4 mr-2"}),"Add Assignment"]})]})]})]})]})}),!r&&e.jsx(ca,{open:p,onOpenChange:m,tourId:d}),!r&&e.jsx(ma,{open:i,onOpenChange:u,tourId:d})]})},ms=s=>{const{user:l,userRole:d}=Ve(),r=Ze(),{data:t=[],isLoading:a,error:c}=Se({queryKey:["tour-documents",s],queryFn:async()=>{const{data:P,error:S}=await $.from("tour_documents").select("*").eq("tour_id",s).order("uploaded_at",{ascending:!1});if(S)throw S;return P},enabled:!!s}),g=Ce({mutationFn:async({file:P,fileName:S})=>{if(!(l!=null&&l.id))throw new Error("User not authenticated");const n=P.name.split(".").pop(),k=crypto.randomUUID(),v=`tours/${s}/${k}.${n}`,x=S||P.name,{error:y}=await $.storage.from("tour-documents").upload(v,P);if(y)throw y;const{data:p,error:m}=await $.from("tour_documents").insert({tour_id:s,file_name:x,file_path:v,file_type:P.type,file_size:P.size,uploaded_by:l.id}).select().single();if(m)throw m;return p},onSuccess:()=>{r.invalidateQueries({queryKey:["tour-documents",s]}),Q.success("Document uploaded successfully")},onError:P=>{Q.error("Failed to upload document")}}),N=Ce({mutationFn:async P=>{const{error:S}=await $.storage.from("tour-documents").remove([P.file_path]),{error:n}=await $.from("tour_documents").delete().eq("id",P.id);if(n)throw n},onSuccess:()=>{r.invalidateQueries({queryKey:["tour-documents",s]}),Q.success("Document deleted successfully")},onError:P=>{Q.error("Failed to delete document")}});return{documents:t,isLoading:a,error:c,uploadDocument:g,deleteDocument:N,getDocumentUrl:async P=>{try{const{data:S,error:n}=await $.storage.from("tour-documents").createSignedUrl(P.file_path,3600);if(n)throw n;if(S!=null&&S.signedUrl)return S.signedUrl;throw new Error("Failed to generate any URL for the document")}catch(S){throw S}},canDelete:P=>l?P.uploaded_by===l.id?!0:["admin","management"].includes(d||""):!1}},ha=({tourId:s})=>{const{documents:l,deleteDocument:d,getDocumentUrl:r,canDelete:t}=ms(s),a=async N=>{try{const j=await r(N);if(j)window.open(j,"_blank","noopener,noreferrer"),Q.success("Document opened in new tab");else throw new Error("Failed to generate document URL")}catch{Q.error("Failed to view document. Please try again.")}},c=async N=>{try{const j=await r(N);if(!j)throw new Error("Failed to generate download URL");const b=globalThis.document.createElement("a");b.href=j,b.download=N.file_name,b.target="_blank",b.style.display="none",globalThis.document.body.appendChild(b),b.click(),globalThis.document.body.removeChild(b),Q.success("Download started")}catch{Q.error("Failed to download document. Please try again.")}},g=async N=>{if(!t(N)){Q.error("You do not have permission to delete this document");return}if(globalThis.confirm(`Are you sure you want to delete "${N.file_name}"?`))try{await d.mutateAsync(N),Q.success("Document deleted successfully")}catch{Q.error("Failed to delete document. Please try again.")}};return l.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(he,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No Documents"}),e.jsx("p",{className:"text-muted-foreground",children:"No documents have been uploaded for this tour yet."})]}):e.jsx("div",{className:"space-y-3",children:l.map(N=>e.jsx(W,{children:e.jsx(te,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(he,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:N.file_name}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(se,{className:"h-3 w-3"}),L(new Date(N.uploaded_at),"MMM d, yyyy")]}),N.file_size&&e.jsx("span",{children:pt(N.file_size)})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{variant:"ghost",size:"sm",onClick:()=>a(N),title:"View document",children:e.jsx(Je,{className:"h-4 w-4"})}),e.jsx(F,{variant:"ghost",size:"sm",onClick:()=>c(N),title:"Download document",children:e.jsx(Ie,{className:"h-4 w-4"})}),t(N)&&e.jsx(F,{variant:"ghost",size:"sm",onClick:()=>g(N),title:"Delete document",className:"text-destructive hover:text-destructive",disabled:d.isPending,children:e.jsx(We,{className:"h-4 w-4"})})]})]})})},N.id))})},xa=({tourId:s,onSuccess:l,onCancel:d})=>{const[r,t]=T.useState(null),[a,c]=T.useState(""),[g,N]=T.useState(0),j=T.useRef(null),{uploadDocument:b}=ms(s),P=x=>{var p;const y=(p=x.target.files)==null?void 0:p[0];y&&(t(y),c(y.name))},S=x=>{x.preventDefault();const y=x.dataTransfer.files[0];y&&(t(y),c(y.name))},n=x=>{x.preventDefault()},k=async()=>{if(r)try{N(25),await b.mutateAsync({file:r,fileName:a.trim()||r.name}),N(100),l()}catch{N(0)}},v=()=>{t(null),c(""),N(0),j.current&&(j.current.value="")};return e.jsx("div",{className:"space-y-4",children:r?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 border rounded-lg",children:[e.jsx(he,{className:"h-6 w-6 text-muted-foreground"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:r.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[(r.size/1024/1024).toFixed(2)," MB"]})]}),e.jsx(F,{variant:"ghost",size:"sm",onClick:v,children:e.jsx(os,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{htmlFor:"fileName",children:"Document Name (Optional)"}),e.jsx(ee,{id:"fileName",value:a,onChange:x=>c(x.target.value),placeholder:"Enter custom document name"})]}),g>0&&g<100&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Upload Progress"}),e.jsx(Et,{value:g,className:"w-full"})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(F,{variant:"outline",onClick:d,children:"Cancel"}),e.jsx(F,{onClick:k,disabled:b.isPending||g>0,children:b.isPending?"Uploading...":"Upload Document"})]})]}):e.jsxs("div",{className:"border-2 border-dashed border-muted-foreground/25 rounded-lg p-8 text-center hover:border-muted-foreground/50 transition-colors cursor-pointer",onDrop:S,onDragOver:n,onClick:()=>{var x;return(x=j.current)==null?void 0:x.click()},children:[e.jsx(Ws,{className:"h-8 w-8 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-lg font-medium mb-2",children:"Drop files here or click to browse"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Supported formats: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, JPG, PNG"}),e.jsx("input",{ref:j,type:"file",onChange:P,className:"hidden",accept:".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.txt"})]})})},Is=({open:s,onOpenChange:l,tourId:d,tourName:r})=>{const[t,a]=T.useState(!1),{documents:c,isLoading:g}=ms(d);return e.jsx(xe,{open:s,onOpenChange:l,children:e.jsxs(pe,{className:"max-w-4xl w-[95vw] md:w-full max-h-[95vh] md:max-h-[90vh] overflow-y-auto",children:[e.jsx(fe,{children:e.jsxs(ge,{className:"flex items-center gap-2 text-base md:text-lg",children:[e.jsx(he,{className:"h-4 w-4 md:h-5 md:w-5"}),e.jsxs("span",{className:"truncate",children:["Tour Documents - ",r]})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Upload Documents"}),e.jsx(F,{onClick:()=>a(!t),variant:t?"outline":"default",children:t?e.jsxs(e.Fragment,{children:[e.jsx(os,{className:"h-4 w-4 mr-2"}),"Cancel"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ws,{className:"h-4 w-4 mr-2"}),"Upload Files"]})})]}),t&&e.jsx(xa,{tourId:d,onSuccess:()=>a(!1),onCancel:()=>a(!1)})]}),e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("h3",{className:"text-lg font-medium mb-4",children:["Documents (",c.length,")"]}),g?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-white mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Loading documents..."})]}):e.jsx(ha,{tourId:d})]})]})]})})};function pa({open:s,onOpenChange:l,tourId:d}){const{toast:r}=me(),t=Ze(),[a,c]=T.useState(!1),[g,N]=T.useState(null),[j,b]=T.useState(null),[P,S]=T.useState(null),[n,k]=T.useState("sound"),[v,x]=T.useState(!1),{data:y=[]}=Se({queryKey:["tour-presets",d,n],queryFn:async()=>{const{data:i,error:u}=await $.from("presets").select(`
          *,
          items:preset_items (
            *,
            equipment:equipment (*)
          )
        `).eq("tour_id",d).eq("department",n).order("name");if(u)throw u;return(i||[]).map(Dt)},enabled:!!d});Ce({mutationFn:async i=>{const{error:u}=await $.from("preset_items").delete().eq("preset_id",i);if(u)throw u;const{error:f}=await $.from("presets").delete().eq("id",i);if(f)throw f},onSuccess:()=>{t.invalidateQueries({queryKey:["tour-presets",d]}),r({title:"Éxito",description:"Preset eliminado"})},onError:i=>{r({title:"Error",description:i.message,variant:"destructive"})}});const p=async(i,u,f)=>{try{if(g){const{error:w}=await $.from("presets").update({name:i}).eq("id",g.id);if(w)throw w;const{error:A}=await $.from("preset_items").delete().eq("preset_id",g.id);if(A)throw A;if(u.length>0){const{error:q}=await $.from("preset_items").insert(u.map(V=>({...V,preset_id:g.id})));if(q)throw q}}else{const{data:w,error:A}=await $.from("presets").insert({name:i,department:n,tour_id:d}).select().single();if(A)throw A;if(u.length>0){const{error:q}=await $.from("preset_items").insert(u.map(V=>({...V,preset_id:w.id})));if(q)throw q}}t.invalidateQueries({queryKey:["tour-presets",d]}),N(null),b(null),c(!1),r({title:"Éxito",description:"Preset guardado"})}catch(w){r({title:"Error",description:w.message,variant:"destructive"})}},m=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Departamento"}),e.jsxs("select",{className:"border rounded px-2 py-1 text-sm",value:n,onChange:i=>k(i.target.value),children:[e.jsx("option",{value:"sound",children:"Sonido"}),e.jsx("option",{value:"lights",children:"Luces"}),e.jsx("option",{value:"video",children:"Vídeo"})]})]}),e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[n==="sound"&&e.jsxs(F,{variant:"outline",size:"sm",onClick:()=>x(!0),className:"flex-1 sm:flex-initial",children:[e.jsx(Hs,{className:"h-4 w-4 mr-2"}),"Crear desde Calculadora"]}),e.jsx(F,{size:"sm",onClick:()=>c(!0),className:"flex-1 sm:flex-initial",children:"Crear Nuevo Preset"})]})]}),e.jsx(W,{children:e.jsx(B,{children:e.jsx(es,{className:"h-[420px]",children:e.jsxs("div",{className:"space-y-3 py-2",children:[y.map(i=>e.jsxs("div",{className:"flex items-center justify-between border rounded p-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[i.items.length," elementos · ",n]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{variant:"ghost",size:"icon",onClick:()=>b({...i,name:`Copia de ${i.name}`}),children:e.jsx(zt,{className:"h-4 w-4"})}),e.jsx(F,{variant:"ghost",size:"icon",onClick:()=>N(i),children:e.jsx(qt,{className:"h-4 w-4"})}),e.jsx(F,{variant:"ghost",size:"icon",onClick:()=>S(i),children:e.jsx(We,{className:"h-4 w-4"})})]})]},i.id)),y.length===0&&e.jsx("div",{className:"text-center text-sm text-muted-foreground py-6",children:"No hay presets para esta gira y departamento."})]})})})})]});return e.jsxs(e.Fragment,{children:[e.jsx(xe,{open:s,onOpenChange:l,children:e.jsxs(pe,{className:"max-w-3xl w-[95vw] md:w-full max-h-[95vh] md:max-h-[90vh] overflow-y-auto",children:[e.jsx(fe,{children:e.jsx(ge,{className:"text-base md:text-lg",children:"Presets de Gira"})}),a||g||j?e.jsx(Ts,{department:n,children:e.jsx(Ft,{preset:g||j,isCopy:!!j,onSave:p,onCancel:()=>{c(!1),N(null),b(null)},fixedTourId:d})}):e.jsx(m,{})]})}),e.jsx(xe,{open:v,onOpenChange:x,children:e.jsxs(pe,{className:"max-w-6xl max-h-[90vh]",children:[e.jsx(fe,{children:e.jsx(ge,{children:"Calculadora de Amplificadores - Crear Preset"})}),e.jsx("div",{className:"text-sm text-muted-foreground mb-4",children:"Configura los altavoces y calcula los amplificadores. Los resultados se guardarán como un nuevo preset para esta gira."}),e.jsx(Ts,{department:n,children:e.jsx(At,{tourId:d})})]})})]})}const fa=s=>{const l=Ze(),{data:d=[],isLoading:r,error:t,refetch:a}=Se({queryKey:["tour-assignments",s],queryFn:async()=>{const{data:S,error:n}=await $.from("tour_assignments").select(`
          *,
          profiles:technician_id (
            first_name,
            last_name,
            email,
            department
          )
        `).eq("tour_id",s).order("department",{ascending:!0});if(n)throw n;return S},enabled:!!s}),c=Ce({mutationFn:async S=>{const{error:n}=await $.from("tour_assignments").insert({tour_id:s,...S});if(n)throw n},onSuccess:()=>{Q.success("Assignment created successfully - automatically applied to all tour jobs"),l.invalidateQueries({queryKey:["tour-assignments",s]}),l.invalidateQueries({queryKey:["job-assignments"]})},onError:S=>{Q.error(`Failed to create assignment: ${S.message}`)}}),g=Ce({mutationFn:async S=>{const{error:n}=await $.from("tour_assignments").delete().eq("id",S);if(n)throw n},onSuccess:()=>{Q.success("Assignment removed successfully - automatically removed from all tour jobs"),l.invalidateQueries({queryKey:["tour-assignments",s]}),l.invalidateQueries({queryKey:["job-assignments"]})},onError:S=>{Q.error(`Failed to remove assignment: ${S.message}`)}}),N=Ce({mutationFn:async({assignmentId:S,updates:n})=>{const{error:k}=await $.from("tour_assignments").update(n).eq("id",S);if(k)throw k},onSuccess:()=>{Q.success("Assignment updated successfully"),l.invalidateQueries({queryKey:["tour-assignments",s]})},onError:S=>{Q.error(`Failed to update assignment: ${S.message}`)}}),j=async S=>{const{data:n,error:k}=await $.from("tour_assignments").select("id").eq("tour_id",s).eq("technician_id",S).maybeSingle();return{hasAccess:!!n,error:k}},b=S=>d.filter(n=>n.department===S),P=()=>d.filter(S=>S.technician_id).map(S=>S.technician_id).filter(Boolean);return{assignments:d,isLoading:r,error:t,refetch:a,createAssignment:c.mutate,deleteAssignment:g.mutate,updateAssignment:N.mutate,isCreating:c.isPending,isDeleting:g.isPending,isUpdating:N.isPending,checkTourAccess:j,getAssignmentsByDepartment:b,getAssignedTechnicianIds:P}},ga=({tourDateId:s,isCreatingFolders:l=!1})=>{const{flexUuid:d,isLoading:r,error:t}=Us(s),{toast:a}=me(),c=async()=>{if(r||l){a({title:"Loading",description:l?"Creating Flex folders, please wait...":"Please wait while we load the Flex folder..."});return}d?await Ys({elementId:d,context:{jobType:"tourdate",folderType:"tourdate"},onError:g=>{a({title:"Error",description:g.message||"Failed to open Flex",variant:"destructive"})},onWarning:g=>{a({title:"Warning",description:g})}}):a(t?{title:"Error",description:t,variant:"destructive"}:{title:"Info",description:"Flex folder not available for this tour date"})};return e.jsxs(F,{variant:"outline",size:"sm",className:"flex items-center gap-2 mt-4 w-full",onClick:c,disabled:r||l,children:[r||l?e.jsx(Z,{className:"h-4 w-4 animate-spin"}):e.jsx("img",{src:Bs,alt:"Flex",width:16,height:16,loading:"lazy",decoding:"async",className:"h-4 w-4"}),l?"Creating Folders...":"Flex Folder"]})},ja=({tourData:s,tourDates:l,onDateSelect:d,selectedDateId:r,canEdit:t,onGenerateDaySheet:a})=>{const[c,g]=T.useState(new Date),[N,j]=T.useState("list"),b=[...l].sort((i,u)=>new Date(i.date).getTime()-new Date(u.date).getTime()),P=Ms(c),S=Es(c),n=Kt({start:P,end:S}),k=new Map(b.map(i=>[L(new Date(i.date),"yyyy-MM-dd"),i])),v=()=>{g(i=>Ps(Ms(i),-1))},x=()=>{g(i=>Ps(Es(i),1))},y=i=>{d(i.id)},m=b.find(i=>i.id===r);return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 h-full",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs(W,{children:[e.jsx(te,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-5 w-5"}),"Timeline del Tour"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{variant:N==="list"?"default":"outline",size:"sm",onClick:()=>j("list"),children:"Lista"}),e.jsx(F,{variant:N==="calendar"?"default":"outline",size:"sm",onClick:()=>j("calendar"),children:"Calendario"})]})]})}),e.jsx(B,{children:N==="list"?e.jsx(es,{className:"h-[500px] pr-4",children:e.jsx("div",{className:"space-y-3",children:b.map((i,u)=>{const f=r===i.id,w=u>0?b[u-1]:null,A=w?Math.ceil((new Date(i.date).getTime()-new Date(w.date).getTime())/(1e3*60*60*24))-1:0;return e.jsxs("div",{children:[A>0&&e.jsxs("div",{className:"flex items-center gap-2 my-2 ml-4 text-sm text-muted-foreground",children:[e.jsx(Oe,{className:"h-4 w-4"}),e.jsxs("span",{children:[A," día(s) de viaje"]})]}),e.jsx(W,{className:_s("cursor-pointer transition-all hover:shadow-md",f&&"ring-2 ring-primary"),onClick:()=>y(i),children:e.jsx(B,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"font-semibold",children:L(new Date(i.date),"EEEE, d 'de' MMMM yyyy",{locale:Y})}),e.jsxs(U,{variant:"outline",children:["Día ",u+1]})]}),i.location&&e.jsxs("div",{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(Ne,{className:"h-4 w-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:i.location.name})]}),i.notes&&e.jsx("p",{className:"text-sm text-muted-foreground pl-6",children:i.notes})]}),e.jsx(F,{variant:"ghost",size:"sm",onClick:q=>{q.stopPropagation(),a(i.id)},children:e.jsx(Ie,{className:"h-4 w-4"})})]})})})]},i.id)})})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(F,{variant:"outline",size:"sm",onClick:v,children:e.jsx(Ot,{className:"h-4 w-4"})}),e.jsx("h3",{className:"text-lg font-semibold",children:L(c,"MMMM yyyy",{locale:Y})}),e.jsx(F,{variant:"outline",size:"sm",onClick:x,children:e.jsx(Gt,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-7 gap-2",children:[["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"].map(i=>e.jsx("div",{className:"text-center text-sm font-medium text-muted-foreground py-2",children:i},i)),n.map((i,u)=>{const f=L(i,"yyyy-MM-dd"),w=k.get(f),A=w&&r===w.id;return e.jsxs("div",{className:_s("aspect-square p-2 border rounded-lg text-center cursor-pointer hover:bg-muted/50 transition-colors",!Qt(i,c)&&"text-muted-foreground opacity-50",w&&"bg-primary/10 border-primary",A&&"ring-2 ring-primary"),onClick:()=>w&&y(w),children:[e.jsx("div",{className:"text-sm font-medium",children:L(i,"d")}),w&&e.jsx("div",{className:"mt-1",children:e.jsx(U,{variant:"secondary",className:"text-xs px-1 py-0",children:"Tour"})})]},u)})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(W,{children:e.jsx(B,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:b.length}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Fechas totales"})]})]})})}),e.jsx(W,{children:e.jsx(B,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:new Set(b.map(i=>{var u;return(u=i.location)==null?void 0:u.name}).filter(Boolean)).size}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Ubicaciones"})]})]})})}),e.jsx(W,{children:e.jsx(B,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:b.length>0?Math.ceil((new Date(b[b.length-1].date).getTime()-new Date(b[0].date).getTime())/(1e3*60*60*24)):0}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Días de duración"})]})]})})})]})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs(W,{children:[e.jsx(te,{children:e.jsxs(ae,{className:"flex items-center gap-2 text-lg",children:[e.jsx(he,{className:"h-5 w-5"}),"Detalles de la Fecha"]})}),e.jsx(B,{children:m?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-1",children:"Fecha"}),e.jsx("div",{className:"font-semibold",children:L(new Date(m.date),"EEEE, d 'de' MMMM yyyy",{locale:Y})})]}),m.location&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-1",children:"Ubicación"}),e.jsx("div",{className:"font-semibold",children:m.location.name}),m.location.address&&e.jsx("div",{className:"text-sm text-muted-foreground mt-1",children:m.location.address})]}),m.notes&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-1",children:"Notas"}),e.jsx("div",{className:"text-sm",children:m.notes})]}),e.jsxs("div",{className:"pt-4 border-t space-y-2",children:[e.jsxs(F,{className:"w-full justify-start",variant:"outline",onClick:()=>a(m.id),children:[e.jsx(Ie,{className:"h-4 w-4 mr-2"}),"Generar Day Sheet"]}),e.jsxs(F,{className:"w-full justify-start",variant:"outline",children:[e.jsx(Vt,{className:"h-4 w-4 mr-2"}),"Ver Pronóstico"]}),e.jsxs(F,{className:"w-full justify-start",variant:"outline",children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Ver Asignaciones"]})]})]}):e.jsx("div",{className:"text-center text-muted-foreground py-8",children:"Selecciona una fecha para ver los detalles"})})]})})]})},va=({tourData:s,tourDates:l,selectedDateId:d,onDateSelect:r,canEdit:t,onSave:a})=>{const{toast:c}=me(),[g,N]=T.useState(!1),[j,b]=T.useState(!1),[P,S]=T.useState(null),[n,k]=T.useState([{label:"Día 1",rows:[]}]),v=[...l].sort((i,u)=>new Date(i.date).getTime()-new Date(u.date).getTime()),x=v.find(i=>i.id===d);T.useEffect(()=>{d&&y()},[d]);const y=async()=>{if(d){N(!0);try{const{data:i,error:u}=await I.from("hoja_de_ruta").select("*").eq("tour_date_id",d).maybeSingle();if(u&&u.code!=="PGRST116")throw u;i?(S(i),i.program_schedule_json?k(i.program_schedule_json):k([{label:"Día 1",rows:[]}])):(S(null),k([{label:"Día 1",rows:[]}]))}catch{c({title:"Error",description:"No se pudo cargar el itinerario",variant:"destructive"})}finally{N(!1)}}},p=async()=>{if(!(!d||!t)){b(!0);try{const{data:i,error:u}=await I.from("jobs").select("id").eq("tour_date_id",d).maybeSingle();if(u&&u.code!=="PGRST116")throw u;const f={job_id:(i==null?void 0:i.id)||null,tour_date_id:d,program_schedule_json:n,status:"draft",last_modified:new Date().toISOString()};if(P!=null&&P.id){const{error:w}=await I.from("hoja_de_ruta").update(f).eq("id",P.id);if(w)throw w}else{const{data:w,error:A}=await I.from("hoja_de_ruta").insert(f).select().single();if(A)throw A;S(w)}c({title:"Guardado",description:"El itinerario se ha guardado correctamente"}),a()}catch{c({title:"Error",description:"No se pudo guardar el itinerario",variant:"destructive"})}finally{b(!1)}}},m=async()=>{if(t){b(!0);try{const i=v.map(async u=>{const f=await I.from("hoja_de_ruta").select("id").eq("tour_date_id",u.id).maybeSingle(),{data:w}=f;if(w)return;const{data:A}=await I.from("jobs").select("id").eq("tour_date_id",u.id).maybeSingle();await I.from("hoja_de_ruta").insert({job_id:(A==null?void 0:A.id)||null,tour_date_id:u.id,program_schedule_json:[{label:"Día 1",rows:[]}],status:"draft"})});await Promise.all(i),c({title:"Itinerarios creados",description:"Se han creado itinerarios para todas las fechas del tour"}),a(),y()}catch{c({title:"Error",description:"No se pudieron crear los itinerarios",variant:"destructive"})}finally{b(!1)}}};return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-4 h-full",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs(W,{children:[e.jsx(te,{children:e.jsxs(ae,{className:"text-lg flex items-center gap-2",children:[e.jsx(se,{className:"h-5 w-5"}),"Fechas del Tour"]})}),e.jsx(B,{className:"p-0",children:e.jsx(es,{className:"h-[600px]",children:e.jsx("div",{className:"p-4 space-y-2",children:v.map((i,u)=>{var A;const f=d===i.id,w=(A=s==null?void 0:s.hojaDeRutaRecords)==null?void 0:A.some(q=>q.tour_date_id===i.id);return e.jsxs("button",{onClick:()=>r(i.id),className:`w-full text-left p-3 rounded-lg border transition-all ${f?"bg-primary text-primary-foreground border-primary":"bg-muted/50 hover:bg-muted border-border"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("span",{className:"text-xs font-medium",children:["Día ",u+1]}),w&&e.jsxs(U,{variant:"secondary",className:"text-xs",children:[e.jsx(he,{className:"h-3 w-3 mr-1"}),"Creado"]})]}),e.jsx("div",{className:"font-semibold text-sm mb-1",children:L(new Date(i.date),"d MMM",{locale:Y})}),i.location&&e.jsxs("div",{className:"flex items-start gap-1 text-xs opacity-90",children:[e.jsx(Ne,{className:"h-3 w-3 mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"line-clamp-2",children:i.location.name})]})]},i.id)})})})})]}),e.jsxs(F,{variant:"outline",className:"w-full",onClick:m,disabled:!t||j,children:[e.jsx(Le,{className:"h-4 w-4 mr-2"}),"Crear para todas"]})]}),e.jsx("div",{className:"lg:col-span-3 space-y-4",children:x?e.jsxs(e.Fragment,{children:[e.jsx(W,{children:e.jsx(te,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"h-5 w-5"}),"Itinerario -"," ",L(new Date(x.date),"EEEE, d 'de' MMMM yyyy",{locale:Y})]}),x.location&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1 flex items-center gap-1",children:[e.jsx(Ne,{className:"h-4 w-4"}),x.location.name]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[P&&e.jsx(U,{variant:"outline",children:P.status==="draft"?"Borrador":P.status==="review"?"En Revisión":P.status==="approved"?"Aprobado":"Final"}),e.jsx(F,{variant:"outline",size:"sm",onClick:y,disabled:g,children:e.jsx(ft,{className:`h-4 w-4 ${g?"animate-spin":""}`})}),t&&e.jsx(F,{size:"sm",onClick:p,disabled:j,children:j?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 mr-2 animate-spin"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Guardar"]})})]})]})})}),g?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(Z,{className:"h-8 w-8 animate-spin"})}):e.jsx(Wt,{value:n,onChange:k,dayTitle:"Programa del Día",subtitle:`Itinerario para ${L(new Date(x.date),"d 'de' MMMM",{locale:Y})}`}),!t&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-lg p-4 text-sm text-amber-800 dark:text-amber-300",children:[e.jsx("strong",{children:"Modo solo lectura:"})," No tienes permisos para editar el itinerario. Solo usuarios con rol de administrador o management pueden hacer cambios."]})]}):e.jsx(W,{children:e.jsxs(B,{className:"p-12 text-center",children:[e.jsx(se,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Selecciona una fecha"}),e.jsx("p",{className:"text-muted-foreground",children:"Elige una fecha del tour para crear o editar su itinerario"})]})})})]})},ya=({tourId:s,tourData:l,tourDates:d,canEdit:r,onSave:t})=>{var q,V,H;const{toast:a}=me(),[c,g]=T.useState([]),[N,j]=T.useState(!1),[b,P]=T.useState(!1),S=[...d].sort((o,_)=>new Date(o.date).getTime()-new Date(_.date).getTime()),n=(q=l==null?void 0:l.tour_settings)==null?void 0:q.homeBase,k=((V=l==null?void 0:l.tour_settings)==null?void 0:V.defaultDepartureTime)||"08:00",v=((H=l==null?void 0:l.tour_settings)==null?void 0:H.defaultReturnTime)||"18:00";T.useEffect(()=>{Array.isArray(l==null?void 0:l.travel_plan)&&l.travel_plan.length>0?g(l.travel_plan):n&&S.length>0&&y()},[l,d]);const x=(o,_,M,z)=>{const C=(M-o)*Math.PI/180,E=(z-_)*Math.PI/180,O=Math.sin(C/2)*Math.sin(C/2)+Math.cos(o*Math.PI/180)*Math.cos(M*Math.PI/180)*Math.sin(E/2)*Math.sin(E/2),G=2*Math.atan2(Math.sqrt(O),Math.sqrt(1-O));return Math.round(6371*G)},y=()=>{if(!n||S.length===0){a({title:"Configuración incompleta",description:"Configura la base de operaciones primero",variant:"destructive"});return}P(!0);const o=[];try{const _=S.find(C=>{var E,O;return((E=C.location)==null?void 0:E.latitude)!=null&&((O=C.location)==null?void 0:O.longitude)!=null}),M=_==null?void 0:_.location;if(_&&M){const C=x(n.latitude,n.longitude,M.latitude,M.longitude);o.push({id:`home-to-${_.id}`,type:"home_to_venue",fromType:"home",toType:"venue",toDateId:_.id,toLocation:M,transportType:"bus",departureTime:k,arrivalTime:"",distance:C,duration:Math.round(C/80*60),notes:"Salida desde la base de operaciones"})}for(let C=0;C<S.length-1;C++){const E=S[C],O=S[C+1],G=E.location,X=O.location;if((G==null?void 0:G.latitude)==null||(G==null?void 0:G.longitude)==null||(X==null?void 0:X.latitude)==null||(X==null?void 0:X.longitude)==null)continue;const de=la(new Date(O.date),new Date(E.date));if(de>=2){const ne=x(G.latitude,G.longitude,n.latitude,n.longitude);o.push({id:`${E.id}-to-home`,type:"venue_to_home",fromType:"venue",toType:"home",fromDateId:E.id,fromLocation:G,transportType:"bus",departureTime:v,arrivalTime:"",distance:ne,duration:Math.round(ne/80*60),notes:`Regreso a casa (${de} días de descanso)`,isGapReturn:!0,gapDays:de});const De=x(n.latitude,n.longitude,X.latitude,X.longitude);o.push({id:`home-to-${O.id}`,type:"home_to_venue",fromType:"home",toType:"venue",toDateId:O.id,toLocation:X,transportType:"bus",departureTime:k,arrivalTime:"",distance:De,duration:Math.round(De/80*60),notes:`Salida desde casa después de ${de} días`})}else{const ne=x(G.latitude,G.longitude,X.latitude,X.longitude);o.push({id:`${E.id}-to-${O.id}`,type:"venue_to_venue",fromType:"venue",toType:"venue",fromDateId:E.id,toDateId:O.id,fromLocation:G,toLocation:X,transportType:"bus",departureTime:"",arrivalTime:"",distance:ne,duration:Math.round(ne/80*60),notes:"Viaje directo entre venues"})}}const z=[...S].reverse().find(C=>{var E,O;return((E=C.location)==null?void 0:E.latitude)!=null&&((O=C.location)==null?void 0:O.longitude)!=null}),h=z==null?void 0:z.location;if(z&&h){const C=x(h.latitude,h.longitude,n.latitude,n.longitude);o.push({id:`${z.id}-to-home-final`,type:"venue_to_home",fromType:"venue",toType:"home",fromDateId:z.id,fromLocation:h,transportType:"bus",departureTime:v,arrivalTime:"",distance:C,duration:Math.round(C/80*60),notes:"Regreso final a la base"})}g(o),a({title:"Plan de viajes generado",description:`Se generaron ${o.length} segmentos de viaje con detección inteligente de descansos`})}catch{a({title:"Error",description:"No se pudo generar el plan de viajes",variant:"destructive"})}finally{P(!1)}},p=(o,_,M)=>{g(z=>z.map(h=>h.id===o?{...h,[_]:M}:h))},m=async()=>{if(!r){a({title:"Sin permisos",description:"No tienes permisos para editar el plan de viajes",variant:"destructive"});return}j(!0);try{const{error:o}=await I.from("tours").update({travel_plan:c}).eq("id",s);if(o)throw o;a({title:"Guardado",description:"El plan de viajes se ha guardado correctamente"}),t()}catch{a({title:"Error",description:"No se pudo guardar el plan de viajes",variant:"destructive"})}finally{j(!1)}},i=o=>{switch(o){case"plane":return e.jsx(Xt,{className:"h-4 w-4"});case"train":return e.jsx(Ht,{className:"h-4 w-4"});default:return e.jsx(Jt,{className:"h-4 w-4"})}},u=o=>o.type==="home_to_venue"?"🏠 → 📍 Base a Venue":o.type==="venue_to_home"?"📍 → 🏠 Venue a Base":o.type==="venue_to_venue"?"📍 → 📍 Entre Venues":"Viaje",f=()=>c.reduce((o,_)=>o+_.distance,0),w=()=>c.reduce((o,_)=>o+_.duration,0),A=()=>c.filter(o=>o.isGapReturn).length;return n?e.jsxs("div",{className:"space-y-6",children:[e.jsxs(W,{children:[e.jsx(te,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-5 w-5"}),"Plan de Viajes Inteligente"]}),r&&e.jsx(F,{onClick:y,disabled:b,children:b?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 mr-2 animate-spin"}),"Generando..."]}):"Regenerar Plan"})]})}),e.jsxs(B,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-1",children:"Total Segmentos"}),e.jsx("div",{className:"text-2xl font-bold",children:c.length})]}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-950 border border-green-200 dark:border-green-800 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-1",children:"Distancia Total"}),e.jsxs("div",{className:"text-2xl font-bold",children:[f()," km"]})]}),e.jsxs("div",{className:"bg-purple-50 dark:bg-purple-950 border border-purple-200 dark:border-purple-800 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-1",children:"Tiempo Total"}),e.jsxs("div",{className:"text-2xl font-bold",children:[Math.round(w()/60),"h"]})]}),e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-1",children:"Regresos a Casa"}),e.jsx("div",{className:"text-2xl font-bold",children:A()})]})]}),c.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(Oe,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No hay plan de viajes generado"}),e.jsx("p",{className:"text-sm mt-1",children:'Haz clic en "Regenerar Plan" para crear uno automáticamente'})]}):e.jsx(es,{className:"h-[500px]",children:e.jsx("div",{className:"space-y-4",children:c.map((o,_)=>{var M,z;return e.jsx(W,{className:"relative",children:e.jsx(B,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsxs(U,{variant:"outline",className:"text-xs",children:["#",_+1]}),i(o.transportType)]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-semibold text-sm",children:u(o)}),o.isGapReturn&&e.jsxs(U,{variant:"default",className:"bg-amber-500",children:[o.gapDays," días de descanso"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Desde: "}),e.jsx("span",{className:"font-medium",children:o.fromType==="home"?n.name:((M=o.fromLocation)==null?void 0:M.name)||"Venue"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Hasta: "}),e.jsx("span",{className:"font-medium",children:o.toType==="home"?n.name:((z=o.toLocation)==null?void 0:z.name)||"Venue"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(R,{className:"text-xs",children:"Transporte"}),e.jsxs(ie,{value:o.transportType,onValueChange:h=>p(o.id,"transportType",h),disabled:!r,children:[e.jsx(le,{className:"h-8",children:e.jsx(oe,{})}),e.jsxs(ce,{children:[e.jsx(K,{value:"bus",children:"Bus"}),e.jsx(K,{value:"van",children:"Van"}),e.jsx(K,{value:"personal",children:"Personal"}),e.jsx(K,{value:"plane",children:"Avión"}),e.jsx(K,{value:"train",children:"Tren"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(R,{className:"text-xs",children:"Salida"}),e.jsx(ee,{type:"time",value:o.departureTime,onChange:h=>p(o.id,"departureTime",h.target.value),disabled:!r,className:"h-8"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(R,{className:"text-xs",children:"Llegada"}),e.jsx(ee,{type:"time",value:o.arrivalTime,onChange:h=>p(o.id,"arrivalTime",h.target.value),disabled:!r,className:"h-8"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(R,{className:"text-xs",children:"Distancia"}),e.jsxs("div",{className:"h-8 px-3 bg-muted rounded-md flex items-center text-sm",children:[o.distance," km (",Math.round(o.duration/60),"h)"]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(R,{className:"text-xs",children:"Notas"}),e.jsx(ee,{value:o.notes,onChange:h=>p(o.id,"notes",h.target.value),disabled:!r,placeholder:"Información adicional del viaje",className:"h-8"})]})]})]})})},o.id)})})})]})]}),r&&c.length>0&&e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx(F,{onClick:m,disabled:N,children:N?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 mr-2 animate-spin"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Guardar Plan de Viajes"]})})}),!r&&e.jsx("div",{className:"bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-lg p-4 text-sm text-amber-700 dark:text-amber-300",children:"⚠ No tienes permisos para editar el plan de viajes"})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-center",children:[e.jsx(Ks,{className:"h-12 w-12 text-amber-500 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Configura la Base de Operaciones"}),e.jsx("p",{className:"text-muted-foreground max-w-md",children:"Para utilizar el planificador de viajes inteligente, primero debes configurar la base de operaciones en la pestaña de Configuración"})]})},Na=({tourId:s,tourData:l,canEdit:d,onSave:r})=>{const{toast:t}=me(),[a,c]=T.useState({name:"",address:"",latitude:null,longitude:null,defaultDepartureTime:"08:00",defaultReturnTime:"18:00"}),[g,N]=T.useState(!1),[j,b]=T.useState("");T.useEffect(()=>{if(l!=null&&l.tour_settings){const n=l.tour_settings.homeBase;c({name:(n==null?void 0:n.name)||"",address:(n==null?void 0:n.address)||"",latitude:(n==null?void 0:n.latitude)||null,longitude:(n==null?void 0:n.longitude)||null,defaultDepartureTime:l.tour_settings.defaultDepartureTime||"08:00",defaultReturnTime:l.tour_settings.defaultReturnTime||"18:00"}),n!=null&&n.address&&b(n.address)}},[l]);const P=n=>{n.coordinates&&(c({...a,name:n.name,address:n.address,latitude:n.coordinates.lat,longitude:n.coordinates.lng}),b(n.address),t({title:"Ubicación seleccionada",description:`${n.name} - ${n.address}`}))},S=async()=>{if(!d){t({title:"Sin permisos",description:"No tienes permisos para editar la configuración",variant:"destructive"});return}if(!a.name||!a.latitude||!a.longitude){t({title:"Datos incompletos",description:"Debes seleccionar una ubicación base para el tour",variant:"destructive"});return}N(!0);try{const n={homeBase:{name:a.name,address:a.address,latitude:a.latitude,longitude:a.longitude},defaultDepartureTime:a.defaultDepartureTime,defaultReturnTime:a.defaultReturnTime},{error:k}=await I.from("tours").update({tour_settings:n}).eq("id",s);if(k)throw k;t({title:"Guardado",description:"La configuración se ha guardado correctamente"}),r()}catch{t({title:"Error",description:"No se pudo guardar la configuración",variant:"destructive"})}finally{N(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(W,{children:[e.jsx(te,{children:e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(cs,{className:"h-5 w-5"}),"Base de Operaciones"]})}),e.jsxs(B,{className:"space-y-4",children:[d?e.jsxs("div",{className:"space-y-2",children:[e.jsx(gt,{value:j,onInputChange:n=>b(n),onSelect:P,placeholder:"Buscar ciudad, dirección o lugar...",label:"Buscar Ubicación"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Busca y selecciona la ubicación base de operaciones del tour"})]}):a.address&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Ubicación"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:a.address})]}),a.latitude&&a.longitude&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-950 border border-green-200 dark:border-green-800 rounded-lg p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-700 dark:text-green-300 font-medium",children:[e.jsx(Ne,{className:"h-4 w-4"}),"Ubicación Base Configurada"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:a.name}),e.jsx("div",{className:"text-muted-foreground",children:a.address}),e.jsxs("div",{className:"text-xs mt-1",children:["GPS: ",a.latitude.toFixed(6),", ",a.longitude.toFixed(6)]})]})]})]})]}),e.jsxs(W,{children:[e.jsx(te,{children:e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"h-5 w-5"}),"Horarios por Defecto"]})}),e.jsx(B,{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{htmlFor:"departure-time",children:"Hora de Salida por Defecto"}),e.jsx(ee,{id:"departure-time",type:"time",value:a.defaultDepartureTime,onChange:n=>c({...a,defaultDepartureTime:n.target.value}),disabled:!d}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Hora habitual de salida desde la base"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{htmlFor:"return-time",children:"Hora de Regreso por Defecto"}),e.jsx(ee,{id:"return-time",type:"time",value:a.defaultReturnTime,onChange:n=>c({...a,defaultReturnTime:n.target.value}),disabled:!d}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Hora habitual de regreso a la base"})]})]})})]}),d&&e.jsx("div",{className:"flex justify-end",children:e.jsx(F,{onClick:S,disabled:g,children:g?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 mr-2 animate-spin"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Guardar Configuración"]})})}),!d&&e.jsx("div",{className:"bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-lg p-4 text-sm text-amber-700 dark:text-amber-300",children:"⚠ No tienes permisos para editar la configuración del tour"})]})},ba=({tourId:s,tourData:l,canEdit:d,onSave:r})=>{const{toast:t}=me(),[a,c]=T.useState([]),[g,N]=T.useState(!1),[j,b]=T.useState(null),[P,S]=T.useState(!1),[n,k]=T.useState({name:"",role:"",phone:"",email:"",isPrimary:!1,notes:""});T.useEffect(()=>{l!=null&&l.tour_contacts&&c(l.tour_contacts)},[l]);const v=f=>{f?(b(f),k(f)):(b(null),k({name:"",role:"",phone:"",email:"",isPrimary:!1,notes:""})),N(!0)},x=()=>{N(!1),b(null),k({name:"",role:"",phone:"",email:"",isPrimary:!1,notes:""})},y=()=>{if(!n.name||!n.role){t({title:"Datos incompletos",description:"El nombre y rol son obligatorios",variant:"destructive"});return}let f;if(j)f=a.map(w=>w.id===j.id?{...w,...n}:w);else{const w={id:crypto.randomUUID(),name:n.name,role:n.role,phone:n.phone||"",email:n.email||"",isPrimary:n.isPrimary||!1,notes:n.notes||""};f=[...a,w]}n.isPrimary&&(f=f.map(w=>w.id===((j==null?void 0:j.id)||f[f.length-1].id)?w:{...w,isPrimary:!1})),c(f),x(),t({title:j?"Contacto actualizado":"Contacto agregado",description:"Recuerda guardar los cambios"})},p=f=>{d&&(c(a.filter(w=>w.id!==f)),t({title:"Contacto eliminado",description:"Recuerda guardar los cambios"}))},m=f=>{d&&(c(a.map(w=>({...w,isPrimary:w.id===f}))),t({title:"Contacto principal actualizado",description:"Recuerda guardar los cambios"}))},i=async()=>{if(!d){t({title:"Sin permisos",description:"No tienes permisos para editar los contactos",variant:"destructive"});return}S(!0);try{const{error:f}=await I.from("tours").update({tour_contacts:a}).eq("id",s);if(f)throw f;t({title:"Guardado",description:"Los contactos se han guardado correctamente"}),r()}catch{t({title:"Error",description:"No se pudieron guardar los contactos",variant:"destructive"})}finally{S(!1)}},u=a.find(f=>f.isPrimary);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(W,{children:[e.jsx(te,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(ke,{className:"h-5 w-5"}),"Contactos del Tour"]}),d&&e.jsxs(F,{onClick:()=>v(),children:[e.jsx(Le,{className:"h-4 w-4 mr-2"}),"Agregar Contacto"]})]})}),e.jsxs(B,{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Gestiona los contactos específicos del tour (tour managers, coordinadores, etc.) que aparecerán en todos los day sheets."}),u&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-lg p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(rs,{className:"h-4 w-4 text-amber-600 dark:text-amber-400 fill-amber-600 dark:fill-amber-400"}),e.jsx("span",{className:"font-medium text-amber-900 dark:text-amber-100",children:"Contacto Principal"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-semibold",children:u.name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:u.role}),u.phone&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Fs,{className:"h-3 w-3"}),u.phone]}),u.email&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ds,{className:"h-3 w-3"}),u.email]})]})]}),a.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ke,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No hay contactos registrados para este tour"}),e.jsx("p",{className:"text-sm mt-1",children:"Agrega contactos de tour managers y coordinadores"})]}):e.jsx("div",{className:"space-y-3",children:a.map(f=>e.jsx(W,{className:"relative",children:e.jsx(B,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold",children:f.name}),f.isPrimary&&e.jsxs(U,{variant:"default",className:"bg-amber-500",children:[e.jsx(rs,{className:"h-3 w-3 mr-1 fill-current"}),"Principal"]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Zt,{className:"h-3 w-3"}),f.role]}),e.jsxs("div",{className:"space-y-1",children:[f.phone&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Fs,{className:"h-3 w-3 text-muted-foreground"}),f.phone]}),f.email&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ds,{className:"h-3 w-3 text-muted-foreground"}),f.email]})]}),f.notes&&e.jsx("p",{className:"text-sm text-muted-foreground italic mt-2",children:f.notes})]}),d&&e.jsxs("div",{className:"flex gap-2",children:[!f.isPrimary&&e.jsx(F,{size:"sm",variant:"outline",onClick:()=>m(f.id),children:e.jsx(rs,{className:"h-3 w-3"})}),e.jsx(F,{size:"sm",variant:"outline",onClick:()=>v(f),children:"Editar"}),e.jsx(F,{size:"sm",variant:"destructive",onClick:()=>p(f.id),children:e.jsx(We,{className:"h-3 w-3"})})]})]})})},f.id))})]})]}),d&&a.length>0&&e.jsx("div",{className:"flex justify-end",children:e.jsx(F,{onClick:i,disabled:P,children:P?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 mr-2 animate-spin"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Guardar Contactos"]})})}),e.jsx(xe,{open:g,onOpenChange:N,children:e.jsxs(pe,{children:[e.jsxs(fe,{children:[e.jsx(ge,{children:j?"Editar Contacto":"Agregar Contacto"}),e.jsx(Ge,{children:"Información del contacto para el tour"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{htmlFor:"contact-name",children:"Nombre *"}),e.jsx(ee,{id:"contact-name",value:n.name||"",onChange:f=>k({...n,name:f.target.value}),placeholder:"Nombre completo"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{htmlFor:"contact-role",children:"Rol *"}),e.jsx(ee,{id:"contact-role",value:n.role||"",onChange:f=>k({...n,role:f.target.value}),placeholder:"Tour Manager, Coordinador, etc."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{htmlFor:"contact-phone",children:"Teléfono"}),e.jsx(ee,{id:"contact-phone",value:n.phone||"",onChange:f=>k({...n,phone:f.target.value}),placeholder:"+34 600 000 000",type:"tel"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{htmlFor:"contact-email",children:"Email"}),e.jsx(ee,{id:"contact-email",value:n.email||"",onChange:f=>k({...n,email:f.target.value}),placeholder:"email@ejemplo.com",type:"email"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{htmlFor:"contact-notes",children:"Notas"}),e.jsx(ee,{id:"contact-notes",value:n.notes||"",onChange:f=>k({...n,notes:f.target.value}),placeholder:"Información adicional"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"contact-primary",checked:n.isPrimary||!1,onChange:f=>k({...n,isPrimary:f.target.checked}),className:"rounded"}),e.jsx(R,{htmlFor:"contact-primary",className:"cursor-pointer",children:"Establecer como contacto principal"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx(F,{variant:"outline",onClick:x,children:"Cancelar"}),e.jsx(F,{onClick:y,children:j?"Actualizar":"Agregar"})]})]})}),!d&&e.jsx("div",{className:"bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-lg p-4 text-sm text-amber-700 dark:text-amber-300",children:"⚠ No tienes permisos para editar los contactos del tour"})]})},wa=({tourData:s,tourDates:l,accommodations:d=[],mapboxToken:r})=>{me();const t=T.useRef(null),a=T.useRef(null),c=T.useRef(null),g=T.useRef([]),[N,j]=T.useState(!0),[b,P]=T.useState(null),[S,n]=T.useState(!1),[k,v]=T.useState(!1),x=[...l].sort((p,m)=>new Date(p.date).getTime()-new Date(m.date).getTime());T.useEffect(()=>{if(!t.current||c.current)return;let p=!0;return(async()=>{try{j(!0),P(null);const[{default:i}]=await Promise.all([As(()=>import("./maps-lib-Ce1ARJmz.js").then(w=>w.m),__vite__mapDeps([0,1,2])),As(()=>import("./maps-lib-Ce1ARJmz.js").then(w=>w.a),__vite__mapDeps([0,1,2]))]);if(!p)return;a.current=i,i.accessToken=r;const u=new i.Map({container:t.current,style:"mapbox://styles/mapbox/dark-v11",center:[-3.7038,40.4168],zoom:5,projection:"mercator"});c.current=u,u.addControl(new i.NavigationControl({visualizePitch:!0}),"top-right"),u.addControl(new i.FullscreenControl,"top-right"),u.on("load",()=>{p&&(j(!1),n(!0),u.resize())}),u.on("error",w=>{p&&(P("No se pudieron cargar los datos del mapa. Inténtalo de nuevo más tarde."),j(!1))});const f=()=>u.resize();window.addEventListener("resize",f),u.once("remove",()=>{window.removeEventListener("resize",f)})}catch(i){if(!p)return;P(i.message||"No se pudo cargar el mapa. Revisa tu conexión."),j(!1)}})(),()=>{var i;p=!1,g.current.forEach(u=>u.remove()),g.current=[],(i=c.current)==null||i.remove(),c.current=null,a.current=null}},[]),T.useEffect(()=>{!S||!c.current||y()},[S,s,l,d]);const y=()=>{var H;if(!c.current)return;const p=a.current;if(!p)return;g.current.forEach(o=>o.remove()),g.current=[];const m=new p.LngLatBounds;let i=!1;const u=(H=s==null?void 0:s.tour_settings)==null?void 0:H.homeBase;if((u==null?void 0:u.latitude)!=null&&(u==null?void 0:u.longitude)!=null){i=!0;const o=document.createElement("div");o.className="custom-marker-home",o.innerHTML="🏠",o.style.fontSize="28px",o.style.cursor="pointer",o.style.filter="drop-shadow(0 2px 4px rgba(0,0,0,0.5))";const _=new p.Popup({offset:25,closeButton:!0}).setHTML(`
        <div style="padding: 8px; min-width: 200px; background: hsl(var(--popover)); color: hsl(var(--popover-foreground));">
          <h3 style="font-weight: bold; margin-bottom: 4px;">🏠 Base de Operaciones</h3>
          <p style="margin: 4px 0; font-size: 14px;">${u.name}</p>
          <p style="margin: 4px 0; font-size: 12px; opacity: 0.8;">${u.address||""}</p>
        </div>
      `),M=new p.Marker(o).setLngLat([u.longitude,u.latitude]).setPopup(_).addTo(c.current);g.current.push(M),m.extend([u.longitude,u.latitude])}x.forEach((o,_)=>{const M=o.locations||o.location;if(!(M!=null&&M.latitude)||!(M!=null&&M.longitude))return;i=!0;const z=document.createElement("div");z.className="custom-marker-venue",z.innerHTML=`<div style="
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #ef4444;
        border: 3px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        color: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        cursor: pointer;
      ">${_+1}</div>`;const h=new Date(o.date).toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),C=new p.Popup({offset:25,closeButton:!0}).setHTML(`
        <div style="padding: 8px; max-width: 250px; background: hsl(var(--popover)); color: hsl(var(--popover-foreground));">
          <h3 style="font-weight: bold; margin-bottom: 4px;">📍 Fecha ${_+1}</h3>
          <p style="margin: 4px 0; font-weight: 600; font-size: 14px;">${M.venue_name||"Venue"}</p>
          <p style="margin: 4px 0; font-size: 12px;">${h}</p>
          <p style="margin: 4px 0; font-size: 12px; opacity: 0.8;">${M.city||""}, ${M.state||""}</p>
          ${o.call_time?`<p style="margin: 4px 0; font-size: 12px;"><strong>Call:</strong> ${o.call_time}</p>`:""}
        </div>
      `),E=new p.Marker(z).setLngLat([M.longitude,M.latitude]).setPopup(C).addTo(c.current);g.current.push(E),m.extend([M.longitude,M.latitude])}),d.forEach((o,_)=>{if(!o.latitude||!o.longitude)return;i=!0;const M=document.createElement("div");M.className="custom-marker-hotel",M.innerHTML="🏨",M.style.fontSize="24px",M.style.cursor="pointer",M.style.filter="drop-shadow(0 2px 4px rgba(0,0,0,0.5))";const z=new p.Popup({offset:25,closeButton:!0}).setHTML(`
        <div style="padding: 8px; max-width: 250px; background: hsl(var(--popover)); color: hsl(var(--popover-foreground));">
          <h3 style="font-weight: bold; margin-bottom: 4px;">🏨 ${o.hotel_name||"Hotel"}</h3>
          ${o.hotel_address?`<p style="margin: 4px 0; font-size: 12px; opacity: 0.8;">${o.hotel_address}</p>`:""}
          ${o.check_in_date?`<p style="margin: 4px 0; font-size: 12px;"><strong>Check-in:</strong> ${new Date(o.check_in_date).toLocaleDateString("es-ES")}</p>`:""}
          ${o.check_out_date?`<p style="margin: 4px 0; font-size: 12px;"><strong>Check-out:</strong> ${new Date(o.check_out_date).toLocaleDateString("es-ES")}</p>`:""}
          ${o.rooms_booked?`<p style="margin: 4px 0; font-size: 12px;"><strong>Habitaciones:</strong> ${o.rooms_booked}</p>`:""}
        </div>
      `),h=new p.Marker(M).setLngLat([o.longitude,o.latitude]).setPopup(z).addTo(c.current);g.current.push(h),m.extend([o.longitude,o.latitude])}),c.current.getSource("tour-route")&&(c.current.removeLayer("tour-route-line"),c.current.removeSource("tour-route"));const f=[],w=Array.isArray(s==null?void 0:s.travel_plan)?s.travel_plan:[],A=o=>{if(!o)return null;const _=x.find(M=>M.id===o);return _&&(_.locations||_.location)||null},q=o=>{o&&((f.length===0||f[f.length-1][0]!==o[0]||f[f.length-1][1]!==o[1])&&f.push(o),m.extend(o),i=!0)};if(w.length>0&&w.forEach(o=>{const _=o.fromType==="home"?u:o.fromLocation||A(o.fromDateId),M=o.toType==="home"?u:o.toLocation||A(o.toDateId),z=(_==null?void 0:_.longitude)!=null&&(_==null?void 0:_.latitude)!=null?[_.longitude,_.latitude]:null,h=(M==null?void 0:M.longitude)!=null&&(M==null?void 0:M.latitude)!=null?[M.longitude,M.latitude]:null;q(z),q(h)}),w.length===0){if((u==null?void 0:u.latitude)!=null&&(u==null?void 0:u.longitude)!=null){const o=x.find(M=>{const z=M.locations||M.location;return(z==null?void 0:z.latitude)!=null&&(z==null?void 0:z.longitude)!=null}),_=(o==null?void 0:o.locations)||(o==null?void 0:o.location);(_==null?void 0:_.latitude)!=null&&(_==null?void 0:_.longitude)!=null&&(q([u.longitude,u.latitude]),q([_.longitude,_.latitude]))}for(let o=0;o<x.length-1;o++){const _=x[o].locations||x[o].location,M=x[o+1].locations||x[o+1].location;(_==null?void 0:_.latitude)!=null&&(_==null?void 0:_.longitude)!=null&&(M==null?void 0:M.latitude)!=null&&(M==null?void 0:M.longitude)!=null&&(f.length===0&&q([_.longitude,_.latitude]),q([M.longitude,M.latitude]))}if((u==null?void 0:u.latitude)!=null&&(u==null?void 0:u.longitude)!=null&&x.length>0){const o=[...x].reverse().find(M=>{const z=M.locations||M.location;return(z==null?void 0:z.latitude)!=null&&(z==null?void 0:z.longitude)!=null}),_=(o==null?void 0:o.locations)||(o==null?void 0:o.location);(_==null?void 0:_.latitude)!=null&&(_==null?void 0:_.longitude)!=null&&(f.length>0&&(f[f.length-1][0]!==_.longitude||f[f.length-1][1]!==_.latitude)&&q([_.longitude,_.latitude]),q([u.longitude,u.latitude]))}}const V=f.length>1;V&&(c.current.addSource("tour-route",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:f}}}),c.current.addLayer({id:"tour-route-line",type:"line",source:"tour-route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#8b5cf6","line-width":3,"line-opacity":.7}})),k!==V&&v(V),i&&!m.isEmpty()&&c.current.fitBounds(m,{padding:80,maxZoom:12,duration:800})};return b?e.jsxs("div",{className:"flex flex-col items-center justify-center h-[600px] text-center p-8",children:[e.jsx(Ks,{className:"h-16 w-16 text-destructive mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Error al cargar el mapa"}),e.jsx("p",{className:"text-muted-foreground",children:b}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Verifica que la API key de Mapbox esté configurada"})]}):e.jsx("div",{className:"space-y-4",children:e.jsxs(W,{className:"border-2",children:[e.jsx(te,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(Qs,{className:"h-5 w-5"}),"Mapa de Ruta del Tour"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(U,{variant:"outline",className:"bg-green-50 dark:bg-green-950",children:[e.jsx(cs,{className:"h-3 w-3 mr-1"}),"Base"]}),e.jsxs(U,{variant:"outline",className:"bg-red-50 dark:bg-red-950",children:[e.jsx(Ne,{className:"h-3 w-3 mr-1"}),"Venues"]}),k&&e.jsxs(U,{variant:"outline",className:"bg-violet-50 dark:bg-violet-950",children:[e.jsx("span",{className:"mr-1 inline-block h-[6px] w-4 rounded-full bg-violet-500"}),"Ruta"]}),d.length>0&&e.jsxs(U,{variant:"outline",className:"bg-purple-50 dark:bg-purple-950",children:[e.jsx(Qe,{className:"h-3 w-3 mr-1"}),"Hoteles"]})]})]})}),e.jsxs(B,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{ref:t,className:"w-full h-[600px] rounded-lg border",style:{minHeight:"600px"}}),N&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-background/95 backdrop-blur-sm rounded-lg",children:[e.jsx(Z,{className:"h-8 w-8 animate-spin mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Cargando mapa..."})]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-4 h-4 rounded-full bg-green-500"}),e.jsx("span",{children:"Base de Operaciones"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-4 h-4 rounded-full bg-red-500"}),e.jsx("span",{children:"Venues del Tour"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-4 h-1 bg-violet-500"}),e.jsx("span",{children:"Ruta del Viaje"})]}),d.length>0&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"text-lg",children:"🏨"}),e.jsx("span",{children:"Alojamientos"})]})]}),x.length===0&&e.jsx("div",{className:"mt-4 bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-lg p-4 text-sm text-amber-700 dark:text-amber-300",children:"⚠ No hay fechas con ubicaciones configuradas para mostrar en el mapa"})]})]})})},_a=({tourId:s,tourDates:l,tourData:d,canEdit:r,onSave:t})=>{var z;const{toast:a}=me(),[c,g]=T.useState([]),[N,j]=T.useState(!1),[b,P]=T.useState(null),[S,n]=T.useState(!1),[k,v]=T.useState(!0),[x,y]=T.useState([]),[p,m]=T.useState({tour_date_id:"",hotel_name:"",hotel_address:"",hotel_phone:"",hotel_email:"",check_in_date:"",check_out_date:"",confirmation_number:"",notes:"",room_allocation:[]}),i=[...l].sort((h,C)=>new Date(h.date).getTime()-new Date(C.date).getTime());T.useEffect(()=>{u(),f()},[s]);const u=async()=>{v(!0);try{const{data:h,error:C}=await I.from("tour_accommodations").select("*").eq("tour_id",s).order("check_in",{ascending:!0});if(C)throw C;g(h||[])}catch{a({title:"Error",description:"No se pudieron cargar los alojamientos",variant:"destructive"})}finally{v(!1)}},f=async()=>{try{const h=await I.from("profiles").select("id, full_name, role").eq("is_active",!0).order("full_name"),{data:C,error:E}=h;if(E)throw E;y(C||[])}catch{}},w=h=>{var C,E;h?(P(h),m(h)):(P(null),m({tour_date_id:((C=i[0])==null?void 0:C.id)||"",hotel_name:"",hotel_address:"",hotel_phone:"",hotel_email:"",check_in_date:((E=i[0])==null?void 0:E.date)||"",check_out_date:"",confirmation_number:"",notes:"",room_allocation:[{id:crypto.randomUUID(),room_type:"single"}]})),j(!0)},A=()=>{j(!1),P(null)},q=async()=>{var h;if(!r){a({title:"Sin permisos",description:"No tienes permisos para editar alojamientos",variant:"destructive"});return}if(!p.hotel_name||!p.tour_date_id){a({title:"Campos requeridos",description:"El nombre del hotel y la fecha son obligatorios",variant:"destructive"});return}n(!0);try{const C={tour_id:s,tour_date_id:p.tour_date_id,hotel_name:p.hotel_name,hotel_address:p.hotel_address,hotel_phone:p.hotel_phone,hotel_email:p.hotel_email,check_in_date:p.check_in_date,check_out_date:p.check_out_date,confirmation_number:p.confirmation_number,notes:p.notes,latitude:p.latitude,longitude:p.longitude,room_allocation:p.room_allocation||[],rooms_booked:((h=p.room_allocation)==null?void 0:h.length)||0};if(b){const{error:E}=await I.from("tour_accommodations").update(C).eq("id",b.id);if(E)throw E;a({title:"Actualizado",description:"Alojamiento actualizado correctamente"})}else{const{error:E}=await I.from("tour_accommodations").insert([C]);if(E)throw E;a({title:"Creado",description:"Alojamiento creado correctamente"})}A(),u(),t()}catch{a({title:"Error",description:"No se pudo guardar el alojamiento",variant:"destructive"})}finally{n(!1)}},V=async h=>{if(!r){a({title:"Sin permisos",description:"No tienes permisos para eliminar alojamientos",variant:"destructive"});return}if(confirm("¿Estás seguro de que deseas eliminar este alojamiento?"))try{const{error:C}=await I.from("tour_accommodations").delete().eq("id",h);if(C)throw C;a({title:"Eliminado",description:"Alojamiento eliminado correctamente"}),u(),t()}catch{a({title:"Error",description:"No se pudo eliminar el alojamiento",variant:"destructive"})}},H=()=>{m({...p,room_allocation:[...p.room_allocation||[],{id:crypto.randomUUID(),room_type:"single"}]})},o=h=>{var C;m({...p,room_allocation:((C=p.room_allocation)==null?void 0:C.filter(E=>E.id!==h))||[]})},_=(h,C,E)=>{var O;m({...p,room_allocation:((O=p.room_allocation)==null?void 0:O.map(G=>G.id===h?{...G,[C]:E}:G))||[]})},M=h=>i.find(C=>C.id===h);return k?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(Z,{className:"h-8 w-8 animate-spin"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(Qe,{className:"h-5 w-5"}),"Gestión de Alojamientos"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Gestiona hoteles y asignación de habitaciones para el tour"})]}),r&&e.jsxs(F,{onClick:()=>w(),className:"gap-2",children:[e.jsx(Le,{className:"h-4 w-4"}),"Añadir Alojamiento"]})]}),c.length===0?e.jsx(W,{children:e.jsx(B,{className:"py-12",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(Qe,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No hay alojamientos configurados para este tour"}),r&&e.jsx(F,{onClick:()=>w(),variant:"outline",className:"mt-4",children:"Añadir el primer alojamiento"})]})})}):e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:c.map(h=>{const C=M(h.tour_date_id),E=(C==null?void 0:C.locations)||(C==null?void 0:C.location);return e.jsxs(W,{className:"border-2 dark:border-gray-700",children:[e.jsx(te,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs(ae,{className:"text-lg flex items-center gap-2",children:[e.jsx(Qe,{className:"h-5 w-5 text-purple-600 dark:text-purple-400"}),h.hotel_name]}),E&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[E.venue_name," - ",E.city]})]}),r&&e.jsxs("div",{className:"flex gap-1",children:[e.jsx(F,{size:"sm",variant:"ghost",onClick:()=>w(h),children:"Editar"}),e.jsx(F,{size:"sm",variant:"ghost",onClick:()=>V(h.id),className:"text-destructive hover:text-destructive",children:e.jsx(We,{className:"h-4 w-4"})})]})]})}),e.jsxs(B,{className:"space-y-3",children:[h.hotel_address&&e.jsxs("div",{className:"flex items-start gap-2 text-sm",children:[e.jsx(Ne,{className:"h-4 w-4 mt-0.5 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-muted-foreground",children:h.hotel_address})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[h.check_in_date&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(se,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:"Check-in:"}),e.jsx("span",{className:"text-muted-foreground",children:new Date(h.check_in_date).toLocaleDateString("es-ES")})]}),h.check_out_date&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(se,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:"Check-out:"}),e.jsx("span",{className:"text-muted-foreground",children:new Date(h.check_out_date).toLocaleDateString("es-ES")})]})]}),h.room_allocation&&h.room_allocation.length>0&&e.jsxs("div",{className:"pt-2 border-t dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ks,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"text-sm font-medium",children:[h.room_allocation.length," ",h.room_allocation.length===1?"Habitación":"Habitaciones"]})]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:h.room_allocation.map((O,G)=>{var X,de;return e.jsxs("div",{className:"text-xs p-2 rounded bg-muted/50 dark:bg-muted/20",children:[e.jsxs("div",{className:"font-medium",children:[O.room_number||`Hab. ${G+1}`," - ",O.room_type==="single"?"Individual":"Doble"]}),O.staff_member_1&&e.jsxs("div",{className:"text-muted-foreground mt-1 flex items-center gap-1",children:[e.jsx(zs,{className:"h-3 w-3"}),((X=x.find(ne=>ne.id===O.staff_member_1))==null?void 0:X.full_name)||"Staff"]}),O.staff_member_2&&e.jsxs("div",{className:"text-muted-foreground flex items-center gap-1",children:[e.jsx(zs,{className:"h-3 w-3"}),((de=x.find(ne=>ne.id===O.staff_member_2))==null?void 0:de.full_name)||"Staff"]})]},O.id)})})]}),h.confirmation_number&&e.jsxs("div",{className:"text-xs text-muted-foreground pt-2 border-t dark:border-gray-700",children:[e.jsx("span",{className:"font-medium",children:"Confirmación:"})," ",h.confirmation_number]})]})]},h.id)})}),e.jsx(xe,{open:N,onOpenChange:j,children:e.jsxs(pe,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(fe,{children:[e.jsx(ge,{children:b?"Editar Alojamiento":"Nuevo Alojamiento"}),e.jsx(Ge,{children:"Configura los detalles del hotel y asigna habitaciones"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Fecha del Tour *"}),e.jsxs(ie,{value:p.tour_date_id,onValueChange:h=>m({...p,tour_date_id:h}),children:[e.jsx(le,{className:"dark:border-gray-600 dark:bg-gray-900",children:e.jsx(oe,{placeholder:"Seleccionar fecha"})}),e.jsx(ce,{children:i.map(h=>{const C=h.locations||h.location;return e.jsxs(K,{value:h.id,children:[new Date(h.date).toLocaleDateString("es-ES",{weekday:"short",day:"numeric",month:"short"})," - ",(C==null?void 0:C.venue_name)||(C==null?void 0:C.city)||"Sin ubicación"]},h.id)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Buscar Hotel *"}),e.jsx(Ut,{value:p.hotel_name||"",checkIn:p.check_in_date,checkOut:p.check_out_date,onChange:(h,C,E)=>{m({...p,hotel_name:h,hotel_address:C||p.hotel_address,latitude:E==null?void 0:E.lat,longitude:E==null?void 0:E.lng})},onCheckInChange:h=>m({...p,check_in_date:h}),onCheckOutChange:h=>m({...p,check_out_date:h}),placeholder:"Buscar por nombre de hotel...",className:"dark:border-gray-600 dark:bg-gray-900"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Teléfono"}),e.jsx(ee,{value:p.hotel_phone||"",onChange:h=>m({...p,hotel_phone:h.target.value}),placeholder:"+34 xxx xxx xxx",className:"dark:border-gray-600 dark:bg-gray-900"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Email"}),e.jsx(ee,{type:"email",value:p.hotel_email||"",onChange:h=>m({...p,hotel_email:h.target.value}),placeholder:"hotel@example.com",className:"dark:border-gray-600 dark:bg-gray-900"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Número de Confirmación"}),e.jsx(ee,{value:p.confirmation_number||"",onChange:h=>m({...p,confirmation_number:h.target.value}),placeholder:"ABC123456",className:"dark:border-gray-600 dark:bg-gray-900"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Notas"}),e.jsx(ee,{value:p.notes||"",onChange:h=>m({...p,notes:h.target.value}),placeholder:"Información adicional...",className:"dark:border-gray-600 dark:bg-gray-900"})]}),e.jsxs("div",{className:"space-y-4 pt-4 border-t dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h4",{className:"font-medium flex items-center gap-2",children:[e.jsx(ks,{className:"h-4 w-4"}),"Habitaciones"]}),e.jsxs(F,{onClick:H,size:"sm",variant:"outline",className:"gap-2",children:[e.jsx(Le,{className:"h-4 w-4"}),"Añadir Habitación"]})]}),e.jsx(Bt,{children:(z=p.room_allocation)==null?void 0:z.map((h,C)=>e.jsxs(Yt.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"p-4 border dark:border-gray-700 rounded-lg space-y-3 bg-muted/20 dark:bg-muted/10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h5",{className:"font-medium text-sm",children:["Habitación ",C+1]}),p.room_allocation&&p.room_allocation.length>1&&e.jsx(F,{size:"sm",variant:"ghost",onClick:()=>o(h.id),className:"h-8 w-8 p-0",children:e.jsx(os,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{className:"text-xs",children:"Tipo"}),e.jsxs(ie,{value:h.room_type,onValueChange:E=>_(h.id,"room_type",E),children:[e.jsx(le,{className:"dark:border-gray-600 dark:bg-gray-900",children:e.jsx(oe,{})}),e.jsxs(ce,{children:[e.jsx(K,{value:"single",children:"Individual"}),e.jsx(K,{value:"double",children:"Doble"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{className:"text-xs",children:"Número"}),e.jsx(ee,{value:h.room_number||"",onChange:E=>_(h.id,"room_number",E.target.value),placeholder:"101",className:"dark:border-gray-600 dark:bg-gray-900"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{className:"text-xs",children:"Personal 1"}),e.jsxs(ie,{value:h.staff_member_1||"none",onValueChange:E=>_(h.id,"staff_member_1",E==="none"?void 0:E),children:[e.jsx(le,{className:"dark:border-gray-600 dark:bg-gray-900",children:e.jsx(oe,{placeholder:"Seleccionar"})}),e.jsxs(ce,{children:[e.jsx(K,{value:"none",children:"Sin asignar"}),x.map(E=>e.jsx(K,{value:E.id,children:E.full_name},E.id))]})]})]}),h.room_type==="double"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{className:"text-xs",children:"Personal 2"}),e.jsxs(ie,{value:h.staff_member_2||"none",onValueChange:E=>_(h.id,"staff_member_2",E==="none"?void 0:E),children:[e.jsx(le,{className:"dark:border-gray-600 dark:bg-gray-900",children:e.jsx(oe,{placeholder:"Seleccionar"})}),e.jsxs(ce,{children:[e.jsx(K,{value:"none",children:"Sin asignar"}),x.map(E=>e.jsx(K,{value:E.id,children:E.full_name},E.id))]})]})]})]})]},h.id))})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t dark:border-gray-700",children:[e.jsx(F,{variant:"outline",onClick:A,children:"Cancelar"}),e.jsx(F,{onClick:q,disabled:S,children:S?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 mr-2 animate-spin"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Guardar"]})})]})]})})]})},_e=[125,1,1],Ca=30,Sa=async()=>{const s=["/sector pro logo.png","./sector pro logo.png","sector pro logo.png"];for(const l of s)try{const d=await fetch(l);if(!d.ok)continue;const r=await d.blob();return await new Promise((t,a)=>{const c=new FileReader;c.onload=()=>t(c.result),c.onerror=()=>a(new Error("Failed to convert image")),c.readAsDataURL(r)})}catch{continue}return null},Te=(s,l,d,r)=>{const t=s.internal.pageSize.width;if(s.setFillColor(..._e),s.rect(0,0,t,Ca,"F"),r)try{s.addImage(r,"PNG",5,5,25,20)}catch{}s.setTextColor(255,255,255),s.setFontSize(18),s.text(l,t/2,15,{align:"center"}),s.setFontSize(12),s.text(d,t/2,25,{align:"center"})},Re=async(s,l)=>{const d=s.internal.pageSize.width,r=s.internal.pageSize.height,t=await Sa();if(t)try{const g=(d-40)/2,N=r-25;s.addImage(t,"PNG",g,N,40,15)}catch{}s.setFontSize(8),s.setTextColor(100,100,100),s.text(`Generado el ${L(new Date,"d 'de' MMMM 'de' yyyy 'a las' HH:mm",{locale:Y})}`,10,r-10),l!==void 0&&s.text(`Página ${l}`,d-30,r-10)},Ta=async(s,l)=>{var j,b,P,S,n;const{jsPDF:d,autoTable:r}=await ds(),t=new d;t.internal.pageSize.width;let a=40,c;try{c=await He(s.id)}catch{}Te(t,s.name,`Day Sheet - ${L(new Date(l.date),"d 'de' MMMM 'de' yyyy",{locale:Y})}`,c),t.setTextColor(0,0,0),t.setFontSize(14),t.setFont(void 0,"bold"),t.text("Información del Evento",10,a),a+=10;const g=[["Fecha",L(new Date(l.date),"EEEE, d 'de' MMMM 'de' yyyy",{locale:Y})],["Ubicación",((j=l.location)==null?void 0:j.name)||"Por confirmar"],["Dirección",((b=l.location)==null?void 0:b.address)||"Por confirmar"]];r(t,{body:g,startY:a,theme:"plain",styles:{fontSize:10,cellPadding:3},columnStyles:{0:{cellWidth:40,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:10,right:10}}),a=t.lastAutoTable.finalY+15;try{const{data:k,error:v}=await I.from("hoja_de_ruta").select("*").eq("tour_date_id",l.id).maybeSingle();if(k&&k.program_schedule_json){t.setFontSize(14),t.setFont(void 0,"bold"),t.text("Programa del Día",10,a),a+=10;const y=k.program_schedule_json;for(const p of y)if(p.rows&&p.rows.length>0){p.label&&(t.setFontSize(12),t.setFont(void 0,"bold"),t.setTextColor(..._e),t.text(p.label,10,a),t.setTextColor(0,0,0),a+=8);const m=p.rows.map(i=>[i.time||"",i.item||"",i.dept||"",i.notes||""]);r(t,{head:[["Hora","Actividad","Dpto","Notas"]],body:m,startY:a,theme:"grid",styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:_e,textColor:[255,255,255],fontSize:10,fontStyle:"bold"},columnStyles:{0:{cellWidth:25,halign:"center"},1:{cellWidth:"auto"},2:{cellWidth:25,halign:"center"},3:{cellWidth:50}},margin:{left:10,right:10}}),a=t.lastAutoTable.finalY+10}}const x=await I.from("jobs").select("id").eq("tour_date_id",l.id).maybeSingle();if((P=x.data)!=null&&P.id&&((S=l.location)!=null&&S.address))try{const y=await Js(x.data.id,l.date,l.date,l.location.address);if(y&&y.length>0){a>250&&(t.addPage(),Te(t,s.name,"Day Sheet (continuación)",c),a=40),t.setFontSize(14),t.setFont(void 0,"bold"),t.text("Pronóstico del Tiempo",10,a),a+=10;const p=y.map(m=>[L(new Date(m.date),"EEE d MMM",{locale:Y}),m.icon+" "+m.condition,`${m.maxTemp}°C / ${m.minTemp}°C`,`${m.precipitationProbability}%`]);r(t,{head:[["Fecha","Condición","Temperatura","Lluvia"]],body:p,startY:a,theme:"grid",styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:_e,textColor:[255,255,255],fontSize:10,fontStyle:"bold"},columnStyles:{0:{cellWidth:35},1:{cellWidth:60},2:{cellWidth:40,halign:"center"},3:{cellWidth:30,halign:"center"}},margin:{left:10,right:10}}),a=t.lastAutoTable.finalY+10}}catch{}if((n=x.data)!=null&&n.id){const{data:y,error:p}=await I.from("job_assignments").select(`
          *,
          profiles!job_assignments_technician_id_fkey (
            first_name,
            last_name,
            phone
          )
        `).eq("job_id",x.data.id);if(y&&y.length>0){a>220&&(t.addPage(),Te(t,s.name,"Day Sheet (continuación)",c),a=40),t.setFontSize(14),t.setFont(void 0,"bold"),t.text("Personal Asignado",10,a),a+=10;const m=y.map(i=>{const u=Array.isArray(i.profiles)?i.profiles[0]:i.profiles,f=[];return i.sound_role&&f.push(`Sound: ${i.sound_role}`),i.lights_role&&f.push(`Lights: ${i.lights_role}`),i.video_role&&f.push(`Video: ${i.video_role}`),[`${(u==null?void 0:u.first_name)||""} ${(u==null?void 0:u.last_name)||""}`.trim(),f.join(", ")||"-",(u==null?void 0:u.phone)||"-"]});r(t,{head:[["Nombre","Roles","Teléfono"]],body:m,startY:a,theme:"grid",styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:_e,textColor:[255,255,255],fontSize:10,fontStyle:"bold"},columnStyles:{0:{cellWidth:60},1:{cellWidth:"auto"},2:{cellWidth:40}},margin:{left:10,right:10}})}}}catch{}await Re(t);const N=`${s.name}_${L(new Date(l.date),"yyyy-MM-dd",{locale:Y})}_daysheet.pdf`;t.save(N)},ka=async(s,l)=>{var k,v;const{jsPDF:d,autoTable:r}=await ds(),t=new d,a=t.internal.pageSize.width;let c=1,g;try{g=await He(s.id)}catch{}const N=[...l].sort((x,y)=>new Date(x.date).getTime()-new Date(y.date).getTime());if(t.setFillColor(..._e),t.rect(0,0,a,t.internal.pageSize.height,"F"),g)try{t.addImage(g,"PNG",(a-80)/2,40,80,60)}catch{}t.setTextColor(255,255,255),t.setFontSize(32),t.text(s.name,a/2,130,{align:"center"}),t.setFontSize(18),t.text("Tour Book",a/2,145,{align:"center"}),N.length>0&&(t.setFontSize(14),t.text(`${L(new Date(N[0].date),"d 'de' MMMM",{locale:Y})} - ${L(new Date(N[N.length-1].date),"d 'de' MMMM 'de' yyyy",{locale:Y})}`,a/2,160,{align:"center"})),t.addPage(),c++,Te(t,s.name,"Índice",g);let j=45;t.setTextColor(0,0,0),t.setFontSize(16),t.setFont(void 0,"bold"),t.text("Contenido",10,j),j+=15,t.setFontSize(11),t.setFont(void 0,"normal"),["Resumen del Tour","Calendario Completo",...N.map((x,y)=>{var p;return`Día ${y+1}: ${L(new Date(x.date),"d 'de' MMMM",{locale:Y})} - ${((p=x.location)==null?void 0:p.name)||"TBC"}`})].forEach((x,y)=>{t.text(`${y+1}. ${x}`,15,j),j+=8}),await Re(t,c),t.addPage(),c++,Te(t,s.name,"Resumen del Tour",g),j=45,t.setTextColor(0,0,0);const P=[["Nombre del Tour",s.name],["Descripción",s.description||"N/A"],["Número de Fechas",N.length.toString()],["Fecha de Inicio",L(new Date(N[0].date),"d 'de' MMMM 'de' yyyy",{locale:Y})],["Fecha de Fin",L(new Date(N[N.length-1].date),"d 'de' MMMM 'de' yyyy",{locale:Y})],["Duración",`${Math.ceil((new Date(N[N.length-1].date).getTime()-new Date(N[0].date).getTime())/(1e3*60*60*24))} días`],["Estado",s.status==="active"?"Activo":s.status==="cancelled"?"Cancelado":"Completado"]];r(t,{body:P,startY:j,theme:"plain",styles:{fontSize:10,cellPadding:4},columnStyles:{0:{cellWidth:50,fontStyle:"bold",fillColor:[240,240,240]},1:{cellWidth:"auto"}},margin:{left:10,right:10}}),await Re(t,c),t.addPage(),c++,Te(t,s.name,"Calendario Completo",g),j=45;const S=N.map((x,y)=>{var p,m;return[`Día ${y+1}`,L(new Date(x.date),"EEE d MMM yyyy",{locale:Y}),((p=x.location)==null?void 0:p.name)||"Por confirmar",((m=x.location)==null?void 0:m.address)||"-"]});r(t,{head:[["Día","Fecha","Venue","Dirección"]],body:S,startY:j,theme:"grid",styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:_e,textColor:[255,255,255],fontSize:10,fontStyle:"bold"},columnStyles:{0:{cellWidth:20,halign:"center"},1:{cellWidth:35},2:{cellWidth:"auto"},3:{cellWidth:50}},margin:{left:10,right:10}}),await Re(t,c);for(let x=0;x<N.length;x++){const y=N[x];t.addPage(),c++,Te(t,s.name,`Día ${x+1} - ${L(new Date(y.date),"d 'de' MMMM",{locale:Y})}`,g),j=45,t.setTextColor(0,0,0);const p=[["Fecha",L(new Date(y.date),"EEEE, d 'de' MMMM 'de' yyyy",{locale:Y})],["Venue",((k=y.location)==null?void 0:k.name)||"Por confirmar"],["Dirección",((v=y.location)==null?void 0:v.address)||"Por confirmar"],["Notas",y.notes||"-"]];r(t,{body:p,startY:j,theme:"plain",styles:{fontSize:10,cellPadding:3},columnStyles:{0:{cellWidth:40,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:10,right:10}}),j=t.lastAutoTable.finalY+15;try{const{data:m}=await I.from("hoja_de_ruta").select("program_schedule_json").eq("tour_date_id",y.id).maybeSingle();if(m&&m.program_schedule_json){t.setFontSize(12),t.setFont(void 0,"bold"),t.text("Programa",10,j),j+=8;const i=m.program_schedule_json;for(const u of i)if(u.rows&&u.rows.length>0){const f=u.rows.map(w=>[w.time||"",w.item||"",w.dept||""]);r(t,{head:[["Hora","Actividad","Departamento"]],body:f,startY:j,theme:"striped",styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:_e,textColor:[255,255,255],fontSize:10,fontStyle:"bold"},columnStyles:{0:{cellWidth:25,halign:"center"},1:{cellWidth:"auto"},2:{cellWidth:30,halign:"center"}},margin:{left:10,right:10}}),j=t.lastAutoTable.finalY+5}}}catch{}await Re(t,c)}const n=`${s.name}_tourbook.pdf`;t.save(n)},re=[125,1,1],Ma=30;let Ke=null,ue=null;const Xs=async()=>{if(Ke&&ue)return{jsPDF:Ke,autoTable:ue};const s=await ds();return Ke=s.jsPDF,ue=s.autoTable,{jsPDF:Ke,autoTable:ue}},Pa=async()=>{const s=["/sector pro logo.png","./sector pro logo.png","sector pro logo.png"];for(const l of s)try{const d=await fetch(l);if(!d.ok)continue;const r=await d.blob();return await new Promise((t,a)=>{const c=new FileReader;c.onload=()=>t(c.result),c.onerror=()=>a(new Error("Failed to convert image")),c.readAsDataURL(r)})}catch{continue}return null},ye=(s,l,d,r)=>{const t=s.internal.pageSize.width;if(s.setFillColor(...re),s.rect(0,0,t,Ma,"F"),r)try{s.addImage(r,"PNG",5,5,25,20)}catch{}s.setTextColor(255,255,255),s.setFontSize(18),s.text(l,t/2,15,{align:"center"}),s.setFontSize(12),s.text(d,t/2,25,{align:"center"})},Zs=async(s,l)=>{const d=s.internal.pageSize.width,r=s.internal.pageSize.height,t=await Pa();if(t)try{const g=(d-40)/2,N=r-25;s.addImage(t,"PNG",g,N,40,15)}catch{}s.setFontSize(8),s.setTextColor(100,100,100),s.text(`Generado el ${L(new Date,"d 'de' MMMM 'de' yyyy 'a las' HH:mm",{locale:Y})}`,10,r-10)},et=(s,l,d)=>{if(!l||l.length===0)return d;s.setFontSize(14),s.setFont(void 0,"bold"),s.setTextColor(...re),s.text("Contactos del Tour",10,d),s.setTextColor(0,0,0),d+=8;const r=l.map(t=>{const a=[];return t.phone&&a.push(`Tel: ${t.phone}`),t.email&&a.push(`Email: ${t.email}`),[`${t.name}${t.isPrimary?" ⭐":""}`,t.role,a.join(`
`)||"-"]});return ue(s,{body:r,startY:d,theme:"grid",styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:re,textColor:[255,255,255],fontSize:10,fontStyle:"bold"},columnStyles:{0:{cellWidth:50},1:{cellWidth:45},2:{cellWidth:"auto"}},margin:{left:10,right:10}}),s.lastAutoTable.finalY+10},Xe=async(s,l,d,r)=>{var v,x,y,p,m,i,u,f,w;const{jsPDF:t}=await Xs(),a=new t;let c=40,g;try{g=await He(s.id)}catch{}const N=L(new Date(d.date),"d 'de' MMMM 'de' yyyy",{locale:Y}),j=r==="to"?"Viaje HACIA el Venue":"Viaje DESDE el Venue";ye(a,s.name,`${j} - ${N}`,g),a.setTextColor(0,0,0),a.setFontSize(14),a.setFont(void 0,"bold"),a.text("Información del Viaje",10,c),c+=10;const b=(v=s==null?void 0:s.tour_settings)==null?void 0:v.homeBase,P=r==="to"?b==null?void 0:b.name:(x=d.location)==null?void 0:x.name,S=r==="to"?(y=d.location)==null?void 0:y.name:b==null?void 0:b.name,n=[["Fecha de Viaje",N],["Origen",P||"Por confirmar"],["Destino",S||"Por confirmar"],["Tipo de Transporte",((p=l==null?void 0:l.transportType)==null?void 0:p.toUpperCase())||"BUS"],["Hora de Salida",(l==null?void 0:l.departureTime)||"Por confirmar"],["Hora de Llegada Estimada",(l==null?void 0:l.arrivalTime)||"Por confirmar"],["Distancia",`${(l==null?void 0:l.distance)||0} km`],["Duración Estimada",`${Math.round(((l==null?void 0:l.duration)||0)/60)} horas`]];if(ue(a,{body:n,startY:c,theme:"plain",styles:{fontSize:10,cellPadding:3},columnStyles:{0:{cellWidth:60,fontStyle:"bold",fillColor:[240,240,240]},1:{cellWidth:"auto"}},margin:{left:10,right:10}}),c=a.lastAutoTable.finalY+15,r==="to"){a.setFontSize(12),a.setFont(void 0,"bold"),a.setTextColor(...re),a.text("Detalles del Destino",10,c),a.setTextColor(0,0,0),c+=8;const A=[["Venue",((m=d.location)==null?void 0:m.name)||"Por confirmar"],["Dirección",((i=d.location)==null?void 0:i.formatted_address)||"Por confirmar"],["Ciudad",`${((u=d.location)==null?void 0:u.city)||""}, ${((f=d.location)==null?void 0:f.state)||""}`],["Call Time",d.call_time||"Por confirmar"]];ue(a,{body:A,startY:c,theme:"plain",styles:{fontSize:10,cellPadding:3},columnStyles:{0:{cellWidth:40,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:10,right:10}}),c=a.lastAutoTable.finalY+15}s.tour_contacts&&s.tour_contacts.length>0&&(c=et(a,s.tour_contacts,c));try{const A=await I.from("jobs").select("id").eq("tour_date_id",d.id).maybeSingle();if((w=A.data)!=null&&w.id){const{data:q}=await I.from("job_assignments").select(`
          *,
          profiles!job_assignments_technician_id_fkey (
            first_name,
            last_name,
            phone
          )
        `).eq("job_id",A.data.id);if(q&&q.length>0){c>220&&(a.addPage(),ye(a,s.name,`${j} (continuación)`,g),c=40),a.setFontSize(14),a.setFont(void 0,"bold"),a.setTextColor(...re),a.text("Roster de Crew",10,c),a.setTextColor(0,0,0),c+=10;const V=q.map(H=>{const o=Array.isArray(H.profiles)?H.profiles[0]:H.profiles,_=[];return H.sound_role&&_.push(`Sound: ${H.sound_role}`),H.lights_role&&_.push(`Lights: ${H.lights_role}`),H.video_role&&_.push(`Video: ${H.video_role}`),[`${(o==null?void 0:o.first_name)||""} ${(o==null?void 0:o.last_name)||""}`.trim(),_.join(", ")||"-",(o==null?void 0:o.phone)||"-"]});ue(a,{head:[["Nombre","Roles","Teléfono"]],body:V,startY:c,theme:"grid",styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:re,textColor:[255,255,255],fontSize:10,fontStyle:"bold"},columnStyles:{0:{cellWidth:60},1:{cellWidth:"auto"},2:{cellWidth:40}},margin:{left:10,right:10}}),c=a.lastAutoTable.finalY+10}}}catch{}if(l!=null&&l.notes){c>250&&(a.addPage(),ye(a,s.name,`${j} (continuación)`,g),c=40),a.setFontSize(12),a.setFont(void 0,"bold"),a.setTextColor(...re),a.text("Notas",10,c),a.setTextColor(0,0,0),c+=8,a.setFontSize(10),a.setFont(void 0,"normal");const A=a.splitTextToSize(l.notes,190);a.text(A,10,c)}await Zs(a);const k=`${s.name}_${L(new Date(d.date),"yyyy-MM-dd")}_travel_${r}.pdf`;a.save(k)},Ea=async(s,l)=>{var N,j,b,P,S,n,k;const{jsPDF:d}=await Xs(),r=new d;let t=40,a;try{a=await He(s.id)}catch{}ye(r,s.name,`Event Day Sheet - ${L(new Date(l.date),"d 'de' MMMM 'de' yyyy",{locale:Y})}`,a),r.setTextColor(0,0,0),r.setFontSize(14),r.setFont(void 0,"bold"),r.text("Información del Evento",10,t),t+=10;const c=[["Fecha",L(new Date(l.date),"EEEE, d 'de' MMMM 'de' yyyy",{locale:Y})],["Venue",((N=l.location)==null?void 0:N.name)||"Por confirmar"],["Dirección",((j=l.location)==null?void 0:j.formatted_address)||"Por confirmar"],["Ciudad",`${((b=l.location)==null?void 0:b.city)||""}, ${((P=l.location)==null?void 0:P.state)||""}`],["Call Time",l.call_time||"Por confirmar"],["Showtime",l.showtime||"Por confirmar"]];ue(r,{body:c,startY:t,theme:"plain",styles:{fontSize:10,cellPadding:3},columnStyles:{0:{cellWidth:40,fontStyle:"bold",fillColor:[240,240,240]},1:{cellWidth:"auto"}},margin:{left:10,right:10}}),t=r.lastAutoTable.finalY+15;try{const{data:v}=await I.from("hoja_de_ruta").select("*").eq("tour_date_id",l.id).maybeSingle();if(v&&v.program_schedule_json){r.setFontSize(14),r.setFont(void 0,"bold"),r.setTextColor(...re),r.text("Programa del Evento",10,t),r.setTextColor(0,0,0),t+=10;const x=v.program_schedule_json;for(const y of x)if(y.rows&&y.rows.length>0){y.label&&(r.setFontSize(12),r.setFont(void 0,"bold"),r.text(y.label,10,t),t+=8);const p=y.rows.map(m=>[m.time||"",m.item||"",m.dept||"",m.notes||""]);ue(r,{head:[["Hora","Actividad","Dpto","Notas"]],body:p,startY:t,theme:"grid",styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:re,textColor:[255,255,255],fontSize:10,fontStyle:"bold"},columnStyles:{0:{cellWidth:25,halign:"center"},1:{cellWidth:"auto"},2:{cellWidth:25,halign:"center"},3:{cellWidth:50}},margin:{left:10,right:10}}),t=r.lastAutoTable.finalY+10}}if(v!=null&&v.hotel_info){t>200&&(r.addPage(),ye(r,s.name,"Event Day Sheet (continuación)",a),t=40),r.setFontSize(14),r.setFont(void 0,"bold"),r.setTextColor(...re),r.text("Alojamiento",10,t),r.setTextColor(0,0,0),t+=10,r.setFontSize(10),r.setFont(void 0,"normal");const x=r.splitTextToSize(v.hotel_info,190);r.text(x,10,t),t+=x.length*5+10}if(v!=null&&v.restaurants_info){t>220&&(r.addPage(),ye(r,s.name,"Event Day Sheet (continuación)",a),t=40),r.setFontSize(14),r.setFont(void 0,"bold"),r.setTextColor(...re),r.text("Restaurantes Recomendados",10,t),r.setTextColor(0,0,0),t+=10,r.setFontSize(10),r.setFont(void 0,"normal");const x=r.splitTextToSize(v.restaurants_info,190);r.text(x,10,t),t+=x.length*5+10}}catch{}try{const v=await I.from("jobs").select("id").eq("tour_date_id",l.id).maybeSingle();if((S=v.data)!=null&&S.id&&((n=l.location)!=null&&n.formatted_address)){const x=await Js(v.data.id,l.date,l.date,l.location.formatted_address);if(x&&x.length>0){t>230&&(r.addPage(),ye(r,s.name,"Event Day Sheet (continuación)",a),t=40),r.setFontSize(14),r.setFont(void 0,"bold"),r.setTextColor(...re),r.text("Pronóstico del Tiempo",10,t),r.setTextColor(0,0,0),t+=10;const y=x.map(p=>[L(new Date(p.date),"EEE d MMM",{locale:Y}),p.icon+" "+p.condition,`${p.maxTemp}°C / ${p.minTemp}°C`,`${p.precipitationProbability}%`]);ue(r,{head:[["Fecha","Condición","Temperatura","Lluvia"]],body:y,startY:t,theme:"grid",styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:re,textColor:[255,255,255],fontSize:10,fontStyle:"bold"},margin:{left:10,right:10}}),t=r.lastAutoTable.finalY+10}}}catch{}s.tour_contacts&&s.tour_contacts.length>0&&(t>200&&(r.addPage(),ye(r,s.name,"Event Day Sheet (continuación)",a),t=40),t=et(r,s.tour_contacts,t));try{const v=await I.from("jobs").select("id").eq("tour_date_id",l.id).maybeSingle();if((k=v.data)!=null&&k.id){const{data:x}=await I.from("job_assignments").select(`
          *,
          profiles!job_assignments_technician_id_fkey (
            first_name,
            last_name,
            phone
          )
        `).eq("job_id",v.data.id);if(x&&x.length>0){t>200&&(r.addPage(),ye(r,s.name,"Event Day Sheet (continuación)",a),t=40),r.setFontSize(14),r.setFont(void 0,"bold"),r.setTextColor(...re),r.text("Crew Asignado al Evento",10,t),r.setTextColor(0,0,0),t+=10;const y=x.map(p=>{const m=Array.isArray(p.profiles)?p.profiles[0]:p.profiles,i=[];return p.sound_role&&i.push(`Sound: ${p.sound_role}`),p.lights_role&&i.push(`Lights: ${p.lights_role}`),p.video_role&&i.push(`Video: ${p.video_role}`),[`${(m==null?void 0:m.first_name)||""} ${(m==null?void 0:m.last_name)||""}`.trim(),i.join(", ")||"-",(m==null?void 0:m.phone)||"-"]});ue(r,{head:[["Nombre","Roles","Teléfono"]],body:y,startY:t,theme:"grid",styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:re,textColor:[255,255,255],fontSize:10,fontStyle:"bold"},margin:{left:10,right:10}})}}}catch{}await Zs(r);const g=`${s.name}_${L(new Date(l.date),"yyyy-MM-dd")}_event.pdf`;r.save(g)},Fa=async(s,l,d)=>{const r=d.find(a=>a.toDateId===l.id&&a.toType==="venue"),t=d.find(a=>a.fromDateId===l.id&&a.fromType==="venue");r&&await Xe(s,r,l,"to"),await Ea(s,l),t&&await Xe(s,t,l,"from")},Da=({open:s,onOpenChange:l,tourId:d,tourDates:r,tourName:t})=>{const{toast:a}=me(),{userRole:c}=Ve(),[g,N]=T.useState("timeline"),[j,b]=T.useState(!1),[P,S]=T.useState(!1),[n,k]=T.useState(null),[v,x]=T.useState(null),[y,p]=T.useState(!0),[m,i]=T.useState([]),[u,f]=T.useState(null),w=c==="admin"||c==="management";T.useEffect(()=>{s&&d&&A()},[s,d]);const A=async()=>{var o;p(!0);try{const{data:_,error:M}=await I.from("tours").select(`
          *,
          tour_dates (
            *,
            locations (*)
          )
        `).eq("id",d).single();if(M)throw M;const z=((o=_.tour_dates)==null?void 0:o.map(de=>de.id))||[],{data:h,error:C}=await I.from("hoja_de_ruta").select("*").in("tour_date_id",z);if(C)throw C;const{data:E,error:O}=await I.from("tour_accommodations").select("*").eq("tour_id",d);O||i(E||[]);const{data:G,error:X}=await I.functions.invoke("get-mapbox-token");X||G!=null&&G.token&&f(G.token),x({..._,hojaDeRutaRecords:h||[]}),_.tour_dates&&_.tour_dates.length>0&&k(_.tour_dates[0].id)}catch{a({title:"Error",description:"No se pudieron cargar los datos de programación del tour",variant:"destructive"})}finally{p(!1)}},q=async()=>{if(!w){a({title:"Sin permisos",description:"No tienes permisos para editar la programación",variant:"destructive"});return}S(!0);try{a({title:"Guardado",description:"Los cambios se han guardado correctamente"})}catch{a({title:"Error",description:"No se pudieron guardar los cambios",variant:"destructive"})}finally{S(!1)}},V=async o=>{b(!0);try{const _=r.find(M=>M.id===o);if(!_)throw new Error("Fecha no encontrada");await Ta(v,_),a({title:"Day Sheet generado",description:`Day sheet para ${new Date(_.date).toLocaleDateString("es-ES")} generado correctamente`})}catch{a({title:"Error",description:"No se pudo generar el day sheet",variant:"destructive"})}finally{b(!1)}},H=async()=>{b(!0);try{await ka(v,r),a({title:"Tour Book generado",description:"El libro completo del tour se ha generado correctamente"})}catch{a({title:"Error",description:"No se pudo generar el tour book",variant:"destructive"})}finally{b(!1)}};return e.jsx(xe,{open:s,onOpenChange:l,children:e.jsxs(pe,{className:"max-w-[95vw] max-h-[95vh] w-full h-full overflow-hidden flex flex-col",children:[e.jsx(fe,{className:"flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(ge,{className:"text-2xl flex items-center gap-2",children:[e.jsx(Me,{className:"h-6 w-6"}),"Programación y Timeline del Tour"]}),e.jsxs(Ge,{children:[t," - Gestión completa de itinerarios y programación"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!w&&e.jsx(U,{variant:"outline",className:"bg-amber-50 text-amber-700 border-amber-200",children:"Solo lectura"}),e.jsxs(U,{variant:"outline",children:[r.length," fechas"]})]})]})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsxs(Lt,{value:g,onValueChange:N,className:"h-full flex flex-col",children:[e.jsxs(It,{className:"grid w-full grid-cols-8 flex-shrink-0",children:[e.jsxs(be,{value:"timeline",className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4"}),"Timeline"]}),e.jsxs(be,{value:"itinerary",className:"flex items-center gap-2",children:[e.jsx(Me,{className:"h-4 w-4"}),"Itinerarios"]}),e.jsxs(be,{value:"travel",className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-4 w-4"}),"Viajes"]}),e.jsxs(be,{value:"accommodations",className:"flex items-center gap-2",children:[e.jsx(cs,{className:"h-4 w-4"}),"Alojamientos"]}),e.jsxs(be,{value:"settings",className:"flex items-center gap-2",children:[e.jsx(ls,{className:"h-4 w-4"}),"Configuración"]}),e.jsxs(be,{value:"contacts",className:"flex items-center gap-2",children:[e.jsx(ke,{className:"h-4 w-4"}),"Contactos"]}),e.jsxs(be,{value:"map",className:"flex items-center gap-2",children:[e.jsx(Qs,{className:"h-4 w-4"}),"Mapa"]}),e.jsxs(be,{value:"documents",className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4"}),"Documentos"]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto mt-4",children:[e.jsx(we,{value:"timeline",className:"h-full m-0",children:y?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(Z,{className:"h-8 w-8 animate-spin"})}):e.jsx(ja,{tourData:v,tourDates:r,onDateSelect:k,selectedDateId:n,canEdit:w,onGenerateDaySheet:V})}),e.jsx(we,{value:"itinerary",className:"h-full m-0",children:y?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(Z,{className:"h-8 w-8 animate-spin"})}):e.jsx(va,{tourData:v,tourDates:r,selectedDateId:n,onDateSelect:k,canEdit:w,onSave:A})}),e.jsx(we,{value:"travel",className:"h-full m-0",children:y?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(Z,{className:"h-8 w-8 animate-spin"})}):e.jsx(ya,{tourId:d,tourData:v,tourDates:r,canEdit:w,onSave:A})}),e.jsx(we,{value:"accommodations",className:"h-full m-0",children:y?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(Z,{className:"h-8 w-8 animate-spin"})}):e.jsx(_a,{tourId:d,tourDates:r,tourData:v,canEdit:w,onSave:A})}),e.jsx(we,{value:"settings",className:"h-full m-0",children:y?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(Z,{className:"h-8 w-8 animate-spin"})}):e.jsx(Na,{tourId:d,tourData:v,canEdit:w,onSave:A})}),e.jsx(we,{value:"contacts",className:"h-full m-0",children:y?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(Z,{className:"h-8 w-8 animate-spin"})}):e.jsx(ba,{tourId:d,tourData:v,canEdit:w,onSave:A})}),e.jsx(we,{value:"map",className:"h-full m-0",children:y||!u?e.jsxs("div",{className:"flex items-center justify-center h-64",children:[e.jsx(Z,{className:"h-8 w-8 animate-spin"}),e.jsx("p",{className:"text-sm text-muted-foreground ml-2",children:y?"Cargando datos...":"Cargando mapa..."})]}):e.jsx(wa,{tourData:v,tourDates:(v==null?void 0:v.tour_dates)||[],accommodations:m,mapboxToken:u})}),e.jsx(we,{value:"documents",className:"h-full m-0",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-muted/50 p-6 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Generación de Documentos"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Genera day sheets (viaje + evento), sets completos, o un tour book profesional"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"border rounded-lg p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Oe,{className:"h-6 w-6 text-blue-600 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold",children:"Day Sheets de Viaje"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Hojas de ruta de viajes (ida y vuelta)"})]})]}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:r.map(o=>e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs font-medium text-muted-foreground",children:new Date(o.date).toLocaleDateString("es-ES",{weekday:"short",day:"numeric",month:"short"})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(F,{size:"sm",variant:"outline",className:"flex-1",onClick:async()=>{b(!0);try{const M=((v==null?void 0:v.travel_plan)||[]).find(z=>z.toDateId===o.id);await Xe(v,M,o,"to")}catch{}finally{b(!1)}},disabled:j,children:"Ida"}),e.jsx(F,{size:"sm",variant:"outline",className:"flex-1",onClick:async()=>{b(!0);try{const M=((v==null?void 0:v.travel_plan)||[]).find(z=>z.fromDateId===o.id);await Xe(v,M,o,"from")}catch{}finally{b(!1)}},disabled:j,children:"Vuelta"})]})]},o.id))})]}),e.jsxs("div",{className:"border rounded-lg p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(he,{className:"h-6 w-6 text-purple-600 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold",children:"Sets Completos"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Viaje IDA + Evento + Viaje VUELTA"})]})]}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:r.map(o=>e.jsxs(F,{variant:"outline",className:"w-full justify-between",onClick:async()=>{b(!0);try{const _=(v==null?void 0:v.travel_plan)||[];await Fa(v,o,_),a({title:"Sets generados",description:"Se generaron todos los documentos para esta fecha"})}catch{a({title:"Error",description:"No se pudieron generar los documentos",variant:"destructive"})}finally{b(!1)}},disabled:j,children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4"}),new Date(o.date).toLocaleDateString("es-ES",{weekday:"short",day:"numeric",month:"short"})]}),e.jsx(Ie,{className:"h-4 w-4"})]},o.id))})]}),e.jsxs("div",{className:"border rounded-lg p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(he,{className:"h-6 w-6 text-green-600 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold",children:"Tour Book Completo"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Documento profesional completo"})]})]}),e.jsxs("ul",{className:"text-sm space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"• Portada corporativa"}),e.jsx("li",{children:"• Índice y resumen"}),e.jsx("li",{children:"• Calendario completo"}),e.jsx("li",{children:"• Páginas por fecha"}),e.jsx("li",{children:"• Contactos del tour"}),e.jsx("li",{children:"• Información de viajes"}),e.jsx("li",{children:"• Pronósticos meteorológicos"})]}),e.jsx(F,{className:"w-full",onClick:H,disabled:j,children:j?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 mr-2 animate-spin"}),"Generando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ie,{className:"h-4 w-4 mr-2"}),"Generar Tour Book"]})})]})]})]})})]})]})}),e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:w?e.jsx("span",{className:"text-green-600",children:"✓ Puedes editar la programación"}):e.jsx("span",{className:"text-amber-600",children:"⚠ Solo tienes permisos de lectura"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{variant:"outline",onClick:()=>l(!1),children:"Cerrar"}),w&&e.jsx(F,{onClick:q,disabled:P,children:P?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 mr-2 animate-spin"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Guardar Cambios"]})})]})]})]})})},Aa=({tour:s,tourJobId:l})=>{var js,vs,ys;const d=jt(),{toast:r}=me(),{userRole:t}=Ve(),[a]=vt(),g=a.get("mode")==="technician"||["technician","house_tech"].includes(t||""),[N,j]=T.useState(!1),[b,P]=T.useState(!1),[S,n]=T.useState(!1),[k,v]=T.useState(!1),[x,y]=T.useState(!1),[p,m]=T.useState(!1),[i,u]=T.useState(!1),[f,w]=T.useState(!1),[A,q]=T.useState(!1),[V,H]=T.useState(!1),[o,_]=T.useState(),[M,z]=T.useState(!1),[h,C]=T.useState(!1),[E,O]=T.useState(null),[G,X]=T.useState("sound"),[de,ne]=T.useState(!1),{assignments:De}=fa(s==null?void 0:s.id),{data:ss,refetch:us}=bt(s==null?void 0:s.id),ts=!!(ss!=null&&ss.rates_approved),{flexUuid:as,isLoading:Ae,error:hs,folderExists:st}=Us((s==null?void 0:s.id)||"");if(T.useEffect(()=>{s!=null&&s.id&&He(s.id).then(_)},[s==null?void 0:s.id]),!s)return e.jsx("div",{className:"container mx-auto p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Gira No Encontrada"}),e.jsx("p",{className:"text-muted-foreground",children:"No se pudo encontrar la gira solicitada."})]})});const xs=((js=s.tour_dates)==null?void 0:js.filter(D=>new Date(D.date)>=new Date).slice(0,5))||[],ze=((vs=s.tour_dates)==null?void 0:vs.length)||0,ps=((ys=s.tour_dates)==null?void 0:ys.filter(D=>new Date(D.date)<new Date).length)||0,fs=()=>s!=null&&s.tour_dates?[...s.tour_dates].sort((D,J)=>new Date(D.date).getTime()-new Date(J.date).getTime()):[],Pe=fs(),tt=()=>{const D=fs(),J=D.find(je=>new Date(je.date)>=new Date)||D[0];O((J==null?void 0:J.id)||null),C(!0)},at=async()=>{try{if(!E){r({title:"Selecciona una fecha",description:"Por favor elige una fecha de gira como destino.",variant:"destructive"});return}ne(!0);const{data:D,error:J}=await I.from("jobs").select("id, title, start_time, end_time").eq("tour_date_id",E).maybeSingle();if(J||!D){r({title:"No se encontró trabajo",description:"No hay trabajo vinculado a la fecha de gira seleccionada.",variant:"destructive"}),ne(!1);return}const{data:je}=await I.from("job_assignments").select("sound_role, lights_role, video_role, profiles!job_assignments_technician_id_fkey(first_name,last_name,phone)").eq("job_id",D.id),qe=G==="sound"?"sound_role":G==="lights"?"lights_role":"video_role",Be=(je||[]).filter($e=>!!$e[qe]),Ye=[];let Ns=0;for(const $e of Be){const ve=Array.isArray($e.profiles)?$e.profiles[0]:$e.profiles,mt=`${(ve==null?void 0:ve.first_name)??""} ${(ve==null?void 0:ve.last_name)??""}`.trim()||"Técnico";((ve==null?void 0:ve.phone)||"").trim()?Ns+=1:Ye.push(mt)}if(Ns===0){r({title:"Sin teléfonos",description:"No se encontraron números de teléfono válidos para el departamento seleccionado en esta fecha.",variant:"destructive"}),ne(!1);return}Ye.length>0&&r({title:"Faltan algunos teléfonos",description:`Miembros sin teléfono: ${Ye.slice(0,3).join(", ")}${Ye.length>3?"…":""}`});const{data:za,error:bs}=await I.functions.invoke("create-whatsapp-group",{body:{job_id:D.id,department:G}});bs?r({title:"Error al crear grupo",description:bs.message,variant:"destructive"}):(r({title:"Solicitado",description:"Se solicitó la creación del grupo de WhatsApp. Se finalizará en breve."}),C(!1))}catch(D){r({title:"Error",description:(D==null?void 0:D.message)||String(D),variant:"destructive"})}finally{ne(!1)}},rt=()=>{d(`/sound/consumos?tourId=${s.id}&mode=tour-defaults`)},nt=()=>{d(`/sound/pesos?tourId=${s.id}&mode=tour-defaults`)},it=async()=>{z(!0);try{await Tt(s),r({title:"Éxito",description:"Calendario de gira exportado exitosamente"})}catch{r({title:"Error",description:"Error al exportar el calendario de gira",variant:"destructive"})}finally{z(!1)}},Ue=De.length,lt=new Set(De.map(D=>D.department)).size,ot=()=>{q(!0)},ct=[{title:"Fechas y Ubicaciones de la Gira",description:"Ver fechas, recintos y ubicaciones de la gira",icon:se,onClick:()=>P(!0),badge:`${ze} fechas`,viewOnly:!0},{title:"Asignaciones del Equipo",description:g?"Ver miembros del equipo de gira (aplicados automáticamente a todos los trabajos)":"Asignar miembros del equipo a toda la gira (sincroniza automáticamente con todos los trabajos)",icon:ea,onClick:()=>v(!0),badge:`${Ue} asignados`,viewOnly:g,hasAutoSync:!0},{title:"Gestión de Documentos",description:"Subir, organizar y compartir documentos de la gira",icon:he,onClick:()=>y(!0),badge:"Disponible",viewOnly:!1},{id:"rates-manager",title:"Gestor de Tarifas y Extras",description:"Configurar extras y resolver problemas de tarifas",icon:sa,onClick:()=>u(!0),badge:ts?"Tarifas Aprobadas":"Requiere Aprobación",showForTechnician:!1},{title:"Presets de Gira",description:"Crear y gestionar presets de equipos para esta gira",icon:ta,onClick:()=>m(!0),badge:"Equipamiento",showForTechnician:!1},{title:"Configuración de Gira",description:"Valores por defecto de potencia y peso, configuraciones técnicas",icon:ls,onClick:()=>n(!0),badge:"Configuración",showForTechnician:!1},{title:"Requisitos de Potencia",description:"Establecer cálculos de potencia por defecto para todas las fechas",icon:Hs,onClick:rt,badge:"Por Defecto",showForTechnician:!1},{title:"Cálculos de Peso",description:"Configurar valores por defecto y cálculos de peso",icon:_t,onClick:nt,badge:"Por Defecto",showForTechnician:!1},{title:"Programación y Línea de Tiempo",description:"Línea de tiempo y gestión de programación de la gira",icon:Me,onClick:()=>H(!0),badge:"Disponible",viewOnly:!1,showForTechnician:!1},{title:"Logística",description:"Transporte para toda la gira con anulaciones por fecha",icon:aa,onClick:()=>w(!0),badge:"Disponible",showForTechnician:!1},{title:"Tareas de Gira",description:"Gestionar tareas y actualizaciones de toda la gira",icon:$t,onClick:ot,badge:"Disponible",showForTechnician:!1}].filter(D=>!(g&&D.showForTechnician===!1)),gs=()=>{d("/technician-dashboard")},dt=async()=>{if(Ae){r({title:"Cargando",description:"Por favor espera mientras cargamos la carpeta Flex..."});return}as?await Ys({elementId:as,onError:D=>{r({title:"Error",description:D.message||"Error al abrir Flex",variant:"destructive"})},onWarning:D=>{r({title:"Advertencia",description:D})}}):r(hs?{title:"Error",description:hs,variant:"destructive"}:{title:"Info",description:"Carpeta Flex no disponible para esta gira"})};return g?e.jsxs("div",{className:"max-w-[1920px] mx-auto p-3 md:p-6 space-y-4 md:space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row items-start gap-4",children:[e.jsx("div",{className:"flex-shrink-0 mx-auto md:mx-0",children:o?e.jsx("img",{src:o,alt:`${s.name} logo`,width:64,height:64,loading:"lazy",decoding:"async",className:"w-16 h-16 object-contain rounded-lg border border-border",onError:D=>{const J=D.target;J.style.display="none"}}):e.jsx("div",{className:"w-16 h-16 flex items-center justify-center rounded-lg border border-border bg-muted",children:e.jsx(se,{className:"h-8 w-8 text-muted-foreground"})})}),e.jsxs("div",{className:"flex-1 text-center md:text-left",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-center md:justify-start gap-2 mb-2",children:[e.jsxs(F,{variant:"ghost",onClick:gs,className:"p-0 h-auto",children:[e.jsx(qs,{className:"h-4 w-4 mr-1"}),"Volver al Panel"]}),e.jsxs(U,{variant:"outline",children:[e.jsx(Je,{className:"h-3 w-3 mr-1"}),"Vista de Técnico"]})]}),e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:s.name}),s.description&&e.jsx("p",{className:"text-muted-foreground mt-1 text-sm md:text-base",children:s.description}),e.jsxs("div",{className:"flex flex-wrap items-center justify-center md:justify-start gap-3 mt-2 text-sm text-muted-foreground",children:[s.start_date&&s.end_date&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs md:text-sm",children:[L(new Date(s.start_date),"MMM d")," - ",L(new Date(s.end_date),"MMM d, yyyy")]})]}),e.jsxs(U,{variant:"outline",style:{borderColor:s.color,color:s.color},children:[ze," fechas"]})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full",children:[e.jsxs(F,{variant:"outline",onClick:()=>v(!0),className:"w-full sm:w-auto",children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Ver Asignaciones"]}),e.jsxs(F,{onClick:()=>y(!0),className:"w-full sm:w-auto",children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),"Abrir Documentos"]})]})]}),e.jsxs(W,{children:[e.jsxs(te,{children:[e.jsx(ae,{className:"text-lg md:text-xl",children:"Fechas de Gira Programadas"}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Revisa las fechas y ubicaciones confirmadas para esta gira."})]}),e.jsx(B,{className:"px-3 md:px-6",children:Pe.length>0?e.jsx("div",{className:"space-y-3",children:Pe.map(D=>{var je;const J=D!=null&&D.date?new Date(D.date):null;return e.jsxs("div",{className:"p-3 md:p-4 border rounded-lg flex flex-col gap-2 bg-muted/30",children:[J?e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"font-medium text-sm md:text-base",children:L(J,"EEEE, MMMM d, yyyy")})]}),e.jsx(U,{variant:"outline",className:"self-start sm:self-auto",children:L(J,"HH:mm")})]}):e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(se,{className:"h-4 w-4"}),e.jsx("span",{children:"Fecha no disponible"})]}),((je=D.location)==null?void 0:je.name)&&e.jsxs("div",{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(Ne,{className:"h-4 w-4 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"break-words",children:D.location.name})]}),D.notes&&e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground whitespace-pre-wrap break-words",children:D.notes})]},D.id)})}):e.jsx("div",{className:"text-center py-10 text-muted-foreground text-sm",children:"Aún no hay fechas programadas disponibles para esta gira."})})]}),e.jsx(Cs,{open:b,onOpenChange:P,tourId:s.id,tourDates:Pe,readOnly:!0}),e.jsx(Ls,{open:k,onOpenChange:v,tourId:s.id,readOnly:!0}),e.jsx(Is,{open:x,onOpenChange:y,tourId:s.id,tourName:s.name})]}):e.jsxs("div",{className:"max-w-[1920px] mx-auto p-3 md:p-6 space-y-4 md:space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row items-start gap-4",children:[o&&e.jsx("div",{className:"flex-shrink-0 mx-auto md:mx-0",children:e.jsx("img",{src:o,alt:`${s.name} logo`,width:64,height:64,loading:"lazy",decoding:"async",className:"w-16 h-16 object-contain rounded-lg border border-border",onError:D=>{const J=D.target;J.style.display="none"}})}),e.jsxs("div",{className:"flex-1 text-center md:text-left",children:[g&&e.jsxs("div",{className:"flex flex-wrap items-center justify-center md:justify-start gap-2 mb-2",children:[e.jsxs(F,{variant:"ghost",onClick:gs,className:"p-0 h-auto",children:[e.jsx(qs,{className:"h-4 w-4 mr-1"}),"Volver al Panel"]}),e.jsxs(U,{variant:"outline",children:[e.jsx(Je,{className:"h-3 w-3 mr-1"}),"Vista de Técnico"]})]}),e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:s.name}),s.description&&e.jsx("p",{className:"text-muted-foreground mt-1 text-sm md:text-base",children:s.description}),e.jsxs("div",{className:"flex flex-wrap items-center justify-center md:justify-start gap-2 md:gap-4 mt-2",children:[s.start_date&&s.end_date&&e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm",children:[e.jsx(se,{className:"h-4 w-4"}),e.jsxs("span",{children:[L(new Date(s.start_date),"MMM d")," - ",L(new Date(s.end_date),"MMM d, yyyy")]})]}),e.jsxs(U,{variant:"outline",style:{borderColor:s.color,color:s.color},children:[ze," fechas"]}),Ue>0&&e.jsxs(U,{variant:"outline",children:[Ue," crew asignado"]})]})]})]}),!g&&e.jsxs("div",{className:"flex flex-col sm:flex-row flex-wrap gap-2",children:[e.jsxs(F,{onClick:it,variant:"outline",disabled:M,className:"w-full sm:w-auto",children:[e.jsx(ra,{className:"h-4 w-4 mr-2"}),M?"Imprimiendo...":"Imprimir Calendario"]}),(st||Ae)&&e.jsxs(F,{variant:"outline",size:"sm",className:"flex items-center gap-2 w-full sm:w-auto",onClick:dt,disabled:!as||Ae,children:[Ae?e.jsx(Z,{className:"h-4 w-4 animate-spin"}):e.jsx("img",{src:Bs,alt:"Flex",width:16,height:16,loading:"lazy",decoding:"async",className:"h-4 w-4"}),Ae?"Cargando...":"Flex"]}),(t==="management"||t==="admin")&&e.jsxs(F,{variant:"outline",size:"sm",className:"flex items-center gap-2 w-full sm:w-auto",onClick:tt,children:[e.jsx(na,{className:"h-4 w-4"}),"Grupo WhatsApp"]}),e.jsxs(F,{onClick:()=>j(!0),className:"w-full sm:w-auto",children:[e.jsx(ls,{className:"h-4 w-4 mr-2"}),"Configuración de Gira"]})]})]}),!g&&e.jsx("div",{className:"bg-blue-50 dark:bg-blue-950 p-3 md:p-4 rounded-lg border border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Vs,{className:"h-4 w-4 text-blue-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-xs md:text-sm text-blue-800 dark:text-blue-200",children:[e.jsx("p",{className:"font-medium mb-1",children:"Sincronización Automática de Trabajos"}),e.jsx("p",{className:"text-xs md:text-sm",children:"Las asignaciones de gira se aplican automáticamente a todos los trabajos de esta gira. Los miembros del equipo asignados a la gira aparecerán instantáneamente en todas las asignaciones de trabajos individuales, y eliminarlos de la gira los elimina de todos los trabajos."})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4",children:[e.jsxs(W,{children:[e.jsxs(te,{className:"flex flex-row items-center justify-between space-y-0 pb-2 px-3 md:px-6 pt-3 md:pt-6",children:[e.jsx(ae,{className:"text-xs md:text-sm font-medium",children:"Fechas Totales"}),e.jsx(se,{className:"h-3 w-3 md:h-4 md:w-4 text-muted-foreground flex-shrink-0"})]}),e.jsx(B,{className:"px-3 md:px-6 pb-3 md:pb-6",children:e.jsx("div",{className:"text-xl md:text-2xl font-bold",children:ze})})]}),e.jsxs(W,{children:[e.jsxs(te,{className:"flex flex-row items-center justify-between space-y-0 pb-2 px-3 md:px-6 pt-3 md:pt-6",children:[e.jsx(ae,{className:"text-xs md:text-sm font-medium",children:"Completadas"}),e.jsx(ia,{className:"h-3 w-3 md:h-4 md:w-4 text-muted-foreground flex-shrink-0"})]}),e.jsx(B,{className:"px-3 md:px-6 pb-3 md:pb-6",children:e.jsx("div",{className:"text-xl md:text-2xl font-bold",children:ps})})]}),e.jsxs(W,{children:[e.jsxs(te,{className:"flex flex-row items-center justify-between space-y-0 pb-2 px-3 md:px-6 pt-3 md:pt-6",children:[e.jsx(ae,{className:"text-xs md:text-sm font-medium",children:"Próximas"}),e.jsx(Me,{className:"h-3 w-3 md:h-4 md:w-4 text-muted-foreground flex-shrink-0"})]}),e.jsx(B,{className:"px-3 md:px-6 pb-3 md:pb-6",children:e.jsx("div",{className:"text-xl md:text-2xl font-bold",children:ze-ps})})]}),e.jsxs(W,{children:[e.jsxs(te,{className:"flex flex-row items-center justify-between space-y-0 pb-2 px-3 md:px-6 pt-3 md:pt-6",children:[e.jsx(ae,{className:"text-xs md:text-sm font-medium",children:"Crew Asignado"}),e.jsx(ke,{className:"h-3 w-3 md:h-4 md:w-4 text-muted-foreground flex-shrink-0"})]}),e.jsxs(B,{className:"px-3 md:px-6 pb-3 md:pb-6",children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold",children:Ue}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[lt," departamentos"]})]})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold mb-3 md:mb-4 px-1",children:g?"Información de Gira":"Áreas de Gestión"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-3 md:gap-4",children:ct.map((D,J)=>e.jsxs(W,{className:`hover:shadow-md transition-shadow cursor-pointer ${D.disabled?"opacity-60":""}`,onClick:D.onClick,children:[e.jsxs(te,{className:"pb-3 px-3 md:px-6 pt-3 md:pt-6",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D.icon,{className:"h-5 w-5 md:h-6 md:w-6 flex-shrink-0",style:{color:s.color}}),D.hasAutoSync&&!g&&e.jsx(U,{variant:"outline",className:"text-xs border-blue-300 text-blue-700 hidden sm:inline-flex",children:"Auto-sincronización"})]}),e.jsx(U,{variant:D.badge==="Coming Soon"?"secondary":ts&&D.id==="rates-manager"?"default":"outline",className:"text-xs",children:D.badge})]}),!g&&D.id==="rates-manager"&&e.jsx("div",{className:"flex gap-2",children:ts?e.jsx(F,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:async je=>{je.stopPropagation(),await I.from("tours").update({rates_approved:!1,rates_approved_at:null,rates_approved_by:null}).eq("id",s.id),us()},children:"Revocar"}):e.jsx(F,{variant:"default",size:"sm",className:"w-full text-xs",onClick:async je=>{var Be;je.stopPropagation();const{data:qe}=await I.auth.getUser();await I.from("tours").update({rates_approved:!0,rates_approved_at:new Date().toISOString(),rates_approved_by:((Be=qe==null?void 0:qe.user)==null?void 0:Be.id)||null}).eq("id",s.id),us()},children:"Aprobar"})})]}),e.jsx(ae,{className:"text-sm md:text-base mt-2",children:D.title})]}),e.jsxs(B,{className:"px-3 md:px-6 pb-3 md:pb-6",children:[e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:D.description}),D.viewOnly&&g&&e.jsx(U,{variant:"secondary",className:"mt-2 text-xs",children:"Solo Lectura"})]})]},J))})]}),xs.length>0&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold mb-3 md:mb-4 px-1",children:"Próximas Fechas de Gira"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-3 md:gap-4",children:xs.map(D=>{var J;return e.jsxs(W,{children:[e.jsxs(te,{className:"pb-3 px-3 md:px-6 pt-3 md:pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(se,{className:"h-4 w-4 md:h-5 md:w-5 text-muted-foreground flex-shrink-0"}),e.jsx(U,{variant:"outline",className:"text-xs",children:L(new Date(D.date),"MMM d")})]}),e.jsx(ae,{className:"text-sm md:text-base mt-2",children:L(new Date(D.date),"EEEE, MMMM d, yyyy")})]}),e.jsxs(B,{className:"px-3 md:px-6 pb-3 md:pb-6",children:[((J=D.location)==null?void 0:J.name)&&e.jsxs("div",{className:"flex items-start gap-2 text-xs md:text-sm text-muted-foreground mb-2",children:[e.jsx(Ne,{className:"h-4 w-4 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"break-words",children:D.location.name})]}),!g&&e.jsx(ga,{tourDateId:D.id})]})]},D.id)})})]}),!g&&e.jsx(Ct,{open:N,onOpenChange:j,tour:s}),!g&&e.jsx(Nt,{open:i,onOpenChange:u,tourId:s.id}),e.jsx(Cs,{open:b,onOpenChange:P,tourId:s.id,tourDates:Pe,readOnly:g}),!g&&e.jsx(St,{open:S,onOpenChange:n,tour:s}),e.jsx(Ls,{open:k,onOpenChange:v,tourId:s.id,readOnly:g}),e.jsx(Is,{open:x,onOpenChange:y,tourId:s.id,tourName:s.name}),!g&&e.jsx(pa,{open:p,onOpenChange:m,tourId:s.id}),!g&&e.jsx(oa,{open:f,onOpenChange:w,tourId:s.id}),!g&&e.jsx(Rt,{open:A,onOpenChange:q,tourId:s.id,userRole:t}),!g&&e.jsx(Da,{open:V,onOpenChange:H,tourId:s.id,tourDates:Pe,tourName:s.name}),e.jsx(xe,{open:h,onOpenChange:C,children:e.jsxs(pe,{className:"w-[95vw] md:w-full max-w-md",children:[e.jsxs(fe,{children:[e.jsx(ge,{className:"text-base md:text-lg",children:"Crear Grupo de WhatsApp"}),e.jsx(Ge,{className:"text-xs md:text-sm",children:"Elige una fecha de gira y departamento. El grupo incluirá la tripulación asignada para esa fecha."})]}),e.jsxs("div",{className:"space-y-3 py-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs md:text-sm font-medium mb-1",children:"Fecha de Gira"}),e.jsx("select",{className:"w-full border rounded px-2 py-1 text-sm",value:E||"",onChange:D=>O(D.target.value||null),children:Pe.map(D=>{var J;return e.jsxs("option",{value:D.id,children:[L(new Date(D.date),"PPPP"),(J=D.location)!=null&&J.name?` · ${D.location.name}`:""]},D.id)})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs md:text-sm font-medium mb-1",children:"Departamento"}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer text-xs md:text-sm",children:[e.jsx("input",{type:"radio",name:"wa-dept",checked:G==="sound",onChange:()=>X("sound")}),e.jsx("span",{children:"Sonido"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer text-xs md:text-sm",children:[e.jsx("input",{type:"radio",name:"wa-dept",checked:G==="lights",onChange:()=>X("lights")}),e.jsx("span",{children:"Luces"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer text-xs md:text-sm",children:[e.jsx("input",{type:"radio",name:"wa-dept",checked:G==="video",onChange:()=>X("video")}),e.jsx("span",{children:"Vídeo"})]})]})]})]}),e.jsxs(Gs,{className:"flex-col sm:flex-row gap-2",children:[e.jsx(F,{variant:"outline",onClick:()=>C(!1),disabled:de,className:"w-full sm:w-auto",children:"Cancelar"}),e.jsx(F,{onClick:at,disabled:de,className:"w-full sm:w-auto",children:de?"Creando…":"Crear Grupo"})]})]})})]})},An=()=>{const{tourId:s}=yt(),{user:l}=Ve(),{data:d,isLoading:r,error:t}=Se({queryKey:["tour",s],queryFn:async()=>{if(!s)throw new Error("Tour ID is required");const{data:g,error:N}=await $.from("tours").select(`
          *,
          tour_dates (
            *,
            location:locations (*)
          )
        `).eq("id",s).maybeSingle();if(N)throw N;if(!g)throw new Error("Tour not found");const{data:j,error:b}=await $.from("jobs").select("id").eq("tour_id",s).eq("job_type","tour").maybeSingle();if(b)throw b;return{tour:g,tourJobId:(j==null?void 0:j.id)??null}},enabled:!!s}),a=d==null?void 0:d.tour,c=(d==null?void 0:d.tourJobId)??null;return r?e.jsx("div",{className:"container mx-auto p-3 md:p-6",children:e.jsx(W,{children:e.jsx(B,{className:"flex items-center justify-center py-8 md:py-12 px-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{className:"text-sm md:text-base",children:"Loading tour management..."})]})})})}):t||!a?e.jsx("div",{className:"container mx-auto p-3 md:p-6",children:e.jsx(W,{children:e.jsx(B,{className:"flex items-center justify-center py-8 md:py-12 px-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-lg md:text-xl font-semibold mb-2",children:"Tour Not Found"}),e.jsx("p",{className:"text-sm md:text-base text-muted-foreground",children:(t==null?void 0:t.message)||"The requested tour could not be found."})]})})})}):e.jsx(Aa,{tour:a,tourJobId:c})};export{An as TourManagementWrapper};
