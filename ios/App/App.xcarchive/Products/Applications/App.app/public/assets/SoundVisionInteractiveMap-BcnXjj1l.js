const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/maps-lib-Ce1ARJmz.js","assets/commonjs-helpers-Cpj98o6Y.js","assets/maps-lib-CtPDR2nd.css"])))=>i.map(i=>d[i]);
import{_ as we}from"./vite-preload-helper-ckwbz45p.js";import{f as Ne,n as z,m as _,r as m,j as e,Q as xe,D as Ae,q as Be,F as Oe,G as Ke,aK as Ie,ac as He,aL as We,B as q,a as X,V as Qe,a2 as Xe,P as Ge,R as Ye,I as Ze,S as J,t as ee,v as se,w as ae,x as T,X as Je,M as es,s as pe}from"./index-NZ6jJLfQ.js";import{u as ie}from"./useQuery-kdg2pmgf.js";import{S as je}from"./scroll-area-BHjMXddA.js";import{u as te}from"./useMutation-DluhVBs1.js";import{S as re}from"./star-icpn3ybK.js";import{B as ye}from"./badge-vNTKF5RD.js";import{f as ve}from"./formatDistanceToNow-Bbdi_GlK.js";import{e as ge}from"./es-CSiFCUGj.js";import{C as he}from"./circle-alert-LZYNzZ7F.js";import{A as ss}from"./arrow-left-VpQwT4cv.js";import{D as be}from"./download-C1rVE0-J.js";import{F as as}from"./filter-D0HnK7Nz.js";import{S as ts}from"./search-D-OiWg8h.js";import{U as rs}from"./user-E3OATBQk.js";import{C as ns}from"./calendar-_Cj_Sgy-.js";const is=(s,o)=>ie({queryKey:["soundvision-files",s],enabled:!0,queryFn:async()=>{const{error:v}=await _.rpc("assert_soundvision_access");if(v)throw v;const l=_.from("soundvision_files").select(`
          *,
          venue:venues(id, name, city, country, state_region, coordinates)
        `).order("uploaded_at",{ascending:!1}),{data:c,error:d}=await l;if(d)throw d;const{data:{user:g}}=await _.auth.getUser(),b=(g==null?void 0:g.id)??null,f=[...new Set(c.map(r=>r.uploaded_by))];let y=[];if(f.length>0){const{data:r}=await _.from("profiles").select("id, first_name, last_name").in("id",f);y=r||[]}const E=new Map(y.map(r=>[r.id,{first_name:r.first_name,last_name:r.last_name}]));let t=new Map,p=new Map;if(b&&c.length>0){const{data:r,error:n}=await _.from("soundvision_file_reviews").select("id, file_id, rating, review, is_initial, updated_at").eq("reviewer_id",b).in("file_id",c.map(j=>j.id));if(n)throw n;t=new Map((r||[]).map(j=>[j.file_id,{id:j.id,rating:j.rating,review:j.review,is_initial:j.is_initial,updated_at:j.updated_at}]));const{data:$,error:k}=await _.from("soundvision_file_downloads").select("file_id, downloaded_at").eq("profile_id",b).in("file_id",c.map(j=>j.id));if(k&&k.code!=="42P01")throw k;p=new Map(($||[]).map(j=>[j.file_id,j.downloaded_at]))}let i=c.map(r=>({...r,uploader:E.get(r.uploaded_by)||{first_name:"",last_name:""},hasReviewed:t.has(r.id),hasDownloaded:p.has(r.id),lastDownloadedAt:p.get(r.id)??null,current_user_review:t.get(r.id)||null}));if(s!=null&&s.searchTerm){const r=s.searchTerm.toLowerCase();i=i.filter(n=>{var $;return n.file_name.toLowerCase().includes(r)||(($=n.venue)==null?void 0:$.name.toLowerCase().includes(r))})}return s!=null&&s.city&&(i=i.filter(r=>{var n;return((n=r.venue)==null?void 0:n.city)===s.city})),s!=null&&s.country&&(i=i.filter(r=>{var n;return((n=r.venue)==null?void 0:n.country)===s.country})),s!=null&&s.stateRegion&&(i=i.filter(r=>{var n;return((n=r.venue)==null?void 0:n.state_region)===s.stateRegion})),s!=null&&s.fileType&&(i=i.filter(r=>r.file_type===s.fileType.replace(".",""))),i}}),os=()=>{const s=Ne();return te({mutationFn:async o=>{var t,p;const{data:{user:v}}=await _.auth.getUser();if(!v)throw new Error("Debes iniciar sesión para descargar este archivo.");const{data:l,error:c}=await _.storage.from("soundvision-files").download(o.file_path);if(c)throw c;const d=URL.createObjectURL(l),g=document.createElement("a");g.href=d,g.download=o.file_name,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(d);let b=null;const f=typeof navigator<"u"?navigator.userAgent:null,{error:y}=await _.from("soundvision_file_downloads").upsert({file_id:o.id,profile_id:v.id,downloaded_at:new Date().toISOString(),user_agent:f},{onConflict:"file_id,profile_id"});y&&(b=y);let E={success:!0};try{const u=((t=o.venue)==null?void 0:t.name)||((p=o.metadata)==null?void 0:p.venue_name)||null,{error:i}=await _.functions.invoke("push",{body:{action:"broadcast",type:"soundvision.file.downloaded",file_id:o.id,venue_id:o.venue_id,venue_name:u,url:"/soundvision-files"}});i&&(E={success:!1,error:i.message||"Error al enviar notificación"})}catch(u){E={success:!1,error:u instanceof Error?u.message:"Error desconocido al notificar"}}return{downloadRecordError:b,pushNotificationResult:E}},onSuccess:({downloadRecordError:o,pushNotificationResult:v})=>{s.invalidateQueries({queryKey:["soundvision-files"]});const l=!!o,c=!v.success;!l&&!c?z.success("Descarga iniciada correctamente."):l&&!c?z.warning("La descarga se realizó, pero no se pudo registrar el evento."):!l&&c?z.success("Descarga iniciada correctamente.",{description:"Sin embargo, no se pudo notificar a todos los usuarios."}):z.warning("La descarga se realizó, pero no se pudo registrar el evento ni notificar.")},onError:o=>{z.error("No se pudo descargar el archivo")}})},ls={sm:"h-4 w-4",md:"h-5 w-5",lg:"h-6 w-6"},ne=({value:s,onChange:o,readOnly:v=!1,size:l="md",className:c,label:d})=>{const g=m.useMemo(()=>[1,2,3,4,5],[]),b=f=>{v||!o||o(f)};return e.jsx("div",{className:xe("flex items-center gap-1",c),"aria-label":d??"Valoración",children:g.map(f=>{const y=s>=f;return e.jsxs("button",{type:"button",disabled:v,onClick:()=>b(f),className:xe("transition-colors disabled:cursor-default",v?"cursor-default":"cursor-pointer"),children:[e.jsx(re,{className:xe(ls[l],y?"fill-yellow-400 text-yellow-500":"text-muted-foreground"),"aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:`${f} estrella${f>1?"s":""}`})]},f)})})},cs=s=>{var f,y,E;const o=Ne(),v=(t,p)=>{if(t&&typeof t=="object"){const u=t,i=u.message??"";if(u.code&&["42501","P0001","23514"].includes(u.code)||i.toLowerCase().includes("soundvision_file_downloads")||i.toLowerCase().includes("row-level security"))return"Debes descargar el archivo antes de dejar una reseña."}return t instanceof Error&&t.message&&t.message.toLowerCase().includes("descarga el archivo")?t.message:p},l=ie({queryKey:["soundvision-file-reviews",s],enabled:!!s,queryFn:async()=>{if(!s)return{reviews:[],currentUserReview:null,userId:null};const{data:{user:t}}=await _.auth.getUser();if(!t)return{reviews:[],currentUserReview:null,userId:null};const{data:p,error:u}=await _.from("soundvision_file_reviews").select(`id, file_id, reviewer_id, rating, review, is_initial, created_at, updated_at,
          reviewer:profiles(id, first_name, last_name, role)`).eq("file_id",s).order("updated_at",{ascending:!1});if(u)throw u;const i=(p??[]).map(n=>({id:n.id,file_id:n.file_id,reviewer_id:n.reviewer_id,rating:n.rating,review:n.review,is_initial:n.is_initial,created_at:n.created_at,updated_at:n.updated_at,reviewer:n.reviewer??null})),r=i.find(n=>n.reviewer_id===t.id)??null;return{reviews:i,currentUserReview:r,userId:t.id}}}),c=t=>{t&&(o.invalidateQueries({queryKey:["soundvision-file-reviews",t]}),o.invalidateQueries({queryKey:["soundvision-files"]}))},d=te({mutationFn:async({rating:t,review:p})=>{if(!s)throw new Error("Archivo no válido");const{data:{user:u}}=await _.auth.getUser();if(!u)throw new Error("Usuario no autenticado");const{error:i}=await _.from("soundvision_file_reviews").insert({file_id:s,reviewer_id:u.id,rating:t,review:p??null});if(i)throw i},onSuccess:()=>{s&&c(s),z.success("Reseña guardada correctamente")},onError:t=>{z.error(v(t,"No se pudo guardar la reseña"))}}),g=te({mutationFn:async({reviewId:t,rating:p,review:u})=>{if(!s)throw new Error("Archivo no válido");const{error:i}=await _.from("soundvision_file_reviews").update({rating:p,review:u??null}).eq("id",t);if(i)throw i},onSuccess:()=>{s&&c(s),z.success("Reseña actualizada correctamente")},onError:t=>{z.error(v(t,"No se pudo actualizar la reseña"))}}),b=te({mutationFn:async t=>{if(!s)throw new Error("Archivo no válido");const{error:p}=await _.from("soundvision_file_reviews").delete().eq("id",t);if(p)throw p},onSuccess:()=>{s&&c(s),z.success("Reseña eliminada correctamente")},onError:t=>{z.error(t.message||"No se pudo eliminar la reseña")}});return{reviews:((f=l.data)==null?void 0:f.reviews)??[],currentUserReview:((y=l.data)==null?void 0:y.currentUserReview)??null,userId:((E=l.data)==null?void 0:E.userId)??null,isLoading:l.isLoading,isError:l.isError,createReview:d,updateReview:g,deleteReview:b,refetch:l.refetch,query:l}},ds=({file:s,open:o,onOpenChange:v,currentUserRole:l})=>{const{reviews:c,currentUserReview:d,userId:g,isLoading:b,createReview:f,updateReview:y,deleteReview:E}=cs(s.id),[t,p]=m.useState(0),[u,i]=m.useState(""),r=f.isPending||y.isPending,n=E.isPending,k=l==="admin"||l==="management"||s.hasDownloaded,j=!!d,B=!!g&&(j||k);m.useEffect(()=>{o&&(d?(p(d.rating),i(d.review??"")):(p(0),i("")))},[d,o]);const R=m.useMemo(()=>{const x=c.length,D=c.reduce((H,O)=>H+O.rating,0);return{count:x,average:x>0?D/x:null}},[c]),A=m.useMemo(()=>R.count>0&&R.average!==null?`${R.average.toFixed(1)} / 5 · ${R.count} ${R.count===1?"reseña":"reseñas"}`:s.ratings_count>0&&s.average_rating!==null?`${s.average_rating.toFixed(1)} / 5 · ${s.ratings_count} ${s.ratings_count===1?"reseña":"reseñas"}`:"Sin reseñas registradas",[s.average_rating,s.ratings_count,R]),K=async x=>{if(x.preventDefault(),!g){z.error("Debes iniciar sesión para dejar una reseña.");return}if(!k&&!j){z.error("Descarga el archivo antes de dejar una reseña.");return}if(t<1){z.error("Selecciona una valoración entre 1 y 5 estrellas.");return}const D={rating:t,review:u.trim()?u.trim():void 0};try{d?await y.mutateAsync({reviewId:d.id,rating:D.rating,review:D.review}):await f.mutateAsync(D)}catch{}},I=async()=>{if(d)try{await E.mutateAsync(d.id)}catch{}};return e.jsx(Ae,{open:o,onOpenChange:v,children:e.jsxs(Be,{className:"max-w-2xl",children:[e.jsxs(Oe,{children:[e.jsxs(Ke,{children:["Reseñas para ",s.file_name]}),e.jsx(Ie,{children:e.jsx("div",{className:"mt-2 flex flex-col gap-2",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ne,{value:R.average??s.average_rating??0,readOnly:!0}),e.jsx("span",{className:"text-muted-foreground",children:A})]})})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("form",{onSubmit:K,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-medium",children:"Tu valoración"}),d&&e.jsxs(ye,{variant:"secondary",children:["Última actualización ",ve(new Date(d.updated_at),{addSuffix:!0,locale:ge})]})]}),e.jsx(ne,{value:t,onChange:p,readOnly:!B||r||n,size:"lg"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",htmlFor:"soundvision-review-text",children:"Comentarios (opcional)"}),e.jsx(He,{id:"soundvision-review-text",placeholder:"Comparte detalles útiles sobre este archivo...",value:u,onChange:x=>i(x.target.value),disabled:!B||r||n,rows:4}),!g&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Inicia sesión para dejar una reseña."}),g&&!j&&!k&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Descarga el archivo para poder dejar una reseña."})]}),e.jsxs(We,{className:"flex items-center justify-between gap-4",children:[d?e.jsxs(q,{type:"button",variant:"ghost",onClick:I,disabled:n,className:"text-destructive",children:[n?e.jsx(X,{className:"h-4 w-4 animate-spin"}):e.jsx(Qe,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-2",children:"Eliminar reseña"})]}):e.jsx("span",{}),e.jsxs(q,{type:"submit",disabled:!B||r||n,children:[r?e.jsx(X,{className:"mr-2 h-4 w-4 animate-spin"}):null,d?"Actualizar reseña":"Publicar reseña"]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm font-medium",children:"Todas las reseñas"}),b?e.jsx("div",{className:"flex items-center justify-center py-6",children:e.jsx(X,{className:"h-6 w-6 animate-spin text-primary"})}):c.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Todavía no hay reseñas para este archivo."}):e.jsx("div",{className:"space-y-3 max-h-80 overflow-y-auto pr-1",children:c.map(x=>e.jsxs("div",{className:"rounded-lg border p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:x.reviewer&&`${x.reviewer.first_name??""} ${x.reviewer.last_name??""}`.trim()||"Usuario"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:ve(new Date(x.updated_at),{addSuffix:!0,locale:ge})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{value:x.rating,readOnly:!0,size:"sm"}),x.is_initial&&e.jsx(ye,{variant:"outline",children:"Inicial"})]})]}),x.review&&e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-line",children:x.review})]},x.id))})]})]})]})})},us=s=>ie({queryKey:["venues",s],queryFn:async()=>{let o=_.from("venues").select("*").order("name");const{data:v,error:l}=await o;if(l)throw l;return v}}),Ms=({theme:s,isDark:o,onClose:v})=>{const[l,c]=m.useState("half"),[d,g]=m.useState(""),[b,f]=m.useState(""),[y,E]=m.useState(""),[t,p]=m.useState(""),[u,i]=m.useState(""),[r,n]=m.useState(!1),[$,k]=m.useState(null),[j,B]=m.useState(!1),[R,A]=m.useState(null),K=m.useRef(null),I=m.useRef(null),x=m.useRef(null),D=m.useRef([]),[H,O]=m.useState(!0),[oe,le]=m.useState(null),[fe,_e]=m.useState(!1),{data:F}=ie({queryKey:["current-user-profile"],queryFn:async()=>{const{data:{user:a}}=await pe.auth.getUser();if(!a)return null;const{data:C}=await pe.from("profiles").select("role").eq("id",a.id).single();return C}}),{data:P=[],isLoading:Se,refetch:Re}=is({searchTerm:d||void 0,city:b&&b!=="all"?b:void 0,country:y&&y!=="all"?y:void 0,stateRegion:t&&t!=="all"?t:void 0,fileType:u&&u!=="all"?u:void 0}),ce=os(),{data:U}=us(),Ce=[...new Set(U==null?void 0:U.map(a=>a.city).filter(Boolean))].sort(),Me=[...new Set(U==null?void 0:U.map(a=>a.country).filter(Boolean))].sort(),Ee=[...new Set(U==null?void 0:U.map(a=>a.state_region).filter(Boolean))].sort(),ze=b||y||t||u||d,$e=(F==null?void 0:F.role)==="admin"||(F==null?void 0:F.role)==="management",G=a=>$e||a.hasDownloaded||a.hasReviewed,ke=()=>{g(""),f(""),E(""),p(""),i("")},De=async()=>{B(!0);try{await Re()}finally{setTimeout(()=>B(!1),500)}};m.useEffect(()=>{const a=()=>A(null);return window.addEventListener("click",a),window.addEventListener("resize",a),()=>{window.removeEventListener("click",a),window.removeEventListener("resize",a)}},[]),m.useEffect(()=>{if(!$)return;const a=P.find(C=>C.id===$.id);a&&a!==$&&k(a)},[P,$]),m.useEffect(()=>{if(!K.current||x.current)return;let a=!0;return(async()=>{try{O(!0),le(null);const{data:S,error:L}=await pe.functions.invoke("get-mapbox-token");if(L)throw new Error(`Error al obtener el token de Mapbox: ${L.message}`);if(!(S!=null&&S.token))throw new Error("No se encontró el token de Mapbox en la respuesta");const[{default:h}]=await Promise.all([we(()=>import("./maps-lib-Ce1ARJmz.js").then(M=>M.m),__vite__mapDeps([0,1,2])),we(()=>import("./maps-lib-Ce1ARJmz.js").then(M=>M.a),__vite__mapDeps([0,1,2]))]);if(!a)return;I.current=h,h.accessToken=S.token;const N=new h.Map({container:K.current,style:"mapbox://styles/mapbox/dark-v11",center:[0,20],zoom:1.5,projection:"globe"});x.current=N,N.addControl(new h.NavigationControl({visualizePitch:!0}),"top-right"),N.on("style.load",()=>{N.setFog({color:"rgb(10, 10, 20)","high-color":"rgb(30, 30, 50)","horizon-blend":.1})}),N.on("load",()=>{a&&(O(!1),_e(!0),N.resize())}),N.on("movestart",()=>A(null)),N.on("click",()=>A(null)),N.on("error",M=>{a&&(le("No se pudieron cargar los datos del mapa."),O(!1))})}catch{if(!a)return;le("No se pudo cargar el mapa. Revisa tu conexión."),O(!1)}})(),()=>{var S;a=!1,D.current.forEach(L=>L.remove()),D.current=[],(S=x.current)==null||S.remove(),x.current=null,I.current=null}},[]),m.useEffect(()=>{if(!fe||!x.current)return;const a=new Map,C=new Map;P.forEach(h=>{var Q;if(!((Q=h.venue)!=null&&Q.coordinates))return;const{lat:N,lng:M}=h.venue.coordinates,V=`${N.toFixed(6)},${M.toFixed(6)}`;C.has(V)||C.set(V,[]),C.get(V).push(h);const Y=h.ratings_count??0,W=h.rating_total??0;if(!a.has(V))a.set(V,{venue:h.venue,fileCount:1,ratingsCount:Y,ratingTotal:W});else{const w=a.get(V);w.fileCount++,w.ratingsCount+=Y,w.ratingTotal+=W}}),D.current.forEach(h=>h.remove()),D.current=[];const S=I.current;if(!S)return;const L=new S.LngLatBounds;a.forEach(({venue:h,fileCount:N,ratingsCount:M,ratingTotal:V},Y)=>{if(!h.coordinates)return;const{lat:W,lng:Q}=h.coordinates;L.extend([Q,W]);const w=document.createElement("div");w.className="custom-marker",w.style.width="28px",w.style.height="28px",w.style.borderRadius="50%",w.style.backgroundColor="hsl(217, 91%, 60%)",w.style.border="3px solid white",w.style.cursor="pointer",w.style.boxShadow="0 2px 8px rgba(0,0,0,0.4)",w.style.display="flex",w.style.alignItems="center",w.style.justifyContent="center",w.style.color="white",w.style.fontSize="11px",w.style.fontWeight="bold",w.innerHTML=`${N}`,w.addEventListener("contextmenu",Z=>{Z.preventDefault(),Z.stopPropagation();const Ve=C.get(Y)||[];A({x:Z.clientX,y:Z.clientY,venueName:h.name,files:Ve})});const me=M>0?V/M:null,Fe=M>0?`<p style="font-size: 0.8rem; color: #888; margin-top: 6px;">Valoración: <strong>${me==null?void 0:me.toFixed(1)}</strong> ⭐ (${M} ${M===1?"reseña":"reseñas"})</p>`:'<p style="font-size: 0.8rem; color: #888; margin-top: 6px;">Sin reseñas</p>',Ue=`
        <div style="padding: 8px; min-width: 180px; color: #fff; background: #1a1a2e; border-radius: 8px;">
          <h3 style="font-weight: bold; margin-bottom: 4px; font-size: 0.95rem;">${h.name}</h3>
          <p style="font-size: 0.8rem; color: #888; margin-bottom: 8px;">
            ${[h.city,h.state_region,h.country].filter(Boolean).join(", ")}
          </p>
          <p style="font-size: 0.8rem; color: #888;">
            <strong>${N}</strong> ${N===1?"archivo":"archivos"}
          </p>
          ${Fe}
          <p style="font-size: 0.7rem; color: #666; margin-top: 8px; font-style: italic;">
            Click derecho para opciones
          </p>
        </div>
      `,qe=new S.Popup({offset:25,closeButton:!0,closeOnClick:!1,className:"soundvision-popup"}).setHTML(Ue),Pe=new S.Marker(w).setLngLat([Q,W]).setPopup(qe).addTo(x.current);D.current.push(Pe)}),!L.isEmpty()&&a.size>0&&x.current.fitBounds(L,{padding:80,maxZoom:12,duration:800})},[P,fe]);const de=P.filter(a=>{var C;return(C=a.venue)==null?void 0:C.coordinates}),ue=P.length-de.length,Le=()=>{switch(l){case"collapsed":return{height:"80px"};case"half":return{height:"55%"};case"full":return{height:"calc(100% - 60px)"}}},Te=()=>{c(l==="collapsed"?"half":l==="half"?"full":"collapsed")};return e.jsxs("div",{className:"relative w-full h-full bg-black overflow-hidden",children:[e.jsxs("div",{className:"absolute inset-0",children:[H&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80 z-10",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx(X,{className:"h-8 w-8 animate-spin text-blue-500"}),e.jsx("span",{className:"text-sm text-gray-400",children:"Cargando mapa..."})]})}),oe&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80 z-10",children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx(he,{className:"h-10 w-10 text-red-500 mx-auto mb-3"}),e.jsx("p",{className:"text-red-400 font-medium mb-2",children:"Error del mapa"}),e.jsx("p",{className:"text-sm text-gray-500",children:oe})]})}),e.jsx("div",{ref:K,className:"h-full w-full"}),v&&e.jsx("button",{type:"button",onClick:v,"aria-label":"Volver",className:"absolute top-6 left-6 z-20 p-3 bg-black/60 text-white rounded-full backdrop-blur-md border border-white/10 hover:bg-black/80 transition-colors",children:e.jsx(ss,{size:20})}),!H&&!oe&&e.jsx("div",{className:"absolute top-6 right-6 z-20 px-4 py-2 bg-black/60 backdrop-blur-md rounded-full border border-white/10",children:e.jsxs("span",{className:"text-white text-sm font-medium",children:[de.length," ",de.length===1?"ubicación":"ubicaciones"]})})]}),R&&e.jsxs("div",{className:`fixed z-50 min-w-[280px] max-w-[320px] rounded-lg shadow-xl overflow-hidden border ${s.divider} ${o?"bg-[#1a1a2e]":"bg-white"}`,style:{left:Math.min(R.x,window.innerWidth-320),top:Math.min(R.y,window.innerHeight-(R.files.length*60+50))},onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:`p-3 border-b ${s.divider} ${o?"bg-black/20":"bg-slate-50"}`,children:[e.jsx("h3",{className:`font-semibold text-sm ${s.textMain}`,children:R.venueName}),e.jsxs("p",{className:`text-xs ${s.textMuted}`,children:[R.files.length," archivos disponibles"]})]}),e.jsx(je,{className:"max-h-[300px]",children:e.jsx("div",{className:"p-1",children:R.files.map(a=>e.jsxs("div",{className:`p-2 hover:${o?"bg-white/5":"bg-slate-50"} rounded flex items-center justify-between gap-3 group transition-colors`,children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:`text-sm font-medium truncate ${s.textMain}`,children:a.file_name}),e.jsxs("div",{className:"flex items-center gap-1 mt-0.5",children:[e.jsx(re,{size:10,className:a.average_rating?"text-yellow-500 fill-yellow-500":s.textMuted}),e.jsx("span",{className:`text-xs ${s.textMuted}`,children:a.average_rating?a.average_rating.toFixed(1):"-"})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(q,{size:"icon",variant:"ghost",className:"h-8 w-8 text-blue-500 hover:text-blue-400 hover:bg-blue-500/10",onClick:()=>ce.mutate(a),title:"Descargar",children:e.jsx(be,{size:14})}),e.jsx(q,{size:"icon",variant:"ghost",className:`h-8 w-8 ${a.hasReviewed?"text-yellow-500 hover:text-yellow-400":s.textMuted} hover:bg-yellow-500/10`,onClick:()=>{k(a),A(null)},disabled:!G(a),title:G(a)?"Reseñas":"Descarga para reseñar",children:e.jsx(re,{size:14})})]})]},a.id))})})]}),e.jsxs("div",{className:`absolute bottom-0 w-full ${o?"bg-[#0f1219]":"bg-white"} border-t ${s.divider} rounded-t-3xl shadow-2xl flex flex-col transition-all duration-500 z-30`,style:Le(),children:[e.jsx("div",{onClick:Te,className:"w-full h-8 flex items-center justify-center cursor-pointer shrink-0",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-12 h-1.5 rounded-full ${o?"bg-gray-600":"bg-slate-300"}`}),l==="collapsed"?e.jsx(Xe,{size:16,className:s.textMuted}):l==="full"?e.jsx(Ge,{size:16,className:s.textMuted}):null]})}),e.jsxs("div",{className:`px-4 pb-3 border-b ${s.divider} shrink-0`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:`text-xl font-bold ${s.textMain}`,children:"SoundVision DB"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{variant:"ghost",size:"sm",onClick:()=>n(!r),className:r?"bg-blue-500/20 text-blue-400":"",children:e.jsx(as,{size:16})}),e.jsx(q,{variant:"ghost",size:"sm",onClick:De,disabled:j,children:e.jsx(Ye,{size:16,className:j?"animate-spin":""})})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ts,{className:`absolute left-3 top-3 ${s.textMuted}`,size:16}),e.jsx(Ze,{type:"text",placeholder:"Buscar recinto o archivo...",value:d,onChange:a=>g(a.target.value),className:`w-full rounded-xl py-3 pl-10 pr-4 text-sm ${s.input} h-11`})]}),r&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs(J,{value:u,onValueChange:i,children:[e.jsx(ee,{className:`text-xs ${s.input}`,children:e.jsx(se,{placeholder:"Tipo"})}),e.jsxs(ae,{children:[e.jsx(T,{value:"all",children:"Todos los tipos"}),e.jsx(T,{value:".xmlp",children:".xmlp (Proyecto)"}),e.jsx(T,{value:".xmls",children:".xmls (Escena)"}),e.jsx(T,{value:".xmlc",children:".xmlc (Config)"})]})]}),e.jsxs(J,{value:b,onValueChange:f,children:[e.jsx(ee,{className:`text-xs ${s.input}`,children:e.jsx(se,{placeholder:"Ciudad"})}),e.jsxs(ae,{children:[e.jsx(T,{value:"all",children:"Todas las ciudades"}),Ce.map(a=>e.jsx(T,{value:a,children:a},a))]})]}),e.jsxs(J,{value:y,onValueChange:E,children:[e.jsx(ee,{className:`text-xs ${s.input}`,children:e.jsx(se,{placeholder:"País"})}),e.jsxs(ae,{children:[e.jsx(T,{value:"all",children:"Todos los países"}),Me.map(a=>e.jsx(T,{value:a,children:a},a))]})]}),e.jsxs(J,{value:t,onValueChange:p,children:[e.jsx(ee,{className:`text-xs ${s.input}`,children:e.jsx(se,{placeholder:"Región"})}),e.jsxs(ae,{children:[e.jsx(T,{value:"all",children:"Todas las regiones"}),Ee.map(a=>e.jsx(T,{value:a,children:a},a))]})]})]}),ze&&e.jsxs(q,{variant:"ghost",size:"sm",onClick:ke,className:"w-full text-xs",children:[e.jsx(Je,{size:14,className:"mr-1"}),"Limpiar filtros"]})]}),ue>0&&e.jsxs("div",{className:`mt-2 flex items-center gap-2 text-xs ${s.textMuted}`,children:[e.jsx(he,{size:12}),e.jsxs("span",{children:[ue," ",ue===1?"archivo sin":"archivos sin"," coordenadas"]})]})]}),e.jsx(je,{className:"flex-1 p-4",children:Se?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(X,{className:"h-6 w-6 animate-spin text-blue-500"})}):P.length===0?e.jsxs("div",{className:`text-center py-8 ${s.textMuted}`,children:[e.jsx("p",{className:"text-lg mb-2",children:"No se encontraron archivos"}),e.jsx("p",{className:"text-sm",children:"Intenta ajustar los filtros"})]}):e.jsx("div",{className:"space-y-3",children:P.map(a=>{var C,S,L,h,N,M;return e.jsxs("div",{className:`p-4 rounded-2xl border ${s.divider} ${o?"bg-white/5":"bg-slate-50"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-3 mb-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:`font-semibold truncate ${s.textMain}`,children:((C=a.venue)==null?void 0:C.name)||"Sin recinto"}),!((S=a.venue)!=null&&S.coordinates)&&e.jsx(he,{size:14,className:s.textMuted})]}),e.jsx("p",{className:`text-xs mt-1 truncate ${s.textMuted}`,children:a.file_name})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[e.jsx(ne,{value:a.average_rating??0,readOnly:!0,size:"sm"}),a.ratings_count>0&&e.jsxs("span",{className:`text-xs ${s.textMuted}`,children:["(",a.ratings_count,")"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[e.jsxs("div",{className:`flex items-center gap-2 text-xs ${s.textMuted}`,children:[e.jsx(es,{size:12}),e.jsxs("span",{className:"truncate",children:[(L=a.venue)==null?void 0:L.city,", ",(h=a.venue)==null?void 0:h.country]})]}),e.jsxs("div",{className:`flex items-center gap-2 text-xs ${s.textMuted}`,children:[e.jsx(rs,{size:12}),e.jsxs("span",{className:"truncate",children:[(N=a.uploader)==null?void 0:N.first_name," ",(M=a.uploader)==null?void 0:M.last_name]})]}),e.jsxs("div",{className:`flex items-center gap-2 text-xs ${s.textMuted} col-span-2`,children:[e.jsx(ns,{size:12}),e.jsx("span",{children:ve(new Date(a.uploaded_at),{addSuffix:!0,locale:ge})})]})]}),a.hasReviewed&&a.current_user_review&&e.jsxs("div",{className:"mb-3 text-xs text-emerald-500 font-medium",children:["Tu valoración: ",a.current_user_review.rating," ⭐"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(q,{size:"sm",variant:a.hasReviewed?"secondary":"outline",onClick:()=>k(a),disabled:!G(a),className:"flex-1 text-xs",children:[e.jsx(re,{size:14,className:"mr-1"}),"Reseñas"]}),e.jsxs(q,{size:"sm",variant:"outline",onClick:()=>ce.mutate(a),disabled:ce.isPending,className:"flex-1 text-xs",children:[e.jsx(be,{size:14,className:"mr-1"}),"Descargar"]})]}),!G(a)&&e.jsx("p",{className:`mt-2 text-xs ${s.textMuted}`,children:"Descarga el archivo para dejar una reseña"})]},a.id)})})})]}),$&&e.jsx(ds,{file:$,open:!!$,onOpenChange:a=>{a||k(null)},currentUserRole:(F==null?void 0:F.role)??null}),e.jsx("style",{children:`
        .soundvision-popup .mapboxgl-popup-content {
          background: transparent;
          padding: 0;
          box-shadow: none;
        }
        .soundvision-popup .mapboxgl-popup-close-button {
          color: white;
          font-size: 18px;
          right: 8px;
          top: 4px;
        }
        .soundvision-popup .mapboxgl-popup-tip {
          border-top-color: #1a1a2e;
        }
      `})]})};export{Ms as S};
