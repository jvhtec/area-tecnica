import{u as k,e as S,r as p,j as e,L as n,I as l,S as U,t as A,v as E,w as O,x as c,B as x,a as b,s as F}from"./index-NZ6jJLfQ.js";import{A as P,a as D}from"./alert-BqA-5jRM.js";import{C as L}from"./checkbox-BsRNEGV1.js";import{A as q}from"./arrow-left-VpQwT4cv.js";const z=({onBack:u,preventAutoLogin:d=!1})=>{const{signUp:w,createUserAsAdmin:C,isLoading:f,error:j}=k(),{toast:h}=S(),[g,m]=p.useState(null),[a,t]=p.useState({email:"",password:"",confirmPassword:"",firstName:"",nickname:"",lastName:"",phone:"",department:"",dni:"",residencia:"",flexResourceId:"",flexUrl:""}),[N,v]=p.useState(!1),[y,I]=p.useState(!0),R=async s=>{if(s.preventDefault(),m(null),!a.email||!a.firstName||!a.lastName){m("Por favor rellena todos los campos obligatorios");return}if(!d&&!a.password){m("La contraseña es obligatoria");return}if(!d&&a.password.length<6){m("La contraseña debe tener al menos 6 caracteres");return}if(!d&&a.password!==a.confirmPassword){m("Las contraseñas no coinciden");return}if(d){if(await C({email:a.email,firstName:a.firstName,nickname:a.nickname,lastName:a.lastName,phone:a.phone,department:a.department,dni:a.dni,residencia:a.residencia,flex_resource_id:a.flexResourceId||void 0})&&y)try{const{data:r,error:i}=await F.functions.invoke("send-onboarding-email",{body:{email:a.email,firstName:a.firstName,lastName:a.lastName,department:a.department}});if(i)throw i;if(!(r!=null&&r.success))throw new Error("Failed to send onboarding email");h({title:"Onboarding enviado",description:`Se envió el email a ${a.email}.`})}catch(r){h({title:"No se pudo enviar el onboarding",description:(r==null?void 0:r.message)||"Error desconocido",variant:"destructive"})}return}else await w({email:a.email,password:a.password,firstName:a.firstName,nickname:a.nickname,lastName:a.lastName,phone:a.phone,department:a.department,dni:a.dni,residencia:a.residencia})};return e.jsxs("form",{onSubmit:R,className:"space-y-4",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Crear Cuenta"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Rellena tus datos para comenzar"})]}),(g||j)&&e.jsx(P,{variant:"destructive",children:e.jsx(D,{children:g||j})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"firstName",children:"Nombre *"}),e.jsx(l,{id:"firstName",type:"text",value:a.firstName,onChange:s=>t({...a,firstName:s.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"nickname",children:"Apodo"}),e.jsx(l,{id:"nickname",type:"text",value:a.nickname,onChange:s=>t({...a,nickname:s.target.value}),placeholder:"Opcional"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"lastName",children:"Apellidos *"}),e.jsx(l,{id:"lastName",type:"text",value:a.lastName,onChange:s=>t({...a,lastName:s.target.value}),required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"signup-email",children:"Correo *"}),e.jsx(l,{id:"signup-email",type:"email",value:a.email,onChange:s=>t({...a,email:s.target.value}),required:!0})]}),!d&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"signup-password",children:"Contraseña *"}),e.jsx(l,{id:"signup-password",type:"password",value:a.password,onChange:s=>t({...a,password:s.target.value}),required:!0,minLength:6})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"confirmPassword",children:"Confirmar Contraseña *"}),e.jsx(l,{id:"confirmPassword",type:"password",value:a.confirmPassword,onChange:s=>t({...a,confirmPassword:s.target.value}),required:!0,minLength:6})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"phone",children:"Teléfono"}),e.jsx(l,{id:"phone",type:"tel",value:a.phone,onChange:s=>t({...a,phone:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"department",children:"Departamento"}),e.jsxs(U,{value:a.department,onValueChange:s=>t({...a,department:s}),children:[e.jsx(A,{children:e.jsx(E,{placeholder:"Seleccionar departamento"})}),e.jsxs(O,{children:[e.jsx(c,{value:"sound",children:"Sonido"}),e.jsx(c,{value:"lights",children:"Iluminación"}),e.jsx(c,{value:"video",children:"Video"}),e.jsx(c,{value:"production",children:"Producción"}),e.jsx(c,{value:"logistics",children:"Logística"}),e.jsx(c,{value:"management",children:"Gestión"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"dni",children:"DNI"}),e.jsx(l,{id:"dni",type:"text",value:a.dni,onChange:s=>t({...a,dni:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"residencia",children:"Residencia"}),e.jsx(l,{id:"residencia",type:"text",value:a.residencia,onChange:s=>t({...a,residencia:s.target.value})})]})]}),d&&e.jsxs("div",{className:"space-y-3 border rounded-md p-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"flexResourceId",children:"ID de Recurso Flex (opcional)"}),e.jsx(l,{id:"flexResourceId",type:"text",placeholder:"4b0d98e0-e700-11ea-97d0-2a0a4490a7fb",value:a.flexResourceId,onChange:s=>t({...a,flexResourceId:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"flexUrl",children:"URL de Contacto Flex (pegar y extraer)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(l,{id:"flexUrl",type:"text",placeholder:"https://sectorpro.flexrentalsolutions.com/f5/ui/?desktop#contact/UUID/phone",value:a.flexUrl,onChange:s=>t({...a,flexUrl:s.target.value})}),e.jsx(x,{type:"button",variant:"secondary",onClick:()=>{var r;const s=/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}/,o=(r=(a.flexUrl||"").match(s))==null?void 0:r[0];o&&t({...a,flexResourceId:o})},children:"Extraer"}),e.jsx(x,{type:"button",variant:"outline",onClick:async()=>{var s;try{const o=await navigator.clipboard.readText(),r=/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}/,i=(s=(o||"").match(r))==null?void 0:s[0];t({...a,flexUrl:o,flexResourceId:i||a.flexResourceId})}catch{}},children:"Pegar URL"}),e.jsx(x,{type:"button",variant:"default",disabled:N||!(a.flexResourceId||a.flexUrl),onClick:async()=>{try{v(!0);const{data:s,error:o}=await F.functions.invoke("fetch-flex-contact-info",{body:a.flexResourceId?{contact_id:a.flexResourceId}:{url:a.flexUrl}});if(o)throw o;if(s!=null&&s.error)throw new Error(s.error);const r=(s==null?void 0:s.mapped)||{};t(i=>({...i,firstName:r.firstName||i.firstName,lastName:r.lastName||i.lastName,email:r.email||i.email,phone:r.phone||i.phone,residencia:r.residencia||i.residencia,dni:r.dni||i.dni,department:r.department||i.department,flexResourceId:(s==null?void 0:s.contact_id)||i.flexResourceId})),h({title:"Obtenido de Flex",description:"Los campos se han autocompletado."})}catch(s){h({title:"Fallo al obtener de Flex",description:(s==null?void 0:s.message)||"Error desconocido",variant:"destructive"})}finally{v(!1)}},children:N?e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"mr-2 h-4 w-4 animate-spin"}),"Obteniendo…"]}):"Obtener de Flex"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ejemplo: https://sectorpro.flexrentalsolutions.com/f5/ui/?desktop#contact/4b0d98e0-e700-11ea-97d0-2a0a4490a7fb/phone"})]}),e.jsxs("div",{className:"flex items-center gap-2 pt-1",children:[e.jsx(L,{id:"sendOnboarding",checked:y,onCheckedChange:s=>I(!!s)}),e.jsx(n,{htmlFor:"sendOnboarding",children:"Enviar email de bienvenida (onboarding)"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-4",children:[e.jsx(x,{type:"submit",disabled:f,children:f?e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"mr-2 h-4 w-4 animate-spin"}),"Creando Cuenta..."]}):d?"Crear Usuario":"Crear Cuenta"}),u&&e.jsxs(x,{type:"button",variant:"ghost",onClick:u,children:[e.jsx(q,{className:"mr-2 h-4 w-4"}),"Volver al Inicio de Sesión"]})]})]})};export{z as S};
