import{u as b,j as r,N as x,f as j,aN as E,r as s,bY as N,bX as L,ca as I,n as v,ch as T,cb as A,c7 as M,ci as F,cj as O,bm as D,c as P,a4 as q}from"./index-NZ6jJLfQ.js";import{u as B}from"./useEnhancedRouteSubscriptions-B8NTEQXv.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./formatDistanceToNow-Bbdi_GlK.js";import"./constructNow-u0VlpghF.js";import"./differenceInCalendarMonths-6exvViir.js";import"./endOfMonth-Byhxb84j.js";const Q=({children:e})=>{const{session:a,isLoading:t}=b();return t?r.jsx("div",{className:"min-h-screen flex items-center justify-center",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-white"})}):a?r.jsx(r.Fragment,{children:e}):r.jsx(x,{to:"/auth",replace:!0})},R=(e,a=1e3,t=3e4)=>Math.min(a*Math.pow(2,e),t);function V(){const e=j(),a=E(),t=s.useMemo(()=>N.getInstance(e),[e]),o=s.useMemo(()=>L.getInstance(e),[e]),m=s.useRef(0),f=s.useRef(0),[i,S]=s.useState(()=>t.getIsLeader());s.useEffect(()=>{const c=n=>{const l=n.detail.isLeader;S(l),T(e,l)};return window.addEventListener("tab-leader-elected",c),()=>{window.removeEventListener("tab-leader-elected",c)}},[e]),s.useEffect(()=>{if(!i)return;const c=I.getInstance();let n=null;const l=async()=>{if(!i)return;const d=Date.now();if(!(d-m.current<3e4)){m.current=d;try{const p=M(),y=await F();if(p==="DISCONNECTED"&&y){f.current+=1;const k=R(f.current-1);await new Promise(g=>setTimeout(g,k)),o.reestablishSubscriptions(),c.getSession(!0).catch(g=>{})}else p==="CONNECTED"&&(f.current=0)}catch{}}},C=()=>{n||(n=window.setInterval(()=>{l().catch(d=>{})},6e4))},w=()=>{n&&(clearInterval(n),n=null)},h=()=>{if(document.hidden){w();return}l().catch(d=>{}),C()};return document.addEventListener("visibilitychange",h,{passive:!0}),h(),()=>{w(),document.removeEventListener("visibilitychange",h)}},[i,o]),s.useEffect(()=>{if(i){o.setupVisibilityBasedRefetching(),o.setupNetworkStatusRefetching();return}o.teardownVisibilityBasedRefetching(),o.teardownNetworkStatusRefetching()},[i,o]);const u=B();return s.useEffect(()=>{u.isStale&&i&&(u.forceRefresh(),v.info("Refreshing stale data...",{description:"Your connection was inactive for a while, updating now"}))},[u.isStale,i]),s.useEffect(()=>{if(!u.isFullySubscribed&&i){const c=n=>{if(n>3)return;const l=R(n);setTimeout(()=>{u.unsubscribedTables.length>0&&(u.forceRefresh(),c(n+1))},l)};c(0)}else i||u.unsubscribedTables.length>0&&t.requestSubscriptions(u.unsubscribedTables)},[a.pathname,u,i,t]),s.useEffect(()=>{const c=()=>{i&&A().then(n=>{n&&(t.invalidateQueries(),v.success("Connection restored",{description:"Network is back online, refreshing data"}))})};return window.addEventListener("online",c),()=>{window.removeEventListener("online",c)}},[i,t]),null}function W(){return r.jsx(V,{})}function Y(){const{userRole:e}=b(),a=!1;s.useRef(new Set),s.useEffect(()=>{},[a,e])}function z(){return Y(),null}function G(){const{userRole:e,isLoading:a}=b(),t=E(),o=P();return q.useEffect(()=>{a||e==="technician"&&(t.pathname==="/tech-app"||t.pathname==="/auth"||t.pathname.startsWith("/auth")||o("/tech-app",{replace:!0}))},[e,a,t.pathname,o]),null}function ee(){return r.jsx(Q,{children:r.jsxs(O,{children:[r.jsx(W,{}),r.jsx(z,{}),r.jsx(G,{}),r.jsx(D,{})]})})}export{ee as default};
