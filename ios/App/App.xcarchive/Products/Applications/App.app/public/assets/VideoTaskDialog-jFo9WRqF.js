import{u as L}from"./useQuery-kdg2pmgf.js";import{s as i,a9 as Fe,f as ne,r as x,b$ as Pe,c0 as Ue,e as de,j as e,D as ue,q as me,F as he,G as ge,L as B,I as J,S as I,t as ee,v as se,w as te,x as M,B as V,V as fe,X as Ae}from"./index-NZ6jJLfQ.js";import{u as Re}from"./useJobRequiredRoles-Bz0ibKHS.js";import{r as $e}from"./useWeatherData-d0TEdKFc.js";import{c as pe}from"./icon-D8sTZPYx.js";import{P as ae}from"./progress-C8XsV-Me.js";import{T as xe,a as _e,b as re,c as C,d as we,e as S}from"./table-DnQAmABX.js";import{T as ve}from"./lazyXlsx-BrFBF17_.js";import{D as ye}from"./download-C1rVE0-J.js";import{U as je}from"./upload-DF4rjO7T.js";import{u as Oe}from"./useMutation-DluhVBs1.js";const Ie=(t,D)=>L({queryKey:["folder-existence",t],queryFn:async()=>{let y=i.from("flex_folders").select("id").limit(1);D?y=y.or(`job_id.eq.${t},tour_date_id.eq.${D}`):y=y.eq("job_id",t);const{data:g,error:E}=await y;if(E)throw E;return g&&g.length>0},enabled:!!t,staleTime:1e3*60*10,gcTime:1e3*60*30,refetchOnMount:!1,refetchOnWindowFocus:!1,retry:1}),es=(t,D,y,g,E,F,q)=>{const{theme:R}=Fe(),j=ne(),$=(q==null?void 0:q.enableRoleSummary)??!0,n=(q==null?void 0:q.enableSoundTasks)??!0,{appliedBorderColor:G,appliedBgColor:K}=x.useMemo(()=>{const m=R==="dark",f=t.color||"#7E69AB",k=m&&t.darkColor||f,p=t.color?`${t.color}05`:"#7E69AB05",T=m&&t.darkColor?`${t.darkColor}15`:p;return{appliedBorderColor:k,appliedBgColor:T}},[t.color,t.darkColor,R]),[Q,U]=x.useState(!0),[P,W]=x.useState(t.job_assignments||[]),[a,s]=x.useState(t.job_documents||[]),[c,d]=x.useState(!1),[r,u]=x.useState(!1),[Y,oe]=x.useState(!1),[le,o]=x.useState(!1),[l,w]=x.useState(!1);x.useEffect(()=>{s(t.job_documents||[])},[t.job_documents]);const N=m=>Array.isArray(m)?m[0]:m,h=x.useCallback(async()=>{if(t!=null&&t.id)try{const m=Array.isArray(t==null?void 0:t.job_assignments)?t.job_assignments:[],{data:f,error:k}=await i.from("timesheets").select(`
          technician_id,
          date,
          profiles!fk_timesheets_technician_id (first_name, nickname, last_name, department)
        `).eq("job_id",t.id).eq("is_active",!0);let p=[];try{const{data:v,error:H}=await i.rpc("get_timesheet_amounts_visible").eq("job_id",t.id);!H&&Array.isArray(v)&&(p=v)}catch{}const T=new Map,O=new Map,z=v=>{if(!(v!=null&&v.technician_id)||!(v!=null&&v.date))return;const H=T.get(v.technician_id)||[];H.push(v.date),T.set(v.technician_id,H),v.profiles&&O.set(v.technician_id,N(v.profiles))};(f||[]).forEach(z),p.forEach(z);const _=new Map;T.forEach((v,H)=>{const Ee=Array.from(new Set(v)).sort();_.set(H,Ee)});const A=(m||[]).map(v=>({...v,profiles:N(v.profiles),_timesheet_dates:_.get(v.technician_id)||[]})),De=new Set((m||[]).map(v=>v.technician_id));_.forEach((v,H)=>{De.has(H)||A.push({job_id:t.id,technician_id:H,profiles:O.get(H)||null,sound_role:null,lights_role:null,video_role:null,status:null,single_day:null,assignment_date:null,assigned_at:null,_timesheet_dates:v})}),W(A)}catch{}},[t==null?void 0:t.id,t==null?void 0:t.job_assignments]);x.useEffect(()=>{W(t.job_assignments||[])},[t.job_assignments]);const b=l||!Q;x.useEffect(()=>{b&&h()},[h,b]),x.useEffect(()=>{if(!(t!=null&&t.id)||!b)return;const m=i.channel(`job-card-timesheets-${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"timesheets",filter:`job_id=eq.${t.id}`},async()=>{await h()}).subscribe(),f=()=>{h()};return window.addEventListener("assignment-updated",f),()=>{window.removeEventListener("assignment-updated",f),i.removeChannel(m)}},[t==null?void 0:t.id,h,b]);const X=x.useMemo(()=>{const m=y==="house_tech",f=["admin","management","logistics"].includes(y||""),k=["admin","management","logistics","technician","house_tech"].includes(y||""),p=["admin","management","logistics"].includes(y||""),T=["admin","management","logistics"].includes(y||"");return{isHouseTech:m,canEditJobs:f,canManageArtists:k,canUploadDocuments:p,canCreateFlexFolders:T}},[y]),{data:Z=[],byDepartment:ie}=Re(t==null?void 0:t.id,$),ce=x.useMemo(()=>{const m=new Set,f=new Set,k=new Set,p={},T=Array.isArray(P)?P:[];for(const _ of T){const A=_.technician_id;_.sound_role&&(m.add(A),p[_.sound_role]=p[_.sound_role]||new Set,p[_.sound_role].add(A)),_.lights_role&&(f.add(A),p[_.lights_role]=p[_.lights_role]||new Set,p[_.lights_role].add(A)),_.video_role&&(k.add(A),p[_.video_role]=p[_.video_role]||new Set,p[_.video_role].add(A))}const O={sound:m.size,lights:f.size,video:k.size},z={};return Object.entries(p).forEach(([_,A])=>z[_]=A.size),{countsByDept:O,countsByRole:z}},[P]),Ne=x.useMemo(()=>{var f;const m={};for(const k of["sound","lights","video"]){const p=((f=ie.get)==null?void 0:f.call(ie,k))||(Z.find(_=>_.department===k)??null),T=(p==null?void 0:p.total_required)??0,O=((p==null?void 0:p.roles)||[]).map(_=>({role_code:_.role_code,required:_.quantity,assigned:ce.countsByRole[_.role_code]||0})),z=ce.countsByDept[k]||0;m[k]={required:T,assigned:z,roles:O}}return m},[Z,ie,ce]),{data:be}=L({queryKey:Pe.tasks.byDepartment("sound",t.id),queryFn:async()=>{if(D!=="sound")return null;const{data:m,error:f}=await i.from("sound_job_tasks").select(`
          *,
          assigned_to (first_name, last_name),
          task_documents(*)
        `).eq("job_id",t.id);if(f)throw f;return m},enabled:n&&D==="sound"&&(c||!Q),staleTime:120*1e3}),ke=x.useCallback(m=>{m.stopPropagation(),U(f=>!f)},[]),qe=x.useCallback(m=>{m.stopPropagation(),o(!0)},[]),Ce=x.useCallback(async m=>{var k;m.stopPropagation();const f=(k=m.target.files)==null?void 0:k[0];if(!(!f||!D))try{const p=f.name.split(".").pop(),T=`${D}/${t.id}/${crypto.randomUUID()}.${p}`,{error:O}=await i.storage.from("job_documents").upload(T,f);if(O)throw O;const{data:z,error:_}=await i.from("job_documents").insert({job_id:t.id,file_name:f.name,file_path:T,file_type:f.type,file_size:f.size,original_type:null}).select("*").single();if(_)throw _;z&&s(A=>Array.isArray(A)?[...A,z]:[z]);try{i.functions.invoke("push",{body:{action:"broadcast",type:"document.uploaded",job_id:t.id,file_name:f.name}})}catch{}}catch{}},[t.id,D]),Se=x.useCallback(async m=>{if(!(m!=null&&m.read_only)&&window.confirm("Are you sure you want to delete this document?"))try{const{bucket:f,path:k}=$e(m.file_path),{error:p}=await i.storage.from(f).remove([k]);if(p)throw p;const{error:T}=await i.from("job_documents").delete().eq("id",m.id);if(T)throw T;s(O=>Array.isArray(O)?O.filter(z=>z.id!==m.id):O);try{i.functions.invoke("push",{body:{action:"broadcast",type:"document.deleted",job_id:t.id,file_name:m.file_name}})}catch{}}catch{}},[t.id]),Te=x.useCallback(async m=>{m.stopPropagation();try{const{data:f,error:k}=await i.from("job_documents").select("*").eq("job_id",t.id).order("uploaded_at",{ascending:!1});k||s(f||[]),h(),j.invalidateQueries({queryKey:["optimized-jobs"]})}catch{}},[t.id,j,h]);return{appliedBorderColor:G,appliedBgColor:K,collapsed:Q,assignments:P,documents:a,reqSummary:Z,requiredVsAssigned:Ne,soundTaskDialogOpen:c,lightsTaskDialogOpen:r,videoTaskDialogOpen:Y,editJobDialogOpen:le,assignmentDialogOpen:l,soundTasks:be,...X,toggleCollapse:ke,handleEditButtonClick:qe,handleFileUpload:Ce,handleDeleteDocument:Se,refreshData:Te,setSoundTaskDialogOpen:d,setLightsTaskDialogOpen:u,setVideoTaskDialogOpen:oe,setEditJobDialogOpen:o,setAssignmentDialogOpen:w}},ss=Ue((t,D)=>({deletingJobs:new Set,addDeletingJob:y=>{t(g=>({deletingJobs:new Set([...g.deletingJobs,y])}))},removeDeletingJob:y=>{t(g=>{const E=new Set(g.deletingJobs);return E.delete(y),{deletingJobs:E}})},isDeletingJob:y=>D().deletingJobs.has(y),clearDeletingJobs:()=>{t({deletingJobs:new Set})}})),ze=["QT","Rigging Plot","Pesos","Consumos","PS"],ts=({jobId:t,open:D,onOpenChange:y})=>{const{toast:g}=de(),[E,F]=x.useState(!1),q=ne(),{data:R}=L({queryKey:["management-users"],queryFn:async()=>{const{data:a,error:s}=await i.from("profiles").select("id, first_name, last_name").in("role",["management","admin"]);if(s)throw s;return a}}),{data:j,refetch:$}=L({queryKey:["lights-tasks",t],queryFn:async()=>{if(!t)return null;const{data:a,error:s}=await i.from("lights_job_tasks").select(`
          *,
          assigned_to (
            first_name,
            last_name
          ),
          task_documents (*)
        `).eq("job_id",t);if(s)throw s;return a},enabled:!!t}),{data:n}=L({queryKey:["lights-personnel",t],queryFn:async()=>{if(!t)return null;const{data:a,error:s}=await i.from("lights_job_personnel").select("*").eq("job_id",t).maybeSingle();if(s&&s.code!=="PGRST116")throw s;if(!a){const{data:c,error:d}=await i.from("lights_job_personnel").insert({job_id:t,lighting_designers:0,lighting_techs:0,spot_ops:0,riggers:0}).select().single();if(d)throw d;return c}return a},enabled:!!t}),G=async(a,s)=>{try{F(!0);const c=`${a}/${crypto.randomUUID()}-${s.name}`,{error:d}=await i.storage.from("task_documents").upload(c,s);if(d)throw d;const{error:r}=await i.from("task_documents").insert({lights_task_id:a,file_name:s.name,file_path:c});if(r)throw r;await i.from("lights_job_tasks").update({status:"completed",progress:100}).eq("id",a),g({title:"File uploaded successfully",description:"The document has been uploaded and task marked as completed."}),$()}catch(c){g({title:"Upload failed",description:c.message,variant:"destructive"})}finally{F(!1)}},K=async(a,s)=>{try{const{data:c,error:d}=await i.storage.from("task_documents").download(a);if(d)throw d;const r=URL.createObjectURL(c),u=document.createElement("a");u.href=r,u.download=s,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(r)}catch(c){g({title:"Download failed",description:c.message,variant:"destructive"})}},Q=async(a,s,c)=>{try{const{error:d}=await i.storage.from("task_documents").remove([c]);if(d)throw new Error(`Failed to delete file from storage: ${d.message}`);const{error:r}=await i.from("task_documents").delete().eq("id",s);if(r)throw new Error(`Failed to delete file record: ${r.message}`);const{error:u}=await i.from("lights_job_tasks").update({status:"in_progress",progress:50}).eq("id",a);if(u)throw new Error(`Failed to update task status: ${u.message}`);g({title:"File deleted",description:"The document has been removed from the task."}),$()}catch(d){g({title:"Delete failed",description:d.message,variant:"destructive"})}},U=async(a,s)=>{try{const c=s==="completed"?100:s==="in_progress"?50:0,{error:d}=await i.from("lights_job_tasks").update({status:s,progress:c,updated_at:new Date().toISOString()}).eq("id",a);if(d)throw d;$(),g({title:"Task updated",description:"Task status has been updated successfully."})}catch(c){g({title:"Update failed",description:c.message,variant:"destructive"})}},P=()=>{if(!(j!=null&&j.length))return 0;const a=j.reduce((s,c)=>s+(c.progress||0),0);return Math.round(a/j.length)},W=a=>{switch(a){case"completed":return"bg-green-500";case"in_progress":return"bg-blue-500";default:return"bg-gray-300"}};return t?e.jsx(ue,{open:D,onOpenChange:y,children:e.jsxs(me,{className:"p-4 w-[95vw] max-w-[800px] max-h-[80vh] overflow-y-auto",children:[e.jsx(he,{children:e.jsxs(ge,{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"h-5 w-5"}),e.jsx("span",{children:"Lights Department Tasks"}),e.jsx("img",{src:pe,alt:"Create Flex Folders",width:24,height:24,loading:"lazy",decoding:"async",className:"h-6 w-6 ml-2 cursor-pointer",title:"Create Flex Folders"})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(B,{children:"Lighting Designers Required"}),e.jsx(J,{type:"number",min:"0",value:(n==null?void 0:n.lighting_designers)||0,onChange:async a=>{const{error:s}=await i.from("lights_job_personnel").update({lighting_designers:parseInt(a.target.value)}).eq("id",n==null?void 0:n.id);s&&g({title:"Update failed",description:s.message,variant:"destructive"}),q.invalidateQueries({queryKey:["lights-personnel",t]})}})]}),e.jsxs("div",{children:[e.jsx(B,{children:"Lighting Techs Required"}),e.jsx(J,{type:"number",min:"0",value:(n==null?void 0:n.lighting_techs)||0,onChange:async a=>{const{error:s}=await i.from("lights_job_personnel").update({lighting_techs:parseInt(a.target.value)}).eq("id",n==null?void 0:n.id);s&&g({title:"Update failed",description:s.message,variant:"destructive"}),q.invalidateQueries({queryKey:["lights-personnel",t]})}})]}),e.jsxs("div",{children:[e.jsx(B,{children:"Spot Ops Required"}),e.jsx(J,{type:"number",min:"0",value:(n==null?void 0:n.spot_ops)||0,onChange:async a=>{const{error:s}=await i.from("lights_job_personnel").update({spot_ops:parseInt(a.target.value)}).eq("id",n==null?void 0:n.id);s&&g({title:"Update failed",description:s.message,variant:"destructive"}),q.invalidateQueries({queryKey:["lights-personnel",t]})}})]}),e.jsxs("div",{children:[e.jsx(B,{children:"Riggers Required"}),e.jsx(J,{type:"number",min:"0",value:(n==null?void 0:n.riggers)||0,onChange:async a=>{const{error:s}=await i.from("lights_job_personnel").update({riggers:parseInt(a.target.value)}).eq("id",n==null?void 0:n.id);s&&g({title:"Update failed",description:s.message,variant:"destructive"}),q.invalidateQueries({queryKey:["lights-personnel",t]})}})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("span",{className:"font-medium",children:"Total Progress:"}),e.jsx("div",{className:"flex-1",children:e.jsx(ae,{value:P(),className:"h-2"})}),e.jsxs("span",{className:"text-sm",children:[P(),"%"]})]}),e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsxs(xe,{className:"w-full",children:[e.jsx(_e,{children:e.jsxs(re,{children:[e.jsx(C,{className:"w-[15%]",children:"Task"}),e.jsx(C,{className:"w-[20%]",children:"Assigned To"}),e.jsx(C,{className:"w-[15%]",children:"Status"}),e.jsx(C,{className:"w-[15%]",children:"Progress"}),e.jsx(C,{className:"w-[20%]",children:"Documents"}),e.jsx(C,{className:"w-[15%]",children:"Actions"})]})}),e.jsx(we,{children:ze.map(a=>{var c,d;const s=j==null?void 0:j.find(r=>r.task_type===a);return e.jsxs(re,{children:[e.jsx(S,{className:"font-medium truncate max-w-[100px]",children:a}),e.jsx(S,{children:e.jsxs(I,{value:((c=s==null?void 0:s.assigned_to)==null?void 0:c.id)||"",onValueChange:async r=>{if(s){const{error:u}=await i.from("lights_job_tasks").update({assigned_to:r}).eq("id",s.id);if(u)throw u}else{const{error:u}=await i.from("lights_job_tasks").insert({job_id:t,task_type:a,assigned_to:r});if(u)throw u}$()},children:[e.jsx(ee,{className:"w-[150px]",children:e.jsx(se,{placeholder:"Assign to..."})}),e.jsx(te,{children:R==null?void 0:R.map(r=>e.jsxs(M,{value:r.id,children:[r.first_name," ",r.last_name]},r.id))})]})}),e.jsx(S,{children:s&&e.jsxs(I,{value:s.status,onValueChange:r=>U(s.id,r),children:[e.jsx(ee,{className:"w-[120px]",children:e.jsx(se,{})}),e.jsxs(te,{children:[e.jsx(M,{value:"not_started",children:"Not Started"}),e.jsx(M,{value:"in_progress",children:"In Progress"}),e.jsx(M,{value:"completed",children:"Completed"})]})]})}),e.jsx(S,{children:s&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ae,{value:s.progress,className:`h-2 ${W(s.status)}`}),e.jsxs("span",{className:"text-xs w-7",children:[s.progress,"%"]})]})}),e.jsx(S,{children:e.jsx("div",{className:"max-h-[60px] overflow-y-auto",children:(d=s==null?void 0:s.task_documents)==null?void 0:d.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-1 text-xs",children:[e.jsx("span",{className:"truncate max-w-[100px]",title:r.file_name,children:r.file_name}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(V,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>K(r.file_path,r.file_name),children:e.jsx(ye,{className:"h-3 w-3"})}),e.jsx(V,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>Q(s.id,r.id,r.file_path),children:e.jsx(fe,{className:"h-3 w-3"})})]})]},r.id))})}),e.jsx(S,{children:s&&e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",onChange:r=>{var Y;const u=(Y=r.target.files)==null?void 0:Y[0];u&&G(s.id,u)},disabled:E}),e.jsxs(V,{variant:"outline",size:"sm",disabled:E,className:"w-[100px]",children:[e.jsx(je,{className:"h-3 w-3 mr-1"}),"Upload"]})]})})]},a)})})]})})]})]})]})}):null},Ke=["QT","Rigging Plot","Prediccion","Pesos","Consumos","PS"],as=({jobId:t,open:D,onOpenChange:y})=>{const[g,E]=x.useState({foh_engineers:0,mon_engineers:0,pa_techs:0,rf_techs:0}),[F,q]=x.useState(null),[R,j]=x.useState(!1),$=ne(),{toast:n}=de(),{data:G}=L({queryKey:["job-details",t],queryFn:async()=>{if(!t)return null;const{data:o,error:l}=await i.from("jobs").select("*").eq("id",t).single();if(l)throw l;return o},enabled:!!t});x.useEffect(()=>{G&&q(G)},[G]);const{data:K}=L({queryKey:["job-personnel",t],queryFn:async()=>{if(!t)return null;const{data:o,error:l}=await i.from("sound_job_personnel").select("*").eq("job_id",t).single();if(l)throw l;return o},enabled:!!t});x.useEffect(()=>{K&&E({foh_engineers:K.foh_engineers||0,mon_engineers:K.mon_engineers||0,pa_techs:K.pa_techs||0,rf_techs:K.rf_techs||0})},[K]);const{data:Q}=L({queryKey:["management-users"],queryFn:async()=>{const{data:o,error:l}=await i.from("profiles").select("id, first_name, last_name").in("role",["management","admin"]);if(l)throw l;return o}}),{data:U,refetch:P}=L({queryKey:["sound-tasks",t],queryFn:async()=>{if(!t)return null;const{data:o,error:l}=await i.from("sound_job_tasks").select(`
          *,
          assigned_to (
            id,
            first_name,
            last_name
          ),
          task_documents (*)
        `).eq("job_id",t);if(l)throw l;return o},enabled:!!t}),W=Oe({mutationFn:async()=>{const{error:o}=await i.from("jobs").update({flex_folders_created:!0}).eq("id",t);if(o)throw o}}),a=async()=>{if(!F||F.flex_folders_created){n({title:"Folders already created",description:"Flex folders have already been created for this job.",variant:"destructive"});return}try{n({title:"Creating folders",description:"Please wait while the folders are being created..."});const l=new Date(F.start_date).toISOString().slice(2,10).replace(/-/g,"");await W.mutateAsync(),n({title:"Success",description:"Flex folders have been created successfully."}),$.invalidateQueries({queryKey:["job-details",t]})}catch(o){n({title:"Error creating folders",description:o.message,variant:"destructive"})}},s=async(o,l)=>{var w;try{j(!0);const N=l.name.replace(/[^a-zA-Z0-9.-]/g,"_"),h=new Date().getTime(),b=`${o}/${h}_${N}`,{error:X}=await i.storage.from("task_documents").upload(b,l,{cacheControl:"3600",upsert:!1});if(X)throw X;const{error:Z}=await i.from("task_documents").insert({sound_task_id:o,file_name:l.name,file_path:b,uploaded_by:(w=(await i.auth.getUser()).data.user)==null?void 0:w.id});if(Z)throw Z;await i.from("sound_job_tasks").update({status:"completed",progress:100,updated_at:new Date().toISOString()}).eq("id",o),n({title:"File uploaded successfully",description:"The document has been uploaded and task marked as completed."}),P()}catch(N){n({title:"Upload failed",description:N.message,variant:"destructive"})}finally{j(!1)}},c=async(o,l,w)=>{try{const{error:N}=await i.storage.from("task_documents").remove([w]);if(N)throw N;const{error:h}=await i.from("task_documents").delete().eq("id",l);if(h)throw h;await i.from("sound_job_tasks").update({status:"in_progress",progress:50}).eq("id",o),P(),n({title:"File deleted",description:"The document has been removed successfully."})}catch(N){n({title:"Delete failed",description:N.message,variant:"destructive"})}},d=(o,l)=>{E(w=>({...w,[o]:isNaN(l)?0:l}))},r=async(o,l)=>{try{const{error:w}=await i.from("sound_job_personnel").update({[o]:l}).eq("job_id",t);if(w)throw w;n({title:"Update successful",description:`${o} updated to ${l}`}),E(N=>({...N,[o]:l}))}catch(w){n({title:"Update failed",description:w.message,variant:"destructive"})}},u=()=>{if(!(U!=null&&U.length))return 0;const o=U.reduce((l,w)=>l+(w.progress||0),0);return Math.round(o/U.length)},Y=o=>{switch(o){case"completed":return"bg-green-500";case"in_progress":return"bg-blue-500";default:return"bg-gray-300"}},oe=async(o,l)=>{try{const w=l==="completed"?100:l==="in_progress"?50:0,{error:N}=await i.from("sound_job_tasks").update({status:l,progress:w,updated_at:new Date().toISOString()}).eq("id",o);if(N)throw N;P(),n({title:"Task updated",description:"Task status has been updated successfully."})}catch(w){n({title:"Update failed",description:w.message,variant:"destructive"})}},le=async(o,l)=>{try{const{data:w,error:N}=await i.storage.from("task_documents").download(o);if(N)throw N;const h=URL.createObjectURL(w),b=document.createElement("a");b.href=h,b.download=l,document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(h)}catch(w){n({title:"Download failed",description:w.message,variant:"destructive"})}};return e.jsx(ue,{open:D,onOpenChange:y,children:e.jsxs(me,{className:"w-full max-w-4xl h-[90vh] flex flex-col p-0",children:[e.jsxs(he,{className:"px-4 py-2 flex flex-row items-center justify-between border-b",children:[e.jsxs(ge,{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"h-5 w-5"}),e.jsx("span",{children:"Sound Department Tasks"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(V,{variant:"ghost",size:"icon",onClick:a,disabled:!F||F.flex_folders_created,className:"hover:bg-gray-100 group relative",children:[e.jsx("img",{src:pe,alt:"Create Flex Folders",width:24,height:24,loading:"lazy",decoding:"async",className:"h-6 w-6"}),e.jsx("span",{className:"absolute -bottom-8 scale-0 transition-all rounded bg-gray-800 p-2 text-xs text-white group-hover:scale-100 whitespace-nowrap",children:F!=null&&F.flex_folders_created?"Folders already created":"Create Flex Folders"})]}),e.jsx(V,{variant:"ghost",size:"icon",onClick:()=>y(!1),children:e.jsx(Ae,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(B,{children:"FOH Engineers Required"}),e.jsx(J,{type:"number",min:"0",value:g.foh_engineers,onChange:o=>d("foh_engineers",parseInt(o.target.value)),onBlur:o=>r("foh_engineers",parseInt(o.target.value))})]}),e.jsxs("div",{children:[e.jsx(B,{children:"MON Engineers Required"}),e.jsx(J,{type:"number",min:"0",value:g.mon_engineers,onChange:o=>d("mon_engineers",parseInt(o.target.value)),onBlur:o=>r("mon_engineers",parseInt(o.target.value))})]}),e.jsxs("div",{children:[e.jsx(B,{children:"PA Techs Required"}),e.jsx(J,{type:"number",min:"0",value:g.pa_techs,onChange:o=>d("pa_techs",parseInt(o.target.value)),onBlur:o=>r("pa_techs",parseInt(o.target.value))})]}),e.jsxs("div",{children:[e.jsx(B,{children:"RF Techs Required"}),e.jsx(J,{type:"number",min:"0",value:g.rf_techs,onChange:o=>d("rf_techs",parseInt(o.target.value)),onBlur:o=>r("rf_techs",parseInt(o.target.value))})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("span",{className:"font-medium",children:"Total Progress:"}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:e.jsx(ae,{value:u(),className:"h-2"})}),e.jsxs("span",{className:"text-sm",children:[u(),"%"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(xe,{children:[e.jsx(_e,{children:e.jsxs(re,{children:[e.jsx(C,{className:"w-[15%]",children:"Task"}),e.jsx(C,{className:"w-[20%]",children:"Assigned To"}),e.jsx(C,{className:"w-[15%]",children:"Status"}),e.jsx(C,{className:"w-[15%]",children:"Progress"}),e.jsx(C,{className:"w-[20%]",children:"Documents"}),e.jsx(C,{className:"w-[15%]",children:"Actions"})]})}),e.jsx(we,{children:Ke.map(o=>{var w,N;const l=U==null?void 0:U.find(h=>h.task_type===o);return e.jsxs(re,{children:[e.jsx(S,{className:"font-medium truncate max-w-[100px]",children:o}),e.jsx(S,{children:e.jsxs(I,{value:((w=l==null?void 0:l.assigned_to)==null?void 0:w.id)||"",onValueChange:async h=>{if(l){const{error:b}=await i.from("sound_job_tasks").update({assigned_to:h}).eq("id",l.id);if(b)throw b}else{const{error:b}=await i.from("sound_job_tasks").insert({job_id:t,task_type:o,assigned_to:h});if(b)throw b}P()},children:[e.jsx(ee,{className:"w-[150px]",children:e.jsx(se,{placeholder:"Assign to..."})}),e.jsx(te,{children:Q==null?void 0:Q.map(h=>e.jsxs(M,{value:h.id,children:[h.first_name," ",h.last_name]},h.id))})]})}),e.jsx(S,{children:l&&e.jsxs(I,{value:l.status,onValueChange:h=>oe(l.id,h),children:[e.jsx(ee,{className:"w-[120px]",children:e.jsx(se,{})}),e.jsxs(te,{children:[e.jsx(M,{value:"not_started",children:"Not Started"}),e.jsx(M,{value:"in_progress",children:"In Progress"}),e.jsx(M,{value:"completed",children:"Completed"})]})]})}),e.jsx(S,{children:l&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ae,{value:l.progress,className:`h-2 ${Y(l.status)}`}),e.jsxs("span",{className:"text-xs w-7",children:[l.progress,"%"]})]})}),e.jsx(S,{children:e.jsx("div",{className:"max-h-[60px] overflow-y-auto",children:(N=l==null?void 0:l.task_documents)==null?void 0:N.map(h=>e.jsxs("div",{className:"flex items-center justify-between p-1 text-xs",children:[e.jsx("span",{className:"truncate max-w-[100px]",title:h.file_name,children:h.file_name}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(V,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>le(h.file_path,h.file_name),children:e.jsx(ye,{className:"h-3 w-3"})}),e.jsx(V,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>c(l.id,h.id,h.file_path),children:e.jsx(fe,{className:"h-3 w-3"})})]})]},h.id))})}),e.jsx(S,{children:l&&e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",onChange:h=>{var X;const b=(X=h.target.files)==null?void 0:X[0];b&&s(l.id,b)},disabled:R}),e.jsxs(V,{variant:"outline",size:"sm",disabled:R,className:"w-[100px]",children:[e.jsx(je,{className:"h-3 w-3 mr-1"}),"Upload"]})]})})]},o)})})]})})]})]})})]})})},Le=["QT","Rigging Plot","Pesos","Consumos"],rs=({jobId:t,open:D,onOpenChange:y})=>{const{toast:g}=de(),[E,F]=x.useState(!1),q=ne(),{data:R}=L({queryKey:["management-users"],queryFn:async()=>{const{data:a,error:s}=await i.from("profiles").select("id, first_name, last_name").in("role",["management","admin"]);if(s)throw s;return a}}),{data:j,refetch:$}=L({queryKey:["video-tasks",t],queryFn:async()=>{if(!t)return null;const{data:a,error:s}=await i.from("video_job_tasks").select(`
          *,
          assigned_to (
            first_name,
            last_name
          ),
          task_documents (*)
        `).eq("job_id",t);if(s)throw s;return a},enabled:!!t}),{data:n}=L({queryKey:["video-personnel",t],queryFn:async()=>{if(!t)return null;const{data:a,error:s}=await i.from("video_job_personnel").select("*").eq("job_id",t).maybeSingle();if(s&&s.code!=="PGRST116")throw s;if(!a){const{data:c,error:d}=await i.from("video_job_personnel").insert({job_id:t,video_directors:0,camera_ops:0,playback_techs:0,video_techs:0}).select().single();if(d)throw d;return c}return a},enabled:!!t}),G=async(a,s)=>{try{F(!0);const c=`${a}/${crypto.randomUUID()}-${s.name}`,{error:d}=await i.storage.from("task_documents").upload(c,s);if(d)throw d;const{error:r}=await i.from("task_documents").insert({task_id:a,file_name:s.name,file_path:c});if(r)throw r;await i.from("video_job_tasks").update({status:"completed",progress:100}).eq("id",a),g({title:"File uploaded successfully",description:"The document has been uploaded and task marked as completed."}),$()}catch(c){g({title:"Upload failed",description:c.message,variant:"destructive"})}finally{F(!1)}},K=async(a,s)=>{try{const{data:c,error:d}=await i.storage.from("task_documents").download(a);if(d)throw d;const r=URL.createObjectURL(c),u=document.createElement("a");u.href=r,u.download=s,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(r)}catch(c){g({title:"Download failed",description:c.message,variant:"destructive"})}},Q=async(a,s,c)=>{try{const{error:d}=await i.storage.from("task_documents").remove([c]);if(d)throw new Error(`Failed to delete file from storage: ${d.message}`);const{error:r}=await i.from("task_documents").delete().eq("id",s);if(r)throw new Error(`Failed to delete file record: ${r.message}`);const{error:u}=await i.from("video_job_tasks").update({status:"in_progress",progress:50}).eq("id",a);if(u)throw new Error(`Failed to update task status: ${u.message}`);g({title:"File deleted",description:"The document has been removed from the task."}),$()}catch(d){g({title:"Delete failed",description:d.message,variant:"destructive"})}},U=async(a,s)=>{try{const c=s==="completed"?100:s==="in_progress"?50:0,{error:d}=await i.from("video_job_tasks").update({status:s,progress:c,updated_at:new Date().toISOString()}).eq("id",a);if(d)throw d;$(),g({title:"Task updated",description:"Task status has been updated successfully."})}catch(c){g({title:"Update failed",description:c.message,variant:"destructive"})}},P=()=>{if(!(j!=null&&j.length))return 0;const a=j.reduce((s,c)=>s+(c.progress||0),0);return Math.round(a/j.length)},W=a=>{switch(a){case"completed":return"bg-green-500";case"in_progress":return"bg-blue-500";default:return"bg-gray-300"}};return t?e.jsx(ue,{open:D,onOpenChange:y,children:e.jsxs(me,{className:"p-4 w-[95vw] max-w-[800px] max-h-[80vh] overflow-y-auto",children:[e.jsx(he,{children:e.jsxs(ge,{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"h-5 w-5"}),e.jsx("span",{children:"Video Department Tasks"}),e.jsx("img",{src:pe,alt:"Create Flex Folders",width:24,height:24,loading:"lazy",decoding:"async",className:"h-6 w-6 ml-2 cursor-pointer",title:"Create Flex Folders"})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(B,{children:"Video Directors Required"}),e.jsx(J,{type:"number",min:"0",value:(n==null?void 0:n.video_directors)||0,onChange:async a=>{const{error:s}=await i.from("video_job_personnel").update({video_directors:parseInt(a.target.value)}).eq("id",n==null?void 0:n.id);s&&g({title:"Update failed",description:s.message,variant:"destructive"}),q.invalidateQueries({queryKey:["video-personnel",t]})}})]}),e.jsxs("div",{children:[e.jsx(B,{children:"Camera Operators Required"}),e.jsx(J,{type:"number",min:"0",value:(n==null?void 0:n.camera_ops)||0,onChange:async a=>{const{error:s}=await i.from("video_job_personnel").update({camera_ops:parseInt(a.target.value)}).eq("id",n==null?void 0:n.id);s&&g({title:"Update failed",description:s.message,variant:"destructive"}),q.invalidateQueries({queryKey:["video-personnel",t]})}})]}),e.jsxs("div",{children:[e.jsx(B,{children:"Playback Techs Required"}),e.jsx(J,{type:"number",min:"0",value:(n==null?void 0:n.playback_techs)||0,onChange:async a=>{const{error:s}=await i.from("video_job_personnel").update({playback_techs:parseInt(a.target.value)}).eq("id",n==null?void 0:n.id);s&&g({title:"Update failed",description:s.message,variant:"destructive"}),q.invalidateQueries({queryKey:["video-personnel",t]})}})]}),e.jsxs("div",{children:[e.jsx(B,{children:"Video Techs Required"}),e.jsx(J,{type:"number",min:"0",value:(n==null?void 0:n.video_techs)||0,onChange:async a=>{const{error:s}=await i.from("video_job_personnel").update({video_techs:parseInt(a.target.value)}).eq("id",n==null?void 0:n.id);s&&g({title:"Update failed",description:s.message,variant:"destructive"}),q.invalidateQueries({queryKey:["video-personnel",t]})}})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("span",{className:"font-medium",children:"Total Progress:"}),e.jsx("div",{className:"flex-1",children:e.jsx(ae,{value:P(),className:"h-2"})}),e.jsxs("span",{className:"text-sm",children:[P(),"%"]})]}),e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsxs(xe,{className:"w-full",children:[e.jsx(_e,{children:e.jsxs(re,{children:[e.jsx(C,{className:"w-[15%]",children:"Task"}),e.jsx(C,{className:"w-[20%]",children:"Assigned To"}),e.jsx(C,{className:"w-[15%]",children:"Status"}),e.jsx(C,{className:"w-[15%]",children:"Progress"}),e.jsx(C,{className:"w-[20%]",children:"Documents"}),e.jsx(C,{className:"w-[15%]",children:"Actions"})]})}),e.jsx(we,{children:Le.map(a=>{var c,d;const s=j==null?void 0:j.find(r=>r.task_type===a);return e.jsxs(re,{children:[e.jsx(S,{className:"font-medium truncate max-w-[100px]",children:a}),e.jsx(S,{children:e.jsxs(I,{value:((c=s==null?void 0:s.assigned_to)==null?void 0:c.id)||"",onValueChange:async r=>{if(s){const{error:u}=await i.from("video_job_tasks").update({assigned_to:r}).eq("id",s.id);if(u)throw u}else{const{error:u}=await i.from("video_job_tasks").insert({job_id:t,task_type:a,assigned_to:r});if(u)throw u}$()},children:[e.jsx(ee,{className:"w-[150px]",children:e.jsx(se,{placeholder:"Assign to..."})}),e.jsx(te,{children:R==null?void 0:R.map(r=>e.jsxs(M,{value:r.id,children:[r.first_name," ",r.last_name]},r.id))})]})}),e.jsx(S,{children:s&&e.jsxs(I,{value:s.status,onValueChange:r=>U(s.id,r),children:[e.jsx(ee,{className:"w-[120px]",children:e.jsx(se,{})}),e.jsxs(te,{children:[e.jsx(M,{value:"not_started",children:"Not Started"}),e.jsx(M,{value:"in_progress",children:"In Progress"}),e.jsx(M,{value:"completed",children:"Completed"})]})]})}),e.jsx(S,{children:s&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ae,{value:s.progress,className:`h-2 ${W(s.status)}`}),e.jsxs("span",{className:"text-xs w-7",children:[s.progress,"%"]})]})}),e.jsx(S,{children:e.jsx("div",{className:"max-h-[60px] overflow-y-auto",children:(d=s==null?void 0:s.task_documents)==null?void 0:d.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-1 text-xs",children:[e.jsx("span",{className:"truncate max-w-[100px]",title:r.file_name,children:r.file_name}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(V,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>K(r.file_path,r.file_name),children:e.jsx(ye,{className:"h-3 w-3"})}),e.jsx(V,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>Q(s.id,r.id,r.file_path),children:e.jsx(fe,{className:"h-3 w-3"})})]})]},r.id))})}),e.jsx(S,{children:s&&e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",onChange:r=>{var Y;const u=(Y=r.target.files)==null?void 0:Y[0];u&&G(s.id,u)},disabled:E}),e.jsxs(V,{variant:"outline",size:"sm",disabled:E,className:"w-[100px]",children:[e.jsx(je,{className:"h-3 w-3 mr-1"}),"Upload"]})]})})]},a)})})]})})]})]})]})}):null};export{ts as L,as as S,rs as V,es as a,Ie as b,ss as u};
