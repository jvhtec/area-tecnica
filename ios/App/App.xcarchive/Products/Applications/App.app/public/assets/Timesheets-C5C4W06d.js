import{l as ze,r as g,j as e,C as S,W as I,Y as J,A as E,D as Ds,aF as Rs,B as y,q as As,F as Ms,G as Ps,X as cs,U as zs,m as Q,i as Z,u as he,S as re,t as ne,v as ie,w as le,x as U,h as ce,a4 as pe,L as F,Q as qs,a as Ee,f as Us,n as oe,aG as Hs,I as ee,ac as Ne,aH as Ls,aI as Bs,cd as $s,aJ as _e,ce as Os,e as os,V as Fe,ab as Vs,b as Is}from"./index-NZ6jJLfQ.js";import{B as se}from"./badge-vNTKF5RD.js";import{u as ds}from"./useTimesheets-C6aFxEBN.js";import{u as Js}from"./useJobAssignmentsRealtime-7FZn5naq.js";import{P as rs,S as Gs}from"./index-vfKqQWY5.js";import{u as ye}from"./useQuery-kdg2pmgf.js";import{C as X}from"./clock-BXPvTWvY.js";import{E as be}from"./euro-DgRTeGAz.js";import{U as Qs}from"./users-DMnpVLUq.js";import{e as me}from"./es-CSiFCUGj.js";import{u as Ks}from"./useJobPayoutTotals-CXAavZS-.js";import{u as ms}from"./useJobRatesApproval-DsfA8V9C.js";import{U as us}from"./user-E3OATBQk.js";import{P as De}from"./plus-C3JQqq7t.js";import{A as qe,h as xs,a as Ue,b as He,c as Le,d as Be,e as $e,f as Oe,g as Ve}from"./alert-dialog-CtyYUxwH.js";import{A as Re,a as Ae,b as Ws}from"./alert-BqA-5jRM.js";import{P as Xs}from"./progress-C8XsV-Me.js";import{U as Ys}from"./upload-DF4rjO7T.js";import{F as xe}from"./file-text-igU140SQ.js";import{E as hs}from"./eye-BE_DouVP.js";import{u as ve}from"./useMutation-DluhVBs1.js";import{C as Me}from"./circle-alert-LZYNzZ7F.js";import{C as Zs}from"./circle-x-DDzV-xk_.js";import{C as ps}from"./circle-check-C0N48OpO.js";import{R as Pe}from"./receipt-CWKVL4Rh.js";import{C as ea}from"./calendar-days-DcwEz6pd.js";import{M as sa}from"./mail-1T3Omkp6.js";import{T as aa}from"./triangle-alert-D6qN0F8g.js";import{d as ta}from"./timesheet-pdf-82e1LStH.js";import{u as ra}from"./useOptimizedJobs-BQ4L7-2d.js";import{D as na}from"./download-C1rVE0-J.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./ratesQueryKeys-DgMsgg6U.js";import"./useRealtimeQuery-DRd58t-I.js";import"./useTableSubscription-Cu79jct8.js";import"./pdf-libs-BqoGqu1a.js";import"./logoUtils-D2o1jUVg.js";import"./logo-url-cache-eY6nfvu7.js";import"./lazyPdf-xVUlxKNu.js";import"./useSubscription-C3wu6ko-.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ia=ze("FilePen",[["path",{d:"M12.5 22H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v9.5",key:"1couwa"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M13.378 15.626a1 1 0 1 0-3.004-3.004l-5.01 5.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z",key:"1y4qbx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const la=ze("ShieldAlert",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ns=ze("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]),ca=({timesheetId:s,currentSignature:a,canSign:r,onSigned:n})=>{const[c,p]=g.useState(!1),[u,o]=g.useState(!1),t=g.useRef(null),m=async()=>{if(t.current){o(!0);try{const j=t.current.toDataURL();await n(s,j),p(!1)}catch{}finally{o(!1)}}},l=()=>{t.current&&t.current.clear()};return e.jsxs(S,{children:[e.jsx(I,{children:e.jsxs(J,{className:"text-sm flex items-center gap-2",children:[e.jsx(rs,{className:"h-4 w-4"}),"Digital Signature"]})}),e.jsx(E,{children:a?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"border rounded-lg p-2 bg-background",children:e.jsx("img",{src:a,alt:"Signature",width:400,height:150,loading:"lazy",decoding:"async",className:"max-w-full h-20 object-contain"})}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Signed digitally"})]}):r?e.jsxs(Ds,{open:c,onOpenChange:p,children:[e.jsx(Rs,{asChild:!0,children:e.jsxs(y,{variant:"outline",className:"w-full",children:[e.jsx(rs,{className:"h-4 w-4 mr-2"}),"Add Signature"]})}),e.jsxs(As,{className:"max-w-md",children:[e.jsx(Ms,{children:e.jsx(Ps,{children:"Digital Signature"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border rounded-lg p-2 bg-background",children:e.jsx(Gs,{ref:t,canvasProps:{width:400,height:150,className:"signature-canvas w-full"},backgroundColor:"white"})}),e.jsxs("div",{className:"flex justify-between gap-2",children:[e.jsxs(y,{variant:"outline",onClick:l,className:"flex items-center gap-2",children:[e.jsx(cs,{className:"h-4 w-4"}),"Clear"]}),e.jsxs(y,{onClick:m,disabled:u,className:"flex items-center gap-2",children:[e.jsx(zs,{className:"h-4 w-4"}),u?"Saving...":"Save Signature"]})]})]})]})]}):e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Signature pending"})})})]})};function oa(s){return ye({queryKey:["job-totals",s],queryFn:async()=>{if(!s)return null;const{data:a,error:r}=await Q.rpc("get_job_total_amounts",{_job_id:s});if(r)throw r;const n=Array.isArray(a)?a==null?void 0:a[0]:a;return n?{job_id:n.job_id??s,total_approved_eur:Number(n.total_approved_eur??0),total_pending_eur:Number(n.total_pending_eur??0),pending_item_count:Number(n.pending_item_count??0),expenses_total_eur:Number(n.expenses_total_eur??0),expenses_pending_eur:Number(n.expenses_pending_eur??0),expenses_breakdown:n.expenses_breakdown??[],breakdown_by_category:n.breakdown_by_category??{},individual_amounts:n.individual_amounts??[],user_can_see_all:!!n.user_can_see_all}:null},enabled:!!s,staleTime:30*1e3})}const da=({jobId:s,jobTitle:a})=>{var t;const{data:r,isLoading:n,error:c}=oa(s);if(n)return e.jsx(S,{children:e.jsx(E,{className:"flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(X,{className:"h-8 w-8 mx-auto text-muted-foreground animate-spin mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading job totals..."})]})})});if(c||!r)return e.jsx(S,{children:e.jsx(E,{className:"flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ns,{className:"h-8 w-8 mx-auto text-muted-foreground mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Unable to load job totals"})]})})});const p=Object.entries(r.breakdown_by_category||{}),u=r.total_approved_eur>0,o=r.total_pending_eur>0||r.pending_item_count>0||r.expenses_pending_eur>0;return e.jsxs(S,{children:[e.jsx(I,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5"}),"Job Cost Summary",a&&e.jsxs("span",{className:"text-sm font-normal text-muted-foreground",children:["- ",a]})]})}),e.jsxs(E,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 rounded-lg border bg-green-50 border-green-200",children:[e.jsx("p",{className:"text-sm text-green-700 font-medium",children:"Approved Total"}),e.jsxs("p",{className:"text-2xl font-bold text-green-800",children:["€",r.total_approved_eur.toFixed(2)]}),r.expenses_total_eur>0&&e.jsxs("p",{className:"text-xs text-green-700 mt-1",children:["Includes €",r.expenses_total_eur.toFixed(2)," in approved expenses"]})]}),o&&e.jsxs("div",{className:"p-4 rounded-lg border bg-yellow-50 border-yellow-200",children:[e.jsx("p",{className:"text-sm text-yellow-700 font-medium",children:"Pending Submissions"}),e.jsxs("p",{className:"text-2xl font-bold text-yellow-800",children:["€",r.total_pending_eur.toFixed(2)]}),e.jsxs("p",{className:"text-xs text-yellow-700 mt-1",children:[r.pending_item_count," item",r.pending_item_count===1?"":"s"," awaiting review"]}),r.expenses_pending_eur>0&&e.jsxs("p",{className:"text-xs text-yellow-700",children:["€",r.expenses_pending_eur.toFixed(2)," of the pending total comes from expenses"]})]})]}),u&&p.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx(Qs,{className:"h-4 w-4"}),"Breakdown by Category"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:p.map(([m,l])=>e.jsxs("div",{className:"p-3 rounded-lg border",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(se,{variant:"outline",className:"capitalize",children:m}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[Number(l.count??0)," timesheet",Number(l.count??0)!==1?"s":""]})]}),e.jsxs("p",{className:"text-lg font-bold",children:["€",Number(l.total_eur??0).toFixed(2)]})]},m))})]}),r.user_can_see_all&&((t=r.individual_amounts)==null?void 0:t.length)>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Individual Timesheet Details"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:r.individual_amounts.map((m,l)=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded border bg-muted/50",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-sm",children:m.technician_name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(se,{variant:"outline",className:"text-xs px-1 py-0",children:m.category}),e.jsx("span",{children:Z(new Date(m.date),"d MMM",{locale:me})})]})]}),e.jsxs("p",{className:"font-semibold",children:["€",Number(m.amount_eur??0).toFixed(2)]})]},l))})]}),!u&&e.jsxs("div",{className:"text-center p-6 text-muted-foreground",children:[e.jsx(ns,{className:"h-8 w-8 mx-auto mb-2"}),e.jsx("p",{children:"No approved timesheets with calculated amounts yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Totals will appear once timesheets are approved by management"})]})]})]})};function ma({jobId:s,filterTechnicianId:a}){const{user:r,userRole:n}=he(),c=n==="technician"||n==="house_tech",{data:p=[],isLoading:u,error:o}=Ks(s,c?r==null?void 0:r.id:void 0),{data:t}=ms(s),{data:m=[]}=ye({queryKey:["job-assignments-names",s],queryFn:async()=>{const{data:v,error:C}=await Q.from("job_assignments").select("technician_id, profiles:technician_id ( first_name, last_name )").eq("job_id",s);if(C)throw C;return v||[]},enabled:!!s&&!c,staleTime:60*1e3}),l=v=>{var B,W;const C=m.find(Y=>Y.technician_id===v),N=((B=C==null?void 0:C.profiles)==null?void 0:B.first_name)||"",G=((W=C==null?void 0:C.profiles)==null?void 0:W.last_name)||"";return`${N} ${G}`.trim()||`Tech ${v.slice(0,8)}…`},[j,M]=g.useState(null);if(g.useEffect(()=>{a?M(a):!c&&p.length&&!j&&M(p[0].technician_id)},[c,p,j,a]),u)return e.jsxs(S,{children:[e.jsx(I,{children:e.jsxs(J,{className:"flex items-center gap-2 text-base",children:[e.jsx(be,{className:"h-5 w-5"})," ",c?"My Total For This Job":"Technician Total For This Job"]})}),e.jsx(E,{children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading…"})})]});const P=(t==null?void 0:t.rates_approved)??!1;if(c&&!P||o||p.length===0)return e.jsxs(S,{children:[e.jsx(I,{children:e.jsxs(J,{className:"flex items-center gap-2 text-base",children:[e.jsx(be,{className:"h-5 w-5"})," ",c?"My Total For This Job":"Technician Total For This Job"]})}),e.jsx(E,{children:c&&!P?e.jsxs("div",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[e.jsx(la,{className:"h-4 w-4"}),"Rates for this job are pending approval by management."]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No approved amounts yet."})})]});const H=c?p[0]:p.find(v=>v.technician_id===j)||p[0],K=H.timesheets_total_eur||0,$=H.extras_total_eur||0,z=H.expenses_total_eur||0,A=H.total_eur||0;return e.jsxs(S,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center justify-between gap-2 flex-wrap",children:[e.jsxs(J,{className:"flex items-center gap-2 text-base",children:[e.jsx(be,{className:"h-5 w-5"})," ",c?"Mi Total Para Este Trabajo":"Total del Técnico Para Este Trabajo"]}),!c&&p.length>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(us,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(re,{value:j??void 0,onValueChange:v=>M(v),children:[e.jsx(ne,{className:"w-[220px]",children:e.jsx(ie,{placeholder:"Seleccionar técnico"})}),e.jsx(le,{children:p.map(v=>e.jsx(U,{value:v.technician_id,children:l(v.technician_id)},v.technician_id))})]})]})]})}),e.jsxs(E,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsxs("div",{children:["Partes: ",e.jsx("span",{className:"font-medium text-foreground",children:ce(K)})]}),$>0&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(De,{className:"h-3 w-3"})," Extras: ",e.jsx("span",{className:"font-medium text-foreground",children:ce($)})]}),z>0&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(De,{className:"h-3 w-3"})," Gastos: ",e.jsx("span",{className:"font-medium text-foreground",children:ce(z)})]})]}),e.jsx(se,{variant:"default",className:"text-base px-4 py-2",children:ce(A)})]})]})}async function ua(s){try{const{data:{session:a},error:r}=await Q.auth.getSession();if(r||!a)return{success:!1,error:"You must be logged in to send reminder emails"};const{data:n,error:c}=await Q.functions.invoke("send-timesheet-reminder",{body:{timesheetId:s}});return c?{success:!1,error:c.message||"Failed to send reminder email"}:n.success?{success:!0,messageId:n.messageId,sentTo:n.sentTo}:{success:!1,error:n.error||"Failed to send reminder email"}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error occurred"}}}const x={labels:{date:"Fecha del gasto",category:"Categoría",amount:"Importe",currency:"Divisa",description:"Descripción",receipt:"Recibo"},placeholders:{category:"Seleccionar categoría",amount:"0.00",description:"Detalles del gasto (opcional)"},status:{draft:"Borrador",submitted:"Enviado",approved:"Aprobado",rejected:"Rechazado"},actions:{submit:"Enviar gasto",delete:"Eliminar",cancel:"Cancelar",uploadReceipt:"Subir recibo"},errors:{dateRequired:"La fecha es obligatoria",categoryRequired:"Debe seleccionar una categoría",amountPositive:"El importe debe ser mayor que 0",amountInvalid:"El importe no es válido",currencyRequired:"La divisa es obligatoria",receiptRequired:"Esta categoría requiere un recibo",receiptUploading:"Esperando a que termine la subida del recibo",permissionExpired:"El permiso para esta categoría ha expirado",permissionInactive:"El permiso aún no está activo",uploadFailed:"Error al subir el recibo",submitFailed:"Error al enviar el gasto",deleteFailed:"Error al eliminar el gasto"},success:{saved:"Borrador guardado correctamente",submitted:"Gasto enviado para aprobación",deleted:"Gasto eliminado"},empty:{noExpenses:"No tienes gastos para este trabajo",noPermissions:"No tienes permisos de gastos para este trabajo"},info:{receiptOptional:"El recibo es opcional para esta categoría",receiptRequired:"El recibo es obligatorio para esta categoría",uploading:"Subiendo recibo...",waitingUpload:"Esperando a que termine la subida",dailyCapInfo:(s,a,r="EUR")=>`Has usado ${s.toFixed(2)} ${r} de ${a.toFixed(2)} ${r} hoy`,totalCapInfo:(s,a,r="EUR")=>`Has usado ${s.toFixed(2)} ${r} de ${a.toFixed(2)} ${r} en total`,noCapInfo:"Sin límite establecido"},rejection:{title:"Motivo del rechazo"},totals:{pending:"Pendiente",approved:"Aprobado",total:"Total gastos",byCategory:"Por categoría"}},is=({status:s,className:a})=>{const n=(()=>{switch(s){case"draft":return{label:x.status.draft,variant:"secondary",icon:ia,className:"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300"};case"submitted":return{label:x.status.submitted,variant:"default",icon:X,className:"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300"};case"approved":return{label:x.status.approved,variant:"outline",icon:ps,className:"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300"};case"rejected":return{label:x.status.rejected,variant:"destructive",icon:Zs,className:"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300"};default:return{label:s,variant:"secondary",icon:X,className:""}}})(),c=n.icon;return e.jsxs(se,{variant:n.variant,className:`${n.className} ${a||""}`,children:[e.jsx(c,{className:"w-3 h-3 mr-1"}),n.label]})},xa=({value:s,isRequired:a=!1,isUploading:r=!1,uploadProgress:n=0,error:c,onChange:p,onRemove:u,onView:o,disabled:t=!1})=>{const[m,l]=g.useState(!1),j=pe.useRef(null),M=g.useCallback(v=>{v.preventDefault(),!t&&!r&&l(!0)},[t,r]),P=g.useCallback(v=>{v.preventDefault(),l(!1)},[]),H=g.useCallback(v=>{if(v.preventDefault(),l(!1),t||r)return;const C=Array.from(v.dataTransfer.files);if(C.length>0){const N=C[0];(N.type.startsWith("image/")||N.type==="application/pdf")&&p(N)}},[t,r,p]),K=g.useCallback(v=>{const C=v.target.files;C&&C.length>0&&p(C[0])},[p]),$=g.useCallback(()=>{!t&&!r&&j.current&&j.current.click()},[t,r]),z=g.useCallback(v=>{v.stopPropagation(),u&&u()},[u]),A=g.useCallback(v=>{v.stopPropagation(),o&&o()},[o]);return e.jsxs("div",{className:"space-y-2",children:[e.jsxs(F,{children:[x.labels.receipt,a&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),!s&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{onClick:$,onDragOver:M,onDragLeave:P,onDrop:H,className:qs("border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-colors",m&&"border-primary bg-primary/5",!m&&"border-gray-300 hover:border-gray-400 dark:border-gray-700 dark:hover:border-gray-600",t&&"opacity-50 cursor-not-allowed",c&&"border-red-500"),children:[e.jsx("input",{ref:j,type:"file",accept:"image/*,application/pdf",onChange:K,className:"hidden",disabled:t||r}),r?e.jsxs("div",{className:"space-y-3",children:[e.jsx(Ee,{className:"w-8 h-8 mx-auto text-primary animate-spin"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:x.info.uploading}),n>0&&e.jsx(Xs,{value:n,className:"w-full max-w-xs mx-auto"})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ys,{className:"w-8 h-8 mx-auto text-muted-foreground"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium",children:x.actions.uploadReceipt}),e.jsx("p",{className:"text-muted-foreground text-xs mt-1",children:"Arrastra una imagen o PDF aquí, o haz clic para seleccionar"})]})]})]}),!a&&!c&&e.jsx("p",{className:"text-xs text-muted-foreground",children:x.info.receiptOptional}),a&&!c&&e.jsx("p",{className:"text-xs text-orange-600 dark:text-orange-400",children:x.info.receiptRequired})]}),s&&!r&&e.jsxs("div",{className:"flex items-center gap-2 p-3 border rounded-lg bg-gray-50 dark:bg-gray-900",children:[e.jsx(xe,{className:"w-5 h-5 text-primary flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.split("/").pop()||"Recibo"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Subido"})]}),e.jsxs("div",{className:"flex gap-1",children:[o&&e.jsx(y,{type:"button",variant:"ghost",size:"sm",onClick:A,className:"h-8 w-8 p-0",children:e.jsx(hs,{className:"w-4 h-4"})}),u&&!t&&e.jsx(y,{type:"button",variant:"ghost",size:"sm",onClick:z,className:"h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20",children:e.jsx(cs,{className:"w-4 h-4"})})]})]}),c&&e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400",children:c})]})},ha=s=>{const{user:a}=he();return ye({queryKey:["expense-permissions",s,a==null?void 0:a.id],queryFn:async()=>{if(!s||!(a!=null&&a.id))return[];const{data:r,error:n}=await Q.from("expense_permissions").select(`
          id,
          job_id,
          technician_id,
          category_slug,
          valid_from,
          valid_to,
          daily_cap_eur,
          total_cap_eur,
          notes,
          category:expense_categories(
            slug,
            label_es,
            requires_receipt,
            default_daily_cap_eur,
            default_total_cap_eur
          )
        `).eq("job_id",s).eq("technician_id",a.id);if(n)throw n;return r||[]},enabled:!!s&&!!(a!=null&&a.id),staleTime:300*1e3})},pa=(s,a=new Date)=>{const r=a.toISOString().split("T")[0];return!(s.valid_from&&r<s.valid_from||s.valid_to&&r>s.valid_to)},ls=(s,a)=>{var r,n;return a==="daily"?s.daily_cap_eur??((r=s.category)==null?void 0:r.default_daily_cap_eur)??null:s.total_cap_eur??((n=s.category)==null?void 0:n.default_total_cap_eur)??null},ja=s=>{const{user:a,userRole:r}=he();return ye({queryKey:["job-expenses",s,a==null?void 0:a.id],queryFn:async()=>{if(!s||!(a!=null&&a.id))return[];let n=Q.from("job_expenses").select(`
          id,
          job_id,
          technician_id,
          category_slug,
          permission_id,
          expense_date,
          amount_original,
          currency_code,
          fx_rate,
          amount_eur,
          description,
          receipt_path,
          status,
          submitted_at,
          approved_at,
          rejected_at,
          rejection_reason,
          created_at,
          updated_at,
          category:expense_categories(label_es, requires_receipt)
        `).eq("job_id",s).order("expense_date",{ascending:!1}).order("created_at",{ascending:!1});(r==="technician"||r==="house_tech")&&(n=n.eq("technician_id",a.id));const{data:c,error:p}=await n;if(p)throw p;return c||[]},enabled:!!s&&!!(a!=null&&a.id)})},js=()=>{const s=Us(),{user:a}=he(),r=ve({mutationFn:async u=>{if(!(a!=null&&a.id))throw new Error("No authenticated user");const{data:o,error:t}=await Q.from("job_expenses").insert({...u,technician_id:a.id,status:"draft",created_by:a.id}).select().single();if(t)throw t;return o},onSuccess:(u,o)=>{s.invalidateQueries({queryKey:["job-expenses",o.job_id]}),oe.success(x.success.saved)},onError:u=>{oe.error(x.errors.submitFailed)}}),n=ve({mutationFn:async({id:u,jobId:o,data:t})=>{const{data:m,error:l}=await Q.from("job_expenses").update({...t,updated_at:new Date().toISOString()}).eq("id",u).eq("status","draft").select().single();if(l)throw l;return m},onSuccess:(u,o)=>{s.invalidateQueries({queryKey:["job-expenses",o.jobId]}),oe.success(x.success.saved)},onError:u=>{oe.error(x.errors.submitFailed)}}),c=ve({mutationFn:async u=>{if(!(a!=null&&a.id))throw new Error("No authenticated user");const{data:o,error:t}=await Q.rpc("submit_job_expense",{p_job_id:u.job_id,p_category_slug:u.category_slug,p_expense_date:u.expense_date,p_amount_original:u.amount_original,p_currency_code:u.currency_code,p_fx_rate:u.fx_rate||1,p_description:u.description||null,p_receipt_path:u.receipt_path||null});if(t)throw t;return o},onSuccess:(u,o)=>{s.invalidateQueries({queryKey:["job-expenses",o.job_id]}),s.invalidateQueries({queryKey:["job-totals"]}),oe.success(x.success.submitted)},onError:u=>{const o=u.message||x.errors.submitFailed;oe.error(o)}}),p=ve({mutationFn:async({id:u,jobId:o})=>{const{error:t}=await Q.from("job_expenses").delete().eq("id",u).eq("status","draft");if(t)throw t},onSuccess:(u,o)=>{s.invalidateQueries({queryKey:["job-expenses",o.jobId]}),oe.success(x.success.deleted)},onError:u=>{oe.error(x.errors.deleteFailed)}});return{createDraft:r,updateDraft:n,submitExpense:c,deleteExpense:p}},ga=()=>{const[s,a]=pe.useState(0),[r,n]=pe.useState(!1);return{uploadReceipt:async(p,u)=>{n(!0),a(0);try{const o=Date.now(),t=p.name.split(".").pop(),m=`${o}-${Math.random().toString(36).substring(7)}.${t}`,l=`job/${u}/${m}`;a(30);const{error:j}=await Q.storage.from("expense-receipts").upload(l,p,{cacheControl:"3600",upsert:!1});if(j)throw j;return a(100),l}catch(o){throw o}finally{n(!1),setTimeout(()=>a(0),1e3)}},progress:s,isUploading:r}},fa=Bs({expense_date:_e().min(1,x.errors.dateRequired),category_slug:_e().min(1,x.errors.categoryRequired),amount_original:Os.number({invalid_type_error:x.errors.amountInvalid}).positive(x.errors.amountPositive),currency_code:_e().min(3,x.errors.currencyRequired).max(3),description:_e().optional(),receipt_file:$s(File).optional().nullable()}),_a=({jobId:s,onSuccess:a,onCancel:r,defaultDate:n})=>{var ae;const{data:c=[],isLoading:p}=ha(s),{submitExpense:u}=js(),{uploadReceipt:o,progress:t,isUploading:m}=ga(),[l,j]=g.useState(null),[M,P]=g.useState(null),{register:H,handleSubmit:K,watch:$,setValue:z,formState:{errors:A,isSubmitting:v},reset:C}=Hs({resolver:Ls(fa),defaultValues:{expense_date:n||Z(new Date,"yyyy-MM-dd"),category_slug:"",amount_original:0,currency_code:"EUR",description:"",receipt_file:null}}),N=$("category_slug"),G=$("expense_date"),D=c.find(T=>T.category_slug===N),B=((ae=D==null?void 0:D.category)==null?void 0:ae.requires_receipt)||!1,W=D?pa(D,new Date(G||new Date)):!1,Y=D?ls(D,"daily"):null,ue=D?ls(D,"total"):null,h=async T=>{if(!T){j(null),z("receipt_file",null),P(null);return}try{P(null);const R=await o(T,s);j(R),z("receipt_file",T)}catch{P(x.errors.uploadFailed),j(null),z("receipt_file",null)}},b=()=>{j(null),z("receipt_file",null),P(null)},w=async T=>{if(B&&!l){P(x.errors.receiptRequired);return}if(m){P(x.errors.receiptUploading);return}try{await u.mutateAsync({job_id:s,category_slug:T.category_slug,expense_date:T.expense_date,amount_original:T.amount_original,currency_code:T.currency_code,description:T.description,receipt_path:l||void 0}),C(),j(null),P(null),a&&a()}catch{}};return p?e.jsx(S,{children:e.jsx(E,{className:"flex items-center justify-center py-8",children:e.jsx(Ee,{className:"w-6 h-6 animate-spin text-muted-foreground"})})}):c.length===0?e.jsx(S,{children:e.jsx(E,{className:"py-6",children:e.jsxs(Re,{children:[e.jsx(Me,{className:"h-4 w-4"}),e.jsx(Ae,{children:x.empty.noPermissions})]})})}):e.jsxs(S,{children:[e.jsx(I,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(De,{className:"w-5 h-5"}),"Nuevo Gasto"]})}),e.jsx(E,{children:e.jsxs("form",{onSubmit:K(w),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(F,{htmlFor:"expense_date",children:[x.labels.date,e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),e.jsx(ee,{id:"expense_date",type:"date",...H("expense_date"),className:A.expense_date?"border-red-500":""}),A.expense_date&&e.jsx("p",{className:"text-sm text-red-600",children:A.expense_date.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(F,{htmlFor:"category_slug",children:[x.labels.category,e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),e.jsxs(re,{value:N,onValueChange:T=>z("category_slug",T),children:[e.jsx(ne,{className:A.category_slug?"border-red-500":"",children:e.jsx(ie,{placeholder:x.placeholders.category})}),e.jsx(le,{children:c.map(T=>{var R;return e.jsx(U,{value:T.category_slug,children:((R=T.category)==null?void 0:R.label_es)||T.category_slug},T.id)})})]}),A.category_slug&&e.jsx("p",{className:"text-sm text-red-600",children:A.category_slug.message}),D&&!W&&e.jsxs(Re,{variant:"destructive",children:[e.jsx(Me,{className:"h-4 w-4"}),e.jsx(Ae,{children:D.valid_from&&G<D.valid_from?x.errors.permissionInactive:x.errors.permissionExpired})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"col-span-2 space-y-2",children:[e.jsxs(F,{htmlFor:"amount_original",children:[x.labels.amount,e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),e.jsx(ee,{id:"amount_original",type:"number",step:"0.01",min:"0",placeholder:x.placeholders.amount,...H("amount_original"),className:A.amount_original?"border-red-500":""}),A.amount_original&&e.jsx("p",{className:"text-sm text-red-600",children:A.amount_original.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"currency_code",children:x.labels.currency}),e.jsxs(re,{value:$("currency_code"),onValueChange:T=>z("currency_code",T),children:[e.jsx(ne,{children:e.jsx(ie,{})}),e.jsxs(le,{children:[e.jsx(U,{value:"EUR",children:"EUR"}),e.jsx(U,{value:"USD",children:"USD"}),e.jsx(U,{value:"GBP",children:"GBP"})]})]})]})]}),(Y!==null||ue!==null)&&e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1 p-3 bg-muted/50 rounded-md",children:[Y!==null&&e.jsx("p",{children:x.info.dailyCapInfo(0,Y)}),ue!==null&&e.jsx("p",{children:x.info.totalCapInfo(0,ue)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"description",children:x.labels.description}),e.jsx(Ne,{id:"description",placeholder:x.placeholders.description,rows:2,...H("description")})]}),e.jsx(xa,{value:l,isRequired:B,isUploading:m,uploadProgress:t,error:M||void 0,onChange:h,onRemove:b,disabled:v}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(y,{type:"submit",disabled:v||m||!W,className:"flex-1",children:v?e.jsxs(e.Fragment,{children:[e.jsx(Ee,{className:"w-4 h-4 mr-2 animate-spin"}),"Enviando..."]}):x.actions.submit}),r&&e.jsx(y,{type:"button",variant:"outline",onClick:r,children:x.actions.cancel})]})]})})]})},va=({expenses:s,groupBy:a="date",showActions:r=!0})=>{const{deleteExpense:n}=js(),{toast:c}=os(),p=(t,m)=>{n.mutate({id:t,jobId:m})},u=async t=>{try{const{data:m,error:l}=await Q.storage.from("expense-receipts").createSignedUrl(t,3600);if(l)throw l;m!=null&&m.signedUrl&&window.open(m.signedUrl,"_blank")}catch{c({title:"Error",description:"No se pudo cargar el recibo",variant:"destructive"})}},o=pe.useMemo(()=>{if(a==="status"){const t=new Map;return s.forEach(m=>{const l=m.status;t.has(l)||t.set(l,[]),t.get(l).push(m)}),Array.from(t.entries()).sort((m,l)=>{const j=["submitted","draft","approved","rejected"];return j.indexOf(m[0])-j.indexOf(l[0])})}else{const t=new Map;return s.forEach(m=>{const l=m.expense_date;t.has(l)||t.set(l,[]),t.get(l).push(m)}),Array.from(t.entries()).sort((m,l)=>l[0].localeCompare(m[0]))}},[s,a]);return s.length===0?e.jsx(S,{children:e.jsxs(E,{className:"py-8 text-center text-muted-foreground",children:[e.jsx(xe,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:x.empty.noExpenses})]})}):e.jsx("div",{className:"space-y-4",children:o.map(([t,m])=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 px-1",children:[a==="date"?e.jsx("h3",{className:"text-sm font-semibold",children:Z(new Date(t),"EEEE, d MMMM yyyy",{locale:me})}):e.jsx(is,{status:t}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",m.length,")"]})]}),e.jsx("div",{className:"space-y-2",children:m.map(l=>{var j;return e.jsx(S,{className:"overflow-hidden",children:e.jsx(E,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(se,{variant:"outline",className:"text-xs",children:((j=l.category)==null?void 0:j.label_es)||l.category_slug}),a!=="status"&&e.jsx(is,{status:l.status}),a!=="date"&&e.jsx("span",{className:"text-xs text-muted-foreground",children:Z(new Date(l.expense_date),"d MMM yyyy",{locale:me})})]}),e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("span",{className:"text-lg font-bold",children:ce(l.amount_eur)}),l.currency_code!=="EUR"&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",l.amount_original.toFixed(2)," ",l.currency_code,")"]})]}),l.description&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:l.description}),l.receipt_path&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(xe,{className:"w-3 h-3"}),e.jsx("span",{children:"Con recibo"})]}),l.status==="rejected"&&l.rejection_reason&&e.jsxs("div",{className:"flex gap-2 p-2 bg-red-50 dark:bg-red-900/20 rounded-md",children:[e.jsx(Me,{className:"w-4 h-4 text-red-600 dark:text-red-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-semibold text-red-900 dark:text-red-100",children:x.rejection.title}),e.jsx("p",{className:"text-xs text-red-700 dark:text-red-300",children:l.rejection_reason})]})]})]}),r&&e.jsxs("div",{className:"flex flex-col gap-1",children:[l.receipt_path&&e.jsx(y,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:()=>u(l.receipt_path),children:e.jsx(hs,{className:"w-4 h-4"})}),l.status==="draft"&&e.jsxs(qe,{children:[e.jsx(xs,{asChild:!0,children:e.jsx(y,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20",children:e.jsx(Fe,{className:"w-4 h-4"})})}),e.jsxs(Ue,{children:[e.jsxs(He,{children:[e.jsx(Le,{children:"¿Eliminar gasto?"}),e.jsx(Be,{children:"Esta acción no se puede deshacer. El gasto se eliminará permanentemente."})]}),e.jsxs($e,{children:[e.jsx(Oe,{children:x.actions.cancel}),e.jsx(Ve,{onClick:()=>p(l.id,l.job_id),className:"bg-red-600 hover:bg-red-700",children:x.actions.delete})]})]})]})]})]})})},l.id)})})]},t))})},ba=({expenses:s,className:a})=>{const r=pe.useMemo(()=>{const n=s.filter(t=>t.status==="submitted"||t.status==="draft").reduce((t,m)=>t+m.amount_eur,0),c=s.filter(t=>t.status==="approved").reduce((t,m)=>t+m.amount_eur,0),p=s.filter(t=>t.status==="submitted"||t.status==="draft").length,u=s.filter(t=>t.status==="approved").length,o=new Map;return s.filter(t=>t.status==="approved").forEach(t=>{var j;const m=t.category_slug,l=o.get(m)||{label:((j=t.category)==null?void 0:j.label_es)||m,total:0,count:0};o.set(m,{label:l.label,total:l.total+t.amount_eur,count:l.count+1})}),{pending:n,approved:c,total:n+c,pendingCount:p,approvedCount:u,totalCount:s.length,byCategory:Array.from(o.entries()).map(([t,m])=>({slug:t,...m})).sort((t,m)=>m.total-t.total)}},[s]);return s.length===0?e.jsxs(S,{className:a,children:[e.jsx(I,{children:e.jsxs(J,{className:"flex items-center gap-2 text-base",children:[e.jsx(Pe,{className:"w-4 h-4"}),x.totals.total]})}),e.jsx(E,{className:"text-center text-muted-foreground py-6",children:e.jsx("p",{className:"text-sm",children:x.empty.noExpenses})})]}):e.jsxs(S,{className:a,children:[e.jsx(I,{children:e.jsxs(J,{className:"flex items-center gap-2 text-base",children:[e.jsx(Pe,{className:"w-4 h-4"}),x.totals.total]})}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.pendingCount>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(X,{className:"w-3 h-3"}),e.jsx("span",{children:x.totals.pending})]}),e.jsx("p",{className:"text-lg font-bold text-blue-700 dark:text-blue-400",children:ce(r.pending)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r.pendingCount," ",r.pendingCount===1?"gasto":"gastos"]})]}),r.approvedCount>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(ps,{className:"w-3 h-3"}),e.jsx("span",{children:x.totals.approved})]}),e.jsx("p",{className:"text-lg font-bold text-green-700 dark:text-green-400",children:ce(r.approved)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r.approvedCount," ",r.approvedCount===1?"gasto":"gastos"]})]})]}),r.byCategory.length>0&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"pt-2",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground mb-2",children:x.totals.byCategory}),e.jsx("div",{className:"space-y-2",children:r.byCategory.map(n=>e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx(se,{variant:"outline",className:"text-xs",children:n.label}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",n.count,")"]})]}),e.jsx("span",{className:"font-semibold",children:ce(n.total)})]},n.slug))})]})}),r.totalCount>1&&e.jsx("div",{className:"pt-2 border-t",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-semibold",children:"Total"}),e.jsx("span",{className:"text-xl font-bold",children:ce(r.total)})]})})]})]})},Na=({formData:s,setFormData:a,onSave:r,onCancel:n})=>e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"start_time",children:"Hora de Inicio"}),e.jsx(ee,{id:"start_time",type:"time",value:s.start_time,onChange:c=>a({...s,start_time:c.target.value})})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"end_time",children:"Hora de Fin"}),e.jsx(ee,{id:"end_time",type:"time",value:s.end_time,onChange:c=>a({...s,end_time:c.target.value})})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"break_minutes",children:"Descanso (minutos)"}),e.jsx(ee,{id:"break_minutes",type:"number",value:s.break_minutes,onChange:c=>a({...s,break_minutes:parseInt(c.target.value)||0})}),e.jsx("p",{className:"text-[10px] text-muted-foreground mt-1",children:"Solo para descansos por convenio o montajes/desmontajes, no para comidas."})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-6",children:[e.jsx("input",{id:"ends_next_day",type:"checkbox",checked:!!s.ends_next_day,onChange:c=>a({...s,ends_next_day:c.target.checked})}),e.jsx(F,{htmlFor:"ends_next_day",children:"Termina al día siguiente"}),s.end_time<s.start_time&&e.jsx(se,{variant:"secondary",className:"ml-2 bg-blue-100 text-blue-800",children:"Auto-detectado"})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"category",children:"Categoría"}),e.jsxs(re,{value:s.category,onValueChange:c=>a({...s,category:c}),children:[e.jsx(ne,{children:e.jsx(ie,{placeholder:"Seleccionar categoría"})}),e.jsxs(le,{children:[e.jsx(U,{value:"tecnico",children:"técnico"}),e.jsx(U,{value:"especialista",children:"especialista"}),e.jsx(U,{value:"responsable",children:"responsable"})]})]})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"overtime_hours",children:"Horas Extra"}),e.jsx(ee,{id:"overtime_hours",type:"number",step:"0.5",value:s.overtime_hours,onChange:c=>a({...s,overtime_hours:parseFloat(c.target.value)||0})})]}),e.jsxs("div",{className:"col-span-2 md:col-span-4",children:[e.jsx(F,{htmlFor:"notes",children:"Notas"}),e.jsx(Ne,{id:"notes",value:s.notes,onChange:c=>a({...s,notes:c.target.value}),placeholder:"Notas adicionales..."})]}),e.jsxs("div",{className:"col-span-2 md:col-span-4 flex gap-2",children:[e.jsx(y,{onClick:r,children:"Guardar Cambios"}),e.jsx(y,{variant:"outline",onClick:n,children:"Cancelar"})]})]}),ya=({timesheet:s,rejectionNotes:a,onRejectionNotesChange:r,onClose:n,onConfirm:c})=>e.jsx(qe,{open:!!s,onOpenChange:p=>{p||n()},children:e.jsxs(Ue,{children:[e.jsxs(He,{children:[e.jsx(Le,{children:"Rechazar parte de trabajo"}),e.jsx(Be,{children:"Proporcione una nota breve para que el técnico sepa qué debe corregirse antes de volver a enviar."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"rejection-notes",className:"text-sm font-medium",children:"Notas de rechazo"}),e.jsx(Ne,{id:"rejection-notes",placeholder:"Por favor ajuste la hora de finalización...",value:a,onChange:p=>r(p.target.value),minLength:0})]}),e.jsxs($e,{children:[e.jsx(Oe,{onClick:n,children:"Cancelar"}),e.jsx(Ve,{onClick:c,disabled:!s,children:"Rechazar parte"})]})]})});function wa(s,a,r,n){const c=new Date(`2000-01-01T${s}`);let u=new Date(`2000-01-01T${a}`).getTime()-c.getTime();(n||u<0)&&(u+=1440*60*1e3);const t=u/(1e3*60*60)-r/60;return Math.max(0,t)}const Ca=({jobId:s,jobTitle:a,canManage:r=!1,filterDepartment:n,filterTechnicianId:c,filterDate:p})=>{const{user:u,userRole:o}=he(),{timesheets:t,isLoading:m,updateTimesheet:l,submitTimesheet:j,approveTimesheet:M,rejectTimesheet:P,signTimesheet:H,deleteTimesheet:K,deleteTimesheets:$,recalcTimesheet:z,revertTimesheet:A,refetch:v}=ds(s,{userRole:o}),{assignments:C}=Js(s),{toast:N}=os(),{data:G=[]}=ja(s),{data:D}=ms(s),[B,W]=g.useState(!1),[Y,ue]=g.useState(Z(new Date,"yyyy-MM-dd")),[h,b]=g.useState(null),[w,ae]=g.useState(new Set),[T,R]=g.useState(!1),[je,we]=g.useState(!1),[k,ge]=g.useState(!1),[_,te]=g.useState({start_time:"",end_time:"",break_minutes:void 0,overtime_hours:void 0,notes:"",ends_next_day:!1}),[q,fe]=g.useState({date:Y,start_time:"09:00",end_time:"17:00",break_minutes:30,overtime_hours:0,notes:"",ends_next_day:!1,category:void 0}),[Ce,Ie]=g.useState(null),[Je,ke]=g.useState(""),[Ge,Qe]=g.useState(null),Se=g.useMemo(()=>{if(!t||!u)return[];let i=t;return(o==="technician"||o==="house_tech")&&(i=i.filter(f=>f.technician_id===u.id)),n&&n!=="all"&&(i=i.filter(f=>{var d;return((d=f.technician)==null?void 0:d.department)===n})),c&&c!=="all"&&(i=i.filter(f=>f.technician_id===c)),p&&(i=i.filter(f=>f.date===p)),i},[t,o,u,n,c,p]),gs=i=>{switch(i){case"draft":return"secondary";case"submitted":return"default";case"approved":return"outline";case"rejected":return"destructive";default:return"secondary"}},fs=i=>({draft:"Borrador",submitted:"Enviado",approved:"Aprobado",rejected:"Rechazado"})[i]||i,_s=async i=>{h&&(await l(h,{start_time:q.start_time,end_time:q.end_time,break_minutes:q.break_minutes,overtime_hours:q.overtime_hours,notes:q.notes,ends_next_day:q.ends_next_day,category:q.category}),b(null))},vs=i=>{b(i.id),fe({date:i.date,start_time:i.start_time||"09:00",end_time:i.end_time||"17:00",break_minutes:i.break_minutes||0,overtime_hours:i.overtime_hours||0,notes:i.notes||"",ends_next_day:i.ends_next_day||!1,category:i.category||void 0})};g.useEffect(()=>{if(h&&q.start_time&&q.end_time){const i=q.end_time<q.start_time;i&&!q.ends_next_day?fe(f=>({...f,ends_next_day:!0})):!i&&q.ends_next_day&&fe(f=>({...f,ends_next_day:!1}))}},[q.start_time,q.end_time,h]),g.useEffect(()=>{if(je&&_.start_time&&_.end_time){const i=_.end_time<_.start_time;i&&!_.ends_next_day?te(f=>({...f,ends_next_day:!0})):!i&&_.ends_next_day&&te(f=>({...f,ends_next_day:!1}))}},[_.start_time,_.end_time,je]);const bs=i=>{Ie(i),ke(i.rejection_reason??"")},Ke=()=>{Ie(null),ke("")},Ns=async()=>{Ce&&(await P(Ce.id,Je.trim()||void 0),Ke())},ys=async i=>{Qe(i);try{const f=await ua(i);f.success?N({title:"Recordatorio enviado",description:`Email enviado a ${f.sentTo}`}):N({title:"Error al enviar recordatorio",description:f.error||"No se pudo enviar el email",variant:"destructive"})}catch{N({title:"Error al enviar recordatorio",description:"Ocurrió un error inesperado",variant:"destructive"})}finally{Qe(null)}},Te=async i=>{if(w.size===0)return;ge(!0);const f=Array.from(w);try{if(i==="delete")await $(f);else{const d=f.map(V=>{if(i==="submit")return j(V);if(i==="approve")return M(V)});await Promise.all(d)}ae(new Set),R(!1),setTimeout(()=>{v()},500)}catch{}finally{ge(!1)}},ws=async()=>{ge(!0);try{const i=Array.from(w).map(d=>{const V={};return _.start_time&&(V.start_time=_.start_time),_.end_time&&(V.end_time=_.end_time),_.break_minutes!==void 0&&(V.break_minutes=_.break_minutes),_.overtime_hours!==void 0&&(V.overtime_hours=_.overtime_hours),_.notes&&(V.notes=_.notes),_.ends_next_day!==void 0&&(V.ends_next_day=_.ends_next_day),l(d,V,!0)}),f=await Promise.all(i);await v(),ae(new Set),R(!1),we(!1),te({start_time:"",end_time:"",break_minutes:void 0,overtime_hours:void 0,notes:"",ends_next_day:!1})}catch{}finally{ge(!1)}},Cs=i=>{const f=new Set(w);f.has(i)?f.delete(i):f.add(i),ae(f),R(f.size>0)},ks=()=>{const i=Se.map(f=>f.id);ae(new Set(i)),R(i.length>0)},We=()=>{ae(new Set),R(!1),we(!1)},Xe=Se.reduce((i,f)=>{const d=f.date;return i[d]||(i[d]=[]),i[d].push(f),i},{}),O=o==="admin"||o==="management",L=o==="technician"||o==="house_tech",Ss=(D==null?void 0:D.rates_approved)??!1,Ts=!L||Ss;return m?e.jsx("div",{className:"flex items-center justify-center p-8",children:"Cargando partes de trabajo..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(da,{jobId:s,jobTitle:a}),e.jsx(ma,{jobId:s,filterTechnicianId:c==="all"?void 0:c}),Ts&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(Pe,{className:"h-6 w-6"}),L?"Mis Gastos":"Gastos"]}),L&&e.jsx(y,{onClick:()=>W(!B),variant:B?"outline":"default",children:B?"Cerrar":"Nuevo Gasto"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[L&&B&&e.jsx("div",{className:"lg:col-span-2",children:e.jsx(_a,{jobId:s,onSuccess:()=>W(!1),onCancel:()=>W(!1)})}),e.jsx("div",{className:B&&L?"":"lg:col-span-1",children:e.jsx(ba,{expenses:G})}),e.jsx("div",{className:B&&L?"lg:col-span-1":"lg:col-span-2",children:e.jsx(va,{expenses:G,showActions:L})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(X,{className:"h-6 w-6"}),L?"Mis Partes de Trabajo":"Partes de Trabajo"]}),a&&e.jsxs("p",{className:"text-muted-foreground",children:["Trabajo: ",a]})]}),O&&Se.length>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[T&&e.jsxs(e.Fragment,{children:[e.jsxs(y,{variant:"outline",size:"sm",onClick:()=>{we(!je)},disabled:k,children:["Editar Tiempos (",w.size,")"]}),e.jsxs(y,{variant:"outline",size:"sm",onClick:()=>Te("submit"),disabled:w.size===0||k,children:["Enviar Seleccionados (",w.size,")"]}),e.jsxs(y,{size:"sm",onClick:()=>Te("approve"),disabled:w.size===0||k,children:["Aprobar Seleccionados (",w.size,")"]}),e.jsxs(y,{variant:"destructive",size:"sm",onClick:()=>Te("delete"),disabled:w.size===0||k,children:[e.jsx(Fe,{className:"h-4 w-4 mr-1"}),"Eliminar Seleccionados (",w.size,")"]}),e.jsx(y,{variant:"outline",size:"sm",onClick:We,disabled:k,children:"Limpiar"})]}),e.jsx(y,{variant:"outline",size:"sm",onClick:w.size>0?We:ks,disabled:k,children:w.size>0?"Deseleccionar Todo":"Seleccionar Todo"})]})]}),je&&w.size>0&&e.jsx(S,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Editar Tiempos para ",w.size," Partes Seleccionados",k&&e.jsx("span",{className:"text-sm text-muted-foreground ml-2",children:"(Actualizando...)"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"bulk_start_time",children:"Hora de Inicio"}),e.jsx(ee,{id:"bulk_start_time",type:"time",value:_.start_time,onChange:i=>te({..._,start_time:i.target.value}),placeholder:"Dejar vacío para omitir",disabled:k})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"bulk_end_time",children:"Hora de Fin"}),e.jsx(ee,{id:"bulk_end_time",type:"time",value:_.end_time,onChange:i=>te({..._,end_time:i.target.value}),placeholder:"Dejar vacío para omitir",disabled:k})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"bulk_break_minutes",children:"Descanso (minutos)"}),e.jsx(ee,{id:"bulk_break_minutes",type:"number",value:_.break_minutes||"",onChange:i=>te({..._,break_minutes:i.target.value?parseInt(i.target.value):void 0}),placeholder:"Dejar vacío para omitir",disabled:k}),e.jsx("p",{className:"text-[10px] text-muted-foreground mt-1",children:"Solo para descansos por convenio o montajes/desmontajes, no para comidas."})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"bulk_overtime_hours",children:"Horas Extra"}),e.jsx(ee,{id:"bulk_overtime_hours",type:"number",step:"0.5",value:_.overtime_hours||"",onChange:i=>te({..._,overtime_hours:i.target.value?parseFloat(i.target.value):void 0}),placeholder:"Dejar vacío para omitir",disabled:k})]}),e.jsx("div",{className:"flex flex-col justify-end gap-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"bulk_ends_next_day",type:"checkbox",checked:!!_.ends_next_day,onChange:i=>te({..._,ends_next_day:i.target.checked}),disabled:k}),e.jsx(F,{htmlFor:"bulk_ends_next_day",children:"Termina al día siguiente"}),_.end_time&&_.start_time&&_.end_time<_.start_time&&e.jsx(se,{variant:"secondary",className:"ml-2 bg-blue-100 text-blue-800",children:"Auto-detectado"})]})}),e.jsx("div",{className:"flex items-end",children:e.jsx(y,{onClick:()=>{ws()},className:"w-full",disabled:k,children:k?"Actualizando...":"Aplicar Cambios"})})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"bulk_notes",children:"Notas (se añadirán a las notas existentes)"}),e.jsx(Ne,{id:"bulk_notes",value:_.notes,onChange:i=>te({..._,notes:i.target.value}),placeholder:"Dejar vacío para omitir añadir notas",disabled:k})]})]})}),k&&e.jsx(S,{children:e.jsx(E,{className:"flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(X,{className:"h-12 w-12 mx-auto text-muted-foreground animate-spin mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Actualizando partes de trabajo..."}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Por favor espere mientras actualizamos todos los partes seleccionados"})]})})}),!C.length&&O&&e.jsx(S,{children:e.jsx(E,{className:"flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(us,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"No hay técnicos asignados a este trabajo"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Asigne técnicos a este trabajo para generar partes automáticamente"})]})})}),m&&C.length>0&&e.jsx(S,{children:e.jsx(E,{className:"flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(X,{className:"h-12 w-12 mx-auto text-muted-foreground animate-spin mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Cargando partes de trabajo..."}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:L?"Cargando sus partes de trabajo...":"Creando partes para los técnicos asignados..."})]})})}),Object.entries(Xe).length===0&&!m&&e.jsx(S,{children:e.jsx(E,{className:"flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(xe,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:L?"No se encontraron partes de trabajo para usted en este trabajo":"Los partes se están generando..."}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:L?"Sus partes de trabajo aparecerán aquí una vez que sean creados por la dirección":"Los partes se crean automáticamente para todos los técnicos asignados"})]})})}),Object.entries(Xe).map(([i,f])=>e.jsxs(S,{children:[e.jsx(I,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(ea,{className:"h-5 w-5"}),e.jsx("span",{className:"capitalize",children:Z(Vs(i),"EEEE, d 'de' MMMM, yyyy",{locale:me})})]})}),e.jsx(E,{className:"space-y-4",children:f.map(d=>{var Ze,es,ss,as;const V=["draft","rejected"],Es=L?d.technician_id===(u==null?void 0:u.id)&&V.includes(d.status):O&&V.includes(d.status),Ye=["draft","rejected"],Fs=L?d.technician_id===(u==null?void 0:u.id)&&Ye.includes(d.status):O&&Ye.includes(d.status);return e.jsxs("div",{className:"border rounded-lg p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[O&&e.jsx("input",{type:"checkbox",checked:w.has(d.id),onChange:()=>Cs(d.id),className:"h-4 w-4",disabled:k}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:L?"Mi Parte de Trabajo":`${(Ze=d.technician)==null?void 0:Ze.first_name} ${(es=d.technician)==null?void 0:es.last_name}`}),!L&&e.jsx("p",{className:"text-sm text-muted-foreground",children:(ss=d.technician)==null?void 0:ss.department})]}),e.jsx(se,{variant:gs(d.status),children:fs(d.status)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Es&&e.jsx(y,{variant:"outline",size:"sm",onClick:()=>vs(d),disabled:k,children:"Editar"}),O&&d.status!=="approved"&&e.jsxs(y,{variant:"outline",size:"sm",onClick:()=>ys(d.id),disabled:Ge===d.id||k,className:"border-blue-500 text-blue-600 hover:bg-blue-50",children:[e.jsx(sa,{className:"h-4 w-4 mr-1"}),Ge===d.id?"Enviando...":"Recordatorio"]}),Fs&&e.jsx(y,{variant:"default",size:"default",className:"bg-green-600 hover:bg-green-700 font-semibold shadow-md",onClick:()=>j(d.id),disabled:k,children:"✓ ENVIAR PARTE"}),O&&d.status==="submitted"&&e.jsxs(e.Fragment,{children:[e.jsx(y,{size:"sm",onClick:()=>M(d.id),disabled:k,children:"Aprobar"}),e.jsx(y,{variant:"outline",size:"sm",onClick:()=>bs(d),disabled:k,children:"Rechazar"})]}),O&&d.status==="approved"&&e.jsx(y,{variant:"outline",size:"sm",onClick:()=>A(d.id),disabled:k,className:"border-orange-500 text-orange-600 hover:bg-orange-50",children:"Revertir Aprobación"}),O&&e.jsxs(qe,{children:[e.jsx(xs,{asChild:!0,children:e.jsx(y,{variant:"destructive",size:"sm",disabled:k,children:e.jsx(Fe,{className:"h-4 w-4"})})}),e.jsxs(Ue,{children:[e.jsxs(He,{children:[e.jsx(Le,{children:"¿De verdad quieres hacer esto?"}),e.jsx(Be,{children:'Vale, vale... eliminar este parte de trabajo es irreversible. No me vengas luego llorando porque "ay, que lo borré sin querer". Una vez que le des a confirmar, adiós muy buenas. ¿Seguro que quieres seguir adelante con esta genialidad?'})]}),e.jsxs($e,{children:[e.jsx(Oe,{children:"No, mejor no"}),e.jsx(Ve,{onClick:()=>K(d.id),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Sí, elimínalo"})]})]})]})]})]}),d.status==="rejected"&&e.jsxs(Re,{variant:"destructive",children:[e.jsxs(Ws,{className:"flex items-center gap-2",children:[e.jsx(aa,{className:"h-4 w-4"}),"Parte rechazado"]}),e.jsx(Ae,{children:(as=d.rejection_reason)!=null&&as.length?d.rejection_reason:"Por favor revise las horas y vuelva a enviar para su aprobación."})]}),h===d.id?e.jsx(Na,{formData:q,setFormData:fe,onSave:()=>_s(),onCancel:()=>b(null)}):e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Hora de Inicio"}),e.jsx("p",{className:"font-medium",children:d.start_time||"No establecido"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Hora de Fin"}),e.jsx("p",{className:"font-medium",children:d.end_time||"No establecido"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Descanso"}),e.jsxs("p",{className:"font-medium",children:[d.break_minutes||0," min"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Horas Totales"}),e.jsxs("p",{className:"font-medium",children:[wa(d.start_time||"09:00",d.end_time||"17:00",d.break_minutes||0,d.ends_next_day).toFixed(1),"h"]})]}),d.ends_next_day&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Cruza medianoche"}),e.jsx("p",{className:"font-medium",children:"Sí"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Categoría"}),e.jsx("p",{className:"font-medium",children:d.category||"No establecido"})]}),d.notes&&e.jsxs("div",{className:"col-span-2 md:col-span-4",children:[e.jsx("p",{className:"text-muted-foreground",children:"Notas"}),e.jsx("p",{className:"font-medium",children:d.notes})]})]}),(()=>{const ts=!!d.amount_breakdown_visible;return O||o==="technician"&&ts||o==="house_tech"&&ts?e.jsxs("div",{className:"mt-4 p-3 rounded-md border",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("p",{className:"font-medium",children:"Cálculo de Tarifa"}),O&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{size:"sm",variant:"outline",onClick:()=>z(d.id),children:"Recalcular"}),!d.category&&e.jsx(se,{variant:"destructive",children:"Establecer categoría para calcular"})]})]}),(()=>{const de=O?d.amount_breakdown:d.amount_breakdown_visible;return de?e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Horas Redondeadas"}),e.jsxs("p",{className:"font-medium",children:[de.worked_hours_rounded||0,"h"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Cantidad Base"}),e.jsxs("p",{className:"font-medium",children:["€",(de.base_amount_eur??0).toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Horas Extra"}),e.jsxs("p",{className:"font-medium",children:[de.overtime_hours||0,"h × €",de.overtime_hour_eur||0]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Cantidad HE"}),e.jsxs("p",{className:"font-medium",children:["€",(de.overtime_amount_eur??0).toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Total"}),e.jsxs("p",{className:"font-semibold",children:["€",(de.total_eur??0).toFixed(2)]})]}),(o==="technician"||o==="house_tech")&&e.jsx("div",{className:"col-span-2 md:col-span-5 text-xs text-muted-foreground mt-1",children:"Notas: redondeo después de 30 minutos; pueden aplicarse algunas condiciones como descuentos de 30€ para autónomos según el contrato."})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:o==="technician"?"Pendiente de aprobación":"No hay cálculo disponible todavía"})})()]}):null})(),(d.status==="draft"||d.status==="submitted"||d.status==="rejected")&&e.jsx(ca,{timesheetId:d.id,currentSignature:d.signature_data,canSign:d.technician_id===(u==null?void 0:u.id)||O,onSigned:H})]},d.id)})})]},i)),e.jsx(ya,{timesheet:Ce,rejectionNotes:Je,onRejectionNotesChange:ke,onClose:Ke,onConfirm:Ns})]})};function jt(){const[s,a]=Is(),r=s.get("jobId"),[n,c]=g.useState(r||""),[p,u]=g.useState(Z(new Date,"yyyy-MM-dd")),{user:o,userRole:t}=he(),{data:m=[],isLoading:l}=ra(),{timesheets:j}=ds(n||"",{userRole:t}),M=t==="admin"||t==="management",P=t==="admin"||t==="management",[H,K]=g.useState("all"),[$,z]=g.useState("all"),[A,v]=g.useState("");g.useEffect(()=>{if(o!=null&&o.department&&M){const h=o.department;K(h)}},[o==null?void 0:o.department,M]),g.useEffect(()=>{r&&c(r)},[r]);const C=g.useMemo(()=>m.filter(b=>{const w=String(b.job_type||"").toLowerCase();return w==="dryhire"||w==="dry_hire"||w==="tourdate"?!1:Array.isArray(b.job_date_types)&&b.job_date_types.length>0?b.job_date_types.some(R=>(R==null?void 0:R.type)!=="off"&&(R==null?void 0:R.type)!=="travel"):!0}).sort((b,w)=>new Date(w.start_time).getTime()-new Date(b.start_time).getTime()),[m]),N=m.find(h=>h.id===n),G=N&&(N.job_type==="dryhire"||N.job_type==="tourdate"),D=g.useMemo(()=>j?Array.from(new Set(j.map(h=>{var b;return(b=h.technician)==null?void 0:b.department}).filter(Boolean))).sort():[],[j]),B=g.useMemo(()=>{if(!j)return[];const h=new Map;return j.forEach(b=>{b.technician&&h.set(b.technician.id,b.technician)}),Array.from(h.values()).sort((b,w)=>(b.first_name||"").localeCompare(w.first_name||""))},[j]),W=g.useMemo(()=>{if(!j)return[];const h=new Set(j.map(b=>b.date?b.date:b.start_time?b.start_time.split("T")[0]:null).filter(Boolean));return Array.from(h).sort().reverse()},[j]),Y=h=>{c(h),K(o!=null&&o.department&&M?o.department:"all"),z("all"),v("");const b=new URLSearchParams(s);h?b.set("jobId",h):b.delete("jobId"),a(b,{replace:!1})},ue=async()=>{if(N){if(j.length===0){alert("No se encontraron partes de horas para este trabajo");return}try{await ta({job:N,timesheets:j,date:"all-dates"})}catch{alert("No se pudo generar el PDF")}}};return l?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx(X,{className:"h-12 w-12 mx-auto text-muted-foreground animate-spin mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Cargando trabajos..."})]})}):e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 py-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-3",children:[e.jsx(X,{className:"h-8 w-8"}),"Gestión de partes de horas"]}),e.jsx("p",{className:"text-muted-foreground",children:"Gestiona partes de horas de los técnicos para los trabajos"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"min-w-[240px]",children:e.jsxs(re,{value:n,onValueChange:Y,children:[e.jsx(ne,{children:e.jsx(ie,{placeholder:"Selecciona un trabajo"})}),e.jsx(le,{children:C.map(h=>e.jsx(U,{value:h.id,children:h.title},h.id))})]})}),n&&P&&!G&&e.jsx(e.Fragment,{children:e.jsxs(y,{onClick:ue,variant:"outline",className:"flex items-center gap-2",children:[e.jsx(na,{className:"h-4 w-4"}),"Descargar PDF"]})})]})]}),!n&&!l&&e.jsxs(S,{children:[e.jsx(I,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5"}),"Selecciona un trabajo para ver los partes"]})}),e.jsx(E,{children:e.jsx("div",{className:"max-w-sm",children:e.jsxs(re,{value:n,onValueChange:Y,children:[e.jsx(ne,{children:e.jsx(ie,{placeholder:"Selecciona un trabajo"})}),e.jsx(le,{children:C.map(h=>e.jsx(U,{value:h.id,children:h.title},h.id))})]})})})]}),N&&e.jsxs(S,{children:[e.jsx(I,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"h-5 w-5"}),"Detalles del trabajo"]})}),e.jsx(E,{children:e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsx("h3",{className:"font-medium mb-2",children:N.title}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Inicio"}),e.jsx("p",{children:Z(new Date(N.start_time),"PPP",{locale:me})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Fin"}),e.jsx("p",{children:Z(new Date(N.end_time),"PPP",{locale:me})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Tipo"}),e.jsx("p",{className:"capitalize",children:N.job_type})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Estado"}),e.jsx("p",{className:"capitalize",children:N.status||"Activo"})]})]})]})})]}),G&&N&&e.jsxs(S,{children:[e.jsx(I,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5"}),"Partes deshabilitados"]})}),e.jsx(E,{children:e.jsx("div",{className:"p-4 bg-muted rounded-lg",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["No se utilizan partes de horas para trabajos de tipo",e.jsxs("span",{className:"font-medium",children:[" ",N.job_type]}),"."]})})})]}),n&&!G&&M&&e.jsxs(S,{children:[e.jsx(I,{className:"pb-3",children:e.jsxs(J,{className:"text-lg flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4"}),"Filtros"]})}),e.jsx(E,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Departamento"}),e.jsxs(re,{value:H,onValueChange:K,children:[e.jsx(ne,{children:e.jsx(ie,{placeholder:"Todos los departamentos"})}),e.jsxs(le,{children:[e.jsx(U,{value:"all",children:"Todos los departamentos"}),D.map(h=>e.jsx(U,{value:h,children:h},h))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Técnico"}),e.jsxs(re,{value:$,onValueChange:z,children:[e.jsx(ne,{children:e.jsx(ie,{placeholder:"Todos los técnicos"})}),e.jsxs(le,{children:[e.jsx(U,{value:"all",children:"Todos los técnicos"}),B.map(h=>e.jsxs(U,{value:h.id,children:[h.first_name," ",h.last_name]},h.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Fecha"}),e.jsx("label",{className:"text-sm font-medium",children:"Fecha"}),e.jsxs(re,{value:A,onValueChange:v,children:[e.jsx(ne,{children:e.jsx(ie,{placeholder:"Todas las fechas"})}),e.jsxs(le,{children:[e.jsx(U,{value:"all",children:"Todas las fechas"}),W.map(h=>e.jsx(U,{value:h,children:Z(new Date(h),"d 'de' MMMM",{locale:me})},h))]})]})]})]})})]}),n&&!G&&e.jsx(Ca,{jobId:n,jobTitle:N==null?void 0:N.title,canManage:M,filterDepartment:H,filterTechnicianId:$,filterDate:A})]})}export{jt as default};
