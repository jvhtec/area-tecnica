import{l as Ce,i as Le,j as e,L as K,B as ae,X as Re,S as O,t as J,v as Z,w as ee,x as se,I as me,a as qe,e as Pe,f as Te,r as w,C as Fe,W as Me,Y as Ie,A as Ee,s as I}from"./index-NZ6jJLfQ.js";import{T as Ke,a as $e,b as U,c as W}from"./tabs-BdaywI_b.js";import{S as _e}from"./scroll-area-BHjMXddA.js";import{a as De}from"./lazyPdf-xVUlxKNu.js";import{C as He}from"./checkbox-BsRNEGV1.js";import{P as ze}from"./plus-C3JQqq7t.js";import{S as Be}from"./save-z_re-Mcq.js";import{F as Ve}from"./file-text-igU140SQ.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./index-hC3MxXep.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=Ce("Repeat",[["path",{d:"m17 2 4 4-4 4",key:"nntrym"}],["path",{d:"M3 11v-1a4 4 0 0 1 4-4h14",key:"84bu3i"}],["path",{d:"m7 22-4-4 4-4",key:"1wqhfi"}],["path",{d:"M21 13v1a4 4 0 0 1-4 4H3",key:"1rx37r"}]]),Qe=async(t,N,c)=>{const{jsPDF:v,autoTable:h}=await De();return new Promise((R,n)=>{try{const a=new v,g=a.internal.pageSize.getWidth(),y=a.internal.pageSize.getHeight(),$=Le(new Date,"PPP");a.setFillColor(125,1,1),a.rect(0,0,g,30,"F"),a.setTextColor(255,255,255),a.setFontSize(20),a.text("Amplifier Requirements Report",g/2,20,{align:"center"}),a.setTextColor(0,0,0),a.setFontSize(12),a.text(`Generated: ${$}`,14,40);let b=60;Object.entries(N.perSection).forEach(([C,P])=>{if(P.totalAmps>0){a.setFontSize(14),a.setTextColor(125,1,1);const T=`${C.charAt(0).toUpperCase()+C.slice(1)}${P.mirrored?" (Mirrored)":""}`;a.text(T,14,b),b+=10;const _=P.details.map(L=>[L]);h(a,{startY:b,head:[["Speaker Configuration"]],body:_,theme:"grid",headStyles:{fillColor:[200,200,200],textColor:[0,0,0],fontStyle:"bold"},margin:{left:14,right:14}}),b=a.lastAutoTable.finalY+10,a.setFontSize(12),a.setTextColor(0,0,0),a.text(`Total amplifiers for section: ${P.totalAmps}`,14,b),b+=20,b>y-40&&(a.addPage(),b=20)}}),a.setFontSize(16),a.setTextColor(125,1,1),a.text("Summary",14,b),b+=10,a.setFontSize(12),a.setTextColor(0,0,0);const B=[[`Total LA-RAKs required: ${N.completeRaks}`],[`Additional loose amplifiers: ${N.looseAmplifiers}`],[`Total amplifiers needed: ${N.totalAmplifiersNeeded}`]];h(a,{startY:b,body:B,theme:"plain",styles:{fontSize:12,cellPadding:2},margin:{left:14,right:14}});const F=new Image;F.crossOrigin="anonymous",F.src="/lovable-uploads/ce3ff31a-4cc5-43c8-b5bb-a4056d3735e4.png",F.onload=()=>{try{const P=40*(F.height/F.width),T=a.internal.pages.length;for(let L=1;L<=T;L++)a.setPage(L),a.addImage(F,"PNG",g-50,y-25,40,P),a.setFontSize(10),a.text(`Page ${L} of ${T}`,g/2,y-10,{align:"center"});const _=a.output("blob");R(_)}catch{const P=a.output("blob");R(P)}},F.onerror=()=>{const C=a.output("blob");R(C)}}catch(a){n(a)}})},D=[{id:1,name:" K1 ",weight:56},{id:2,name:" K2 ",weight:43},{id:3,name:" K3 ",weight:35},{id:4,name:" KARA II ",weight:26},{id:5,name:" KIVA ",weight:13},{id:6,name:" KS28 ",weight:79},{id:7,name:" SB28 ",weight:93},{id:8,name:" K1-SB ",weight:83},{id:9,name:" KS21 ",weight:49},{id:10,name:" X15 ",weight:21},{id:11,name:" 115HiQ ",weight:35},{id:12,name:" TFS900H ",weight:45},{id:13,name:" TFS600A ",weight:35},{id:14,name:" TFS550H ",weight:28},{id:15,name:" TFS900B ",weight:65},{id:16,name:" TFS550L ",weight:42}],Ge={mains:["K1","K2","K3","KARA II","TFS900H","TFS600A","TFS550H"],outs:["K1","K2","K3","KARA II","TFS900H","TFS600A","TFS550H"],subs:["KS28","SB28","K1-SB","KS21","TFS900B","TFS550L"],fronts:["KARA II","KIVA"],delays:["K1","K2","K3","KARA II","TFS900H","TFS600A","TFS550H"],other:["KIVA","X15","115HiQ"]},de={K1:{maxLink:2,maxPerAmp:2,channelsRequired:4},K2:{maxLink:3,maxPerAmp:3,channelsRequired:4},K3:{maxLink:3,maxPerAmp:6,channelsRequired:2},"KARA II":{maxLink:3,maxPerAmp:6,channelsRequired:2},KIVA:{maxLink:4,maxPerAmp:12,channelsRequired:1},KS28:{maxLink:1,maxPerAmp:4,channelsRequired:1},SB28:{maxLink:1,maxPerAmp:4,channelsRequired:1},"K1-SB":{maxLink:1,maxPerAmp:4,channelsRequired:1},KS21:{maxLink:2,maxPerAmp:8,channelsRequired:.5},X15:{maxLink:3,maxPerAmp:6,channelsRequired:2},"115HiQ":{maxLink:3,maxPerAmp:6,channelsRequired:2},TFS900H:{maxLink:3,maxPerAmp:3,channelsRequired:4},TFS600A:{maxLink:3,maxPerAmp:3,channelsRequired:3},TFS550H:{maxLink:3,maxPerAmp:6,channelsRequired:2},TFS900B:{maxLink:3,maxPerAmp:6,channelsRequired:2},TFS550L:{maxLink:3,maxPerAmp:12,channelsRequired:1}},xe=t=>t.trim().startsWith("TFS"),Y=({section:t,sectionConfig:N,getAvailableSpeakers:c,onMirroredChange:v,onAddSpeaker:h,onRemoveSpeaker:R,onConfigChange:n})=>e.jsxs("div",{className:"space-y-4",children:[["mains","outs","delays"].includes(t)&&e.jsxs("div",{className:"flex items-center gap-2 bg-muted/50 rounded-lg p-3 border",children:[e.jsx(He,{id:`${t}-mirrored`,checked:N.mirrored,onCheckedChange:a=>v(t,a)}),e.jsxs(K,{htmlFor:`${t}-mirrored`,className:"flex items-center gap-2 cursor-pointer text-sm font-medium flex-1",children:[e.jsx(Xe,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"whitespace-nowrap",children:"Mirrored Clusters"})]})]}),N.speakers.map((a,g)=>e.jsxs("div",{className:"relative border rounded-lg p-4 bg-card",children:[e.jsx(ae,{variant:"ghost",size:"icon",className:"absolute right-2 top-2",onClick:()=>R(t,g),children:e.jsx(Re,{className:"h-4 w-4"})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{htmlFor:`${t}-${g}-speaker`,className:"text-sm font-medium",children:"Speaker Type"}),e.jsxs(O,{value:a.speakerId,onValueChange:y=>n(t,g,"speakerId",y),children:[e.jsx(J,{id:`${t}-${g}-speaker`,children:e.jsx(Z,{placeholder:"Select speaker"})}),e.jsx(ee,{children:c(t).map(y=>e.jsx(se,{value:y.id.toString(),children:y.name},y.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{htmlFor:`${t}-${g}-quantity`,className:"text-sm font-medium",children:"Quantity"}),e.jsx(me,{id:`${t}-${g}-quantity`,type:"number",min:"0",value:a.quantity,onChange:y=>n(t,g,"quantity",y.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{htmlFor:`${t}-${g}-maxlinked`,className:"text-sm font-medium",children:"Max Linked"}),e.jsx(me,{id:`${t}-${g}-maxlinked`,type:"number",min:"0",value:a.maxLinked,onChange:y=>n(t,g,"maxLinked",y.target.value)})]})]})]},g)),e.jsxs(ae,{variant:"outline",className:"w-full",onClick:()=>h(t),children:[e.jsx(ze,{className:"h-4 w-4 mr-2"}),"Add Speaker"]})]}),Ue=({results:t})=>e.jsxs("div",{className:"mt-6 border rounded-lg overflow-hidden",children:[e.jsx("div",{className:"bg-muted px-4 py-3",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Required Amplifiers"})}),e.jsx("div",{className:"p-4 space-y-4",children:Object.entries(t.perSection).map(([N,c])=>c.totalAmps>0&&e.jsxs("div",{className:"space-y-2 pb-4 border-b last:border-b-0 last:pb-0",children:[e.jsxs("div",{className:"font-medium capitalize text-sm text-muted-foreground",children:[N,c.mirrored?" (Mirrored)":""]}),c.details.map((v,h)=>e.jsx("div",{className:"text-sm pl-4",children:v},h)),c.details.length>1&&e.jsxs("div",{className:"text-sm pl-4 font-medium",children:["Total amplifiers for ",N,": ",c.totalAmps]})]},N))}),e.jsxs("div",{className:"bg-muted/50 px-4 py-3 border-t space-y-2",children:[e.jsx("div",{className:"font-semibold text-sm text-muted-foreground",children:"Summary"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm",children:[t.completeRaks>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"LA-RAKs required:"}),e.jsx("span",{className:"font-medium",children:t.completeRaks})]}),t.looseAmplifiers>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Loose LA12X amplifiers:"}),e.jsx("span",{className:"font-medium",children:t.looseAmplifiers})]}),t.plmRacks>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"PLM20000 Racks:"}),e.jsx("span",{className:"font-medium",children:t.plmRacks})]}),t.loosePLMAmps>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Loose PLM20000D amplifiers:"}),e.jsx("span",{className:"font-medium",children:t.loosePLMAmps})]})]}),e.jsxs("div",{className:"flex justify-between font-semibold pt-2 border-t",children:[e.jsx("span",{children:"Total amplifiers needed:"}),e.jsx("span",{children:t.totalAmplifiersNeeded})]})]})]}),We=({results:t,totalCalculatedAmps:N,presetOptions:c,ampOptions:v,createNewPreset:h,setCreateNewPreset:R,newPresetName:n,setNewPresetName:a,selectedPresetId:g,setSelectedPresetId:y,laRakEquipmentId:$,setLaRakEquipmentId:b,laAmpEquipmentId:B,setLaAmpEquipmentId:F,plmRakEquipmentId:C,setPlmRakEquipmentId:P,plmAmpEquipmentId:T,setPlmAmpEquipmentId:_,isLoadingPresets:L,isLoadingAmpOptions:E,isSavingPreset:q,onSave:re})=>e.jsxs("div",{className:"mt-4 border rounded-lg p-4 space-y-4",children:[e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Guardar en preset"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Inserta los amplificadores calculados como items de preset (subsystem amplification)."})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[N," amplificadores calculados"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(K,{children:"Preset de sonido"}),e.jsx(ae,{variant:"link",size:"sm",className:"h-auto p-0 text-xs",onClick:()=>{R(!h),a("")},children:h?"Seleccionar existente":"Crear nuevo"})]}),h?e.jsx(me,{placeholder:"Nombre del nuevo preset...",value:n,onChange:f=>a(f.target.value),disabled:q}):e.jsxs(O,{value:g,onValueChange:y,disabled:L||c.length===0||q,children:[e.jsx(J,{children:e.jsx(Z,{placeholder:L?"Cargando presets...":"Selecciona un preset"})}),e.jsx(ee,{children:c.map(f=>e.jsx(se,{value:f.id,children:f.name},f.id))})]})]}),t.completeRaks>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Equipo LA-RAK (racks completos)"}),e.jsxs(O,{value:$||"",onValueChange:b,disabled:E||v.length===0||q,children:[e.jsx(J,{children:e.jsx(Z,{placeholder:E?"Cargando equipos...":"Selecciona LA-RAK"})}),e.jsx(ee,{children:v.map(f=>e.jsx(se,{value:f.id,children:f.name},f.id))})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Racks calculados: ",t.completeRaks]})]}),t.looseAmplifiers>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Equipo LA12X (amplificadores sueltos)"}),e.jsxs(O,{value:B||"",onValueChange:F,disabled:E||v.length===0||q,children:[e.jsx(J,{children:e.jsx(Z,{placeholder:E?"Cargando equipos...":"Selecciona LA12X"})}),e.jsx(ee,{children:v.map(f=>e.jsx(se,{value:f.id,children:f.name},f.id))})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Amplificadores sueltos: ",t.looseAmplifiers]})]}),t.plmRacks>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Equipo PLM-RAK (racks completos)"}),e.jsxs(O,{value:C||"",onValueChange:P,disabled:E||v.length===0||q,children:[e.jsx(J,{children:e.jsx(Z,{placeholder:E?"Cargando equipos...":"Selecciona PLM-RAK"})}),e.jsx(ee,{children:v.map(f=>e.jsx(se,{value:f.id,children:f.name},f.id))})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Racks calculados: ",t.plmRacks]})]}),t.loosePLMAmps>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Equipo PLM20000D (amplificadores sueltos)"}),e.jsxs(O,{value:T||"",onValueChange:_,disabled:E||v.length===0||q,children:[e.jsx(J,{children:e.jsx(Z,{placeholder:E?"Cargando equipos...":"Selecciona PLM20000D"})}),e.jsx(ee,{children:v.map(f=>e.jsx(se,{value:f.id,children:f.name},f.id))})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Amplificadores sueltos: ",t.loosePLMAmps]})]})]}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:'Los items se guardan con subsystem "amplification" y source "amp_calculator".'}),e.jsx(ae,{onClick:re,disabled:q||!h&&!g||h&&!n.trim()||t.completeRaks>0&&!$||t.looseAmplifiers>0&&!B||t.plmRacks>0&&!C||t.loosePLMAmps>0&&!T,className:"w-full sm:w-auto gap-2",children:q?e.jsxs(e.Fragment,{children:[e.jsx(qe,{className:"h-4 w-4 animate-spin"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Be,{className:"h-4 w-4"}),"Guardar en preset"]})})]})]}),ls=({jobId:t,tourId:N}={})=>{const{toast:c}=Pe(),v=Te(),[h,R]=w.useState({mains:{speakers:[],mirrored:!1},outs:{speakers:[],mirrored:!1},subs:{speakers:[]},fronts:{speakers:[]},delays:{speakers:[],mirrored:!1},other:{speakers:[]}}),[n,a]=w.useState(null),[g,y]=w.useState([]),[$,b]=w.useState(""),[B,F]=w.useState([]),[C,P]=w.useState(null),[T,_]=w.useState(null),[L,E]=w.useState(null),[q,re]=w.useState(null),[f,pe]=w.useState(!1),[ge,ue]=w.useState(!1),[je,he]=w.useState(!1),[ke,Ae]=w.useState(new Map),[ie,ne]=w.useState(!1),[le,oe]=w.useState("");w.useEffect(()=>{let s=!0;const l=async()=>{pe(!0);try{const{data:u,error:d}=await I.from("presets").select("id, name").eq("department","sound").order("name");if(d)throw d;if(!s)return;const r=u||[];y(r),b(m=>{var o;return m||((o=r[0])==null?void 0:o.id)||""})}catch{if(!s)return;c({title:"Error",description:"No se pudieron cargar los presets de sonido.",variant:"destructive"})}finally{s&&pe(!1)}},i=async()=>{ue(!0);try{const{data:u,error:d}=await I.from("equipment").select("id, name, category").eq("department","sound").in("category",["pa_amp","amplificacion"]);if(d)throw d;if(!s)return;const r=u||[];F(r);const m=o=>r.find(j=>{var k;return(k=j.name)==null?void 0:k.toLowerCase().includes(o.toLowerCase())});_(o=>{var j,k;return o||((j=m("la12x"))==null?void 0:j.id)||((k=r[0])==null?void 0:k.id)||null}),re(o=>{var j,k,p,A;return o||((j=m("plm"))==null?void 0:j.id)||((k=m("20000"))==null?void 0:k.id)||((p=r.find(M=>{var S;return(S=M.name)==null?void 0:S.toLowerCase().includes("tf")}))==null?void 0:p.id)||((A=r[0])==null?void 0:A.id)||null})}catch{if(!s)return;c({title:"Error",description:"No se pudieron cargar las opciones de amplificación (Flex).",variant:"destructive"})}finally{s&&ue(!1)}},x=async()=>{try{const{data:u,error:d}=await I.from("equipment").select("id, name").eq("department","sound");if(d)throw d;if(!s)return;const r=new Map;D.forEach(m=>{const o=m.name.trim(),j=(u==null?void 0:u.find(k=>{var p;return((p=k.name)==null?void 0:p.toLowerCase())===o.toLowerCase()}))||(u==null?void 0:u.find(k=>{var p;return(p=k.name)==null?void 0:p.toLowerCase().includes(o.toLowerCase())}));j&&r.set(o,j.id)}),Ae(r)}catch{if(!s)return}};return l(),i(),x(),()=>{s=!1}},[c]);const H=s=>{const l=Ge[s]||[];return D.filter(i=>l.includes(i.name.trim()))},V=(s,l)=>{R(i=>({...i,[s]:{...i[s],mirrored:l}}))},X=s=>{R(l=>({...l,[s]:{...l[s],speakers:[...l[s].speakers,{speakerId:"",quantity:0,maxLinked:0}]}}))},Q=(s,l)=>{R(i=>({...i,[s]:{...i[s],speakers:i[s].speakers.filter((x,u)=>u!==l)}}))},G=(s,l,i,x)=>{const u=i==="speakerId"?x:Number(x);if(i==="speakerId"&&typeof x=="string"){const d=D.find(r=>r.id.toString()===x);if(d){const r=de[d.name.trim()];if(!H(s).find(o=>o.id.toString()===x)){c({title:"Invalid speaker selection",description:`This speaker is not available for the ${s} section`,variant:"destructive"});return}R(o=>({...o,[s]:{...o[s],speakers:o[s].speakers.map((j,k)=>k===l?{...j,speakerId:x,maxLinked:r?r.maxLink:0}:j)}}));return}}if(i==="maxLinked"){const d=D.find(r=>r.id.toString()===h[s].speakers[l].speakerId);if(d){const r=de[d.name.trim()];if(r&&Number(x)>r.maxLink){c({title:"Max linked limit exceeded",description:`Maximum linked quantity for ${d.name.trim()} is ${r.maxLink}`,variant:"destructive"});return}}}R(d=>({...d,[s]:{...d[s],speakers:d[s].speakers.map((r,m)=>m===l?{...r,[i]:u}:r)}}))},Se=(s,l,i,x=!1)=>{if(!s||l===0)return{amps:0,details:"No speakers configured"};const u=D.find(te=>te.id.toString()===s);if(!u)return{amps:0,details:"Invalid speaker selection"};const d=u.name.trim(),r=de[d];if(!r)return{amps:0,details:"Speaker configuration not found"};const m=x?l*2:l,o=Math.min(i||r.maxLink,r.maxLink),j=Math.ceil(m/o),k=r.channelsRequired,p=Math.floor(4/k),A=Math.ceil(j/p),M=x?" × 2 (mirrored clusters)":"",S=xe(d)?"PLM20000D":"LA12X",z=r.channelsRequired===1?"1 channel":`${r.channelsRequired} channels`;return{amps:A,details:`${l} ${d} speakers${M} (${z} each, ${o} linked) requiring ${A} ${S} amplifier${A!==1?"s":""}`}},ye=()=>{const s={totalAmplifiersNeeded:0,completeRaks:0,looseAmplifiers:0,plmRacks:0,loosePLMAmps:0,laAmpsTotal:0,plmAmpsTotal:0,perSection:{}};let l=0,i=0;Object.entries(h).forEach(([x,{speakers:u,mirrored:d}])=>{const r={amps:0,details:[],totalAmps:0,mirrored:d,laAmps:0,plmAmps:0};u.forEach(m=>{const o=Se(m.speakerId,m.quantity,m.maxLinked,d);if(o.amps>0){r.amps+=o.amps,r.details.push(o.details);const j=D.find(k=>k.id.toString()===m.speakerId);j&&(xe(j.name)?(r.plmAmps+=o.amps,i+=o.amps):(r.laAmps+=o.amps,l+=o.amps))}}),r.totalAmps=r.amps,s.perSection[x]=r,s.totalAmplifiersNeeded+=r.totalAmps}),s.completeRaks=Math.floor(l/3),s.looseAmplifiers=l%3,s.plmRacks=Math.floor(i/3),s.loosePLMAmps=i%3,s.laAmpsTotal=l,s.plmAmpsTotal=i,a(s)},be=async()=>{if(!n){c({title:"No calculations",description:"Please calculate amplifier requirements first.",variant:"destructive"});return}try{const s=await Qe(h,n,D),l=URL.createObjectURL(s),i=document.createElement("a");i.href=l,i.download=`amplifier-requirements-${new Date().toISOString().split("T")[0]}.pdf`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(l),c({title:"PDF Generated",description:"The PDF has been downloaded successfully."})}catch{c({title:"Error",description:"Failed to generate PDF. Please try again.",variant:"destructive"})}},ce=async s=>{await I.from("presets").delete().eq("id",s),y(l=>l.filter(i=>i.id!==s)),b(""),ne(!1),oe("")},ve=async()=>{var s,l;if(!n){c({title:"Sin cálculos",description:"Calcula los amplificadores antes de guardarlos en un preset.",variant:"destructive"});return}if(ie){if(!le.trim()){c({title:"Nombre requerido",description:"Ingresa un nombre para el nuevo preset.",variant:"destructive"});return}}else if(!$){c({title:"Preset requerido",description:"Selecciona un preset de sonido para guardar los amplificadores.",variant:"destructive"});return}if(n.completeRaks>0&&!C){c({title:"Falta seleccionar LA-RAK",description:"Elige el equipo de LA-RAK para guardar los racks completos.",variant:"destructive"});return}if(n.looseAmplifiers>0&&!T){c({title:"Falta seleccionar LA12X",description:"Elige el equipo de LA12X para guardar los amplificadores sueltos.",variant:"destructive"});return}if(n.plmRacks>0&&!L){c({title:"Falta seleccionar PLM-RAK",description:"Elige el equipo de PLM-RAK para guardar los racks completos.",variant:"destructive"});return}if(n.loosePLMAmps>0&&!q){c({title:"Falta seleccionar PLM20000D",description:"Elige el equipo de PLM20000D para guardar los amplificadores sueltos.",variant:"destructive"});return}he(!0);try{let i=$,x=null;if(ie){const{data:p,error:A}=await I.auth.getSession();if(A||!((l=(s=p==null?void 0:p.session)==null?void 0:s.user)!=null&&l.id))throw new Error("Usuario no autenticado");const{data:M,error:S}=await I.from("presets").insert({name:le.trim(),created_by:p.session.user.id,user_id:p.session.user.id,department:"sound",is_template:!1,job_id:t??null,tour_id:N??null}).select().single();if(S)throw S;if(!M)throw new Error("No se pudo crear el preset");i=M.id,x=M.id,b(i),ne(!1),oe("");const{data:z}=await I.from("presets").select("id, name").eq("department","sound").order("name");z&&y(z)}const{data:u,error:d}=await I.from("preset_items").select("preset_id, equipment_id, quantity, subsystem, source, notes").eq("preset_id",i).eq("source","amp_calculator");if(d)throw x&&await ce(x),d;const{error:r}=await I.from("preset_items").delete().eq("preset_id",i).eq("source","amp_calculator");if(r)throw x&&await ce(x),r;const m=[];if(Object.entries(h).forEach(([p,{speakers:A,mirrored:M}])=>{A.forEach(S=>{if(S.quantity>0&&S.speakerId){const z=D.find(te=>te.id.toString()===S.speakerId);if(z){const te=z.name.trim(),fe=ke.get(te);if(fe){const Ne=M?S.quantity*2:S.quantity;m.push({preset_id:i,equipment_id:fe,quantity:Ne,subsystem:p,source:"amp_calculator"})}}}})}),n.completeRaks>0&&C&&m.push({preset_id:i,equipment_id:C,quantity:n.completeRaks,subsystem:"amplification",source:"amp_calculator"}),n.looseAmplifiers>0&&T&&m.push({preset_id:i,equipment_id:T,quantity:n.looseAmplifiers,subsystem:"amplification",source:"amp_calculator"}),n.plmRacks>0&&L&&m.push({preset_id:i,equipment_id:L,quantity:n.plmRacks,subsystem:"amplification",source:"amp_calculator"}),n.loosePLMAmps>0&&q&&m.push({preset_id:i,equipment_id:q,quantity:n.loosePLMAmps,subsystem:"amplification",source:"amp_calculator"}),m.length>0){const{error:p}=await I.from("preset_items").insert(m);if(p){let A="No se pudieron guardar los items en el preset.";if(u&&u.length>0){const{error:M}=await I.from("preset_items").insert(u.map(S=>({preset_id:S.preset_id,equipment_id:S.equipment_id,quantity:S.quantity,subsystem:S.subsystem,source:S.source,notes:S.notes??null})));M&&(c({title:"Advertencia crítica",description:"Error al guardar items. Falló la restauración de datos anteriores - se pueden haber perdido datos previos.",variant:"destructive"}),A="Error al guardar items. Además, falló la restauración de datos anteriores del calculador.")}throw x&&(await ce(x),A+=" El preset creado fue eliminado."),new Error(A)}}v.invalidateQueries({predicate:p=>Array.isArray(p.queryKey)&&p.queryKey.some(A=>A==="presets"||A==="job-presets"||A==="tour-presets")});const o=m.reduce((p,A)=>p+A.quantity,0),j=m.filter(p=>p.subsystem!=="amplification").length,k=m.filter(p=>p.subsystem==="amplification").length;c({title:"Preset actualizado",description:m.length>0?`Se guardaron ${j} altavoces y ${k} amplificadores (${o} unidades totales).`:"Se eliminaron los equipos anteriores calculados."})}catch(i){c({title:"Error al guardar",description:i instanceof Error?i.message:"No se pudieron guardar los amplificadores en el preset.",variant:"destructive"})}finally{he(!1)}},we=((n==null?void 0:n.laAmpsTotal)??0)+((n==null?void 0:n.plmAmpsTotal)??0);return e.jsxs(Fe,{className:"w-full",children:[e.jsx(Me,{className:"space-y-1",children:e.jsx(Ie,{className:"text-2xl font-bold text-center",children:"Amplifier Calculator"})}),e.jsx(_e,{className:"h-[calc(100vh-12rem)]",children:e.jsxs(Ee,{className:"space-y-6",children:[e.jsxs(Ke,{defaultValue:"mains",className:"space-y-4",children:[e.jsxs($e,{className:"grid grid-cols-3 sm:grid-cols-3 lg:grid-cols-6 w-full gap-1",children:[e.jsx(U,{value:"mains",className:"text-xs sm:text-sm px-2",children:"Mains"}),e.jsx(U,{value:"outs",className:"text-xs sm:text-sm px-2",children:"Outs"}),e.jsx(U,{value:"subs",className:"text-xs sm:text-sm px-2",children:"Subs"}),e.jsx(U,{value:"fronts",className:"text-xs sm:text-sm px-2",children:"Fronts"}),e.jsx(U,{value:"delays",className:"text-xs sm:text-sm px-2",children:"Delays"}),e.jsx(U,{value:"other",className:"text-xs sm:text-sm px-2",children:"Other"})]}),e.jsx(W,{value:"mains",children:e.jsx(Y,{section:"mains",sectionConfig:h.mains,getAvailableSpeakers:H,onMirroredChange:V,onAddSpeaker:X,onRemoveSpeaker:Q,onConfigChange:G})}),e.jsx(W,{value:"outs",children:e.jsx(Y,{section:"outs",sectionConfig:h.outs,getAvailableSpeakers:H,onMirroredChange:V,onAddSpeaker:X,onRemoveSpeaker:Q,onConfigChange:G})}),e.jsx(W,{value:"subs",children:e.jsx(Y,{section:"subs",sectionConfig:h.subs,getAvailableSpeakers:H,onMirroredChange:V,onAddSpeaker:X,onRemoveSpeaker:Q,onConfigChange:G})}),e.jsx(W,{value:"fronts",children:e.jsx(Y,{section:"fronts",sectionConfig:h.fronts,getAvailableSpeakers:H,onMirroredChange:V,onAddSpeaker:X,onRemoveSpeaker:Q,onConfigChange:G})}),e.jsx(W,{value:"delays",children:e.jsx(Y,{section:"delays",sectionConfig:h.delays,getAvailableSpeakers:H,onMirroredChange:V,onAddSpeaker:X,onRemoveSpeaker:Q,onConfigChange:G})}),e.jsx(W,{value:"other",children:e.jsx(Y,{section:"other",sectionConfig:h.other,getAvailableSpeakers:H,onMirroredChange:V,onAddSpeaker:X,onRemoveSpeaker:Q,onConfigChange:G})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-2 sm:gap-4 mt-6",children:[e.jsx(ae,{onClick:ye,variant:"secondary",className:"w-full sm:w-auto",children:"Calculate Amplifiers"}),e.jsxs(ae,{onClick:be,className:"gap-2 w-full sm:w-auto",children:[e.jsx(Ve,{className:"h-4 w-4"}),"Export PDF"]})]}),n&&e.jsx(Ue,{results:n}),n&&e.jsx(We,{results:n,totalCalculatedAmps:we,presetOptions:g,ampOptions:B,createNewPreset:ie,setCreateNewPreset:ne,newPresetName:le,setNewPresetName:oe,selectedPresetId:$,setSelectedPresetId:b,laRakEquipmentId:C,setLaRakEquipmentId:P,laAmpEquipmentId:T,setLaAmpEquipmentId:_,plmRakEquipmentId:L,setPlmRakEquipmentId:E,plmAmpEquipmentId:q,setPlmAmpEquipmentId:re,isLoadingPresets:f,isLoadingAmpOptions:ge,isSavingPreset:je,onSave:ve})]})})]})};export{ls as AmplifierTool};
