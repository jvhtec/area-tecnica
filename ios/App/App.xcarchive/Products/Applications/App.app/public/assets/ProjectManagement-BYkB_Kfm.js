import{d as M,j as e,Q as l,B as b,i as Ne,a as _,y as Y,z as ye,P as G,s as w,a6 as be,a7 as ve,c as Se,b as De,e as Me,u as Ae,r as d,a8 as Te,C as Ee,W as ke,Y as Le,I as _e,A as Pe}from"./index-NZ6jJLfQ.js";import{C as ze}from"./chevron-left-rq2ui83a.js";import{C as He}from"./chevron-right-Bn7Eu0F7.js";import{T as Oe,a as Re,b as L,c as Fe}from"./tabs-BdaywI_b.js";import{J as Ue,a as Be}from"./JobCardNew-ZLL_Hd_i.js";import{i as qe}from"./isWithinInterval-CV3kanO0.js";import{C as X}from"./checkbox-BsRNEGV1.js";import{D as Z,a as ee,b as te,c as y,d as se}from"./dropdown-menu-Dn1SMjj1.js";import{F}from"./filter-D0HnK7Nz.js";import{u as Ie}from"./useOptimizedJobs-BQ4L7-2d.js";import{u as Je}from"./useTabVisibility-TU5j192j.js";import{a as Qe,s as Ke}from"./startOfMonth-B5dVCv8B.js";import{S as Ve,a as $e,b as We,c as Ye,d as Ge}from"./sheet-DFFfLazF.js";import{S as Xe}from"./search-D-OiWg8h.js";import{C as Ze}from"./circle-check-big-CilmNGCn.js";import{e as et}from"./endOfMonth-Byhxb84j.js";import{a as $}from"./addMonths-j-Bb577B.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./index-hC3MxXep.js";import"./VideoTaskDialog-jFo9WRqF.js";import"./useQuery-kdg2pmgf.js";import"./useJobRequiredRoles-Bz0ibKHS.js";import"./useMutation-DluhVBs1.js";import"./useWeatherData-d0TEdKFc.js";import"./weatherApi-BatwQpQy.js";import"./icon-D8sTZPYx.js";import"./progress-C8XsV-Me.js";import"./table-DnQAmABX.js";import"./lazyXlsx-BrFBF17_.js";import"./download-C1rVE0-J.js";import"./upload-DF4rjO7T.js";import"./optimisticJobDeletionService-Bq-53fU4.js";import"./folders-Scoqgw4s.js";import"./alert-dialog-CtyYUxwH.js";import"./useJobAssignmentsRealtime-7FZn5naq.js";import"./useRealtimeQuery-DRd58t-I.js";import"./useTableSubscription-Cu79jct8.js";import"./technicianAvailability-gbYgVBKV.js";import"./roleCategory-BtQgWHfO.js";import"./external-link-QJoXZ6ES.js";import"./api-C9EDenHJ.js";import"./config-DVV3VxR4.js";import"./constants-DoXhG9KB.js";import"./dryhireFolderService-Bb-tDpoa.js";import"./folderNameSanitizer-DNdk00QU.js";import"./JobDetailsDialog-Cah6wZTf.js";import"./useTourRateSubscriptions-Dd0aSU9f.js";import"./JobExtrasEditor-gQe73Sd8.js";import"./badge-vNTKF5RD.js";import"./separator-E-JdTFOv.js";import"./ratesQueryKeys-DgMsgg6U.js";import"./euro-DgRTeGAz.js";import"./minus-InO4I9Ks.js";import"./plus-C3JQqq7t.js";import"./circle-alert-LZYNzZ7F.js";import"./useJobRatesApproval-DsfA8V9C.js";import"./switch-DUBpZhIC.js";import"./alert-BqA-5jRM.js";import"./JobPayoutTotalsPanel-BSlgp62i.js";import"./useJobPayoutTotals-CXAavZS-.js";import"./useManagerJobQuotes-BrI1iNRY.js";import"./tourRateMath-BOmIkfWO.js";import"./logoUtils-D2o1jUVg.js";import"./logo-url-cache-eY6nfvu7.js";import"./lazyPdf-xVUlxKNu.js";import"./es-CSiFCUGj.js";import"./pen-D_H3YLSb.js";import"./file-down-Buu6FgvW.js";import"./send-Uvkx0r_O.js";import"./clock-BXPvTWvY.js";import"./triangle-alert-D6qN0F8g.js";import"./users-DMnpVLUq.js";import"./calendar-_Cj_Sgy-.js";import"./JobExtrasManagement-CpH8R_KL.js";import"./receipt-CWKVL4Rh.js";import"./circle-check-C0N48OpO.js";import"./circle-x-DDzV-xk_.js";import"./file-text-igU140SQ.js";import"./eye-BE_DouVP.js";import"./pdfMerge-DXtLP7Xx.js";import"./pdf-libs-BqoGqu1a.js";import"./timesheet-pdf-82e1LStH.js";import"./truck-Br5sduv3.js";import"./avatar-QSp4LpEt.js";import"./places-restaurant-service-CakuSyx6.js";import"./utensils-crossed-CZeagqP3.js";import"./phone-BlFwiuho.js";import"./ModernHojaDeRuta-DrMmS05m.js";import"./useJobSelection-B9iLNF5-.js";import"./MultiDayScheduleBuilder-DmGkt0fN.js";import"./building-BdT03Y2e.js";import"./arrow-up-BTt-lBKB.js";import"./copy-Dez5r9kU.js";import"./calendar-days-DcwEz6pd.js";import"./building-2-nIk8XRuA.js";import"./zap-QKspq41J.js";import"./sparkles-BZkmCd_8.js";import"./image--Pql38nK.js";import"./settings-egXcSQW9.js";import"./user-E3OATBQk.js";import"./briefcase-BrpPecAy.js";import"./id-card-oCs3SPbN.js";import"./car-vrO_NvCk.js";import"./plane-NSG-_bNT.js";import"./package-Oxfj-CNq.js";import"./activity-BNQuCEmB.js";import"./circle-CWxDyDxx.js";import"./star-icpn3ybK.js";import"./printer-De77t3j8.js";import"./save-z_re-Mcq.js";import"./FlexFolderPicker-DHVHrWa7.js";import"./scroll-area-BHjMXddA.js";import"./EditJobDialog-DRKRzgWP.js";import"./LogisticsEventDialog-WK7mGk6y.js";import"./transportOptions-CtHnG2xX.js";import"./transportProviders-CPS1W6Xy.js";import"./TaskManagerDialog-WHCTXr5s.js";import"./taskCompletion-NTcmWFA_.js";import"./TechnicianIncidentReportDialog-Bb0qWmts.js";import"./index-vfKqQWY5.js";import"./logo-service-SlbhM6-i.js";import"./jobDocumentsUpload-BaycvzFe.js";import"./clipboard-list-wtFE30Ps.js";import"./useFlexUuid-C0fmwl_8.js";import"./flexUuidService-C9yZjzP-.js";import"./command-D3uMBT-Z.js";import"./message-circle-Bh9rUoQO.js";import"./info-CpCfiYD2.js";import"./square-pen-BMpSgZGa.js";import"./folder-plus-DTUhlRcm.js";import"./userName-BCcvOtN-.js";import"./mic-l4q2dREA.js";import"./moon-Bp9lP4EQ.js";import"./wrench-DzMvZxmF.js";import"./index-D9TsP8oP.js";import"./useSubscription-C3wu6ko-.js";const tt=({currentDate:t,onPreviousMonth:r,onNextMonth:c})=>{const o=M();return e.jsxs("div",{className:l("flex items-center justify-between",o?"mb-4":"mb-6"),children:[e.jsxs(b,{variant:"outline",size:o?"sm":"default",onClick:r,className:l(o&&"px-2 min-w-[2.5rem]"),children:[e.jsx(ze,{className:l("h-4 w-4",!o&&"mr-1")}),!o&&"Previous"]}),e.jsx("h2",{className:l("font-semibold",o?"text-base":"text-lg"),children:Ne(t,o?"MMM yyyy":"MMMM yyyy")}),e.jsxs(b,{variant:"outline",size:o?"sm":"default",onClick:c,className:l(o&&"px-2 min-w-[2.5rem]"),children:[!o&&"Next",e.jsx(He,{className:l("h-4 w-4",!o&&"ml-1")})]})]})},st=({selectedDepartment:t,onDepartmentChange:r,jobs:c,jobsLoading:o,onDeleteDocument:a,userRole:m,highlightToday:g=!1,openHojaDeRutaJobId:v,onHojaDeRutaOpened:P})=>{const h=M(),A=f=>{const x=new Date,C=new Date(f.start_time),z=new Date(f.end_time);return qe(x,{start:Y(C),end:ye(z)})};return e.jsxs(Oe,{value:t,onValueChange:r,className:l(h?"mt-3":"mt-4"),children:[e.jsxs(Re,{className:l(h?"w-full grid grid-cols-4":"grid w-full grid-cols-4 lg:w-[500px]"),children:[e.jsx(L,{value:"sound",className:l(h&&"text-xs sm:text-sm"),children:"Sonido"}),e.jsx(L,{value:"lights",className:l(h&&"text-xs sm:text-sm"),children:"Luces"}),e.jsx(L,{value:"video",className:l(h&&"text-xs sm:text-sm"),children:"Video"}),e.jsx(L,{value:"production",className:l(h&&"text-xs sm:text-sm"),children:"ProducciÃ³n"})]}),["sound","lights","video","production"].map(f=>e.jsx(Fe,{value:f,className:l(h&&"mt-3"),children:o?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(_,{className:"h-6 w-6 animate-spin"})}):c.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"No jobs found"}):e.jsx("div",{className:l("space-y-4",h&&"space-y-3"),children:c.map(x=>{const C=g&&A(x);return e.jsx("div",{className:`transition-all duration-300 ${C?"ring-2 ring-primary ring-offset-2 shadow-lg scale-[1.02]":""}`,children:e.jsx(Ue,{job:x,onEditClick:()=>{},onDeleteClick:()=>{},onJobClick:()=>{},department:f,userRole:m,onDeleteDocument:a,showUpload:!0,showManageArtists:!0,isProjectManagementPage:!0,openHojaDeRuta:v===x.id,onHojaDeRutaOpened:P})},x.id)})})},f))]})},at={Tentativa:"Tentative",Confirmado:"Confirmed",Completado:"Completed",Cancelado:"Cancelled"},rt=({allJobStatuses:t,selectedJobStatuses:r,onStatusSelection:c})=>{const o=M(),a=m=>at[m]||m;return e.jsxs(Z,{children:[e.jsx(ee,{asChild:!0,children:e.jsxs(b,{variant:"outline",size:"sm",className:l("gap-2",o&&"w-full justify-between"),children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-4 w-4"}),"Status",r.length>0&&e.jsx("span",{className:"ml-1 rounded-full bg-primary text-primary-foreground text-xs px-2 py-0.5",children:r.length})]}),e.jsx(G,{className:"h-4 w-4"})]})}),e.jsxs(te,{align:o?"center":"end",className:l("w-56",o&&"w-[calc(100vw-2rem)]"),children:[e.jsx(y,{onClick:()=>{r.length===t.length?r.forEach(m=>c(m)):t.forEach(m=>{r.includes(m)||c(m)})},className:"font-medium",children:r.length===t.length?"Clear All":"Select All"}),t.length>0&&e.jsx(se,{}),t.map(m=>e.jsxs(y,{onClick:g=>{g.preventDefault(),c(m)},className:"gap-2 cursor-pointer",children:[e.jsx(X,{checked:r.includes(m),onChange:()=>c(m),className:"data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground"}),e.jsx(Be,{status:m}),e.jsx("span",{className:"ml-2",children:a(m)})]},m)),t.length===0&&e.jsx(y,{disabled:!0,className:"text-muted-foreground",children:"No statuses available"})]})]})},ot={single:"Single",festival:"Festival",tour:"Tour",tourdate:"Tour Date",dryhire:"Dry Hire",evento:"Evento"},it=t=>ot[t==null?void 0:t.toLowerCase()]||t,nt=({allJobTypes:t,selectedJobTypes:r,onTypeToggle:c})=>{const o=M();return e.jsxs(Z,{children:[e.jsx(ee,{asChild:!0,children:e.jsxs(b,{variant:"outline",size:"sm",className:l("gap-2",o&&"w-full justify-between"),children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-4 w-4"}),"Types",r.length>0&&e.jsx("span",{className:"ml-1 rounded-full bg-primary text-primary-foreground text-xs px-2 py-0.5",children:r.length})]}),e.jsx(G,{className:"h-4 w-4"})]})}),e.jsxs(te,{align:o?"center":"end",className:l("w-56",o&&"w-[calc(100vw-2rem)]"),children:[e.jsx(y,{onClick:()=>{r.length===t.length?r.forEach(a=>c(a)):t.forEach(a=>{r.includes(a)||c(a)})},className:"font-medium",children:r.length===t.length?"Clear All":"Select All"}),t.length>0&&e.jsx(se,{}),t.map(a=>e.jsxs(y,{onClick:m=>{m.preventDefault(),c(a)},className:"gap-2 cursor-pointer",children:[e.jsx(X,{checked:r.includes(a),onChange:()=>c(a),className:"data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground"}),e.jsx("span",{className:"ml-2",children:it(a)})]},a)),t.length===0&&e.jsx(y,{disabled:!0,className:"text-muted-foreground",children:"No types available"})]})]})},lt=t=>{if(!(t!=null&&t.end_time)||t.status==="Cancelado"||t.status==="Completado")return!1;const r=new Date(t.end_time);if(Number.isNaN(r.getTime()))return!1;const c=t.timezone||"Europe/Madrid",o=new Date,a=be(r,c),m=Y(Qe(a,1)),g=ve(m,c);return o>=g},W=async t=>{const r=t.filter(lt);if(r.length===0)return{updatedJobs:t,updatedCount:0};try{const{error:c}=await w.from("jobs").update({status:"Completado"}).in("id",r.map(a=>a.id)).neq("status","Cancelado");if(c)throw c;return{updatedJobs:t.map(a=>r.some(m=>m.id===a.id)?{...a,status:"Completado"}:a),updatedCount:r.length}}catch{return{updatedJobs:t,updatedCount:0}}},Fa=()=>{const t=Se(),[r,c]=De(),{toast:o}=Me(),a=M(),{userDepartment:m,isLoading:g}=Ae(),[v,P]=d.useState(!0),[h,A]=d.useState(m??"sound"),[f,x]=d.useState(new Date),[C,z]=d.useState(null),[S,ae]=d.useState([]),[j,U]=d.useState(["Confirmado","Tentativa"]),[re,oe]=d.useState([]),[ie,ne]=d.useState([]),[le,B]=d.useState(!1),[q,T]=d.useState(!1),[H,me]=d.useState(""),[I,ce]=d.useState(""),[de,pe]=d.useState(!1),{forceSubscribe:J}=Te(),ue=r.get("openHojaDeRuta"),he=d.useCallback(()=>{const s=new URLSearchParams(r);s.delete("openHojaDeRuta"),c(s)},[r,c]),fe=Ke(f),xe=et(f);d.useEffect(()=>{g||A(m??"sound")},[g,m]),Je(["optimized-jobs"]),d.useEffect(()=>{J([{table:"jobs",queryKey:["optimized-jobs"],priority:"high"},{table:"job_assignments",queryKey:["optimized-jobs"],priority:"medium"},{table:"job_departments",queryKey:["optimized-jobs"],priority:"medium"}])},[J]),d.useEffect(()=>{const s=setTimeout(()=>ce(H),300);return()=>clearTimeout(s)},[H]);const D=I.trim().length>0,{data:u=[],isLoading:O,error:mt}=Ie(h,D?void 0:fe,D?void 0:xe,!0),E=["admin","management","logistics"].includes(C||"");d.useEffect(()=>{(async()=>{if(!(!(u!=null&&u.length)||!E||D)){T(!0);try{const{updatedJobs:n,updatedCount:i}=await W(u);i>0&&o({title:"Jobs Auto-Completed",description:`${i} past job(s) automatically marked as completed`})}catch{}finally{T(!1)}}})()},[u,E,D,o]);const k=(u||[]).filter(s=>{var K,V;const n=D?!0:S.length===0||S.map(R=>R.toLowerCase()).includes(String(s.job_type||"").toLowerCase()),i=j.length===0||j.includes(s.status),p=I.trim().toLowerCase(),N=p.length===0||[s.title,s.client,(K=s.location)==null?void 0:K.name,(V=s.location)==null?void 0:V.formatted_address].filter(Boolean).some(R=>R.toLowerCase().includes(p));return n&&i&&N});d.useEffect(()=>{!v&&k.length>0&&k.filter(n=>{const i=new Date(n.start_time),p=new Date(n.end_time),N=new Date;return N>=i&&N<=p}).length>0&&(B(!0),setTimeout(()=>B(!1),3e3))},[v,k]),d.useEffect(()=>{(async()=>{try{const{data:{session:n}}=await w.auth.getSession();if(!n){t("/auth");return}const{data:i,error:p}=await w.from("profiles").select("role").eq("id",n.user.id).single();if(p)throw p;if(!i||!["admin","logistics","management","technician"].includes(i.role)){t("/dashboard");return}z(i.role),P(!1)}catch{t("/dashboard")}})()},[t]),d.useEffect(()=>{(async()=>{var n;try{const{data:{session:i}}=await w.auth.getSession();if(!((n=i==null?void 0:i.user)!=null&&n.id))return;const{data:p,error:N}=await w.from("profiles").select("selected_job_statuses").eq("id",i.user.id).single();if(N)return;p!=null&&p.selected_job_statuses&&U(p.selected_job_statuses)}catch{}})()},[]);const ge=async s=>{var n;try{const{data:{session:i}}=await w.auth.getSession();if(!((n=i==null?void 0:i.user)!=null&&n.id))return;const{error:p}=await w.from("profiles").update({selected_job_statuses:s}).eq("id",i.user.id)}catch{}};if(d.useEffect(()=>{if((u==null?void 0:u.length)>0){const s=Array.from(new Set(u.map(i=>i.job_type).filter(Boolean))),n=Array.from(new Set(u.map(i=>i.status).filter(Boolean)));oe(s),ne(n)}},[u]),v)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(_,{className:"h-8 w-8 animate-spin"})});const je=async()=>{if(E){T(!0);try{const{updatedJobs:s,updatedCount:n}=await W(u);n>0?o({title:"Jobs Auto-Completed",description:`${n} past job(s) marked as completed`}):o({title:"No Updates Needed",description:"All past jobs are already completed or cancelled"})}catch{o({title:"Error",description:"Failed to auto-complete jobs",variant:"destructive"})}finally{T(!1)}}},we=s=>{const n=j.includes(s)?j.filter(i=>i!==s):[...j,s];U(n),ge(n)},Ce=s=>{ae(n=>n.includes(s)?n.filter(i=>i!==s):[...n,s])},Q=()=>e.jsxs("div",{className:l("flex flex-col gap-4",a?"w-full":""),children:[e.jsxs("div",{className:l("flex",a?"flex-col gap-3":"items-center gap-4"),children:[e.jsx(nt,{allJobTypes:re,selectedJobTypes:S,onTypeToggle:Ce}),e.jsx(rt,{allJobStatuses:ie,selectedJobStatuses:j,onStatusSelection:we})]}),E&&e.jsxs(b,{onClick:je,disabled:q||O,variant:"outline",size:"sm",className:l("flex items-center gap-2",a&&"w-full"),children:[q?e.jsx(_,{className:"h-4 w-4 animate-spin"}):e.jsx(Ze,{className:"h-4 w-4"}),"Auto-Complete Past Jobs"]})]});return e.jsx("div",{className:"min-h-screen bg-background text-foreground",children:e.jsx("div",{className:l("w-full max-w-full mx-auto space-y-4",a?"px-3 py-4":"px-6 py-6"),children:e.jsxs(Ee,{children:[e.jsxs(ke,{className:l("flex flex-col space-y-4",a?"p-4 pb-3":"p-6 pb-4"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Le,{className:l(a?"text-lg":"text-xl"),children:"Project Management"}),a&&e.jsxs(Ve,{open:de,onOpenChange:pe,children:[e.jsx($e,{asChild:!0,children:e.jsxs(b,{variant:"outline",size:"sm",className:"gap-2",children:[e.jsx(F,{className:"h-4 w-4"}),"Filters",(S.length>0||j.length>0)&&e.jsx("span",{className:"ml-1 rounded-full bg-primary text-primary-foreground text-xs px-2 py-0.5",children:S.length+j.length})]})}),e.jsxs(We,{side:"bottom",className:"h-auto max-h-[85vh] overflow-y-auto",children:[e.jsx(Ye,{className:"mb-4",children:e.jsx(Ge,{children:"Filters"})}),e.jsx(Q,{})]})]})]}),e.jsxs("div",{className:l("flex gap-2",a?"flex-col":"flex-row flex-wrap items-center"),children:[!a&&e.jsx(Q,{}),e.jsxs("div",{className:l("relative",a?"w-full":"flex-1 min-w-[220px] max-w-[280px]"),children:[e.jsx(Xe,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(_e,{value:H,onChange:s=>me(s.target.value),placeholder:"Search projects...",className:l("pl-8 h-9",a&&"w-full")}),O&&e.jsx(_,{className:"absolute right-2 top-1/2 -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground"})]})]})]}),e.jsxs(Pe,{className:l(a?"p-4 pt-2":"p-6 pt-2"),children:[e.jsx(tt,{currentDate:f,onPreviousMonth:()=>x(s=>$(s,-1)),onNextMonth:()=>x(s=>$(s,1))}),e.jsx(st,{selectedDepartment:h,onDepartmentChange:s=>A(s),jobs:k,jobsLoading:O,onDeleteDocument:void 0,userRole:C,highlightToday:le,openHojaDeRutaJobId:ue,onHojaDeRutaOpened:he})]})]})})})};export{Fa as default};
