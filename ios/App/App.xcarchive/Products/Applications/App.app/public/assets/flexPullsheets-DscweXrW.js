import{m as h,c2 as b}from"./index-NZ6jJLfQ.js";function F(e){if(!e||typeof e!="string")return null;const r=e.trim();if(!r)return null;try{const t=new URL(r);if(t.hash){const a=t.hash.match(/[#/](?:element|fin-doc|contact-list|expense-sheet|remote-file-list|equipment-list)\/([a-f0-9-]{36})/i);if(a&&a[1])return a[1]}if(t.pathname){const a=t.pathname.match(/\/element\/([a-f0-9-]{36})/i);if(a&&a[1])return a[1]}return null}catch{const a=/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}/i,l=r.match(a);return l?l[0]:null}}let m=null;const p=new Map([["foh_console","98905ca2-b094-45bc-ad5b-67fe311a48e8"],["mon_console","aadfee39-e5e4-4a68-b7d8-03d55b3f29f8"],["wireless","a8f2e63b-55f1-4531-83a4-835232d2bd04"],["iem","5194620b-ed50-4a31-bf6b-a986614b3d2d"],["wired_mics","9a33f593-67e9-462d-b085-e7e215f5da72"],["pa_mains","d83de363-5f9b-46e4-8e11-5bee0ef30137"],["pa_downfill","aeb78382-d19c-4314-bbbe-5bbe5e5d3cd4"],["pa_outfill","d8e2ce25-4370-469c-8980-61760569492a"],["pa_subs","61aba524-61db-43a9-935d-147ec287888e"],["pa_frontfill","d9b588e6-b9a8-4327-baa5-fecf104a6775"],["pa_delays","e38db281-4b27-40eb-a846-e4a27db3961f"],["pa_amp","9d463da6-40f1-4ab0-9a96-123fd0025f88"]]),g={mains:"pa_mains",outs:"pa_outfill",subs:"pa_subs",fronts:"pa_frontfill",delays:"pa_delays",other:"pa_mains",amplification:"pa_amp"};async function I(){if(m)return m;const{data:e,error:r}=await h.functions.invoke("get-secret",{body:{secretName:"X_AUTH_TOKEN"}});if(r)throw new Error(r.message||"Failed to resolve Flex auth token");const t=e==null?void 0:e.X_AUTH_TOKEN;if(!t)throw new Error("Flex auth token response missing X_AUTH_TOKEN");return m=t,t}async function _(e){var c;const{documentId:r,resourceId:t,quantity:a,parentLineItemId:l="",nextSiblingId:n="",token:s}=e,u=`${b}/line-item/${encodeURIComponent(r)}/add-resource/${encodeURIComponent(t)}`,f={accept:"*/*","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Auth-Token":s,apikey:s},o=new URLSearchParams({resourceParentId:"",managedResourceLineItemType:"inventory-model",quantity:String(a),parentLineItemId:l,nextSiblingId:n});try{const i=await fetch(u,{method:"POST",headers:f,body:o.toString()});if(!i.ok){const q=await i.text().catch(()=>"");return{success:!1,error:`API error: ${i.status}`}}const d=await i.json().catch(()=>null);return d?{success:!0,lineItemId:(c=d.addedResourceLineIds)==null?void 0:c[0]}:{success:!1,error:"Invalid response from API"}}catch{return{success:!1,error:"Network error"}}}function w(e){if(e.flexCategoryKey)return e.flexCategoryKey;if(e.subsystem){const r=g[e.subsystem];if(r)return r}return e.category?e.category:"uncategorized"}function E(e){const r=new Map;return e.forEach(t=>{const a=w(t),l=`${a}:${t.resourceId}`,n=r.get(l);if(n){n.quantity+=t.quantity,!n.subsystem&&t.subsystem&&(n.subsystem=t.subsystem),!n.category&&t.category&&(n.category=t.category);return}r.set(l,{...t,flexCategoryKey:a})}),Array.from(r.values())}async function L(e,r){const t={succeeded:0,failed:[]};let a;try{a=await I()}catch(s){return s instanceof Error&&s.message,r.forEach(u=>{t.failed.push({name:u.name,error:"Authentication failed"})}),t}const l=E(r),n=new Map;l.forEach(s=>{n.has(s.flexCategoryKey)||n.set(s.flexCategoryKey,[]),n.get(s.flexCategoryKey).push(s)});for(const[s,u]of n.entries()){let f="";if(p.has(s)){const o=p.get(s),c=await _({documentId:e,resourceId:o,quantity:1,token:a});c.success&&c.lineItemId&&(f=c.lineItemId)}for(const o of u){const c=await _({documentId:e,resourceId:o.resourceId,quantity:o.quantity,parentLineItemId:f,token:a});c.success?t.succeeded++:t.failed.push({name:o.name,error:c.error||"Unknown error"})}}return t}const T="a220432c-af33-11df-b8d5-00e08175e43e",A="equipment-list",x=50;async function P(e){const{data:r,error:t}=await h.from("flex_folders").select("id, element_id, department, created_at").eq("job_id",e).eq("folder_type","pull_sheet").order("department",{ascending:!0}).order("created_at",{ascending:!0}).limit(100);if(t)throw new Error(`Failed to query pullsheets: ${t.message}`);return(r||[]).map(a=>({...a,source:"database"}))}async function U(e){const r=await P(e);try{const{data:t,error:a}=await h.from("flex_folders").select("element_id").eq("job_id",e).or("folder_type.eq.main_event,folder_type.eq.main").single();if(a||!(t!=null&&t.element_id))return r;const l=await I(),n=new AbortController,s=setTimeout(()=>n.abort(),1e4);let u;try{const i=await fetch(`${b}/element/${t.element_id}/tree`,{method:"GET",headers:{"Content-Type":"application/json","X-Auth-Token":l,apikey:l},signal:n.signal});if(clearTimeout(s),!i.ok)return r;try{u=await i.json()}catch{return r}}catch(i){return clearTimeout(s),i instanceof Error&&i.name,r}const f=y(u),o=new Set(r.map(i=>i.element_id)),c=f.filter(i=>!o.has(i.element_id));return[...r,...c]}catch{return r}}function y(e,r=0){if(r>x)return[];if(!e)return[];if(Array.isArray(e)){const o=[];for(const c of e)o.push(...y(c,r));return o}const t=[],a=e.elementId||e.nodeId||e.id,l=e.definitionId||e.elementDefinitionId,n=e.domainId,s=e.leaf===!0||e.leaf===void 0&&(!Array.isArray(e.children)||e.children.length===0),u=e.displayName||(e.name&&e.documentNumber?`${e.name} (${e.documentNumber})`:e.name);if(a&&l===T||a&&n===A&&s){const o=e.createdAt||e.created_at||e.dateCreated||e.date_created||"2000-01-01T00:00:00.000Z",c={id:a,element_id:a,department:null,created_at:o,display_name:u,source:"flex_api"};t.push(c)}if(Array.isArray(e.children))for(const o of e.children)t.push(...y(o,r+1));return t}export{F as e,U as g,L as p};
