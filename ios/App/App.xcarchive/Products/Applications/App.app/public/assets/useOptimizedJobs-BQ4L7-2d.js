import{u as c}from"./useQuery-kdg2pmgf.js";import{s as _}from"./index-NZ6jJLfQ.js";import{u as y}from"./useSubscription-C3wu6ko-.js";const z=(l,s,r,a=!1)=>{y([{table:"jobs",queryKey:["optimized-jobs"],priority:"high"},{table:"job_assignments",queryKey:["optimized-jobs"],priority:"high"},{table:"job_departments",queryKey:["optimized-jobs"],priority:"medium"},{table:"job_documents",queryKey:["optimized-jobs"],priority:"low"},{table:"flex_folders",queryKey:["optimized-jobs"],priority:"low"},{table:"locations",queryKey:["optimized-jobs"],priority:"low"},{table:"tours",queryKey:["optimized-jobs"],priority:"low"}]);const f=async()=>{let t=_.from("jobs").select(`
        *,
        location_data:locations(
          id,
          name,
          formatted_address
        ),
        job_departments!inner(
          department
        ),
        job_assignments(
          technician_id,
          sound_role,
          lights_role,
          video_role,
          single_day,
          assignment_date,
          status,
          assigned_at,
          profiles!inner(
            id,
            first_name,
            nickname,
            last_name,
            department
          )
        ),
        job_documents(
          id,
          file_name,
          file_path,
          file_type,
          file_size,
          visible_to_tech,
          uploaded_at,
          read_only,
          template_type
        ),
        flex_folders(
          id,
          element_id,
          department,
          folder_type
        )
      `).in("job_type",a?["single","festival","tourdate","dryhire","evento"]:["single","festival","tourdate","evento"]).order("start_time",{ascending:!0});l&&(t=t.eq("job_departments.department",l)),s&&(t=t.gte("end_time",s.toISOString())),r&&(t=t.lte("start_time",r.toISOString()));const{data:p,error:n}=await t;if(n)throw n;const d=(p||[]).map(e=>{var i;return{...e,job_documents:e.job_documents||[],flex_folders_exist:(((i=e.flex_folders)==null?void 0:i.length)||0)>0}}),m=Array.from(new Set(d.map(e=>e.tour_id).filter(e=>!!e))),u={};if(m.length>0){const{data:e,error:i}=await _.from("tours").select("id, status, deleted").in("id",m);i||(e||[]).forEach(o=>{o!=null&&o.id&&(u[o.id]={id:o.id,status:o.status??null,deleted:o.deleted??null})})}return d.map(e=>({...e,tour_meta:e.tour_id?u[e.tour_id]??null:null})).filter(e=>{const i=e.tour_meta;return i&&(i.status==="cancelled"||i.deleted===!0)?!1:e.status!=="Cancelado"})};return c({queryKey:["optimized-jobs",l,s==null?void 0:s.toISOString(),r==null?void 0:r.toISOString(),a],queryFn:f,staleTime:1e3*60*5,gcTime:1e3*60*10,refetchOnWindowFocus:!1,refetchOnReconnect:!0,retry:2,retryDelay:t=>Math.min(1e3*2**t,3e4),placeholderData:t=>t})};export{z as u};
