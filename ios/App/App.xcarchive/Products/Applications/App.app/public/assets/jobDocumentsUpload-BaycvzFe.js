import{s as e}from"./index-NZ6jJLfQ.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";const $=async(o,s,f,c)=>{var l;const i=f.replace(/[^a-zA-Z0-9._-]/g,"_").replace(/_{2,}/g,"_").replace(/^_|_$/g,""),r=`${c}/${o}`,p=`${r}/${i}`;try{try{const{data:t,error:m}=await e.storage.from("job-documents").list(r);if(!m){if(t&&t.length>0){const _=t.map(b=>`${r}/${b.name}`),{error:h}=await e.storage.from("job-documents").remove(_)}}const{error:u}=await e.from("job_documents").delete().like("file_path",`${r}/%`).eq("job_id",o)}catch{}const{error:a}=await e.storage.from("job-documents").upload(p,s,{cacheControl:"3600",upsert:!1,contentType:"application/pdf"});if(a)throw a;const{data:n}=await e.auth.getUser(),{error:d}=await e.from("job_documents").insert({job_id:o,file_name:i,file_path:p,file_type:"application/pdf",file_size:s.size,uploaded_by:((l=n==null?void 0:n.user)==null?void 0:l.id)||null,original_type:"pdf",visible_to_tech:!0});if(d)throw d;try{const t=c==="incident-reports"?"incident.report.uploaded":"document.uploaded";e.functions.invoke("push",{body:{action:"broadcast",type:t,job_id:o,file_name:i}})}catch{}}catch(a){throw a}};export{$ as uploadJobPdfWithCleanup};
