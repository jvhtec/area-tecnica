import{l as qe,f as Ce,n as k,m as _,j as e,C as W,Q as Te,W as ie,Y as oe,A as G,L as Y,I as ne,r as P,D as Be,q as Qe,F as Pe,G as Le,B as K,S as fe,t as be,v as ge,w as xe,x as V,i as Ke,h as U}from"./index-NZ6jJLfQ.js";import{T as He,a as ze,b as ae,c as se}from"./tabs-BdaywI_b.js";import{B as z}from"./badge-vNTKF5RD.js";import{u as $}from"./useQuery-kdg2pmgf.js";import{u as re}from"./useMutation-DluhVBs1.js";import{a as ke,u as Je,d as Ie,S as ve,b as Oe,s as je}from"./useManagerJobQuotes-BrI1iNRY.js";import{a as Ue}from"./useHouseTechRates-BLqiuvHa.js";import{a as Ve,b as $e,J as We}from"./JobExtrasEditor-gQe73Sd8.js";import{g as Ge,f as ye,s as we}from"./tourRateMath-BOmIkfWO.js";import{a as Ye}from"./useTourRatesApproval-CR_t91JW.js";import{a as Xe,u as Ze}from"./useJobRatesApproval-DsfA8V9C.js";import{A as Re,a as Ae}from"./alert-BqA-5jRM.js";import{R as J}from"./ratesQueryKeys-DgMsgg6U.js";import{W as et}from"./wrench-DzMvZxmF.js";import{E as Se}from"./euro-DgRTeGAz.js";import{F as Ne}from"./file-down-Buu6FgvW.js";import{C as tt}from"./calendar-_Cj_Sgy-.js";import{U as at}from"./users-DMnpVLUq.js";import{T as st}from"./triangle-alert-D6qN0F8g.js";import{e as rt}from"./es-CSiFCUGj.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=qe("ShieldX",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m14.5 9.5-5 5",key:"17q4r4"}],["path",{d:"m9.5 9.5 5 5",key:"18nt4w"}]]);function it(){return $({queryKey:J.baseRates,queryFn:async()=>{const{data:f,error:y}=await _.from("rate_cards_tour_2025").select("*").order("category",{ascending:!0});if(y)throw y;return f||[]},staleTime:60*1e3})}function ot(){const f=Ce();return re({mutationFn:async y=>{const{data:g,error:n}=await _.from("rate_cards_tour_2025").upsert(y).select().single();if(n)throw n;return g},onSuccess:()=>{f.invalidateQueries({queryKey:J.baseRates}),k.success("Tour base rate saved")},onError:y=>{k.error("Failed to save tour base rate")}})}function nt({className:f}){const{data:y=[],isLoading:g}=Ve(),n=$e();return e.jsxs(W,{className:Te(f),children:[e.jsx(ie,{children:e.jsxs(oe,{className:"flex items-center gap-2 text-base",children:[e.jsx(et,{className:"h-4 w-4"})," Catálogo de extras (2025)"]})}),e.jsxs(G,{className:"space-y-3",children:[e.jsx(Re,{children:e.jsx(Ae,{children:"Define importes unitarios para extras de viaje y días de descanso. Los managers pueden ajustarlos en cualquier momento."})}),g&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Cargando catálogo de extras…"}),!g&&y.map(u=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Y,{className:"w-40 capitalize",children:u.extra_type.replace("_"," ")}),e.jsx(ne,{type:"number",defaultValue:u.amount_eur,className:"w-40",onBlur:j=>{const b=parseFloat(j.target.value);!isNaN(b)&&b!==u.amount_eur&&n.mutate({extra_type:u.extra_type,amount_eur:b})},"aria-label":`Importe para ${u.extra_type}`}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"EUR"})]},u.extra_type))]})]})}function lt({className:f}){const{data:y=[],isLoading:g}=it(),n=ot(),u=[{key:"tecnico",label:"Técnico"},{key:"especialista",label:"Especialista"},{key:"responsable",label:"Responsable"}],j=P.useMemo(()=>Object.fromEntries(y.map(b=>[b.category,b.base_day_eur])),[y]);return e.jsxs(W,{className:Te(f),children:[e.jsx(ie,{children:e.jsxs(oe,{className:"flex items-center gap-2 text-base",children:[e.jsx(Se,{className:"h-4 w-4"})," Tarifas base de gira (2025)"]})}),e.jsxs(G,{className:"space-y-3",children:[e.jsx(Re,{children:e.jsx(Ae,{children:"Establece importes diarios por categoría. Se aplican multiplicadores semanales cuando los técnicos están en el equipo de gira."})}),g&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Cargando tarifas base…"}),!g&&u.map(b=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Y,{className:"w-40",children:b.label}),e.jsx(ne,{type:"number",defaultValue:j[b.key]??"",className:"w-40",onBlur:h=>{const F=parseFloat(h.target.value);isNaN(F)||n.mutate({category:b.key,base_day_eur:F})},"aria-label":`Tarifa base para ${b.label}`}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"EUR"})]},b.key))]})]})}const ct="tecnico";async function Mt(){const[f,y,g,n]=await Promise.all([_.from("tours").select("id, name, start_date, rates_approved").order("start_date",{ascending:!0}).eq("rates_approved",!1).limit(5),_.from("rate_extras_2025").select("*").order("extra_type",{ascending:!0}),_.from("rate_cards_tour_2025").select("*").order("category",{ascending:!0}),_.from("custom_tech_rates").select("profile_id, base_day_eur, updated_at",{count:"exact"}).order("updated_at",{ascending:!1}).limit(5)]);if(f.error)throw f.error;if(y.error)throw y.error;if(g.error)throw g.error;if(n.error)throw n.error;const u=n.data||[],j=u.map(R=>R.profile_id).filter(Boolean);let b={};if(j.length>0){const{data:R,error:a}=await _.from("profiles").select("id, first_name, last_name").in("id",j);if(a)throw a;b=Object.fromEntries((R||[]).map(E=>[E.id,`${E.first_name??""} ${E.last_name??""}`.trim()||"Sin nombre"]))}const h=y.data||[],F=g.data||[];return{totals:{pendingTours:(f.data||[]).length,baseRates:F.length,extras:h.length,houseOverrides:n.count??u.length},pendingTours:f.data||[],extrasCatalog:h,baseRates:F,recentOverrides:u.map(R=>({profileId:R.profile_id,profileName:b[R.profile_id]||"Sin nombre",baseDayEur:R.base_day_eur??null,updatedAt:R.updated_at??null}))}}async function Ft(){const{data:f,error:y}=await _.from("profiles").select("id, first_name, last_name, default_timesheet_category, role").in("role",["house_tech","technician"]).order("first_name",{ascending:!0});if(y)throw y;const g=f||[],n=g.map(j=>j.id);let u={};if(n.length>0){const{data:j,error:b}=await _.from("custom_tech_rates").select("profile_id, base_day_eur, updated_at").in("profile_id",n);if(b)throw b;u=Object.fromEntries((j||[]).map(h=>[h.profile_id,{base_day_eur:h.base_day_eur,updated_at:h.updated_at}]))}return g.map(j=>{var b,h;return{profileId:j.id,profileName:`${j.first_name??""} ${j.last_name??""}`.trim()||"Sin nombre",defaultCategory:j.default_timesheet_category??ct,overrideBaseDay:((b=u[j.id])==null?void 0:b.base_day_eur)??null,overrideUpdatedAt:((h=u[j.id])==null?void 0:h.updated_at)??null}})}async function qt(){const{data:f,error:y}=await _.from("tours").select("id, name, start_date, end_date, rates_approved, status").neq("status","cancelled").order("start_date",{ascending:!0});if(y)throw y;const g=f||[],n=g.map(c=>c.id).filter(Boolean),u={},j=new Set;if(n.length>0){const{data:c,error:d}=await _.from("jobs").select("id, tour_id, job_type").in("tour_id",n);if(d)throw d;const o=[];if((c||[]).filter(i=>(i.job_type??"").toLowerCase()!=="dryhire").forEach(i=>{i.tour_id&&(u[i.tour_id]||(u[i.tour_id]={jobCount:0,jobIds:[],assignmentCount:0}),u[i.tour_id].jobCount+=1,u[i.tour_id].jobIds.push(i.id),o.push(i.id),j.add(i.id))}),o.length>0){const{data:i,error:l}=await _.from("job_assignments").select("job_id").in("job_id",o);if(l)throw l;const s={};(i||[]).forEach(r=>{r.job_id&&(s[r.job_id]=(s[r.job_id]||0)+1)}),Object.values(u).forEach(r=>{r.assignmentCount=r.jobIds.reduce((x,T)=>x+(s[T]||0),0)})}}const{data:b,error:h}=await _.from("jobs").select("id, title, start_time, end_time, job_type, status, rates_approved, tour_id").neq("job_type","tourdate").neq("job_type","dryhire").in("status",["Confirmado","Completado"]).order("start_time",{ascending:!0});if(h)throw h;const F=(b||[]).filter(c=>(c.job_type??"").toLowerCase()!=="tour"),R=F.map(c=>c.id);R.forEach(c=>j.add(c));const a={},E={},N={};if(R.length>0){const{data:c,error:d}=await _.from("job_assignments").select("job_id").in("job_id",R);if(d)throw d;(c||[]).forEach(o=>{o.job_id&&(a[o.job_id]=(a[o.job_id]||0)+1)})}if(j.size>0){const c=Array.from(j),[{data:d,error:o},{data:i,error:l}]=await Promise.all([_.from("timesheets").select("job_id, status").eq("is_active",!0).in("job_id",c),_.from("job_rate_extras").select("job_id, status").in("job_id",c)]);if(o)throw o;if(l)throw l;(d||[]).forEach(s=>{var T;if(!s.job_id)return;const r=String(s.status??"").toLowerCase(),x=E[T=s.job_id]||(E[T]={total:0,approved:0,rejected:0});x.total+=1,r==="approved"&&(x.approved+=1),r==="rejected"&&(x.rejected+=1)}),(i||[]).forEach(s=>{var T;if(!s.job_id)return;const r=String(s.status??"").toLowerCase(),x=N[T=s.job_id]||(N[T]={pending:0,rejected:0});r==="pending"&&(x.pending+=1),r==="rejected"&&(x.rejected+=1)})}const q=g.map(c=>{const d=u[c.id]||{jobCount:0,jobIds:[],assignmentCount:0},o=[];if(c.rates_approved||o.push("Approval required"),d.jobCount===0&&o.push("No tour jobs"),d.assignmentCount===0&&o.push("No assignments"),d.jobIds.length>0){const i=d.jobIds.map(m=>E[m]),l=i.every(m=>!m||m.total===0),s=i.some(m=>((m==null?void 0:m.rejected)??0)>0),r=i.some(m=>m?m.total>0&&m.approved<m.total:!0);l?o.push("No timesheets"):s?o.push("Timesheets rejected"):r&&o.push("Timesheets pending");const x=d.jobIds.map(m=>N[m]),T=x.some(m=>((m==null?void 0:m.pending)??0)>0),A=x.some(m=>((m==null?void 0:m.rejected)??0)>0);T&&o.push("Extras pending"),A&&o.push("Extras rejected")}return{id:c.id,name:c.name,startDate:c.start_date??null,endDate:c.end_date??null,ratesApproved:!!c.rates_approved,jobCount:d.jobCount,assignmentCount:d.assignmentCount,pendingIssues:o,entityType:"tour",jobType:"tour",status:c.status??null}}),H=F.map(c=>{const d=[],o=a[c.id]||0;c.rates_approved||d.push("Approval required"),o===0&&d.push("No assignments");const i=E[c.id];!i||i.total===0?d.push("No timesheets"):(i.rejected??0)>0?d.push("Timesheets rejected"):i.approved<i.total&&d.push("Timesheets pending");const l=N[c.id];return((l==null?void 0:l.pending)??0)>0&&d.push("Extras pending"),((l==null?void 0:l.rejected)??0)>0&&d.push("Extras rejected"),{id:c.id,name:c.title,startDate:c.start_time??null,endDate:c.end_time??null,ratesApproved:!!c.rates_approved,jobCount:1,assignmentCount:o,pendingIssues:d,entityType:"job",jobType:c.job_type??null,status:c.status??null}}),Q=[...q,...H];return Q.sort((c,d)=>{const o=c.startDate?new Date(c.startDate).getTime():0,i=d.startDate?new Date(d.startDate).getTime():0;return o-i}),Q}function ut(f){f.invalidateQueries({queryKey:J.overview}),f.invalidateQueries({queryKey:J.extrasCatalog}),f.invalidateQueries({queryKey:J.baseRates}),f.invalidateQueries({queryKey:J.houseTechList}),f.invalidateQueries({queryKey:J.approvals})}const dt=(f,y,g,n)=>({job_id:n.job_id??f,technician_id:n.technician_id??g,start_time:n.start_time,end_time:n.end_time,job_type:n.job_type??"tourdate",tour_id:n.tour_id??y,title:n.title??"",is_house_tech:!!n.is_house_tech,is_tour_team_member:!!n.is_tour_team_member,category:n.category??"",base_day_eur:Number(n.base_day_eur??0),week_count:Number(n.week_count??1),multiplier:Number(n.multiplier??1),per_job_multiplier:n.per_job_multiplier!=null?Number(n.per_job_multiplier):void 0,iso_year:n.iso_year??null,iso_week:n.iso_week??null,total_eur:Number(n.total_eur??0),extras:n.extras,extras_total_eur:n.extras_total_eur!=null?Number(n.extras_total_eur):void 0,total_with_extras_eur:n.total_with_extras_eur!=null?Number(n.total_with_extras_eur):void 0,vehicle_disclaimer:n.vehicle_disclaimer,vehicle_disclaimer_text:n.vehicle_disclaimer_text,breakdown:n.breakdown??{}});async function _t(f,y){if(!f||y.length===0)return{jobsWithQuotes:[],profiles:[]};const g=y.map(a=>a.id).filter(Boolean);if(g.length===0)return{jobsWithQuotes:[],profiles:[]};const[n,u]=await Promise.all([_.from("job_assignments").select("job_id, technician_id").in("job_id",g),_.from("flex_work_orders").select("job_id, technician_id, lpo_number").in("job_id",g)]);if(n.error)throw n.error;if(u.error)throw u.error;const j=new Map;(n.data||[]).forEach(a=>{!a.job_id||!a.technician_id||(j.has(a.job_id)||j.set(a.job_id,new Set),j.get(a.job_id).add(a.technician_id))});const b=new Map;(u.data||[]).forEach(a=>{!a.job_id||!a.technician_id||(b.has(a.job_id)||b.set(a.job_id,new Map),b.get(a.job_id).set(a.technician_id,a.lpo_number))}),await Promise.all(y.map(async a=>{if(String(a.job_type||"").toLowerCase()==="tourdate")return;const N=b.get(a.id);if(!(N&&N.size>0))try{const{data:q}=await _.from("jobs").select("id, rates_approved").eq("id",a.id).maybeSingle();if(!(q!=null&&q.rates_approved))return;await ke(a.id);const{data:H}=await _.from("flex_work_orders").select("job_id, technician_id, lpo_number").eq("job_id",a.id);if(H){const Q=new Map;H.forEach(c=>Q.set(c.technician_id,c.lpo_number)),b.set(a.id,Q)}}catch{}}));const h=[];for(const a of y){const E=Array.from(j.get(a.id)??[]);if(E.length===0)continue;let N=[];if((a.job_type??"").toLowerCase()==="tourdate"){N=(await Promise.all(E.map(async o=>{const{data:i,error:l}=await _.rpc("compute_tour_job_rate_quote_2025",{_job_id:a.id,_tech_id:o});if(l)return{job_id:a.id,technician_id:o,start_time:a.start_time,end_time:a.end_time??a.start_time,job_type:"tourdate",tour_id:f,title:a.title,is_house_tech:!1,is_tour_team_member:!1,category:"",base_day_eur:0,week_count:1,multiplier:1,per_job_multiplier:1,iso_year:null,iso_week:null,total_eur:0,extras:void 0,extras_total_eur:void 0,total_with_extras_eur:void 0,vehicle_disclaimer:void 0,vehicle_disclaimer_text:void 0,breakdown:{error:l.message}};const s=i||{};return dt(a.id,f,o,s)}))).filter(Boolean).filter(o=>o.technician_id);const{data:c}=await _.from("timesheets").select("id, technician_id, approved_by_manager, amount_breakdown").eq("job_id",a.id).eq("is_active",!0).in("technician_id",E).eq("approved_by_manager",!0),d=new Map;if(c&&c.length){const o=[];c.forEach(i=>{const l=i.technician_id,s=i.amount_breakdown;s||o.push(i);const r=s||{},x=Number(r.hours_rounded??r.worked_hours_rounded??0)||0,T=r.plus_10_12_amount_eur!=null?Number(r.plus_10_12_amount_eur)||0:(Number(r.plus_10_12_eur??0)||0)*Math.min(Math.max(x-10,0),2),A=Number(r.overtime_hours??0)||0,m=Number(r.overtime_amount_eur??0)||0,C=d.get(l)||{h:0,plus:0,otH:0,otAmt:0};d.set(l,{h:C.h+x,plus:C.plus+T,otH:C.otH+A,otAmt:C.otAmt+m})}),o.length&&(await Promise.all(o.map(async l=>{const{data:s,error:r}=await _.rpc("compute_timesheet_amount_2025",{_timesheet_id:l.id,_persist:!1});return{tech:l.technician_id,br:r?null:s}}))).forEach(({tech:l,br:s})=>{if(!l||!s)return;const r=Number(s.hours_rounded??s.worked_hours_rounded??0)||0,x=s.plus_10_12_amount_eur!=null?Number(s.plus_10_12_amount_eur)||0:(Number(s.plus_10_12_eur??0)||0)*Math.min(Math.max(r-10,0),2),T=Number(s.overtime_hours??0)||0,A=Number(s.overtime_amount_eur??0)||0,m=d.get(l)||{h:0,plus:0,otH:0,otAmt:0};d.set(l,{h:m.h+r,plus:m.plus+x,otH:m.otH+T,otAmt:m.otAmt+A})})}if((!c||c.length===0)&&d.size===0){const{data:o}=await _.rpc("get_timesheet_amounts_visible");Array.isArray(o)&&o.length&&o.filter(i=>i.job_id===a.id&&E.includes(i.technician_id)&&i.approved_by_manager===!0).forEach(i=>{const l=i.technician_id,s=i.amount_breakdown||i.amount_breakdown_visible||{},r=Number(s.hours_rounded??s.worked_hours_rounded??0)||0,x=r>10&&Number(s.plus_10_12_eur??0)||0,T=Number(s.overtime_hours??0)||0,A=Number(s.overtime_amount_eur??0)||0,m=d.get(l)||{h:0,plus:0,otH:0,otAmt:0};d.set(l,{h:m.h+r,plus:m.plus+x,otH:m.otH+T,otAmt:m.otAmt+A})})}N=N.map(o=>{var i,l,s,r;return{...o,breakdown:{...o.breakdown||{},single_hours_total:((i=d.get(o.technician_id))==null?void 0:i.h)??0,single_plus_10_12_total_eur:((l=d.get(o.technician_id))==null?void 0:l.plus)??0,single_overtime_hours_total:((s=d.get(o.technician_id))==null?void 0:s.otH)??0,single_overtime_amount_total_eur:((r=d.get(o.technician_id))==null?void 0:r.otAmt)??0}}})}else{const{data:Q,error:c}=await _.from("v_job_tech_payout_2025").select("technician_id, timesheets_total_eur, extras_total_eur, total_eur, vehicle_disclaimer, vehicle_disclaimer_text").eq("job_id",a.id).in("technician_id",E);if(c)N=E.map(d=>({job_id:a.id,technician_id:d,start_time:a.start_time,end_time:a.end_time??a.start_time,job_type:a.job_type||"single",tour_id:f,title:a.title,is_house_tech:!1,is_tour_team_member:!1,category:"",base_day_eur:0,week_count:1,multiplier:1,iso_year:null,iso_week:null,total_eur:0,extras:void 0,extras_total_eur:0,total_with_extras_eur:0,vehicle_disclaimer:void 0,vehicle_disclaimer_text:void 0,breakdown:{}}));else{const{data:d}=await _.from("timesheets").select("id, technician_id, approved_by_manager, amount_breakdown, amount_breakdown_visible, created_at").eq("job_id",a.id).eq("is_active",!0).in("technician_id",E).eq("approved_by_manager",!0),o=new Map;if((d||[]).length>0){(d||[]).forEach(l=>{const s=l.technician_id;if(!s)return;const r=l.amount_breakdown||l.amount_breakdown_visible;if(!r)return;const x=Number(r.hours_rounded??r.worked_hours_rounded??0)||0,T=r.plus_10_12_amount_eur!=null?Number(r.plus_10_12_amount_eur)||0:(Number(r.plus_10_12_eur??0)||0)*Math.min(Math.max(x-10,0),2),A=Number(r.overtime_hours??0)||0,m=Number(r.overtime_amount_eur??0)||0,C=o.get(s)||{hours_total:0,plus_10_12_total_eur:0,overtime_hours_total:0,overtime_amount_total_eur:0};C.hours_total+=x,C.plus_10_12_total_eur+=T,C.overtime_hours_total+=A,C.overtime_amount_total_eur+=m,o.set(s,C)});const i=(d||[]).filter(l=>!l.amount_breakdown&&!l.amount_breakdown_visible);i.length>0&&(await Promise.all(i.map(async s=>{const{data:r,error:x}=await _.rpc("compute_timesheet_amount_2025",{_timesheet_id:s.id,_persist:!1});return{tech:s.technician_id,breakdown:x?null:r}}))).forEach(({tech:s,breakdown:r})=>{if(!s||!r)return;const x=Number(r.hours_rounded??r.worked_hours_rounded??0)||0,T=r.plus_10_12_amount_eur!=null?Number(r.plus_10_12_amount_eur)||0:(Number(r.plus_10_12_eur??0)||0)*Math.min(Math.max(x-10,0),2),A=Number(r.overtime_hours??0)||0,m=Number(r.overtime_amount_eur??0)||0,C=o.get(s)||{hours_total:0,plus_10_12_total_eur:0,overtime_hours_total:0,overtime_amount_total_eur:0};C.hours_total+=x,C.plus_10_12_total_eur+=T,C.overtime_hours_total+=A,C.overtime_amount_total_eur+=m,o.set(s,C)})}if(o.size===0){const{data:i}=await _.rpc("get_timesheet_amounts_visible");Array.isArray(i)&&i.length&&i.filter(l=>l.job_id===a.id&&E.includes(l.technician_id)&&l.approved_by_manager===!0).forEach(l=>{const s=l.technician_id,r=l.amount_breakdown||l.amount_breakdown_visible||{},x=Number(r.hours_rounded??r.worked_hours_rounded??0)||0,T=r.plus_10_12_amount_eur!=null?Number(r.plus_10_12_amount_eur)||0:(Number(r.plus_10_12_eur??0)||0)*Math.min(Math.max(x-10,0),2),A=Number(r.overtime_hours??0)||0,m=Number(r.overtime_amount_eur??0)||0,C=o.get(s)||{hours_total:0,plus_10_12_total_eur:0,overtime_hours_total:0,overtime_amount_total_eur:0};C.hours_total+=x,C.plus_10_12_total_eur+=T,C.overtime_hours_total+=A,C.overtime_amount_total_eur+=m,o.set(s,C)})}N=(Q||[]).map(i=>{var l,s,r,x;return{job_id:a.id,technician_id:i.technician_id,start_time:a.start_time,end_time:a.end_time??a.start_time,job_type:a.job_type||"single",tour_id:f,title:a.title,is_house_tech:!1,is_tour_team_member:!1,category:"",base_day_eur:Number(i.timesheets_total_eur??0),week_count:1,multiplier:1,iso_year:null,iso_week:null,total_eur:Number(i.total_eur??0),extras:void 0,extras_total_eur:Number(i.extras_total_eur??0),total_with_extras_eur:Number(i.total_eur??0),vehicle_disclaimer:i.vehicle_disclaimer??void 0,vehicle_disclaimer_text:i.vehicle_disclaimer_text??void 0,breakdown:{single_hours_total:((l=o.get(i.technician_id))==null?void 0:l.hours_total)??0,single_plus_10_12_total_eur:((s=o.get(i.technician_id))==null?void 0:s.plus_10_12_total_eur)??0,single_overtime_hours_total:((r=o.get(i.technician_id))==null?void 0:r.overtime_hours_total)??0,single_overtime_amount_total_eur:((x=o.get(i.technician_id))==null?void 0:x.overtime_amount_total_eur)??0}}})}}if(N.length===0)continue;const H=b.get(a.id)??new Map;h.push({job:a,quotes:N,lpoMap:H})}const F=Array.from(new Set(h.flatMap(a=>a.quotes.map(E=>E.technician_id).filter(Boolean))));if(F.length===0)return{jobsWithQuotes:h,profiles:[]};const R=await _.from("profiles").select("id, first_name, last_name, default_timesheet_category, role").in("id",F);if(R.error)throw R.error;return{jobsWithQuotes:h,profiles:R.data||[]}}function Bt({open:f,onOpenChange:y,tourId:g}){const{data:n=[]}=$({queryKey:["tour-jobs-for-rates",g],queryFn:async()=>{const{data:t,error:p}=await _.from("jobs").select("id, title, start_time, end_time, job_type, tour_id").eq("tour_id",g).neq("job_type","dryhire").order("start_time",{ascending:!0});if(p)throw p;return t||[]},enabled:f&&!!g}),[u,j]=P.useState(void 0);P.useEffect(()=>{f&&n.length&&!u&&j(n[0].id)},[f,n,u]);const b=P.useMemo(()=>n.find(t=>t.id===u),[n,u]),{data:h=[],isLoading:F}=Je(u,b==null?void 0:b.job_type,g),R=P.useMemo(()=>n.map(t=>t.id).filter(Boolean),[n]),{data:a}=Xe(R),{data:E}=Ze(u),N=u?!!((E==null?void 0:E.rates_approved)??(a==null?void 0:a.get(u))):!1,{data:q=[]}=$({queryKey:["profiles-for-rates-manager",h.map(t=>t.technician_id)],queryFn:async()=>{if(!h.length)return[];const t=[...new Set(h.map(v=>v.technician_id))],{data:p,error:w}=await _.from("profiles").select("id, first_name, last_name, email, default_timesheet_category, role").in("id",t);if(w)throw w;return p||[]},enabled:f&&!!h.length}),H=t=>{const p=q.find(w=>w.id===t);return p&&`${p.first_name??""} ${p.last_name??""}`.trim()||"Unknown"};P.useEffect(()=>{h.length>0&&u&&h.forEach((t,p)=>{t.total_eur})},[h,u]);const[Q,c]=P.useState(!1),[d,o]=P.useState({}),{data:i=[]}=$({queryKey:["house-tech-rates-bulk",h.map(t=>t.technician_id)],queryFn:async()=>{if(!h.length)return[];const t=[...new Set(h.map(v=>v.technician_id))],{data:p,error:w}=await _.from("custom_tech_rates").select("profile_id, base_day_eur").in("profile_id",t);if(w)throw w;return p},enabled:f&&!!h.length}),l=P.useMemo(()=>Object.fromEntries(i.map(t=>[t.profile_id,t.base_day_eur])),[i]),s=Ce(),r=Ue(),x=re({mutationFn:async({technicianId:t,category:p})=>{const{error:w}=await _.from("profiles").update({default_timesheet_category:p}).eq("id",t);if(w)throw w},onSuccess:()=>{s.invalidateQueries({queryKey:["profiles-for-rates-manager"]}),s.invalidateQueries({queryKey:["tour-job-rate-quotes"]}),s.invalidateQueries({queryKey:["tour-job-rate-quotes-manager"]})}}),[T,A]=P.useState("by-date"),[m,C]=P.useState(!1),{data:X,refetch:le}=Ye(g),Z=!!(X!=null&&X.rates_approved),ce=re({mutationFn:async({jobId:t,approve:p})=>{var w;if(!t)throw new Error("Job ID requerido");if(p){const{data:v}=await _.auth.getUser(),L=((w=v==null?void 0:v.user)==null?void 0:w.id)||null,{error:B}=await _.from("jobs").update({rates_approved:!0,rates_approved_at:new Date().toISOString(),rates_approved_by:L}).eq("id",t);if(B)throw B;let I=null,S=null;try{I=await ke(t)}catch(ee){S=ee.message||"Error desconocido al crear órdenes en Flex"}return{jobId:t,approve:p,syncResult:I,syncError:S}}else{const{error:v}=await _.from("jobs").update({rates_approved:!1,rates_approved_at:null,rates_approved_by:null}).eq("id",t);if(v)throw v;return{jobId:t,approve:p,syncResult:null,syncError:null}}},onSuccess:(t,{jobId:p})=>{var w,v,L;ut(s),s.invalidateQueries({queryKey:["job-rates-approval",p]}),s.invalidateQueries({queryKey:["job-rates-approval-map"]}),s.invalidateQueries({queryKey:["tour-job-rate-quotes-manager",p]}),s.invalidateQueries({queryKey:["tour-job-rate-quotes-manager",p,g]}),s.invalidateQueries({queryKey:["tour-job-rate-quotes-manager"]}),t!=null&&t.approve&&((w=t==null?void 0:t.syncResult)!=null&&w.created&&k.success(`Órdenes de trabajo creadas en Flex: ${t.syncResult.created}`),(L=(v=t==null?void 0:t.syncResult)==null?void 0:v.errors)==null||L.forEach(B=>k.error(B)),t!=null&&t.syncError&&k.error(`No se pudieron generar algunas órdenes de trabajo en Flex: ${t.syncError}`))},onError:t=>{const p=(t==null?void 0:t.message)||"No se pudo actualizar la aprobación del trabajo.";k.error(p)}});return e.jsx(Be,{open:f,onOpenChange:y,children:e.jsxs(Qe,{className:"max-w-5xl max-h-[95vh] md:max-h-[90vh] overflow-y-auto w-[95vw] md:w-full",children:[e.jsxs(Pe,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2",children:[e.jsxs(Le,{className:"flex items-center gap-2 text-base md:text-lg",children:[e.jsx(Se,{className:"h-4 w-4 md:h-5 md:w-5"}),"Gestor de Tarifas y Extras"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{variant:Z?"default":"secondary",className:"hidden sm:inline-flex",children:Z?"Tarifas base liberadas":"Aprobación base pendiente"}),e.jsxs(K,{variant:"outline",size:"sm",disabled:m,onClick:async()=>{C(!0);try{const{data:t}=await _.from("tours").select("name").eq("id",g).single(),{data:p,error:w}=await _.from("jobs").select("id, title, start_time, end_time, job_type").eq("tour_id",g).order("start_time",{ascending:!0});if(w)throw w;const L=(p||[]).filter(S=>(S.job_type??"").toLowerCase()!=="dryhire").map(S=>({id:S.id,title:S.title,start_time:S.start_time,end_time:S.end_time??null,job_type:S.job_type??null})),{jobsWithQuotes:B,profiles:I}=await _t(g,L);if(!B.length){k.error("No hay asignaciones con tarifas para exportar.");return}await Ie((t==null?void 0:t.name)||"Tour",B,I),k.success("PDF de gira generado")}catch{k.error("No se pudo generar el PDF de la gira")}finally{C(!1)}},className:"flex items-center gap-1",children:[e.jsx(Ne,{className:"h-4 w-4"})," Exportar Gira"]}),Z?e.jsxs(K,{variant:"outline",size:"sm",onClick:async()=>{const{error:t}=await _.from("tours").update({rates_approved:!1,rates_approved_at:null,rates_approved_by:null}).eq("id",g);t||le()},className:"flex items-center gap-1",children:[e.jsx(Ee,{className:"h-4 w-4"})," Revocar base"]}):e.jsxs(K,{variant:"default",size:"sm",onClick:async()=>{var v;const{data:t}=await _.auth.getUser(),p=((v=t==null?void 0:t.user)==null?void 0:v.id)||null,{error:w}=await _.from("tours").update({rates_approved:!0,rates_approved_at:new Date().toISOString(),rates_approved_by:p}).eq("id",g);w||le()},className:"flex items-center gap-1",children:[e.jsx(ve,{className:"h-4 w-4"})," Liberar tarifas base"]})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"La aprobación de la gira libera las tarifas base para todo el equipo. Cada fecha también puede liberar el pago final (base + extras) para que los responsables finalicen importes desde un único lugar."})]}),e.jsxs(He,{value:T,onValueChange:A,className:"space-y-4",children:[e.jsxs(ze,{children:[e.jsx(ae,{value:"by-date",children:"Por fecha"}),e.jsx(ae,{value:"extras",children:"Catálogo de extras"}),e.jsx(ae,{value:"base",children:"Tarifas base"})]}),e.jsxs(se,{value:"by-date",className:"space-y-4",children:[e.jsxs(W,{children:[e.jsx(ie,{children:e.jsxs(oe,{className:"flex items-center gap-2 text-base",children:[e.jsx(tt,{className:"h-4 w-4"})," Seleccionar fecha de gira"]})}),e.jsxs(G,{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:gap-4",children:[e.jsxs(fe,{value:u,onValueChange:t=>j(t),children:[e.jsx(be,{className:"min-w-[260px]",children:e.jsx(ge,{placeholder:"Elegir fecha"})}),e.jsx(xe,{children:n.map(t=>e.jsxs(V,{value:t.id,className:"flex items-center justify-between gap-2",children:[e.jsxs("span",{children:[Ke(new Date(t.start_time),"PPP",{locale:rt})," • ",t.title]}),e.jsx(z,{variant:a!=null&&a.get(t.id)?"default":"secondary",children:a!=null&&a.get(t.id)?"Pago final liberado":"Pendiente"})]},t.id))})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[e.jsxs(z,{variant:"outline",className:"w-fit",children:[e.jsx(at,{className:"h-3 w-3 mr-1"}),h.length," asignaciones"]}),e.jsxs(K,{variant:"outline",size:"sm",disabled:!u||h.length===0,onClick:async()=>{const t=n.find(v=>v.id===u);if(!t)return;const{data:p}=await _.from("flex_work_orders").select("technician_id, lpo_number").eq("job_id",u),w=new Map((p||[]).map(v=>[v.technician_id,v.lpo_number]));await Oe(h,t,q,w),k.success("PDF generado")},children:[e.jsx(Ne,{className:"h-4 w-4 mr-1"}),"Exportar Fecha"]}),e.jsx(K,{size:"sm",disabled:!u||h.length===0||!N||Q,onClick:async()=>{var t;if(u){c(!0);try{const p=await je({jobId:u,supabase:_,quotes:h,profiles:q});if(p.error)k.error("No se pudieron enviar los correos");else{const w=Array.isArray((t=p.response)==null?void 0:t.results)?p.response.results.some(v=>!v.sent):!1;p.success&&!w?k.success("Correos enviados"):k.warning("Algunos correos no se pudieron enviar"),p.missingEmails.length&&k.warning("Hay técnicos sin correo configurado")}}catch{k.error("Se produjo un error al enviar")}finally{c(!1)}}},title:N?"Enviar correos a los técnicos de esta fecha":"Liberar pago final para habilitar envío",children:Q?"Enviando…":"Enviar por correo"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[F&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Cargando tarifas…"}),!F&&h.map(t=>{var ue,de,_e,me,pe,he;const p=H(t.technician_id),w=!!((ue=t.breakdown)!=null&&ue.error),v=(de=t.breakdown)==null?void 0:de.error,L=t.is_house_tech,B=Ge(t),I=((_e=t.breakdown)==null?void 0:_e.after_discount)??((me=t.breakdown)==null?void 0:me.base_calculation),S=t.base_day_eur??0,ee=typeof B=="number"&&B>0,De=I??(ee?S/B:S),te=ye(B),Me=te.startsWith("×")?te.slice(1):te;return e.jsx(W,{children:e.jsxs(G,{className:"pt-4 space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-medium",children:p}),L&&e.jsx(z,{variant:"secondary",children:"Técnico en plantilla"}),t.is_tour_team_member&&we(t.multiplier)&&e.jsxs(z,{variant:"outline",children:[ye(t.multiplier)," multiplicador semanal"]}),t.category&&!L&&e.jsx(z,{variant:"outline",children:t.category})]}),e.jsxs("div",{className:"text-right flex flex-col items-end gap-2",children:[e.jsx("div",{className:"font-semibold",children:U(t.total_with_extras_eur||t.total_eur)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:we(B)?e.jsxs(e.Fragment,{children:["Base ",U(De)," × ",Me," ="," ",U(S),t.week_count>1?` (${t.week_count} fechas en la semana)`:""]}):e.jsxs(e.Fragment,{children:["Base ",U(S)]})}),e.jsx(K,{size:"sm",variant:"outline",disabled:!u||!N||!!d[t.technician_id]||!((pe=q.find(D=>D.id===t.technician_id))!=null&&pe.email),onClick:async()=>{var D;if(u){o(M=>({...M,[t.technician_id]:!0}));try{const M=await je({jobId:u,supabase:_,quotes:h.filter(O=>O.technician_id===t.technician_id),profiles:q,technicianIds:[t.technician_id]});if(M.error)k.error("No se pudo enviar el correo a este técnico");else{const O=Array.isArray((D=M.response)==null?void 0:D.results)?M.response.results.find(Fe=>Fe.technician_id===t.technician_id):{sent:M.success};O!=null&&O.sent?k.success("Correo enviado a este técnico"):k.warning("No se pudo enviar el correo a este técnico")}}catch{k.error("Se produjo un error al enviar")}finally{o(M=>({...M,[t.technician_id]:!1}))}}},title:N?(he=q.find(D=>D.id===t.technician_id))!=null&&he.email?"Enviar a este técnico":"Sin correo configurado":"Liberar pago final para habilitar envío",children:d[t.technician_id]?"Enviando…":"Enviar"})]})]}),(b==null?void 0:b.job_type)==="tourdate"&&t.is_tour_team_member&&e.jsxs("div",{className:"text-xs text-muted-foreground p-2 bg-muted/30 rounded-md flex items-center gap-2",children:[e.jsx(z,{variant:"outline",className:"text-xs",children:"Asignado tour completo"}),e.jsx("span",{children:"Multiplicadores aplicados automáticamente"})]}),w&&e.jsxs("div",{className:"flex flex-col gap-2 p-3 rounded-lg border bg-amber-50 border-amber-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 text-sm",children:[e.jsx(st,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"Problema:"}),e.jsxs("span",{children:[v==="category_missing"&&"Falta categoría",v==="house_rate_missing"&&"Falta tarifa de house tech",v==="tour_base_missing"&&"Falta tarifa base de gira para la categoría"]})]}),v==="category_missing"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"text-xs",children:"Establecer categoría:"}),e.jsxs(fe,{onValueChange:D=>x.mutate({technicianId:t.technician_id,category:D}),children:[e.jsx(be,{className:"w-48",children:e.jsx(ge,{placeholder:"Elegir"})}),e.jsxs(xe,{children:[e.jsx(V,{value:"tecnico",children:"Técnico"}),e.jsx(V,{value:"especialista",children:"Especialista"}),e.jsx(V,{value:"responsable",children:"Responsable"})]})]}),e.jsx(K,{variant:"outline",size:"sm",disabled:x.isPending,children:"Aplicar"})]}),v==="house_rate_missing"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"text-xs min-w-[120px]",children:"Día base (en plantilla):"}),e.jsx(ne,{type:"number",placeholder:"EUR",className:"w-40",onKeyDown:async D=>{if(D.key==="Enter"){const M=parseFloat(D.target.value);isNaN(M)||(await r.mutateAsync({profile_id:t.technician_id,base_day_eur:M,plus_10_12_eur:null,overtime_hour_eur:null}),s.invalidateQueries({queryKey:["tour-job-rate-quotes"]}),s.invalidateQueries({queryKey:["tour-job-rate-quotes-manager"]}))}}}),e.jsx(K,{size:"sm",variant:"outline",onClick:async()=>{const D=document.activeElement,M=parseFloat((D==null?void 0:D.value)||"");isNaN(M)||(await r.mutateAsync({profile_id:t.technician_id,base_day_eur:M,plus_10_12_eur:null,overtime_hour_eur:null}),s.invalidateQueries({queryKey:["tour-job-rate-quotes"]}),s.invalidateQueries({queryKey:["tour-job-rate-quotes-manager"]}))},children:"Guardar"}),l[t.technician_id]!==void 0&&e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:["Actual: ",U(l[t.technician_id])]})]}),v==="tour_base_missing"&&e.jsx("div",{className:"text-xs text-amber-800",children:'Define la tarifa base para esta categoría en la pestaña "Tarifas base".'})]}),e.jsxs("div",{className:"p-3 rounded-lg border space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(z,{variant:N?"default":"secondary",children:N?"Pago final liberado (base + extras)":"Pendiente liberar base + extras"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"El pago final muestra a los técnicos la suma de la tarifa base y los extras asignados."})]}),e.jsx(K,{size:"sm",variant:N?"outline":"default",disabled:ce.isPending||!u,onClick:()=>u&&ce.mutate({jobId:u,approve:!N}),className:"flex items-center gap-1",children:N?e.jsxs(e.Fragment,{children:[e.jsx(Ee,{className:"h-4 w-4"})," Revocar pago final"]}):e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"h-4 w-4"})," Liberar pago final"]})})]}),e.jsx("div",{className:"text-xs font-medium",children:"Extras"}),e.jsx(We,{jobId:t.job_id,technicianId:t.technician_id,technicianName:p,isManager:!0,showVehicleDisclaimer:!!t.vehicle_disclaimer,vehicleDisclaimerText:t.vehicle_disclaimer_text})]})]})},t.technician_id+t.job_id)})]})]}),e.jsx(se,{value:"extras",className:"space-y-4",children:e.jsx(nt,{})}),e.jsx(se,{value:"base",className:"space-y-4",children:e.jsx(lt,{})})]})]})})}export{lt as B,nt as E,Bt as T,qt as a,_t as b,Mt as c,Ft as f};
