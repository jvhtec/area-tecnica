import{r as f,f as O,m as r,n as s}from"./index-NZ6jJLfQ.js";import{R as $}from"./ratesQueryKeys-DgMsgg6U.js";const N=(i,c)=>{const[j,T]=f.useState([]),[S,_]=f.useState(!0),[q,E]=f.useState(!1),k=O(),p=f.useCallback(()=>{i&&(k.invalidateQueries({queryKey:["job-approval-status",i]}),k.invalidateQueries({queryKey:$.approvals}))},[i,k]),m=f.useCallback(async()=>{try{_(!0),E(!1);const{data:t,error:e}=await r.from("timesheets").select("*").eq("job_id",i).order("date",{ascending:!0}).order("created_at",{ascending:!0});if(e){E(!0),s.error("Failed to fetch timesheets");return}if(!t||t.length===0){T([]);return}const n=[...new Set(t.map(l=>l.technician_id))],{data:a}=await r.from("profiles").select("id, first_name, last_name, email, department").in("id",n),{data:h,error:d}=await r.rpc("get_timesheets_batch",{_timesheet_ids:t.map(l=>l.id)}),y=new Map;(h||[]).forEach(l=>{y.set(l.id,l)});const b=t.map(l=>{const o=y.get(l.id);return{...l,amount_eur:(o==null?void 0:o.amount_eur)??void 0,amount_breakdown:(o==null?void 0:o.amount_breakdown)??void 0,amount_eur_visible:(o==null?void 0:o.amount_eur_visible)??null,amount_breakdown_visible:(o==null?void 0:o.amount_breakdown_visible)??null,technician:a==null?void 0:a.find(F=>F.id===l.technician_id)}});T(b)}catch{E(!0),s.error("Failed to fetch timesheets")}finally{_(!1)}},[i]),C=f.useCallback(async()=>{var t;try{const{data:e,error:n}=await r.from("job_assignments").select("technician_id").eq("job_id",i);if(n||!e){_(!1);return}const{data:a,error:h}=await r.from("jobs").select(`
          start_time, 
          end_time,
          job_type,
          job_date_types(type, date)
        `).eq("id",i).single();if(h||!a){_(!1);return}const d=String(a.job_type||"").toLowerCase();if(d==="dryhire"||d==="dry_hire"||d==="tourdate"){_(!1);return}const y=new Date(a.start_time),b=new Date(a.end_time),l=[];for(let u=new Date(y);u<=b;u.setDate(u.getDate()+1))l.push(u.toISOString().split("T")[0]);const o=l.filter(u=>{var v;const g=(v=a.job_date_types)==null?void 0:v.find(K=>K.date===u);return!g||g.type!=="off"&&g.type!=="travel"}),{data:F}=await r.from("timesheets").select("technician_id, date").eq("job_id",i),A=new Set((F||[]).map(u=>`${u.technician_id}-${u.date}`)),D=[];for(const u of e)for(const g of o){const v=`${u.technician_id}-${g}`;A.has(v)||D.push({job_id:i,technician_id:u.technician_id,date:g,created_by:(t=(await r.auth.getUser()).data.user)==null?void 0:t.id})}if(D.length>0){const{error:u}=await r.from("timesheets").insert(D);u?_(!1):setTimeout(()=>m(),500)}else _(!1)}catch{_(!1)}},[i,m]),R=f.useRef(null);f.useEffect(()=>{const t=(c==null?void 0:c.userRole)==="admin"||(c==null?void 0:c.userRole)==="management";!i||!t||R.current!==i&&!S&&j.length===0&&(R.current=i,C())},[i,c==null?void 0:c.userRole,S,j.length,C]),f.useEffect(()=>{c&&typeof c.userRole>"u"||(i&&i.length>0&&i!==""?m():(_(!1),T([])))},[i,m,c==null?void 0:c.userRole]);const x=async(t,e,n)=>{var a;try{const h={job_id:i,technician_id:t,date:e,created_by:(a=(await r.auth.getUser()).data.user)==null?void 0:a.id};n&&(h.category=n);const{data:d,error:y}=await r.from("timesheets").insert(h).select(`
          *,
          technician:profiles!fk_timesheets_technician_id (
            first_name,
            last_name,
            email,
            department
          )
        `).single();return y?(s.error("Failed to create timesheet"),null):(T(b=>[...b,{...d,technician:(d==null?void 0:d.technician)??null}]),s.success("Timesheet created successfully"),d)}catch{return s.error("Failed to create timesheet"),null}},w=async(t,e,n=!1)=>{try{const{data:a,error:h}=await r.from("timesheets").update(e).eq("id",t).select(`
          *,
          technician:profiles!fk_timesheets_technician_id (
            first_name,
            last_name,
            email,
            department
          )
        `).single();if(h)return s.error("Failed to update timesheet"),null;try{Object.keys(e).some(y=>["start_time","end_time","break_minutes","category","ends_next_day"].includes(y))&&await r.rpc("compute_timesheet_amount_2025",{_timesheet_id:t,_persist:!0})}catch{}return n||(await m(),s.success("Timesheet updated successfully"),p()),a}catch{return s.error("Failed to update timesheet"),null}};return{timesheets:j,isLoading:S,isError:q,refetch:m,createTimesheet:x,updateTimesheet:w,submitTimesheet:async t=>{const e=await w(t,{status:"submitted"});if(e!=null&&e.job_id&&(e!=null&&e.technician_id))try{r.functions.invoke("push",{body:{action:"broadcast",type:"timesheet.submitted",job_id:e.job_id,technician_id:e.technician_id}})}catch{}return e},approveTimesheet:async t=>{const e=(await r.auth.getUser()).data.user,n=await w(t,{status:"approved",approved_by_manager:!0,approved_by:e==null?void 0:e.id,approved_at:new Date().toISOString()});try{await r.rpc("compute_timesheet_amount_2025",{_timesheet_id:t,_persist:!0}),await m(),p()}catch{}return n},rejectTimesheet:async(t,e)=>{const n=(await r.auth.getUser()).data.user,a=await w(t,{status:"rejected",approved_by_manager:!1,approved_by:null,approved_at:null,rejected_at:new Date().toISOString(),rejected_by:n==null?void 0:n.id,rejection_reason:e??null},!0);if(a&&(await m(),s.success("Timesheet rejected"),p(),a.job_id&&a.technician_id))try{r.functions.invoke("push",{body:{action:"broadcast",type:"timesheet.rejected",job_id:a.job_id,recipient_id:a.technician_id,technician_id:a.technician_id,rejection_reason:e||void 0}})}catch{}return a},signTimesheet:async(t,e)=>w(t,{signature_data:e,signed_at:new Date().toISOString()}),deleteTimesheet:async t=>{try{const{error:e}=await r.from("timesheets").delete().eq("id",t);if(e)throw s.error("Failed to delete timesheet"),e;await m(),s.success("Timesheet deleted successfully"),p()}catch(e){throw s.error("Failed to delete timesheet"),e}},deleteTimesheets:async t=>{try{const{error:e}=await r.from("timesheets").delete().in("id",t);if(e)throw s.error("Failed to delete timesheets"),e;await m(),s.success(`${t.length} timesheets deleted successfully`),p()}catch(e){throw s.error("Failed to delete timesheets"),e}},recalcTimesheet:async t=>{try{const{data:e,error:n}=await r.rpc("compute_timesheet_amount_2025",{_timesheet_id:t,_persist:!0});return n?(s.error("Failed to recalculate amount"),null):(await m(),s.success("Amount recalculated"),e)}catch{return s.error("Failed to recalculate amount"),null}},revertTimesheet:async t=>{const e=await w(t,{status:"submitted",approved_by_manager:!1,approved_by:null,approved_at:null,rejected_at:null,rejected_by:null,rejection_reason:null},!0);return e&&(await m(),s.success("Timesheet approval reverted"),p()),e}}};export{N as u};
