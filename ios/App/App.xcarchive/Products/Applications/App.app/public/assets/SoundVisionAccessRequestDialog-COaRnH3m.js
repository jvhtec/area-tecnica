import{e as R,f as D,s as i,aG as V,j as e,D as E,q as F,F as C,G as A,aK as L,ac as P,aL as $,B as S,a as _}from"./index-NZ6jJLfQ.js";import{F as Q,a as I,b as U,c as Y,d as K,e as T,f as B}from"./form-DwbSQQJ0.js";import{A as f,a as b}from"./alert-BqA-5jRM.js";import{u as M}from"./useQuery-kdg2pmgf.js";import{u as G}from"./useMutation-DluhVBs1.js";import{C as H}from"./clock-BXPvTWvY.js";import{C as O}from"./circle-check-big-CilmNGCn.js";import{C as X}from"./circle-x-DDzV-xk_.js";const N="[SoundVision Access]",z=()=>{var g,o;const{toast:p}=R(),c=D(),n=M({queryKey:["soundvision-access-requests","user"],queryFn:async()=>{const{data:{user:t}}=await i.auth.getUser();if(!t)throw new Error("User not authenticated");const{data:a,error:d}=await i.from("vacation_requests").select(`
          *,
          technicians:profiles!technician_id(first_name, last_name, department, email)
        `).eq("technician_id",t.id).ilike("reason",`${N}%`).order("created_at",{ascending:!1});if(d)throw d;return(a??[]).filter(u=>u.start_date===u.end_date)}}),m=(n.data||[]).some(t=>t.status==="pending"),l=G({mutationFn:async({note:t})=>{const{data:{user:a}}=await i.auth.getUser();if(!a)throw new Error("User not authenticated");if(m)throw new Error("You already have a pending SoundVision access request");const d=new Date().toISOString().split("T")[0],u=`${N} ${t}`,{data:x,error:s}=await i.from("vacation_requests").insert({technician_id:a.id,start_date:d,end_date:d,reason:u,status:"pending"}).select().single();if(s)throw s;const{data:r}=await i.from("profiles").select("first_name, last_name").eq("id",a.id).single(),j=`${(r==null?void 0:r.first_name)||""} ${(r==null?void 0:r.last_name)||""}`.trim(),k=`SoundVision Access Request from ${j}:

${t}`,{data:v,error:y}=await i.from("messages").insert({content:k,department:"sound",sender_id:a.id,status:"unread",metadata:{type:"soundvision_access_request",vacation_request_id:x.id}}).select().single();if(y)throw y;const{data:w,error:J}=await i.from("profiles").select("id").or("role.eq.admin,and(role.eq.management,department.eq.sound)"),q=(w==null?void 0:w.map(h=>h.id).filter(Boolean))||[];if(q.length>0)try{await Promise.all(q.map(h=>i.functions.invoke("push",{body:{action:"broadcast",type:"message.received",recipient_id:h,message_preview:t.substring(0,100),message_id:v.id,actor_name:j,url:"/messages"}})))}catch{}return{vacationRequest:x,message:v}},onSuccess:()=>{c.invalidateQueries({queryKey:["soundvision-access-requests"]}),c.invalidateQueries({queryKey:["vacation-requests"]}),c.invalidateQueries({queryKey:["messages"]});try{window.dispatchEvent(new Event("messages_invalidated")),window.dispatchEvent(new Event("vacation_requests_invalidated"))}catch{}p({title:"Request submitted!",description:"Your SoundVision access request has been submitted for approval."})},onError:t=>{p({title:"Error submitting request",description:t.message||"An unexpected error occurred.",variant:"destructive"})}});return{soundVisionRequests:n.data||[],isLoadingRequests:n.isLoading,hasPendingRequest:m,submitRequest:l.mutate,isSubmitting:l.isPending,currentStatus:m?"pending":(g=n.data)!=null&&g.find(t=>t.status==="approved")?"approved":(o=n.data)!=null&&o.find(t=>t.status==="rejected")?"rejected":null}},ie=({open:p,onOpenChange:c})=>{var x;const{soundVisionRequests:n,isLoadingRequests:m,hasPendingRequest:l,submitRequest:g,isSubmitting:o,currentStatus:t}=z(),a=V({defaultValues:{note:""}}),d=s=>{if(!s.note.trim()){a.setError("note",{message:"Please provide a reason for requesting access"});return}g({note:s.note},{onSuccess:()=>{a.reset()}})},u=()=>{if(m)return e.jsxs(f,{children:[e.jsx(_,{className:"h-4 w-4 animate-spin"}),e.jsx(b,{children:"Loading your request status..."})]});if(l){const s=n.find(r=>r.status==="pending");return e.jsxs(f,{className:"border-yellow-500 bg-yellow-50 dark:bg-yellow-950",children:[e.jsx(H,{className:"h-4 w-4 text-yellow-600 dark:text-yellow-400"}),e.jsxs(b,{className:"text-yellow-800 dark:text-yellow-200",children:["You have a pending SoundVision access request.",(s==null?void 0:s.created_at)&&e.jsxs("span",{className:"block text-sm text-muted-foreground mt-1",children:["Submitted: ",new Date(s.created_at).toLocaleDateString()]})]})]})}if(t==="approved"){const s=n.find(r=>r.status==="approved");return e.jsxs(f,{className:"border-green-500 bg-green-50 dark:bg-green-950",children:[e.jsx(O,{className:"h-4 w-4 text-green-600 dark:text-green-400"}),e.jsxs(b,{className:"text-green-800 dark:text-green-200",children:["Your SoundVision access request has been approved!",(s==null?void 0:s.approved_at)&&e.jsxs("span",{className:"block text-sm text-muted-foreground mt-1",children:["Approved: ",new Date(s.approved_at).toLocaleDateString()]})]})]})}if(t==="rejected"){const s=n.find(r=>r.status==="rejected");return e.jsxs(f,{className:"border-red-500 bg-red-50 dark:bg-red-950",children:[e.jsx(X,{className:"h-4 w-4 text-red-600 dark:text-red-400"}),e.jsxs(b,{className:"text-red-800 dark:text-red-200",children:["Your previous SoundVision access request was not approved.",(s==null?void 0:s.rejection_reason)&&e.jsxs("span",{className:"block text-sm mt-1",children:["Reason: ",s.rejection_reason]}),e.jsx("span",{className:"block text-sm text-muted-foreground mt-1",children:"You can submit a new request below."})]})]})}return null};return e.jsx(E,{open:p,onOpenChange:c,children:e.jsxs(F,{className:"sm:max-w-[500px]",children:[e.jsxs(C,{children:[e.jsx(A,{children:"Request SoundVision Access"}),e.jsx(L,{children:"Submit a request to access the SoundVision files database. Management will review your request."})]}),e.jsxs("div",{className:"space-y-4",children:[u(),e.jsx(Q,{...a,children:e.jsxs("form",{onSubmit:a.handleSubmit(d),className:"space-y-4",children:[e.jsx(I,{control:a.control,name:"note",render:({field:s})=>e.jsxs(U,{children:[e.jsx(Y,{children:"Reason for Access"}),e.jsx(K,{children:e.jsx(P,{...s,placeholder:"Please explain why you need access to SoundVision files...",rows:4,disabled:o||l})}),e.jsx(T,{children:"Provide details about your role or project that requires SoundVision access."}),e.jsx(B,{})]})}),e.jsxs($,{children:[e.jsx(S,{type:"button",variant:"outline",onClick:()=>c(!1),disabled:o,children:"Close"}),e.jsx(S,{type:"submit",disabled:o||l||!((x=a.watch("note"))!=null&&x.trim()),children:o?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"mr-2 h-4 w-4 animate-spin"}),"Submitting..."]}):"Submit Request"})]})]})}),n.length>0&&e.jsxs("div",{className:"mt-6 pt-4 border-t",children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"Request History"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:n.slice(0,5).map(s=>e.jsxs("div",{className:"text-xs p-2 rounded bg-muted/50 flex justify-between items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"block text-muted-foreground",children:new Date(s.created_at).toLocaleDateString()}),e.jsx("span",{className:"block text-xs line-clamp-1",children:s.reason.replace("[SoundVision Access]","").trim()})]}),e.jsx("span",{className:`text-xs font-medium px-2 py-1 rounded ${s.status==="approved"?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200":s.status==="rejected"?"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200":"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200"}`,children:s.status})]},s.id))})]})]})]})})};export{ie as S};
