import{r as d,f as oe,bX as ce,s as U,n as N,j as e,D as le,q as de,F as me,G as ue,c as q,C as V,Q as he,W,Y as Z,B as b,c7 as $,ca as fe,cb as K,u as pe,N as xe,A as ge,a as G,R as ve}from"./index-NZ6jJLfQ.js";import{u as we}from"./useQuery-kdg2pmgf.js";import{J as ye,D as je}from"./JobExtrasManagement-CpH8R_KL.js";import{M as Ce}from"./music-Dlz2JBJr.js";import{C as be}from"./calendar-days-DcwEz6pd.js";import{S as Ne}from"./separator-E-JdTFOv.js";import{P as _e,g as Ee}from"./festivalPdfGenerator-gdXb7BRp.js";import{fetchJobLogo as Se}from"./logoUtils-D2o1jUVg.js";import{S as De}from"./subscription-indicator-DAcdH7Ud.js";import{C as ke}from"./chevron-left-rq2ui83a.js";import{C as Re}from"./chevron-right-Bn7Eu0F7.js";import{T as Le}from"./tent-G6tzA2Go.js";import{E as Te}from"./eye-off-ljd0ixjZ.js";import{E as Fe}from"./eye-BE_DouVP.js";import{T as Me}from"./triangle-alert-D6qN0F8g.js";import{P as ze}from"./printer-De77t3j8.js";import"./vite-preload-helper-ckwbz45p.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./badge-vNTKF5RD.js";import"./JobExtrasEditor-gQe73Sd8.js";import"./useMutation-DluhVBs1.js";import"./ratesQueryKeys-DgMsgg6U.js";import"./euro-DgRTeGAz.js";import"./minus-InO4I9Ks.js";import"./plus-C3JQqq7t.js";import"./circle-alert-LZYNzZ7F.js";import"./useJobPayoutTotals-CXAavZS-.js";import"./users-DMnpVLUq.js";import"./checkbox-BsRNEGV1.js";import"./artistPdfExport-DnsKQk1F.js";import"./lazyPdf-xVUlxKNu.js";import"./download-C1rVE0-J.js";import"./pdf-libs-BqoGqu1a.js";import"./pdfMerge-DXtLP7Xx.js";import"./weatherApi-BatwQpQy.js";import"./logo-url-cache-eY6nfvu7.js";import"./formatDistanceToNow-Bbdi_GlK.js";import"./constructNow-u0VlpghF.js";import"./differenceInCalendarMonths-6exvViir.js";import"./endOfMonth-Byhxb84j.js";import"./wifi-C3_7SFyW.js";function Q(t,a,m={}){const{enabled:c=!0,priority:s="medium",dependencies:g=[]}=m,x=d.useMemo(()=>JSON.stringify(a),[a]),i=d.useMemo(()=>a,[x]),l=oe(),o=ce.getInstance(l),v=d.useRef(null),[r,h]=d.useState({isConnected:!1,isLoading:!1,error:null,retryCount:0});return d.useEffect(()=>{if(c){h(u=>({...u,isLoading:!0,error:null}));try{v.current=o.subscribeToTable(t,i,void 0,s),h(u=>({...u,isConnected:!0,isLoading:!1,error:null}))}catch(u){h(p=>({...p,isConnected:!1,isLoading:!1,error:u instanceof Error?u.message:"Unknown error",retryCount:p.retryCount+1}))}return()=>{v.current&&(v.current.unsubscribe(),v.current=null)}}},[c,t,i,x,s,o,...g]),d.useEffect(()=>()=>{v.current&&v.current.unsubscribe()},[]),{...r,retry:()=>{h(u=>({...u,retryCount:0})),h(u=>({...u,isLoading:!0}))},stats:o.getSnapshot()}}function Ie(t,a){const m={},c={};return t.forEach(s=>{c[s.job_id]||(c[s.job_id]=[]),c[s.job_id].push(s)}),Object.keys(c).forEach(s=>{const g=c[s],x=a[s]||[],i=[],l={};g.forEach(o=>{l[o.technician_id]||(l[o.technician_id]=[]),l[o.technician_id].push(o)}),Object.keys(l).forEach(o=>{const v=l[o],r=x.find(u=>u.technician_id===o),h=(r==null?void 0:r.profiles)||v[0].technician||{id:o,first_name:"Unknown",last_name:"Technician",nickname:"",department:""},j={technician_id:o,technician:h,dates:v.map(u=>u.date).sort(),status:(r==null?void 0:r.status)||"confirmed",source:r?"assignment":"timesheet",roles:{sound_role:r==null?void 0:r.sound_role,lights_role:r==null?void 0:r.lights_role,video_role:r==null?void 0:r.video_role},original_assignment:r};i.push(j)}),m[s]=i}),m}function Oe(){const[t,a]=d.useState(0),[m,c]=d.useState(!1),s=3,g=d.useCallback(async()=>{try{const{data:p,error:_}=await U.from("jobs").select(`
            *,
            location:locations(name),
            job_departments!inner(department),
            job_assignments(
              id,
              technician_id,
              sound_role,
              lights_role,
              video_role,
              assignment_source,
              status,
              single_day,
              assignment_date,
              profiles!job_assignments_technician_id_fkey(
                id,
                first_name,
                last_name,
                nickname,
                department
              )
            ),
            job_documents(*),
            tour_date:tour_dates(*)
          `);if(_)throw _.code==="401"?(window.dispatchEvent(new CustomEvent("token-refresh-needed")),new Error("Authorization error. Refreshing credentials...")):_;const S=p||[],R=S.map(w=>w.id).filter(Boolean);let M={};if(R.length>0){const I=[];for(let y=0;y<R.length;y+=100)I.push(R.slice(y,y+100));const D=I.map(y=>U.from("timesheets").select(`
              job_id,
              technician_id,
              date,
              is_schedule_only,
              technician:profiles!fk_timesheets_technician_id(
                id,
                first_name,
                last_name,
                nickname,
                department
              )
            `).eq("is_schedule_only",!1).eq("is_active",!0).in("job_id",y)),O=await Promise.all(D),k=[];for(const{data:y,error:E}of O){if(E)throw E;y&&k.push(...y)}const L=S.reduce((y,E)=>(y[E.id]=E.job_assignments||[],y),{});M=Ie(k,L)}const z=S.map(w=>({...w,timesheet_assignments:M[w.id]||[]}));return a(0),c(!1),z}catch(p){if(t<s)throw a(_=>_+1),p;return c(!0),[]}},[t,s]),{data:x,isLoading:i,isError:l,error:o,refetch:v}=we({queryKey:["jobs"],queryFn:g,retry:s,retryDelay:p=>Math.min(1e3*2**p,1e4),enabled:!m,staleTime:120*1e3,refetchOnWindowFocus:!1}),r=Q("jobs","jobs",{enabled:!m,priority:"high"}),h=Q("timesheets",["jobs","timesheets"],{enabled:!m,priority:"high"}),j=d.useMemo(()=>({isConnected:r.isConnected&&h.isConnected,isLoading:r.isLoading||h.isLoading,error:r.error||h.error,retryCount:r.retryCount+h.retryCount,retry:r.retry,stats:r.stats}),[r,h]);return d.useEffect(()=>{j.error&&!i&&N.warning("Real-time updates experiencing issues",{description:"Data will still update, but may be slightly delayed.",duration:3e3})},[j.error,i]),{jobs:x,isLoading:i,isError:l,error:o,refetch:async()=>{try{c(!1),a(0),await v(),N.success("Data refreshed successfully")}catch{N.error("Failed to refresh data")}},isRefreshing:i,realtimeStatus:j,isPaused:m,retryCount:t,maxRetries:s}}const Je=({open:t,onOpenChange:a,jobId:m,jobTitle:c,isManager:s=!1})=>e.jsx(le,{open:t,onOpenChange:a,children:e.jsxs(de,{className:"max-w-4xl max-h-[85vh] md:max-h-[90vh] overflow-y-auto w-[95vw] md:w-full",children:[e.jsx(me,{children:e.jsxs(ue,{className:"text-base md:text-lg",children:["Job Extras - ",c]})}),e.jsx(ye,{jobId:m,isManager:s})]})}),Pe=({job:t,onEditClick:a,onDeleteClick:m,onJobClick:c,userRole:s,department:g,selectedDate:x,festivalLogo:i,hideFestivalControls:l=!1})=>{const o=q(),[v,r]=d.useState(!1),h=p=>{p.stopPropagation(),o(`/festival-management/${t.id}`)},j=["admin","management","logistics","technician"].includes(s||""),u=["admin","management"].includes(s||"");return e.jsxs(V,{className:he("relative transition-all hover:shadow-lg cursor-pointer",t.color&&`border-l-4 border-l-[${t.color}]`),onClick:()=>c(t.id),children:[e.jsx(W,{className:"relative",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-3 md:gap-2",children:[e.jsxs(Z,{className:"text-base md:text-lg font-semibold flex items-center gap-2",children:[e.jsx("span",{className:"break-words",children:t.title}),t.job_type==="festival"&&e.jsx(Ce,{className:"inline-block h-4 w-4 text-primary flex-shrink-0"})]}),e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap items-center gap-2",children:[u&&e.jsxs(b,{variant:"outline",size:"sm",onClick:p=>{p.stopPropagation(),r(!0)},className:"flex items-center gap-1 h-8 md:h-9",children:[e.jsx(je,{className:"h-3 w-3"}),e.jsx("span",{className:"hidden sm:inline",children:"Extras"})]}),t.job_type==="festival"&&j&&e.jsxs(b,{variant:"outline",size:"sm",onClick:h,className:"h-8 md:h-9 text-xs md:text-sm",children:[e.jsx("span",{className:"hidden sm:inline",children:s==="technician"?"View Festival":"Manage Festival"}),e.jsx("span",{className:"sm:hidden",children:s==="technician"?"View":"Manage"})]}),u&&!l&&e.jsxs(e.Fragment,{children:[e.jsx(b,{variant:"outline",size:"sm",onClick:p=>{p.stopPropagation(),a(t)},className:"h-8 md:h-9",children:"Edit"}),e.jsx(b,{variant:"destructive",size:"sm",onClick:p=>{p.stopPropagation(),m(t.id)},className:"h-8 md:h-9",children:"Delete"})]})]})]})}),e.jsxs("div",{className:"p-3 md:p-4",children:[i&&e.jsx("div",{className:"mb-4 h-24 md:h-32 flex justify-center items-center",children:e.jsx("img",{src:i,alt:`${t.title} logo`,width:512,height:512,loading:"lazy",decoding:"async",className:"h-full w-full object-contain"})}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground line-clamp-3 md:line-clamp-none break-words",children:t.description}),e.jsxs("div",{className:"mt-2 flex items-start md:items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4 text-muted-foreground flex-shrink-0 mt-0.5 md:mt-0"}),e.jsxs("span",{className:"text-xs md:text-sm text-muted-foreground break-words",children:[new Date(t.start_time).toLocaleDateString()," - ",new Date(t.end_time).toLocaleDateString()]})]})]}),e.jsx(Je,{open:v,onOpenChange:r,jobId:t.id,jobTitle:t.title,isManager:u})]})};function Ae(){const[t,a]=d.useState(()=>$()==="CONNECTED"?"connected":"disconnected"),[m,c]=d.useState(Date.now()),[s,g]=d.useState(!1),x=fe.getInstance();d.useEffect(()=>{let l=null;const o=()=>{const j=$(),u=j==="CONNECTED"?"connected":j==="CONNECTING"?"connecting":"disconnected";a(u),u==="connected"&&c(Date.now())},v=()=>{l||(l=window.setInterval(o,1e4))},r=()=>{l&&(clearInterval(l),l=null)},h=()=>{if(document.hidden){r();return}o(),v()};return document.addEventListener("visibilitychange",h,{passive:!0}),h(),()=>{r(),document.removeEventListener("visibilitychange",h)}},[]),d.useEffect(()=>{const l=()=>{i()},o=()=>{a("disconnected")};return window.addEventListener("online",l),window.addEventListener("offline",o),()=>{window.removeEventListener("online",l),window.removeEventListener("offline",o)}},[]);const i=async()=>{if(!s)try{g(!0),a("connecting");const l=await K();return x.getTimeSinceLastRefresh()>600*1e3&&await x.refreshToken(),l?(window.dispatchEvent(new CustomEvent("connection-restored")),a("connected"),c(Date.now()),!0):(a("disconnected"),!1)}catch{return a("disconnected"),!1}finally{g(!1)}};return{status:t,isConnected:t==="connected",isConnecting:t==="connecting",isDisconnected:t==="disconnected",lastConnected:m,timeSinceLastConnection:Date.now()-m,recoverConnection:i,isRecovering:s}}const He=({currentPage:t,totalPages:a,onPageChange:m,totalItems:c,itemsPerPage:s})=>{const g=(t-1)*s+1,x=Math.min(t*s,c);return e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-4 px-2",children:[e.jsxs("div",{className:"text-xs sm:text-sm text-muted-foreground order-2 sm:order-1",children:["Mostrando ",g,"-",x," de ",c," festivales"]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 order-1 sm:order-2",children:[e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>m(t-1),disabled:t<=1,className:"h-9 sm:h-8",children:[e.jsx(ke,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Anterior"})]}),e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:a},(i,l)=>l+1).map(i=>i===1||i===a||i>=t-1&&i<=t+1?e.jsx(b,{variant:i===t?"default":"outline",size:"sm",onClick:()=>m(i),className:"w-9 h-9 sm:w-8 sm:h-8 p-0 touch-manipulation",children:i},i):i===t-2||i===t+2?e.jsx("span",{className:"px-1 sm:px-2 text-xs sm:text-sm text-muted-foreground",children:"..."},i):null)}),e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>m(t+1),disabled:t>=a,className:"h-9 sm:h-8",children:[e.jsx("span",{className:"hidden sm:inline",children:"Siguiente"}),e.jsx(Re,{className:"h-4 w-4"})]})]})]})},Be=t=>{if(!t||t.length===0)return null;const a=new Date;a.setHours(0,0,0,0);let m=t[0];const c=new Date(t[0].start_time);c.setHours(0,0,0,0);let s=Math.abs(c.getTime()-a.getTime());return t.forEach(g=>{const x=new Date(g.start_time);x.setHours(0,0,0,0);const i=Math.abs(x.getTime()-a.getTime());i<s&&(s=i,m=g)}),m},Ue=(t,a,m)=>{if(!a||!t.length)return 1;const c=t.findIndex(s=>s.id===a.id);return c===-1?1:Math.floor(c/m)+1},F=9,Lt=()=>{const t=q(),{userRole:a,userDepartment:m,isLoading:c}=pe(),{jobs:s,isLoading:g,isError:x,error:i,refetch:l}=Oe(),[o,v]=d.useState([]),[r,h]=d.useState({}),[j,u]=d.useState({}),[p,_]=d.useState(1),[S,R]=d.useState(null),[M,z]=d.useState(!1),[w,I]=d.useState(null),[D,O]=d.useState(!1),{status:k,recoverConnection:L}=Ae(),y=d.useRef({});d.useEffect(()=>{if(s){let n=s.filter(f=>f.job_type==="festival"&&f.status!=="Cancelado");D||(n=n.filter(f=>f.status!=="Completado")),v(n),n.forEach(ee)}},[s,D]),d.useEffect(()=>{if(o.length>0){const n=Be(o);if(n){const f=Ue(o,n,F);_(f),R(n.id),setTimeout(()=>{te(n.id)},300)}}},[o]),d.useEffect(()=>{if(S){const n=setTimeout(()=>{R(null)},3e3);return()=>clearTimeout(n)}},[S]);const E=Math.ceil(o.length/F),J=(p-1)*F,X=J+F,Y=o.slice(J,X);d.useEffect(()=>{(x||k!=="connected"&&!g)&&(async()=>(await L(),l()))()},[x,k,g,L,l]);const ee=async n=>{try{const f=await Se(n.id);f&&h(C=>({...C,[n.id]:f}))}catch{}},te=n=>{const f=y.current[n];f&&f.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})},P=n=>{t(`/festival-management/${n}`)},se=(n,f)=>{I({id:n,title:f}),z(!0)},ne=async(n,f)=>{if(w){u(C=>({...C,[w.id]:!0}));try{const C=await Ee(w.id,w.title,n,f);if(!C.blob||C.blob.size===0)throw new Error("Generated PDF is empty");const B=URL.createObjectURL(C.blob),T=document.createElement("a");T.href=B,T.download=C.filename,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(B),N.success("Documentación generada exitosamente")}catch(C){N.error(`Error al generar documentación: ${C.message}`)}finally{u(C=>({...C,[w.id]:!1}))}}},A=async()=>{try{N.info("Actualizando datos de festivales..."),await K()?(await l(),N.success("Datos de festival actualizados")):(await L(),await l(),N.success("Conexión restaurada y datos actualizados"))}catch{N.error("No se pudieron actualizar los datos. Por favor, inténtalo de nuevo.")}},ae=a==="admin",ie=(m==null?void 0:m.toLowerCase())==="sound";if(!c&&!ae&&!ie)return e.jsx(xe,{to:"/dashboard",replace:!0});const re=["admin","management","logistics"].includes(a||""),H=()=>{};return e.jsxs("div",{className:"w-full space-y-4 md:space-y-6 px-4 sm:px-6 py-4",children:[e.jsxs(V,{children:[e.jsxs(W,{className:"flex flex-col md:flex-row md:items-center justify-between space-y-4 md:space-y-0 pb-2",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Z,{className:"text-xl md:text-2xl font-bold",children:"Gestión de Festivales"}),e.jsx(Le,{className:"h-5 w-5 md:h-6 md:w-6 text-muted-foreground"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-2",children:[e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>O(!D),className:"w-full sm:w-auto",children:[D?e.jsx(Te,{className:"h-4 w-4 sm:mr-2"}):e.jsx(Fe,{className:"h-4 w-4 sm:mr-2"}),e.jsx("span",{className:"ml-2 sm:ml-0",children:D?"Ocultar Completados":"Mostrar Completados"})]}),e.jsx(De,{tables:["jobs","job_assignments","job_departments","job_date_types","festival_logos"],showRefreshButton:!0,onRefresh:A,showLabel:!0,className:"justify-center sm:justify-start"})]})]}),e.jsxs(ge,{children:[e.jsx("p",{className:"text-muted-foreground mb-6",children:"Accede y gestiona todos los eventos tipo festival en un solo lugar."}),e.jsx(Ne,{className:"my-6"}),g?e.jsxs("div",{className:"flex flex-col justify-center items-center h-40",children:[e.jsx(G,{className:"h-8 w-8 animate-spin mb-2 text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Cargando festivales..."}),k!=="connected"&&e.jsx("p",{className:"text-amber-500 mt-2",children:"Estableciendo conexión..."})]}):x?e.jsxs("div",{className:"flex flex-col justify-center items-center h-40 text-center",children:[e.jsx(Me,{className:"h-8 w-8 mb-2 text-destructive"}),e.jsx("h3",{className:"text-lg font-medium text-destructive",children:"Error al cargar festivales"}),e.jsx("p",{className:"text-muted-foreground mt-2 max-w-md",children:i instanceof Error?i.message:"Ha ocurrido un error desconocido"}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-2",children:["Estado de conexión: ",k]}),e.jsxs(b,{variant:"outline",size:"sm",onClick:A,className:"mt-4",children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"Reconectar e Intentar de Nuevo"]})]}):o.length===0?e.jsxs("div",{className:"text-center py-10",children:[e.jsx("h3",{className:"text-lg font-medium",children:"No se encontraron festivales"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Actualmente no hay trabajos tipo festival programados."})]}):e.jsxs("div",{className:"space-y-4 md:space-y-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 snap-y snap-mandatory md:snap-none overflow-y-auto md:overflow-visible max-h-[70vh] md:max-h-none",children:Y.map(n=>e.jsxs("div",{className:"relative snap-start min-h-[280px] md:min-h-0",ref:f=>{y.current[n.id]=f},children:[e.jsx("div",{onClick:()=>P(n.id),className:`cursor-pointer transition-all duration-300 active:scale-95 md:active:scale-100 ${S===n.id?"ring-2 ring-primary ring-offset-2 shadow-lg md:scale-105":""}`,children:e.jsx(Pe,{job:n,onJobClick:()=>P(n.id),onEditClick:H,onDeleteClick:H,userRole:a,department:"sound",festivalLogo:r[n.id],hideFestivalControls:!0})}),re&&e.jsxs(b,{variant:"outline",size:"sm",className:"absolute top-3 right-3 md:top-2 md:right-2 z-10 h-9 w-9 md:h-8 md:w-8 p-0",onClick:f=>{f.stopPropagation(),se(n.id,n.title)},disabled:j[n.id],children:[j[n.id]?e.jsx(G,{className:"h-4 w-4 animate-spin"}):e.jsx(ze,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Imprimir Documentación"})]})]},n.id))}),E>1&&e.jsx(He,{currentPage:p,totalPages:E,onPageChange:_,totalItems:o.length,itemsPerPage:F})]})]})]}),e.jsx(_e,{open:M,onOpenChange:z,onConfirm:ne,maxStages:3,jobTitle:(w==null?void 0:w.title)||"",jobId:w==null?void 0:w.id})]})};export{Lt as default};
