const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/logoUtils-D2o1jUVg.js","assets/index-NZ6jJLfQ.js","assets/vite-preload-helper-ckwbz45p.js","assets/commonjs-helpers-Cpj98o6Y.js","assets/index-DFO7exW2.css","assets/logo-url-cache-eY6nfvu7.js","assets/jobDocumentsUpload-BaycvzFe.js","assets/taskAutoCompletion-DInRlPJM.js","assets/taskCompletion-NTcmWFA_.js"])))=>i.map(i=>d[i]);
import{_ as S}from"./vite-preload-helper-ckwbz45p.js";import{c as Ne,e as we,b as fe,r as m,j as e,C as q,A as Y,W as ge,B as N,Y as Te,L as h,S as E,t as P,v,w as y,x as w,I as O,V as Ee,s as Pe}from"./index-NZ6jJLfQ.js";import{e as ve}from"./pdfExport-DjZPdCcG.js";import{u as ye}from"./useJobSelection-B9iLNF5-.js";import{C as K}from"./checkbox-BsRNEGV1.js";import{u as Ae,T as Ce}from"./TourOverrideModeHeader-C5X_h6fg.js";import{B as $}from"./badge-vNTKF5RD.js";import{A as Re}from"./arrow-left-VpQwT4cv.js";import{F as Se}from"./file-text-igU140SQ.js";import"./commonjs-helpers-Cpj98o6Y.js";import"./lazyPdf-xVUlxKNu.js";import"./useQuery-kdg2pmgf.js";import"./settings-egXcSQW9.js";import"./calendar-_Cj_Sgy-.js";const F=[{id:1,name:"CAMEO OPUS S5",watts:650},{id:2,name:"CLAY PAKY A-LEDA K20",watts:650},{id:3,name:"CLAY PAKY A-LEDA K25",watts:1100},{id:4,name:"CLAY PAKY STORMY CC",watts:800},{id:5,name:"ELATION CHORUS LINE 16",watts:750},{id:6,name:"MARTIN MAC AURA",watts:260},{id:7,name:"MARTIN MAC VIPER",watts:1200},{id:8,name:"ROBE BMFL BLADE",watts:2e3},{id:9,name:"ROBE BMFL SPOT",watts:2e3},{id:10,name:"ROBE BMFL WASHBEAM",watts:2e3},{id:11,name:"ROBE MEGAPOINTE",watts:670},{id:12,name:"ROBE POINTE",watts:470},{id:13,name:"TRITON BLUE 15R BEAM",watts:500},{id:14,name:"TRITON BLUE 15R SPOT",watts:500},{id:15,name:"TRITON BLUE WALLY 3715",watts:650},{id:16,name:"CAMEO AURO BAR 100",watts:140},{id:17,name:"ACL 250W (2 BARRAS)",watts:2e3},{id:18,name:"ACL 650W (2 BARRAS)",watts:5200},{id:19,name:"BARRA PAR 64x6",watts:6e3},{id:20,name:"FRESNELL 2KW",watts:2e3},{id:21,name:"MOLEFAY BLINDER 4",watts:2600},{id:22,name:"MOLEFAY BLINDER 8",watts:5200},{id:23,name:"PAR 64",watts:1e3},{id:24,name:"ADMIRAL VINTAGE 53cm",watts:60},{id:25,name:"ADMIRAL VINTAGE 38cm",watts:60},{id:26,name:"FRESNELL 5KW",watts:5e3},{id:27,name:"MOLEFAY BLINDER 2",watts:1300},{id:28,name:"RECORTE ETC 25º/50º",watts:750},{id:29,name:"RECORTE ETC 15º/30º",watts:750},{id:30,name:"RECORTE ETC 19º",watts:750},{id:31,name:"RECORTE ETC 10º",watts:750},{id:32,name:"RECORTE TB LED 25º/50º",watts:300},{id:33,name:"SUNSTRIP",watts:500},{id:34,name:"CAMEO ZENIT 120",watts:120},{id:35,name:"ELATION SIXBAR 1000",watts:150},{id:36,name:"MARTIN ATOMIC 3000",watts:3e3},{id:37,name:"SGM Q7",watts:500},{id:38,name:"ELATION SIXBAR 500",watts:80},{id:39,name:"SMOKE FACTORY TOUR HAZERII",watts:1500},{id:40,name:"ROBE 500 FT-PRO",watts:1200},{id:41,name:"SAHARA TURBO DRYER",watts:1500},{id:42,name:"ROBE SPIIDER",watts:660},{id:43,name:"GLP JDC1",watts:1200},{id:44,name:"CAMEO W3",watts:325},{id:45,name:"CHAUVET COLOR STRIKE M",watts:750},{id:46,name:"GLP X4 BAR 20",watts:500},{id:47,name:"ROBERT JULIAT ARAMIS",watts:2500},{id:48,name:"ROBERT JULIAT MERLIN",watts:2500},{id:49,name:"ROBERT JULIAT CYRANO",watts:2500},{id:50,name:"ROBERT JULIAT LANCELOT",watts:4e3},{id:51,name:"ROBERT JULIAT KORRIGAN",watts:1200},{id:52,name:"PIXEL LINE IP",watts:420},{id:53,name:"COLORADO PXL BAR ",watts:768}],Oe=400,Le=.85,Ie=3,z=["CEE32A 3P+N+G","CEE63A 3P+N+G","CEE125A 3P+N+G","Powerlock 400A 3P+N+G","Custom"],Ye=()=>{const X=Ne(),{toast:x}=we(),{data:f}=ye(),[L]=fe(),I=L.get("tourId"),Z=L.get("tourDateId");L.get("mode");const{isOverrideMode:o,overrideData:l,isLoading:Q,saveOverride:ee}=Ae(I||void 0,Z||void 0,"lights"),[u,te]=m.useState(""),[se,ae]=m.useState(null),[b,M]=m.useState(""),[g,_]=m.useState([]),[T,re]=m.useState(0),[W,ie]=m.useState(!1),[A,ne]=m.useState(""),[D,oe]=m.useState(""),[B,C]=m.useState({name:"",rows:[{quantity:"",componentId:"",watts:""}]}),[R,de]=m.useState([]);m.useEffect(()=>{if(o&&l){const t=l.defaults.filter(s=>s.table_type==="power").map(s=>{var a,i;return{name:`${s.table_name} (Default)`,rows:s.table_data.rows||[],totalWatts:s.total_value,currentPerPhase:(a=s.metadata)==null?void 0:a.currentPerPhase,pduType:(i=s.metadata)==null?void 0:i.pduType,id:`default-${s.id}`,isDefault:!0}});de(t)}},[o,l]);const le=()=>{C(t=>({...t,rows:[...t.rows,{quantity:"",componentId:"",watts:""}]}))},ce=t=>{C(s=>{const a=s.rows.filter((i,r)=>r!==t);return{...s,rows:a.length>0?a:[{quantity:"",componentId:"",watts:""}]}})},V=(t,s,a)=>{const i=[...B.rows];if(s==="componentId"){const r=F.find(p=>p.id.toString()===a);i[t]={...i[t],[s]:a,watts:r?r.watts.toString():""}}else i[t]={...i[t],[s]:a};C(r=>({...r,rows:i}))},me=t=>{te(t);const s=(f==null?void 0:f.find(a=>a.id===t))||null;ae(s)},ue=t=>{const s=t*(1+T/100),a=s/Ie,i=a/(Oe*Le);return{wattsPerPhase:a,currentPerPhase:i,adjustedWatts:s}},pe=t=>t<=32?"CEE32A 3P+N+G":t<=63?"CEE63A 3P+N+G":t<=125?"CEE125A 3P+N+G":"Powerlock 400A 3P+N+G",G=async t=>{if(o&&l){await ee("power",{table_name:t.name,total_watts:t.totalWatts||0,current_per_phase:t.currentPerPhase||0,pdu_type:t.customPduType||t.pduType||"",custom_pdu_type:t.customPduType,includes_hoist:t.includesHoist||!1,override_data:{rows:t.rows}})&&x({title:"Success",description:"Override saved for tour date"});return}if(u)try{const{error:s}=await Pe.from("power_requirement_tables").insert({job_id:u,department:"lights",table_name:t.name,total_watts:t.totalWatts||0,current_per_phase:t.currentPerPhase||0,pdu_type:t.customPduType||t.pduType||"",includes_hoist:t.includesHoist||!1,custom_pdu_type:t.customPduType});if(s)throw s;x({title:"Éxito",description:"La tabla de requerimientos de potencia se ha guardado exitosamente"})}catch{x({title:"Error",description:"Error al guardar la tabla de requerimientos de potencia",variant:"destructive"})}},he=()=>{if(!b){x({title:"Falta el nombre de la tabla",description:"Por favor ingrese un nombre para la tabla",variant:"destructive"});return}const t=B.rows.map(n=>{const c=F.find(j=>j.id.toString()===n.componentId),d=parseFloat(n.quantity)&&parseFloat(n.watts)?parseFloat(n.quantity)*parseFloat(n.watts):0;return{...n,componentName:(c==null?void 0:c.name)||"",totalWatts:d}}),s=t.reduce((n,c)=>n+(c.totalWatts||0),0),{currentPerPhase:a,adjustedWatts:i}=ue(s),r=pe(a),p={name:b,rows:t,totalWatts:s,adjustedWatts:i,currentPerPhase:a,pduType:A==="Custom"?D:r,customPduType:A==="Custom"?D:void 0,includesHoist:W,id:Date.now()};_(n=>[...n,p]),u&&G(p),k()},k=()=>{C({name:"",rows:[{quantity:"",componentId:"",watts:""}]}),M("")},xe=t=>{typeof t=="number"&&_(s=>s.filter(a=>a.id!==t))},H=(t,s)=>{typeof t=="number"&&_(a=>a.map(i=>{if(i.id===t){const r={...i,...s};return u&&G(r),r}return i}))},je=async()=>{const t=o&&l?{id:"override",title:`${l.tourName} - ${l.locationName}`}:se;if(!t){x({title:o?"No tour data":"No hay trabajo seleccionado",description:o?"Tour data not loaded":"Por favor seleccione un trabajo antes de exportar.",variant:"destructive"});return}try{const s=o?[...R,...g]:g;let a;try{if(o&&I){const{fetchTourLogo:d}=await S(async()=>{const{fetchTourLogo:j}=await import("./logoUtils-D2o1jUVg.js");return{fetchTourLogo:j}},__vite__mapDeps([0,1,2,3,4,5]));a=await d(I)}else if(u){const{fetchJobLogo:d}=await S(async()=>{const{fetchJobLogo:j}=await import("./logoUtils-D2o1jUVg.js");return{fetchJobLogo:j}},__vite__mapDeps([0,1,2,3,4,5]));a=await d(u)}}catch{}const i=await ve(t.title,s.map(d=>({...d,toolType:"consumos"})),"power",t.title,("start_time"in t?t.start_time:null)||new Date().toISOString(),void 0,void 0,T,a),r=`Informe de Potencia - ${t.title}.pdf`;let p=0;if(!o&&u)try{const{uploadJobPdfWithCleanup:d}=await S(async()=>{const{uploadJobPdfWithCleanup:U}=await import("./jobDocumentsUpload-BaycvzFe.js");return{uploadJobPdfWithCleanup:U}},__vite__mapDeps([6,1,2,3,4]));await d(u,i,r,"calculators/lights-consumos");const{autoCompleteConsumosTasks:j}=await S(async()=>{const{autoCompleteConsumosTasks:U}=await import("./taskAutoCompletion-DInRlPJM.js");return{autoCompleteConsumosTasks:U}},__vite__mapDeps([7,8,1,2,3,4])),J=await j(u,"lights");p=J.completedCount,J.completedCount>0}catch(d){if(d instanceof Error&&d.message.includes("uploadJobPdfWithCleanup"))throw d}x({title:"Éxito",description:p>0?`PDF subido exitosamente. ${p} tarea(s) de Consumos auto-completadas.`:"El PDF se ha generado y subido exitosamente."});const n=window.URL.createObjectURL(i),c=document.createElement("a");c.href=n,c.download=r,document.body.appendChild(c),c.click(),window.URL.revokeObjectURL(n),document.body.removeChild(c)}catch{x({title:"Error",description:"Error al generar o subir el PDF.",variant:"destructive"})}};return Q?e.jsx(q,{className:"w-full max-w-4xl mx-auto my-6",children:e.jsx(Y,{className:"pt-6",children:e.jsx("p",{children:"Loading tour override data..."})})}):e.jsxs(q,{className:"w-full max-w-4xl mx-auto my-6",children:[e.jsx(ge,{className:"space-y-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>X("/lights"),children:e.jsx(Re,{className:"h-4 w-4"})}),e.jsxs(Te,{className:"text-2xl font-bold",children:[o?"Override Mode - ":"","Calculadora de Potencia"]})]})}),e.jsx(Y,{children:e.jsxs("div",{className:"space-y-6",children:[o&&l&&e.jsx(Ce,{tourName:l.tourName,tourDate:l.tourDate,locationName:l.locationName,defaultsCount:R.length,overridesCount:g.length,department:"lights"}),o&&R.length>0&&e.jsxs("div",{className:"border rounded-lg p-4 bg-green-50",children:[e.jsx("h3",{className:"font-semibold mb-3 text-green-800",children:"Tour Defaults (Read-Only)"}),R.map(t=>{var s,a;return e.jsxs("div",{className:"border rounded-lg overflow-x-auto mt-4 bg-white",children:[e.jsx("div",{className:"bg-green-100 px-4 py-3 flex justify-between items-center",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold",children:t.name}),e.jsx($,{variant:"outline",className:"bg-green-50 text-green-700",children:"Default"})]})}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Watts:"})," ",(s=t.totalWatts)==null?void 0:s.toFixed(2)," W"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Current per Phase:"})," ",(a=t.currentPerPhase)==null?void 0:a.toFixed(2)," A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"PDU Type:"})," ",t.pduType]}),t.includesHoist&&e.jsx("div",{className:"col-span-2 text-gray-600 italic",children:"Includes hoist power requirement"})]})})]},t.id)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"safetyMargin",children:"Margen de Seguridad"}),e.jsxs(E,{value:T.toString(),onValueChange:t=>re(Number(t)),children:[e.jsx(P,{children:e.jsx(v,{placeholder:"Seleccionar Margen de Seguridad"})}),e.jsx(y,{children:[0,10,20,30,40,50].map(t=>e.jsxs(w,{value:t.toString(),children:[t,"%"]},t))})]})]}),!o&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"jobSelect",children:"Seleccionar Trabajo"}),e.jsxs(E,{value:u,onValueChange:me,children:[e.jsx(P,{children:e.jsx(v,{placeholder:"Seleccione un trabajo"})}),e.jsx(y,{children:f==null?void 0:f.map(t=>e.jsx(w,{value:t.id,children:t.title},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"tableName",children:"Nombre de la Tabla"}),e.jsx(O,{id:"tableName",value:b,onChange:t=>M(t.target.value),placeholder:"Ingrese el nombre de la tabla"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Anulación del Tipo de PDU"}),e.jsxs(E,{value:A,onValueChange:ne,children:[e.jsx(P,{children:e.jsx(v,{placeholder:"Usar el tipo de PDU recomendado"})}),e.jsxs(y,{children:[e.jsx(w,{value:"default",children:"Usar el tipo de PDU recomendado"}),z.map(t=>e.jsx(w,{value:t,children:t},t))]})]})]}),A==="Custom"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Tipo de PDU Personalizado"}),e.jsx(O,{value:D,onChange:t=>oe(t.target.value),placeholder:"Ingrese un tipo de PDU personalizado"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{id:"hoistPower",checked:W,onCheckedChange:t=>ie(t)}),e.jsx(h,{htmlFor:"hoistPower",children:"Requiere Potencia Adicional para Polipasto (CEE32A 3P+N+G)"})]}),e.jsx("div",{className:"border rounded-lg overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Cantidad"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Componente"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Vatios (por unidad)"}),e.jsx("th",{className:"w-12 px-4 py-3 text-left font-medium",children:" "})]})}),e.jsx("tbody",{children:B.rows.map((t,s)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-4",children:e.jsx(O,{type:"number",value:t.quantity,onChange:a=>V(s,"quantity",a.target.value),min:"0",className:"w-full"})}),e.jsx("td",{className:"p-4",children:e.jsxs(E,{value:t.componentId,onValueChange:a=>V(s,"componentId",a),children:[e.jsx(P,{className:"w-full",children:e.jsx(v,{placeholder:"Seleccione componente"})}),e.jsx(y,{children:F.map(a=>e.jsx(w,{value:a.id.toString(),children:a.name},a.id))})]})}),e.jsx("td",{className:"p-4",children:e.jsx(O,{type:"number",value:t.watts,readOnly:!0,className:"w-full bg-muted"})}),e.jsx("td",{className:"p-4",children:e.jsx(N,{type:"button",variant:"ghost",size:"icon",onClick:()=>ce(s),className:"text-destructive hover:text-destructive","aria-label":"Eliminar fila",children:e.jsx(Ee,{className:"h-4 w-4"})})})]},s))})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{onClick:le,children:"Agregar Fila"}),e.jsx(N,{onClick:he,variant:"secondary",children:"Generar Tabla"}),e.jsx(N,{onClick:k,variant:"destructive",children:"Reiniciar"}),g.length>0&&e.jsxs(N,{onClick:je,variant:"outline",className:"ml-auto gap-2",children:[e.jsx(Se,{className:"w-4 h-4"}),"Exportar y Subir PDF"]})]}),g.map(t=>{var s,a,i;return e.jsxs("div",{className:"border rounded-lg overflow-x-auto mt-6",children:[e.jsxs("div",{className:"bg-muted px-4 py-3 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold",children:t.name}),o&&e.jsx($,{variant:"outline",className:"bg-orange-50 text-orange-700",children:"Override"})]}),typeof t.id=="number"&&e.jsx(N,{variant:"destructive",size:"sm",onClick:()=>xe(t.id),children:"Eliminar Tabla"})]}),typeof t.id=="number"&&e.jsx("div",{className:"p-4 bg-muted/50 space-y-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{id:`hoist-${t.id}`,checked:t.includesHoist,onCheckedChange:r=>H(t.id,{includesHoist:!!r})}),e.jsx(h,{htmlFor:`hoist-${t.id}`,children:"Incluir Potencia para Polipasto (CEE32A 3P+N+G)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{children:"Anulación de Tipo de PDU:"}),e.jsxs(E,{value:t.customPduType||"default",onValueChange:r=>H(t.id,{customPduType:r==="default"?void 0:r}),children:[e.jsx(P,{className:"w-[200px]",children:e.jsx(v,{placeholder:"Usar PDU sugerido"})}),e.jsxs(y,{children:[e.jsx(w,{value:"default",children:"Usar PDU sugerido"}),z.map(r=>e.jsx(w,{value:r,children:r},r))]})]})]})]})}),e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-muted/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Cantidad"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Componente"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Vatios (por unidad)"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Vatios Totales"})]})}),e.jsxs("tbody",{children:[t.rows.map((r,p)=>{var n;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:r.quantity}),e.jsx("td",{className:"px-4 py-3",children:r.componentName}),e.jsx("td",{className:"px-4 py-3",children:r.watts}),e.jsx("td",{className:"px-4 py-3",children:(n=r.totalWatts)==null?void 0:n.toFixed(2)})]},p)}),e.jsxs("tr",{className:"border-t bg-muted/50 font-medium",children:[e.jsx("td",{colSpan:3,className:"px-4 py-3 text-right",children:"Vatios Totales:"}),e.jsxs("td",{className:"px-4 py-3",children:[(s=t.totalWatts)==null?void 0:s.toFixed(2)," W"]})]}),T>0&&e.jsxs("tr",{className:"border-t bg-muted/50 font-medium",children:[e.jsxs("td",{colSpan:3,className:"px-4 py-3 text-right",children:["Vatios Ajustados (",T,"% margen de seguridad):"]}),e.jsxs("td",{className:"px-4 py-3",children:[(a=t.adjustedWatts)==null?void 0:a.toFixed(2)," W"]})]}),e.jsxs("tr",{className:"border-t bg-muted/50 font-medium",children:[e.jsx("td",{colSpan:3,className:"px-4 py-3 text-right",children:"Corriente por Fase:"}),e.jsxs("td",{className:"px-4 py-3",children:[(i=t.currentPerPhase)==null?void 0:i.toFixed(2)," A"]})]}),e.jsxs("tr",{className:"border-t bg-muted/50 font-medium",children:[e.jsx("td",{colSpan:3,className:"px-4 py-3 text-right",children:"PDU Sugerido:"}),e.jsx("td",{className:"px-4 py-3",children:t.pduType})]}),t.customPduType&&e.jsxs("tr",{className:"border-t bg-muted/50 font-medium text-primary",children:[e.jsx("td",{colSpan:3,className:"px-4 py-3 text-right",children:"Anulación de PDU Seleccionada:"}),e.jsx("td",{className:"px-4 py-3",children:t.customPduType})]})]})]}),t.includesHoist&&e.jsx("div",{className:"px-4 py-2 text-sm text-gray-500 bg-muted/30 italic",children:"Se requiere potencia adicional para polipasto: CEE32A 3P+N+G"})]},t.id)})]})})]})};export{Ye as default};
