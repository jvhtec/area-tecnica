import{r as o,i as Y,e as _e,f as he,j as e,D as ye,q as ve,F as xe,G as ge,L as c,S as C,t as A,v as q,w as O,x as g,aD as je,I as j,B as Z,ac as fe,V as be,s as d}from"./index-NZ6jJLfQ.js";import{C as Se}from"./checkbox-BsRNEGV1.js";import{u as we}from"./useQuery-kdg2pmgf.js";import{A as De,a as Te,b as Ne,c as Ce,d as Ae,e as qe,f as Oe,g as Le}from"./alert-dialog-CtyYUxwH.js";import{R as Pe}from"./transportOptions-CtHnG2xX.js";import{T as ke}from"./transportProviders-CPS1W6Xy.js";const Re=["sound","lights","video"],Ke=({open:L,onOpenChange:P,selectedDate:f,selectedEvent:t,initialJobId:b=null,initialDepartments:oe=[],initialTransportType:le,initialEventType:ce,onCreated:_})=>{const[S,k]=o.useState("load"),[$,R]=o.useState("trailer"),[F,M]=o.useState("09:00"),[B,Q]=o.useState(f?Y(f,"yyyy-MM-dd"):""),[E,U]=o.useState(""),[w,D]=o.useState(null),[V,K]=o.useState(""),[ee,I]=o.useState(""),[te,z]=o.useState(null),[H,J]=o.useState(""),[p,G]=o.useState([]),[de,W]=o.useState(!1),[ae,X]=o.useState("#7E69AB"),[se,ie]=o.useState(!1),{toast:h}=_e(),T=he();o.useEffect(()=>{L&&(t!=null&&t.id?(k(t.event_type),R(t.transport_type),M(t.event_time),Q(t.event_date?Y(new Date(t.event_date),"yyyy-MM-dd"):""),U(t.loading_bay||""),D(t.job_id||null),K(t.title||""),I(t.license_plate||""),z(t.transport_provider||null),J(t.notes||""),G((t.departments||[]).map(a=>a.department)),X(t.color||"#7E69AB")):(k(ce||"load"),R(le||"trailer"),M("09:00"),Q(f?Y(f,"yyyy-MM-dd"):""),U(""),D(b||null),K(""),I(""),z(null),J(""),G(oe||[]),X("#7E69AB"),ie(!1),b||D(null)))},[L,t==null?void 0:t.id]);const{data:y}=we({queryKey:["jobs"],queryFn:async()=>{const{data:a,error:n}=await d.from("jobs").select("id, title");if(n)throw n;return a}}),pe=async()=>{try{if(!t)return;const{error:a}=await d.from("logistics_event_departments").delete().eq("event_id",t.id);if(a)throw a;const{error:n}=await d.from("logistics_events").delete().eq("id",t.id);if(n)throw n;h({title:"Éxito",description:"Evento de logística eliminado correctamente."}),T.invalidateQueries({queryKey:["logistics-events"]}),T.invalidateQueries({queryKey:["today-logistics"]});const r=(t.departments||[]).map(s=>s.department);try{await d.functions.invoke("push",{body:{action:"broadcast",type:"logistics.event.cancelled",job_id:t.job_id||void 0,event_id:t.id,event_type:t.event_type,event_date:t.event_date,event_time:t.event_time,title:t.title,transport_type:t.transport_type,loading_bay:t.loading_bay,departments:r,license_plate:t.license_plate}})}catch{}W(!1),setTimeout(()=>P(!1),100)}catch(a){h({title:"Error",description:a.message,variant:"destructive"})}},ue=async a=>{if(a.preventDefault(),!B||!F||!w&&!V){h({title:"Error",description:"Fecha, hora y título (si no hay trabajo) son obligatorios.",variant:"destructive"});return}try{const n=async(s,m={})=>{if(!s)return;const{type:u="logistics.event.created",autoCreatedUnload:i,pairedEvent:l,departmentsOverride:v,changes:x}=m;try{await d.functions.invoke("push",{body:{action:"broadcast",type:u,job_id:s.job_id||void 0,event_id:s.id,event_type:s.event_type,event_date:s.event_date,event_time:s.event_time,title:s.title,transport_type:s.transport_type,loading_bay:s.loading_bay,departments:v??p,license_plate:s.license_plate,auto_created_unload:i||void 0,paired_event_type:l==null?void 0:l.event_type,paired_event_date:l==null?void 0:l.event_date,paired_event_time:l==null?void 0:l.event_time,...x?{changes:x}:{}}})}catch{}},r={event_type:S,transport_type:$,transport_provider:te||null,notes:H||null,event_date:B,event_time:F,loading_bay:E||null,job_id:w||null,title:V||null,license_plate:ee||null,color:ae};if(t){const{error:s}=await d.from("logistics_events").update(r).eq("id",t.id);if(s)throw s;if(await d.from("logistics_event_departments").delete().eq("event_id",t.id),p.length>0){const{error:N}=await d.from("logistics_event_departments").insert(p.map(me=>({event_id:t.id,department:me})));if(N)throw N}const m=(t.departments||[]).map(N=>N.department).sort(),u={...t,...r},i={};t.event_type!==r.event_type&&(i.event_type={from:t.event_type,to:r.event_type}),t.event_date!==r.event_date&&(i.event_date={from:t.event_date,to:r.event_date});const l=(t.event_time||"").slice(0,5),v=(r.event_time||"").slice(0,5);l!==v&&(i.event_time={from:t.event_time,to:r.event_time}),(t.transport_type||"")!==(r.transport_type||"")&&(i.transport_type={from:t.transport_type,to:r.transport_type});const x=t.loading_bay||"",re=r.loading_bay||"";x!==re&&(i.loading_bay={from:t.loading_bay,to:r.loading_bay}),(t.license_plate||"")!==(r.license_plate||"")&&(i.license_plate={from:t.license_plate,to:r.license_plate});const ne=[...p].sort();JSON.stringify(m)!==JSON.stringify(ne)&&(i.departments={from:m,to:ne}),await n(u,{type:"logistics.event.updated",departmentsOverride:p,changes:Object.keys(i).length>0?i:void 0}),h({title:"Success",description:"Evento de logística actualizado correctamente."})}else{const{data:s,error:m}=await d.from("logistics_events").insert(r).select().single();if(m)throw m;try{_==null||_({id:s.id,event_type:s.event_type,event_date:s.event_date,event_time:s.event_time})}catch{}if(p.length>0){const{error:u}=await d.from("logistics_event_departments").insert(p.map(i=>({event_id:s.id,department:i})));if(u)throw u}if(se&&S==="load"){const u={...r,event_type:"unload"},{data:i,error:l}=await d.from("logistics_events").insert(u).select().single();if(l)throw l;if(p.length>0){const{error:v}=await d.from("logistics_event_departments").insert(p.map(x=>({event_id:i.id,department:x})));if(v)throw v}try{_==null||_({id:i.id,event_type:i.event_type,event_date:i.event_date,event_time:i.event_time})}catch{}await n(s,{type:"logistics.event.created",pairedEvent:{event_type:i.event_type,event_date:i.event_date,event_time:i.event_time}}),await n(i,{type:"logistics.event.created",autoCreatedUnload:!0,pairedEvent:{event_type:s.event_type,event_date:s.event_date,event_time:s.event_time}})}else await n(s);h({title:"Éxito",description:"Evento de logística creado correctamente."})}T.invalidateQueries({queryKey:["logistics-events"]}),T.invalidateQueries({queryKey:["today-logistics"]}),P(!1)}catch(n){h({title:"Error",description:n.message,variant:"destructive"})}};return e.jsxs(e.Fragment,{children:[e.jsx(ye,{open:L,onOpenChange:P,children:e.jsxs(ve,{className:"max-h-[85vh] overflow-y-auto",children:[e.jsx(xe,{children:e.jsx(ge,{children:t?"Editar evento de logística":"Crear evento de logística"})}),e.jsxs("form",{onSubmit:ue,className:"space-y-4",children:[!t&&!b?e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Trabajo"}),e.jsxs(C,{value:w||"no-job",onValueChange:a=>{D(a==="no-job"?null:a)},children:[e.jsx(A,{children:e.jsx(q,{placeholder:"Selecciona un trabajo"})}),e.jsxs(O,{children:[e.jsx(g,{value:"no-job",children:"Sin trabajo"}),y==null?void 0:y.map(a=>e.jsx(g,{value:a.id,children:a.title},a.id))]})]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Trabajo"}),e.jsx("div",{className:"px-3 py-2 border rounded bg-muted text-sm",children:(()=>{var n;return((n=y==null?void 0:y.find(r=>r.id===((t==null?void 0:t.job_id)||b)))==null?void 0:n.title)||"Trabajo seleccionado"})()})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Color del evento"}),e.jsx(je,{color:ae,onChange:X})]}),w===null&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Título"}),e.jsx(j,{value:V,onChange:a=>K(a.target.value),placeholder:"Introduce el título del evento",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Tipo de evento"}),e.jsxs(C,{value:S,onValueChange:a=>k(a),children:[e.jsx(A,{children:e.jsx(q,{})}),e.jsxs(O,{children:[e.jsx(g,{value:"load",children:"Carga"}),e.jsx(g,{value:"unload",children:"Descarga"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Fecha"}),e.jsx(j,{type:"date",value:B,onChange:a=>Q(a.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Hora"}),e.jsx(j,{type:"time",value:F,onChange:a=>M(a.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Tipo de vehículo"}),e.jsxs(C,{value:$,onValueChange:R,children:[e.jsx(A,{children:e.jsx(q,{})}),e.jsx(O,{children:Pe.map(a=>e.jsx(g,{value:a,children:a.replace("_"," ")},a))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Matrícula"}),e.jsx(j,{value:ee,onChange:a=>I(a.target.value),placeholder:"Introduce matrícula (opcional)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Transport Provider"}),e.jsxs(C,{value:te||"",onValueChange:a=>z(a||null),children:[e.jsx(A,{children:e.jsx(q,{placeholder:"Select provider..."})}),e.jsx(O,{children:Object.entries(ke).map(([a,{label:n}])=>e.jsx(g,{value:a,children:n},a))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Departamentos"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Re.map(a=>e.jsx(Z,{type:"button",variant:p.includes(a)?"default":"outline",onClick:()=>{G(n=>n.includes(a)?n.filter(r=>r!==a):[...n,a])},children:a},a))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Muelle de carga"}),e.jsx(j,{value:E,onChange:a=>U(a.target.value),placeholder:"Opcional"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Notes"}),e.jsx(fe,{placeholder:"Additional notes or instructions...",className:"resize-none",maxLength:500,value:H,onChange:a=>J(a.target.value)}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[H.length," / 500 characters"]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2",children:[t&&e.jsxs(Z,{type:"button",variant:"destructive",onClick:()=>W(!0),children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),"Eliminar"]}),!t&&S==="load"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Se,{id:"alsoCreateUnload",checked:se,onCheckedChange:a=>ie(!!a)}),e.jsx(c,{htmlFor:"alsoCreateUnload",className:"text-sm",children:"Crear también descarga"})]}),e.jsxs(Z,{type:"submit",children:[t?"Actualizar":"Crear"," evento"]})]})]})]})}),e.jsx(De,{open:de,onOpenChange:W,children:e.jsxs(Te,{children:[e.jsxs(Ne,{children:[e.jsx(Ce,{children:"¿Eliminar este evento?"}),e.jsx(Ae,{children:"Esta acción no se puede deshacer y eliminará el evento permanentemente."})]}),e.jsxs(qe,{children:[e.jsx(Oe,{children:"Cancelar"}),e.jsx(Le,{onClick:pe,children:"Eliminar"})]})]})})]})};export{Ke as L};
