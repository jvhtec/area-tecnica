# Web push & offline rollout checklist

This document captures what remains outside of the front-end repo to deliver end-to-end push notifications and offline support. It complements `docs/pwa-push-offline-plan.md`.

## Front-end status

- ✅ Service worker (`public/sw.js`) precaches the app shell, handles push payloads, and focuses or opens a window on notification clicks.
- ✅ `src/hooks/usePushNotifications.ts` exposes enable/disable helpers, tracks permission state, and safeguards against missing browser support or missing VAPID keys.
- ✅ Settings UI (`src/pages/Settings.tsx`) surfaces push status, error messaging, and manual controls for users.
- ⚠️ Build tooling still needs dependencies installed (`npm install`) before verifying locally.

### What remains besides the backend?

- The production-ready backend described below is already implemented.
- Front-end flows, service worker behavior, and configuration management are complete as noted above.
- The only outstanding item is the optional device-management UX, which is not required for enabling push notifications end to end.

## Environment variables

| Variable | Where it is used | Notes |
| --- | --- | --- |
| `VITE_VAPID_PUBLIC_KEY` | Browser bundle (`usePushNotifications`) | Copy the VAPID public key generated by your backend into `.env`. Present in `.env.example`. |
| `VAPID_PUBLIC_KEY` | Backend push service | Should match `VITE_VAPID_PUBLIC_KEY` and be passed to `web-push` (or your push provider). |
| `VAPID_PRIVATE_KEY` | Backend push service | Keep secret on the server. |

## Backend work items

1. ✅ **Persist subscriptions**
   - Supabase Edge Function `push` stores `{ endpoint, keys.p256dh, keys.auth, expirationTime, user_agent }` against the authenticated user via `supabase.functions.invoke('push', { action: 'subscribe' })`.
   - Responses are normalized to JSON for the React client; failures surface actionable errors.
2. ✅ **Handle unsubscription**
   - The same Edge Function handles `action: 'unsubscribe'`, deleting the subscription for the user and endpoint combination.
3. ✅ **Send notifications**
   - `action: 'test'` uses `web-push` with the configured VAPID keys to fan out test payloads and cleans up expired endpoints automatically.
   - Extend this helper to broadcast real events defined in `docs/pwa-push-offline-plan.md` from your job/event pipeline.
4. ✅ **Auth & CSRF**
   - Supabase JWT verification (enabled in `supabase/config.toml`) validates the caller; no cookies are required because the Supabase client attaches the bearer token.
5. **Device management UX (optional)**
   - Provide a user-facing view to see/remove devices, if required by policy.

## Testing checklist

1. Install dependencies and run a production build: `npm install` → `npm run build` → `npm run preview`.
2. Load the preview URL in a browser that supports Push (Chrome/Edge/Safari desktop) over HTTPS or `http://localhost`.
3. Verify that:
   - The Settings card shows "Enable push" when no subscription exists.
   - Clicking "Enable push" creates a subscription, the backend saves it, and a success toast/log appears server-side.
   - Test notifications sent from your backend reach the device and open the correct route when clicked.
   - Disabling push removes the subscription and updates the backend record.
4. Simulate offline mode in DevTools to confirm the cached shell renders.

## Operational follow-ups

- Automate VAPID key provisioning/secrets management (e.g., store in your platform's secret manager).
- Monitor `pushsubscriptionchange` events server-side (if you expand the service worker) to refresh expired subscriptions.
- Plan a re-engagement campaign or UI nudge prompting users to enable notifications after rollout.

