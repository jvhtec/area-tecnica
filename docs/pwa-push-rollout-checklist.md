# Web push & offline rollout checklist

This document captures what remains outside of the front-end repo to deliver end-to-end push notifications and offline support. It complements `docs/pwa-push-offline-plan.md`.

## Front-end status

- ✅ Service worker (`public/sw.js`) precaches the app shell, handles push payloads, and focuses or opens a window on notification clicks.
- ✅ `src/hooks/usePushNotifications.ts` exposes enable/disable helpers, tracks permission state, and safeguards against missing browser support or missing VAPID keys.
- ✅ Settings UI (`src/pages/Settings.tsx`) surfaces push status, error messaging, and manual controls for users.
- ⚠️ Build tooling still needs dependencies installed (`npm install`) before verifying locally.

## Environment variables

| Variable | Where it is used | Notes |
| --- | --- | --- |
| `VITE_VAPID_PUBLIC_KEY` | Browser bundle (`usePushNotifications`) | Copy the VAPID public key generated by your backend into `.env`. Present in `.env.example`. |
| `VAPID_PUBLIC_KEY` | Backend push service | Should match `VITE_VAPID_PUBLIC_KEY` and be passed to `web-push` (or your push provider). |
| `VAPID_PRIVATE_KEY` | Backend push service | Keep secret on the server. |

## Backend work items

1. **Persist subscriptions**
   - Implement `POST /api/push/subscribe` to upsert `{ endpoint, keys.p256dh, keys.auth, expirationTime, userAgent }` for the authenticated user.
   - Return a 2xx response when stored successfully; non-2xx responses surface an error in the UI.
2. **Handle unsubscription**
   - Implement `POST /api/push/unsubscribe` to remove the subscription by endpoint and tidy up related state.
3. **Send notifications**
   - Feed the event taxonomy from `docs/pwa-push-offline-plan.md` into your job/event pipeline.
   - Serialize payloads that respect the documented schema and remain < 4 KB.
   - Sign requests with the VAPID keys when using `web-push` or equivalent.
4. **Auth & CSRF**
   - The front-end sends credentials (`credentials: 'include'`); ensure your API validates the current session and protects against CSRF (e.g., via cookies + CSRF token or SameSite settings).
5. **Device management UX (optional)**
   - Provide a user-facing view to see/remove devices, if required by policy.

## Testing checklist

1. Install dependencies and run a production build: `npm install` → `npm run build` → `npm run preview`.
2. Load the preview URL in a browser that supports Push (Chrome/Edge/Safari desktop) over HTTPS or `http://localhost`.
3. Verify that:
   - The Settings card shows "Enable push" when no subscription exists.
   - Clicking "Enable push" creates a subscription, the backend saves it, and a success toast/log appears server-side.
   - Test notifications sent from your backend reach the device and open the correct route when clicked.
   - Disabling push removes the subscription and updates the backend record.
4. Simulate offline mode in DevTools to confirm the cached shell renders.

## Operational follow-ups

- Automate VAPID key provisioning/secrets management (e.g., store in your platform's secret manager).
- Monitor `pushsubscriptionchange` events server-side (if you expand the service worker) to refresh expired subscriptions.
- Plan a re-engagement campaign or UI nudge prompting users to enable notifications after rollout.

